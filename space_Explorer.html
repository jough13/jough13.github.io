<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wayfinder: Echoes of the Void - v0.8.16 (Map Rendering Revert & Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html {
            height: 100%;
            overflow: hidden; 
            margin: 0;
            padding: 0;
            box-sizing: border-box; 
        }
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #0D0D1A; 
            color: #D0D0D0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            margin: 0;
            padding: 0; 
            overflow: hidden; 
            box-sizing: border-box;
        }
        #page-wrapper { 
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            width: 100%;
            max-width: 800px; 
            height: 100vh; 
            overflow-y: auto; 
            padding: 15px; 
            box-sizing: border-box;
        }

        /* Custom Scrollbar Styles for WebKit browsers */
        #page-wrapper::-webkit-scrollbar {
            width: 10px; 
        }

        #page-wrapper::-webkit-scrollbar-track {
            background: #101022; 
            border-radius: 5px;
        }

        #page-wrapper::-webkit-scrollbar-thumb {
            background-color: #00A0A0; 
            border-radius: 5px;
            border: 2px solid #101022; 
        }

        #page-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: #00E0E0; 
        }
        
        /* Firefox scrollbar styling */
        #page-wrapper {
            scrollbar-width: thin; 
            scrollbar-color: #00A0A0 #101022; 
        }


        #gameContainer {
            background-color: #101022; 
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 220, 220, 0.25); 
            border: 1px solid #303060; 
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; 
            height: 680px; 
            overflow: hidden; 
            width: 100%; 
            margin-bottom: 15px; 
        }
        #gameMap {
            white-space: pre;
            font-size: 18px; 
            line-height: 1; 
            border: 1px solid #303060; 
            padding: 10px;
            border-radius: 5px;
            background-color: #000000; 
            color: #A0A0A0; 
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameMap > div { 
            text-align: center;
            height: 18px; 
        }
        #playerStats {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px 12px; 
            width: 100%;
            max-width: 580px; 
            padding: 12px; 
            background-color: #181830; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            text-align: center;
            border: 1px solid #2a2a5a;
        }
        .stat-item {
             display: flex;
             flex-direction: column;
             align-items: center;
             padding: 3px 0; 
        }
        .stat {
            color: #00E0E0; 
            font-weight: bold;
            font-size: 16px; 
            line-height: 18px; 
        }
        .stat-label {
            color: #8888AA; 
            font-size: 12px; 
            line-height: 14px; 
            margin-bottom: 2px; 
        }
        .sector-coords {
            font-size: 12px; 
            line-height: 14px; 
            color: #6A6A8A; 
            margin-top: 1px;
        }
        #messageArea {
            height: 120px; 
            overflow-y: scroll; 
            color: #FFD700; 
            text-align: left; 
            font-size: 16px;
            line-height: 23px; 
            width: 100%;
            max-width: 720px; 
            padding: 15px; 
            border: 1px dashed #404070; 
            border-radius: 8px;
            background-color: #101022; 
        }
        .game-title {
            font-size: 44px; 
            line-height: 48px; 
            font-weight: 700;
            color: #00E8E8;
            text-shadow: 0 0 8px #00E8E8, 0 0 15px #00A0A0, 0 0 25px #007070; 
            margin-top: 0; 
            margin-bottom: 15px; 
        }
        .controls-info {
            margin-top: 0; 
            margin-bottom: 15px; 
            font-size: 13px; 
            line-height: 20px; 
            color: #707090; 
            text-align: center;
        }
        #versionInfo {
            margin-top: 0; 
            margin-bottom: 0; 
            font-size: 13px;  
            line-height: 16px; 
            color: #404050; 
            text-align: center;
        }

        /* Codex Styles */
        #codexOverlay {
            position: absolute; top: 5%; left: 5%; width: 90%; height: 90%; 
            background-color: rgba(10, 10, 25, 0.97); border: 2px solid #00E0E0;
            border-radius: 10px; z-index: 1000; color: #C0C0C0; padding: 20px;
            display: none; flex-direction: column; font-size: 16px;
        }
        #codexTitle { font-size: 1.8em; color: #00E0E0; text-align: center; margin-bottom: 15px; border-bottom: 1px solid #333355; padding-bottom: 10px; }
        #codexContent { flex-grow: 1; overflow-y: auto; display: flex; }
        #codexCategories, #codexEntries { padding: 10px; border-right: 1px solid #333355; overflow-y: auto; }
        #codexEntryText { padding: 10px; overflow-y: auto; white-space: pre-wrap; text-align: left; line-height: 1.5; }
        #codexCategories { flex-basis: 25%; }
        #codexEntries { flex-basis: 30%; border-right: 1px solid #333355; }
        #codexEntryText { flex-basis: 45%; border-right: none; }
        .codex-list-item { padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; background-color: #181830; transition: background-color 0.2s; text-align: left; }
        .codex-list-item:hover { background-color: #282848; }
        .codex-list-item.active { background-color: #00E0E0; color: #0f0f1a; }
        #codexCloseButton { position: absolute; top: 15px; right: 20px; font-size: 1.5em; color: #ff4444; cursor: pointer; background: none; border: none; }

        .player-char { color: #FFFFFF; text-shadow: 0 0 6px #FFFFFF, 0 0 10px #00FFFF; } 
        .star-char { color: #FFFF99; text-shadow: 0 0 3px #FFFF00; } 
        .planet-char { color: #88CCFF; } 
        .starbase-char { color: #FF88FF; text-shadow: 0 0 3px #FF00FF; } 
        .outpost-char { color: #AADD99; } 
        .asteroid-char { color: #FFAA66; } 
        .nebula-char { color: #DD99FF; }
        .empty-space-char { color: #909090; } 
        .pirate-char { color: #FF5555; font-weight: bold; text-shadow: 0 0 5px #FF0000; }
        .derelict-char { color: #88AACC; } 
        .anomaly-char { color: #FF33FF; font-weight: bold; animation: pulse-magenta 1.3s infinite; } 
        .wormhole-char { color: #FFB800; font-weight: bold; animation: pulse-orange 1.3s infinite; } 
        .npc-trader-char { color: #4CAF50; font-weight: bold; text-shadow: 0 0 3px #388E3C; }


        @keyframes pulse-orange { 0% { opacity: 1; text-shadow: 0 0 6px #FFA500, 0 0 10px #FF8C00; } 50% { opacity: 0.7; text-shadow: 0 0 12px #FF8C00, 0 0 18px #FF7700; } 100% { opacity: 1; text-shadow: 0 0 6px #FFA500, 0 0 10px #FF8C00; } }
        @keyframes pulse-magenta { 0% { opacity: 1; text-shadow: 0 0 6px #FF00FF, 0 0 10px #DD00DD; } 50% { opacity: 0.7; text-shadow: 0 0 12px #DD00DD, 0 0 18px #CC00CC; } 100% { opacity: 1; text-shadow: 0 0 6px #FF00FF, 0 0 10px #DD00DD; } }
    </style>
</head>
<body>
    <div id="page-wrapper">
        <h1 class="game-title">Wayfinder: Echoes of the Void</h1>

        <div id="gameContainer">
            <div id="playerStats">
                <div class="stat-item"><span class="stat-label">Fuel</span><span id="fuelStat" class="stat">0/0</span></div>
                <div class="stat-item"> 
                    <span class="stat-label">Current Sector</span>
                    <span id="sectorNameStat" class="stat">Sol Sector</span>
                    <span id="sectorCoordsStat" class="sector-coords">(0,0)</span>
                </div>
                <div class="stat-item"><span class="stat-label">Shields</span><span id="shieldsStat" class="stat">0/0</span></div>
                
                <div class="stat-item"><span class="stat-label">Credits</span><span id="creditsStat" class="stat">0</span></div>
                <div class="stat-item"><span class="stat-label">Cargo</span><span id="cargoStat" class="stat">0/0</span></div>
                <div class="stat-item"><span class="stat-label">Hull</span><span id="hullStat" class="stat">0/0</span></div> 
                
                <div class="stat-item">
                    <span class="stat-label">Level / XP</span>
                    <span id="levelXpStat" class="stat">1 (0/0)</span>
                </div>
                <div class="stat-item"><span class="stat-label">Ship Class</span><span id="shipClassStat" class="stat">Unknown</span></div>
                <div class="stat-item"><span class="stat-label">Notoriety</span><span id="notorietyStat" class="stat">Unknown</span></div>
            </div>
            <div id="gameMap"></div>
            <div id="messageArea">Welcome, Explorer!</div>

            <div id="codexOverlay">
                <button id="codexCloseButton" onclick="toggleCodex(false)">&times;</button>
                <div id="codexTitle">Codex Galactica</div>
                <div id="codexContent">
                    <div id="codexCategories"></div>
                    <div id="codexEntries"></div>
                    <div id="codexEntryText">Select an entry to read.</div>
                </div>
            </div>
        </div>

        <div class="controls-info">
            WASD: Move | E: Scan | H: Scoop Fuel | T: Traverse Wormhole | J: Codex | I: Cargo | M: Mine Asteroid <br> 
            Docked - B: Buy | S: Sell | O: Outfit Ship | K: Missions | L: Leave | Y: Hail NPC (on same tile) <br>
            Docked Mission Actions - C: Complete Delivery (at destination) | G: Claim Reward (at giver) <br>
            Combat - F: Fight | C: Charge Attack | V: Evade | R: Run | Enter: Continue (after battle)
        </div>
        <div id="versionInfo">Wayfinder: Echoes of the Void - v0.8.15</div>
    </div>

    <script>
        // --- Game Configuration ---
        const GAME_VERSION = "v0.8.15"; 
        const MAP_WIDTH = 55; 
        const MAP_HEIGHT = 14; 
        const PLAYER_CHAR_VAL = '@'; const EMPTY_SPACE_CHAR_VAL = '.';
        const STAR_CHAR_VAL = '*'; const PLANET_CHAR_VAL = 'O';
        const STARBASE_CHAR_VAL = '#'; 
        const OUTPOST_CHAR_VAL = 'H';  
        const ASTEROID_CHAR_VAL = '%'; const NEBULA_CHAR_VAL = '~'; 
        const PIRATE_CHAR_VAL = 'X'; const DERELICT_CHAR_VAL = 'D'; 
        const ANOMALY_CHAR_VAL = '?'; const WORMHOLE_CHAR_VAL = 'W'; 
        const NPC_TRADER_CHAR = '$';

        var INITIAL_FUEL; 
        var MAX_FUEL;     
        const INITIAL_CREDITS = 1000; const PLAYER_CARGO_CAPACITY = 50;
        const BASE_FUEL_PER_MOVE = 0.8; 
        var INITIAL_SHIELDS; 
        var MAX_SHIELDS;     
        const MAX_PLAYER_HULL = 100; 
        var playerHull; 

        const PIRATE_ENCOUNTER_CHANCE = 0.0025; 
        const RUN_ESCAPE_CHANCE = 0.6; const RUN_FUEL_COST = 5;
        const EVASION_FUEL_COST = 3;
        const EVASION_DODGE_BONUS = 0.35; 
        const CHARGE_DAMAGE_MULTIPLIER = 1.5;
        const CHARGE_HIT_BONUS = 0.15;
        const HULL_DAMAGE_BONUS_MULTIPLIER = 1.25; 


        var PLAYER_ATTACK_DAMAGE; 
        var PLAYER_HIT_CHANCE;  
        const PIRATE_BASE_SHIELDS_MIN = 15; 
        const PIRATE_BASE_SHIELDS_MAX = 35; 
        const PIRATE_BASE_HULL_MIN = 40; 
        const PIRATE_BASE_HULL_MAX = 70; 
        const PIRATE_ATTACK_DAMAGE_MIN = 5;
        const PIRATE_ATTACK_DAMAGE_MAX = 12; 
        const PIRATE_HIT_CHANCE = 0.6;
        const PIRATE_CREDIT_REWARD_MIN = 20; const PIRATE_CREDIT_REWARD_MAX = 60; 
        const XP_PER_PIRATE_MIN = 10; 
        const XP_PER_PIRATE_MAX = 25; 

        const MIN_SCOOP_YIELD = 10; 
        const MAX_SCOOP_YIELD_RICHNESS_MULTIPLIER = 18; 
        const SCOOP_RANDOM_BONUS = 4; 

        const OUTPOST_SPAWN_CHANCE = 0.08; 
        const WORMHOLE_SPAWN_CHANCE = 0.03; 
        const WORMHOLE_TRAVEL_FUEL_COST = 20;
        const WORMHOLE_JUMP_MIN_DIST = 5;
        const WORMHOLE_JUMP_MAX_DIST = 15;

        const BASE_XP_TO_LEVEL = 75; 
        const XP_LEVEL_EXPONENT = 1.6; 
        const XP_PER_NEW_SECTOR_DISCOVERY = 25; 
        const XP_PER_FIRST_SCAN_TYPE = 5;       
        const XP_PER_LOCATION_DISCOVERY = 10;   
        const XP_PER_PROFIT_UNIT = 0.1;   
        const XP_MYSTERY_REWARD = 200;      
        const XP_WORMHOLE_TRAVERSE = 15;
        const XP_PER_MINING_OP = 3; 
        const XP_BONUS_RARE_MINERAL = 5; 
        const XP_MISSION_COMPLETION_BASE = 50;

        // Notoriety Configuration
        const NOTORIETY_TITLES = [
            { score: -Infinity, title: "Enemy of the Concord" }, 
            { score: -200, title: "Wanted Outlaw" },
            { score: -50,  title: "Troublemaker" },
            { score: 0,    title: "Rookie Spacer" },
            { score: 50,   title: "Known Freelancer" },
            { score: 200,  title: "Respected Captain" },
            { score: 500,  title: "Galactic Hero" }
        ]; 
        
        // --- Ship Components Database ---
        const COMPONENTS_DATABASE = {
            WEAPON_PULSE_LASER_MK1: { name: "Pulse Laser Mk1", type: "weapon", slot: "weapon", description: "Standard issue civilian pulse laser. Reliable but low power.", cost: 0, stats: { damage: 8, hitChance: 0.70 }, loreKey: "LORE_COMP_PULSE_LASER" },
            WEAPON_PULSE_LASER_MK2: { name: "Pulse Laser Mk2", type: "weapon", slot: "weapon", description: "Upgraded pulse laser with improved focusing coils for higher damage.", cost: 2000, stats: { damage: 12, hitChance: 0.75 }, loreKey: "LORE_COMP_PULSE_LASER" },
            WEAPON_PULSE_LASER_MK3: { name: "Pulse Laser Mk3", type: "weapon", slot: "weapon", description: "Military-grade pulse laser. Significant damage output and better targeting.", cost: 5500, stats: { damage: 18, hitChance: 0.78 }, loreKey: "LORE_COMP_PULSE_LASER" },
            WEAPON_KINETIC_IMPULSOR_MK1: { name: "Kinetic Impulsor Mk1", type: "weapon", slot: "weapon", description: "Fires solid slugs. Decent against unshielded hulls.", cost: 1800, stats: { damage: 15, hitChance: 0.65 }, loreKey: "LORE_COMP_KINETIC_WEAPON" },
            WEAPON_ION_CANNON_MK1: { name: "Ion Cannon Mk1", type: "weapon", slot: "weapon", description: "Disrupts shields effectively, less hull damage.", cost: 2200, stats: { damage: 6, hitChance: 0.80, vsShieldBonus: 10 }, loreKey: "LORE_COMP_ION_WEAPON" }, 
            WEAPON_BEAM_LASER_MK1: { name: "Beam Laser Mk1", type: "weapon", slot: "weapon", description: "Sustained energy beam. High accuracy, consistent damage over time.", cost: 2800, stats: { damage: 10, hitChance: 0.85 }, loreKey: "LORE_COMP_BEAM_LASER" },
            WEAPON_MASS_DRIVER_MK1: { name: "Mass Driver Mk1", type: "weapon", slot: "weapon", description: "Accelerates a dense projectile to devastating speeds. High hull damage, slow fire rate.", cost: 3800, stats: { damage: 25, hitChance: 0.60 }, loreKey: "LORE_COMP_MASS_DRIVER" },
            WEAPON_MISSILE_LAUNCHER_MK1: { name: "Missile Launcher Mk1", type: "weapon", slot: "weapon", description: "Fires self-propelled explosive ordnance. High damage, limited ammo (flavor).", cost: 4500, stats: { damage: 30, hitChance: 0.60 }, loreKey: "LORE_COMP_MISSILE_LAUNCHER" },
            SHIELD_BASIC_ARRAY_A: { name: "Basic Deflector Array A", type: "shield", slot: "shield", description: "Entry-level shield generator. Offers minimal protection.", cost: 0, stats: { maxShields: 50, rechargeRate: 1 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            SHIELD_GUARDIAN_B: { name: "Guardian Shield Emitter B", type: "shield", slot: "shield", description: "Military surplus shield, offering better resilience and faster recharge.", cost: 2500, stats: { maxShields: 80, rechargeRate: 2 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" }, 
            SHIELD_AEGIS_C: { name: "Aegis Shield Projector C", type: "shield", slot: "shield", description: "Top-tier Concord shield tech. Excellent protection and robust recharge.", cost: 5000, stats: { maxShields: 120, rechargeRate: 3 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            SHIELD_RAPID_CYCLE_A: { name: "Rapid-Cycle Unit A", type: "shield", slot: "shield", description: "Lower capacity, but regenerates very quickly. Favored by agile fighters.", cost: 3000, stats: { maxShields: 65, rechargeRate: 4 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            SHIELD_FORTRESS_GRID_A: { name: "Fortress Grid A", type: "shield", slot: "shield", description: "Extremely high capacity, but slow to regenerate. For ships that can take a beating.", cost: 4500, stats: { maxShields: 150, rechargeRate: 1 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            ENGINE_STD_DRIVE_MK1: { name: "Standard Drive Mk1", type: "engine", slot: "engine", description: "Common civilian stardrive. Gets you there, eventually.", cost: 0, stats: { maxFuel: 220, fuelEfficiency: 1.0 }, loreKey: "LORE_COMP_ENGINE" }, 
            ENGINE_RANGEPLUS_MK1: { name: "RangePlus Drive Mk1", type: "engine", slot: "engine", description: "Larger fuel tank for extended travel, slightly improved efficiency.", cost: 3000, stats: { maxFuel: 350, fuelEfficiency: 0.95 }, loreKey: "LORE_COMP_ENGINE" },
            ENGINE_IONFLOW_MK2: { name: "IonFlow Drive Mk2", type: "engine", slot: "engine", description: "Advanced ion engine, significantly better fuel efficiency.", cost: 4000, stats: { maxFuel: 275, fuelEfficiency: 0.75 }, loreKey: "LORE_COMP_ENGINE" }, 
            ENGINE_HIGH_THRUST_MK1: { name: "High-Thrust Drive Mk1", type: "engine", slot: "engine", description: "Powerful engine, standard fuel tank but hints at faster sublight travel (future).", cost: 3500, stats: { maxFuel: 210, fuelEfficiency: 1.15 }, loreKey: "LORE_COMP_ENGINE" },
            SCANNER_BASIC_SUITE: { name: "Standard Sensor Suite", type: "scanner", slot: "scanner", description: "Basic sensor package. Provides essential data.", cost: 0, stats: { scanBonus: 0 }, loreKey: "LORE_COMP_SCANNER" },
            SCANNER_DEEP_RANGE_A: { name: "Deep-Range Array A", type: "scanner", slot: "scanner", description: "Improved sensor resolution. May reveal more details or rarer finds.", cost: 1500, stats: { scanBonus: 0.05 }, loreKey: "LORE_COMP_SCANNER" } 
        };


        const COMMODITIES = { 
            FUEL_CELLS: { name: "Fuel Cells", basePrice: 10, description: "Concord-grade hyper-refined hydrogen. The lifeblood of interstellar travel, ensuring stable warp fields. Black market cells, often crudely refined from nebula gas, offer more punch but risk catastrophic containment failure. Every spacer knows the hum of a good fuel cell... and the silence of a bad one." },
            MINERALS: { name: "Minerals", basePrice: 25, description: "Bulk-processed common ores – iron, bauxite, silicates. The gritty backbone of galactic construction, from towering Starbase Alpha to the smallest frontier outpost. The dust of these minerals coats the lungs of asteroid miners across a thousand worlds. Some rare veins contain trace elements vital for advanced alloys." },
            FOOD_SUPPLIES: { name: "Food Supplies", basePrice: 15, description: "A spectrum of sustenance: from bland but life-sustaining nutrient paste (affectionately known as 'Grey Goo') to surprisingly palatable hydroponic greens and recycled protein. Fresh, soil-grown food is a luxury reserved for core worlds or well-funded stations; most spacers subsist on these processed rations, dreaming of real fruit or a synth-steak that doesn't taste of despair." },
            TECH_PARTS: { name: "Tech Parts", basePrice: 50, description: "A chaotic assortment of salvaged and 'repurposed' electronic components, often stripped from derelicts or 'acquired' from less-than-reputable sources. Essential for ship repairs and often used in dangerous, unsanctioned upgrades. Finding a working Precursor chip among the junk is like winning the lottery... or a death sentence, depending on who sees you with it." },
            RARE_METALS: { name: "Rare Metals", basePrice: 75, description: "Platinum, Iridium, Osmium, and other dense, exotic metals vital for high-tech manufacturing, especially sensitive FTL drive components, advanced sensor arrays, and some forms of energy weaponry. Often mined from hazardous, gravity-sheared asteroid fields or the hearts of dying stars, making their acquisition a risky but profitable venture." },
            MEDICAL_SUPPLIES: { name: "Medical Supplies", basePrice: 60, description: "Sterile field kits, broad-spectrum anti-rads, combat stims, and advanced auto-suture devices. A lifeline in the void where the nearest medical facility might be parsecs away. Black market 'slapper' patches and 'Focus' chems offer potent, if risky and often addictive, alternatives to Concord-approved med-tech. Some say the best, and most ethically questionable, stuff comes from K'tharr bio-labs.", unlocked: false },
            ARTIFACT_SHARDS: { name: "Artifact Shards", basePrice: 150, description: "Fragments of unknown, possibly alien, technology. Highly sought after by collectors, xeno-archaeologists, and shadowy corporate R&D divisions. Rumored to hum with faint energy and whisper forgotten secrets or induce strange dreams in those who handle them for too long. Some believe they are pieces of Precursor 'keys' to unlock their lost knowledge or activate dormant machinery. The Concord officially discourages trade in such items, citing potential unknown dangers.", unlocked: false },
            XENO_ANTIQUES: { name: "Xeno-Antiques", basePrice: 200, description: "Intact relics from extinct alien civilizations. Extremely rare and valuable to the right buyer – usually eccentric billionaires or secretive research institutions. Some whisper they carry curses or forgotten knowledge of the Precursors. Authenticity is often dubious; many are clever fakes crafted in backwater asteroid foundries. The K'tharr consider most Xeno-Antiques to be blasphemous and will destroy them on sight, believing them to be corrupting influences.", unlocked: false },
            FORBIDDEN_TEXTS: { name: "Forbidden Texts", basePrice: 120, description: "Data slates containing controversial or dangerous information - heretical philosophies like the 'Chronos Heresy', banned technologies such as self-replicating nanites or K'tharr Void Engines, or unredacted histories the Concord wants forgotten (e.g., 'The True Founding of the Concord', 'The Precursor Accords'). Possession is often illegal under Galactic Concord law, Article 7, Section Gamma. Knowledge has a price, and some knowledge is best left unknown, lest it unravel the fabric of society or reveal uncomfortable truths.", unlocked: false },
            PRECURSOR_DATACUBE: { name: "Precursor Datacube", basePrice: 350, description: "A perfectly preserved data storage device of Precursor origin, often made of an unidentifiable, crystalline material. Its contents are unreadable by current tech, but its value is immense to certain factions seeking to unlock the secrets of the ancients. They are rumored to contain star charts to lost worlds, schematics for unimaginable technology, the history of the Precursors' final days and their warnings about 'The Silencers', or even the very fabric of their consciousness. The Obsidian Directorate, K'tharr renegades, and the Children of the Void all seek these for their own inscrutable ends.", unlocked: false },
            KTHARR_SPICES: { name: "K'tharr Spices", basePrice: 90, description: "Highly potent and addictive spices from the K'tharr Hegemony, derived from flora unique to their harsh homeworlds. Illegal in Concord space, prized by hedonists and those seeking 'expanded consciousness' or an edge in combat. Said to induce visions of other realities or allow communion with K'tharr ancestors. Long-term use has... significant side effects, often involving paranoia, heightened aggression, and an insatiable craving for more of the spice. Some K'tharr warrior castes use them ritually.", unlocked: false },
            VOID_CRYSTALS: { name: "Void Crystals", basePrice: 180, description: "Crystals that seem to absorb light, found only near certain anomalies or in the deepest, most gravitationally stressed asteroid fields. Their properties are largely unknown and dangerous. Some say they whisper secrets of the void, or are solidified 'nothingness' that can unravel spacetime locally. The Children of the Void revere them as holy relics and use them to power strange devices and in their attempts to 'harmonize' with cosmic anomalies.", unlocked: false },
            GENETIC_SAMPLES: { name: "Genetic Samples", basePrice: 110, description: "Viable biological material from rare or extinct xeno-fauna, or even unique flora from hazardous environments. Valued by researchers, bio-corporations for study or weaponization, and by some K'tharr factions seeking 'pure' genetic lines for unknown, possibly eugenic, purposes. Some samples are highly unstable and require specialized containment, lest they escape and wreak havoc.", unlocked: false },
            NAVIGATION_CHARTS: { name: "Navigation Charts", basePrice: 40, description: "Datachips containing stellar cartography. Up-to-date charts are a spacer's most valuable tool, guiding safe passage through known space and highlighting potential hazards or resource-rich areas. Outdated or pirated charts, however, can lead to an early grave, an unexpected encounter with something ancient and hungry, or simply a very long, fuel-wasting detour.", unlocked: false },
            SENTIENT_MYCELIUM: { name: "Sentient Mycelium", basePrice: 220, description: "A rare, psychoactive fungus found in deep-space derelicts, certain nebulae, or rumored to grow on 'Genesis Worlds'. Its uses are... varied and often illicit. Some claim it allows telepathic communication with the 'Great Spore Network' that spans galaxies, a collective consciousness of ancient fungal life. Others say it simply drives you mad, filling your mind with alien thoughts and the laughter of dead gods. The K'tharr revere it as a sacred plant, a gift from their void gods, used in their most sacred rituals to commune with Ancestral Echoes.", unlocked: false },
            PHASE_SHIFTED_ALLOY: { name: "Phase-Shifted Alloy", basePrice: 400, description: "An incredibly rare Precursor material that flickers in and out of normal spacetime. Almost impossible to work with, but invaluable for advanced shield tech or experimental FTL drives. Rumored to be unstable and require specialized containment fields. Some say ships made of it can pass through normal matter, or even between dimensions, but the process is... unsettling for organic minds, often leading to 'reality sickness'.", unlocked: false },
            WAYFINDER_CORE: { name: "Wayfinder Core", basePrice: 1000, description: "The heart of a Precursor Wayfinder. Pulsates with ancient energy and contains fragmented star charts leading to unknown regions. Highly coveted by the Concord and other factions. Its purpose remains a profound mystery, but it's said to respond to other Precursor artifacts and guide ships through impossible spaces, perhaps even the mythical hyperlanes. It feels warm to the touch, almost alive, and sometimes projects faint, alien constellations onto nearby surfaces.", unlocked: false },
            KTHARR_ANCESTRAL_BLADE: { name: "K'tharr Ancestral Blade", basePrice: 275, description: "An ancient, energy-edged blade passed down through K'tharr warrior lineages. More than a weapon, it's a symbol of honor and a conduit to ancestral spirits. Highly illegal for non-K'tharr to possess, and the Hegemony will go to great lengths to recover one. Each blade is said to contain the 'soul-print' or 'Ancestral Echo' of its previous wielders and can only be truly mastered by one of K'tharr blood who has undergone the 'Ritual of Bonding'.", unlocked: false },
            PRECURSOR_STAR_MAP_FRAGMENT: { name: "Precursor Star Map Fragment", basePrice: 650, description: "A crystalline shard that projects a partial, holographic star chart of an unknown, impossibly distant region of space. Clearly Precursor in origin, it could lead to untold discoveries... or dangers beyond imagining. These are pieces of a larger, galaxy-spanning map, possibly leading to the Precursor homeworld, their greatest creations, or the location of 'The Great Filter'. Some fragments are said to actively resist being joined with others, as if possessing a rudimentary will.", unlocked: false },
            GOLD: { name: "Gold Bullion", basePrice: 100, description: "Refined gold bullion. While not as crucial for high-tech applications as other rare elements, its universal value as a stable store of wealth and its use in luxury goods and some specialized electronics ensures constant demand across all factions. Often used as a 'neutral' currency in lawless systems.", unlocked: false },
            PLATINUM_ORE: { name: "Platinum Ore", basePrice: 60, description: "Raw, unrefined ore rich in platinum group metals. Tedious and expensive to process, but the refined product is essential for advanced catalysts, sensitive sensor components, and certain Precursor-derived technologies. High-grade ore is increasingly rare in Concord space.", unlocked: false },
            HYDROGEN_3: { name: "Hydrogen-3", basePrice: 300, description: "Also known as Tritium, this rare hydrogen isotope is a critical component in high-yield fusion reactors and experimental 'reality-bending' FTL drives. Found in trace amounts in some icy asteroids or harvested from gas giants with specialized (and often illegal) equipment. The Concord heavily regulates its production and sale.", unlocked: false }
        };
        const LOCATIONS_DATA = { 
            "Starbase Alpha": { 
                coords: { y: MAP_HEIGHT - 5, x: MAP_WIDTH - 7 }, type: STARBASE_CHAR_VAL, 
                isMajorHub: true, 
                sells: [ { id: "FUEL_CELLS", priceMod: 0.9, stock: 100 }, { id: "TECH_PARTS", priceMod: 1.1, stock: 30 }, { id: "MEDICAL_SUPPLIES", priceMod: 1.0, stock: 25 }, { id: "NAVIGATION_CHARTS", priceMod: 1.0, stock: 50 } ],
                buys: [ 
                    { id: "MINERALS", priceMod: 1.2, stock: 50 }, { id: "FOOD_SUPPLIES", priceMod: 1.1, stock: 50 }, 
                    { id: "RARE_METALS", priceMod: 1.3, stock: 15 }, { id: "ARTIFACT_SHARDS", priceMod: 1.5, stock: 5 }, 
                    { id: "XENO_ANTIQUES", priceMod: 1.8, stock: 2 }, { id: "PRECURSOR_DATACUBE", priceMod: 2.5, stock: 1}, 
                    { id: "VOID_CRYSTALS", priceMod: 1.6, stock: 3}, { id: "GENETIC_SAMPLES", priceMod: 1.4, stock: 10},
                    { id: "FORBIDDEN_TEXTS", priceMod: 0.7, stock: 3 }, { id: "PHASE_SHIFTED_ALLOY", priceMod: 3.0, stock: 1},
                    { id: "WAYFINDER_CORE", priceMod: 5.0, stock: 1 }, { id: "SENTIENT_MYCELIUM", priceMod: 1.2, stock: 4 }, 
                    { id: "PRECURSOR_STAR_MAP_FRAGMENT", priceMod: 4.0, stock: 1}, { id: "KTHARR_ANCESTRAL_BLADE", priceMod: 0.5, stock: 1 },
                    { id: "GOLD", priceMod: 1.1, stock: 30 }, { id: "PLATINUM_ORE", priceMod: 1.2, stock: 20 }, { id: "HYDROGEN_3", priceMod: 2.0, stock: 5 }
                ],
                scanFlavor: "Starbase Alpha: Major Concord trade hub and administrative center for Sol Sector. Its Xeno-Archaeology department in the 'Scholar's Spire' pays top credit for Precursor Algorithm Keys. The Obsidian Directorate is always interested in... unique acquisitions, operating from the heavily shielded 'Black Site Annex'. The Oracle of Cygnus in the Mystic Quarter sometimes trades prophecies for rare xeno-artifacts, if you can find her hidden sanctum."
            },
            "Planet Omega": { coords: { y: 7, x: 7 }, type: PLANET_CHAR_VAL, sells: [ { id: "MINERALS", priceMod: 0.8, stock: 200 }, { id: "FOOD_SUPPLIES", priceMod: 0.9, stock: 100 } ], buys: [ { id: "TECH_PARTS", priceMod: 1.3, stock: 10 }, { id: "RARE_METALS", priceMod: 1.1, stock: 20 } ], scanFlavor: "Planet Omega: Rich Dilithium deposits. Significant Precursor ruins dot the landscape, some appearing as immense, silent geometric structures half-buried in the crimson sands; some whisper of a dormant 'World Engine' beneath the surface. Concord research outposts monitor unusual energy fluctuations, wary of what they call 'Silencer Echoes' – faint, high-frequency transmissions that seem to emanate from the deepest ruins." },
            "Planet Xerxes": {  coords: { y: 3, x: MAP_WIDTH - 5 }, type: PLANET_CHAR_VAL, sells: [], buys: [], scanFlavor: "Planet Xerxes: Extreme environment, corrosive atmosphere, and crushing gravity. High Xenon Gas and heavy metal concentrations make it valuable, but deadly. Rumored pirate haven and site of ancient K'tharr battles; some say the 'bad spirits' here are echoes of failed K'tharr rituals or a malfunctioning Precursor 'guardian' system that affects psionic minds, causing vivid hallucinations of metallic spiders." }
        };
        var currentSectorOutpostData = null; 
        const RUMORS = [ 
            "Captain 'Voidfang' still plagues the Kepler Nebula. They say her ship, the 'Nightreaver', is faster than any Concord patrol, and she's looking for a legendary Precursor map that leads to the 'Silentium Expanse'. She supposedly has a K'tharr first mate, a disgraced warrior seeking redemption, who knows the old K'tharr star-paths. Some say she's already found a Precursor Star Map Fragment, and is seeking more to complete a 'Cosmic Sextant' that might point to the Precursor homeworld itself.",
            "That derelict capital ship in Gamma-7? Some say it's a 'Precursor' vessel, others claim it's a military ghost from the old Terran Wars, its AI still active and hostile. A few brave souls tried to board it... none returned. They say it 'sings' on subspace frequencies, a song of madness that lures ships to their doom. One survivor, driven mad, babbled about 'eyes in the dark' and a 'heart of void crystal' pulsing within the wreck.",
            "Young stars in the Orion Spur sectors often have asteroid belts rich in Iridium. Risky, but profitable. Watch for claim jumpers and the K'tharr mining guilds, who consider those belts sacred ground, burial sites of their ancestors. They guard them fiercely and are known to use phase-cloaked mines. They say some asteroids there are not asteroids at all, but dormant K'tharr bio-weapons or eggs of stellar creatures. One K'tharr elder was heard muttering about 'the waking of the Sky-Serpents' if the belts are disturbed too much.",
            "The K'tharr Hegemony is tightening its borders near the Serpentis Cluster. Fuel prices might spike if their trade routes are disrupted. They don't take kindly to outsiders, especially those carrying 'Forbidden Texts' or Precursor tech, which they deem 'unholy corruptions' that led to the Precursors' downfall. Their 'Void Priests' preach of a coming cleansing, and they're actively hunting for K'tharr Ancestral Blades stolen by 'infidels', believing each blade holds a piece of their collective soul and is needed for a ritual to 're-align the Sky-Gods'.",
            "The research team near the 'Whispering Anomaly' in Sector (-1, 4)? Vanished. Some say they found something they shouldn't have, something that... whispered back, promising power. Their last garbled transmission mentioned 'opening the way' to a 'realm of pure thought' and 'the entities beyond the veil of stars'. One crewman was found catatonic, clutching a Void Crystal, his mind shattered, muttering about 'star-songs' and 'the geometry of fear'.",
            "Starbase Alpha is offering bounties for information on pirate activity in the outer rim sectors. Concord's reach is long, but not infinite. They're particularly interested in any 'Voidfang' sightings and the location of her hidden base, rumored to be inside a hollowed-out asteroid cloaked with Precursor tech, possibly using Phase-Shifted Alloy. They also want any recovered K'tharr Honor Blades, no questions asked... well, few questions, and a hefty 'processing fee'. Rumor has it, the Obsidian Directorate wants the blades for more than just museum pieces.",
            "Artifact Shards are fetching high prices on the black market. Collectors are obsessed with 'Precursor' tech, believing it holds the key to FTL without Dilithium. The University of Cygnus Prime pays even more for intact Datacubes, hoping to unlock their secrets before the Concord classifies them as 'restricted knowledge' under the Galactic Security Act. They say one Datacube contains the location of a Precursor library, or a weapon of unimaginable power, perhaps even the schematics for a 'world-killer' or a 'reality-anchor'.",
            "Blue giants offer rich hydrogen, but their solar flares can fry your systems if you're not careful. Lost a good friend that way, chasing a 'perfect scoop'. He swore he saw ships dancing in the corona, made of pure light, beckoning him closer. Some say they are stellar elementals, ancient beings of pure energy, or perhaps Precursor guardians of sacred stars, still active after millennia. One Children of the Void text refers to them as 'Coronal Shepherds'.",
            "Heard a distress call from a mining outpost in Sector (2,5). Something about 'crystal entities' awakening in the deep mines. Sounded like a tall tale, but the outpost went silent shortly after. Concord has quarantined the sector, calling it a 'geological event', but survivors whisper of crystalline horrors that absorb energy and replicate, possibly a form of silicon-based life or a Precursor terraforming experiment gone wrong. They say the crystals 'sing' before they strike.",
            "The 'Silentium Expanse' beyond Sector (10,10) is uncharted. Legends say it's where stars go to die, or where something else entirely sleeps, something ancient and vast. The Precursors called it 'The Great Filter', a test for ascending civilizations. Some say it's a gateway to other universes, or the domain of the Void Dwellers, beings of pure nothingness who hunger for reality. No ship that has entered has ever returned with reliable data, only garbled, terrified last transmissions.",
            "A trader mentioned a hidden Outpost in the 'Graveyard of Ships' sector that deals in Forbidden Texts and Xeno-Antiques. High risk, high reward. They say it's run by a reclusive information broker known only as 'The Archivist', who is rumored to be an AI from before the Concord, possessing knowledge lost to time, including fragments of the K'tharr sacred scrolls and Precursor Star Map Fragments. They say The Archivist demands unique data in trade, not just credits, sometimes asking for 'memories' or 'experiences'.",
            "The 'Precursors' supposedly left 'Wayfinders' scattered across the galaxy. Finding one could lead to unimaginable discoveries... or doom. Each Wayfinder is said to point to another, forming a cosmic breadcrumb trail to their mythical homeworld, or their tomb, or perhaps the source of the 'Silencer' threat. The first signal was detected near a binary star in a volatile region...", 
            "There's a faction known as the 'Children of the Void' who worship anomalies. They're said to be... unpredictable, and sometimes hostile to those who 'disturb the sacred'. They seek to understand the 'language of creation' and achieve apotheosis by merging with the void. They collect Void Crystals for their rituals, and some say they can control lesser anomalies or even commune with the Sentient Mycelium to glimpse the future, or what they call 'the True Pattern'.",
            "The K'tharr are a proud, warrior race. Their spices are potent, but their justice is swift for those caught smuggling them into Concord space. Their homeworld is said to be a fortress, built around a black hole, powered by its accretion disk. They view the Precursors as heretics, and any who traffic in their tech as blasphemers. Their Ancestral Blades are said to be forged from fallen stars and can cut through Concord armor like paper, resonating with the wielder's 'Ki' or life-force, some even claim the blades 'speak' to their wielders.",
            "Void Crystals? Nasty stuff. Heard they can warp reality locally. Some cults use them in their rituals, trying to contact entities from 'beyond the veil'. Stay clear if you value your sanity. They say the crystals whisper your deepest fears and desires, and sometimes, grant them, at a terrible price. They are also a key component in some experimental Concord weapons designed to breach other dimensions, a project the Obsidian Directorate keeps under tight wraps.",
            "Some say the derelict ships aren't all accidental. There are whispers of 'ship-breakers', pirates who disable vessels and leave them for scavengers... after taking the best loot and sometimes, the crew for 'other purposes', like selling them to the K'tharr or using them in dark rituals involving Sentient Mycelium. Voidfang is rumored to be a master of this tactic, leaving no witnesses, only cold, silent hulks.",
            "The Galactic Concord is rumored to be developing a new type of FTL drive, one that doesn't rely on Dilithium, possibly based on recovered Precursor schematics. They're desperate for Precursor Datacubes to complete it, and they'll pay anything, or take it by force. The Obsidian Directorate is said to be leading this effort, and they don't play by the rules. They're also trying to weaponize Phase-Shifted Alloys for their new 'Nova' class destroyers, capable of phasing through enemy shields.",
            "There's a legend of a 'Genesis Planet' hidden deep within an uncharted nebula, a world teeming with life and untouched by any known civilization. Many have sought it; none have returned with proof. Some say it's guarded by a sentient nebula that tests the worthiness of visitors, or that it's made entirely of Sentient Mycelium, a single, planet-sized organism that dreams the universe into being, and can reshape reality within its domain. The K'tharr consider this nebula sacred, calling it the 'Cradle of the Sky-Gods'.",
            "Sentient Mycelium networks are said to span entire star systems, hidden within dense nebulae. Touching them can grant visions, or madness. Some traders pay highly for samples, believing it can unlock psychic potential or even allow communication across vast distances instantaneously. The K'tharr consider it a sacred plant, a gift from their void gods, used in their most sacred rituals to commune with Ancestral Echoes. Some say the Mycelium is older than the stars themselves.",
            "Phase-Shifted Alloys are the holy grail for shipwrights. A hull made of it could theoretically pass through solid matter. Finding even a scrap is like finding a king's ransom. The Precursors used it extensively in their most advanced constructs, including their Wayfinders and city-ships. Some say it's not an alloy at all, but a form of stabilized exotic matter from another dimension, and it slowly 'learns' to adapt to its environment, sometimes exhibiting strange, almost sentient behaviors.",
            "Heard some spacers talking about 'Ghost Fleets' in the uncharted territories. Ships that appear on sensors, then vanish. Some say they're K'tharr scouts, others, something far older. Some even whisper they are echoes of ships lost in wormholes, forever caught between dimensions, their crews driven mad by the experience, forever replaying their final moments. One pilot claimed his ship was briefly 'phased' with one, seeing its spectral crew staring back.",
            "The 'Oracle of Cygnus' at Starbase Alpha sometimes gives cryptic prophecies to those who bring her rare Xeno-Antiques. Most think she's just a charlatan, but a few swear by her words. She once predicted the K'tharr invasion of the Draco system, and the appearance of the 'Silentium Expanse' on long-range charts. She also mumbles about 'the return of the Star-Eaters' and the 'Cycle of Silence', an ancient Precursor prophecy that supposedly details the end of all light in the galaxy.",
            "Wormholes are tears in spacetime, unstable and dangerous. But some ancient texts speak of 'Stable Conduits' left by the Precursors. Finding one would revolutionize interstellar travel... or unleash whatever lies at the other end. Some say they lead to other galaxies, or even other times. The Concord heavily restricts research into them, fearing what they might unleash upon an unsuspecting galaxy. There are whispers of a 'Wormhole Nexus' hidden deep in K'tharr space.",
            "The 'Void Kraken' is a legend among deep-space haulers. A colossal, energy-based lifeform said to inhabit dark nebulae, preying on unwary ships. Most dismiss it as space-madness, but some derelicts are found with strange, energy-based scarring... and their crews are always missing. Some say it's a Precursor bio-weapon gone rogue, or a guardian of the void, perhaps even a 'Silencer' itself.",
            "There's a black market for 'Precursor Navigational Cores' on some remote outposts. They say these cores can interface with ancient Precursor hyperlanes, allowing for instantaneous travel across vast distances... if you can survive the trip and the entities that guard those lanes. They are often found within Precursor Star Map Fragments, and are said to sing to those who can listen, a song that charts paths through the impossible."
        ];

        // --- Lore Database ---
        const LORE_DATABASE = { 
            FACTION_CONCORD: { title: "Galactic Concord", category: "Factions", text: "The Galactic Concord is the dominant interstellar government, formed after the Terran Wars some three centuries ago. It strives to maintain peace and facilitate trade across thousands of member systems. Governed by a High Council and enforced by Sector Commands, its influence is vast. While generally seen as a force for order, its bureaucracy can be stifling, and its military arm, Concord Defense Force (CDF), is known for its efficiency and sometimes ruthless enforcement of Concord law. The Obsidian Directorate is its shadowy intelligence agency, rumored to operate outside normal legal channels, often dealing with threats deemed too sensitive for public knowledge, such as dangerous Precursor technologies or K'tharr incursions. Publicly, the Concord promotes ideals of unity and progress, but critics point to its vast surveillance network and the suppression of dissenting voices on fringe worlds. Many citizens, however, appreciate the stability and relative safety the Concord provides compared to the lawless outer rim.", unlocked: false },
            FACTION_KTHARR: { title: "K'tharr Hegemony", category: "Factions", text: "The K'tharr are a proud, militaristic saurian species from the Serpentis Cluster. Their society is built on strict honor codes, warrior traditions, and a rigid caste system dictated by bloodline and combat prowess. They are deeply spiritual, worshipping the void and celestial bodies (which they call 'Sky-Gods'), and view Precursor technology as heretical, believing it led to the Precursors' own destruction. The Hegemony is often in a state of cold war with the Concord, with frequent border skirmishes over resources and ideology. Their ships are fast, well-armed, and often utilize cloaking technology. K'tharr Ancestral Blades are symbols of immense power and status within their clans, said to contain the 'Ancestral Echoes' of past wielders. They view most other sentient species as 'unworthy' or 'inferior,' a stance that often complicates diplomatic relations, though they maintain pragmatic trade relations when it suits their interests.", unlocked: false },
            FACTION_PIRATES_VOID_VULTURES: { title: "Void Vultures", category: "Factions", text: "Not a unified faction, but a loose confederation of pirate clans and individual reavers who prey on shipping lanes. The 'Void Vultures' are one of the more notorious groups, known for their ruthlessness and distinctive black-and-red ship markings. They often operate from hidden bases in asteroid fields or dark nebulae, utilizing hit-and-run tactics with retrofitted freighters and agile interceptors. They often disable ships to plunder them rather than outright destroying them, unless provoked or if a bounty is high enough. Captain Voidfang is their most infamous leader, a cunning tactician with a reputation for always being one step ahead of the Concord.", unlocked: false },
            FACTION_CHILDREN_OF_THE_VOID: { title: "Children of the Void", category: "Factions", text: "A secretive cult that worships cosmic anomalies and the void itself. They believe these phenomena are manifestations of a higher consciousness or gateways to other realities. Their motives are often inscrutable, and they can be either helpful or hostile to those who encounter them near anomalies. They are known to collect Void Crystals for their rituals, which they claim allow them to 'hear the whispers of the universe' and predict future events or navigate hidden pathways through space. Some say their ultimate goal is to achieve a collective apotheosis by merging with the void itself, a concept most find terrifying. They refer to this event as the 'Great Awakening' or 'Final Silence'.", unlocked: false },
            LOCATION_STARBASE_ALPHA: { title: "Starbase Alpha", category: "Locations", text: LOCATIONS_DATA["Starbase Alpha"].scanFlavor, unlocked: false },
            LOCATION_PLANET_OMEGA: { title: "Planet Omega", category: "Locations", text: LOCATIONS_DATA["Planet Omega"].scanFlavor, unlocked: false },
            LOCATION_PLANET_XERXES: { title: "Planet Xerxes", category: "Locations", text: LOCATIONS_DATA["Planet Xerxes"].scanFlavor, unlocked: false },
            LOCATION_OUTPOST: { title: "Outposts", category: "Locations", text: "Scattered throughout the void, outposts are small, often independent stations that serve as vital resupply points, trading posts, or havens for those on the fringes of society. Their markets are limited, but they often have unique local rumors and a character all their own. Some are havens for smugglers and pirates, others are lonely research stations or struggling colonies.", unlocked: false },
            PHENOMENON_STAR: { title: "Stars", category: "Phenomena", text: "Suns are the hearts of stellar systems, providing light, heat, and the raw hydrogen fuel essential for FTL travel. They come in many types, from stable G-type stars like Sol to volatile blue giants and dying red dwarfs. Some, like pulsars or neutron stars, are extreme cosmic objects with unique properties and dangers. Ancient civilizations often worshipped their stars, and some Precursor structures seem designed to harness stellar energy directly.", unlocked: false },
            PHENOMENON_ASTEROID: { title: "Asteroid Fields", category: "Phenomena", text: "Belts of rock, ice, and metal, often remnants of planetary formation or shattered celestial bodies. They can be rich in minerals but are also hazardous to navigate and popular hiding spots for pirates. Some fields contain unique crystalline structures or are known to be ancient battlefields, littered with the debris of forgotten wars.", unlocked: false },
            PHENOMENON_NEBULA: { title: "Nebulae", category: "Phenomena", text: "Vast clouds of interstellar gas and dust. Emission nebulae glow brightly from ionized gas, reflection nebulae shine with light from nearby stars, and dark nebulae obscure what lies within. They can interfere with sensors and hide many secrets, from stellar nurseries to pirate bases, and even pockets of unique lifeforms or strange, psychoactive gases like those that form Sentient Mycelium.", unlocked: false },
            PHENOMENON_WORMHOLE: { title: "Wormholes", category: "Phenomena", text: "Unstable tears in spacetime that can connect distant points in the galaxy, or perhaps even other realities. Traversing them is dangerous and consumes significant fuel, with unpredictable exit points. Precursor texts hint at a network of stable 'Conduits' they used for rapid transit across their empire, but none have ever been found by modern civilizations. The Concord officially denies their existence, classifying any verified sightings as 'localized gravimetric shear events'.", unlocked: false },
            PHENOMENON_VOID_CRYSTALS: { title: "Void Crystals", category: "Technology & Phenomena", text: COMMODITIES.VOID_CRYSTALS.description + " These strange formations are often found near intense gravitational anomalies or within the hearts of particularly dense dark nebulae. They defy easy analysis, absorbing most sensor scans. Some theorize they are a form of exotic matter, or even biological in origin, perhaps the dormant state of some void-dwelling lifeform. Their value lies in their rarity and the esoteric research being conducted by fringe science groups and cults like the Children of the Void.", unlocked: false },
            XENO_PRECURSORS: { title: "The Precursors", category: "Xeno-Archaeology", text: "An ancient, highly advanced civilization that vanished eons ago, leaving behind enigmatic ruins, powerful artifacts, and unanswered questions across the galaxy. Their technology far surpassed current understanding, and factions like the Concord and various collectors desperately seek their relics. Why they disappeared is one of the greatest mysteries; theories range from self-ascension to a higher plane of existence, a catastrophic war against an unknown enemy (often dubbed 'The Silencers' or 'Star-Eaters'), a self-inflicted technological cataclysm due to experiments with spacetime, or even a voluntary departure from this dimension to escape an even greater threat. Some believe they seeded the galaxy with life, or that they await a time to return, judging the civilizations that followed. The concept of the 'Great Filter' – a hypothetical barrier to the long-term survival of intelligent life – is often associated with their fate.", unlocked: false },
            XENO_DERELICTS: { title: "Derelict Ships", category: "Xeno-Archaeology", text: "The galaxy is littered with the silent hulks of lost ships. Some are recent casualties of pirates or accidents, their emergency beacons long dead. Others are ancient mysteries from forgotten eras or unknown civilizations, their hulls scarred by weapons beyond current comprehension or simply worn down by eons adrift. Exploring them can be profitable, yielding salvage or lost cargo, but also dangerous, as some may still have active (and often hostile) automated defenses, dormant alien lifeforms, or be booby-trapped by their former owners or later scavengers.", unlocked: false },
            XENO_ANOMALIES: { title: "Cosmic Anomalies", category: "Xeno-Archaeology", text: "Regions of space where the laws of physics seem to break down or behave erratically. These can range from gravimetric distortions that crush hulls, temporal loops that replay moments in time, subspace echoes that whisper maddening secrets, to exotic particle clouds that interfere with ship systems or even induce mutations in organic matter. They are often dangerous but can sometimes yield unique data or rare materials like Void Crystals. Some are believed to be Precursor experiments gone awry, natural phenomena beyond current comprehension, or even the battle scars left by cosmic entities.", unlocked: false },
            
            TECH_FTL_DRIVES: { title: "FTL Drives", category: "Technology & Phenomena", text: "Faster-Than-Light travel is the backbone of interstellar civilization. Most common drives, like the standard Alcubierre-Ishikawa Warp Drive, utilize controlled warp field manipulation to contract spacetime ahead of the vessel and expand it behind, requiring Dilithium crystals as a focusing agent and energy conduit. Older, less stable 'jump drive' technology exists but is highly unpredictable and prone to misjumps into uncharted (and often hostile) territory. Rumors persist of Precursor 'hyperlane' networks that allow near-instantaneous travel between fixed points, and K'tharr ships are known for their unique FTL signatures that defy easy Concord tracking, possibly utilizing localized wormhole generation or a form of non-linear spacetime navigation.", unlocked: false },
            TECH_PHASE_SHIFT_ALLOY: { title: "Phase-Shifted Alloy", category: "Technology & Phenomena", text: COMMODITIES.PHASE_SHIFTED_ALLOY.description + " Its atomic structure seems to exist in multiple quantum states simultaneously, allowing it to briefly 'ignore' normal matter under specific energy conditions, effectively passing through it. Concord scientists have tried for decades to replicate it with limited success, often resulting in catastrophic instability or the alloy simply vanishing from this dimension. Precursor applications included advanced cloaking, interdimensional gateways, and potentially even weapons capable of bypassing conventional defenses.", unlocked: false },
            
            LEGEND_VOID_KRAKEN: { title: "The Void Kraken", category: "Myths & Legends", text: "A chilling legend among deep-space haulers and explorers. Said to be a colossal, energy-based or etheric lifeform inhabiting the darkest nebulae or the void between galaxies. Descriptions vary wildly: some claim it's a creature of pure shadow with glowing, malevolent eyes, others a being of shifting, impossible geometries that defy perception. Most dismiss it as space-madness, sensor ghosts, or misidentified stellar phenomena. However, some derelicts are found with strange, energy-based scarring that no known weapon could inflict, their logs wiped, and their crews invariably missing without a trace, fueling the terrifying myth of the Kraken's hunger.", unlocked: false },
            LEGEND_SENTIENT_MYCELIUM_NETWORK: { title: "Sentient Mycelium Network", category: "Myths & Legends", text: COMMODITIES.SENTIENT_MYCELIUM.description + " Some fringe theories suggest the network is not just a collection of fungi, but a single, galaxy-spanning superorganism, a 'Great Spore Mind' that dreams the universe, or at least observes it with an alien intellect. Contact is said to be transformative, offering glimpses of other realities or profound cosmic truths, but often at the cost of sanity or one's individual consciousness being subsumed into the network. The K'tharr revere it as a sacred entity, while the Concord views it as a dangerous biological hazard.", unlocked: false },
            
            REGION_SOL_SECTOR: { title: "Sol Sector (0,0)", category: "Notable Star Systems/Regions", text: "The birthplace of humanity's interstellar expansion and the heart of the Galactic Concord. Home to Starbase Alpha, the primary administrative and commercial hub of this region of space. While heavily patrolled by the CDF, its high traffic makes it a target for opportunistic pirates and smugglers. Contains several well-charted planets, including Planet Omega, a key research and resource center.", unlocked: true }, 
            REGION_KEPLER_NEBULA: { title: "Kepler Nebula", category: "Notable Star Systems/Regions", text: "A dense, turbulent nebula known for its rich mineral deposits and treacherous navigation. Its sensor-baffling properties make it a favored hiding spot for pirate clans, particularly the infamous Void Vultures. Concord patrols are infrequent and often meet with heavy resistance. Many a fortune has been made and lost in its swirling, irradiated clouds.", unlocked: false },
            REGION_SILENTIUM_EXPANSE: { title: "The Silentium Expanse", category: "Notable Star Systems/Regions", text: "A vast, largely uncharted region of space beyond the Concord's established borders. Long-range scans show an unusual dearth of stellar activity, and ships that venture too far often fail to return. Legends speak of it as the Precursors' 'Great Filter' or a domain of entities that predate the current universe. What secrets or horrors it holds remains one of the galaxy's greatest and most terrifying mysteries.", unlocked: false },


            COMMODITY_WAYFINDER_CORE: { title: "Wayfinder Core", category: "Commodities", text: COMMODITIES.WAYFINDER_CORE.description, unlocked: false },
            COMMODITY_KTHARR_ANCESTRAL_BLADE: { title: "K'tharr Ancestral Blade", category: "Commodities", text: COMMODITIES.KTHARR_ANCESTRAL_BLADE.description, unlocked: false },
            COMMODITY_PRECURSOR_STAR_MAP_FRAGMENT: { title: "Precursor Star Map Fragment", category: "Commodities", text: COMMODITIES.PRECURSOR_STAR_MAP_FRAGMENT.description, unlocked: false },
            MYSTERY_WAYFINDER_QUEST: { title: "The Precursor Wayfinder", category: "Mysteries", text: "Ancient legends speak of Precursor 'Wayfinders', devices capable of charting paths through the deepest voids and perhaps even between galaxies. The Galactic Concord has long sought these mythical artifacts. Rumors suggest a signal from one was recently detected...", unlocked: false },
            MYSTERY_WAYFINDER_QUEST_COMPLETED: { title: "Wayfinder Activated", category: "Mysteries", text: "You successfully located and activated a Precursor Wayfinder. Its core contains fragmented charts hinting at paths into the Silentium Expanse and a location known as the 'First Nexus'. This discovery could change the course of galactic exploration, but also attract unwanted attention. The journey has just begun.", unlocked: false }
        };
        
        // --- Global State Variables - Declare globally, instantiate in initializeGame ---
        var playerX, playerY, playerFuel, playerCredits, playerShields; 
        var playerShip;
        var playerShipClass; 
        var playerNotoriety; 
        var playerNotorietyTitle; 
        var playerIsChargingAttack; 
        var playerIsEvading;      
        var playerHull;
        var playerLevel; 
        var playerXP;    
        var xpToNextLevel; 
        var currentSectorX, currentSectorY; 
        
        var playerCargo = {}; 
        var currentCargoLoad = 0; 
        var gameMapGrid = []; 
        // var gameMapCellElements = []; // Removed for reverted map rendering
        var message = ""; 
        var currentTradeContext = null; 
        var currentCombatContext = null; 
        var currentOutfitContext = null; 
        var currentMissionContext = null; 
        var playerActiveMission = null; 
        var missionsAvailableAtStation = [];
        var currentVictoryContext = null; 
        var currentNPCTradeContext = null;
        var currentSectorNPCs = [];
        var interactionTargetNPC = null; 
        
        var playerCompletedMissions = new Set(); 
        var scannedObjectTypes = new Set(); 
        var discoveredLocations = new Set(); 
        var sectorCache = {}; 
        var currentQuantityInput = ""; 
        var currentSectorName = "Sol Sector"; 
        var discoveredLoreEntries = new Set();


        // Mystery State
        var mystery_wayfinder_progress; 
        var mystery_wayfinder_finalLocation; 
        const MYSTERY_WAYFINDER_TARGET_SECTOR_VOLATILITY = 5; 
        const MYSTERY_WAYFINDER_ANOMALY_HINT_TYPE = 'unstable warp pocket'; 
        const MYSTERY_WAYFINDER_DERELICT_HINT_TYPE = 'Concord patrol craft'; 
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MIN = -5; 
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MAX = -1;
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MIN = 1;
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MAX = 5;

        // --- Mission Data ---
        const MISSIONS_DATABASE = {
            "Starbase Alpha": [ 
                {
                    id: "BOUNTY_SOL_PIRATES_1",
                    title: "Sol Sector Cleanup",
                    briefing: "Concord Security offers a reward for eliminating pirate threats in the Sol sector.",
                    description: "Pirate activity has been reported in the Sol sector (0,0). Eliminate 3 pirate vessels to claim your reward. This is a standard Concord security contract.",
                    type: "BOUNTY",
                    giver: "Starbase Alpha", 
                    objectives: [{ type: "ELIMINATE", targetName: "Pirate", count: 3, targetSectorKey: "0,0" }], 
                    rewards: { credits: 300, xp: 50, notoriety: 5 },
                    prerequisites: null, 
                    isRepeatable: false
                },
                {
                    id: "DELIVERY_OMEGA_TECH",
                    title: "Tech Parts for Omega",
                    briefing: "Planet Omega's research division requires urgent tech parts.",
                    description: "Deliver 5 units of Tech Parts to Planet Omega in the Sol sector (0,0). The science teams are waiting for these components for critical research. Return to Starbase Alpha Trade Authority for payment.",
                    type: "DELIVERY",
                    giver: "Starbase Alpha", 
                    objectives: [{ type: "DELIVER", itemID: "TECH_PARTS", count: 5, destinationName: "Planet Omega", destinationSectorKey: "0,0" }],
                    rewards: { credits: 200, xp: 40, notoriety: 2 },
                    prerequisites: null,
                    isRepeatable: false
                },
                {
                    id: "SURVEY_SOL_ANOMALY",
                    title: "Survey Gravimetric Anomaly",
                    briefing: "Concord Science Division seeks data on a nearby gravimetric wave.",
                    description: "Scan a 'gravimetric wave' type anomaly. Any sector will do for initial data, but higher sensor readings are appreciated. Return to Starbase Alpha with your findings.",
                    type: "SURVEY",
                    giver: "Starbase Alpha", 
                    objectives: [{ type: "SCAN_OBJECT", targetType: "anomaly", subtype: "gravimetric wave", sectorKey: "ANY" }], 
                    rewards: { credits: 150, xp: 60, notoriety: 1 },
                    prerequisites: null,
                    isRepeatable: false
                }
            ]
        };


        // --- DOM Elements ---
        var gameMapElement;
        var messageAreaElement;
        var fuelStatElement;
        var creditsStatElement;
        var cargoStatElement;
        var shieldsStatElement;
        var hullStatElement; 
        var sectorNameStatElement; 
        var sectorCoordsStatElement; 
        var levelXpStatElement; 
        var shipClassStatElement; 
        var notorietyStatElement; 
        var codexOverlayElement;
        var codexCategoriesElement;
        var codexEntriesElement;
        var codexEntryTextElement;   

        function getTileChar(tile) { if (typeof tile === 'object' && tile !== null && tile.char) return tile.char; return tile; }
        function getTileType(tile) { if (typeof tile === 'object' && tile !== null && tile.type) return tile.type; return null; }

        function calculateXpToNextLevel(level) {
            return Math.floor(BASE_XP_TO_LEVEL * Math.pow(level, XP_LEVEL_EXPONENT)); 
        }
        
        function applyPlayerShipStats() {
            const weapon = COMPONENTS_DATABASE[playerShip.weapon];
            const shield = COMPONENTS_DATABASE[playerShip.shield];
            const engine = COMPONENTS_DATABASE[playerShip.engine];

            PLAYER_ATTACK_DAMAGE = weapon.stats.damage;
            PLAYER_HIT_CHANCE = weapon.stats.hitChance;
            MAX_SHIELDS = shield.stats.maxShields;
            MAX_FUEL = engine.stats.maxFuel;

            if (playerShields > MAX_SHIELDS) playerShields = MAX_SHIELDS;
            if (playerFuel > MAX_FUEL) playerFuel = MAX_FUEL;
        }

        function updatePlayerNotoriety(amount) {
            playerNotoriety += amount;
            updateNotorietyTitle();
        }

        function updateNotorietyTitle() {
            let currentTitle = "Rookie Spacer"; 
            for (let i = NOTORIETY_TITLES.length - 1; i >= 0; i--) {
                if (playerNotoriety >= NOTORIETY_TITLES[i].score) {
                    currentTitle = NOTORIETY_TITLES[i].title;
                    break;
                }
            }
            if (playerNotoriety < 0) {
                 for (let i = 0; i < NOTORIETY_TITLES.length; i++) {
                    if (playerNotoriety <= NOTORIETY_TITLES[i].score) { 
                        currentTitle = NOTORIETY_TITLES[i].title;
                        break; 
                    }
                 }
            } else { 
                 for (let i = NOTORIETY_TITLES.length - 1; i >= 0; i--) {
                    if (playerNotoriety >= NOTORIETY_TITLES[i].score) {
                        currentTitle = NOTORIETY_TITLES[i].title;
                        break;
                    }
                }
            }
            playerNotorietyTitle = currentTitle;
        }


        function unlockLoreEntry(entryKey) {
            if (LORE_DATABASE[entryKey] && !discoveredLoreEntries.has(entryKey)) {
                discoveredLoreEntries.add(entryKey);
                LORE_DATABASE[entryKey].unlocked = true; 
                updateMessage(`<span style='color:#A2D2FF;'>Codex Updated: ${LORE_DATABASE[entryKey].title}</span>`, true);
            }
        }


        function initializeGame() {
            visitedSectors = new Set();
            scannedObjectTypes = new Set();
            discoveredLocations = new Set();
            playerCompletedMissions = new Set();
            sectorCache = {};
            playerCargo = {};
            Object.keys(COMMODITIES).forEach(id => playerCargo[id] = 0); 
            discoveredLoreEntries = new Set();
            missionsAvailableAtStation = [];
            gameMapGrid = []; 
            // gameMapCellElements = []; // Removed for reverted map rendering
            currentVictoryContext = null;
            currentNPCTradeContext = null;
            currentSectorNPCs = [];
            interactionTargetNPC = null;


            gameMapElement = document.getElementById('gameMap');
            messageAreaElement = document.getElementById('messageArea');
            fuelStatElement = document.getElementById('fuelStat');
            creditsStatElement = document.getElementById('creditsStat');
            cargoStatElement = document.getElementById('cargoStat');
            shieldsStatElement = document.getElementById('shieldsStat');
            hullStatElement = document.getElementById('hullStat');
            sectorNameStatElement = document.getElementById('sectorNameStat'); 
            sectorCoordsStatElement = document.getElementById('sectorCoordsStat'); 
            levelXpStatElement = document.getElementById('levelXpStat'); 
            shipClassStatElement = document.getElementById('shipClassStat'); 
            notorietyStatElement = document.getElementById('notorietyStat'); 
            codexOverlayElement = document.getElementById('codexOverlay');
            codexCategoriesElement = document.getElementById('codexCategories');
            codexEntriesElement = document.getElementById('codexEntries');
            codexEntryTextElement = document.getElementById('codexEntryText');   

            playerShip = { 
                weapon: "WEAPON_PULSE_LASER_MK1", 
                shield: "SHIELD_BASIC_ARRAY_A", 
                engine: "ENGINE_STD_DRIVE_MK1",
                scanner: "SCANNER_BASIC_SUITE" 
            };
            applyPlayerShipStats(); 

            playerFuel = MAX_FUEL; 
            playerCredits = INITIAL_CREDITS; 
            playerShields = MAX_SHIELDS; 
            playerHull = MAX_PLAYER_HULL; 
            playerShipClass = "Light Freighter"; 
            playerNotoriety = 0;
            updateNotorietyTitle();
            playerActiveMission = null;
            currentMissionContext = null; 
            
            playerLevel = 1; playerXP = 0; xpToNextLevel = calculateXpToNextLevel(playerLevel);
            visitedSectors.add("0,0"); 
            
            unlockLoreEntry("FACTION_CONCORD"); 
            unlockLoreEntry("XENO_PRECURSORS"); 
            unlockLoreEntry("MYSTERY_WAYFINDER_QUEST"); 
            unlockLoreEntry("REGION_SOL_SECTOR");
            Object.keys(COMPONENTS_DATABASE).forEach(key => { 
                if (COMPONENTS_DATABASE[key].loreKey) unlockLoreEntry(COMPONENTS_DATABASE[key].loreKey);
            });

            mystery_wayfinder_progress = 0; 
            mystery_wayfinder_finalLocation = null;
            currentSectorX = 0; currentSectorY = 0; 
            
            updateCurrentCargoLoad();
            loadOrGenerateSectorMap(currentSectorX, currentSectorY); 
            playerX = Math.floor(MAP_WIDTH / 2); playerY = Math.floor(MAP_HEIGHT / 2);
            ensurePlayerStartNotOccupied(); 
            currentTradeContext = null; currentCombatContext = null; currentOutfitContext = null; 
            updateMessage(`Welcome to ${currentSectorName} (${currentSectorX},${currentSectorY})! Use WASD to move.`);
            renderGame();
        }
        
        function loadOrGenerateSectorMap(sX, sY) { 
            const sectorKey = `${sX},${sY}`;
            currentSectorNPCs = []; 
            interactionTargetNPC = null;

            if (sectorCache[sectorKey]) {
                const cachedSector = sectorCache[sectorKey];
                gameMapGrid = JSON.parse(JSON.stringify(cachedSector.grid)); 
                currentSectorOutpostData = cachedSector.outpostData ? JSON.parse(JSON.stringify(cachedSector.outpostData)) : null;
                currentSectorName = cachedSector.name; 
                
                for (let y = 0; y < MAP_HEIGHT; y++) {
                    for (let x = 0; x < MAP_WIDTH; x++) {
                        const tile = gameMapGrid[y][x];
                        if (typeof tile === 'object' && tile !== null && tile.type === 'star') {
                            tile.scoopedThisVisit = false;
                        }
                         if (typeof tile === 'object' && tile !== null && tile.type === 'asteroid') { 
                            tile.minedThisVisit = false;
                        }
                    }
                }
            } else {
                generateNewSectorMapData(sX, sY);
                currentSectorName = generateSectorName(sX, sY); 
                sectorCache[sectorKey] = { 
                    grid: JSON.parse(JSON.stringify(gameMapGrid)), 
                    outpostData: currentSectorOutpostData ? JSON.parse(JSON.stringify(currentSectorOutpostData)) : null,
                    name: currentSectorName 
                };
            }
            spawnNPCsForSector(sX, sY); 
        }
        function generateNewSectorMapData(sX, sY) { 
            gameMapGrid=[];currentSectorOutpostData=null;for(let y=0;y<MAP_HEIGHT;y++){const r=[];for(let x=0;x<MAP_WIDTH;x++)r.push(EMPTY_SPACE_CHAR_VAL);gameMapGrid.push(r);}
            if(sX===0&&sY===0){for(const lN in LOCATIONS_DATA){const l=LOCATIONS_DATA[lN];if(l.coords&&l.type)gameMapGrid[l.coords.y][l.coords.x]=l.type;}}
            else{
                if(Math.random()<OUTPOST_SPAWN_CHANCE){const rX=Math.floor(Math.random()*(MAP_WIDTH-4))+2;const rY=Math.floor(Math.random()*(MAP_HEIGHT-4))+2;if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){gameMapGrid[rY][rX]=OUTPOST_CHAR_VAL;currentSectorOutpostData={name:`Outpost Kepler-${Math.abs(sX)}${Math.abs(sY)}${rX%10}${rY%10}`,coords:{y:rY,x:rX},type:OUTPOST_CHAR_VAL,isMajorHub:false,...generateOutpostMarket(),scanFlavor:"A lonely outpost, a speck of light in the vast darkness. They trade what they can, and always have an ear for news from the wider galaxy.",rumor:RUMORS[Math.floor(Math.random()*RUMORS.length)]};}}
                if(Math.random()<WORMHOLE_SPAWN_CHANCE&&!currentSectorOutpostData){const rX=Math.floor(Math.random()*(MAP_WIDTH-4))+2;const rY=Math.floor(Math.random()*(MAP_HEIGHT-4))+2;if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){gameMapGrid[rY][rX]={char:WORMHOLE_CHAR_VAL,type:'wormhole',stability:Math.random()};}}}
            
            const numStars=1+Math.floor(Math.random()*3);for(let i=0;i<numStars;i++){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL)gameMapGrid[rY][rX]={char:STAR_CHAR_VAL,type:'star',richness:Math.random(),starType:['G-type','Red dwarf','Blue giant','Binary','Neutron Star','White Dwarf','Pulsar','Protostar','Wolf-Rayet','Rogue Star','Black Hole Accretion Disk (Visual Only)'][Math.floor(Math.random()*11)],scoopedThisVisit:false};}
            
            const ASTEROID_TYPES = {
                "Common Silicate": [{id: "MINERALS", chance: 0.9, minYield: 5, maxYield: 20}],
                "Metallic Core": [{id: "MINERALS", chance: 0.5, minYield: 10, maxYield: 25}, {id: "RARE_METALS", chance: 0.3, minYield: 1, maxYield: 5}, {id: "GOLD", chance: 0.15, minYield: 1, maxYield: 3}],
                "Icy Cluster": [{id: "MINERALS", chance: 0.4, minYield: 3, maxYield: 10}, {id: "HYDROGEN_3", chance: 0.05, minYield: 1, maxYield: 2}], 
                "Exotic Crystalline": [{id: "PLATINUM_ORE", chance: 0.4, minYield: 1, maxYield: 4}, {id: "VOID_CRYSTALS", chance: 0.02, minYield: 1, maxYield: 1}] 
            };
            const asteroidTypeKeys = Object.keys(ASTEROID_TYPES);
            const numAsteroids=Math.floor(Math.random()*3);
            for(let i=0;i<numAsteroids;i++){
                const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);
                if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){
                    const chosenTypeKey = asteroidTypeKeys[Math.floor(Math.random() * asteroidTypeKeys.length)];
                    gameMapGrid[rY][rX]={char:ASTEROID_CHAR_VAL,type:'asteroid',density:Math.random(), asteroidType: chosenTypeKey, resources: ASTEROID_TYPES[chosenTypeKey], minedThisVisit: false};
                }
            }

            if(Math.random()<0.20){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL)gameMapGrid[rY][rX]={char:NEBULA_CHAR_VAL,type:'nebula',density:Math.random()};}
            if(Math.random()<0.15){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){const dS=['freighter','explorer','corvette','science vessel','luxury liner','mining barge','unknown wreckage','ancient probe','ghost ship','colony transport','prison hulk','sleeper ship','medical frigate','smuggler runabout','precursor sentinel','K\'tharr warscout','Concord patrol craft','diplomatic courier','generation ship fragment','orbital habitat shard','research outpost remains','K\'tharr broodship fragment','Concord black ops vessel','derelict Precursor surveyor','ancient stellar observatory','lost K\'tharr honor guard ship','abandoned listening post','deep space prison barge','ancient Precursor arkship','K\'tharr \'Shadow Hunter\' stealth vessel','Concord \'Aegis\' class cruiser fragment','lost generation ship','Precursor \'World Shaper\' fragment'];gameMapGrid[rY][rX]={char:DERELICT_CHAR_VAL,type:'derelict',subtype:dS[Math.floor(Math.random()*dS.length)]};}}
            if(Math.random()<0.10){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){const aS=['gravimetric wave','temporal distortion','subspace echo','exotic particle cloud','void fissure','rogue sensor ghost','energy surge','whispering void','chromatic shimmer','localized reality shear','sentient stardust cloud','echoes of creation','cosmic string fragment','unstable warp pocket','null-space bubble','precursor energy field','memory of a star','song of the void','echoes of a dying god','localized chronal stutter','reality bloom','dimensional bleed','psionic storm front','causal loop fragment','void bloom','K\'tharr void rift','Concord FTL test site (failed)','Precursor defense grid node','echoes of a Precursor battle','localized sentience field','K\'tharr ritual site echo','chroniton feedback loop','sentient solar flare','void organism spoor field','fragmented Precursor archive','Concord FTL catastrophe echo','K\'tharr ancestral echo','Precursor dreamscape fragment'];gameMapGrid[rY][rX]={char:ANOMALY_CHAR_VAL,type:'anomaly',subtype:aS[Math.floor(Math.random()*aS.length)]};}}}
        
        const SECTOR_NAME_PARTS = {
            TIER1_PREFIX: ["Nova", "Kepler", "Orion", "Cygnus", "Lyra", "Terra", "Sol", "Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Eta", "Theta", "Iota", "Kappa", "Lambda", "Mu", "Nu", "Xi", "Omicron", "Pi", "Rho", "Sigma", "Tau", "Upsilon", "Phi", "Chi", "Psi", "Omega", "Centauri", "Proxima", "Sirius", "Vega", "Altair", "Regulus", "Spica", "Arcturus", "Capella", "Rigel", "Betelgeuse", "Aldebaran", "Pollux", "Castor", "Deneb", "Fomalhaut", "Antares", "Canopus"],
            TIER1_ROOT: ["Reach", "Spur", "Arm", "Belt", "Cluster", "Expanse", "Frontier", "Verge", "Fields", "Plains", "Depths", "Shallows", "Haven", "Port", "Gate", "Passage", "Crossing", "Junction", "Nexus", "Hub", "Core", "Heart", "Prime", "Minor", "Major", "Central", "Inner", "Outer", "Drift", "Currents", "Flow", "Stream", "Shoals", "Banks", "Flats", "Heights", "Ridge", "Valley", "Canyon", "Basin"],
            TIER2_PREFIX: ["Serpentis", "Draco", "Hydra", "Lupus", "Corvus", "Volans", "Crux", "Carina", "Vela", "Pictor", "Indus", "Pavo", "Tucana", "Grus", "Phoenix", "Horologium", "Reticulum", "Dorado", "Mensa", "Chamaeleon", "Apus", "Musca", "Circinus", "Triangulum", "Norma", "Ara", "Telescopium", "Corona", "Fornax", "Sculptor", "Caelum", "Eridanus", "Cetus", "Aquarius", "Capricornus", "Sagittarius", "Scorpius", "Libra", "Virgo", "Leo", "Cancer", "Gemini", "Taurus", "Aries", "Pisces", "Ophiuchus", "Lyra Minor", "Ursa Major", "Ursa Minor", "Canis Major", "Canis Minor", "Perseus", "Andromeda", "Cassiopeia", "Cepheus", "Lacerta", "Pegasus", "Delphinus", "Equuleus", "Aquila", "Sagitta", "Vulpecula", "Cygnus Minor"],
            TIER2_ROOT: ["Void", "Abyss", "Chasm", "Gulf", "Maelstrom", "Nebula", "Wastes", "Badlands", "Peril", "Hazard", "Brink", "Edge", "Terminus", "Limit", "Maw", "Jaws", "Teeth", "Claws", "Fangs", "Spines", "Thorns", "Barrens", "Wilds", "Expanse", "Deeps", "Shroud", "Veil", "Mist", "Gloom", "Shadow", "Dark", "Grim", "Bleak", "Despair", "Sorrow", "Fear", "Dread", "Terror", "Whispers", "Echoes", "Silence", "Stillness", "Emptiness"],
            TIER3_PREFIX: ["Xylos", "Zylos", "Varkos", "Kryll", "Ghor", "Thrax", "Zargon", "Vorlag", "Nyx", "Erebus", "Tartarus", "Styx", "Acheron", "Phlegethon", "Cocytus", "Lethe", "Hades", "Gehenna", "Sheol", "Abaddon", "Apollyon", "Azrael", "Thanatos", "Moros", "Ker", "Keres", "Yama", "Hel", "Niflheim", "Muspelheim", "Jotunheim", "Svartalfheim", "Yomi", "Kur", "Irkalla", "Duat", "Xibalba", "Mictlan", "Naraka", "Patala", "Annwn", "Tuonela", "Adlivun", "Ukhu Pacha", "Chinvat", "Hamistagan", "Pescha", "Arqa", "Diyu"],
            TIER3_ROOT: ["Oblivion", "Annihilation", "Desolation", "Ruin", "Terror", "Horror", "Madness", "Silence", "Emptiness", "Nothingness", "End", "Omega", "Ultima", "Finality", "Doom", "Blight", "Scourge", "Plague", "Curse", "Hex", "Bane", "Wrath", "Fury", "Storm", "Tempest", "Vortex", "Singularity", "Anomaly", "Paradox", "Enigma", "Labyrinth", "Maze", "Prison", "Tomb", "Crypt", "Sepulcher", "Citadel", "Fortress", "Bastion", "Stronghold", "Domain", "Realm", "Kingdom", "Empire", "Cataclysm", "Apocalypse", "Judgement", "Nadir", "Zero"]
        };

        function generateSectorName(sX, sY) {
            if (sX === 0 && sY === 0) return "Sol Sector"; 

            const absX = Math.abs(sX);
            const absY = Math.abs(sY);
            const maxCoord = Math.max(absX, absY);

            let prefixList, rootList;

            if (maxCoord < 5) {
                prefixList = SECTOR_NAME_PARTS.TIER1_PREFIX;
                rootList = SECTOR_NAME_PARTS.TIER1_ROOT;
            } else if (maxCoord < 15) {
                prefixList = SECTOR_NAME_PARTS.TIER2_PREFIX;
                rootList = SECTOR_NAME_PARTS.TIER2_ROOT;
            } else {
                prefixList = SECTOR_NAME_PARTS.TIER3_PREFIX;
                rootList = SECTOR_NAME_PARTS.TIER3_ROOT;
            }
            
            const prefix = prefixList[Math.floor(Math.random() * prefixList.length)];
            const root = rootList[Math.floor(Math.random() * rootList.length)];
            
            return `${prefix} ${root}`;
        }
        var currentSectorName = "Sol Sector"; // Changed to var


        function generateOutpostMarket() { /* Same as v0.6.11 */ const cK=Object.keys(COMMODITIES);let sI=null,bI=null;const sLb=cK.filter(id=>!["RARE_METALS","TECH_PARTS","ARTIFACT_SHARDS","XENO_ANTIQUES","FORBIDDEN_TEXTS","PRECURSOR_DATACUBE","VOID_CRYSTALS","SENTIENT_MYCELIUM","PHASE_SHIFTED_ALLOY","WAYFINDER_CORE","KTHARR_ANCESTRAL_BLADE","PRECURSOR_STAR_MAP_FRAGMENT"].includes(id));if(sLb.length>0){const sID=sLb[Math.floor(Math.random()*sLb.length)];sI={id:sID,priceMod:1.0+(Math.random()*0.2-0.1),stock:10+Math.floor(Math.random()*21)};}const bLb=cK.filter(id=>(!sI||id!==sI.id)&&!["ARTIFACT_SHARDS","XENO_ANTIQUES","FORBIDDEN_TEXTS","PRECURSOR_DATACUBE","VOID_CRYSTALS","SENTIENT_MYCELIUM","PHASE_SHIFTED_ALLOY","WAYFINDER_CORE","KTHARR_ANCESTRAL_BLADE","PRECURSOR_STAR_MAP_FRAGMENT"].includes(id));if(bLb.length>0){const bID=bLb[Math.floor(Math.random()*bLb.length)];bI={id:bID,priceMod:1.0+(Math.random()*0.2-0.05),stock:15+Math.floor(Math.random()*26)};}return{sells:sI?[sI]:[],buys:bI?[bI]:[]};}
        function ensurePlayerStartNotOccupied() { /* Same as v0.6.7 */ if (getTileChar(gameMapGrid[playerY][playerX]) !== EMPTY_SPACE_CHAR_VAL) { let fE = false; for(let i=-1;i<=1;i++){for(let j=-1;j<=1;j++){if(i===0&&j===0)continue;const cY=playerY+i,cX=playerX+j;if(cY>=0&&cY<MAP_HEIGHT&&cX>=0&&cX<MAP_WIDTH&&getTileChar(gameMapGrid[cY][cX])===EMPTY_SPACE_CHAR_VAL){playerX=cX;playerY=cY;fE=true;break;}}if(fE)break;} if(!fE){if(getTileChar(gameMapGrid[0][0])===EMPTY_SPACE_CHAR_VAL){playerX=0;playerY=0;}else{for(let r=0;r<MAP_HEIGHT;r++){for(let c=0;c<MAP_WIDTH;c++){if(getTileChar(gameMapGrid[r][c])===EMPTY_SPACE_CHAR_VAL){playerX=c;playerY=r;fE=true;break;}}if(fE)break;}}}}}
        function updateCurrentCargoLoad() { /* Same as v0.6.7 */ currentCargoLoad = 0; for (const cID in playerCargo) currentCargoLoad += playerCargo[cID]; }

        function renderGame() { 
             // Reverted map rendering: Clear and recreate map elements on each render
            gameMapElement.innerHTML = ''; 
            for (let y = 0; y < MAP_HEIGHT; y++) {
                const rowDiv = document.createElement('div');
                for (let x = 0; x < MAP_WIDTH; x++) {
                    const cellSpan = document.createElement('span');
                    let tileData = gameMapGrid[y][x];
                    let tileChar = getTileChar(tileData);
                    let className = '';

                    let npcOnTile = currentSectorNPCs.find(npc => npc.x === x && npc.y === y);

                    if (currentCombatContext && x === playerX && y === playerY) {
                        tileChar = PIRATE_CHAR_VAL;
                        className = 'pirate-char';
                    } else if (x === playerX && y === playerY) {
                        tileChar = PLAYER_CHAR_VAL;
                        className = 'player-char';
                    } else if (npcOnTile) {
                        tileChar = npcOnTile.char;
                        className = 'npc-trader-char'; 
                    } else {
                        switch(tileChar) {
                            case STAR_CHAR_VAL: className = 'star-char'; break;
                            case PLANET_CHAR_VAL: className = 'planet-char'; break;
                            case STARBASE_CHAR_VAL: className = 'starbase-char'; break;
                            case OUTPOST_CHAR_VAL: className = 'outpost-char'; break;
                            case ASTEROID_CHAR_VAL: className = 'asteroid-char'; break;
                            case NEBULA_CHAR_VAL: className = 'nebula-char'; break;
                            case DERELICT_CHAR_VAL: className = 'derelict-char'; break;
                            case ANOMALY_CHAR_VAL: className = 'anomaly-char'; break;
                            case WORMHOLE_CHAR_VAL: className = 'wormhole-char'; break;
                            case EMPTY_SPACE_CHAR_VAL: className = 'empty-space-char'; break;
                            default: className = 'empty-space-char'; 
                        }
                    }
                    cellSpan.textContent = tileChar;
                    if (className) cellSpan.className = className;
                    rowDiv.appendChild(cellSpan);
                }
                gameMapElement.appendChild(rowDiv);
            }

            if (currentVictoryContext) {
                messageAreaElement.innerHTML = currentVictoryContext.message.replace(/\n/g, '<br>');
            } else if (currentNPCTradeContext) {
                // Message area is handled by NPC trade functions, no need to overwrite here
            }
             else {
                messageAreaElement.innerHTML = message.replace(/\n/g, '<br>');
            }

            fuelStatElement.textContent = `${playerFuel.toFixed(1)}/${MAX_FUEL.toFixed(1)}`; 
            shieldsStatElement.textContent = `${playerShields}/${MAX_SHIELDS}`;
            hullStatElement.textContent = `${playerHull}/${MAX_PLAYER_HULL}`; 
            creditsStatElement.textContent = playerCredits;
            cargoStatElement.textContent = `${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}`;
            levelXpStatElement.textContent = `${playerLevel} (${playerXP}/${xpToNextLevel})`; 
            shipClassStatElement.textContent = playerShipClass;
            notorietyStatElement.textContent = playerNotorietyTitle; 
            sectorNameStatElement.textContent = currentSectorName; 
            sectorCoordsStatElement.textContent = `(${currentSectorX},${currentSectorY})`; 
            document.getElementById('versionInfo').textContent = `Wayfinder: Echoes of the Void - ${GAME_VERSION}`;
        }

        function updateMessage(newMessage, append = false) { 
            if (currentVictoryContext || currentNPCTradeContext) return; 

            if (append) {
                 message += "\n" + newMessage;
            } else {
                message = newMessage;
            }
            if (!currentTradeContext && !currentCombatContext && !currentOutfitContext && !currentMissionContext && playerActiveMission) {
                let missionStatus = `<span style='color:#FFFF00;'>Active Mission: ${playerActiveMission.title}`;
                if (playerActiveMission.isComplete) {
                    missionStatus += ` - Ready to turn in at ${playerActiveMission.giver}. (Press G)</span>`;
                } else {
                    let firstIncompleteObjective = "";
                    for(let i=0; i < playerActiveMission.objectives.length; i++) {
                        const obj = playerActiveMission.objectives[i];
                        const progressKey = `${obj.type.toLowerCase()}_${i}`; 
                        const objectiveProgress = playerActiveMission.progress[progressKey];
                        
                        if (objectiveProgress && !objectiveProgress.complete) { 
                            if (obj.type === "ELIMINATE") {
                                firstIncompleteObjective = ` - Eliminate ${objectiveProgress.required - objectiveProgress.current} more ${obj.targetName}(s)`;
                                if (obj.targetSectorKey !== "ANY") firstIncompleteObjective += ` in ${obj.targetSectorKey}`;
                                 firstIncompleteObjective += ".";
                            } else if (obj.type === "SURVEY") {
                                firstIncompleteObjective = ` - Scan ${obj.subtype} ${obj.targetType}`;
                                 if (obj.sectorKey !== "ANY") firstIncompleteObjective += ` in ${obj.sectorKey}`;
                                 firstIncompleteObjective += ".";
                            } else if (obj.type === "DELIVERY") {
                                firstIncompleteObjective = ` - Deliver ${objectiveProgress.required - (objectiveProgress.delivered || 0)} ${COMMODITIES[obj.itemID].name} to ${obj.destinationName}.`;
                            }
                            break;
                        }
                    }
                    missionStatus += firstIncompleteObjective + "</span>";
                }
                message += "\n" + missionStatus;
            }
        }
        function getCombinedLocationData(y,x) { 
            if (currentSectorX === 0 && currentSectorY === 0) { 
                for(const n in LOCATIONS_DATA) {
                    if(LOCATIONS_DATA[n].coords.y===y && LOCATIONS_DATA[n].coords.x===x) return {name:n, ...LOCATIONS_DATA[n]};
                }
            } 
            if (currentSectorOutpostData && currentSectorOutpostData.coords.y === y && currentSectorOutpostData.coords.x === x) {
                return currentSectorOutpostData;
            } 
            return null;
        }

        function traverseWormhole() { 
            if (playerFuel < WORMHOLE_TRAVEL_FUEL_COST) {
                updateMessage(`Cannot traverse: Requires ${WORMHOLE_TRAVEL_FUEL_COST} fuel, you have ${playerFuel.toFixed(1)}.`); 
                renderGame();
                return;
            }
            playerFuel -= WORMHOLE_TRAVEL_FUEL_COST;
            playerFuel = parseFloat(playerFuel.toFixed(1));
            let jumpX = Math.floor(Math.random() * (WORMHOLE_JUMP_MAX_DIST - WORMHOLE_JUMP_MIN_DIST + 1)) + WORMHOLE_JUMP_MIN_DIST;
            let jumpY = Math.floor(Math.random() * (WORMHOLE_JUMP_MAX_DIST - WORMHOLE_JUMP_MIN_DIST + 1)) + WORMHOLE_JUMP_MIN_DIST;
            if (Math.random() < 0.5) jumpX *= -1;
            if (Math.random() < 0.5) jumpY *= -1;
            currentSectorX += jumpX;
            currentSectorY += jumpY;
            playerX = Math.floor(MAP_WIDTH / 2);
            playerY = Math.floor(MAP_HEIGHT / 2);
            loadOrGenerateSectorMap(currentSectorX, currentSectorY); 
            ensurePlayerStartNotOccupied(); 
            let warpMessage = `The wormhole violently ejects you into an unknown region!\nArrived in ${currentSectorName} (${currentSectorX},${currentSectorY}).`; 
            const newSectorKey = `${currentSectorX},${currentSectorY}`;
            if (!visitedSectors.has(newSectorKey)) {
                visitedSectors.add(newSectorKey);
                updatePlayerNotoriety(1); 
                playerXP += XP_PER_NEW_SECTOR_DISCOVERY + XP_WORMHOLE_TRAVERSE; 
                warpMessage += `\n<span style='color:#00FF00;'>New Sector Discovered via Wormhole! +${XP_PER_NEW_SECTOR_DISCOVERY + XP_WORMHOLE_TRAVERSE} XP!</span>`;
                checkLevelUp();
            } else {
                 playerXP += XP_WORMHOLE_TRAVERSE;
                 warpMessage += `\n<span style='color:#00DD00;'>Wormhole Traversed! +${XP_WORMHOLE_TRAVERSE} XP!</span>`;
                 checkLevelUp();
            }
            unlockLoreEntry("PHENOMENON_WORMHOLE"); 
            updateMessage(warpMessage);
            handleInteraction(); 
            renderGame();
        }


        function movePlayer(dx, dy) { 
            if(currentTradeContext || currentOutfitContext || currentMissionContext || currentVictoryContext || currentNPCTradeContext){updateMessage("Complete current action (L to leave, Enter to continue).");renderGame();return;} 
            if(currentCombatContext){updateMessage("In combat! (F)ight or (R)un.");renderGame();return;}
            
            const currentEngine = COMPONENTS_DATABASE[playerShip.engine];
            const actualFuelPerMove = BASE_FUEL_PER_MOVE * (currentEngine.stats.fuelEfficiency || 1.0);

            if(playerFuel < actualFuelPerMove &&(dx!==0||dy!==0)){updateMessage("Out of fuel!");renderGame();return;}
            
            let nX=playerX+dx; let nY=playerY+dy; let sC=false;
            
            if(nX<0){currentSectorX--;nX=MAP_WIDTH-1;sC=true;}
            else if(nX>=MAP_WIDTH){currentSectorX++;nX=0;sC=true;}
            if(nY<0){currentSectorY--;nY=MAP_HEIGHT-1;sC=true;}
            else if(nY>=MAP_HEIGHT){currentSectorY++;nY=0;sC=true;}
            
            playerX=nX;playerY=nY;
            if(dx!==0||dy!==0){
                playerFuel-=actualFuelPerMove;
                playerFuel = parseFloat(playerFuel.toFixed(1)); 
                if(playerFuel<0)playerFuel=0;
            }
            
            if(sC){
                loadOrGenerateSectorMap(currentSectorX,currentSectorY); 
                ensurePlayerStartNotOccupied();
                let wM=`Warped to ${currentSectorName} (${currentSectorX},${currentSectorY}).`; 
                const nSK=`${currentSectorX},${currentSectorY}`;
                if(!visitedSectors.has(nSK)&&(currentSectorX!==0||currentSectorY!==0)){
                    visitedSectors.add(nSK);
                    playerXP+=XP_PER_NEW_SECTOR_DISCOVERY;
                    updatePlayerNotoriety(1); 
                    wM+=`\n<span style='color:#00FF00;'>New Sector Discovered! +${XP_PER_NEW_SECTOR_DISCOVERY} XP!</span>`;
                    checkLevelUp();
                }
                updateMessage(wM);
                const nSTO=gameMapGrid[playerY][playerX];const nSTC=getTileChar(nSTO);const nSTT=getTileType(nSTO);
                if((nSTC===EMPTY_SPACE_CHAR_VAL||nSTT==='asteroid'||nSTT==='derelict'||nSTT==='anomaly'|| nSTT==='wormhole')&&Math.random()<PIRATE_ENCOUNTER_CHANCE)startCombat();else handleInteraction();
            } else { 
                const currentTileObjectInternal = gameMapGrid[playerY][playerX]; 
                const currentTileCharInternal = getTileChar(currentTileObjectInternal); 
                const currentTileTypeInternal = getTileType(currentTileObjectInternal);

                if(mystery_wayfinder_progress===4&&mystery_wayfinder_finalLocation&&currentSectorX===mystery_wayfinder_finalLocation.sectorX&&currentSectorY===mystery_wayfinder_finalLocation.sectorY&&playerX===mystery_wayfinder_finalLocation.x&&playerY===mystery_wayfinder_finalLocation.y){
                    updateMessage(`You've arrived at the precise coordinates. A hidden Precursor Wayfinder activates!\nIts energy core hums, revealing fragmented charts pointing towards the Silentium Expanse and a 'First Nexus'.\n<span style='color:#DA70D6;'>+5000 Credits! +${XP_MYSTERY_REWARD} XP! Wayfinder Core acquired!</span>`);
                    playerCredits+=5000;playerXP+=XP_MYSTERY_REWARD;
                    updatePlayerNotoriety(100); 
                    if(playerCargo.WAYFINDER_CORE<PLAYER_CARGO_CAPACITY-currentCargoLoad){playerCargo.WAYFINDER_CORE=(playerCargo.WAYFINDER_CORE||0)+1;updateCurrentCargoLoad();}else{updateMessage("Wayfinder Core acquired, but no cargo space! It's left floating here.",true);}
                    mystery_wayfinder_progress=5;checkLevelUp();
                    unlockLoreEntry("MYSTERY_WAYFINDER_QUEST_COMPLETED"); 
                }else if((currentTileCharInternal===EMPTY_SPACE_CHAR_VAL||currentTileTypeInternal==='asteroid'||currentTileTypeInternal==='derelict'||currentTileTypeInternal==='anomaly'|| currentTileTypeInternal==='wormhole') && !currentSectorNPCs.find(npc => npc.x === playerX && npc.y === playerY) && Math.random()<PIRATE_ENCOUNTER_CHANCE)startCombat();else handleInteraction();
            }
            moveNPCs(); 
            renderGame();
        }
        function handleInteraction() { 
            const tileObject = gameMapGrid[playerY][playerX];
            const tileChar = getTileChar(tileObject);
            const l=getCombinedLocationData(playerY,playerX); 
            interactionTargetNPC = currentSectorNPCs.find(npc => npc.x === playerX && npc.y === playerY);

            let bM=`${currentSectorName} (${currentSectorX},${currentSectorY}) [${playerX},${playerY}]. Fuel:${playerFuel.toFixed(1)}/${MAX_FUEL.toFixed(1)}. Sh:${playerShields}/${MAX_SHIELDS}. Hull:${playerHull}/${MAX_PLAYER_HULL}.`; 
            if(l){
                bM=`Arrived at ${l.name}. Fuel:${playerFuel.toFixed(1)}/${MAX_FUEL.toFixed(1)}. Sh:${playerShields}/${MAX_SHIELDS}. Hull:${playerHull}/${MAX_PLAYER_HULL}.`;
                let actionsAvailable = "";
                if((l.sells&&l.sells.length>0)||(l.buys&&l.buys.length>0)) actionsAvailable += "Trade (B/S). ";
                if (l.isMajorHub) {
                    actionsAvailable += "Outfit (O). "; 
                    actionsAvailable += "Missions (K). ";
                }
                actionsAvailable += "Leave (L).";
                
                if (playerActiveMission && !playerActiveMission.isComplete) {
                    playerActiveMission.objectives.forEach((obj, index) => {
                        const progressKey = `${obj.type.toLowerCase()}_${index}`;
                        const objectiveProgress = playerActiveMission.progress[progressKey];
                        if (obj.type === "DELIVERY" && objectiveProgress && !objectiveProgress.complete &&
                            l.name === obj.destinationName && `${currentSectorX},${currentSectorY}` === obj.destinationSectorKey) {
                            actionsAvailable += ` Complete Delivery for '${playerActiveMission.title}' (C).`;
                        }
                    });
                }
                if (playerActiveMission && playerActiveMission.isComplete && l.name === playerActiveMission.giver) {
                     actionsAvailable += ` <span style='color:#00FF00;'>Claim Reward for '${playerActiveMission.title}' (G).</span>`;
                }

                bM += "\nActions: " + actionsAvailable;

                if(l.type===STARBASE_CHAR_VAL||l.type===OUTPOST_CHAR_VAL){ 
                    playerFuel=MAX_FUEL;playerShields=MAX_SHIELDS; playerHull = MAX_PLAYER_HULL; 
                    bM+=`\nFuel, Shields, and Hull fully repaired!`;
                    applyPlayerShipStats(); 
                }
                if(l.rumor) bM+= `\n<span style='color:#AAAAFF;'>Local Chatter: "${l.rumor}"</span>`;
                if(!discoveredLocations.has(l.name)){
                    discoveredLocations.add(l.name);
                    playerXP+=XP_PER_LOCATION_DISCOVERY;
                    bM+=`\n<span style='color:#00FF00;'>Location Discovered: ${l.name}! +${XP_PER_LOCATION_DISCOVERY} XP!</span>`;
                    unlockLoreEntry(`LOCATION_${l.name.replace(/\s+/g, '_').toUpperCase()}`); 
                    checkLevelUp();
                }
            } else if (interactionTargetNPC) {
                 bM = `You are at the same coordinates as a ${interactionTargetNPC.faction} Trader (${interactionTargetNPC.char}).`;
                 bM += "\nActions: Hail (Y). Attack (F).";
            } else {
                switch(tileChar){ 
                    case STAR_CHAR_VAL:bM+=` Near star. (H to Scoop Fuel)`; unlockLoreEntry("PHENOMENON_STAR"); break; 
                    case ASTEROID_CHAR_VAL:bM+=` Asteroids. (M to Mine)`; unlockLoreEntry("PHENOMENON_ASTEROID"); break;
                    case NEBULA_CHAR_VAL:bM+=` Nebula.`; unlockLoreEntry("PHENOMENON_NEBULA"); break;
                    case DERELICT_CHAR_VAL:bM+=` Near a derelict ship.`; unlockLoreEntry("XENO_DERELICTS"); break;
                    case ANOMALY_CHAR_VAL:bM+=` Near a strange anomaly.`; unlockLoreEntry("XENO_ANOMALIES"); break;
                    case WORMHOLE_CHAR_VAL:bM+=` Unstable Wormhole detected! (T to Traverse)`; unlockLoreEntry("PHENOMENON_WORMHOLE"); break;
                }
            }
            updateMessage(bM); 
        }
        
        function scanLocation() { 
            if (currentTradeContext || currentCombatContext || currentOutfitContext || currentMissionContext || currentVictoryContext || currentNPCTradeContext) { updateMessage("Cannot scan now."); renderGame(); return; }
            const location = getCombinedLocationData(playerY, playerX); 
            let scanMessage = `Scan Report - ${currentSectorName} (${currentSectorX},${currentSectorY}) [${playerX},${playerY}]:\nPlayer Shields: ${playerShields}/${MAX_SHIELDS}. Hull: ${playerHull}/${MAX_PLAYER_HULL}.\n`; 
            const tileObject = gameMapGrid[playerY][playerX];
            const tileChar = getTileChar(tileObject);
            let objectTypeForXP = getTileType(tileObject) || tileChar; 
            let isMysteryClue = false;
            let actionsAvailable = "";

            if (location) { 
                scanMessage+=`Location: ${location.name} (${location.type}).\n`;
                scanMessage+=location.scanFlavor||"Standard readings for this type of installation/outpost.";
                if(location.rumor)scanMessage+=`\n<span style='color:#AAAAFF;'>Intercepted Local Comm: "${location.rumor}"</span>`;
                if((location.sells&&location.sells.length>0)||(location.buys&&location.buys.length>0)){
                    scanMessage+="\n<span style='color:#66FF66;'>Trade Analysis:</span>";
                    if(location.sells.length>0)scanMessage+=`\n  Exports: ${location.sells.map(item=>COMMODITIES[item.id].name).join(', ')}.`;
                    if(location.buys.length>0)scanMessage+=`\n  Imports: ${location.buys.map(item=>COMMODITIES[item.id].name).join(', ')}.`;
                } else {
                    scanMessage+="\nNo active trade facilities detected.";
                }
                objectTypeForXP=location.type; 
                 if (location.type === STARBASE_CHAR_VAL || location.type === OUTPOST_CHAR_VAL) {
                    if ((location.sells && location.sells.length > 0) || (location.buys && location.buys.length > 0)) actionsAvailable += "Trade (B/S). ";
                    if (location.isMajorHub) {
                        actionsAvailable += "Outfit (O). "; 
                        actionsAvailable += "Missions (K). ";
                    }
                    actionsAvailable += "Leave (L).";
                }
            } else { 
                const npcAtLocation = currentSectorNPCs.find(npc => npc.x === playerX && npc.y === playerY);
                if (npcAtLocation) {
                    scanMessage += `Detected: ${npcAtLocation.faction} Trader vessel. Standard freighter configuration. Mild energy signature from cargo hold.`;
                    objectTypeForXP = 'npc_trader';
                    actionsAvailable += "Hail (Y). Attack (F).";
                } else {
                    switch (tileChar) { 
                        case EMPTY_SPACE_CHAR_VAL: 
                            const eF=["Vast emptiness. Faint cosmic background radiation. The universe feels ancient here.","Cold and silent void. Distant quasar flicker, a beacon from billions of years past.","Deep space. Unknown navigational beacons at extreme range, their origin a mystery.","Faint gravimetric distortions. Ancient... or nothing. Perhaps a Precursor hyperlane, long collapsed.","Star-dusted canvas. Quiet contemplation, or ambush. The patterns of the stars seem to shift slightly.","The silence here is profound, almost deafening. A lone comet streaks by in the far distance, its tail a whisper of ice and dust.","Echoes of ancient warp signatures, long faded. This area feels... watched. As if by unseen eyes.","A faint trail of exotic particles suggests something passed through here recently. Something big, and not of Concord design.","Sensors detect a faint, repeating energy pulse. Too weak to pinpoint, but it's out there... somewhere. It calls to something deep within your ship's core.","The void stretches on, indifferent. A perfect place to lose oneself, or be lost."];
                            scanMessage+=eF[Math.floor(Math.random()*eF.length)];
                            objectTypeForXP='empty_space';
                            break;
                        case STAR_CHAR_VAL: 
                            const starFlavor = ["Brilliant G-type star...","Red dwarf...","Blue giant...","Binary star system...","Young protostar...","Neutron star remnant...","White dwarf...","Pulsar...","Star with stellar engineering...","Variable star...","Wolf-Rayet star...","Rogue star..."];
                            let starDesc = starFlavor[Math.floor(Math.random() * starFlavor.length)];
                            if (tileObject && tileObject.type === 'star' && tileObject.starType === 'Binary' && mystery_wayfinder_progress < 2 && (Math.abs(currentSectorX) + Math.abs(currentSectorY) >= MYSTERY_WAYFINDER_TARGET_SECTOR_VOLATILITY)) {
                                starDesc += "\n<span style='color:#FFD700;'>A faint, repeating energy signature emanates from this binary system... it seems artificial. It pulses with a resonance matching unstable warp energies.</span>";
                                mystery_wayfinder_progress = 2; isMysteryClue = true;
                            }
                            scanMessage += starDesc;
                            if (tileObject && tileObject.type === 'star') {
                                 if (tileObject.richness > 0.75) scanMessage += "\n<span style='color:#FFFF99;'>High hydrogen concentrations detected! Ideal for scooping.</span>";
                                 else if (tileObject.richness > 0.4) scanMessage += "\n<span style='color:#FFFFE0;'>Moderate hydrogen concentrations. Scooping viable.</span>";
                                 else scanMessage += "\n<span style='color:#FFFACD;'>Low hydrogen concentrations. Scooping may be inefficient.</span>";
                                 if (tileObject.scoopedThisVisit) {
                                    scanMessage += "\n<span style='color:#999999;'>Corona appears depleted from recent scooping this visit.</span>";
                                 }
                            }
                            actionsAvailable += "Scoop Fuel (H).";
                            break;
                        case ASTEROID_CHAR_VAL: 
                            let asteroidMsg = "Asteroid field detected. ";
                            if (tileObject && tileObject.asteroidType) {
                                asteroidMsg += `Type: ${tileObject.asteroidType}. `;
                                if (tileObject.resources && tileObject.resources.length > 0) {
                                    const primaryResource = COMMODITIES[tileObject.resources[0].id].name;
                                    asteroidMsg += `Primary resource signature: ${primaryResource}. `;
                                    if (tileObject.resources.length > 1 && (COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus || 0) > 0.01) { 
                                         asteroidMsg += `Faint traces of other materials.`;
                                    }
                                } else {
                                    asteroidMsg += "Appears mostly barren.";
                                }
                            } else {
                                asteroidMsg += "Composition unknown.";
                            }
                            if (tileObject && tileObject.minedThisVisit) {
                                scanMessage += "\n<span style='color:#999999;'>This field appears recently mined.</span>";
                            }
                            scanMessage += asteroidMsg;
                            actionsAvailable += "Mine Asteroid (M).";
                            break;
                        case NEBULA_CHAR_VAL: 
                            const nF=["Vibrant emission nebula...","Dark nebula...","Planetary nebula...","Reflection nebula...","Calm gaseous expanse...","Stellar nursery...","Bok globule...","Void Crystal concentration...","Forbidden nebula...","Singing nebula?...","Sentient Mycelium filaments..."];
                            scanMessage+=nF[Math.floor(Math.random()*nF.length)];
                            break;
                        case DERELICT_CHAR_VAL: 
                            let dM="Scanners detect a derelict ship. ";
                            if(tileObject&&tileObject.type==='derelict'&&tileObject.subtype){
                                dM+=`Appears to be a ${tileObject.subtype}. `;
                                objectTypeForXP=`derelict_${tileObject.subtype.replace(/\s+/g,'_').toLowerCase()}`;
                                if(mystery_wayfinder_progress===3&&tileObject.subtype===MYSTERY_WAYFINDER_DERELICT_HINT_TYPE&&currentSectorX>=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MIN&&currentSectorX<=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MAX&&currentSectorY>=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MIN&&currentSectorY<=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MAX){
                                    const fSX=Math.floor(Math.random()*10)+10*(Math.random()<0.5?1:-1);const fSY=Math.floor(Math.random()*10)+10*(Math.random()<0.5?1:-1);const fX=Math.floor(Math.random()*MAP_WIDTH);const fY=Math.floor(Math.random()*MAP_HEIGHT);
                                    mystery_wayfinder_finalLocation={sectorX:fSX,sectorY:fSY,x:fX,y:fY};
                                    dM+=`\n<span style='color:#FFD700;'>The ship's damaged logs contain a startling discovery! A Precursor Wayfinder signal has been pinpointed to Sector (${fSX},${fSY}), coordinates [${fX},${fY}].</span>`;
                                    mystery_wayfinder_progress=4;isMysteryClue=true;
                                } else {
                                    switch(tileObject.subtype){
                                        case 'freighter': dM += "Hull breaches... K'tharr Spices scent."; break; 
                                        case 'explorer': dM += "Shattered sensors... Silentium Expanse charts."; break; 
                                        default: dM += "Origin unknown."; break;
                                    }
                                }
                            } else {
                                dM+="Its origin and purpose are unknown.";
                            }
                            if(Math.random() < (0.20 + (COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus || 0)) && !isMysteryClue){/* loot logic */}
                            scanMessage+=dM;
                            break;
                        case ANOMALY_CHAR_VAL: 
                            let anoM="Unusual energy readings detected. This is an anomaly. ";
                            if(tileObject&&tileObject.type==='anomaly'&&tileObject.subtype){
                                anoM+=`Identified as a ${tileObject.subtype}. `;
                                objectTypeForXP=`anomaly_${tileObject.subtype.replace(/\s+/g,'_').toLowerCase()}`;
                                if(mystery_wayfinder_progress===2&&tileObject.subtype===MYSTERY_WAYFINDER_ANOMALY_HINT_TYPE){
                                    anoM+=`\n<span style='color:#FFD700;'>The anomaly resonates with the Precursor signal! A fragmented data packet is recovered: 'Seek the lost explorer... Concord designation 'Pathfinder' (${MYSTERY_WAYFINDER_DERELICT_HINT_TYPE})... last seen in the negative X, positive Y quadrant sectors... carrying vital charts.'</span>`;
                                    mystery_wayfinder_progress=3;isMysteryClue=true;
                                } else {
                                    switch(tileObject.subtype){
                                         case 'gravimetric wave': anoM += "Space ripples... temporal displacement."; break; 
                                         case 'temporal distortion': anoM += "Chroniton interference... time flows erratically."; break; 
                                         default: anoM += "Nature beyond current sensors."; break;
                                    }
                                }
                            } else {
                                anoM+="Its nature is beyond current sensor capabilities. Approach with extreme caution.";
                            }
                            if(Math.random() < (0.05 + (COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus || 0)) &&!isMysteryClue){/* unique signature log */}
                            else if(Math.random()<(0.03+(COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus||0))&&playerCargo.VOID_CRYSTALS<PLAYER_CARGO_CAPACITY-currentCargoLoad&&!isMysteryClue){/* void crystal */}
                            else if(Math.random()<(0.01+(COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus||0))&&playerCargo.PRECURSOR_DATACUBE<PLAYER_CARGO_CAPACITY-currentCargoLoad&&!isMysteryClue){/* datacube */}
                            else if(Math.random()<(0.02+(COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus||0))&&playerCargo.PHASE_SHIFTED_ALLOY<PLAYER_CARGO_CAPACITY-currentCargoLoad&&!isMysteryClue){/* phase alloy */}
                            scanMessage+=anoM;
                            break;
                        case WORMHOLE_CHAR_VAL: 
                            let wMsg="Detected an unstable Wormhole! ";
                            if (tileObject && tileObject.type === 'wormhole' && typeof tileObject.stability === 'number') {
                                if (tileObject.stability > 0.7) wMsg += "Appears relatively stable...";
                                else if (tileObject.stability > 0.3) wMsg += "Fluctuating energy readings...";
                                else wMsg += "Highly unstable! Enter at extreme peril!";
                            }
                            scanMessage += wMsg;
                            actionsAvailable += "Traverse Wormhole (T).";
                            objectTypeForXP = 'wormhole';
                            break;
                        default: scanMessage += "Unknown anomaly detected. Sensor readings inconclusive."; break;
                    }
                }
            }


            if (actionsAvailable) {
                scanMessage += "\nAvailable Actions: " + actionsAvailable;
            }

            if (objectTypeForXP && !scannedObjectTypes.has(objectTypeForXP) && !isMysteryClue) { 
                scannedObjectTypes.add(objectTypeForXP);
                playerXP += XP_PER_FIRST_SCAN_TYPE;
                scanMessage += `\n<span style='color:#00FF00;'>New Discovery Type Scanned! +${XP_PER_FIRST_SCAN_TYPE} XP!</span>`;
                unlockLoreEntry(`PHENOMENON_${objectTypeForXP.toUpperCase()}`); 
                if (tileObject && tileObject.subtype) {
                    unlockLoreEntry(`${getTileType(tileObject).toUpperCase()}_${tileObject.subtype.replace(/\s+/g, '_').toUpperCase()}`); 
                }
                checkLevelUp();
            }
            
            if (playerActiveMission && playerActiveMission.type === "SURVEY" && !playerActiveMission.isComplete) {
                playerActiveMission.objectives.forEach((obj, index) => {
                    if (obj.type === "SCAN_OBJECT") {
                        const progressKey = `survey_${index}`;
                        const objectiveProgress = playerActiveMission.progress[progressKey];
                        if (objectiveProgress && !objectiveProgress.scanned && 
                            tileObject && getTileType(tileObject) === obj.targetType && tileObject.subtype === obj.subtype &&
                            (obj.sectorKey === "ANY" || obj.sectorKey === `${currentSectorX},${currentSectorY}`)) {
                            
                            objectiveProgress.scanned = true;
                            objectiveProgress.complete = true; 
                            scanMessage += `\n<span style='color:#00FF00;'>Mission Objective Update: ${obj.subtype} ${obj.targetType} scanned for "${playerActiveMission.title}".</span>`;
                        }
                    }
                });
                checkMissionObjectiveCompletion();
            }
            updateMessage(scanMessage);
            renderGame();
        }

        function scoopHydrogen() { 
            if(currentTradeContext||currentCombatContext||currentOutfitContext || currentMissionContext || currentVictoryContext || currentNPCTradeContext){updateMessage("Cannot scoop fuel now.");renderGame();return;}
            const cT=gameMapGrid[playerY][playerX];
            if(getTileType(cT)!=='star'){updateMessage("No star here to scoop from.");renderGame();return;}
            if(playerFuel>=MAX_FUEL){updateMessage("Fuel tanks full!");renderGame();return;}
            
            if (cT.scoopedThisVisit) {
                updateMessage("This star's corona has been depleted for this visit.");
                renderGame();
                return;
            }

            const sR=(typeof cT.richness==='number')?cT.richness:0.3;
            let fG=MIN_SCOOP_YIELD+Math.floor(sR*MAX_SCOOP_YIELD_RICHNESS_MULTIPLIER);
            fG+=Math.floor(Math.random()*SCOOP_RANDOM_BONUS);
            fG=Math.max(1,fG);
            const oF=playerFuel;
            playerFuel=Math.min(MAX_FUEL,playerFuel+fG);
            playerFuel = parseFloat(playerFuel.toFixed(1)); // Round fuel
            const aG=playerFuel-oF;

            if(aG>0) {
                updateMessage(`Scooped ${aG.toFixed(1)} units of hydrogen.\nFuel: ${playerFuel.toFixed(1)}/${MAX_FUEL.toFixed(1)}`);
                cT.scoopedThisVisit = true; 
            } else {
                 updateMessage("Scooping yielded no fuel. Tanks full or star already depleted this visit.");
            }
            renderGame();
        }

        function mineAsteroid() {
            if (currentTradeContext || currentCombatContext || currentOutfitContext || currentMissionContext || currentVictoryContext || currentNPCTradeContext) {
                updateMessage("Cannot mine now.");
                renderGame();
                return;
            }
            const asteroid = gameMapGrid[playerY][playerX];
            if (getTileType(asteroid) !== 'asteroid') {
                updateMessage("No asteroid field here to mine.");
                renderGame();
                return;
            }
            if (asteroid.minedThisVisit) {
                updateMessage("This asteroid field has been depleted for this visit.");
                renderGame();
                return;
            }

            let minedResourcesMessage = "Mining operation yields:\n";
            let totalMinedWeight = 0;
            let minedSomething = false;
            let gainedRareXP = false;

            if (asteroid.resources && asteroid.resources.length > 0) {
                asteroid.resources.forEach(resourceData => {
                    if (Math.random() < resourceData.chance) {
                        let yieldAmount = resourceData.minYield + Math.floor(Math.random() * (resourceData.maxYield - resourceData.minYield + 1));
                        yieldAmount = Math.floor(yieldAmount * (asteroid.density || 0.5)); 
                        yieldAmount = Math.max(0, yieldAmount); 

                        if (yieldAmount > 0) {
                            if (currentCargoLoad + yieldAmount <= PLAYER_CARGO_CAPACITY) {
                                playerCargo[resourceData.id] = (playerCargo[resourceData.id] || 0) + yieldAmount;
                                totalMinedWeight += yieldAmount;
                                minedResourcesMessage += ` ${yieldAmount} ${COMMODITIES[resourceData.id].name}\n`;
                                minedSomething = true;
                                unlockLoreEntry(`COMMODITY_${resourceData.id}`);
                                if (["GOLD", "PLATINUM_ORE", "HYDROGEN_3", "RARE_METALS"].includes(resourceData.id)) {
                                    gainedRareXP = true;
                                }
                            } else {
                                minedResourcesMessage += ` Not enough cargo space for ${COMMODITIES[resourceData.id].name}.\n`;
                            }
                        }
                    }
                });
            }

            if (minedSomething) {
                updateCurrentCargoLoad();
                playerXP += XP_PER_MINING_OP;
                if (gainedRareXP) playerXP += XP_BONUS_RARE_MINERAL;
                minedResourcesMessage += `\n+${XP_PER_MINING_OP + (gainedRareXP ? XP_BONUS_RARE_MINERAL : 0)} XP.`;
                checkLevelUp();
            } else {
                minedResourcesMessage = "Mining yielded nothing of value this attempt.";
            }
            
            asteroid.minedThisVisit = true;
            updateMessage(minedResourcesMessage);
            renderGame();
        }


        function calculatePrice(bP,pM){return Math.round(bP*pM);}
        function displayTradeScreen(mode){ 
            const l=getCombinedLocationData(playerY,playerX);
            if(!l||!((mode==='buy'&&l.sells&&l.sells.length>0)||(mode==='sell'&&l.buys&&l.buys.length>0))){updateMessage(`No items to ${mode} here.`);currentTradeContext=null;renderGame();return;}
            currentTradeContext={locationName:l.name,mode:mode,step:'selectItem',locationData:l};
            let tM=`--- ${mode.toUpperCase()} AT ${l.name.toUpperCase()} --- (Cr: ${playerCredits})\nCargo: ${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}\n`;
            const items=mode==='buy'?l.sells:l.buys;
            if(items.length===0)tM+=`Nothing available to ${mode}.\n`;
            else items.forEach((item,idx)=>{
                const com=COMMODITIES[item.id];
                unlockLoreEntry(`COMMODITY_${item.id}`); 
                const pr=calculatePrice(com.basePrice,item.priceMod);
                const st=mode==='buy'?`Stock: ${item.stock}`:`Demand: ${item.stock}`;
                const pH=mode==='sell'?`You have: ${playerCargo[item.id]||0}`:'';
                tM+=`${idx+1}. ${com.name} (${pr}c) [${st}] ${pH}\n`;
            });
            tM+="\nEnter # to select, or 'L' to leave.";updateMessage(tM);renderGame();
        }
        function handleTradeSelection(input){ 
            if(!currentTradeContext||currentTradeContext.step!=='selectItem')return;
            const lD = currentTradeContext.locationData; 
            const items=currentTradeContext.mode==='buy'?lD.sells:lD.buys;const sel=parseInt(input);
            if(isNaN(sel)||sel<1||sel>items.length){updateMessage("Invalid selection. # or 'L'.");renderGame();return;}
            currentTradeContext.itemIndex=sel-1;currentTradeContext.step='selectQuantity';
            const sIE=items[currentTradeContext.itemIndex];const com=COMMODITIES[sIE.id];const pr=calculatePrice(com.basePrice,sIE.priceMod);
            let pM=`How many ${com.name} to ${currentTradeContext.mode}? (Price: ${pr}c)\n`;
            if(currentTradeContext.mode==='buy'){pM+=`Max: ${sIE.stock}, Afford: ${Math.floor(playerCredits/pr)}, Space: ${PLAYER_CARGO_CAPACITY-currentCargoLoad}\n`;}
            else{pM+=`You have: ${playerCargo[sIE.id]||0}, Demand: ${sIE.stock}\n`;}
            pM+="Enter quantity (then Enter), or '0' to cancel item."; 
            currentQuantityInput = ""; 
            updateMessage(pM);renderGame();
        }
        function handleTradeQuantity(inputString){ 
            if(!currentTradeContext||currentTradeContext.step!=='selectQuantity')return;
            const qty=parseInt(inputString); 
            currentQuantityInput = ""; 

            if(isNaN(qty)||qty<0){updateMessage("Invalid qty. # or '0'.");displayTradeScreen(currentTradeContext.mode);renderGame();return;} 
            if(qty===0){displayTradeScreen(currentTradeContext.mode);return;}
            
            const lD = currentTradeContext.locationData; 
            const iL=currentTradeContext.mode==='buy'?lD.sells:lD.buys;const iE=iL[currentTradeContext.itemIndex];
            const cID=iE.id;const com=COMMODITIES[cID];const pr=calculatePrice(com.basePrice,iE.priceMod);let fM="";let xAGT=0;
            if(currentTradeContext.mode==='buy'){const tC=pr*qty;if(qty>iE.stock)fM="Not enough stock.";else if(tC>playerCredits)fM="Not enough credits.";else if(currentCargoLoad+qty>PLAYER_CARGO_CAPACITY)fM="No cargo space.";else{playerCredits-=tC;playerCargo[cID]=(playerCargo[cID]||0)+qty;iE.stock-=qty;updateCurrentCargoLoad();fM=`Bought ${qty} ${com.name} for ${tC}c.`;}}
            else{if(qty>(playerCargo[cID]||0))fM=`Not enough ${com.name} to sell.`;else if(qty>iE.stock)fM=`${lD.name} doesn't demand that many.`;else{const tG=pr*qty;playerCredits+=tG;playerCargo[cID]-=qty;iE.stock-=qty;updateCurrentCargoLoad();fM=`Sold ${qty} ${com.name} for ${tG}c.`;const pPU=pr-com.basePrice;if(pPU>0){xAGT=Math.floor(pPU*qty*XP_PER_PROFIT_UNIT);playerXP+=xAGT;updatePlayerNotoriety(Math.floor(tG / 100)); /* + Notoriety for profitable large sales */ fM+=`\n<span style='color:#00FF00;'>+${xAGT} XP for profitable trade!</span>`;checkLevelUp();}}}
            
            currentTradeContext = null; 
            updateMessage(fM, message.includes("LEVEL UP!")); 
            if(!message.includes("LEVEL UP!")) handleInteraction(); 
            renderGame();
        }
        function checkLevelUp() { /* Same as v0.6.8 */ if(playerXP>=xpToNextLevel){playerLevel++;playerXP-=xpToNextLevel;xpToNextLevel=calculateXpToNextLevel(playerLevel);updateMessage(`LEVEL UP! You are now Level ${playerLevel}!\nShields and Fuel fully restored!`,true);playerShields=MAX_SHIELDS;playerFuel=MAX_FUEL;}}
        
        function startCombat() { 
            const pirateMaxHull = PIRATE_BASE_HULL_MIN + Math.floor(Math.random() * (PIRATE_BASE_HULL_MAX - PIRATE_BASE_HULL_MIN + 1));
            const pirateMaxShields = PIRATE_BASE_SHIELDS_MIN + Math.floor(Math.random() * (PIRATE_BASE_SHIELDS_MAX - PIRATE_BASE_SHIELDS_MIN + 1));
            currentCombatContext = {
                pirateShields: pirateMaxShields, 
                pirateMaxShields: pirateMaxShields,
                pirateHull: pirateMaxHull,
                pirateMaxHull: pirateMaxHull
            };
            const tS=["Your cargo or your life, spacer!","Heh, fresh meat for the void!","This sector is ours! Pay the toll.","Look what the stardrive dragged in!","Prepare to be boarded, scum!","Another lamb to the slaughter!","Your ship looks like a fine prize!","Time to lighten your load, friend!","Don't make this harder than it has to be.","Another shiny target for my lasers!","Hope you've made your peace!","Your ship's paint job offends me! Prepare to die!","The Void Vultures are hungry!","Just hand over the valuables, and maybe you'll see tomorrow!","This is a shakedown! Don't try anything heroic."];
            const pT=tS[Math.floor(Math.random()*tS.length)];
            updateMessage(`"${pT}"\nHostile Pirate ${PIRATE_CHAR_VAL} encountered!\nPirate Sh: ${currentCombatContext.pirateShields}/${currentCombatContext.pirateMaxShields} | Hull: ${currentCombatContext.pirateHull}/${currentCombatContext.pirateMaxHull}\nYour Sh: ${playerShields}/${MAX_SHIELDS} | Hull: ${playerHull}/${MAX_PLAYER_HULL}\n(F)ight, (C)harge, (V)evade, (R)un?`);
            renderGame();
        } 

        function handleVictoryScreen() {
            if (!currentVictoryContext) return;

            playerXP += currentVictoryContext.xpReward;
            playerCredits += currentVictoryContext.creditReward;
            
            if (currentVictoryContext.salvage && currentVictoryContext.salvage.length > 0) {
                currentVictoryContext.salvage.forEach(item => {
                    playerCargo[item.itemID] = (playerCargo[item.itemID] || 0) + item.count;
                });
                updateCurrentCargoLoad();
            }

            checkLevelUp(); 
            
            if (playerActiveMission && playerActiveMission.type === "BOUNTY" && !playerActiveMission.isComplete) {
                 checkMissionObjectiveCompletion(); 
            }

            currentVictoryContext = null;
            handleInteraction(); 
            renderGame();
        }

        function handleCombatAction(action) { 
            if (!currentCombatContext) return; 
            let combatLog = "";
            let enemyAttacks = true; 

            if (action === 'fight') {
                const weaponStats = COMPONENTS_DATABASE[playerShip.weapon].stats;
                let damageDealt = weaponStats.damage;
                let currentHitChance = weaponStats.hitChance;

                if (playerIsChargingAttack) {
                    damageDealt = Math.floor(damageDealt * CHARGE_DAMAGE_MULTIPLIER);
                    currentHitChance += CHARGE_HIT_BONUS;
                    combatLog += "Charged shot unleashed! ";
                    playerIsChargingAttack = false; 
                }

                if (Math.random() < currentHitChance) {
                    let actualDamage = damageDealt;
                    if (weaponStats.vsShieldBonus && currentCombatContext.pirateShields > 0) {
                        actualDamage += weaponStats.vsShieldBonus;
                    }
                    
                    if (currentCombatContext.pirateShields > 0) {
                        currentCombatContext.pirateShields -= actualDamage;
                        combatLog += `Hit pirate shields for ${actualDamage}!`;
                        if (currentCombatContext.pirateShields < 0) {
                             combatLog += ` Shields down!`;
                             currentCombatContext.pirateShields = 0;
                        }
                    } else { 
                        actualDamage = Math.floor(actualDamage * HULL_DAMAGE_BONUS_MULTIPLIER);
                        currentCombatContext.pirateHull -= actualDamage;
                        combatLog += `Hit pirate hull for ${actualDamage}!`;
                    }
                } else { 
                    combatLog += "Your attack missed!"; 
                }
                
                combatLog += ` Pirate Sh: ${currentCombatContext.pirateShields}/${currentCombatContext.pirateMaxShields} | Hull: ${Math.max(0, currentCombatContext.pirateHull)}/${currentCombatContext.pirateMaxHull}.\n`;
                
                if (currentCombatContext.pirateHull <= 0) {
                    const creditsWon = PIRATE_CREDIT_REWARD_MIN + Math.floor(Math.random()*(PIRATE_CREDIT_REWARD_MAX-PIRATE_CREDIT_REWARD_MIN+1)); 
                    const xpGained = XP_PER_PIRATE_MIN + Math.floor(Math.random() * (XP_PER_PIRATE_MAX - XP_PER_PIRATE_MIN + 1)); 
                    
                    let victoryMessage = `<span style='color:#00FF00;'>*** VICTORY! ***</span>\nPirate defeated!\n`;
                    victoryMessage += `  + ${creditsWon} Credits\n`;
                    victoryMessage += `  + ${xpGained} XP\n`;

                    let salvagedItems = [];
                    const SALVAGE_CHANCE = 0.6; 
                    const SALVAGEABLE_COMMODITIES = ["MINERALS", "TECH_PARTS", "FOOD_SUPPLIES"];

                    if (Math.random() < SALVAGE_CHANCE) {
                        const numSalvageTypes = 1 + Math.floor(Math.random() * 2); 
                        for (let i = 0; i < numSalvageTypes; i++) {
                            const itemID = SALVAGEABLE_COMMODITIES[Math.floor(Math.random() * SALVAGEABLE_COMMODITIES.length)];
                            const count = 1 + Math.floor(Math.random() * 3); 
                            if (currentCargoLoad + count <= PLAYER_CARGO_CAPACITY) {
                                salvagedItems.push({ itemID: itemID, count: count, name: COMMODITIES[itemID].name });
                                victoryMessage += `  + Salvaged: ${count} ${COMMODITIES[itemID].name}\n`;
                            } else {
                                victoryMessage += `  - Found ${COMMODITIES[itemID].name}, but cargo hold is full!\n`;
                            }
                        }
                    }
                    if (salvagedItems.length === 0 && Math.random() < SALVAGE_CHANCE * 0.5) { 
                         victoryMessage += `  + Found a small stash of credits on the wreck!\n`;
                    }


                    victoryMessage += "\nPress Enter to Continue...";
                    
                    currentVictoryContext = {
                        message: victoryMessage,
                        xpReward: xpGained,
                        creditReward: creditsWon,
                        salvage: salvagedItems
                    };
                    
                    if (playerActiveMission && playerActiveMission.type === "BOUNTY" && !playerActiveMission.isComplete) {
                        playerActiveMission.objectives.forEach((obj, index) => {
                            if (obj.type === "ELIMINATE") {
                                const progressKey = `eliminate_${index}`;
                                const objectiveProgress = playerActiveMission.progress[progressKey];
                                if (objectiveProgress && !objectiveProgress.complete && 
                                    (obj.targetName === "Pirate") && 
                                    (obj.targetSectorKey === "ANY" || obj.targetSectorKey === `${currentSectorX},${currentSectorY}`)) {
                                    
                                    objectiveProgress.current++;
                                }
                            }
                        });
                    }
                    currentCombatContext=null; 
                    renderGame(); 
                    return; 
                }
            } else if (action === 'charge') {
                if (playerIsChargingAttack) {
                    combatLog += "Weapon systems already charging!\n";
                } else {
                    playerIsChargingAttack = true;
                    combatLog += "Charging weapon systems... (Attack next turn for bonus!)\n";
                }
            } else if (action === 'evade') {
                if (playerFuel < EVASION_FUEL_COST) {
                    combatLog += `Not enough fuel for evasive maneuvers! (Requires ${EVASION_FUEL_COST})\n`;
                } else {
                    playerFuel -= EVASION_FUEL_COST;
                    playerFuel = parseFloat(playerFuel.toFixed(1));
                    playerIsEvading = true;
                    combatLog += `Attempting evasive maneuvers... (Fuel: ${playerFuel.toFixed(1)})\n`;
                }
            } else if (action === 'run') {
                if(playerFuel<RUN_FUEL_COST){combatLog="Not enough fuel to run!\n";}
                else{
                    playerFuel-=RUN_FUEL_COST;
                    playerFuel = parseFloat(playerFuel.toFixed(1));
                    if(Math.random()<RUN_ESCAPE_CHANCE){
                        combatLog=`Escaped! Used ${RUN_FUEL_COST} fuel.`;
                        updatePlayerNotoriety(-1); 
                        currentCombatContext=null; playerIsChargingAttack = false; playerIsEvading = false; 
                        updateMessage(combatLog);handleInteraction();renderGame();return;
                    } else { combatLog=`Failed to escape! Pirate attacks!\n`; }
                }
            }

            if (currentCombatContext && enemyAttacks) {
                let pirateEffectiveHitChance = PIRATE_HIT_CHANCE;
                if (playerIsEvading) {
                    pirateEffectiveHitChance -= EVASION_DODGE_BONUS;
                    combatLog += "Your evasive maneuvers make you a harder target! ";
                }

                if (Math.random() < pirateEffectiveHitChance) { 
                    const pD = PIRATE_ATTACK_DAMAGE_MIN + Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1)); 
                    if (playerShields > 0) {
                        playerShields -= pD;
                        combatLog += `Pirate hits your shields for ${pD}!`;
                        if (playerShields < 0) {
                            playerHull += playerShields; 
                            playerShields = 0;
                            combatLog += ` Shields down! Hull takes ${-playerShields} spillover damage!`;
                        }
                    } else {
                        playerHull -= pD;
                        combatLog += `Pirate hits your hull for ${pD}!`;
                    }
                } else { 
                    combatLog+="Pirate attack missed!"; 
                }
                combatLog += ` Your Sh: ${playerShields}/${MAX_SHIELDS} | Hull: ${Math.max(0, playerHull)}/${MAX_PLAYER_HULL}.\n`;
                if (playerHull <= 0) { 
                    playerHull=0; combatLog+=`Ship critically damaged! Hull breach! Emergency warp to Starbase Alpha...`; 
                    let cLs=Math.floor(playerCredits*0.1);playerCredits=Math.max(0,playerCredits-cLs);combatLog+=`\nLost ${cLs}c.`; 
                    updatePlayerNotoriety(-10); 
                    playerShields=1; playerHull = 1; 
                    currentSectorX=0; currentSectorY=0; loadOrGenerateSectorMap(0,0); 
                    const sA=LOCATIONS_DATA["Starbase Alpha"].coords; playerX=sA.x;playerY=sA.y; 
                    currentCombatContext=null;playerIsChargingAttack = false; playerIsEvading = false; 
                    updateMessage(combatLog);handleInteraction();renderGame();return; 
                }
            }
            
            playerIsEvading = false; 
            
            if (currentCombatContext) { 
                 combatLog += `\nPirate Sh: ${currentCombatContext.pirateShields}/${currentCombatContext.pirateMaxShields} | Hull: ${Math.max(0, currentCombatContext.pirateHull)}/${currentCombatContext.pirateMaxHull}\n(F)ight, (C)harge, (V)evade, (R)un?`;
            }
            updateMessage(combatLog); 
            renderGame();
        }
        
        // --- Outfitting Functions ---
        function displayOutfittingScreen() {
            currentOutfitContext = { step: 'selectSlot' };
            let outfitMsg = "--- Ship Outfitting ---\n";
            outfitMsg += "Current Loadout:\n";
            outfitMsg += ` 1. Weapon: ${COMPONENTS_DATABASE[playerShip.weapon].name}\n`;
            outfitMsg += ` 2. Shield: ${COMPONENTS_DATABASE[playerShip.shield].name}\n`;
            outfitMsg += ` 3. Engine: ${COMPONENTS_DATABASE[playerShip.engine].name}\n`;
            outfitMsg += ` 4. Scanner: ${COMPONENTS_DATABASE[playerShip.scanner].name}\n\n`;
            outfitMsg += "Select slot # to upgrade, or (L) to Leave.";
            updateMessage(outfitMsg);
            renderGame();
        }

        function displayComponentsForSlot(slotType) {
            currentOutfitContext.step = 'selectComponent';
            currentOutfitContext.selectedSlot = slotType;
            let componentMsg = `--- Upgrading ${slotType.toUpperCase()} ---\nAvailable components (Cr: ${playerCredits}):\n`;
            let componentIndex = 1;
            currentOutfitContext.availableComponents = [];

            for (const compId in COMPONENTS_DATABASE) {
                const comp = COMPONENTS_DATABASE[compId];
                if (comp.slot === slotType && playerShip[slotType] !== compId) { 
                    componentMsg += `${componentIndex}. ${comp.name} (${comp.cost}c) - ${comp.description}\n`;
                    componentMsg += `   Stats: `;
                    let statsStr = [];
                    for(const stat in comp.stats) {
                        statsStr.push(`${stat}: ${comp.stats[stat]}`);
                    }
                    componentMsg += statsStr.join(', ') + "\n";
                    currentOutfitContext.availableComponents.push({id: compId, ...comp }); 
                    componentIndex++;
                }
            }
            if (currentOutfitContext.availableComponents.length === 0) {
                componentMsg += "No other upgrades currently available for this slot.\n";
            }
            componentMsg += "\nEnter # to purchase, or 'L' to go back.";
            updateMessage(componentMsg);
            renderGame();
        }

        function buyComponent(selectedComponentId) { 
            const component = COMPONENTS_DATABASE[selectedComponentId];
            if (!component) {
                updateMessage("Invalid component selection.");
                displayComponentsForSlot(currentOutfitContext.selectedSlot); 
                return;
            }

            if (playerCredits < component.cost) {
                updateMessage("Not enough credits to purchase " + component.name + ".", true);
                displayComponentsForSlot(currentOutfitContext.selectedSlot);
                return;
            }

            const oldComponent = COMPONENTS_DATABASE[playerShip[component.slot]];
            playerCredits -= component.cost;
            playerShip[component.slot] = selectedComponentId; 
            applyPlayerShipStats(); 
            unlockLoreEntry(component.loreKey);

            updateMessage(`Installed ${component.name}. Old ${oldComponent.name} unequipped.\nCredits: ${playerCredits}`); 
            currentOutfitContext = null; 
            handleInteraction(); 
            renderGame();
        }

        function displayCargoHold() {
            if (currentTradeContext || currentCombatContext || currentOutfitContext || currentMissionContext || currentVictoryContext || currentNPCTradeContext) {
                updateMessage("Cannot view cargo hold now.");
                renderGame();
                return;
            }
            let cargoMsg = "--- Cargo Hold ---\n";
            cargoMsg += `Capacity: ${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}\n`;
            let hasCargo = false;
            for (const commID in playerCargo) {
                if (playerCargo[commID] > 0) {
                    cargoMsg += ` ${COMMODITIES[commID].name}: ${playerCargo[commID]}\n`;
                    hasCargo = true;
                }
            }
            if (!hasCargo) {
                cargoMsg += "Hold is empty.\n";
            }
            cargoMsg += "\nPress any key to close cargo view.";
            updateMessage(cargoMsg);
            currentOutfitContext = { step: 'viewingCargo' }; 
            renderGame();
        }


        // --- Codex Functions ---
        let currentCodexCategory = null;
        function toggleCodex(show) { /* Same as v0.6.11 */ if(show){codexOverlayElement.style.display='flex';renderCodexCategories();renderCodexEntries(null);codexEntryTextElement.innerHTML="Select a category, then an entry.";}else{codexOverlayElement.style.display='none';currentCodexCategory=null;}}
        function renderCodexCategories() { /* Same as v0.6.11 */ codexCategoriesElement.innerHTML='';const cats=new Set();Object.values(LORE_DATABASE).forEach(e=>{if(discoveredLoreEntries.has(Object.keys(LORE_DATABASE).find(k=>LORE_DATABASE[k]===e)))cats.add(e.category);});Array.from(cats).sort().forEach(cat=>{const cD=document.createElement('div');cD.textContent=cat;cD.className='codex-list-item';if(cat===currentCodexCategory)cD.classList.add('active');cD.onclick=()=>{currentCodexCategory=cat;renderCodexCategories();renderCodexEntries(cat);codexEntryTextElement.innerHTML="Select an entry.";};codexCategoriesElement.appendChild(cD);});}
        function renderCodexEntries(category) { /* Same as v0.6.11 */ codexEntriesElement.innerHTML='';if(!category)return;Object.entries(LORE_DATABASE).forEach(([k,e])=>{if(e.category===category&&discoveredLoreEntries.has(k)){const eD=document.createElement('div');eD.textContent=e.title;eD.className='codex-list-item';eD.onclick=()=>{codexEntryTextElement.innerHTML=`<strong>${e.title}</strong><hr style="margin:5px 0;border-color:#4a4a6a;"><p>${e.text.replace(/\n/g,'<br>')}</p>`;document.querySelectorAll('#codexEntries .codex-list-item').forEach(el=>el.classList.remove('active'));eD.classList.add('active');};codexEntriesElement.appendChild(eD);}});}

        // --- Mission Functions ---
        function displayMissionBoard() {
            const currentLocation = getCombinedLocationData(playerY, playerX);
            if (!currentLocation || !currentLocation.isMajorHub) {
                updateMessage("Mission board not accessible here.");
                currentMissionContext = null; 
                renderGame();
                return;
            }

            missionsAvailableAtStation = []; 
            const stationName = currentLocation.name;
            const stationMissions = MISSIONS_DATABASE[stationName] || [];
            
            stationMissions.forEach(mission => {
                if (!playerCompletedMissions.has(mission.id) && (!playerActiveMission || playerActiveMission.id !== mission.id) ) { 
                    let meetsPrereqs = true;
                    if (mission.prerequisites) {
                        if (mission.prerequisites.level && playerLevel < mission.prerequisites.level) meetsPrereqs = false;
                        if (mission.prerequisites.completedMission && !playerCompletedMissions.has(mission.prerequisites.completedMission)) meetsPrereqs = false;
                    }
                    if (meetsPrereqs) {
                        missionsAvailableAtStation.push(mission);
                    }
                }
            });

            let missionMsg = `--- ${stationName} Mission Board ---\n`;
            if (playerActiveMission) {
                missionMsg += `Current Active Mission: ${playerActiveMission.title}\n(Complete or abandon current mission to accept a new one.)\n\n`;
            }
            
            if (missionsAvailableAtStation.length === 0) {
                missionMsg += "No new missions currently available.\n";
            } else {
                missionMsg += "Available Contracts:\n";
                missionsAvailableAtStation.forEach((mission, index) => {
                    missionMsg += `${index + 1}. ${mission.title} - Reward: ${mission.rewards.credits}c, ${mission.rewards.xp}XP\n`;
                });
            }
            missionMsg += "\nEnter # to view details, or (L) to leave.";
            
            currentMissionContext = { step: 'selectMission', availableMissions: missionsAvailableAtStation, stationName: stationName };
            updateMessage(missionMsg);
            renderGame();
        }

        function displayMissionDetails(selectedIndex) {
            if (!currentMissionContext || currentMissionContext.step !== 'selectMission' || !currentMissionContext.availableMissions) {
                handleInteraction(); 
                return;
            }
            const mission = currentMissionContext.availableMissions[selectedIndex];
            if (!mission) {
                updateMessage("Invalid mission selection.");
                displayMissionBoard(); 
                return;
            }

            let detailMsg = `--- Mission Briefing: ${mission.title} ---\n`;
            detailMsg += `From: ${mission.giver}\n\n`; 
            detailMsg += `Description:\n${mission.description}\n\n`;
            detailMsg += `Objectives:\n`;
            mission.objectives.forEach(obj => {
                if (obj.type === "ELIMINATE") detailMsg += ` - Eliminate ${obj.count} ${obj.targetName}(s) in sector ${obj.targetSectorKey === "ANY" ? "anywhere" : obj.targetSectorKey}.\n`;
                else if (obj.type === "DELIVER") detailMsg += ` - Deliver ${obj.count} ${COMMODITIES[obj.itemID].name} to ${obj.destinationName} (Sector ${obj.destinationSectorKey}).\n`;
                else if (obj.type === "SCAN_OBJECT") detailMsg += ` - Scan a ${obj.subtype} ${obj.targetType} in sector ${obj.sectorKey === "ANY" ? "anywhere" : obj.sectorKey}.\n`;
            });
            detailMsg += `\nRewards: ${mission.rewards.credits} Credits, ${mission.rewards.xp} XP, ${mission.rewards.notoriety} Notoriety.\n\n`;
            
            if (playerActiveMission) {
                detailMsg += "\n<span style='color:yellow;'>Note: You must complete or abandon your current mission before accepting this one.</span>\n";
                detailMsg += "\n(L) to go back to mission board.";
                currentMissionContext.step = 'viewOnlyDetails'; 
            } else {
                detailMsg += "Accept this mission? (Y/N) or (L) to go back.";
                currentMissionContext.step = 'confirmMission';
            }
            currentMissionContext.selectedMission = mission; 
            updateMessage(detailMsg);
            renderGame();
        }

        function acceptMission() {
            if (!currentMissionContext || currentMissionContext.step !== 'confirmMission' || !currentMissionContext.selectedMission) {
                displayMissionBoard(); 
                return;
            }
            if (playerActiveMission) { 
                updateMessage("You already have an active mission. Complete or abandon it first.");
                displayMissionBoard(); 
                return;
            }

            playerActiveMission = JSON.parse(JSON.stringify(currentMissionContext.selectedMission)); 
            playerActiveMission.isComplete = false; 
            playerActiveMission.progress = {};
            playerActiveMission.objectives.forEach((obj, index) => {
                const progressKeyBase = obj.type.toLowerCase();
                if (obj.type === "ELIMINATE") {
                    playerActiveMission.progress[`${progressKeyBase}_${index}`] = { current: 0, required: obj.count, targetName: obj.targetName, targetSectorKey: obj.targetSectorKey, complete: false };
                } else if (obj.type === "SURVEY") {
                    playerActiveMission.progress[`${progressKeyBase}_${index}`] = { scanned: false, targetType: obj.targetType, subtype: obj.subtype, sectorKey: obj.sectorKey, complete: false };
                } else if (obj.type === "DELIVERY") {
                    playerActiveMission.progress[`${progressKeyBase}_${index}`] = { delivered: 0, required: obj.count, itemID: obj.itemID, destinationName: obj.destinationName, destinationSectorKey: obj.destinationSectorKey, complete: false };
                }
            });

            updateMessage(`Mission Accepted: ${playerActiveMission.title}`);
            currentMissionContext = null;
            handleInteraction(); 
            renderGame();
        }
        
        function handleCompleteDelivery() {
            if (!playerActiveMission || playerActiveMission.type !== "DELIVERY" || playerActiveMission.isComplete) {
                updateMessage("No active delivery to complete here.");
                renderGame();
                return;
            }

            const currentLocation = getCombinedLocationData(playerY, playerX);
            if (!currentLocation) {
                updateMessage("Error: Not currently at a recognized location.");
                renderGame();
                return;
            }

            let deliveryMadeThisInteraction = false;
            
            playerActiveMission.objectives.forEach((obj, index) => {
                if (obj.type === "DELIVERY") {
                    const progressKey = `delivery_${index}`;
                    const objectiveProgress = playerActiveMission.progress[progressKey];

                    if (objectiveProgress && !objectiveProgress.complete &&
                        currentLocation.name === obj.destinationName &&
                        `${currentSectorX},${currentSectorY}` === obj.destinationSectorKey) {
                        
                        if (playerCargo[obj.itemID] >= obj.count) {
                            playerCargo[obj.itemID] -= obj.count;
                            updateCurrentCargoLoad();
                            objectiveProgress.delivered = obj.count; 
                            objectiveProgress.complete = true;
                            updateMessage(`Delivered ${obj.count} ${COMMODITIES[obj.itemID].name} to ${obj.destinationName}.`, true);
                            deliveryMadeThisInteraction = true;
                        } else {
                            updateMessage(`You don't have enough ${COMMODITIES[obj.itemID].name}. Required: ${obj.count}, You have: ${playerCargo[obj.itemID] || 0}.`, true);
                        }
                    }
                }
            });

            if (deliveryMadeThisInteraction) {
                checkMissionObjectiveCompletion(); 
            }
            handleInteraction(); 
            renderGame();
        }


        function checkMissionObjectiveCompletion() {
            if (!playerActiveMission || playerActiveMission.isComplete) return false;

            let allObjectivesNowComplete = true;
            for (let i = 0; i < playerActiveMission.objectives.length; i++) {
                const objective = playerActiveMission.objectives[i];
                const progressKey = `${objective.type.toLowerCase()}_${i}`;
                const objectiveProgress = playerActiveMission.progress[progressKey];

                if (!objectiveProgress || !objectiveProgress.complete) { 
                    allObjectivesNowComplete = false; 
                    break;
                }
            }

            if (allObjectivesNowComplete && !playerActiveMission.isComplete) { 
                playerActiveMission.isComplete = true;
                updateMessage(`All objectives for '${playerActiveMission.title}' complete!\nReturn to ${playerActiveMission.giver} to claim your reward.`, true);
            }
            return allObjectivesNowComplete;
        }
        
        function grantMissionRewards() {
            if (!playerActiveMission || !playerActiveMission.isComplete) return;
            const currentLocation = getCombinedLocationData(playerY, playerX);
            if (!currentLocation || currentLocation.name !== playerActiveMission.giver) {
                updateMessage("You must be at " + playerActiveMission.giver + " to claim this reward.");
                renderGame();
                return;
            }


            const mission = playerActiveMission; 
            playerCredits += mission.rewards.credits;
            playerXP += mission.rewards.xp;
            updatePlayerNotoriety(mission.rewards.notoriety);
            playerCompletedMissions.add(mission.id);
            
            let rewardMsg = `Mission '${mission.title}' Complete!\nRewards:\n  +${mission.rewards.credits} Credits\n  +${mission.rewards.xp} XP`;
            if (mission.rewards.notoriety !== 0) {
                rewardMsg += `\n  Notoriety ${mission.rewards.notoriety > 0 ? '+' : ''}${mission.rewards.notoriety}`;
            }
            
            playerActiveMission = null;
            currentMissionContext = null; 
            
            updateMessage(rewardMsg);
            checkLevelUp(); 
            handleInteraction(); 
            renderGame();
        }


        document.addEventListener('keydown', function(event) {
            const key = event.key.toLowerCase();
            
            if (currentVictoryContext) {
                if (key === 'enter') {
                    handleVictoryScreen();
                }
                event.preventDefault();
                return;
            }

            // --- Top-level context checks first ---
            if (codexOverlayElement.style.display === 'flex') { 
                if (key === 'escape' || key === 'j') { toggleCodex(false); }
                event.preventDefault(); return;
            }
            if (currentOutfitContext && currentOutfitContext.step === 'viewingCargo') { 
                currentOutfitContext = null; 
                handleInteraction(); 
                renderGame();
                event.preventDefault(); return;
            }
            if (currentMissionContext) {
                if (currentMissionContext.step === 'selectMission') {
                    const selection = parseInt(key);
                    if (!isNaN(selection) && selection > 0 && selection <= currentMissionContext.availableMissions.length) {
                        displayMissionDetails(selection - 1);
                    } else if (key === 'l') {
                        currentMissionContext = null; handleInteraction(); renderGame();
                    }
                } else if (currentMissionContext.step === 'confirmMission') {
                    if (key === 'y') {
                        if (!playerActiveMission) { acceptMission(); } 
                        else { updateMessage("Cannot accept: Another mission is already active."); displayMissionBoard(); }
                    } else if (key === 'n' || key === 'l') {
                        displayMissionBoard(); 
                    }
                } else if (currentMissionContext.step === 'viewOnlyDetails' || currentMissionContext.step === 'noMissions') {
                     if (key === 'l') { currentMissionContext = null; handleInteraction(); renderGame(); }
                }
                event.preventDefault(); return;
            }
            if (currentOutfitContext) { 
                if (currentOutfitContext.step === 'selectSlot') {
                    if (key === '1') displayComponentsForSlot('weapon');
                    else if (key === '2') displayComponentsForSlot('shield');
                    else if (key === '3') displayComponentsForSlot('engine');
                    else if (key === '4') displayComponentsForSlot('scanner');
                    else if (key === 'l') { currentOutfitContext = null; handleInteraction(); renderGame(); }
                } else if (currentOutfitContext.step === 'selectComponent') {
                    const selection = parseInt(key);
                    if (!isNaN(selection) && selection > 0 && selection <= currentOutfitContext.availableComponents.length) {
                        buyComponent(currentOutfitContext.availableComponents[selection - 1].id); 
                    } else if (key === 'l') {
                        displayOutfittingScreen(); 
                    }
                }
                event.preventDefault(); return;
            }
            if (currentTradeContext) { 
                if (currentTradeContext.step === 'selectQuantity') { 
                    if (!isNaN(parseInt(key)) && key.length === 1 && currentQuantityInput.length < 3) { 
                        currentQuantityInput += key; 
                        const lD = currentTradeContext.locationData; 
                        const itemsList = currentTradeContext.mode === 'buy' ? lD.sells : lD.buys; 
                        const itemEntry = itemsList[currentTradeContext.itemIndex]; 
                        const commodity = COMMODITIES[itemEntry.id]; 
                        const price = calculatePrice(commodity.basePrice, itemEntry.priceMod); 
                        let promptMsg = `How many ${commodity.name} to ${currentTradeContext.mode}? (Price: ${price}c)\n`; 
                        if (currentTradeContext.mode === 'buy') { promptMsg += `Max: ${itemEntry.stock}, Afford: ${Math.floor(playerCredits / price)}, Space: ${PLAYER_CARGO_CAPACITY - currentCargoLoad}\n`; } 
                        else {  promptMsg += `You have: ${playerCargo[itemEntry.id]||0}, Location demand: ${itemEntry.stock}\n`; } 
                        promptMsg += `Enter quantity (max 3 digits), then Enter. Current: ${currentQuantityInput} (Backspace to correct, 0 to cancel item)`; 
                        updateMessage(promptMsg); renderGame(); 
                    } else if (key === 'backspace' && currentQuantityInput.length > 0) { 
                        currentQuantityInput = currentQuantityInput.slice(0, -1); 
                        const lD = currentTradeContext.locationData; const itemsList = currentTradeContext.mode === 'buy' ? lD.sells : lD.buys; const itemEntry = itemsList[currentTradeContext.itemIndex]; const commodity = COMMODITIES[itemEntry.id]; const price = calculatePrice(commodity.basePrice, itemEntry.priceMod); let promptMsg = `How many ${commodity.name} to ${currentTradeContext.mode}? (Price: ${price}c)\n`; if (currentTradeContext.mode === 'buy') { promptMsg += `Max: ${itemEntry.stock}, Afford: ${Math.floor(playerCredits / price)}, Space: ${PLAYER_CARGO_CAPACITY - currentCargoLoad}\n`; } else {  promptMsg += `You have: ${playerCargo[itemEntry.id]||0}, Location demand: ${itemEntry.stock}\n`; } promptMsg += `Enter quantity (max 3 digits), then Enter. Current: ${currentQuantityInput} (Backspace to correct, 0 to cancel item)`; updateMessage(promptMsg); renderGame(); 
                    } else if (key === 'enter') { handleTradeQuantity(currentQuantityInput || "0"); 
                    } else if (key === 'l') { currentTradeContext = null; currentQuantityInput = ""; handleInteraction(); renderGame(); } 
                } else if (currentTradeContext.step === 'selectItem') { 
                    if (!isNaN(parseInt(key))) handleTradeSelection(key); 
                    else if (key === 'l') {currentTradeContext = null; currentQuantityInput = ""; handleInteraction(); renderGame();} 
                } 
                event.preventDefault();return;  
            }
            if (currentCombatContext) { 
                if (key === 'f') handleCombatAction('fight'); 
                else if (key === 'c') handleCombatAction('charge'); 
                else if (key === 'v') handleCombatAction('evade'); 
                else if (key === 'r') handleCombatAction('run'); 
                event.preventDefault(); return; 
            }
            
            // --- General Gameplay (Docked or In Space) ---
            const currentLocation = getCombinedLocationData(playerY, playerX);
            let actionTaken = false;
            let dx = 0, dy = 0;

            if (currentLocation) { // Player is docked
                switch (key) {
                    case 'b':
                        if ((currentLocation.sells && currentLocation.sells.length > 0) || (currentLocation.buys && currentLocation.buys.length > 0)) {
                            displayTradeScreen('buy'); actionTaken = true;
                        } else { updateMessage("Cannot trade here."); actionTaken = true; } 
                        break;
                    case 's': 
                        if ((currentLocation.sells && currentLocation.sells.length > 0) || (currentLocation.buys && currentLocation.buys.length > 0)) {
                            displayTradeScreen('sell'); actionTaken = true;
                        } else { updateMessage("Cannot trade here."); actionTaken = true; } 
                        break;
                    case 'o': 
                        if (currentLocation.isMajorHub) { displayOutfittingScreen(); actionTaken = true; } 
                        else { updateMessage("Ship outfitting not available here."); actionTaken = true; }
                        break;
                    case 'k':
                        if (currentLocation.isMajorHub) { displayMissionBoard(); actionTaken = true; } 
                        else { updateMessage("No mission board available at this remote outpost."); actionTaken = true; }
                        break;
                    case 'c': // Complete Delivery
                        if (playerActiveMission && playerActiveMission.type === "DELIVERY" && !playerActiveMission.isComplete) {
                            handleCompleteDelivery(); actionTaken = true;
                        }
                        break;
                    case 'g': // Grant mission rewards / Turn in
                        if (playerActiveMission && playerActiveMission.isComplete && currentLocation.name === playerActiveMission.giver) {
                            grantMissionRewards(); actionTaken = true;
                        }
                        break;
                    case 'l': 
                        if (currentMissionContext || currentOutfitContext || currentTradeContext) {
                            currentMissionContext = null; currentOutfitContext = null; currentTradeContext = null; currentQuantityInput = "";
                        }
                        handleInteraction(); actionTaken = true; 
                        break;
                }
            }

            if (actionTaken) {
                renderGame();
                event.preventDefault();
                return;
            }

            // If no docked action was taken, or not docked, process movement and other global keys
            switch(key){
                case 'w':case 'arrowup':dy=-1;break; 
                case 's':case 'arrowdown':dy=1;break; 
                case 'a':case 'arrowleft':dx=-1;break; 
                case 'd':case 'arrowright':dx=1;break;
                case 'e':scanLocation();break; 
                case 'h': scoopHydrogen(); break; 
                case 'm': mineAsteroid(); break; 
                case 'j': toggleCodex(true); break; 
                case 'i': displayCargoHold(); break; 
                case 't': 
                    const cT=gameMapGrid[playerY][playerX];
                    if(getTileType(cT)==='wormhole')traverseWormhole();
                    else updateMessage("No wormhole here.");
                    break;
                default:return; 
            }

            if(dx!==0||dy!==0)movePlayer(dx,dy); else renderGame(); 
            event.preventDefault();
        });
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
