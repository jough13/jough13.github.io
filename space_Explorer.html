<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII Space Explorer - v0.6.7 (Further Lore & Diversity)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #gameContainer {
            background-color: #0f0f1a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameMap {
            white-space: pre;
            font-size: 18px; 
            line-height: 1.1; 
            border: 1px solid #4a4a6a;
            padding: 10px;
            border-radius: 5px;
            background-color: #000;
            color: #B0B0B0; 
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameMap > div {
            text-align: center;
        }
        #playerStats {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            grid-template-rows: auto auto;
            gap: 10px 15px; 
            width: 100%;
            max-width: 500px; 
            padding: 10px;
            background-color: #2a2a4a;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .stat-item {
             display: flex;
             flex-direction: column;
             align-items: center;
        }
        .stat-item.sector-stat { 
            grid-column: 1 / -1; 
            padding-top: 5px;
            border-top: 1px solid #4a4a6a;
            margin-top: 5px;
        }
        .stat {
            color: #00ffff;
            font-weight: bold;
        }
        .stat-label {
            color: #aaa;
            font-size: 0.9em;
        }
        #messageArea {
            min-height: 120px; 
            color: #ffcc00;
            text-align: center;
            font-size: 16px;
            width: 100%;
            max-width: 680px; 
            padding: 10px;
            border: 1px dashed #4a4a6a;
            border-radius: 5px;
            background-color: #101020;
        }
        .game-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 20px;
        }
        .controls-info {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #aaa;
            text-align: center;
        }

        .player-char { color: #FFFFFF; } .star-char { color: #FFFF99; }
        .planet-char { color: #66CCFF; } .starbase-char { color: #FF66FF; } 
        .outpost-char { color: #99FF99; } 
        .asteroid-char { color: #FF9966; } .nebula-char { color: #CC99FF; }
        .empty-space-char { color: #B0B0B0; } .pirate-char { color: #FF4444; font-weight: bold; }
        .derelict-char { color: #77AADD; } 
        .anomaly-char { color: #FF00FF; font-weight: bold;} 
    </style>
</head>
<body>
    <h1 class="game-title">ASCII Space Explorer</h1>

    <div id="gameContainer">
        <div id="playerStats">
            <div class="stat-item">
                <span class="stat-label">Fuel</span>
                <span id="fuelStat" class="stat">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Shields</span>
                <span id="shieldsStat" class="stat">0/0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Credits</span>
                <span id="creditsStat" class="stat">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Cargo</span>
                <span id="cargoStat" class="stat">0/0</span>
            </div>
            <div class="stat-item sector-stat"> <span class="stat-label">Current Sector</span>
                <span id="sectorStat" class="stat">(0,0)</span>
            </div>
        </div>
        <div id="gameMap"></div>
        <div id="messageArea">Welcome, Explorer!</div>
    </div>

    <div class="controls-info">
        WASD: Move | E: Scan | H: Scoop Fuel (at Star) <br> 
        Docked - B: Buy | S: Sell | L: Leave <br>
        Combat - F: Fight | R: Run
    </div>

    <script>
        // --- Game Configuration ---
        const MAP_WIDTH = 40; 
        const MAP_HEIGHT = 20; 
        const PLAYER_CHAR_VAL = '@'; const EMPTY_SPACE_CHAR_VAL = '.';
        const STAR_CHAR_VAL = '*'; const PLANET_CHAR_VAL = 'O';
        const STARBASE_CHAR_VAL = '#'; 
        const OUTPOST_CHAR_VAL = 'H';  
        const ASTEROID_CHAR_VAL = '%'; const NEBULA_CHAR_VAL = '~'; 
        const PIRATE_CHAR_VAL = 'X'; const DERELICT_CHAR_VAL = 'D'; 
        const ANOMALY_CHAR_VAL = '?'; 

        const INITIAL_FUEL = 100; const MAX_FUEL = 100;
        const INITIAL_CREDITS = 1000; const PLAYER_CARGO_CAPACITY = 50;
        const FUEL_PER_MOVE = 1; const INITIAL_SHIELDS = 50; const MAX_SHIELDS = 50;
        const PIRATE_ENCOUNTER_CHANCE = 0.0025; 
        const RUN_ESCAPE_CHANCE = 0.6; const RUN_FUEL_COST = 5;

        const PLAYER_ATTACK_DAMAGE = 10; const PLAYER_HIT_CHANCE = 0.75;
        const PIRATE_BASE_SHIELDS_MIN = 15; 
        const PIRATE_BASE_SHIELDS_MAX = 35; 
        const PIRATE_ATTACK_DAMAGE_MIN = 5;
        const PIRATE_ATTACK_DAMAGE_MAX = 12; 
        const PIRATE_HIT_CHANCE = 0.6;
        const PIRATE_CREDIT_REWARD_MIN = 20; const PIRATE_CREDIT_REWARD_MAX = 60; 

        const MIN_SCOOP_YIELD = 3; 
        const MAX_SCOOP_YIELD_RICHNESS_MULTIPLIER = 12; 
        const SCOOP_RANDOM_BONUS = 3; 

        const OUTPOST_SPAWN_CHANCE = 0.08; 

        const COMMODITIES = {
            FUEL_CELLS: { name: "Fuel Cells", basePrice: 10, description: "Standard hyper-refined hydrogen fuel cells. The lifeblood of interstellar travel." },
            MINERALS: { name: "Minerals", basePrice: 25, description: "A mix of common industrial ores - iron, bauxite, silicates. Essential for construction." },
            FOOD_SUPPLIES: { name: "Food Supplies", basePrice: 15, description: "Nutrient paste, hydroponic vegetables, and recycled protein. Keeps the void-sickness at bay." },
            TECH_PARTS: { name: "Tech Parts", basePrice: 50, description: "Assorted advanced electronic components, often in high demand for repairs and illicit upgrades." },
            RARE_METALS: { name: "Rare Metals", basePrice: 75, description: "Precious and exotic metals like Platinum, Iridium, and Lanthanum. Used in high-tech manufacturing." },
            MEDICAL_SUPPLIES: { name: "Medical Supplies", basePrice: 60, description: "Field kits, combat stims, and anti-radiation drugs. A spacer's best friend after a rough encounter." },
            ARTIFACT_SHARDS: { name: "Artifact Shards", basePrice: 150, description: "Fragments of unknown, possibly alien, technology. Highly sought after by collectors and xeno-archaeologists." },
            XENO_ANTIQUES: { name: "Xeno-Antiques", basePrice: 200, description: "Intact relics from extinct alien civilizations. Extremely rare and valuable to the right buyer." },
            FORBIDDEN_TEXTS: { name: "Forbidden Texts", basePrice: 120, description: "Data slates containing controversial or dangerous information. Possession is often illegal." }
        };

        const LOCATIONS_DATA = { 
            "Starbase Alpha": { 
                coords: { y: MAP_HEIGHT - 5, x: MAP_WIDTH - 7 }, type: STARBASE_CHAR_VAL, 
                isMajorHub: true, 
                sells: [
                    { id: "FUEL_CELLS", priceMod: 0.9, stock: 100 }, { id: "TECH_PARTS", priceMod: 1.1, stock: 30 },
                    { id: "MEDICAL_SUPPLIES", priceMod: 1.0, stock: 25 }
                ],
                buys: [
                    { id: "MINERALS", priceMod: 1.2, stock: 50 }, { id: "FOOD_SUPPLIES", priceMod: 1.1, stock: 50 },
                    { id: "RARE_METALS", priceMod: 1.3, stock: 15 }, { id: "ARTIFACT_SHARDS", priceMod: 1.5, stock: 5 },
                    { id: "XENO_ANTIQUES", priceMod: 1.8, stock: 2 } // Starbase Alpha is very interested in Xeno-Antiques
                ],
                scanFlavor: "Starbase Alpha: A major trade and logistics hub for the sector. Its beacons pulse with welcoming light. The Galactic Concord maintains a strong presence here, ensuring (relative) peace and facilitating interstellar commerce. Rumor has it, their archives hold secrets dating back to the First Expansion."
            },
            "Planet Omega": { 
                coords: { y: 7, x: 7 }, type: PLANET_CHAR_VAL,
                sells: [ { id: "MINERALS", priceMod: 0.8, stock: 200 }, { id: "FOOD_SUPPLIES", priceMod: 0.9, stock: 100 } ],
                buys: [ { id: "TECH_PARTS", priceMod: 1.3, stock: 10 }, { id: "RARE_METALS", priceMod: 1.1, stock: 20 } ],
                scanFlavor: "Planet Omega: Known for its rich Dilithium Crystal deposits and ancient, dormant structures believed to be of 'Precursor' origin. The silent cities hum with an almost imperceptible energy. Atmosphere: Thin but breathable. Surface temperature: Moderate."
            },
            "Planet Xerxes": { 
                coords: { y: 3, x: MAP_WIDTH - 5 }, type: PLANET_CHAR_VAL, sells: [], buys: [], 
                scanFlavor: "Planet Xerxes: High concentrations of Xenon Gas and exotic heavy metals. Atmosphere: Highly corrosive. Surface temperature: Extreme. Unsuitable for EVA. Rumored to be a former pirate hideout, its canyons are said to hide forgotten stashes and deadly traps."
            }
        };

        let currentSectorOutpostData = null; 

        const RUMORS = [
            "Captain 'Voidfang' still plagues the Kepler Nebula. They say her ship, the 'Nightreaver', is faster than any Concord patrol, and she's looking for a legendary Precursor map.",
            "That derelict capital ship in Gamma-7? Some say it's a 'Precursor' vessel, others claim it's a military ghost from the old Terran Wars, its AI still active and hostile.",
            "Young stars in the Orion Spur sectors often have asteroid belts rich in Iridium. Risky, but profitable. Watch for claim jumpers.",
            "The K'tharr Hegemony is tightening its borders near the Serpentis Cluster. Fuel prices might spike if their trade routes are disrupted. They don't take kindly to outsiders.",
            "The research team near the 'Whispering Anomaly' in Sector (-1, 4)? Vanished. Some say they found something they shouldn't have, something that... whispered back.",
            "Starbase Alpha is offering bounties for information on pirate activity in the outer rim sectors. Concord's reach is long, but not infinite.",
            "Artifact Shards are fetching high prices on the black market. Collectors are obsessed with 'Precursor' tech, believing it holds the key to FTL without Dilithium.",
            "Blue giants offer rich hydrogen, but their solar flares can fry your systems if you're not careful. Lost a good friend that way, chasing a 'perfect scoop'.",
            "Heard a distress call from a mining outpost in Sector (2,5). Something about 'crystal entities' awakening in the deep mines. Sounded like a tall tale.",
            "The 'Silentium Expanse' beyond Sector (10,10) is uncharted. Legends say it's where stars go to die, or where something else entirely sleeps, something ancient and vast.",
            "A trader mentioned a hidden Outpost in the 'Graveyard of Ships' sector that deals in Forbidden Texts. High risk, high reward.",
            "The 'Precursors' supposedly left 'Wayfinders' scattered across the galaxy. Finding one could lead to unimaginable discoveries... or doom.",
            "There's a faction known as the 'Children of the Void' who worship anomalies. They're said to be... unpredictable."
        ];

        // --- Game State ---
        let playerX, playerY, playerFuel, playerCredits, playerShields;
        let currentSectorX = 0; let currentSectorY = 0; 
        let playerCargo = {}; 
        let currentCargoLoad = 0;
        let gameMapGrid = []; 
        let message = "";
        let currentTradeContext = null;
        let currentCombatContext = null;

        // --- DOM Elements ---
        const gameMapElement = document.getElementById('gameMap');
        const messageAreaElement = document.getElementById('messageArea');
        const fuelStatElement = document.getElementById('fuelStat');
        const creditsStatElement = document.getElementById('creditsStat');
        const cargoStatElement = document.getElementById('cargoStat');
        const shieldsStatElement = document.getElementById('shieldsStat');
        const sectorStatElement = document.getElementById('sectorStat');

        function getTileChar(tile) { if (typeof tile === 'object' && tile !== null && tile.char) return tile.char; return tile; }
        function getTileType(tile) { if (typeof tile === 'object' && tile !== null && tile.type) return tile.type; return null; }

        function initializeGame() {
            playerFuel = INITIAL_FUEL; playerCredits = INITIAL_CREDITS; playerShields = INITIAL_SHIELDS;
            currentSectorX = 0; currentSectorY = 0; 
            playerCargo = {}; Object.keys(COMMODITIES).forEach(id => playerCargo[id] = 0);
            updateCurrentCargoLoad();
            generateSectorMap(currentSectorX, currentSectorY);
            playerX = Math.floor(MAP_WIDTH / 2); playerY = Math.floor(MAP_HEIGHT / 2);
            ensurePlayerStartNotOccupied(); 
            currentTradeContext = null; currentCombatContext = null;
            updateMessage(`Welcome to Sector (${currentSectorX},${currentSectorY})! Use WASD to move.`);
            renderGame();
        }

        function generateOutpostMarket() {
            const commodityKeys = Object.keys(COMMODITIES);
            let sellsItem = null; let buysItem = null;
            const sellable = commodityKeys.filter(id => !["RARE_METALS", "TECH_PARTS", "ARTIFACT_SHARDS", "XENO_ANTIQUES", "FORBIDDEN_TEXTS"].includes(id));
            if (sellable.length > 0) { const sID = sellable[Math.floor(Math.random() * sellable.length)]; sellsItem = { id: sID, priceMod: 1.0 + (Math.random() * 0.2 - 0.1), stock: 10 + Math.floor(Math.random() * 21) }; }
            const buyable = commodityKeys.filter(id => (!sellsItem || id !== sellsItem.id) && !["ARTIFACT_SHARDS", "XENO_ANTIQUES", "FORBIDDEN_TEXTS"].includes(id)); 
            if (buyable.length > 0) { const bID = buyable[Math.floor(Math.random()*buyable.length)]; buysItem = {id: bID, priceMod: 1.0 + (Math.random()*0.2 - 0.05), stock: 15 + Math.floor(Math.random()*26)};}
            return { sells: sellsItem ? [sellsItem] : [], buys: buysItem ? [buysItem] : [] };
        }

        function generateSectorMap(sX, sY) {
            gameMapGrid = []; currentSectorOutpostData = null; 
            for (let y = 0; y < MAP_HEIGHT; y++) { const r=[]; for(let x=0;x<MAP_WIDTH;x++)r.push(EMPTY_SPACE_CHAR_VAL); gameMapGrid.push(r); }
            if (sX === 0 && sY === 0) { for (const lN in LOCATIONS_DATA) { const l=LOCATIONS_DATA[lN]; if(l.coords&&l.type) gameMapGrid[l.coords.y][l.coords.x]=l.type; }} 
            else { if (Math.random() < OUTPOST_SPAWN_CHANCE) {
                    const rX = Math.floor(Math.random()*(MAP_WIDTH-4))+2; const rY = Math.floor(Math.random()*(MAP_HEIGHT-4))+2;
                    if (getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL) {
                        gameMapGrid[rY][rX] = OUTPOST_CHAR_VAL;
                        currentSectorOutpostData = { name: `Outpost Gamma-${Math.abs(sX)}${Math.abs(sY)}${rX%10}${rY%10}`, coords: {y:rY,x:rX}, type: OUTPOST_CHAR_VAL, isMajorHub: false, ...generateOutpostMarket(), scanFlavor: "A small, independent trading outpost. Offers basic services and a limited, often fluctuating, market. These outposts are lifelines in the deep void.", rumor: RUMORS[Math.floor(Math.random()*RUMORS.length)] };
                    }}}
            const numStars = 1 + Math.floor(Math.random() * 3); 
            for (let i=0;i<numStars;i++){ const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT); if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL) gameMapGrid[rY][rX] = { char: STAR_CHAR_VAL, type: 'star', richness: Math.random() }; }
            const numAsteroids = Math.floor(Math.random() * 3); 
            for (let i=0;i<numAsteroids;i++){ const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT); if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL) gameMapGrid[rY][rX] = { char: ASTEROID_CHAR_VAL, type: 'asteroid', density: Math.random() }; }
            if(Math.random() < 0.20){ const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT); if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL) gameMapGrid[rY][rX] = { char: NEBULA_CHAR_VAL, type: 'nebula', density: Math.random() }; }
            if(Math.random() < 0.15) { 
                const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);
                if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL) {
                    const derelictSubtypes = ['freighter', 'explorer', 'corvette', 'science vessel', 'luxury liner', 'mining barge', 'unknown wreckage', 'ancient probe', 'ghost ship', 'colony transport', 'prison hulk', 'sleeper ship', 'medical frigate', 'smuggler runabout', 'precursor sentinel'];
                    gameMapGrid[rY][rX] = { char: DERELICT_CHAR_VAL, type: 'derelict', subtype: derelictSubtypes[Math.floor(Math.random() * derelictSubtypes.length)] };
                }}
            if(Math.random() < 0.10) { 
                 const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);
                if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL) {
                    const anomalySubtypes = ['gravimetric wave', 'temporal distortion', 'subspace echo', 'exotic particle cloud', 'void fissure', 'rogue sensor ghost', 'energy surge', 'whispering void', 'chromatic shimmer', 'localized reality shear', 'sentient stardust cloud', 'echoes of creation'];
                    gameMapGrid[rY][rX] = { char: ANOMALY_CHAR_VAL, type: 'anomaly', subtype: anomalySubtypes[Math.floor(Math.random() * anomalySubtypes.length)] };
                }}
        }

        function ensurePlayerStartNotOccupied() { if (getTileChar(gameMapGrid[playerY][playerX]) !== EMPTY_SPACE_CHAR_VAL) { let fE = false; for(let i=-1;i<=1;i++){for(let j=-1;j<=1;j++){if(i===0&&j===0)continue;const cY=playerY+i,cX=playerX+j;if(cY>=0&&cY<MAP_HEIGHT&&cX>=0&&cX<MAP_WIDTH&&getTileChar(gameMapGrid[cY][cX])===EMPTY_SPACE_CHAR_VAL){playerX=cX;playerY=cY;fE=true;break;}}if(fE)break;} if(!fE){if(getTileChar(gameMapGrid[0][0])===EMPTY_SPACE_CHAR_VAL){playerX=0;playerY=0;}else{for(let r=0;r<MAP_HEIGHT;r++){for(let c=0;c<MAP_WIDTH;c++){if(getTileChar(gameMapGrid[r][c])===EMPTY_SPACE_CHAR_VAL){playerX=c;playerY=r;fE=true;break;}}if(fE)break;}}}}}
        function updateCurrentCargoLoad() { currentCargoLoad = 0; for (const cID in playerCargo) currentCargoLoad += playerCargo[cID]; }

        function renderGame() {
            gameMapElement.innerHTML = ''; 
            for (let y = 0; y < MAP_HEIGHT; y++) {
                const rD = document.createElement('div'); 
                for (let x = 0; x < MAP_WIDTH; x++) {
                    const cS = document.createElement('span'); 
                    let cTD_val = gameMapGrid[y][x]; 
                    let cTD_char = getTileChar(cTD_val); 
                    let cC = '';
                    if (currentCombatContext && x === playerX && y === playerY) { cTD_char = PIRATE_CHAR_VAL; cC = 'pirate-char';} 
                    else if (x === playerX && y === playerY) { cTD_char = PLAYER_CHAR_VAL; cC = 'player-char'; } 
                    else { 
                        switch(cTD_char) { 
                            case STAR_CHAR_VAL: cC = 'star-char'; break; case PLANET_CHAR_VAL: cC = 'planet-char'; break;
                            case STARBASE_CHAR_VAL: cC = 'starbase-char'; break; case OUTPOST_CHAR_VAL: cC = 'outpost-char'; break; 
                            case ASTEROID_CHAR_VAL: cC = 'asteroid-char'; break; case NEBULA_CHAR_VAL: cC = 'nebula-char'; break; 
                            case DERELICT_CHAR_VAL: cC = 'derelict-char'; break; case ANOMALY_CHAR_VAL: cC = 'anomaly-char'; break; 
                            case EMPTY_SPACE_CHAR_VAL: cC = 'empty-space-char'; break; default: cC = 'empty-space-char'; 
                        }
                    }
                    cS.textContent = cTD_char; if (cC) cS.className = cC; rD.appendChild(cS);
                } gameMapElement.appendChild(rD);
            }
            fuelStatElement.textContent = playerFuel;
            shieldsStatElement.textContent = `${playerShields}/${MAX_SHIELDS}`;
            creditsStatElement.textContent = playerCredits;
            cargoStatElement.textContent = `${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}`;
            sectorStatElement.textContent = `(${currentSectorX},${currentSectorY})`;
            messageAreaElement.innerHTML = message.replace(/\n/g, '<br>');
        }

        function updateMessage(newMessage) { message = newMessage; }
        function getCombinedLocationData(y,x) {
            if (currentSectorX === 0 && currentSectorY === 0) { for(const n in LOCATIONS_DATA) if(LOCATIONS_DATA[n].coords.y===y && LOCATIONS_DATA[n].coords.x===x) return {name:n, ...LOCATIONS_DATA[n]};}
            if (currentSectorOutpostData && currentSectorOutpostData.coords.y === y && currentSectorOutpostData.coords.x === x) return currentSectorOutpostData;
            return null;
        }

        function movePlayer(dx, dy) {
            if (currentTradeContext) { updateMessage("Press 'L' to leave trading first."); renderGame(); return; }
            if (currentCombatContext) { updateMessage("In combat! (F)ight or (R)un."); renderGame(); return; }
            if (playerFuel < FUEL_PER_MOVE && (dx !== 0 || dy !== 0)) { updateMessage("Out of fuel!"); renderGame(); return; }

            let nX = playerX + dx; let nY = playerY + dy; let sC = false;
            if (nX < 0) { currentSectorX--; nX = MAP_WIDTH - 1; sC = true; } 
            else if (nX >= MAP_WIDTH) { currentSectorX++; nX = 0; sC = true; }
            if (nY < 0) { currentSectorY--; nY = MAP_HEIGHT - 1; sC = true; } 
            else if (nY >= MAP_HEIGHT) { currentSectorY++; nY = 0; sC = true; }
            playerX = nX; playerY = nY;
            if (dx !==0 || dy !==0) { playerFuel -= FUEL_PER_MOVE; if(playerFuel < 0) playerFuel = 0; }
            
            const currentTileObject = gameMapGrid[playerY][playerX];
            const currentTileChar = getTileChar(currentTileObject);
            const currentTileType = getTileType(currentTileObject);

            if (sC) {
                generateSectorMap(currentSectorX, currentSectorY);
                ensurePlayerStartNotOccupied(); 
                updateMessage(`Warped to Sector (${currentSectorX},${currentSectorY}).`);
                const newSectorTileObject = gameMapGrid[playerY][playerX]; 
                const newSectorTileChar = getTileChar(newSectorTileObject);
                const newSectorTileType = getTileType(newSectorTileObject);
                if ((newSectorTileChar === EMPTY_SPACE_CHAR_VAL || newSectorTileType === 'asteroid' || newSectorTileType === 'derelict' || newSectorTileType === 'anomaly') && Math.random() < PIRATE_ENCOUNTER_CHANCE) { startCombat(); } 
                else { handleInteraction(); }
            } else { 
                if ((currentTileChar === EMPTY_SPACE_CHAR_VAL || currentTileType === 'asteroid' || currentTileType === 'derelict' || currentTileType === 'anomaly') && Math.random() < PIRATE_ENCOUNTER_CHANCE) { startCombat(); } 
                else { handleInteraction(); }
            }
            renderGame();
        }

        function handleInteraction() { 
            const tileObject = gameMapGrid[playerY][playerX];
            const tileChar = getTileChar(tileObject);
            const l=getCombinedLocationData(playerY,playerX); 
            let bM=`Sector (${currentSectorX},${currentSectorY}) [${playerX},${playerY}]. Fuel:${playerFuel}. Sh:${playerShields}.`;
            if(l){
                bM=`Arrived at ${l.name}. Fuel:${playerFuel}. Sh:${playerShields}.`;
                if((l.sells && l.sells.length>0)||(l.buys && l.buys.length>0))bM+="\nTrade (B/S). Leave (L).";
                if(l.type===STARBASE_CHAR_VAL || l.type===OUTPOST_CHAR_VAL){ 
                    playerFuel=MAX_FUEL;playerShields=MAX_SHIELDS;bM+="\nFuel replenished & Shields repaired!";
                }
                if(l.rumor) bM+= `\n<span style='color:#AAAAFF;'>Local Chatter: "${l.rumor}"</span>`;
            } else {
                switch(tileChar){ 
                    case STAR_CHAR_VAL:bM+=` Near star. (H to Scoop Fuel)`;break; 
                    case ASTEROID_CHAR_VAL:bM+=` Asteroids.`;break;
                    case NEBULA_CHAR_VAL:bM+=` Nebula.`;break;
                    case DERELICT_CHAR_VAL:bM+=` Near a derelict ship.`;break;
                    case ANOMALY_CHAR_VAL:bM+=` Near a strange anomaly.`;break;
                }
            }
            updateMessage(bM); 
        }
        
        function scanLocation() {
            if (currentTradeContext || currentCombatContext) { updateMessage("Cannot scan now."); renderGame(); return; }
            const location = getCombinedLocationData(playerY, playerX); 
            let scanMessage = `Scan Report - Sector (${currentSectorX},${currentSectorY}) [${playerX},${playerY}]:\nPlayer Shields: ${playerShields}/${MAX_SHIELDS}.\n`;
            const tileObject = gameMapGrid[playerY][playerX];
            const tileChar = getTileChar(tileObject);

            if (location) { 
                scanMessage += `Location: ${location.name} (${location.type}).\n`;
                scanMessage += location.scanFlavor || "Standard readings for this type of installation/outpost.";
                if(location.rumor) scanMessage += `\n<span style='color:#AAAAFF;'>Intercepted Local Comm: "${location.rumor}"</span>`;
                if ((location.sells && location.sells.length > 0) || (location.buys && location.buys.length > 0)) {
                    scanMessage += "\n<span style='color:#66FF66;'>Trade Analysis:</span>";
                    if (location.sells.length > 0) scanMessage += `\n  Exports: ${location.sells.map(item => COMMODITIES[item.id].name).join(', ')}.`;
                    if (location.buys.length > 0) scanMessage += `\n  Imports: ${location.buys.map(item => COMMODITIES[item.id].name).join(', ')}.`;
                } else { scanMessage += "\nNo active trade facilities detected."; }
            } else { 
                switch (tileChar) { 
                    case EMPTY_SPACE_CHAR_VAL:
                        const emptyFlavor = ["Vast emptiness. Faint cosmic background radiation.","Cold and silent void. Distant quasar flicker.","Deep space. Unknown navigational beacons at extreme range.","Faint gravimetric distortions. Ancient... or nothing.","Star-dusted canvas. Quiet contemplation, or ambush.","The silence here is profound, almost deafening. A lone comet streaks by in the far distance.","Echoes of ancient warp signatures, long faded. This area feels... watched."];
                        scanMessage += emptyFlavor[Math.floor(Math.random() * emptyFlavor.length)];
                        break;
                    case STAR_CHAR_VAL: 
                        const starFlavor = ["Brilliant G-type star. Moderate radiation. Potential for terrestrial planets.","Red dwarf. Low energy, hazardous flares. Unlikely to support complex life.","Blue giant. Intense radiation, powerful solar winds. Any nearby planets would be scoured.","Binary star system. Gravitational dance creates complex orbital mechanics.","Young protostar. Unstable energy readings. A system in its violent infancy.","Neutron star remnant. Extreme gravity well and radiation. Navigation hazardous.","White dwarf. A dying ember of a once mighty star. Faint energy signature.","Pulsar. Emitting regular beams of electromagnetic radiation. A cosmic lighthouse, or a warning."];
                        scanMessage += starFlavor[Math.floor(Math.random() * starFlavor.length)];
                        if (tileObject && tileObject.type === 'star' && typeof tileObject.richness === 'number') {
                             if (tileObject.richness > 0.75) scanMessage += "\n<span style='color:#FFFF99;'>High hydrogen concentrations detected! Ideal for scooping.</span>";
                             else if (tileObject.richness > 0.4) scanMessage += "\n<span style='color:#FFFFE0;'>Moderate hydrogen concentrations. Scooping viable.</span>";
                             else scanMessage += "\n<span style='color:#FFFACD;'>Low hydrogen concentrations. Scooping may be inefficient.</span>";
                        }
                        break;
                    case ASTEROID_CHAR_VAL:
                        const asteroidFlavor = ["Dense silicate/carbonaceous asteroids. Metallic signatures suggest valuable ores.","Sparse icy asteroid field. Unstable fragments. Some organic compounds detected.","Remnants of a shattered moon. Thick debris. Gravimetric anomalies present.","Rich veins of common ores. Some rare elements detected, likely requiring advanced extraction.","Patrolled asteroid belt. Unidentified energy signatures and faint transponder signals. Pirates likely.","Ancient, heavily cratered asteroids. Signs of past impacts and extreme space weathering.","A 'rogue' asteroid, likely ejected from another system. Unusual isotopic composition.","This field is unusually quiet. Too quiet."];
                        scanMessage += asteroidFlavor[Math.floor(Math.random() * asteroidFlavor.length)];
                        break;
                    case NEBULA_CHAR_VAL:
                        const nebulaFlavor = ["Vibrant emission nebula (ionized hydrogen). High sensor interference. Star formation active within.","Dark nebula, obscuring starlight. Difficult navigation. Strange energy readings from its core.","Planetary nebula (dead star's shroud). Exotic particles and complex molecules.","Reflection nebula, lit by young, hot stars. A stunning visual spectacle, but watch for radiation pockets.","Unusually calm gaseous expanse. Pockets of rare gases and proto-planetary disks.","Stellar nursery. New stars forming within the dense clouds. High levels of protostellar jets.","Bok globule. A dense, dark cloud of cosmic dust and gas, potentially a site of future star birth. Some say these hide pirate nests."];
                        scanMessage += nebulaFlavor[Math.floor(Math.random() * nebulaFlavor.length)];
                        break;
                    case DERELICT_CHAR_VAL: 
                        let derelictMsg = "Scanners detect a derelict ship. ";
                        if (tileObject && tileObject.type === 'derelict' && tileObject.subtype) {
                            derelictMsg += `Appears to be a ${tileObject.subtype}. `;
                            switch(tileObject.subtype) {
                                case 'freighter': derelictMsg += "Hull breaches are visible; life support offline. Cargo manifest is corrupted. Some containers may still be intact, but caution is advised."; break;
                                case 'explorer': derelictMsg += "Its long-range sensor array is shattered. Last log entry is centuries old, speaking of a 'great discovery' beyond known space. The coordinates are unrecoverable."; break;
                                case 'corvette': derelictMsg += "Weapon emplacements are powered down, scarred by energy fire. Signs of a fierce, one-sided battle. No survivors."; break;
                                case 'science vessel': derelictMsg += "Labs are trashed, containment fields failing. Research data cores are wiped, but some experimental tech might be unstable and salvageable. A faint, alien hum emanates from the drive core."; break;
                                case 'luxury liner': derelictMsg += "Eerily silent. Personal effects drift in zero-G. No signs of passengers or crew; a true ghost ship. The ship's chronometer is stuck on a date from the Dark Age of Technology."; break;
                                case 'mining barge': derelictMsg += "Automated systems failed mid-operation. Unrefined ore still in its hoppers, some exotic isotopes detected. The crew seems to have vanished mid-shift."; break;
                                case 'unknown wreckage': derelictMsg += "The design is unfamiliar, possibly alien. Heavy damage obscures its original form. Strange energy signature pulsing from within. Your ship's AI advises caution."; break;
                                case 'ancient probe': derelictMsg += "Non-humanoid design, incredibly old. Emitting a faint, repeating signal that resonates with your ship's computer, hinting at vast distances and a long-dead civilization."; break;
                                case 'ghost ship': derelictMsg += "Sensors detect faint energy signatures, but no life forms. The ship appears almost pristine, yet utterly abandoned. A chill runs down your spine. The name 'Event Horizon' is barely visible on the hull."; break;
                                case 'colony transport': derelictMsg += "Designed to carry thousands, now a silent tomb. Cryo-pods are shattered or offline. A tragedy of a bygone era. A single, undamaged pod shows a life sign... but it's not human."; break;
                                case 'prison hulk': derelictMsg += "Decommissioned long ago. Cell blocks are open, but the containment fields still hum with residual power. What horrors did it once hold? Some cells show signs of recent, desperate escape attempts."; break;
                                case 'sleeper ship': derelictMsg += "A relic of early interstellar travel. Its occupants are long dead or... something else. The stasis pods are failing, and one seems to have been forced open from the inside."; break;
                                case 'medical frigate': derelictMsg += "Its red cross emblem is faded. Autopsy bay shows signs of a struggle. Medical supplies are scattered, some vials broken, their contents unknown."; break;
                                case 'smuggler runabout': derelictMsg += "Fast and agile, but not fast enough. Hidden compartments are empty, likely looted. The transponder has been wiped clean."; break;
                                case 'precursor sentinel': derelictMsg += "Not a ship, but an automated drone of immense age and power. It appears dormant... for now. Its hull is made of an unidentifiable, self-repairing material."; break;
                            }
                        } else { derelictMsg += "Its origin and purpose are unknown."; }
                        if (Math.random() < 0.20) { // 20% chance of minor find
                            const lootTypeChance = Math.random();
                            if (lootTypeChance < 0.03 && playerCargo.ARTIFACT_SHARDS < PLAYER_CARGO_CAPACITY - currentCargoLoad && (tileObject.subtype === 'ancient probe' || tileObject.subtype === 'precursor sentinel' || tileObject.subtype === 'unknown wreckage')) { // 3% chance of artifact shard from specific derelicts
                                playerCargo.ARTIFACT_SHARDS = (playerCargo.ARTIFACT_SHARDS || 0) + 1;
                                updateCurrentCargoLoad();
                                derelictMsg += `\n<span style='color:#FF6347;'>Incredible! Recovered a rare ARTIFACT SHARD from the wreckage!</span>`;
                            } else if (lootTypeChance < 0.1 && playerCargo.TECH_PARTS < PLAYER_CARGO_CAPACITY - currentCargoLoad) { // 7% chance of tech parts (total 10% for commodity)
                                playerCargo.TECH_PARTS = (playerCargo.TECH_PARTS || 0) + 1;
                                updateCurrentCargoLoad();
                                derelictMsg += `\n<span style='color:#66FF66;'>Salvaged 1 unit of TECH PARTS!</span>`;
                            } else {
                                const lootCredits = Math.floor(Math.random() * 30) + 15; // 15-44 credits
                                playerCredits += lootCredits;
                                derelictMsg += `\n<span style='color:#66FF66;'>Found ${lootCredits}c in a stray data chip or unsecured locker!</span>`;
                            }
                        }
                        scanMessage += derelictMsg;
                        break;
                    case ANOMALY_CHAR_VAL: 
                        let anomalyMsg = "Unusual energy readings detected. This is an anomaly. ";
                        if (tileObject && tileObject.type === 'anomaly' && tileObject.subtype) {
                            anomalyMsg += `Identified as a ${tileObject.subtype}. `;
                            switch(tileObject.subtype) {
                                case 'gravimetric wave': anomalyMsg += "Space itself seems to ripple here. Your ship's inertial dampeners are working overtime. Nav-computer reports minor temporal displacement. Objects appear to momentarily duplicate."; break;
                                case 'temporal distortion': anomalyMsg += "Chroniton particle interference. Time flows erratically in this localized pocket. Your ship's clock is unreliable. You see fleeting glimpses of your own ship's past and future maneuvers."; break;
                                case 'subspace echo': anomalyMsg += "Faint signals from another dimension, or perhaps another time. Indecipherable, but they evoke a sense of profound loneliness and immense scale."; break;
                                case 'exotic particle cloud': anomalyMsg += "Composed of particles unknown to Federation science. Highly unstable and corrosive to standard hull materials. Your sensors are picking up strange, almost biological energy patterns within it."; break;
                                case 'void fissure': anomalyMsg += "A tear in the fabric of reality. Gazing into it feels... unwise. Your sensors detect nothing beyond, only an oppressive null-state that seems to absorb light and energy."; break;
                                case 'rogue sensor ghost': anomalyMsg += "Massive energy signature detected... then vanished. Probably a sensor malfunction due to local interference. Or was it? A faint heat signature lingers where it was."; break;
                                case 'energy surge': anomalyMsg += "A sudden burst of Cherenkov radiation. Your shields flare momentarily. Origin unknown, but it felt... directed, almost like a warning shot from an unseen entity."; break;
                                case 'whispering void': anomalyMsg += "Your comm system picks up faint, sibilant whispers. Unsettling, but untraceable. The voices seem to know your ship's designation..."; break;
                                case 'chromatic shimmer': anomalyMsg += "The space around you shimmers with impossible colors. Your optical sensors are struggling to process the input. It's beautiful and terrifying."; break;
                                case 'localized reality shear': anomalyMsg += "A section of space where physical laws appear to be in flux. Navigational hazards are extreme. Your ship groans under the strain."; break;
                                case 'sentient stardust cloud': anomalyMsg += "The dust particles here move with an unnatural synchronicity, forming complex patterns. It seems to be... observing you."; break;
                                case 'echoes of creation': anomalyMsg += "Faint, primordial energies, remnants from the birth of the universe. Your long-range sensors detect patterns that defy known physics."; break;
                            }
                        } else { anomalyMsg += "Its nature is beyond current sensor capabilities. Approach with extreme caution.";}
                         if (Math.random() < 0.05) { scanMessage += "\n<span style='color:#FF69B4;'>Your sensors record a unique energy signature. Data logged for future analysis. This could be significant. The Galactic Concord would pay well for this data.</span>"; }
                        scanMessage += anomalyMsg;
                        break;
                    default: scanMessage += "Unknown anomaly detected. Sensor readings inconclusive."; break;
                }
            }
            updateMessage(scanMessage); renderGame();
        }

        function scoopHydrogen() {
            if (currentTradeContext || currentCombatContext) { updateMessage("Cannot scoop fuel now."); renderGame(); return; }
            const currentTile = gameMapGrid[playerY][playerX];
            if (getTileType(currentTile) !== 'star') { updateMessage("No star here to scoop from."); renderGame(); return; }
            if (playerFuel >= MAX_FUEL) { updateMessage("Fuel tanks full!"); renderGame(); return; }
            const starRichness = (typeof currentTile.richness === 'number') ? currentTile.richness : 0.3; 
            let fuelGained = MIN_SCOOP_YIELD + Math.floor(starRichness * MAX_SCOOP_YIELD_RICHNESS_MULTIPLIER);
            fuelGained += Math.floor(Math.random() * SCOOP_RANDOM_BONUS);
            fuelGained = Math.max(1, fuelGained); 
            const oldFuel = playerFuel; playerFuel = Math.min(MAX_FUEL, playerFuel + fuelGained);
            const actualGained = playerFuel - oldFuel;
            if (actualGained > 0) updateMessage(`Scooped ${actualGained} units of hydrogen.\nFuel: ${playerFuel}/${MAX_FUEL}`);
            else updateMessage("Scooping yielded no fuel. Tanks full or star depleted.");
            renderGame();
        }
        
        function calculatePrice(bP,pM){return Math.round(bP*pM);}
        function displayTradeScreen(mode){
            const l = getCombinedLocationData(playerY, playerX); 
            if(!l || !((mode==='buy' && l.sells && l.sells.length>0) || (mode==='sell' && l.buys && l.buys.length>0))){
                updateMessage(`No items to ${mode} here.`); currentTradeContext=null; renderGame(); return;
            }
            currentTradeContext={locationName:l.name, mode:mode, step:'selectItem', locationData: l}; 
            let tM=`--- ${mode.toUpperCase()} AT ${l.name.toUpperCase()} --- (Cr: ${playerCredits})\nCargo: ${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}\n`;
            const items=mode==='buy'?l.sells:l.buys;
            if(items.length===0){tM+=`Nothing available to ${mode}.\n`;}
            else{items.forEach((item,idx)=>{const com=COMMODITIES[item.id];const pr=calculatePrice(com.basePrice,item.priceMod);const st=mode==='buy'?`Stock: ${item.stock}`:`Demand: ${item.stock}`;const pH=mode==='sell'?`You have: ${playerCargo[item.id]||0}`:'';tM+=`${idx+1}. ${com.name} (${pr}c) [${st}] ${pH}\n`;});}
            tM+="\nEnter # to select, or 'L' to leave.";updateMessage(tM);renderGame();
        }
        function handleTradeSelection(input){
            if(!currentTradeContext||currentTradeContext.step!=='selectItem')return;
            const lD = currentTradeContext.locationData; 
            const items=currentTradeContext.mode==='buy'?lD.sells:lD.buys;const sel=parseInt(input);
            if(isNaN(sel)||sel<1||sel>items.length){updateMessage("Invalid selection. # or 'L'.");renderGame();return;}
            currentTradeContext.itemIndex=sel-1;currentTradeContext.step='selectQuantity';
            const sIE=items[currentTradeContext.itemIndex];const com=COMMODITIES[sIE.id];const pr=calculatePrice(com.basePrice,sIE.priceMod);
            let pM=`How many ${com.name} to ${currentTradeContext.mode}? (Price: ${pr}c)\n`;
            if(currentTradeContext.mode==='buy'){pM+=`Max: ${sIE.stock}, Afford: ${Math.floor(playerCredits/pr)}, Space: ${PLAYER_CARGO_CAPACITY-currentCargoLoad}\n`;}
            else{pM+=`You have: ${playerCargo[sIE.id]||0}, Demand: ${sIE.stock}\n`;}
            pM+="Enter quantity, or '0' to cancel.";updateMessage(pM);renderGame();
        }
        function handleTradeQuantity(input){
            if(!currentTradeContext||currentTradeContext.step!=='selectQuantity')return;
            const qty=parseInt(input);
            if(isNaN(qty)||qty<0){updateMessage("Invalid qty. # or '0'.");renderGame();return;}
            if(qty===0){displayTradeScreen(currentTradeContext.mode);return;}
            const lD = currentTradeContext.locationData; 
            const iL=currentTradeContext.mode==='buy'?lD.sells:lD.buys;const iE=iL[currentTradeContext.itemIndex];
            const cID=iE.id;const com=COMMODITIES[cID];const pr=calculatePrice(com.basePrice,iE.priceMod);let fM="";
            if(currentTradeContext.mode==='buy'){const tC=pr*qty;if(qty>iE.stock)fM="Not enough stock.";else if(tC>playerCredits)fM="Not enough credits.";else if(currentCargoLoad+qty>PLAYER_CARGO_CAPACITY)fM="No cargo space.";else{playerCredits-=tC;playerCargo[cID]=(playerCargo[cID]||0)+qty;iE.stock-=qty;updateCurrentCargoLoad();fM=`Bought ${qty} ${com.name} for ${tC}c.`;}}
            else{if(qty>(playerCargo[cID]||0))fM=`Not enough ${com.name} to sell.`;else if(qty>iE.stock)fM=`${lD.name} doesn't demand that many.`;else{const tG=pr*qty;playerCredits+=tG;playerCargo[cID]-=qty;iE.stock-=qty;updateCurrentCargoLoad();fM=`Sold ${qty} ${com.name} for ${tG}c.`;}}
            updateMessage(fM);currentTradeContext=null;handleInteraction();renderGame();
        }

        function startCombat() { 
            const pirateShields = PIRATE_BASE_SHIELDS_MIN + Math.floor(Math.random() * (PIRATE_BASE_SHIELDS_MAX - PIRATE_BASE_SHIELDS_MIN + 1));
            currentCombatContext = { pirateShields: pirateShields, pirateMaxShields: pirateShields }; 
            const taunts = ["Your cargo or your life, spacer!", "Heh, fresh meat for the void!", "This sector is ours! Pay the toll.", "Look what the stardrive dragged in!", "Prepare to be boarded, scum!", "Another lamb to the slaughter!", "Your ship looks like a fine prize!"];
            const pirateTaunt = taunts[Math.floor(Math.random() * taunts.length)];
            updateMessage(`"${pirateTaunt}"\nHostile Pirate ${PIRATE_CHAR_VAL} encountered!\nPirate Shields: ${currentCombatContext.pirateShields}\nYour Shields: ${playerShields}\n(F)ight or (R)un?`); renderGame(); 
        }
        function handleCombatAction(action) {
            if (!currentCombatContext) return; let cL = "";
            if (action === 'fight') {
                if (Math.random() < PLAYER_HIT_CHANCE) { currentCombatContext.pirateShields -= PLAYER_ATTACK_DAMAGE; cL += `Hit pirate for ${PLAYER_ATTACK_DAMAGE}!`; } else { cL += "Your attack missed!"; }
                cL += ` Pirate Sh: ${Math.max(0, currentCombatContext.pirateShields)}.\n`;
                if (currentCombatContext.pirateShields <= 0) { const cW = PIRATE_CREDIT_REWARD_MIN + Math.floor(Math.random()*(PIRATE_CREDIT_REWARD_MAX-PIRATE_CREDIT_REWARD_MIN+1)); playerCredits+=cW; cL+=`Pirate defeated! Salvaged ${cW}c.`; currentCombatContext=null; updateMessage(cL); handleInteraction(); renderGame(); return; }
                if (Math.random() < PIRATE_HIT_CHANCE) { const pD = PIRATE_ATTACK_DAMAGE_MIN + Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1)); playerShields-=pD; cL+=`Pirate hits for ${pD}!`; } else { cL+="Pirate attack missed!"; }
                cL += ` Your Sh: ${Math.max(0, playerShields)}.\n`;
                if (playerShields <= 0) { playerShields=0; cL+=`Ship critically damaged! Emergency warp to Starbase Alpha...`; let cLost=Math.floor(playerCredits*0.1);playerCredits=Math.max(0,playerCredits-cLost);cL+=`\nLost ${cLost}c.`; playerShields=1; currentSectorX=0; currentSectorY=0; generateSectorMap(0,0); const sA=LOCATIONS_DATA["Starbase Alpha"].coords; playerX=sA.x;playerY=sA.y; currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return; }
                cL += "(F)ight or (R)un?";
            } else if (action === 'run') {
                if (playerFuel < RUN_FUEL_COST) { cL = "Not enough fuel to run!\n"; if (Math.random()<PIRATE_HIT_CHANCE){const pD=PIRATE_ATTACK_DAMAGE_MIN+Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1));playerShields-=pD;cL+=`Pirate hits for ${pD}! Your Sh: ${Math.max(0,playerShields)}.\n`;if(playerShields<=0){cL="Ship critically damaged!";playerShields=1;currentSectorX=0;currentSectorY=0;generateSectorMap(0,0);const sA=LOCATIONS_DATA["Starbase Alpha"].coords;playerX=sA.x;playerY=sA.y;currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return;}}else{cL+="Pirate missed!\n";} cL+="(F)ight or (R)un?";
                } else { playerFuel-=RUN_FUEL_COST; if (Math.random()<RUN_ESCAPE_CHANCE){cL=`Escaped! Used ${RUN_FUEL_COST} fuel.`;currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return;} else { cL=`Failed to escape! Pirate attacks!\n`; if(Math.random()<PIRATE_HIT_CHANCE){const pD=PIRATE_ATTACK_DAMAGE_MIN+Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1));playerShields-=pD;cL+=`Pirate hits for ${pD}! Your Sh: ${Math.max(0,playerShields)}.\n`;if(playerShields<=0){cL="Ship critically damaged!";playerShields=1;currentSectorX=0;currentSectorY=0;generateSectorMap(0,0);const sA=LOCATIONS_DATA["Starbase Alpha"].coords;playerX=sA.x;playerY=sA.y;currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return;}}else{cL+="Pirate attack missed!\n";} cL+="(F)ight or (R)un?";}}
            } updateMessage(cL); renderGame();
        }

        document.addEventListener('keydown', function(event) {
            const key = event.key.toLowerCase();
            if (currentTradeContext) { if(key==='l'){currentTradeContext=null;handleInteraction();renderGame();}else if(currentTradeContext.step==='selectItem'&&!isNaN(parseInt(key))){handleTradeSelection(key);}else if(currentTradeContext.step==='selectQuantity'&&(!isNaN(parseInt(key))||key.length===1)){handleTradeQuantity(key);}event.preventDefault();return; }
            if (currentCombatContext) { if (key === 'f') handleCombatAction('fight'); else if (key === 'r') handleCombatAction('run'); event.preventDefault(); return; }
            let dx=0,dy=0; 
            switch(key){
                case 'w':case 'arrowup':dy=-1;break; case 's':case 'arrowdown':dy=1;break;
                case 'a':case 'arrowleft':dx=-1;break; case 'd':case 'arrowright':dx=1;break;
                case 'e':scanLocation();break; case 'h': scoopHydrogen(); break; 
                case 'b':const lB=getCombinedLocationData(playerY,playerX);if(lB&&((lB.sells&&lB.sells.length>0)||(lB.buys&&lB.buys.length>0)))displayTradeScreen('buy');else updateMessage("Cannot trade here.");break;
                case 's':const lS=getCombinedLocationData(playerY,playerX);if(lS&&((lS.sells&&lS.sells.length>0)||(lS.buys&&lS.buys.length>0)))displayTradeScreen('sell');else updateMessage("Cannot trade here.");break;
                case 'l':handleInteraction();break; 
                default:return; 
            }
            if(dx!==0||dy!==0)movePlayer(dx,dy); else renderGame(); 
            event.preventDefault();
        });
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
