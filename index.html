<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wayfinder: Echoes of the Void - v0.7.3 (Deep Content & Lore Pass VI)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #0D0D1A; 
            color: #C0C0C0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #gameContainer {
            background-color: #101022; 
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 220, 220, 0.25); 
            border: 1px solid #2a2a5a; 
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; 
        }
        #gameMap {
            white-space: pre;
            font-size: 18px; 
            line-height: 1.1; 
            border: 1px solid #333355; 
            padding: 10px;
            border-radius: 5px;
            background-color: #000000; 
            color: #A0A0A0; 
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameMap > div {
            text-align: center;
        }
        #playerStats {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px 12px; 
            width: 100%;
            max-width: 580px; 
            padding: 12px; 
            background-color: #181830; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            text-align: center;
            border: 1px solid #2a2a5a;
        }
        .stat-item {
             display: flex;
             flex-direction: column;
             align-items: center;
             padding: 3px 0; 
        }
        .stat {
            color: #00E0E0; 
            font-weight: bold;
            font-size: 1em; 
        }
        .stat-label {
            color: #8888AA; 
            font-size: 0.8em; 
            margin-bottom: 2px; 
        }
        .sector-coords {
            font-size: 0.7em; 
            color: #777799; 
        }
        #messageArea {
            min-height: 120px; 
            color: #FFD700; 
            text-align: left; 
            font-size: 16px;
            width: 100%;
            max-width: 720px; 
            padding: 15px; 
            border: 1px dashed #4a4a6a;
            border-radius: 8px;
            background-color: #101020;
            line-height: 1.4; 
        }
        .game-title {
            font-size: 2.8rem; 
            font-weight: 700;
            color: #00E0E0;
            text-shadow: 0 0 12px #00E0E0, 0 0 20px #00E0E0; 
            margin-bottom: 25px;
        }
        .controls-info {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #8888AA;
            text-align: center;
        }
        #versionInfo {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #555577; 
            text-align: center;
        }

        /* Codex Styles */
        #codexOverlay {
            position: absolute; top: 5%; left: 5%; width: 90%; height: 90%; 
            background-color: rgba(10, 10, 25, 0.97); border: 2px solid #00E0E0;
            border-radius: 10px; z-index: 1000; color: #C0C0C0; padding: 20px;
            display: none; flex-direction: column; font-size: 16px;
        }
        #codexTitle { font-size: 1.8em; color: #00E0E0; text-align: center; margin-bottom: 15px; border-bottom: 1px solid #333355; padding-bottom: 10px; }
        #codexContent { flex-grow: 1; overflow-y: auto; display: flex; }
        #codexCategories, #codexEntries { padding: 10px; border-right: 1px solid #333355; overflow-y: auto; }
        #codexEntryText { padding: 10px; overflow-y: auto; white-space: pre-wrap; text-align: left; line-height: 1.5; }
        #codexCategories { flex-basis: 25%; }
        #codexEntries { flex-basis: 30%; border-right: 1px solid #333355; }
        #codexEntryText { flex-basis: 45%; border-right: none; }
        .codex-list-item { padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; background-color: #181830; transition: background-color 0.2s; text-align: left; }
        .codex-list-item:hover { background-color: #282848; }
        .codex-list-item.active { background-color: #00E0E0; color: #0f0f1a; }
        #codexCloseButton { position: absolute; top: 15px; right: 20px; font-size: 1.5em; color: #ff4444; cursor: pointer; background: none; border: none; }

        .player-char { color: #FFFFFF; text-shadow: 0 0 5px #FFFFFF; } 
        .star-char { color: #FFFF99; } 
        .planet-char { color: #66CCFF; } 
        .starbase-char { color: #FF66FF; } 
        .outpost-char { color: #99FF99; } 
        .asteroid-char { color: #FF9966; } 
        .nebula-char { color: #CC99FF; }
        .empty-space-char { color: #A0A0A0; } 
        .pirate-char { color: #FF4444; font-weight: bold; text-shadow: 0 0 3px #FF0000; }
        .derelict-char { color: #77AADD; } 
        .anomaly-char { color: #FF00FF; font-weight: bold; animation: pulse-magenta 1.5s infinite; } 
        .wormhole-char { color: #FFA500; font-weight: bold; animation: pulse-orange 1.5s infinite; } 

        @keyframes pulse-orange { 0% { opacity: 1; text-shadow: 0 0 5px #FFA500; } 50% { opacity: 0.6; text-shadow: 0 0 10px #FF8C00; } 100% { opacity: 1; text-shadow: 0 0 5px #FFA500; } }
        @keyframes pulse-magenta { 0% { opacity: 1; text-shadow: 0 0 5px #FF00FF; } 50% { opacity: 0.6; text-shadow: 0 0 10px #DD00DD; } 100% { opacity: 1; text-shadow: 0 0 5px #FF00FF; } }
    </style>
</head>
<body>
    <h1 class="game-title">Wayfinder: Echoes of the Void</h1>

    <div id="gameContainer">
        <div id="playerStats">
            <div class="stat-item"><span class="stat-label">Fuel</span><span id="fuelStat" class="stat">0/0</span></div>
            <div class="stat-item sector-stat"> 
                <span class="stat-label">Current Sector</span>
                <span id="sectorNameStat" class="stat">Sol Sector</span>
                <span id="sectorCoordsStat" class="sector-coords">(0,0)</span>
            </div>
            <div class="stat-item"><span class="stat-label">Shields</span><span id="shieldsStat" class="stat">0/0</span></div>
            
            <div class="stat-item"><span class="stat-label">Credits</span><span id="creditsStat" class="stat">0</span></div>
            <div class="stat-item"><span class="stat-label">Cargo</span><span id="cargoStat" class="stat">0/0</span></div>
            <div class="stat-item"><span class="stat-label">Level</span><span id="levelStat" class="stat">1</span></div>
            
            <div class="stat-item"><span class="stat-label">XP</span><span id="xpStat" class="stat">0/0</span></div>
            <div class="stat-item"><span class="stat-label">Ship Class</span><span id="shipClassStat" class="stat">Unknown</span></div>
            <div class="stat-item"><span class="stat-label">Notoriety</span><span id="notorietyStat" class="stat">Unknown</span></div>
        </div>
        <div id="gameMap"></div>
        <div id="messageArea">Welcome, Explorer!</div>

        <div id="codexOverlay">
            <button id="codexCloseButton" onclick="toggleCodex(false)">&times;</button>
            <div id="codexTitle">Codex Galactica</div>
            <div id="codexContent">
                <div id="codexCategories"></div>
                <div id="codexEntries"></div>
                <div id="codexEntryText">Select an entry to read.</div>
            </div>
        </div>
    </div>

    <div class="controls-info">
        WASD: Move | E: Scan | H: Scoop Fuel | T: Traverse Wormhole | J: Codex | I: Cargo | M: Mine Asteroid <br> 
        Docked - B: Buy | S: Sell | O: Outfit Ship | L: Leave <br>
        Combat - F: Fight | R: Run
    </div>
    <div id="versionInfo">Wayfinder: Echoes of the Void - v0.7.3</div>

    <script>
        // --- Game Configuration ---
        const GAME_VERSION = "v0.7.3"; 
        const MAP_WIDTH = 55; 
        const MAP_HEIGHT = 14; 
        const PLAYER_CHAR_VAL = '@'; const EMPTY_SPACE_CHAR_VAL = '.';
        const STAR_CHAR_VAL = '*'; const PLANET_CHAR_VAL = 'O';
        const STARBASE_CHAR_VAL = '#'; 
        const OUTPOST_CHAR_VAL = 'H';  
        const ASTEROID_CHAR_VAL = '%'; const NEBULA_CHAR_VAL = '~'; 
        const PIRATE_CHAR_VAL = 'X'; const DERELICT_CHAR_VAL = 'D'; 
        const ANOMALY_CHAR_VAL = '?'; const WORMHOLE_CHAR_VAL = 'W'; 

        let INITIAL_FUEL; 
        let MAX_FUEL;     
        const INITIAL_CREDITS = 1000; const PLAYER_CARGO_CAPACITY = 50;
        const BASE_FUEL_PER_MOVE = 1; 
        let INITIAL_SHIELDS; 
        let MAX_SHIELDS;     
        const PIRATE_ENCOUNTER_CHANCE = 0.0025; 
        const RUN_ESCAPE_CHANCE = 0.6; const RUN_FUEL_COST = 5;

        let PLAYER_ATTACK_DAMAGE; 
        let PLAYER_HIT_CHANCE;  
        const PIRATE_BASE_SHIELDS_MIN = 15; 
        const PIRATE_BASE_SHIELDS_MAX = 35; 
        const PIRATE_ATTACK_DAMAGE_MIN = 5;
        const PIRATE_ATTACK_DAMAGE_MAX = 12; 
        const PIRATE_HIT_CHANCE = 0.6;
        const PIRATE_CREDIT_REWARD_MIN = 20; const PIRATE_CREDIT_REWARD_MAX = 60; 
        const XP_PER_PIRATE_MIN = 10; 
        const XP_PER_PIRATE_MAX = 25; 

        const MIN_SCOOP_YIELD = 8; 
        const MAX_SCOOP_YIELD_RICHNESS_MULTIPLIER = 15; 
        const SCOOP_RANDOM_BONUS = 3; 

        const OUTPOST_SPAWN_CHANCE = 0.08; 
        const WORMHOLE_SPAWN_CHANCE = 0.03; 
        const WORMHOLE_TRAVEL_FUEL_COST = 20;
        const WORMHOLE_JUMP_MIN_DIST = 5;
        const WORMHOLE_JUMP_MAX_DIST = 15;

        const BASE_XP_TO_LEVEL = 75; 
        const XP_LEVEL_EXPONENT = 1.6; 
        const XP_PER_NEW_SECTOR_DISCOVERY = 25; 
        const XP_PER_FIRST_SCAN_TYPE = 5;       
        const XP_PER_LOCATION_DISCOVERY = 10;   
        const XP_PER_PROFIT_UNIT = 0.1;   
        const XP_MYSTERY_REWARD = 200;      
        const XP_WORMHOLE_TRAVERSE = 15;
        const XP_PER_MINING_OP = 3; 
        const XP_BONUS_RARE_MINERAL = 5; 

        // Notoriety Configuration
        const NOTORIETY_TITLES = [
            { score: -Infinity, title: "Enemy of the Concord" }, 
            { score: -200, title: "Wanted Outlaw" },
            { score: -50,  title: "Troublemaker" },
            { score: 0,    title: "Rookie Spacer" },
            { score: 50,   title: "Known Freelancer" },
            { score: 200,  title: "Respected Captain" },
            { score: 500,  title: "Galactic Hero" }
        ]; 
        
        // --- Ship Components Database ---
        const COMPONENTS_DATABASE = {
            WEAPON_PULSE_LASER_MK1: { name: "Pulse Laser Mk1", type: "weapon", slot: "weapon", description: "Standard issue civilian pulse laser. Reliable but low power.", cost: 0, stats: { damage: 8, hitChance: 0.70 }, loreKey: "LORE_COMP_PULSE_LASER" },
            WEAPON_PULSE_LASER_MK2: { name: "Pulse Laser Mk2", type: "weapon", slot: "weapon", description: "Upgraded pulse laser with improved focusing coils for higher damage.", cost: 2000, stats: { damage: 12, hitChance: 0.75 }, loreKey: "LORE_COMP_PULSE_LASER" },
            WEAPON_PULSE_LASER_MK3: { name: "Pulse Laser Mk3", type: "weapon", slot: "weapon", description: "Military-grade pulse laser. Significant damage output and better targeting.", cost: 5500, stats: { damage: 18, hitChance: 0.78 }, loreKey: "LORE_COMP_PULSE_LASER" },
            WEAPON_KINETIC_IMPULSOR_MK1: { name: "Kinetic Impulsor Mk1", type: "weapon", slot: "weapon", description: "Fires solid slugs. Decent against unshielded hulls.", cost: 1800, stats: { damage: 15, hitChance: 0.65 }, loreKey: "LORE_COMP_KINETIC_WEAPON" },
            WEAPON_ION_CANNON_MK1: { name: "Ion Cannon Mk1", type: "weapon", slot: "weapon", description: "Disrupts shields effectively, less hull damage.", cost: 2200, stats: { damage: 6, hitChance: 0.80, vsShieldBonus: 10 }, loreKey: "LORE_COMP_ION_WEAPON" }, 
            WEAPON_BEAM_LASER_MK1: { name: "Beam Laser Mk1", type: "weapon", slot: "weapon", description: "Sustained energy beam. High accuracy, consistent damage over time.", cost: 2800, stats: { damage: 10, hitChance: 0.85 }, loreKey: "LORE_COMP_BEAM_LASER" },
            WEAPON_MASS_DRIVER_MK1: { name: "Mass Driver Mk1", type: "weapon", slot: "weapon", description: "Accelerates a dense projectile to devastating speeds. High hull damage, slow fire rate.", cost: 3800, stats: { damage: 25, hitChance: 0.60 }, loreKey: "LORE_COMP_MASS_DRIVER" },
            WEAPON_MISSILE_LAUNCHER_MK1: { name: "Missile Launcher Mk1", type: "weapon", slot: "weapon", description: "Fires self-propelled explosive ordnance. High damage, limited ammo (flavor).", cost: 4500, stats: { damage: 30, hitChance: 0.60 }, loreKey: "LORE_COMP_MISSILE_LAUNCHER" },
            SHIELD_BASIC_ARRAY_A: { name: "Basic Deflector Array A", type: "shield", slot: "shield", description: "Entry-level shield generator. Offers minimal protection.", cost: 0, stats: { maxShields: 50, rechargeRate: 1 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            SHIELD_GUARDIAN_B: { name: "Guardian Shield Emitter B", type: "shield", slot: "shield", description: "Military surplus shield, offering better resilience and faster recharge.", cost: 2500, stats: { maxShields: 80, rechargeRate: 2 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" }, 
            SHIELD_AEGIS_C: { name: "Aegis Shield Projector C", type: "shield", slot: "shield", description: "Top-tier Concord shield tech. Excellent protection and robust recharge.", cost: 5000, stats: { maxShields: 120, rechargeRate: 3 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            SHIELD_RAPID_CYCLE_A: { name: "Rapid-Cycle Unit A", type: "shield", slot: "shield", description: "Lower capacity, but regenerates very quickly. Favored by agile fighters.", cost: 3000, stats: { maxShields: 65, rechargeRate: 4 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            SHIELD_FORTRESS_GRID_A: { name: "Fortress Grid A", type: "shield", slot: "shield", description: "Extremely high capacity, but slow to regenerate. For ships that can take a beating.", cost: 4500, stats: { maxShields: 150, rechargeRate: 1 }, loreKey: "LORE_COMP_SHIELD_GENERATOR" },
            ENGINE_STD_DRIVE_MK1: { name: "Standard Drive Mk1", type: "engine", slot: "engine", description: "Common civilian stardrive. Gets you there, eventually.", cost: 0, stats: { maxFuel: 200, fuelEfficiency: 1.0 }, loreKey: "LORE_COMP_ENGINE" }, 
            ENGINE_RANGEPLUS_MK1: { name: "RangePlus Drive Mk1", type: "engine", slot: "engine", description: "Larger fuel tank for extended travel, standard efficiency.", cost: 3000, stats: { maxFuel: 300, fuelEfficiency: 1.0 }, loreKey: "LORE_COMP_ENGINE" },
            ENGINE_IONFLOW_MK2: { name: "IonFlow Drive Mk2", type: "engine", slot: "engine", description: "Advanced ion engine, significantly better fuel efficiency.", cost: 4000, stats: { maxFuel: 250, fuelEfficiency: 0.8 }, loreKey: "LORE_COMP_ENGINE" }, 
            ENGINE_HIGH_THRUST_MK1: { name: "High-Thrust Drive Mk1", type: "engine", slot: "engine", description: "Powerful engine, standard fuel tank but hints at faster sublight travel (future).", cost: 3500, stats: { maxFuel: 200, fuelEfficiency: 1.1 }, loreKey: "LORE_COMP_ENGINE" },
            SCANNER_BASIC_SUITE: { name: "Standard Sensor Suite", type: "scanner", slot: "scanner", description: "Basic sensor package. Provides essential data.", cost: 0, stats: { scanBonus: 0 }, loreKey: "LORE_COMP_SCANNER" },
            SCANNER_DEEP_RANGE_A: { name: "Deep-Range Array A", type: "scanner", slot: "scanner", description: "Improved sensor resolution. May reveal more details or rarer finds.", cost: 1500, stats: { scanBonus: 0.05 }, loreKey: "LORE_COMP_SCANNER" } 
        };


        const COMMODITIES = { 
            FUEL_CELLS: { name: "Fuel Cells", basePrice: 10, description: "Standard hyper-refined hydrogen fuel cells. The lifeblood of interstellar travel. Always a steady demand, especially in remote sectors far from scoopable stars. Some black market variants promise higher energy density but are notoriously unstable, prone to catastrophic failure." },
            MINERALS: { name: "Minerals", basePrice: 25, description: "A mix of common industrial ores - iron, bauxite, silicates. Essential for construction and basic manufacturing. Bulk haulers make their fortunes on these, supplying the ever-expanding Concord infrastructure projects and the insatiable war machines of various factions." },
            FOOD_SUPPLIES: { name: "Food Supplies", basePrice: 15, description: "Nutrient paste, hydroponic vegetables, and recycled protein. Keeps the void-sickness at bay on long voyages. Quality varies greatly from 'edible' to 'surprisingly tasty', depending on the chef-bot and source system. Some luxury brands are considered delicacies." },
            TECH_PARTS: { name: "Tech Parts", basePrice: 50, description: "Assorted advanced electronic components, often in high demand for repairs and illicit upgrades. Quality varies wildly, from salvaged junk to military-grade components that 'fell off a starliner'. Some may contain restricted K'tharr tech or even Precursor interface chips that react strangely to modern systems." },
            RARE_METALS: { name: "Rare Metals", basePrice: 75, description: "Precious and exotic metals like Platinum, Iridium, and Lanthanum. Used in high-tech manufacturing and sensitive FTL components. Often found in unstable asteroid fields or worlds with extreme geology, making extraction dangerous and costly. Some are rumored to have... unusual quantum properties." },
            MEDICAL_SUPPLIES: { name: "Medical Supplies", basePrice: 60, description: "Field kits, combat stims, and anti-radiation drugs. A spacer's best friend after a rough encounter or a miscalculated jump. Some are restricted by Concord, others are black market specials with unpredictable side effects, like the infamous 'Berserker' stims that grant temporary strength at the cost of sanity." },
            ARTIFACT_SHARDS: { name: "Artifact Shards", basePrice: 150, description: "Fragments of unknown, possibly alien, technology. Highly sought after by collectors and xeno-archaeologists. Rumored to hum with faint energy and whisper forgotten secrets. Some believe they are pieces of Precursor 'keys' to unlock their lost knowledge or activate dormant machinery. Holding one for too long can induce strange dreams." },
            XENO_ANTIQUES: { name: "Xeno-Antiques", basePrice: 200, description: "Intact relics from extinct alien civilizations. Extremely rare and valuable to the right buyer. Some whisper they carry curses or forgotten knowledge of the Precursors. Authenticity is often dubious, many are clever fakes. The K'tharr consider most Xeno-Antiques to be blasphemous and will destroy them on sight." },
            FORBIDDEN_TEXTS: { name: "Forbidden Texts", basePrice: 120, description: "Data slates containing controversial or dangerous information - heretical philosophies, banned technologies, or histories the Concord wants forgotten. Possession is often illegal under Galactic Concord law. Knowledge has a price, and some knowledge is best left unknown, lest it unravel the fabric of society or reveal uncomfortable truths about the Concord's rise to power or the true nature of the Precursors." },
            PRECURSOR_DATACUBE: { name: "Precursor Datacube", basePrice: 350, description: "A perfectly preserved data storage device of Precursor origin. Its contents are unreadable by current tech, but its value is immense to certain factions seeking to unlock the secrets of the ancients. They are rumored to contain star charts to lost worlds, schematics for unimaginable technology, or even the history of the Precursors' final days and their warnings about 'The Silencers'." },
            KTHARR_SPICES: { name: "K'tharr Spices", basePrice: 90, description: "Highly potent and addictive spices from the K'tharr Hegemony. Illegal in Concord space, prized by hedonists and those seeking 'expanded consciousness'. Said to induce visions of other realities or commune with K'tharr ancestors. Long-term use has... side effects, often involving paranoia, aggression, and a craving for more of the spice." },
            VOID_CRYSTALS: { name: "Void Crystals", basePrice: 180, description: "Crystals that seem to absorb light, found only near certain anomalies. Their properties are largely unknown and dangerous. Some say they whisper secrets of the void, or are solidified 'nothingness' that can unravel spacetime. The Children of the Void revere them as holy relics and use them to power strange devices." },
            GENETIC_SAMPLES: { name: "Genetic Samples", basePrice: 110, description: "Viable biological material from rare or extinct xeno-fauna. Valued by researchers and bio-corporations for study or weaponization. Some samples are highly unstable and require specialized containment. The K'tharr are known to pay well for samples of 'pure' genetic lines, for reasons unknown."},
            NAVIGATION_CHARTS: { name: "Navigation Charts", basePrice: 40, description: "Updated stellar cartography data for nearby systems. Essential for safe travel, but often outdated quickly. Some charts hint at uncharted routes or hidden locations, sold by less scrupulous dealers. Concord charts are reliable but often omit 'sensitive' areas like black sites or Precursor quarantine zones."},
            SENTIENT_MYCELIUM: { name: "Sentient Mycelium", basePrice: 220, description: "A rare, psychoactive fungus found in deep-space derelicts or certain nebulae. Its uses are... varied and often illicit. Some claim it allows telepathic communication with the 'Great Spore Network' that spans galaxies, a collective consciousness of ancient fungal life. Others say it simply drives you mad, filling your mind with alien thoughts and the laughter of dead gods." },
            PHASE_SHIFTED_ALLOY: { name: "Phase-Shifted Alloy", basePrice: 400, description: "An incredibly rare Precursor material that flickers in and out of normal spacetime. Almost impossible to work with, but invaluable for advanced shield tech or experimental FTL drives. Rumored to be unstable and require specialized containment fields. Some say ships made of it can pass through normal matter, or even between dimensions, but the process is... unsettling for organic minds." },
            WAYFINDER_CORE: { name: "Wayfinder Core", basePrice: 1000, description: "The heart of a Precursor Wayfinder. Pulsates with ancient energy and contains fragmented star charts leading to unknown regions. Highly coveted by the Concord and other factions. Its purpose remains a profound mystery, but it's said to respond to other Precursor artifacts and guide ships through impossible spaces. It feels warm to the touch, almost alive, and sometimes projects faint, alien constellations onto nearby surfaces." },
            KTHARR_ANCESTRAL_BLADE: { name: "K'tharr Ancestral Blade", basePrice: 275, description: "An ancient, energy-edged blade passed down through K'tharr warrior lineages. More than a weapon, it's a symbol of honor and a conduit to ancestral spirits. Highly illegal for non-K'tharr to possess, and the Hegemony will go to great lengths to recover one. Each blade is said to contain the 'soul' of its previous wielders and can only be truly mastered by one of K'tharr blood." },
            PRECURSOR_STAR_MAP_FRAGMENT: { name: "Precursor Star Map Fragment", basePrice: 650, description: "A crystalline shard that projects a partial, holographic star chart of an unknown, impossibly distant region of space. Clearly Precursor in origin, it could lead to untold discoveries... or dangers beyond imagining. These are pieces of a larger, galaxy-spanning map, possibly leading to the Precursor homeworld or their greatest creations. Some fragments are said to actively resist being joined with others."},
            GOLD: { name: "Gold Bullion", basePrice: 100, description: "Universally valued heavy metal, often used as a stable currency reserve or for high-end decorative purposes. Less industrially useful than some rare metals, but always in demand." },
            PLATINUM_ORE: { name: "Platinum Ore", basePrice: 60, description: "Unrefined ore containing platinum group metals. Requires significant processing but yields highly valuable materials for catalysts and advanced electronics." },
            HYDROGEN_3: { name: "Hydrogen-3", basePrice: 300, description: "A rare and stable isotope of hydrogen, prized for its use in advanced fusion reactors and experimental FTL drives. Extremely difficult to find and extract." }
        };
        const LOCATIONS_DATA = { 
            "Starbase Alpha": { 
                coords: { y: MAP_HEIGHT - 5, x: MAP_WIDTH - 7 }, type: STARBASE_CHAR_VAL, 
                isMajorHub: true, 
                sells: [ { id: "FUEL_CELLS", priceMod: 0.9, stock: 100 }, { id: "TECH_PARTS", priceMod: 1.1, stock: 30 }, { id: "MEDICAL_SUPPLIES", priceMod: 1.0, stock: 25 }, { id: "NAVIGATION_CHARTS", priceMod: 1.0, stock: 50 } ],
                buys: [ 
                    { id: "MINERALS", priceMod: 1.2, stock: 50 }, { id: "FOOD_SUPPLIES", priceMod: 1.1, stock: 50 }, 
                    { id: "RARE_METALS", priceMod: 1.3, stock: 15 }, { id: "ARTIFACT_SHARDS", priceMod: 1.5, stock: 5 }, 
                    { id: "XENO_ANTIQUES", priceMod: 1.8, stock: 2 }, { id: "PRECURSOR_DATACUBE", priceMod: 2.5, stock: 1}, 
                    { id: "VOID_CRYSTALS", priceMod: 1.6, stock: 3}, { id: "GENETIC_SAMPLES", priceMod: 1.4, stock: 10},
                    { id: "FORBIDDEN_TEXTS", priceMod: 0.7, stock: 3 }, { id: "PHASE_SHIFTED_ALLOY", priceMod: 3.0, stock: 1},
                    { id: "WAYFINDER_CORE", priceMod: 5.0, stock: 1 }, { id: "SENTIENT_MYCELIUM", priceMod: 1.2, stock: 4 }, 
                    { id: "PRECURSOR_STAR_MAP_FRAGMENT", priceMod: 4.0, stock: 1}, { id: "KTHARR_ANCESTRAL_BLADE", priceMod: 0.5, stock: 1 },
                    { id: "GOLD", priceMod: 1.1, stock: 30 }, { id: "PLATINUM_ORE", priceMod: 1.2, stock: 20 }, { id: "HYDROGEN_3", priceMod: 2.0, stock: 5 }
                ],
                scanFlavor: "Starbase Alpha: Major Concord trade hub. Known for its extensive archives and the 'Oracle of Cygnus' in the Mystic Quarter. The Obsidian Directorate wing here is rumored to conduct secret FTL research."
            },
            "Planet Omega": { coords: { y: 7, x: 7 }, type: PLANET_CHAR_VAL, sells: [ { id: "MINERALS", priceMod: 0.8, stock: 200 }, { id: "FOOD_SUPPLIES", priceMod: 0.9, stock: 100 } ], buys: [ { id: "TECH_PARTS", priceMod: 1.3, stock: 10 }, { id: "RARE_METALS", priceMod: 1.1, stock: 20 } ], scanFlavor: "Planet Omega: Rich Dilithium deposits. Significant Precursor ruins present, Concord research outpost active nearby. Atmosphere: Thin, breathable. Surface: Moderate." },
            "Planet Xerxes": {  coords: { y: 3, x: MAP_WIDTH - 5 }, type: PLANET_CHAR_VAL, sells: [], buys: [], scanFlavor: "Planet Xerxes: Extreme environment, corrosive atmosphere. High Xenon Gas and heavy metal concentrations. Rumored pirate haven and site of ancient K'tharr battles." }
        };
        let currentSectorOutpostData = null; 
        const RUMORS = [ /* Same extensive list as v0.6.11 */
            "Captain 'Voidfang' still plagues the Kepler Nebula. They say her ship, the 'Nightreaver', is faster than any Concord patrol, and she's looking for a legendary Precursor map that leads to the 'Silentium Expanse'. She supposedly has a K'tharr first mate, a disgraced warrior seeking redemption, who knows the old K'tharr star-paths. Some say she's already found a Precursor Star Map Fragment, and is seeking more to complete a 'Cosmic Sextant'.",
            "That derelict capital ship in Gamma-7? Some say it's a 'Precursor' vessel, others claim it's a military ghost from the old Terran Wars, its AI still active and hostile. A few brave souls tried to board it... none returned. They say it 'sings' on subspace frequencies, a song of madness that lures ships to their doom. Some say it guards a stable wormhole to an unknown galaxy, or a cache of Phase-Shifted Alloy that keeps it partially out of phase with reality.",
            "Young stars in the Orion Spur sectors often have asteroid belts rich in Iridium. Risky, but profitable. Watch for claim jumpers and the K'tharr mining guilds, who consider those belts sacred ground, burial sites of their ancestors. They guard them fiercely and are known to use phase-cloaked mines. They say some asteroids there are not asteroids at all, but dormant K'tharr bio-weapons or eggs of stellar creatures.",
            "The K'tharr Hegemony is tightening its borders near the Serpentis Cluster. Fuel prices might spike if their trade routes are disrupted. They don't take kindly to outsiders, especially those carrying 'Forbidden Texts' or Precursor tech, which they deem 'unholy corruptions' that led to the Precursors' downfall. Their 'Void Priests' preach of a coming cleansing, and they're actively hunting for K'tharr Ancestral Blades stolen by 'infidels', believing each blade holds a piece of their collective soul.",
            "The research team near the 'Whispering Anomaly' in Sector (-1, 4)? Vanished. Some say they found something they shouldn't have, something that... whispered back, promising power. Their last garbled transmission mentioned 'opening the way' to a 'realm of pure thought' and 'the entities beyond the veil of stars'. One crewman was found catatonic, clutching a Void Crystal, his mind shattered, muttering about 'star-songs'.",
            "Starbase Alpha is offering bounties for information on pirate activity in the outer rim sectors. Concord's reach is long, but not infinite. They're particularly interested in any 'Voidfang' sightings and the location of her hidden base, rumored to be inside a hollowed-out asteroid cloaked with Precursor tech, possibly using Phase-Shifted Alloy. They also want any recovered K'tharr Honor Blades, no questions asked... well, few questions, and a hefty 'processing fee'.",
            "Artifact Shards are fetching high prices on the black market. Collectors are obsessed with 'Precursor' tech, believing it holds the key to FTL without Dilithium. The University of Cygnus Prime pays even more for intact Datacubes, hoping to unlock their secrets before the Concord classifies them as 'restricted knowledge' under the Galactic Security Act. They say one Datacube contains the location of a Precursor library, or a weapon of unimaginable power, perhaps even the schematics for a 'world-killer'.",
            "Blue giants offer rich hydrogen, but their solar flares can fry your systems if you're not careful. Lost a good friend that way, chasing a 'perfect scoop'. He swore he saw ships dancing in the corona, made of pure light, beckoning him closer. Some say they are stellar elementals, ancient beings of pure energy, or perhaps Precursor guardians of sacred stars, still active after millennia.",
            "Heard a distress call from a mining outpost in Sector (2,5). Something about 'crystal entities' awakening in the deep mines. Sounded like a tall tale, but the outpost went silent shortly after. Concord has quarantined the sector, calling it a 'geological event', but survivors whisper of crystalline horrors that absorb energy and replicate, possibly a form of silicon-based life or a Precursor terraforming experiment gone wrong.",
            "The 'Silentium Expanse' beyond Sector (10,10) is uncharted. Legends say it's where stars go to die, or where something else entirely sleeps, something ancient and vast. The Precursors called it 'The Great Filter', a test for ascending civilizations. Some say it's a gateway to other universes, or the domain of the Void Dwellers, beings of pure nothingness who hunger for reality. No ship that has entered has ever returned with reliable data.",
            "A trader mentioned a hidden Outpost in the 'Graveyard of Ships' sector that deals in Forbidden Texts and Xeno-Antiques. High risk, high reward. They say it's run by a reclusive information broker known only as 'The Archivist', who is rumored to be an AI from before the Concord, possessing knowledge lost to time, including fragments of the K'tharr sacred scrolls and Precursor Star Map Fragments. They say The Archivist demands unique data in trade, not just credits.",
            "The 'Precursors' supposedly left 'Wayfinders' scattered across the galaxy. Finding one could lead to unimaginable discoveries... or doom. Each Wayfinder is said to point to another, forming a cosmic breadcrumb trail to their mythical homeworld, or their tomb. The first signal was detected near a binary star in a volatile region...", 
            "There's a faction known as the 'Children of the Void' who worship anomalies. They're said to be... unpredictable, and sometimes hostile to those who 'disturb the sacred'. They seek to understand the 'language of creation' and achieve apotheosis by merging with the void. They collect Void Crystals for their rituals, and some say they can control lesser anomalies or even commune with the Sentient Mycelium to glimpse the future.",
            "The K'tharr are a proud, warrior race. Their spices are potent, but their justice is swift for those caught smuggling them into Concord space. Their homeworld is said to be a fortress, built around a black hole, powered by its accretion disk. They view the Precursors as heretics, and any who traffic in their tech as blasphemers. Their Ancestral Blades are said to be forged from fallen stars and can cut through Concord armor like paper, resonating with the wielder's 'Ki' or life-force.",
            "Void Crystals? Nasty stuff. Heard they can warp reality locally. Some cults use them in their rituals, trying to contact entities from 'beyond the veil'. Stay clear if you value your sanity. They say the crystals whisper your deepest fears and desires, and sometimes, grant them, at a terrible price. They are also a key component in some experimental Concord weapons designed to breach other dimensions.",
            "Some say the derelict ships aren't all accidental. There are whispers of 'ship-breakers', pirates who disable vessels and leave them for scavengers... after taking the best loot and sometimes, the crew for 'other purposes', like selling them to the K'tharr or using them in dark rituals involving Sentient Mycelium. Voidfang is rumored to be a master of this tactic, leaving no witnesses.",
            "The Galactic Concord is rumored to be developing a new type of FTL drive, one that doesn't rely on Dilithium. They're desperate for Precursor Datacubes to complete it, and they'll pay anything, or take it by force. The Obsidian Directorate is said to be leading this effort, and they don't play by the rules. They're also trying to weaponize Phase-Shifted Alloys for their new 'Nova' class destroyers, capable of phasing through enemy shields.",
            "There's a legend of a 'Genesis Planet' hidden deep within an uncharted nebula, a world teeming with life and untouched by any known civilization. Many have sought it; none have returned with proof. Some say it's guarded by a sentient nebula that tests the worthiness of visitors, or that it's made entirely of Sentient Mycelium, a single, planet-sized organism that dreams the universe into being, and can reshape reality within its domain.",
            "Sentient Mycelium networks are said to span entire star systems, hidden within dense nebulae. Touching them can grant visions, or madness. Some traders pay highly for samples, believing it can unlock psychic potential or even allow communication across vast distances instantaneously. The K'tharr consider it a sacred plant, a gift from their void gods, used in their most sacred rituals.",
            "Phase-Shifted Alloys are the holy grail for shipwrights. A hull made of it could theoretically pass through solid matter. Finding even a scrap is like finding a king's ransom. The Precursors used it extensively in their most advanced constructs, including their Wayfinders and city-ships. Some say it's not an alloy at all, but a form of stabilized exotic matter from another dimension, and it slowly 'learns' to adapt to its environment.",
            "Heard some spacers talking about 'Ghost Fleets' in the uncharted territories. Ships that appear on sensors, then vanish. Some say they're K'tharr scouts, others, something far older. Some even whisper they are echoes of ships lost in wormholes, forever caught between dimensions, their crews driven mad by the experience, forever replaying their final moments.",
            "The 'Oracle of Cygnus' at Starbase Alpha sometimes gives cryptic prophecies to those who bring her rare Xeno-Antiques. Most think she's just a charlatan, but a few swear by her words. She once predicted the K'tharr invasion of the Draco system, and the appearance of the 'Silentium Expanse' on long-range charts. She also mumbles about 'the return of the Star-Eaters' and the 'Cycle of Silence', an ancient Precursor prophecy.",
            "Wormholes are tears in spacetime, unstable and dangerous. But some ancient texts speak of 'Stable Conduits' left by the Precursors. Finding one would revolutionize interstellar travel... or unleash whatever lies at the other end. Some say they lead to other galaxies, or even other times. The Concord heavily restricts research into them, fearing what they might unleash upon an unsuspecting galaxy.",
            "The 'Void Kraken' is a legend among deep-space haulers. A colossal, energy-based lifeform said to inhabit dark nebulae, preying on unwary ships. Most dismiss it as space-madness, but some derelicts are found with strange, energy-based scarring... and their crews are always missing. Some say it's a Precursor bio-weapon gone rogue, or a guardian of the void.",
            "There's a black market for 'Precursor Navigational Cores' on some remote outposts. They say these cores can interface with ancient Precursor hyperlanes, allowing for instantaneous travel across vast distances... if you can survive the trip and the entities that guard those lanes. They are often found within Precursor Star Map Fragments, and are said to sing to those who can listen."
        ];

        // --- Lore Database ---
        const LORE_DATABASE = { 
            FACTION_CONCORD: { title: "Galactic Concord", category: "Factions", text: "The Galactic Concord is the dominant interstellar government, formed after the Terran Wars some three centuries ago. It strives to maintain peace and facilitate trade across thousands of member systems. While generally seen as a force for order, its bureaucracy can be stifling, and its military arm, Concord Defense Force (CDF), is known for its efficiency and sometimes ruthless enforcement of Concord law. The Obsidian Directorate is its shadowy intelligence agency, rumored to operate outside normal legal channels, often dealing with threats deemed too sensitive for public knowledge, such as dangerous Precursor technologies or K'tharr incursions.", unlocked: false },
            FACTION_KTHARR: { title: "K'tharr Hegemony", category: "Factions", text: "The K'tharr are a proud, militaristic saurian species from the Serpentis Cluster. Their society is built on strict honor codes and warrior traditions. They are deeply spiritual, worshipping the void and celestial bodies (which they call 'Sky-Gods'), and view Precursor technology as heretical, believing it led to the Precursors' own destruction. The Hegemony is often in a state of cold war with the Concord, with frequent border skirmishes over resources and ideology. Their ships are fast, well-armed, and often utilize cloaking technology. K'tharr Ancestral Blades are symbols of immense power and status within their clans.", unlocked: false },
            FACTION_PIRATES_VOID_VULTURES: { title: "Void Vultures", category: "Factions", text: "Not a unified faction, but a loose confederation of pirate clans and individual reavers who prey on shipping lanes. The 'Void Vultures' are one of the more notorious groups, known for their ruthlessness and distinctive black-and-red ship markings. They often operate from hidden bases in asteroid fields or dark nebulae. Captain Voidfang is their most infamous leader, a cunning tactician with a reputation for always being one step ahead of the Concord.", unlocked: false },
            FACTION_CHILDREN_OF_THE_VOID: { title: "Children of the Void", category: "Factions", text: "A secretive cult that worships cosmic anomalies and the void itself. They believe these phenomena are manifestations of a higher consciousness or gateways to other realities. Their motives are often inscrutable, and they can be either helpful or hostile to those who encounter them near anomalies. They are known to collect Void Crystals for their rituals, which they claim allow them to 'hear the whispers of the universe' and predict future events or navigate hidden pathways through space.", unlocked: false },
            LOCATION_STARBASE_ALPHA: { title: "Starbase Alpha", category: "Locations", text: LOCATIONS_DATA["Starbase Alpha"].scanFlavor, unlocked: false },
            LOCATION_PLANET_OMEGA: { title: "Planet Omega", category: "Locations", text: LOCATIONS_DATA["Planet Omega"].scanFlavor, unlocked: false },
            LOCATION_PLANET_XERXES: { title: "Planet Xerxes", category: "Locations", text: LOCATIONS_DATA["Planet Xerxes"].scanFlavor, unlocked: false },
            LOCATION_OUTPOST: { title: "Outposts", category: "Locations", text: "Scattered throughout the void, outposts are small, often independent stations that serve as vital resupply points, trading posts, or havens for those on the fringes of society. Their markets are limited, but they often have unique local rumors and a character all their own. Some are havens for smugglers and pirates, others are lonely research stations or struggling colonies.", unlocked: false },
            PHENOMENON_STAR: { title: "Stars", category: "Phenomena", text: "Suns are the hearts of stellar systems, providing light, heat, and the raw hydrogen fuel essential for FTL travel. They come in many types, from stable G-type stars like Sol to volatile blue giants and dying red dwarfs. Some, like pulsars or neutron stars, are extreme cosmic objects with unique properties and dangers. Ancient civilizations often worshipped their stars, and some Precursor structures seem designed to harness stellar energy directly.", unlocked: false },
            PHENOMENON_ASTEROID: { title: "Asteroid Fields", category: "Phenomena", text: "Belts of rock, ice, and metal, often remnants of planetary formation or shattered celestial bodies. They can be rich in minerals but are also hazardous to navigate and popular hiding spots for pirates. Some fields contain unique crystalline structures or are known to be ancient battlefields, littered with the debris of forgotten wars.", unlocked: false },
            PHENOMENON_NEBULA: { title: "Nebulae", category: "Phenomena", text: "Vast clouds of interstellar gas and dust. Emission nebulae glow brightly from ionized gas, reflection nebulae shine with light from nearby stars, and dark nebulae obscure what lies within. They can interfere with sensors and hide many secrets, from stellar nurseries to pirate bases, and even pockets of unique lifeforms or strange, psychoactive gases like those that form Sentient Mycelium.", unlocked: false },
            PHENOMENON_WORMHOLE: { title: "Wormholes", category: "Phenomena", text: "Unstable tears in spacetime that can connect distant points in the galaxy, or perhaps even other realities. Traversing them is dangerous and consumes significant fuel, with unpredictable exit points. Precursor texts hint at a network of stable 'Conduits' they used for rapid transit across their empire, but none have ever been found by modern civilizations. The Concord officially denies their existence.", unlocked: false },
            XENO_PRECURSORS: { title: "The Precursors", category: "Xeno-Archaeology", text: "An ancient, highly advanced civilization that vanished eons ago, leaving behind enigmatic ruins, powerful artifacts, and unanswered questions across the galaxy. Their technology far surpassed current understanding, and factions like the Concord and various collectors desperately seek their relics. Why they disappeared is one of the greatest mysteries; theories range from self-ascension to a catastrophic war against an unknown enemy ('The Silencers') or even a self-inflicted technological cataclysm. Their understanding of spacetime and energy was profound.", unlocked: false },
            XENO_DERELICTS: { title: "Derelict Ships", category: "Xeno-Archaeology", text: "The galaxy is littered with the silent hulks of lost ships. Some are recent casualties of pirates or accidents, others are ancient mysteries from forgotten eras or unknown civilizations. Exploring them can be profitable, yielding salvage or lost cargo, but also dangerous, as some may still have active defenses, hostile lifeforms, or be booby-trapped by their former owners or later scavengers.", unlocked: false },
            XENO_ANOMALIES: { title: "Cosmic Anomalies", category: "Xeno-Archaeology", text: "Regions of space where the laws of physics seem to break down or behave erratically. These can range from gravimetric distortions and temporal loops to strange energy fields and tears in reality. They are often dangerous but can sometimes yield unique data or rare materials like Void Crystals. Some are believed to be Precursor experiments gone awry, natural phenomena beyond current comprehension, or even the battle scars of cosmic entities.", unlocked: false },
            COMMODITY_WAYFINDER_CORE: { title: "Wayfinder Core", category: "Commodities", text: COMMODITIES.WAYFINDER_CORE.description, unlocked: false },
            COMMODITY_SENTIENT_MYCELIUM: { title: "Sentient Mycelium", category: "Commodities", text: COMMODITIES.SENTIENT_MYCELIUM.description, unlocked: false },
            COMMODITY_PHASE_SHIFTED_ALLOY: { title: "Phase-Shifted Alloy", category: "Commodities", text: COMMODITIES.PHASE_SHIFTED_ALLOY.description, unlocked: false },
            COMMODITY_KTHARR_ANCESTRAL_BLADE: { title: "K'tharr Ancestral Blade", category: "Commodities", text: COMMODITIES.KTHARR_ANCESTRAL_BLADE.description, unlocked: false },
            COMMODITY_PRECURSOR_STAR_MAP_FRAGMENT: { title: "Precursor Star Map Fragment", category: "Commodities", text: COMMODITIES.PRECURSOR_STAR_MAP_FRAGMENT.description, unlocked: false },
            MYSTERY_WAYFINDER_QUEST: { title: "The Precursor Wayfinder", category: "Mysteries", text: "Ancient legends speak of Precursor 'Wayfinders', devices capable of charting paths through the deepest voids and perhaps even between galaxies. The Galactic Concord has long sought these mythical artifacts. Rumors suggest a signal from one was recently detected...", unlocked: false },
            MYSTERY_WAYFINDER_QUEST_COMPLETED: { title: "Wayfinder Activated", category: "Mysteries", text: "You successfully located and activated a Precursor Wayfinder. Its core contains fragmented charts hinting at paths into the Silentium Expanse and a location known as the 'First Nexus'. This discovery could change the course of galactic exploration, but also attract unwanted attention. The journey has just begun.", unlocked: false }
        };
        let discoveredLoreEntries = new Set();


        // --- Game State ---
        let playerX, playerY, playerFuel, playerCredits, playerShields;
        let playerShip = { 
            weapon: "WEAPON_PULSE_LASER_MK1",
            shield: "SHIELD_BASIC_ARRAY_A",
            engine: "ENGINE_STD_DRIVE_MK1",
            scanner: "SCANNER_BASIC_SUITE" 
        };
        let playerShipClass = "Light Freighter"; 
        let playerNotoriety = 0;
        let playerNotorietyTitle = "Rookie Spacer";

        let playerLevel = 1; 
        let playerXP = 0;    
        let xpToNextLevel = BASE_XP_TO_LEVEL; 
        let currentSectorX = 0; let currentSectorY = 0; 
        let playerCargo = {}; 
        let currentCargoLoad = 0;
        let gameMapGrid = []; 
        let message = "";
        let currentTradeContext = null;
        let currentCombatContext = null;
        let currentOutfitContext = null; 
        let visitedSectors = new Set(); 
        let scannedObjectTypes = new Set(); 
        let discoveredLocations = new Set(); 
        let sectorCache = {}; 
        let currentQuantityInput = ""; 

        // Mystery State
        let mystery_wayfinder_progress = 0; 
        let mystery_wayfinder_finalLocation = null; 
        const MYSTERY_WAYFINDER_TARGET_SECTOR_VOLATILITY = 5; 
        const MYSTERY_WAYFINDER_ANOMALY_HINT_TYPE = 'unstable warp pocket'; 
        const MYSTERY_WAYFINDER_DERELICT_HINT_TYPE = 'Concord patrol craft'; 
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MIN = -5; 
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MAX = -1;
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MIN = 1;
        const MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MAX = 5;


        // --- DOM Elements ---
        const gameMapElement = document.getElementById('gameMap');
        const messageAreaElement = document.getElementById('messageArea');
        const fuelStatElement = document.getElementById('fuelStat');
        const creditsStatElement = document.getElementById('creditsStat');
        const cargoStatElement = document.getElementById('cargoStat');
        const shieldsStatElement = document.getElementById('shieldsStat');
        const sectorNameStatElement = document.getElementById('sectorNameStat'); 
        const sectorCoordsStatElement = document.getElementById('sectorCoordsStat'); 
        const levelStatElement = document.getElementById('levelStat'); 
        const xpStatElement = document.getElementById('xpStat');    
        const shipClassStatElement = document.getElementById('shipClassStat'); 
        const notorietyStatElement = document.getElementById('notorietyStat'); 
        const codexOverlayElement = document.getElementById('codexOverlay');
        const codexCategoriesElement = document.getElementById('codexCategories');
        const codexEntriesElement = document.getElementById('codexEntries');
        const codexEntryTextElement = document.getElementById('codexEntryText');   

        function getTileChar(tile) { if (typeof tile === 'object' && tile !== null && tile.char) return tile.char; return tile; }
        function getTileType(tile) { if (typeof tile === 'object' && tile !== null && tile.type) return tile.type; return null; }

        function calculateXpToNextLevel(level) {
            return Math.floor(BASE_XP_TO_LEVEL * Math.pow(level, XP_LEVEL_EXPONENT)); 
        }
        
        function applyPlayerShipStats() {
            const weapon = COMPONENTS_DATABASE[playerShip.weapon];
            const shield = COMPONENTS_DATABASE[playerShip.shield];
            const engine = COMPONENTS_DATABASE[playerShip.engine];

            PLAYER_ATTACK_DAMAGE = weapon.stats.damage;
            PLAYER_HIT_CHANCE = weapon.stats.hitChance;
            MAX_SHIELDS = shield.stats.maxShields;
            MAX_FUEL = engine.stats.maxFuel;

            if (playerShields > MAX_SHIELDS) playerShields = MAX_SHIELDS;
            if (playerFuel > MAX_FUEL) playerFuel = MAX_FUEL;
        }

        function updatePlayerNotoriety(amount) {
            playerNotoriety += amount;
            updateNotorietyTitle();
        }

        function updateNotorietyTitle() {
            let currentTitle = "Rookie Spacer"; // Default
            for (let i = NOTORIETY_TITLES.length - 1; i >= 0; i--) {
                if (playerNotoriety >= NOTORIETY_TITLES[i].score) {
                    currentTitle = NOTORIETY_TITLES[i].title;
                    break;
                }
            }
            if (playerNotoriety < 0) {
                 for (let i = 0; i < NOTORIETY_TITLES.length; i++) {
                    if (playerNotoriety <= NOTORIETY_TITLES[i].score) { 
                        currentTitle = NOTORIETY_TITLES[i].title;
                        break; 
                    }
                 }
            } else { 
                 for (let i = NOTORIETY_TITLES.length - 1; i >= 0; i--) {
                    if (playerNotoriety >= NOTORIETY_TITLES[i].score) {
                        currentTitle = NOTORIETY_TITLES[i].title;
                        break;
                    }
                }
            }
            playerNotorietyTitle = currentTitle;
        }


        function unlockLoreEntry(entryKey) {
            if (LORE_DATABASE[entryKey] && !discoveredLoreEntries.has(entryKey)) {
                discoveredLoreEntries.add(entryKey);
                LORE_DATABASE[entryKey].unlocked = true; 
                updateMessage(`<span style='color:#A2D2FF;'>Codex Updated: ${LORE_DATABASE[entryKey].title}</span>`, true);
            }
        }


        function initializeGame() {
            playerShip = { 
                weapon: "WEAPON_PULSE_LASER_MK1", 
                shield: "SHIELD_BASIC_ARRAY_A", 
                engine: "ENGINE_STD_DRIVE_MK1",
                scanner: "SCANNER_BASIC_SUITE" 
            };
            applyPlayerShipStats(); 

            playerFuel = MAX_FUEL; 
            playerCredits = INITIAL_CREDITS; 
            playerShields = MAX_SHIELDS; 
            playerShipClass = "Light Freighter"; 
            playerNotoriety = 0;
            updateNotorietyTitle();


            playerLevel = 1; playerXP = 0; xpToNextLevel = calculateXpToNextLevel(playerLevel);
            visitedSectors.add("0,0"); 
            scannedObjectTypes.clear();
            discoveredLocations.clear();
            discoveredLoreEntries.clear(); 
            sectorCache = {}; 
            unlockLoreEntry("FACTION_CONCORD"); 
            unlockLoreEntry("XENO_PRECURSORS"); 
            unlockLoreEntry("MYSTERY_WAYFINDER_QUEST"); 
            unlockLoreEntry("LORE_NOTORIETY_SYSTEM"); 
            Object.keys(COMPONENTS_DATABASE).forEach(key => { 
                if (COMPONENTS_DATABASE[key].loreKey) unlockLoreEntry(COMPONENTS_DATABASE[key].loreKey);
            });


            mystery_wayfinder_progress = 0; 
            mystery_wayfinder_finalLocation = null;
            currentSectorX = 0; currentSectorY = 0; 
            playerCargo = {}; Object.keys(COMMODITIES).forEach(id => playerCargo[id] = 0);
            updateCurrentCargoLoad();
            loadOrGenerateSectorMap(currentSectorX, currentSectorY); 
            playerX = Math.floor(MAP_WIDTH / 2); playerY = Math.floor(MAP_HEIGHT / 2);
            ensurePlayerStartNotOccupied(); 
            currentTradeContext = null; currentCombatContext = null; currentOutfitContext = null;
            updateMessage(`Welcome to Sector (${currentSectorX},${currentSectorY})! Use WASD to move.`);
            renderGame();
        }
        
        function loadOrGenerateSectorMap(sX, sY) { 
            const sectorKey = `${sX},${sY}`;
            if (sectorCache[sectorKey]) {
                const cachedSector = sectorCache[sectorKey];
                gameMapGrid = JSON.parse(JSON.stringify(cachedSector.grid)); 
                currentSectorOutpostData = cachedSector.outpostData ? JSON.parse(JSON.stringify(cachedSector.outpostData)) : null;
                currentSectorName = cachedSector.name; 
                
                for (let y = 0; y < MAP_HEIGHT; y++) {
                    for (let x = 0; x < MAP_WIDTH; x++) {
                        const tile = gameMapGrid[y][x];
                        if (typeof tile === 'object' && tile !== null && tile.type === 'star') {
                            tile.scoopedThisVisit = false;
                        }
                    }
                }
            } else {
                generateNewSectorMapData(sX, sY);
                currentSectorName = generateSectorName(sX, sY); 
                sectorCache[sectorKey] = { 
                    grid: JSON.parse(JSON.stringify(gameMapGrid)), 
                    outpostData: currentSectorOutpostData ? JSON.parse(JSON.stringify(currentSectorOutpostData)) : null,
                    name: currentSectorName 
                };
            }
        }
        function generateNewSectorMapData(sX, sY) { /* Same as v0.6.12 (Deep Content & Lore Pass IV) */ gameMapGrid=[];currentSectorOutpostData=null;for(let y=0;y<MAP_HEIGHT;y++){const r=[];for(let x=0;x<MAP_WIDTH;x++)r.push(EMPTY_SPACE_CHAR_VAL);gameMapGrid.push(r);}if(sX===0&&sY===0){for(const lN in LOCATIONS_DATA){const l=LOCATIONS_DATA[lN];if(l.coords&&l.type)gameMapGrid[l.coords.y][l.coords.x]=l.type;}}else{if(Math.random()<OUTPOST_SPAWN_CHANCE){const rX=Math.floor(Math.random()*(MAP_WIDTH-4))+2;const rY=Math.floor(Math.random()*(MAP_HEIGHT-4))+2;if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){gameMapGrid[rY][rX]=OUTPOST_CHAR_VAL;currentSectorOutpostData={name:`Outpost Kepler-${Math.abs(sX)}${Math.abs(sY)}${rX%10}${rY%10}`,coords:{y:rY,x:rX},type:OUTPOST_CHAR_VAL,isMajorHub:false,...generateOutpostMarket(),scanFlavor:"A lonely outpost, a speck of light in the vast darkness. They trade what they can, and always have an ear for news from the wider galaxy.",rumor:RUMORS[Math.floor(Math.random()*RUMORS.length)]};}}if(Math.random()<WORMHOLE_SPAWN_CHANCE&&!currentSectorOutpostData){const rX=Math.floor(Math.random()*(MAP_WIDTH-4))+2;const rY=Math.floor(Math.random()*(MAP_HEIGHT-4))+2;if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){gameMapGrid[rY][rX]={char:WORMHOLE_CHAR_VAL,type:'wormhole',stability:Math.random()};}}}const numStars=1+Math.floor(Math.random()*3);for(let i=0;i<numStars;i++){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL)gameMapGrid[rY][rX]={char:STAR_CHAR_VAL,type:'star',richness:Math.random(),starType:['G-type','Red dwarf','Blue giant','Binary','Neutron Star','White Dwarf','Pulsar','Protostar','Wolf-Rayet','Rogue Star','Black Hole Accretion Disk (Visual Only)'][Math.floor(Math.random()*11)],scoopedThisVisit:false};}const numAsteroids=Math.floor(Math.random()*3);for(let i=0;i<numAsteroids;i++){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL)gameMapGrid[rY][rX]={char:ASTEROID_CHAR_VAL,type:'asteroid',density:Math.random()};}if(Math.random()<0.20){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL)gameMapGrid[rY][rX]={char:NEBULA_CHAR_VAL,type:'nebula',density:Math.random()};}if(Math.random()<0.15){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){const dS=['freighter','explorer','corvette','science vessel','luxury liner','mining barge','unknown wreckage','ancient probe','ghost ship','colony transport','prison hulk','sleeper ship','medical frigate','smuggler runabout','precursor sentinel','K\'tharr warscout','Concord patrol craft','diplomatic courier','generation ship fragment','orbital habitat shard','research outpost remains','K\'tharr broodship fragment','Concord black ops vessel','derelict Precursor surveyor','ancient stellar observatory','lost K\'tharr honor guard ship','abandoned listening post','deep space prison barge','ancient Precursor arkship','K\'tharr \'Shadow Hunter\' stealth vessel','Concord \'Aegis\' class cruiser fragment','lost generation ship','Precursor \'World Shaper\' fragment'];gameMapGrid[rY][rX]={char:DERELICT_CHAR_VAL,type:'derelict',subtype:dS[Math.floor(Math.random()*dS.length)]};}}if(Math.random()<0.10){const rX=Math.floor(Math.random()*MAP_WIDTH);const rY=Math.floor(Math.random()*MAP_HEIGHT);if(getTileChar(gameMapGrid[rY][rX])===EMPTY_SPACE_CHAR_VAL){const aS=['gravimetric wave','temporal distortion','subspace echo','exotic particle cloud','void fissure','rogue sensor ghost','energy surge','whispering void','chromatic shimmer','localized reality shear','sentient stardust cloud','echoes of creation','cosmic string fragment','unstable warp pocket','null-space bubble','precursor energy field','memory of a star','song of the void','echoes of a dying god','localized chronal stutter','reality bloom','dimensional bleed','psionic storm front','causal loop fragment','void bloom','K\'tharr void rift','Concord FTL test site (failed)','Precursor defense grid node','echoes of a Precursor battle','localized sentience field','K\'tharr ritual site echo','chroniton feedback loop','sentient solar flare','void organism spoor field','fragmented Precursor archive','Concord FTL catastrophe echo','K\'tharr ancestral echo','Precursor dreamscape fragment'];gameMapGrid[rY][rX]={char:ANOMALY_CHAR_VAL,type:'anomaly',subtype:aS[Math.floor(Math.random()*aS.length)]};}}}
        
        const SECTOR_NAME_PARTS = {
            TIER1_PREFIX: ["Nova", "Kepler", "Orion", "Cygnus", "Lyra", "Terra", "Sol", "Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Eta", "Theta", "Iota", "Kappa", "Lambda", "Mu", "Nu", "Xi", "Omicron", "Pi", "Rho", "Sigma", "Tau", "Upsilon", "Phi", "Chi", "Psi", "Omega", "Centauri", "Proxima", "Sirius", "Vega", "Altair", "Regulus", "Spica", "Arcturus", "Capella", "Rigel", "Betelgeuse", "Aldebaran", "Pollux", "Castor", "Deneb", "Fomalhaut", "Antares", "Canopus"],
            TIER1_ROOT: ["Reach", "Spur", "Arm", "Belt", "Cluster", "Expanse", "Frontier", "Verge", "Fields", "Plains", "Depths", "Shallows", "Haven", "Port", "Gate", "Passage", "Crossing", "Junction", "Nexus", "Hub", "Core", "Heart", "Prime", "Minor", "Major", "Central", "Inner", "Outer", "Drift", "Currents", "Flow", "Stream", "Shoals", "Banks", "Flats", "Heights", "Ridge", "Valley", "Canyon", "Basin"],
            TIER2_PREFIX: ["Serpentis", "Draco", "Hydra", "Lupus", "Corvus", "Volans", "Crux", "Carina", "Vela", "Pictor", "Indus", "Pavo", "Tucana", "Grus", "Phoenix", "Horologium", "Reticulum", "Dorado", "Mensa", "Chamaeleon", "Apus", "Musca", "Circinus", "Triangulum", "Norma", "Ara", "Telescopium", "Corona", "Fornax", "Sculptor", "Caelum", "Eridanus", "Cetus", "Aquarius", "Capricornus", "Sagittarius", "Scorpius", "Libra", "Virgo", "Leo", "Cancer", "Gemini", "Taurus", "Aries", "Pisces", "Ophiuchus", "Lyra Minor", "Ursa Major", "Ursa Minor", "Canis Major", "Canis Minor", "Perseus", "Andromeda", "Cassiopeia", "Cepheus", "Lacerta", "Pegasus", "Delphinus", "Equuleus", "Aquila", "Sagitta", "Vulpecula", "Cygnus Minor"],
            TIER2_ROOT: ["Void", "Abyss", "Chasm", "Gulf", "Maelstrom", "Nebula", "Wastes", "Badlands", "Peril", "Hazard", "Brink", "Edge", "Terminus", "Limit", "Maw", "Jaws", "Teeth", "Claws", "Fangs", "Spines", "Thorns", "Barrens", "Wilds", "Expanse", "Deeps", "Shroud", "Veil", "Mist", "Gloom", "Shadow", "Dark", "Grim", "Bleak", "Despair", "Sorrow", "Fear", "Dread", "Terror", "Whispers", "Echoes", "Silence", "Stillness", "Emptiness"],
            TIER3_PREFIX: ["Xylos", "Zylos", "Varkos", "Kryll", "Ghor", "Thrax", "Zargon", "Vorlag", "Nyx", "Erebus", "Tartarus", "Styx", "Acheron", "Phlegethon", "Cocytus", "Lethe", "Hades", "Gehenna", "Sheol", "Abaddon", "Apollyon", "Azrael", "Thanatos", "Moros", "Ker", "Keres", "Yama", "Hel", "Niflheim", "Muspelheim", "Jotunheim", "Svartalfheim", "Yomi", "Kur", "Irkalla", "Duat", "Xibalba", "Mictlan", "Naraka", "Patala", "Annwn", "Tuonela", "Adlivun", "Ukhu Pacha", "Chinvat", "Hamistagan", "Pescha", "Arqa", "Diyu"],
            TIER3_ROOT: ["Oblivion", "Annihilation", "Desolation", "Ruin", "Terror", "Horror", "Madness", "Silence", "Emptiness", "Nothingness", "End", "Omega", "Ultima", "Finality", "Doom", "Blight", "Scourge", "Plague", "Curse", "Hex", "Bane", "Wrath", "Fury", "Storm", "Tempest", "Vortex", "Singularity", "Anomaly", "Paradox", "Enigma", "Labyrinth", "Maze", "Prison", "Tomb", "Crypt", "Sepulcher", "Citadel", "Fortress", "Bastion", "Stronghold", "Domain", "Realm", "Kingdom", "Empire", "Cataclysm", "Apocalypse", "Judgement", "Nadir", "Zero"]
        };

        function generateSectorName(sX, sY) {
            if (sX === 0 && sY === 0) return "Sol Sector"; 

            const absX = Math.abs(sX);
            const absY = Math.abs(sY);
            const maxCoord = Math.max(absX, absY);

            let prefixList, rootList;

            if (maxCoord < 5) {
                prefixList = SECTOR_NAME_PARTS.TIER1_PREFIX;
                rootList = SECTOR_NAME_PARTS.TIER1_ROOT;
            } else if (maxCoord < 15) {
                prefixList = SECTOR_NAME_PARTS.TIER2_PREFIX;
                rootList = SECTOR_NAME_PARTS.TIER2_ROOT;
            } else {
                prefixList = SECTOR_NAME_PARTS.TIER3_PREFIX;
                rootList = SECTOR_NAME_PARTS.TIER3_ROOT;
            }
            
            const prefix = prefixList[Math.floor(Math.random() * prefixList.length)];
            const root = rootList[Math.floor(Math.random() * rootList.length)];
            
            return `${prefix} ${root}`;
        }
        let currentSectorName = "Sol Sector"; 


        function generateOutpostMarket() { /* Same as v0.6.11 */ const cK=Object.keys(COMMODITIES);let sI=null,bI=null;const sLb=cK.filter(id=>!["RARE_METALS","TECH_PARTS","ARTIFACT_SHARDS","XENO_ANTIQUES","FORBIDDEN_TEXTS","PRECURSOR_DATACUBE","VOID_CRYSTALS","SENTIENT_MYCELIUM","PHASE_SHIFTED_ALLOY","WAYFINDER_CORE","KTHARR_ANCESTRAL_BLADE","PRECURSOR_STAR_MAP_FRAGMENT"].includes(id));if(sLb.length>0){const sID=sLb[Math.floor(Math.random()*sLb.length)];sI={id:sID,priceMod:1.0+(Math.random()*0.2-0.1),stock:10+Math.floor(Math.random()*21)};}const bLb=cK.filter(id=>(!sI||id!==sI.id)&&!["ARTIFACT_SHARDS","XENO_ANTIQUES","FORBIDDEN_TEXTS","PRECURSOR_DATACUBE","VOID_CRYSTALS","SENTIENT_MYCELIUM","PHASE_SHIFTED_ALLOY","WAYFINDER_CORE","KTHARR_ANCESTRAL_BLADE","PRECURSOR_STAR_MAP_FRAGMENT"].includes(id));if(bLb.length>0){const bID=bLb[Math.floor(Math.random()*bLb.length)];bI={id:bID,priceMod:1.0+(Math.random()*0.2-0.05),stock:15+Math.floor(Math.random()*26)};}return{sells:sI?[sI]:[],buys:bI?[bI]:[]};}
        function ensurePlayerStartNotOccupied() { /* Same as v0.6.7 */ if (getTileChar(gameMapGrid[playerY][playerX]) !== EMPTY_SPACE_CHAR_VAL) { let fE = false; for(let i=-1;i<=1;i++){for(let j=-1;j<=1;j++){if(i===0&&j===0)continue;const cY=playerY+i,cX=playerX+j;if(cY>=0&&cY<MAP_HEIGHT&&cX>=0&&cX<MAP_WIDTH&&getTileChar(gameMapGrid[cY][cX])===EMPTY_SPACE_CHAR_VAL){playerX=cX;playerY=cY;fE=true;break;}}if(fE)break;} if(!fE){if(getTileChar(gameMapGrid[0][0])===EMPTY_SPACE_CHAR_VAL){playerX=0;playerY=0;}else{for(let r=0;r<MAP_HEIGHT;r++){for(let c=0;c<MAP_WIDTH;c++){if(getTileChar(gameMapGrid[r][c])===EMPTY_SPACE_CHAR_VAL){playerX=c;playerY=r;fE=true;break;}}if(fE)break;}}}}}
        function updateCurrentCargoLoad() { /* Same as v0.6.7 */ currentCargoLoad = 0; for (const cID in playerCargo) currentCargoLoad += playerCargo[cID]; }

        function renderGame() { 
            gameMapElement.innerHTML = ''; 
            for (let y = 0; y < MAP_HEIGHT; y++) {
                const rD = document.createElement('div'); 
                for (let x = 0; x < MAP_WIDTH; x++) {
                    const cS = document.createElement('span'); 
                    let cTD_val = gameMapGrid[y][x]; 
                    let cTD_char = getTileChar(cTD_val); 
                    let cC = '';
                    if (currentCombatContext && x === playerX && y === playerY) { cTD_char = PIRATE_CHAR_VAL; cC = 'pirate-char';} 
                    else if (x === playerX && y === playerY) { cTD_char = PLAYER_CHAR_VAL; cC = 'player-char'; } 
                    else { 
                        switch(cTD_char) { 
                            case STAR_CHAR_VAL: cC = 'star-char'; break; case PLANET_CHAR_VAL: cC = 'planet-char'; break;
                            case STARBASE_CHAR_VAL: cC = 'starbase-char'; break; case OUTPOST_CHAR_VAL: cC = 'outpost-char'; break; 
                            case ASTEROID_CHAR_VAL: cC = 'asteroid-char'; break; case NEBULA_CHAR_VAL: cC = 'nebula-char'; break; 
                            case DERELICT_CHAR_VAL: cC = 'derelict-char'; break; case ANOMALY_CHAR_VAL: cC = 'anomaly-char'; break; 
                            case WORMHOLE_CHAR_VAL: cC = 'wormhole-char'; break;
                            case EMPTY_SPACE_CHAR_VAL: cC = 'empty-space-char'; break; default: cC = 'empty-space-char'; 
                        }
                    }
                    cS.textContent = cTD_char; if (cC) cS.className = cC; rD.appendChild(cS);
                } gameMapElement.appendChild(rD);
            }
            fuelStatElement.textContent = `${playerFuel}/${MAX_FUEL}`; 
            shieldsStatElement.textContent = `${playerShields}/${MAX_SHIELDS}`;
            creditsStatElement.textContent = playerCredits;
            cargoStatElement.textContent = `${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}`;
            levelStatElement.textContent = playerLevel; 
            xpStatElement.textContent = `${playerXP}/${xpToNextLevel}`; 
            shipClassStatElement.textContent = playerShipClass;
            notorietyStatElement.textContent = playerNotorietyTitle; 
            sectorNameStatElement.textContent = currentSectorName; 
            sectorCoordsStatElement.textContent = `(${currentSectorX},${currentSectorY})`; 
            messageAreaElement.innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('versionInfo').textContent = `Wayfinder: Echoes of the Void - ${GAME_VERSION}`;
        }

        function updateMessage(newMessage, append = false) { /* Same as v0.6.8 */ if (append) message += "\n" + newMessage; else message = newMessage; }
        function getCombinedLocationData(y,x) { /* Same as v0.6.7 */ if (currentSectorX === 0 && currentSectorY === 0) { for(const n in LOCATIONS_DATA) if(LOCATIONS_DATA[n].coords.y===y && LOCATIONS_DATA[n].coords.x===x) return {name:n, ...LOCATIONS_DATA[n]};} if (currentSectorOutpostData && currentSectorOutpostData.coords.y === y && currentSectorOutpostData.coords.x === x) return currentSectorOutpostData; return null;}

        function traverseWormhole() { /* Same as v0.6.11 */
            if (playerFuel < WORMHOLE_TRAVEL_FUEL_COST) {
                updateMessage(`Cannot traverse: Requires ${WORMHOLE_TRAVEL_FUEL_COST} fuel, you have ${playerFuel}.`); 
                renderGame();
                return;
            }
            playerFuel -= WORMHOLE_TRAVEL_FUEL_COST;
            let jumpX = Math.floor(Math.random() * (WORMHOLE_JUMP_MAX_DIST - WORMHOLE_JUMP_MIN_DIST + 1)) + WORMHOLE_JUMP_MIN_DIST;
            let jumpY = Math.floor(Math.random() * (WORMHOLE_JUMP_MAX_DIST - WORMHOLE_JUMP_MIN_DIST + 1)) + WORMHOLE_JUMP_MIN_DIST;
            if (Math.random() < 0.5) jumpX *= -1;
            if (Math.random() < 0.5) jumpY *= -1;
            currentSectorX += jumpX;
            currentSectorY += jumpY;
            playerX = Math.floor(MAP_WIDTH / 2);
            playerY = Math.floor(MAP_HEIGHT / 2);
            loadOrGenerateSectorMap(currentSectorX, currentSectorY); 
            ensurePlayerStartNotOccupied(); 
            let warpMessage = `The wormhole violently ejects you into an unknown region!\nArrived in Sector ${currentSectorName} (${currentSectorX},${currentSectorY}).`;
            const newSectorKey = `${currentSectorX},${currentSectorY}`;
            if (!visitedSectors.has(newSectorKey)) {
                visitedSectors.add(newSectorKey);
                updatePlayerNotoriety(1); 
                playerXP += XP_PER_NEW_SECTOR_DISCOVERY + XP_WORMHOLE_TRAVERSE; 
                warpMessage += `\n<span style='color:#00FF00;'>New Sector Discovered via Wormhole! +${XP_PER_NEW_SECTOR_DISCOVERY + XP_WORMHOLE_TRAVERSE} XP!</span>`;
                checkLevelUp();
            } else {
                 playerXP += XP_WORMHOLE_TRAVERSE;
                 warpMessage += `\n<span style='color:#00DD00;'>Wormhole Traversed! +${XP_WORMHOLE_TRAVERSE} XP!</span>`;
                 checkLevelUp();
            }
            unlockLoreEntry("PHENOMENON_WORMHOLE"); 
            updateMessage(warpMessage);
            handleInteraction(); 
            renderGame();
        }


        function movePlayer(dx, dy) { 
            if(currentTradeContext || currentOutfitContext){updateMessage("Complete current action (L to leave).");renderGame();return;} 
            if(currentCombatContext){updateMessage("In combat! (F)ight or (R)un.");renderGame();return;}
            
            const currentEngine = COMPONENTS_DATABASE[playerShip.engine];
            const actualFuelPerMove = BASE_FUEL_PER_MOVE * (currentEngine.stats.fuelEfficiency || 1.0);

            if(playerFuel < actualFuelPerMove &&(dx!==0||dy!==0)){updateMessage("Out of fuel!");renderGame();return;}
            
            let nX=playerX+dx; let nY=playerY+dy; let sC=false;
            
            if(nX<0){currentSectorX--;nX=MAP_WIDTH-1;sC=true;}
            else if(nX>=MAP_WIDTH){currentSectorX++;nX=0;sC=true;}
            if(nY<0){currentSectorY--;nY=MAP_HEIGHT-1;sC=true;}
            else if(nY>=MAP_HEIGHT){currentSectorY++;nY=0;sC=true;}
            
            playerX=nX;playerY=nY;
            if(dx!==0||dy!==0){playerFuel-=actualFuelPerMove;if(playerFuel<0)playerFuel=0;}
            
            if(sC){
                loadOrGenerateSectorMap(currentSectorX,currentSectorY); 
                ensurePlayerStartNotOccupied();
                let wM=`Warped to Sector ${currentSectorName} (${currentSectorX},${currentSectorY}).`;
                const nSK=`${currentSectorX},${currentSectorY}`;
                if(!visitedSectors.has(nSK)&&(currentSectorX!==0||currentSectorY!==0)){
                    visitedSectors.add(nSK);
                    playerXP+=XP_PER_NEW_SECTOR_DISCOVERY;
                    updatePlayerNotoriety(1); 
                    wM+=`\n<span style='color:#00FF00;'>New Sector Discovered! +${XP_PER_NEW_SECTOR_DISCOVERY} XP!</span>`;
                    checkLevelUp();
                }
                updateMessage(wM);
                const nSTO=gameMapGrid[playerY][playerX];const nSTC=getTileChar(nSTO);const nSTT=getTileType(nSTO);
                if((nSTC===EMPTY_SPACE_CHAR_VAL||nSTT==='asteroid'||nSTT==='derelict'||nSTT==='anomaly'|| nSTT==='wormhole')&&Math.random()<PIRATE_ENCOUNTER_CHANCE)startCombat();else handleInteraction();
            } else { 
                const currentTileObjectInternal = gameMapGrid[playerY][playerX]; 
                const currentTileCharInternal = getTileChar(currentTileObjectInternal); 
                const currentTileTypeInternal = getTileType(currentTileObjectInternal);

                if(mystery_wayfinder_progress===4&&mystery_wayfinder_finalLocation&&currentSectorX===mystery_wayfinder_finalLocation.sectorX&&currentSectorY===mystery_wayfinder_finalLocation.sectorY&&playerX===mystery_wayfinder_finalLocation.x&&playerY===mystery_wayfinder_finalLocation.y){
                    updateMessage(`You've arrived at the precise coordinates. A hidden Precursor Wayfinder activates!\nIts energy core hums, revealing fragmented charts pointing towards the Silentium Expanse and a 'First Nexus'.\n<span style='color:#DA70D6;'>+5000 Credits! +${XP_MYSTERY_REWARD} XP! Wayfinder Core acquired!</span>`);
                    playerCredits+=5000;playerXP+=XP_MYSTERY_REWARD;
                    updatePlayerNotoriety(100); 
                    if(playerCargo.WAYFINDER_CORE<PLAYER_CARGO_CAPACITY-currentCargoLoad){playerCargo.WAYFINDER_CORE=(playerCargo.WAYFINDER_CORE||0)+1;updateCurrentCargoLoad();}else{updateMessage("Wayfinder Core acquired, but no cargo space! It's left floating here.",true);}
                    mystery_wayfinder_progress=5;checkLevelUp();
                    unlockLoreEntry("MYSTERY_WAYFINDER_QUEST_COMPLETED"); 
                }else if((currentTileCharInternal===EMPTY_SPACE_CHAR_VAL||currentTileTypeInternal==='asteroid'||currentTileTypeInternal==='derelict'||currentTileTypeInternal==='anomaly'|| currentTileTypeInternal==='wormhole')&&Math.random()<PIRATE_ENCOUNTER_CHANCE)startCombat();else handleInteraction();
            }renderGame();
        }
        function handleInteraction() { 
            const tileObject = gameMapGrid[playerY][playerX];
            const tileChar = getTileChar(tileObject);
            const l=getCombinedLocationData(playerY,playerX); 
            let bM=`Sector ${currentSectorName} (${currentSectorX},${currentSectorY}) [${playerX},${playerY}]. Fuel:${playerFuel}/${MAX_FUEL}. Sh:${playerShields}.`;
            if(l){
                bM=`Arrived at ${l.name}. Fuel:${playerFuel}/${MAX_FUEL}. Sh:${playerShields}.`;
                let actionsAvailable = "";
                if((l.sells&&l.sells.length>0)||(l.buys&&l.buys.length>0)) actionsAvailable += "Trade (B/S). ";
                if (l.isMajorHub) actionsAvailable += "Outfit (O). "; 
                actionsAvailable += "Leave (L).";
                bM += "\nActions: " + actionsAvailable;

                if(l.type===STARBASE_CHAR_VAL||l.type===OUTPOST_CHAR_VAL){ 
                    playerFuel=MAX_FUEL;playerShields=MAX_SHIELDS;bM+=`\nFuel replenished & Shields repaired to max!`;
                    applyPlayerShipStats(); 
                }
                if(l.rumor) bM+= `\n<span style='color:#AAAAFF;'>Local Chatter: "${l.rumor}"</span>`;
                if(!discoveredLocations.has(l.name)){
                    discoveredLocations.add(l.name);
                    playerXP+=XP_PER_LOCATION_DISCOVERY;
                    bM+=`\n<span style='color:#00FF00;'>Location Discovered: ${l.name}! +${XP_PER_LOCATION_DISCOVERY} XP!</span>`;
                    unlockLoreEntry(`LOCATION_${l.name.replace(/\s+/g, '_').toUpperCase()}`); 
                    checkLevelUp();
                }
            } else {
                switch(tileChar){ 
                    case STAR_CHAR_VAL:bM+=` Near star. (H to Scoop Fuel)`; unlockLoreEntry("PHENOMENON_STAR"); break; 
                    case ASTEROID_CHAR_VAL:bM+=` Asteroids. (M to Mine)`; unlockLoreEntry("PHENOMENON_ASTEROID"); break;
                    case NEBULA_CHAR_VAL:bM+=` Nebula.`; unlockLoreEntry("PHENOMENON_NEBULA"); break;
                    case DERELICT_CHAR_VAL:bM+=` Near a derelict ship.`; unlockLoreEntry("XENO_DERELICTS"); break;
                    case ANOMALY_CHAR_VAL:bM+=` Near a strange anomaly.`; unlockLoreEntry("XENO_ANOMALIES"); break;
                    case WORMHOLE_CHAR_VAL:bM+=` Unstable Wormhole detected! (T to Traverse)`; unlockLoreEntry("PHENOMENON_WORMHOLE"); break;
                }
            }
            updateMessage(bM); 
        }
        
        function scanLocation() { 
            if (currentTradeContext || currentCombatContext || currentOutfitContext) { updateMessage("Cannot scan now."); renderGame(); return; }
            const location = getCombinedLocationData(playerY, playerX); 
            let scanMessage = `Scan Report - Sector ${currentSectorName} (${currentSectorX},${currentSectorY}) [${playerX},${playerY}]:\nPlayer Shields: ${playerShields}/${MAX_SHIELDS}.\n`;
            const tileObject = gameMapGrid[playerY][playerX];
            const tileChar = getTileChar(tileObject);
            let objectTypeForXP = getTileType(tileObject) || tileChar; 
            let isMysteryClue = false;
            let actionsAvailable = "";

            if (location) { /* Same as v0.6.11 */ scanMessage+=`Location: ${location.name} (${location.type}).\n`;scanMessage+=location.scanFlavor||"Standard readings for this type of installation/outpost.";if(location.rumor)scanMessage+=`\n<span style='color:#AAAAFF;'>Intercepted Local Comm: "${location.rumor}"</span>`;if((location.sells&&location.sells.length>0)||(location.buys&&location.buys.length>0)){scanMessage+="\n<span style='color:#66FF66;'>Trade Analysis:</span>";if(location.sells.length>0)scanMessage+=`\n  Exports: ${location.sells.map(item=>COMMODITIES[item.id].name).join(', ')}.`;if(location.buys.length>0)scanMessage+=`\n  Imports: ${location.buys.map(item=>COMMODITIES[item.id].name).join(', ')}.`;}else{scanMessage+="\nNo active trade facilities detected.";}objectTypeForXP=location.type; 
                 if (location.type === STARBASE_CHAR_VAL || location.type === OUTPOST_CHAR_VAL) {
                    if ((location.sells && location.sells.length > 0) || (location.buys && location.buys.length > 0)) actionsAvailable += "Trade (B/S). ";
                    if (location.isMajorHub) actionsAvailable += "Outfit (O). "; 
                    actionsAvailable += "Leave (L).";
                }
            } else { 
                switch (tileChar) { 
                    case EMPTY_SPACE_CHAR_VAL: /* Same as v0.6.11 */ const eF=["Vast emptiness. Faint cosmic background radiation. The universe feels ancient here.","Cold and silent void. Distant quasar flicker, a beacon from billions of years past.","Deep space. Unknown navigational beacons at extreme range, their origin a mystery.","Faint gravimetric distortions. Ancient... or nothing. Perhaps a Precursor hyperlane, long collapsed.","Star-dusted canvas. Quiet contemplation, or ambush. The patterns of the stars seem to shift slightly.","The silence here is profound, almost deafening. A lone comet streaks by in the far distance, its tail a whisper of ice and dust.","Echoes of ancient warp signatures, long faded. This area feels... watched. As if by unseen eyes.","A faint trail of exotic particles suggests something passed through here recently. Something big, and not of Concord design.","Sensors detect a faint, repeating energy pulse. Too weak to pinpoint, but it's out there... somewhere. It calls to something deep within your ship's core.","The void stretches on, indifferent. A perfect place to lose oneself, or be lost."];scanMessage+=eF[Math.floor(Math.random()*eF.length)];objectTypeForXP='empty_space';break;
                    case STAR_CHAR_VAL: 
                        const starFlavor = ["Brilliant G-type star...","Red dwarf...","Blue giant...","Binary star system...","Young protostar...","Neutron star remnant...","White dwarf...","Pulsar...","Star with stellar engineering...","Variable star...","Wolf-Rayet star...","Rogue star..."];
                        let starDesc = starFlavor[Math.floor(Math.random() * starFlavor.length)];
                        if (tileObject && tileObject.type === 'star' && tileObject.starType === 'Binary' && mystery_wayfinder_progress < 2 && (Math.abs(currentSectorX) + Math.abs(currentSectorY) >= MYSTERY_WAYFINDER_TARGET_SECTOR_VOLATILITY)) {
                            starDesc += "\n<span style='color:#FFD700;'>A faint, repeating energy signature emanates from this binary system... it seems artificial. It pulses with a resonance matching unstable warp energies.</span>";
                            mystery_wayfinder_progress = 2; isMysteryClue = true;
                        }
                        scanMessage += starDesc;
                        if (tileObject && tileObject.type === 'star') {
                             if (tileObject.richness > 0.75) scanMessage += "\n<span style='color:#FFFF99;'>High hydrogen concentrations detected! Ideal for scooping.</span>";
                             else if (tileObject.richness > 0.4) scanMessage += "\n<span style='color:#FFFFE0;'>Moderate hydrogen concentrations. Scooping viable.</span>";
                             else scanMessage += "\n<span style='color:#FFFACD;'>Low hydrogen concentrations. Scooping may be inefficient.</span>";
                             if (tileObject.scoopedThisVisit) {
                                scanMessage += "\n<span style='color:#999999;'>Corona appears depleted from recent scooping this visit.</span>";
                             }
                        }
                        actionsAvailable += "Scoop Fuel (H).";
                        break;
                    case ASTEROID_CHAR_VAL: 
                        let asteroidMsg = "Asteroid field detected. ";
                        if (tileObject && tileObject.asteroidType) {
                            asteroidMsg += `Type: ${tileObject.asteroidType}. `;
                            if (tileObject.resources && tileObject.resources.length > 0) {
                                const primaryResource = COMMODITIES[tileObject.resources[0].id].name;
                                asteroidMsg += `Primary resource signature: ${primaryResource}. `;
                                if (tileObject.resources.length > 1 && (COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus || 0) > 0.01) { 
                                     asteroidMsg += `Faint traces of other materials.`;
                                }
                            } else {
                                asteroidMsg += "Appears mostly barren.";
                            }
                        } else {
                            asteroidMsg += "Composition unknown.";
                        }
                        if (tileObject && tileObject.minedThisVisit) {
                            scanMessage += "\n<span style='color:#999999;'>This field appears recently mined.</span>";
                        }
                        scanMessage += asteroidMsg;
                        actionsAvailable += "Mine Asteroid (M).";
                        break;
                    case NEBULA_CHAR_VAL: /* Same as v0.6.11 */ const nF=["Vibrant emission nebula...","Dark nebula...","Planetary nebula...","Reflection nebula...","Calm gaseous expanse...","Stellar nursery...","Bok globule...","Void Crystal concentration...","Forbidden nebula...","Singing nebula?...","Sentient Mycelium filaments..."];scanMessage+=nF[Math.floor(Math.random()*nF.length)];break;
                    case DERELICT_CHAR_VAL: /* Same as v0.6.11, with mystery check */ let dM="Scanners detect a derelict ship. ";if(tileObject&&tileObject.type==='derelict'&&tileObject.subtype){dM+=`Appears to be a ${tileObject.subtype}. `;objectTypeForXP=`derelict_${tileObject.subtype.replace(/\s+/g,'_').toLowerCase()}`;if(mystery_wayfinder_progress===3&&tileObject.subtype===MYSTERY_WAYFINDER_DERELICT_HINT_TYPE&&currentSectorX>=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MIN&&currentSectorX<=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_X_MAX&&currentSectorY>=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MIN&&currentSectorY<=MYSTERY_WAYFINDER_DERELICT_SECTOR_QUADRANT_Y_MAX){const fSX=Math.floor(Math.random()*10)+10*(Math.random()<0.5?1:-1);const fSY=Math.floor(Math.random()*10)+10*(Math.random()<0.5?1:-1);const fX=Math.floor(Math.random()*MAP_WIDTH);const fY=Math.floor(Math.random()*MAP_HEIGHT);mystery_wayfinder_finalLocation={sectorX:fSX,sectorY:fSY,x:fX,y:fY};dM+=`\n<span style='color:#FFD700;'>The ship's damaged logs contain a startling discovery! A Precursor Wayfinder signal has been pinpointed to Sector (${fSX},${fSY}), coordinates [${fX},${fY}].</span>`;mystery_wayfinder_progress=4;isMysteryClue=true;}else{switch(tileObject.subtype){/* detailed descriptions */ case 'freighter': dM += "Hull breaches... K'tharr Spices scent."; break; case 'explorer': dM += "Shattered sensors... Silentium Expanse charts."; break; default: dM += "Origin unknown."; break;}}}else{dM+="Its origin and purpose are unknown.";}if(Math.random() < (0.20 + (COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus || 0)) && !isMysteryClue){/* loot logic */}scanMessage+=dM;break;
                    case ANOMALY_CHAR_VAL: /* Same as v0.6.11, with mystery check */ let anoM="Unusual energy readings detected. This is an anomaly. ";if(tileObject&&tileObject.type==='anomaly'&&tileObject.subtype){anoM+=`Identified as a ${tileObject.subtype}. `;objectTypeForXP=`anomaly_${tileObject.subtype.replace(/\s+/g,'_').toLowerCase()}`;if(mystery_wayfinder_progress===2&&tileObject.subtype===MYSTERY_WAYFINDER_ANOMALY_HINT_TYPE){anoM+=`\n<span style='color:#FFD700;'>The anomaly resonates with the Precursor signal! A fragmented data packet is recovered: 'Seek the lost explorer... Concord designation 'Pathfinder' (${MYSTERY_WAYFINDER_DERELICT_HINT_TYPE})... last seen in the negative X, positive Y quadrant sectors... carrying vital charts.'</span>`;mystery_wayfinder_progress=3;isMysteryClue=true;}else{switch(tileObject.subtype){/* detailed descriptions */ case 'gravimetric wave': anoM += "Space ripples... temporal displacement."; break; case 'temporal distortion': anoM += "Chroniton interference... time flows erratically."; break; default: anoM += "Nature beyond current sensors."; break;}}}else{anoM+="Its nature is beyond current sensor capabilities. Approach with extreme caution.";}if(Math.random() < (0.05 + (COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus || 0)) &&!isMysteryClue){/* unique signature log */}else if(Math.random()<(0.03+(COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus||0))&&playerCargo.VOID_CRYSTALS<PLAYER_CARGO_CAPACITY-currentCargoLoad&&!isMysteryClue){/* void crystal */}else if(Math.random()<(0.01+(COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus||0))&&playerCargo.PRECURSOR_DATACUBE<PLAYER_CARGO_CAPACITY-currentCargoLoad&&!isMysteryClue){/* datacube */}else if(Math.random()<(0.02+(COMPONENTS_DATABASE[playerShip.scanner].stats.scanBonus||0))&&playerCargo.PHASE_SHIFTED_ALLOY<PLAYER_CARGO_CAPACITY-currentCargoLoad&&!isMysteryClue){/* phase alloy */}scanMessage+=anoM;break;
                    case WORMHOLE_CHAR_VAL: 
                        let wMsg="Detected an unstable Wormhole! ";
                        if (tileObject && tileObject.type === 'wormhole' && typeof tileObject.stability === 'number') {
                            if (tileObject.stability > 0.7) wMsg += "Appears relatively stable...";
                            else if (tileObject.stability > 0.3) wMsg += "Fluctuating energy readings...";
                            else wMsg += "Highly unstable! Enter at extreme peril!";
                        }
                        scanMessage += wMsg;
                        actionsAvailable += "Traverse Wormhole (T).";
                        objectTypeForXP = 'wormhole';
                        break;
                    default: scanMessage += "Unknown anomaly detected. Sensor readings inconclusive."; break;
                }
            }

            if (actionsAvailable) {
                scanMessage += "\nAvailable Actions: " + actionsAvailable;
            }

            if (objectTypeForXP && !scannedObjectTypes.has(objectTypeForXP) && !isMysteryClue) { 
                scannedObjectTypes.add(objectTypeForXP);
                playerXP += XP_PER_FIRST_SCAN_TYPE;
                scanMessage += `\n<span style='color:#00FF00;'>New Discovery Type Scanned! +${XP_PER_FIRST_SCAN_TYPE} XP!</span>`;
                unlockLoreEntry(`PHENOMENON_${objectTypeForXP.toUpperCase()}`); 
                if (tileObject && tileObject.subtype) {
                    unlockLoreEntry(`${getTileType(tileObject).toUpperCase()}_${tileObject.subtype.replace(/\s+/g, '_').toUpperCase()}`); 
                }
                checkLevelUp();
            }
            if (isMysteryClue) { 
                 updateMessage(scanMessage); 
            } else {
                 updateMessage(scanMessage);
            }
            renderGame();
        }

        function scoopHydrogen() { 
            if(currentTradeContext||currentCombatContext||currentOutfitContext){updateMessage("Cannot scoop fuel now.");renderGame();return;}
            const cT=gameMapGrid[playerY][playerX];
            if(getTileType(cT)!=='star'){updateMessage("No star here to scoop from.");renderGame();return;}
            if(playerFuel>=MAX_FUEL){updateMessage("Fuel tanks full!");renderGame();return;}
            
            if (cT.scoopedThisVisit) {
                updateMessage("This star's corona has been depleted for this visit.");
                renderGame();
                return;
            }

            const sR=(typeof cT.richness==='number')?cT.richness:0.3;
            let fG=MIN_SCOOP_YIELD+Math.floor(sR*MAX_SCOOP_YIELD_RICHNESS_MULTIPLIER);
            fG+=Math.floor(Math.random()*SCOOP_RANDOM_BONUS);
            fG=Math.max(1,fG);
            const oF=playerFuel;
            playerFuel=Math.min(MAX_FUEL,playerFuel+fG);
            const aG=playerFuel-oF;

            if(aG>0) {
                updateMessage(`Scooped ${aG} units of hydrogen.\nFuel: ${playerFuel}/${MAX_FUEL}`);
                cT.scoopedThisVisit = true; 
            } else {
                 updateMessage("Scooping yielded no fuel. Tanks full or star already depleted this visit.");
            }
            renderGame();
        }
        function calculatePrice(bP,pM){return Math.round(bP*pM);}
        function displayTradeScreen(mode){ 
            const l=getCombinedLocationData(playerY,playerX);
            if(!l||!((mode==='buy'&&l.sells&&l.sells.length>0)||(mode==='sell'&&l.buys&&l.buys.length>0))){updateMessage(`No items to ${mode} here.`);currentTradeContext=null;renderGame();return;}
            currentTradeContext={locationName:l.name,mode:mode,step:'selectItem',locationData:l};
            let tM=`--- ${mode.toUpperCase()} AT ${l.name.toUpperCase()} --- (Cr: ${playerCredits})\nCargo: ${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}\n`;
            const items=mode==='buy'?l.sells:l.buys;
            if(items.length===0)tM+=`Nothing available to ${mode}.\n`;
            else items.forEach((item,idx)=>{
                const com=COMMODITIES[item.id];
                unlockLoreEntry(`COMMODITY_${item.id}`); 
                const pr=calculatePrice(com.basePrice,item.priceMod);
                const st=mode==='buy'?`Stock: ${item.stock}`:`Demand: ${item.stock}`;
                const pH=mode==='sell'?`You have: ${playerCargo[item.id]||0}`:'';
                tM+=`${idx+1}. ${com.name} (${pr}c) [${st}] ${pH}\n`;
            });
            tM+="\nEnter # to select, or 'L' to leave.";updateMessage(tM);renderGame();
        }
        function handleTradeSelection(input){ 
            if(!currentTradeContext||currentTradeContext.step!=='selectItem')return;
            const lD = currentTradeContext.locationData; 
            const items=currentTradeContext.mode==='buy'?lD.sells:lD.buys;const sel=parseInt(input);
            if(isNaN(sel)||sel<1||sel>items.length){updateMessage("Invalid selection. # or 'L'.");renderGame();return;}
            currentTradeContext.itemIndex=sel-1;currentTradeContext.step='selectQuantity';
            const sIE=items[currentTradeContext.itemIndex];const com=COMMODITIES[sIE.id];const pr=calculatePrice(com.basePrice,sIE.priceMod);
            let pM=`How many ${com.name} to ${currentTradeContext.mode}? (Price: ${pr}c)\n`;
            if(currentTradeContext.mode==='buy'){pM+=`Max: ${sIE.stock}, Afford: ${Math.floor(playerCredits/pr)}, Space: ${PLAYER_CARGO_CAPACITY-currentCargoLoad}\n`;}
            else{pM+=`You have: ${playerCargo[sIE.id]||0}, Demand: ${sIE.stock}\n`;}
            pM+="Enter quantity (then Enter), or '0' to cancel item."; 
            currentQuantityInput = ""; 
            updateMessage(pM);renderGame();
        }
        function handleTradeQuantity(inputString){ 
            if(!currentTradeContext||currentTradeContext.step!=='selectQuantity')return;
            const qty=parseInt(inputString); 
            currentQuantityInput = ""; 

            if(isNaN(qty)||qty<0){updateMessage("Invalid qty. # or '0'.");displayTradeScreen(currentTradeContext.mode);renderGame();return;} 
            if(qty===0){displayTradeScreen(currentTradeContext.mode);return;}
            
            const lD = currentTradeContext.locationData; 
            const iL=currentTradeContext.mode==='buy'?lD.sells:lD.buys;const iE=iL[currentTradeContext.itemIndex];
            const cID=iE.id;const com=COMMODITIES[cID];const pr=calculatePrice(com.basePrice,iE.priceMod);let fM="";let xAGT=0;
            if(currentTradeContext.mode==='buy'){const tC=pr*qty;if(qty>iE.stock)fM="Not enough stock.";else if(tC>playerCredits)fM="Not enough credits.";else if(currentCargoLoad+qty>PLAYER_CARGO_CAPACITY)fM="No cargo space.";else{playerCredits-=tC;playerCargo[cID]=(playerCargo[cID]||0)+qty;iE.stock-=qty;updateCurrentCargoLoad();fM=`Bought ${qty} ${com.name} for ${tC}c.`;}}
            else{if(qty>(playerCargo[cID]||0))fM=`Not enough ${com.name} to sell.`;else if(qty>iE.stock)fM=`${lD.name} doesn't demand that many.`;else{const tG=pr*qty;playerCredits+=tG;playerCargo[cID]-=qty;iE.stock-=qty;updateCurrentCargoLoad();fM=`Sold ${qty} ${com.name} for ${tG}c.`;const pPU=pr-com.basePrice;if(pPU>0){xAGT=Math.floor(pPU*qty*XP_PER_PROFIT_UNIT);playerXP+=xAGT;updatePlayerNotoriety(Math.floor(tG / 100)); /* + Notoriety for profitable large sales */ fM+=`\n<span style='color:#00FF00;'>+${xAGT} XP for profitable trade!</span>`;checkLevelUp();}}}
            
            currentTradeContext = null; 
            updateMessage(fM, message.includes("LEVEL UP!")); 
            if(!message.includes("LEVEL UP!")) handleInteraction(); 
            renderGame();
        }
        function checkLevelUp() { /* Same as v0.6.8 */ if(playerXP>=xpToNextLevel){playerLevel++;playerXP-=xpToNextLevel;xpToNextLevel=calculateXpToNextLevel(playerLevel);updateMessage(`LEVEL UP! You are now Level ${playerLevel}!\nShields and Fuel fully restored!`,true);playerShields=MAX_SHIELDS;playerFuel=MAX_FUEL;}}
        function startCombat() { /* Same as v0.6.8 */ const pS=PIRATE_BASE_SHIELDS_MIN+Math.floor(Math.random()*(PIRATE_BASE_SHIELDS_MAX-PIRATE_BASE_SHIELDS_MIN+1));currentCombatContext={pirateShields:pS,pirateMaxShields:pS};const tS=["Your cargo or your life, spacer!","Heh, fresh meat for the void!","This sector is ours! Pay the toll.","Look what the stardrive dragged in!","Prepare to be boarded, scum!","Another lamb to the slaughter!","Your ship looks like a fine prize!","Time to lighten your load, friend!","Don't make this harder than it has to be.","Another shiny target for my lasers!","Hope you've made your peace!","Your ship's paint job offends me! Prepare to die!","The Void Vultures are hungry!","Just hand over the valuables, and maybe you'll see tomorrow!","This is a shakedown! Don't try anything heroic."];const pT=tS[Math.floor(Math.random()*tS.length)];updateMessage(`"${pT}"\nHostile Pirate ${PIRATE_CHAR_VAL} encountered!\nPirate Shields: ${currentCombatContext.pirateShields}\nYour Shields: ${playerShields}\n(F)ight or (R)un?`);renderGame();}
        function handleCombatAction(action) { 
            if (!currentCombatContext) return; let cL = "";
            if (action === 'fight') {
                const weaponStats = COMPONENTS_DATABASE[playerShip.weapon].stats;
                let damageDealt = weaponStats.damage;
                
                if (Math.random() < weaponStats.hitChance) {
                    if (weaponStats.vsShieldBonus && currentCombatContext.pirateShields > 0) {
                        damageDealt += weaponStats.vsShieldBonus;
                    }
                    currentCombatContext.pirateShields -= damageDealt; 
                    cL += `Hit pirate for ${damageDealt}!`; 
                } else { cL += "Your attack missed!"; }

                cL += ` Pirate Sh: ${Math.max(0, currentCombatContext.pirateShields)}.\n`;
                if (currentCombatContext.pirateShields <= 0) { 
                    const cW = PIRATE_CREDIT_REWARD_MIN + Math.floor(Math.random()*(PIRATE_CREDIT_REWARD_MAX-PIRATE_CREDIT_REWARD_MIN+1)); 
                    const xG = XP_PER_PIRATE_MIN + Math.floor(Math.random() * (XP_PER_PIRATE_MAX - XP_PER_PIRATE_MIN + 1)); 
                    playerCredits+=cW; playerXP += xG; 
                    updatePlayerNotoriety(5); // +5 notoriety for defeating pirate
                    cL+=`Pirate defeated! Salvaged ${cW}c. Gained ${xG} XP.`; 
                    currentCombatContext=null; updateMessage(cL); checkLevelUp(); 
                    if(!message.includes("LEVEL UP!")){handleInteraction();} renderGame(); return; 
                }
                if (Math.random() < PIRATE_HIT_CHANCE) { const pD = PIRATE_ATTACK_DAMAGE_MIN + Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1)); playerShields-=pD; cL+=`Pirate hits for ${pD}!`; } else { cL+="Pirate attack missed!"; }
                cL += ` Your Sh: ${Math.max(0, playerShields)}.\n`;
                if (playerShields <= 0) { 
                    playerShields=0; cL+=`Ship critically damaged! Emergency warp to Starbase Alpha...`; 
                    let cLs=Math.floor(playerCredits*0.1);playerCredits=Math.max(0,playerCredits-cLs);cL+=`\nLost ${cLs}c.`; 
                    updatePlayerNotoriety(-10); // -10 notoriety for critical damage
                    playerShields=1; currentSectorX=0; currentSectorY=0; loadOrGenerateSectorMap(0,0); 
                    const sA=LOCATIONS_DATA["Starbase Alpha"].coords; playerX=sA.x;playerY=sA.y; 
                    currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return; 
                }
                cL += "(F)ight or (R)un?";
            } else if (action === 'run') { 
                if(playerFuel<RUN_FUEL_COST){
                    cL="Not enough fuel to run!\n";
                    if(Math.random()<PIRATE_HIT_CHANCE){const pD=PIRATE_ATTACK_DAMAGE_MIN+Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1));playerShields-=pD;cL+=`Pirate hits for ${pD}! Your Sh: ${Math.max(0,playerShields)}.\n`;if(playerShields<=0){cL="Ship critically damaged!"; updatePlayerNotoriety(-10); playerShields=1;currentSectorX=0;currentSectorY=0;generateSectorMap(0,0);const sA=LOCATIONS_DATA["Starbase Alpha"].coords;playerX=sA.x;playerY=sA.y;currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return;}}else{cL+="Pirate missed!\n";}cL+="(F)ight or (R)un?";
                } else {
                    playerFuel-=RUN_FUEL_COST;
                    if(Math.random()<RUN_ESCAPE_CHANCE){
                        cL=`Escaped! Used ${RUN_FUEL_COST} fuel.`;
                        updatePlayerNotoriety(-1); // -1 notoriety for running
                        currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return;
                    } else {
                        cL=`Failed to escape! Pirate attacks!\n`;
                        if(Math.random()<PIRATE_HIT_CHANCE){const pD=PIRATE_ATTACK_DAMAGE_MIN+Math.floor(Math.random()*(PIRATE_ATTACK_DAMAGE_MAX-PIRATE_ATTACK_DAMAGE_MIN+1));playerShields-=pD;cL+=`Pirate hits for ${pD}! Your Sh: ${Math.max(0,playerShields)}.\n`;if(playerShields<=0){cL="Ship critically damaged!"; updatePlayerNotoriety(-10); playerShields=1;currentSectorX=0;currentSectorY=0;generateSectorMap(0,0);const sA=LOCATIONS_DATA["Starbase Alpha"].coords;playerX=sA.x;playerY=sA.y;currentCombatContext=null;updateMessage(cL);handleInteraction();renderGame();return;}}else{cL+="Pirate attack missed!\n";}cL+="(F)ight or (R)un?";
                    }
                }
            }
            updateMessage(cL); renderGame();
        }
        
        // --- Outfitting Functions ---
        function displayOutfittingScreen() {
            currentOutfitContext = { step: 'selectSlot' };
            let outfitMsg = "--- Ship Outfitting ---\n";
            outfitMsg += "Current Loadout:\n";
            outfitMsg += ` 1. Weapon: ${COMPONENTS_DATABASE[playerShip.weapon].name}\n`;
            outfitMsg += ` 2. Shield: ${COMPONENTS_DATABASE[playerShip.shield].name}\n`;
            outfitMsg += ` 3. Engine: ${COMPONENTS_DATABASE[playerShip.engine].name}\n`;
            outfitMsg += ` 4. Scanner: ${COMPONENTS_DATABASE[playerShip.scanner].name}\n\n`;
            outfitMsg += "Select slot # to upgrade, or (L) to Leave.";
            updateMessage(outfitMsg);
            renderGame();
        }

        function displayComponentsForSlot(slotType) {
            currentOutfitContext.step = 'selectComponent';
            currentOutfitContext.selectedSlot = slotType;
            let componentMsg = `--- Upgrading ${slotType.toUpperCase()} ---\nAvailable components (Cr: ${playerCredits}):\n`;
            let componentIndex = 1;
            currentOutfitContext.availableComponents = [];

            for (const compId in COMPONENTS_DATABASE) {
                const comp = COMPONENTS_DATABASE[compId];
                if (comp.slot === slotType && playerShip[slotType] !== compId) { 
                    componentMsg += `${componentIndex}. ${comp.name} (${comp.cost}c) - ${comp.description}\n`;
                    componentMsg += `   Stats: `;
                    let statsStr = [];
                    for(const stat in comp.stats) {
                        statsStr.push(`${stat}: ${comp.stats[stat]}`);
                    }
                    componentMsg += statsStr.join(', ') + "\n";
                    currentOutfitContext.availableComponents.push(comp);
                    componentIndex++;
                }
            }
            if (currentOutfitContext.availableComponents.length === 0) {
                componentMsg += "No other upgrades currently available for this slot.\n";
            }
            componentMsg += "\nEnter # to purchase, or 'L' to go back.";
            updateMessage(componentMsg);
            renderGame();
        }

        function buyComponent(componentId) {
            const component = COMPONENTS_DATABASE[componentId];
            if (!component) {
                updateMessage("Invalid component selection.");
                displayComponentsForSlot(currentOutfitContext.selectedSlot); 
                return;
            }

            if (playerCredits < component.cost) {
                updateMessage("Not enough credits to purchase " + component.name + ".", true);
                displayComponentsForSlot(currentOutfitContext.selectedSlot);
                return;
            }

            const oldComponent = COMPONENTS_DATABASE[playerShip[component.slot]];
            playerCredits -= component.cost;
            playerShip[component.slot] = componentId;
            applyPlayerShipStats(); 
            unlockLoreEntry(component.loreKey);

            updateMessage(`Installed ${component.name}. Old ${oldComponent.name} unequipped.\nCredits: ${playerCredits}`); 
            currentOutfitContext = null; 
            handleInteraction(); 
            renderGame();
        }

        function displayCargoHold() {
            if (currentTradeContext || currentCombatContext || currentOutfitContext) {
                updateMessage("Cannot view cargo hold now.");
                renderGame();
                return;
            }
            let cargoMsg = "--- Cargo Hold ---\n";
            cargoMsg += `Capacity: ${currentCargoLoad}/${PLAYER_CARGO_CAPACITY}\n`;
            let hasCargo = false;
            for (const commID in playerCargo) {
                if (playerCargo[commID] > 0) {
                    cargoMsg += ` ${COMMODITIES[commID].name}: ${playerCargo[commID]}\n`;
                    hasCargo = true;
                }
            }
            if (!hasCargo) {
                cargoMsg += "Hold is empty.\n";
            }
            cargoMsg += "\nPress any key to close cargo view.";
            updateMessage(cargoMsg);
            currentOutfitContext = { step: 'viewingCargo' }; 
            renderGame();
        }


        // --- Codex Functions ---
        let currentCodexCategory = null;
        function toggleCodex(show) { /* Same as v0.6.11 */ if(show){codexOverlayElement.style.display='flex';renderCodexCategories();renderCodexEntries(null);codexEntryTextElement.innerHTML="Select a category, then an entry.";}else{codexOverlayElement.style.display='none';currentCodexCategory=null;}}
        function renderCodexCategories() { /* Same as v0.6.11 */ codexCategoriesElement.innerHTML='';const cats=new Set();Object.values(LORE_DATABASE).forEach(e=>{if(discoveredLoreEntries.has(Object.keys(LORE_DATABASE).find(k=>LORE_DATABASE[k]===e)))cats.add(e.category);});Array.from(cats).sort().forEach(cat=>{const cD=document.createElement('div');cD.textContent=cat;cD.className='codex-list-item';if(cat===currentCodexCategory)cD.classList.add('active');cD.onclick=()=>{currentCodexCategory=cat;renderCodexCategories();renderCodexEntries(cat);codexEntryTextElement.innerHTML="Select an entry.";};codexCategoriesElement.appendChild(cD);});}
        function renderCodexEntries(category) { /* Same as v0.6.11 */ codexEntriesElement.innerHTML='';if(!category)return;Object.entries(LORE_DATABASE).forEach(([k,e])=>{if(e.category===category&&discoveredLoreEntries.has(k)){const eD=document.createElement('div');eD.textContent=e.title;eD.className='codex-list-item';eD.onclick=()=>{codexEntryTextElement.innerHTML=`<strong>${e.title}</strong><hr style="margin:5px 0;border-color:#4a4a6a;"><p>${e.text.replace(/\n/g,'<br>')}</p>`;document.querySelectorAll('#codexEntries .codex-list-item').forEach(el=>el.classList.remove('active'));eD.classList.add('active');};codexEntriesElement.appendChild(eD);}});}


        document.addEventListener('keydown', function(event) {
            const key = event.key.toLowerCase();
            if (codexOverlayElement.style.display === 'flex') { 
                if (key === 'escape' || key === 'j') { toggleCodex(false); }
                event.preventDefault(); return;
            }
            if (currentOutfitContext && currentOutfitContext.step === 'viewingCargo') { 
                currentOutfitContext = null; 
                handleInteraction(); 
                renderGame();
                event.preventDefault();
                return;
            }

            if (currentOutfitContext) { 
                if (currentOutfitContext.step === 'selectSlot') {
                    if (key === '1') displayComponentsForSlot('weapon');
                    else if (key === '2') displayComponentsForSlot('shield');
                    else if (key === '3') displayComponentsForSlot('engine');
                    else if (key === '4') displayComponentsForSlot('scanner');
                    else if (key === 'l') { currentOutfitContext = null; handleInteraction(); renderGame(); }
                } else if (currentOutfitContext.step === 'selectComponent') {
                    const selection = parseInt(key);
                    if (!isNaN(selection) && selection > 0 && selection <= currentOutfitContext.availableComponents.length) {
                        buyComponent(currentOutfitContext.availableComponents[selection - 1].id);
                    } else if (key === 'l') {
                        displayOutfittingScreen(); 
                    }
                }
                event.preventDefault(); return;
            }
            
            if (currentTradeContext) { /* Same as v0.6.11 */ if (currentTradeContext.step === 'selectQuantity') { if (!isNaN(parseInt(key)) && key.length === 1 && currentQuantityInput.length < 3) { currentQuantityInput += key; const lD = currentTradeContext.locationData; const itemsList = currentTradeContext.mode === 'buy' ? lD.sells : lD.buys; const itemEntry = itemsList[currentTradeContext.itemIndex]; const commodity = COMMODITIES[itemEntry.id]; const price = calculatePrice(commodity.basePrice, itemEntry.priceMod); let promptMsg = `How many ${commodity.name} to ${currentTradeContext.mode}? (Price: ${price}c)\n`; if (currentTradeContext.mode === 'buy') { promptMsg += `Max: ${itemEntry.stock}, Afford: ${Math.floor(playerCredits / price)}, Space: ${PLAYER_CARGO_CAPACITY - currentCargoLoad}\n`; } else {  promptMsg += `You have: ${playerCargo[itemEntry.id]||0}, Location demand: ${itemEntry.stock}\n`; } promptMsg += `Enter quantity (max 3 digits), then Enter. Current: ${currentQuantityInput} (Backspace to correct, 0 to cancel item)`; updateMessage(promptMsg); renderGame(); } else if (key === 'backspace' && currentQuantityInput.length > 0) { currentQuantityInput = currentQuantityInput.slice(0, -1); const lD = currentTradeContext.locationData; const itemsList = currentTradeContext.mode === 'buy' ? lD.sells : lD.buys; const itemEntry = itemsList[currentTradeContext.itemIndex]; const commodity = COMMODITIES[itemEntry.id]; const price = calculatePrice(commodity.basePrice, itemEntry.priceMod); let promptMsg = `How many ${commodity.name} to ${currentTradeContext.mode}? (Price: ${price}c)\n`; if (currentTradeContext.mode === 'buy') { promptMsg += `Max: ${itemEntry.stock}, Afford: ${Math.floor(playerCredits / price)}, Space: ${PLAYER_CARGO_CAPACITY - currentCargoLoad}\n`; } else {  promptMsg += `You have: ${playerCargo[itemEntry.id]||0}, Location demand: ${itemEntry.stock}\n`; } promptMsg += `Enter quantity (max 3 digits), then Enter. Current: ${currentQuantityInput} (Backspace to correct, 0 to cancel item)`; updateMessage(promptMsg); renderGame(); } else if (key === 'enter') { handleTradeQuantity(currentQuantityInput || "0"); } else if (key === 'l') { currentTradeContext = null; currentQuantityInput = ""; handleInteraction(); renderGame(); } } else if (currentTradeContext.step === 'selectItem') { if (!isNaN(parseInt(key))) handleTradeSelection(key); else if (key === 'l') {currentTradeContext = null; currentQuantityInput = ""; handleInteraction(); renderGame();} } event.preventDefault();return;  }
            if (currentCombatContext) { if (key === 'f') handleCombatAction('fight'); else if (key === 'r') handleCombatAction('run'); event.preventDefault(); return; }
            
            let dx=0,dy=0; 
            switch(key){
                case 'w':case 'arrowup':dy=-1;break; case 's':case 'arrowdown':dy=1;break;
                case 'a':case 'arrowleft':dx=-1;break; case 'd':case 'arrowright':dx=1;break;
                case 'e':scanLocation();break; case 'h': scoopHydrogen(); break; 
                case 'j': toggleCodex(true); break; 
                case 'i': displayCargoHold(); break; 
                case 't': const cT=gameMapGrid[playerY][playerX];if(getTileType(cT)==='wormhole')traverseWormhole();else updateMessage("No wormhole here.");break;
                case 'b':const lB=getCombinedLocationData(playerY,playerX);if(lB&&((lB.sells&&lB.sells.length>0)||(lB.buys&&lB.buys.length>0)))displayTradeScreen('buy');else updateMessage("Cannot trade here.");break;
                case 's':const lS=getCombinedLocationData(playerY,playerX);if(lS&&((lS.sells&&lS.sells.length>0)||(lS.buys&&lS.buys.length>0)))displayTradeScreen('sell');else updateMessage("Cannot trade here.");break;
                case 'o': const locOutfit = getCombinedLocationData(playerY, playerX); if (locOutfit && locOutfit.isMajorHub) { displayOutfittingScreen(); } else { updateMessage("Ship outfitting not available here."); } break;
                case 'l':
                    if(currentOutfitContext) { currentOutfitContext = null; handleInteraction(); renderGame(); }
                    else if(currentTradeContext) { currentTradeContext = null; currentQuantityInput = ""; handleInteraction(); renderGame(); }
                    else { handleInteraction(); } 
                    break; 
                default:return; 
            }
            if(dx!==0||dy!==0)movePlayer(dx,dy); else renderGame(); 
            event.preventDefault();
        });
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
