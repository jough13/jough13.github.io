<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realms of Rune & Rust</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c1a2b; 
            color: #f0e8f0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .game-container {
            font-family: 'VT323', monospace;
            background-color: #1a0f1a;
            color: #cc99cc;
            border: 2px solid #800080;
            box-shadow: 0 0 15px #800080, inset 0 0 10px #80008033;
            padding: 1rem;
            width: 90vw;
            max-width: 850px; 
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .game-screen {
            white-space: pre;
            overflow: hidden;
            border: 1px dashed #660066;
            padding: 0.5rem;
            height: 120px; 
            line-height: 1.2; 
            font-size: 16px; 
            border-radius: 4px;
            background-color: #100510;
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .game-screen-content { 
            width: 100%;
            text-align: left; 
        }
        .player-char { 
            color: #ffff00; /* Bright Yellow */
        }
        .water-tile {
            color: #6495ed; /* CornflowerBlue */
        }
        .bridge-tile {
            color: #8b4513; /* SaddleBrown */
        }
        .mountain-tile {
            color: #a9a9a9; /* DarkGray */
        }
        .forest-tile {
            color: #228b22; /* ForestGreen */
        }
        .dark-feature-tile {
            color: #363636; /* Very Dark Grey */
        }
        .cloud-tile {
            color: #f0f8ff; /* AliceBlue - for clouds */
        }
        .ruin-tile { 
            color: #deb887; /* BurlyWood - for aged stone */
        }
        .windchime-tile { 
             color: #ffd700; /* Gold */
        }
         .guardian-tile { 
            color: #b0e0e6; /* PowderBlue - for constructs */
        }
        .oracle-dais-tile {
            color: #483d8b; /* DarkSlateBlue - for Oracle's Dais */
        }
        .enemy-tile {
            color: #ff4136; /* Red for enemies */
            font-weight: bold;
        }
        .blocked-path-tile { color: #708090; } 
        .runic-etching-tile { color: #afeeee; } 
        .whispering-totem-tile { color: #dda0dd; } 
        .whispering-echo-tile { color: #e0ffff; } 
        .chest-tile { color: #daa520; } 
        .weaver-tile { color: #ba55d3; } 
        .sword-stone-tile { color: #c0c0c0; font-weight: bold; } /* Silver */
        .dying-creature-tile { color: #cd853f; } /* Peruvian Brown */


        .stats-bar, .log-area, .controls-area, .decision-area, .message-input-area, .summary-area {
            border: 1px dashed #660066;
            padding: 0.5rem;
            font-size: 16px;
            border-radius: 4px;
            background-color: #201020;
        }
        .log-area {
            height: 200px; 
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .log-area p {
            margin: 0 0 0.25rem 0;
            font-size: 14px;
        }
        .log-area p.lore-message, .log-area p.startup-message, .log-area p.narrative-snippet { 
            color: #ffdead; 
            font-style: italic;
            border-left: 2px solid #ff8c00; 
            padding-left: 0.5em;
        }
        .log-area p.world-lore-message { 
            color: #f5deb3; 
            font-style: italic;
            border-left: 2px solid #daa520; 
            padding-left: 0.5em;
        }
        .log-area p.synergy-message, .log-area p.puzzle-success-message { 
            color: #da70d6; 
            font-style: italic;
            font-weight: bold;
            border-left: 2px solid #ba55d3; 
            padding-left: 0.5em;
        }
        .log-area p.puzzle-fail-message { 
             color: #f08080; 
             font-style: italic;
        }
        .log-area p.artifact-synergy-message { 
            color: #9932cc; 
            font-style: italic;
            font-weight: bold;
            border-left: 2px solid #8a2be2; 
            padding-left: 0.5em;
            margin-top: 0.3em;
            margin-bottom: 0.3em;
        }
        .log-area p.artifact-message {
            color: #e6e6fa; 
            font-style: italic;
            border-left: 2px solid #9370db; 
            padding-left: 0.5em;
            margin-bottom: 0.4em;
        }
        .log-area p.artifact-message strong {
            color: #dda0dd; 
            font-weight: bold;
        }
        .log-area p.npc-message {
            color: #afeeee; 
            border-left: 2px solid #48d1cc; 
            padding-left: 0.5em;
            margin-bottom: 0.3em; 
        }
        .log-area p.quest-message { 
            color: #ffb6c1; 
            font-style: italic;
            border-left: 2px solid #ff69b4; 
            padding-left: 0.5em;
        }
        .log-area p.combat-message { 
            color: #ff69b4; 
            font-style: italic;
        }
         .log-area p.combat-victory {
            color: #32cd32; 
            font-weight: bold;
        }
        .log-area p.combat-defeat {
            color: #dc143c; 
            font-weight: bold;
        }
        .log-area p.decision-outcome { 
            color: #dda0dd; 
            font-weight: bold;
        }
        .log-area p.future-self-message {
            color: #add8e6; 
            font-style: italic;
            border: 1px dashed #87cefa;
            padding: 0.3em;
            margin-bottom: 0.5em;
        }
        .log-area p.companion-message {
            color: #98fb98; 
            font-weight: bold;
            border-left: 2px solid #32cd32; 
            padding-left: 0.5em;
        }
        .log-area p.grave-message {
            color: #b0c4de; 
            font-style: italic;
        }
        .log-area p.seed-message { 
            color: #7fffd4; 
            font-size: 12px;
        }
        .log-area p.xp-message { 
            color: #fafad2; 
        }
        .log-area p.level-up-message { 
            color: #ffeb3b; 
            font-weight: bold;
            border: 1px solid #ffc107;
            padding: 0.2em;
        }
        .log-area p.legacy-message { 
            color: #c0c0c0; 
            font-style: italic;
            border-left: 2px solid #a9a9a9; 
            padding-left: 0.5em;
        }
        .log-area p.class-choice-message, .log-area p.name-choice-message { 
            color: #90ee90; 
            font-weight: bold;
            border-left: 2px solid #3cb371; 
            padding-left: 0.5em;
        }
        .controls-area button, .decision-area button, .message-input-area button, .summary-area button { 
            background-color: #7a2a7a;
            color: #f0d0f0;
            border: 1px solid #aa44aa;
            padding: 0.25rem 0.75rem;
            margin: 0.2rem;
            border-radius: 4px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .controls-area button:hover, .decision-area button:hover, .message-input-area button:hover, .summary-area button:hover { 
            background-color: #993399;
            box-shadow: 0 0 8px #cc66cc;
        }
        .controls-area button:disabled, .decision-area button:disabled, .message-input-area button:disabled, .summary-area button:disabled { 
            background-color: #554455;
            color: #887788;
            cursor: not-allowed;
            border-color: #776677;
        }
        .title-header {
            font-family: 'VT323', monospace;
            font-size: 2.5rem;
            color: #ff6600;
            text-shadow: 0 0 5px #cc3300, 0 0 10px #cc3300;
            margin-bottom: 1rem;
            text-align: center;
        }
        .resource-icon {
            display: inline-block;
            width: 1em;
            text-align: center;
        }
        .decision-area, .message-input-area, .summary-area { 
            display: none; 
            text-align: center;
        }
        .decision-area p, .message-input-area p, .summary-area p { 
            margin-bottom: 0.5rem;
        }
        .message-input-area textarea, .summary-area textarea { 
            width: 90%;
            height: 100px; 
            background-color: #100510;
            color: #f0e8f0;
            border: 1px solid #660066;
            border-radius: 4px;
            padding: 0.3em;
            font-family: 'VT323', monospace;
            margin-bottom: 0.5rem;
            white-space: pre-wrap; 
        }
        #playerNameInput { 
            background-color: #100510;
            color: #f0e8f0;
            border: 1px solid #660066;
            padding: 0.25rem;
            margin-bottom: 0.5rem;
            font-family: 'VT323', monospace;
            width: 70%;
        }
    </style>
</head>
<body>
    <h1 class="title-header">Realms of Rune & Rust</h1>

    <div class="game-container">
        <div id="stats-bar" class="stats-bar">
            Name: <span id="player-name-display">Wanderer</span> | Zone: <span id="zone-name">Loading...</span> | Explored: <span id="explored-percentage">0</span>%
            <br>
            HP: <span id="player-hp">0</span>/<span id="player-max-hp">0</span> | Level: <span id="player-level">1</span> | XP: <span id="player-xp">0</span>/<span id="xp-to-next-level">100</span>
            <br>
            Class: <span id="player-class">None</span> | Stats: MGT <span id="stat-might">0</span> | WIT <span id="stat-wits">0</span> | SPR <span id="stat-spirit">0</span>
            <br>
            Resources: <span class="resource-icon">.</span> <span id="glimmering-dust">0</span> | <span class="resource-icon">#</span> <span id="ancient-scraps">0</span>
            | <span id="void-essence-display" style="display:none;">VE: <span id="void-essence">0</span> | </span>Runes: <span id="runes-collected">None</span>
            <br>
            <span id="companion-display" style="display:none;">Companion: <span id="companion-info"></span></span>
            | Artifacts: <span id="artifacts-collected">0/0</span> | Speed: <span id="exploration-speed">1</span>x
        </div>

        <div id="game-screen" class="game-screen">
            <div id="game-screen-content"></div> 
        </div>

        <div id="log-area" class="log-area"></div>
        
        <div id="decision-area" class="decision-area">
            <p id="decision-prompt-text">A choice awaits...</p>
            <div id="decision-buttons-container"></div>
        </div>

        <div id="message-input-area" class="message-input-area">
            <p>Leave a message for your future self (optional):</p>
            <textarea id="future-self-textarea" maxlength="150"></textarea>
            <button id="save-message-button">Save Message & End Journey</button>
            <button id="skip-message-button">End Journey Without Message</button>
        </div>

        <div id="summary-area" class="summary-area"> 
            <p>Your journey's echoes. Copy this to remember your path:</p>
            <textarea id="journey-summary-textarea" readonly></textarea>
            <button id="new-journey-button">Begin a New Journey</button> 
            <button id="transcend-button" style="display:none;">Transcend & Begin Anew</button> 
        </div>

        <div id="controls-area" class="controls-area">
            <button id="pause-resume-button">Pause</button>
            <button id="upgrade-speed-button" disabled>Upgrade Speed (Cost: 50<span class="resource-icon">.</span>)</button>
            <button id="mute-button">Mute Sounds</button> 
        </div>
    </div>

    <script>
        // --- Game Configuration ---
        const SCREEN_WIDTH = 70; 
        const PLAYER_VISUAL_POSITION = Math.floor(SCREEN_WIDTH / 3); 
        const INITIAL_GAME_TICK_MS = 1000; 
        const FUTURE_SELF_MESSAGE_KEY = 'realmsOfRuneAndRust_FutureSelfMessage';
        const LEGACY_MIGHT_KEY = 'rrnr_legacy_might';
        const LEGACY_WITS_KEY = 'rrnr_legacy_wits';
        const LEGACY_SPIRIT_KEY = 'rrnr_legacy_spirit';
        const TRANSCEND_LEVEL_THRESHOLD = 3; 
        const NAME_CHOICE_EVENT_X_POS = 25; 
        const CLASS_CHOICE_EVENT_X_POS = 75; 
        const MAX_NAME_LENGTH = 20;


        const NUM_LANES = 5;
        const PLAYER_INITIAL_LANE = Math.floor(NUM_LANES / 2); 
        const VERTICAL_MOVE_CHANCE = 0.15; 
        const PLAYER_COLOR_STYLE = "color: #ffff00;"; 
        const WATER_COLOR_STYLE = "color: #6495ed;"; 
        const BRIDGE_COLOR_STYLE = "color: #8b4513;"; 
        const MOUNTAIN_COLOR_STYLE = "color: #a9a9a9;"; 
        const FOREST_COLOR_STYLE = "color: #228b22;"; 
        const DARK_FEATURE_COLOR_STYLE = "color: #363636;"; 
        const CLOUD_COLOR_STYLE = "color: #f0f8ff;";
        const RUIN_COLOR_STYLE = "color: #deb887;";
        const WINDCHIME_COLOR_STYLE = "color: #ffd700;";
        const GUARDIAN_COLOR_STYLE = "color: #b0e0e6;";
        const ORACLE_DAIS_COLOR_STYLE = "color: #7b68ee;"; 
        const ENEMY_COLOR_STYLE = "color: #ff4136; font-weight: bold;";
        const BLOCKED_PATH_COLOR_STYLE = "color: #708090;"; 
        const RUNIC_ETCHING_COLOR_STYLE = "color: #afeeee;"; 
        const WHISPERING_TOTEM_COLOR_STYLE = "color: #dda0dd;"; 
        const WHISPERING_ECHO_COLOR_STYLE = "color: #e0ffff;"; 
        const CHEST_TILE_STYLE = "color: #daa520;"; 
        const WEAVER_TILE_STYLE = "color: #ba55d3;"; 


        const COMPANION_FIND_CHANCE = 0.1; 
        const BASE_STAT_VALUE = 3; 
        const MIGHT_BONUS_DUST_CHANCE_PER_POINT = 0.05; 
        const WIT_INSIGHT_THRESHOLD = 4;
        const SPIRIT_COMPANION_THRESHOLD = 4;
        const SPIRIT_SHRINE_THRESHOLD = 4;
        const XP_FOR_LEVEL_2 = 100;
        const XP_LEVEL_SCALING_BASE = 50; 
        const SPONTANEOUS_VICTORY_CHANCE = 0.01; 
        const COMBAT_ESCAPE_DUST_LOSS = 10;
        const MIN_STEP_SOUND_INTERVAL = 0.2; 
        const BASE_HP = 20; 
        
        const MGT_BLOCKED_PATH_THRESHOLD = 5;
        const WIT_ETCHINGS_THRESHOLD = 5;
        const SPR_TOTEM_THRESHOLD = 5;


        // --- Seeded RNG (Mulberry32) ---
        let currentSeed;
        function initializeSeed(seed) { currentSeed = seed; }
        function seededRandom() {
            if (currentSeed === undefined) { currentSeed = Date.now() % 2147483647; }
            let t = currentSeed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            currentSeed = t; 
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        function seededRandomInt(min, max) { return Math.floor(seededRandom() * (max - min + 1)) + min; }

        const STARTUP_MESSAGES = [
            "The ancient echoes stir...", "A new path unfolds in the ruins...", "Whispers of forgotten ages call to you...",
            "The scent of adventure hangs heavy in the air...", "Destiny awaits, or perhaps, only dust...",
            "Another soul wanders these blighted lands...", "The Runes pulse with a faint, expectant energy..."
        ];

        // --- Sound Synthesizers (Tone.js) --- 
        let soundSynth, noiseSynth, metalSynth; 
        function initializeSounds() {
            if (typeof Tone !== 'undefined') {
                if (Tone.context.state !== 'running') {
                    Tone.start().catch(e => console.warn("Tone.start() could not be initiated automatically. Sounds may not play until user interaction.", e));
                }
                try {
                    soundSynth = new Tone.Synth({
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 },
                        volume: -20 
                    }).toDestination();

                    noiseSynth = new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.005, decay: 0.05, sustain: 0, release: 0.1 },
                        volume: -25
                    }).toDestination();

                    metalSynth = new Tone.MetalSynth({ 
                        frequency: 50,
                        envelope: { attack: 0.001, decay: 0.1, release: 0.1 },
                        harmonicity: 3.1,
                        modulationIndex: 16,
                        resonance: 2000,
                        octaves: 0.5,
                        volume: -22
                    }).toDestination();
                } catch (e) {
                    console.error("Error initializing Tone.js synthesizers:", e);
                    Tone = undefined; 
                }
            } else {
                console.warn("Tone.js not loaded. Sounds will be disabled.");
            }
        }
        
        function playSound(type, note = 'C4', duration = '16n') {
            if (gameState.isMuted || typeof Tone === 'undefined' || !soundSynth || !noiseSynth || !metalSynth) return;
            
            if (Tone.context.state !== 'running') {
                Tone.start().catch(e => { /* console.warn("Tone.start() failed in playSound.", e); */ }); 
                if (Tone.context.state !== 'running') return; 
            }

            const baseTime = Tone.now() + 0.005; 

            try {
                switch(type) {
                    case 'step':
                        if (baseTime - gameState.lastStepSoundTime >= MIN_STEP_SOUND_INTERVAL) {
                            noiseSynth.triggerAttackRelease(duration, baseTime, 0.3); 
                            gameState.lastStepSoundTime = baseTime;
                        }
                        break;
                    case 'dust':
                        soundSynth.triggerAttackRelease('C6', '32n', baseTime); 
                        break;
                    case 'scrap':
                        metalSynth.triggerAttackRelease('8n', baseTime, 0.2); 
                        break;
                    case 'rune':
                        soundSynth.triggerAttackRelease('G5', '8n', baseTime);
                        soundSynth.triggerAttackRelease('C6', '8n', baseTime + 0.1); 
                        break;
                    case 'artifact':
                        soundSynth.triggerAttackRelease('A5', '16n', baseTime);
                        soundSynth.triggerAttackRelease('E6', '16n', baseTime + 0.05); 
                        break;
                    case 'tome':
                         noiseSynth.triggerAttackRelease("4n", baseTime, 0.1); 
                        break;
                    case 'levelUp':
                        soundSynth.triggerAttackRelease('C4', '8n', baseTime);
                        soundSynth.triggerAttackRelease('E4', '8n', baseTime + 0.1);
                        soundSynth.triggerAttackRelease('G4', '8n', baseTime + 0.2);
                        soundSynth.triggerAttackRelease('C5', '4n', baseTime + 0.3);
                        break;
                    case 'companionFind':
                        soundSynth.triggerAttackRelease('B5', '16n', baseTime);
                        soundSynth.triggerAttackRelease('D6', '16n', baseTime + 0.07);
                        soundSynth.triggerAttackRelease('F#6', '16n', baseTime + 0.14);
                        break;
                    case 'combatHit':
                        metalSynth.triggerAttackRelease('16n', baseTime, 0.5);
                        break;
                    case 'combatMiss': 
                         noiseSynth.triggerAttackRelease("16n", baseTime, 0.4);
                        break;
                    case 'combatVictory':
                        soundSynth.triggerAttackRelease('G4', '8n', baseTime);
                        soundSynth.triggerAttackRelease('C5', '4n', baseTime + 0.1);
                        break;
                    case 'combatDefeat':
                        soundSynth.triggerAttackRelease('C3', '1n', baseTime); 
                        break;
                    default:
                        soundSynth.triggerAttackRelease(note, duration, baseTime);
                }
            } catch (e) {
                // console.error(`Error playing sound (${type}):`, e); 
            }
        }


        // --- Game State ---
        let gameState = {
            playerName: "Wanderer", 
            playerZoneX: 0, playerLane: PLAYER_INITIAL_LANE, currentZoneIndex: 0,
            explorationSpeedMultiplier: 1,
            resources: { glimmeringDust: 0, ancientScraps: 0, voidEssence: 0 },
            stats: { 
                might: BASE_STAT_VALUE,
                wits: BASE_STAT_VALUE,
                spirit: BASE_STAT_VALUE
            },
            level: 1, 
            xp: 0,
            xpToNextLevel: XP_FOR_LEVEL_2,
            maxHp: 0, 
            currentHp: 0, 
            playerClass: null, 
            runes: [], companion: null, collectedArtifacts: [], logMessages: [], 
            maxLogMessages: 35, isPaused: false, gameTickMs: INITIAL_GAME_TICK_MS,
            narrativeFlags: {}, activeDecision: null, encounteredNPCs: {},
            initialGameSeed: 0,
            inCombat: false,
            isMuted: false, 
            lastStepSoundTime: 0,
            lastExploredZoneIndex: 0 
        };

        // --- Lore & Content Definitions ---
        const ZONE_LORE = { 
            "ASHEN_WOODS_INTRO": "The Ashen Woods. Charred skeletons of trees claw at a sky perpetually choked with soot. The taste of ancient grief lingers in the air.",
            "ASHEN_SHRINE_1": "This soot-stained shrine feels strangely warm. Carvings depict a colossal, blazing tree – 'The First Spark' – its branches birthing stars, its roots anchoring reality. Then, a scene of it consumed by an even greater fire – 'The Great Ember.'",
            "CRIMSON_DEPTHS_INTRO": "The Crimson Depths. Bioluminescent crystals pulse with a slow, rhythmic light, casting eerie, dancing shadows. The silence is profound, broken only by the drip of mineral-rich water.",
            "CRIMSON_SHRINE_1": "Runes on this damp shrine flow like water. They speak of 'Earth-Songs,' the planet's resonant heartbeat, and 'Crystal Hearts,' vast geode networks that amplified these songs into a symphony of life.",
            "VOLCANIC_WASTES_INTRO": "The Volcanic Wastes. A hellscape of cracked obsidian plains and rivers of molten rock. The air shimmers with unbearable heat, and the ground trembles with the planet's fury.",
            "VOLCANIC_SHRINE_1": "Forged in volcanic glass, this shrine radiates intense heat. It tells of 'Sky-Fire,' a celestial forge, and 'Mountain Hearts' of adamant, shattered when the 'Void Star' screamed across the heavens and struck the world.",
            "STARFALL_CRATER_INTRO": "The Starfall Crater. An unnatural stillness hangs over this vast, glass-lined wound in the earth. Strange, impossible geometries jut from the crater floor, pulsing with a faint, sickly light.",
            "STARFALL_SHRINE_1": "This shrine is not of this world. Its material is cold, absorbing light. It speaks not of creation, but of un-creation, of the 'Silent Maw' that is the Void, and the 'Star-That-Devours' which was its herald.",
            "SUNKEN_ARCHIVES_INTRO": "The Sunken Archives. Waterlogged ruins of a Lumina repository sigh with the weight of lost knowledge. Ghostly lights flicker within submerged data-conduits.",
            "SUNKEN_ARCHIVES_SHRINE_1": "This coral-encrusted shrine depicts Lumina scholars cataloging stars and weaving light into complex data-matrices. It mourns the 'Great Unlearning' when their knowledge was drowned or shattered.",
            "SKY_TEMPLE_AERIE_INTRO": "The Sky-Temple Aerie. Wind howls through broken archways of a once-majestic Lumina temple, clinging to a mountain summit. Clouds drift like ghosts through its crumbling halls.",
            "SKY_TEMPLE_AERIE_SHRINE_1": "This shrine, carved from cloud-like alabaster, depicts Lumina with feathered wings, communing with celestial energies. It speaks of the 'Upper Weave' and the 'Breath of Stars' that powered their Sky-Citadels."
        };
        const SHRINE_SYNERGY_LORE = { 
            "ASHEN_SHRINE_1_SYNERGY": "The combined aura of your Runes (Φ+Δ) resonates deeply. The shrine's warmth intensifies, revealing a hidden compartment. Inside, ancient, untouched dust glimmers, and you feel a surge of protective energy.",
            "CRIMSON_SHRINE_1_SYNERGY": "With Perception and Resilience, you decipher a deeper layer of runes on the damp shrine. They speak of Crystal Guardians that sleep beneath the earth, awaiting a call only the pure-hearted can make.",
            "VOLCANIC_SHRINE_1_SYNERGY": "Your attuned Runes (Φ+Δ) allow you to withstand the shrine's heat longer. You glimpse a vision of the Runesmiths forging not just symbols, but anchors against the Void, their efforts ultimately overwhelmed but not entirely in vain.",
            "STARFALL_SHRINE_1_SYNERGY": "The alien shrine reacts to your Runes (Φ+Δ), a low hum emanating from its core. It shows you a fleeting image: the Void Star was not just a destroyer, but a seed. What it planted here remains a chilling mystery.",
            "SUNKEN_ARCHIVES_SHRINE_1_SYNERGY": "Your Runes (Φ+Δ) illuminate faded glyphs upon the coral. They tell of Lumina attempts to create 'Echo Chambers' – repositories of consciousness to survive The Fall. Perhaps some still function, lost in the deepest trenches.",
            "SKY_TEMPLE_AERIE_SHRINE_1_SYNERGY": "The Runes of Perception and Resilience (Φ+Δ) harmonize with the Aerie's winds. You hear a clear, ancient voice on the breeze: 'The First Song is fractured, but its notes linger. Seek those who remember its cadence.'"
        };
        const ARTIFACT_SYNERGY_LORE = { 
            "ORACLE_DAIS_LUMINA_LENS_SYNERGY": "Holding the Cracked Lumina Lens to the Oracle's Dais, the fractured images coalesce. You see a vision: Lumina Seers, their eyes wide with terror, witnessing the Void Star's approach. They speak of a 'Final Sanctuary,' hidden beyond the known realms, a place where a fragment of the First Song might yet be preserved..."
        };
        const STAT_CHALLENGE_LORE = { 
            "BLOCKED_PATH_SUCCESS": "With a surge of might, you clear the debris, revealing a small cache of resources!",
            "BLOCKED_PATH_FAIL": "The blockage is too formidable for your current strength.",
            "RUNIC_ETCHINGS_SUCCESS": "Your keen intellect deciphers the ancient etchings! They speak of [a short, unique seeded lore snippet about the zone's deeper history or a nearby secret - TBD].",
            "RUNIC_ETCHINGS_FAIL": "The runic markings are complex and weathered, their meaning lost to you.",
            "WHISPERING_TOTEM_SUCCESS": "Your spirit attunes to the totem's whispers. You feel a fleeting surge of insight and hear: 'The echoes remember...'",
            "WHISPERING_TOTEM_FAIL": "A faint murmur emanates from the totem, but its words are indistinct, like wind through dead leaves."
        };
        const NARRATIVE_SNIPPETS = [ 
            "A cold draft chills you to the bone, carrying the scent of ozone and despair.",
            "For a moment, you hear the faint sound of distant, mournful singing.",
            "The very stones beneath your feet seem to hum with a forgotten sorrow.",
            "A fleeting image flashes in your mind: a city of light, then darkness.",
            "The air grows heavy, thick with unspoken memories.",
            "You feel a prickling sensation, as if unseen eyes are watching you from the shadows.",
            "A whisper on the wind: '...lost... all lost...'",
            "The ground shudders almost imperceptibly, a deep sigh from the wounded earth.",
            "A single, perfect drop of water falls from an unseen height, its echo unnaturally loud.",
            "The silence here is older than the mountains, deeper than the void.",
            "Dust motes dance in a stray beam of light, like tiny, forgotten stars.",
            "You catch a whiff of something ancient and metallic, like a long-abandoned forge.",
            "The rustle of unseen things in the undergrowth... or is it just the wind?",
            "A strange sense of déjà vu washes over you, as if you've walked this path before, in another life.",
            "The air tastes of ash and regret here.",
            "A flicker of movement in the corner of your eye, but when you turn, nothing is there."
        ];

        const WORLD_LORE_FRAGMENTS = [ 
            { key: "WL_GOLDEN_AGE_1", text: "A shard of iridescent shell whispers of a time when the 'Singers of Light' wove reality from pure sound, their voices the breath of creation." },
            { key: "WL_GOLDEN_AGE_2", text: "On a metallic plate: '...the Sky-Citadels floated on currents of pure will, their inhabitants, the Lumina, drawing sustenance from starlight and dreams...'" },
            { key: "WL_GOLDEN_AGE_3", text: "A perfectly preserved flower, encased in amber, still hums with a faint, joyful energy. It speaks of a world where life and magic were one." },
            { key: "WL_GOLDEN_AGE_LUMINA_SOCIETY", text: "The Lumina, it's whispered, lived in harmonious 'Constellations' – city-states bound by shared purpose, each a unique note in the world's First Song." },
            { key: "WL_GOLDEN_AGE_SKY_TEMPLES", text: "Sky-Temples, like the Aerie, were said to be anchors for the Sky-Citadels, drawing energy from both the earth and the celestial sphere to maintain their impossible altitudes." },
            { key: "WL_GOLDEN_AGE_FIRST_SONG_POWER", text: "The First Song wasn't just heard, it was *felt*. It shaped the land, healed the sick, and allowed the Lumina to commune directly with the essence of reality." },
            { key: "WL_LUMINA_CULTURE_1", text: "Lumina society valued artistry and understanding above all. Their cities were living sculptures, their technology indistinguishable from magic." },
            { key: "WL_LUMINA_CULTURE_2", text: "Debate and philosophical inquiry were central to Lumina life. Great halls of learning, now lost, once echoed with profound discussions on the nature of existence." },
            { key: "WL_LUMINA_CULTURE_3", text: "Lumina children were taught to 'listen' to the world, to discern the subtle notes of the First Song in all things, from the rustle of leaves to the hum of a distant star." },
            { key: "WL_LUMINA_CULTURE_4", text: "Time, for the Lumina, was not a linear progression but a flowing tapestry. They could perceive echoes of the past and faint glimmers of potential futures." },
            { key: "WL_THE_FALL_1", text: "A scorched datapad flickers with a final, desperate message: 'The Song is broken! The Void Star… it DRINKS the light! The Lumina… they are screaming…'" },
            { key: "WL_THE_FALL_2", text: "Etched into a Runesmith's hammer: 'The Great Weave frays. The Anchors of Reality groan under the strain. The Old Night returns, and They come with it.'" },
            { key: "WL_THE_FALL_3", text: "A child's music box, warped and silent. When touched, a phantom melody of pure terror echoes in your mind." },
            { key: "WL_THE_FALL_4", text: "Fragment of a prophecy: '...and when the Star-That-Devours tastes the world, silence will claim the Song, and rust will claim the Runes...'" },
            { key: "WL_THE_FALL_5", text: "A Lumina's signet ring, cracked and cold. It feels heavy with the weight of a civilization's despair." },
            { key: "WL_THE_FALL_VOID_NATURE", text: "The Void is not mere emptiness, but an active, hungry anti-existence. The Star was its tooth, tearing a hole in the fabric of what is." },
            { key: "WL_THE_FALL_SKY_CITADELS_FALL", text: "When the Void Star struck, the Sky-Citadels, once beacons of light, rained down as fire and ruin. Few remnants survived, clinging to the highest peaks." },
            { key: "WL_THE_FALL_RUNESMITHS_FATE", text: "Many Runesmiths perished trying to reinforce the Weave against the Void Star's corruption. Their greatest creations became their tombs." },
            { key: "WL_THE_FALL_WEAVERS_LAMENT", text: "The Weavers, who spun the threads of reality, could only watch as their tapestries were rent by the Void. Their lament is still felt in places where the Weave is thin." },
            { key: "WL_THE_FALL_SILENCE", text: "The most terrifying aspect of The Fall was not the destruction, but the encroaching Silence – the absence of the First Song, a void where once there was cosmic harmony." },
            { key: "WL_SECRETS_1", text: "A geode, when cracked, reveals not crystals, but a miniature, swirling galaxy. It hums in tune with the Rune of Perception, hinting at unseen layers of reality." },
            { key: "WL_SECRETS_2", text: "A star-chart, etched on dragon scale, depicts constellations that no longer exist, all spiraling towards a central, black abyss – the Void Star's trajectory." },
            { key: "WL_SECRETS_RUNESMITHS", text: "The Runesmiths, it is said, didn't just craft the Runes. They sang them into existence, binding fragments of the First Song into tangible forms. Their greatest works are keys, not just tools." },
            { key: "WL_SECRETS_SLEEPERS", text: "Legends tell of 'Sleepers' – powerful beings or constructs from the Golden Age, hidden away, awaiting the 'True Note' of a mended Song to reawaken. Are they myth, or a forgotten promise?" },
            { key: "WL_SECRETS_WEAVERS", text: "Before the Runesmiths, there were the Weavers, who spun the raw energies of creation. The Runes are but echoes of their intricate tapestries." },
            { key: "WL_SECRETS_ARCHIVES_PURPOSE", text: "The Sunken Archives... they were meant to be a bulwark against forgetting, a final repository of the Lumina's understanding of the cosmos, should the First Song ever fade." },
            { key: "WL_SECRETS_FIRST_SONG_NATURE", text: "The First Song was not mere music, but the fundamental vibration of existence, the law that bound atoms and stars. Its fracturing led to The Fall." },
            { key: "WL_SECRETS_VOID_WHISPERS_TRUTH", text: "The whispers from the Void often speak in half-truths, preying on despair. Discernment is crucial, lest you become another lost echo." },
            { key: "WL_SECRETS_GUARDIAN_PROTOCOL", text: "The Echo-Guardians were programmed with a final directive: protect the 'Heart-Note' of their designated sacred site, even if all else turns to dust." },
            { key: "WL_SECRETS_RUNE_SYNERGY", text: "Some Runes, when brought together, resonate in unexpected ways, unlocking deeper truths or latent powers. The Runesmiths knew these combinations, but much of that knowledge is lost." },
            { key: "WL_HOPE_SAPLING", text: "In the deepest char of the Ashen Woods, a single, silver-barked sapling thrives, its leaves shimmering with an inner light. It is a defiant spark against the overwhelming dark." },
            { key: "WL_HOPE_RUNES_ECHO", text: "The Runes are more than power. They are memories, fragments of the world's soul. Gathered, they might form a new Song, a new beginning... or a final, terrible crescendo." },
            { key: "WL_HOPE_WHISPERS", text: "Faint whispers, carried on the solar winds, speak of other 'Shards' – worlds touched by the Void Star, some resisting, some fallen, some... waiting." },
            { key: "WL_HOPE_COMPANION", text: "The bond with a loyal companion... perhaps this, too, is a fragment of the First Song, a note of harmony in a discordant world." },
            { key: "WL_HOPE_MEMORY", text: "Even in ruin, memory endures. Each fragment of lore, each Rune, is a seed of what was, and what could be again." },
            { key: "WL_HOPE_SKY_TEMPLES_LEGACY", text: "The Sky-Temples, even in ruin, hold echoes of Lumina wisdom. Perhaps a way to mend the Weave, or at least understand its breaking, lies hidden within their aeries." },
            { key: "WL_HOPE_FINAL_SANCTUARY", text: "The 'Final Sanctuary' spoken of in visions... if it exists, it would require more than just Runes to find. It would need a heart attuned to the remnants of the First Song." },
            { key: "WL_HOPE_REBIRTH_CYCLE", text: "Some ancient texts hint that The Fall was not an end, but a violent transformation, part of a cosmic cycle of creation and unmaking. Could this rust and ruin be the prelude to a new dawn?" },
            { key: "WL_VOID_ECHOES", text: "The silence of the Starfall Crater is a lie. Listen closely, and you hear it: the faint, chilling laughter of something ancient and utterly alien, from beyond the veil of stars." },
            { key: "WL_GUARDIANS_LEGEND", text: "The Lumina, before their fall, were said to have created 'Echo-Guardians,' sentient constructs bound to protect the sacred sites and the deepest secrets of the First Song." }
        ];
        const COMPANIONS = [
            { type: "Fox", name: "Sparky", call: "yip" }, { type: "Raven", name: "Corvus", call: "caw" },
            { type: "Salamander", name: "Iggy", call: "hiss" }, { type: "Hound", name: "Loyal", call: "woof" },
            { type: "Sprite", name: "Glimmer", call: "chime" }, { type: "Stone Whelp", name: "Roki", call: "rumble" },
            { type: "Owl", name: "Hoot", call: "hoo" }, { type: "Shadow Pup", name: "Umbra", call: "whimper" }
        ];
        const COMPANION_ZONE_ENTRY_DIALOGUE = {
            "Fox": {
                "The Ashen Woods": "Sparky sniffs the air, a low whine escaping its throat. The scent of old fires makes it uneasy.",
                "The Crimson Depths": "Sparky's ears perk up, its eyes wide in the dim light, fascinated by the glowing crystals.",
                "The Volcanic Wastes": "Sparky pants heavily, seeking shade near your legs from the oppressive heat.",
                "The Starfall Crater": "Sparky flattens its ears, growling softly at the unnatural stillness of the crater.",
                "The Sunken Archives": "Sparky shakes its fur, clearly displeased by the dampness of the Archives.",
                "The Sky-Temple Aerie": "Sparky looks up with wide, curious eyes, as if trying to catch the whispers on the wind."
            },
            "Raven": {
                "The Ashen Woods": "Corvus ruffles its feathers, cawing softly as it surveys the desolation.",
                "The Crimson Depths": "Corvus tilts its head, its beady eyes reflecting the crystal light with keen interest.",
                "The Volcanic Wastes": "Corvus circles above briefly, then lands on your shoulder, wary of the molten rivers.",
                "The Starfall Crater": "Corvus lets out a single, sharp caw, its feathers bristling slightly at the alien atmosphere.",
                "The Sunken Archives": "Corvus preens its feathers meticulously, as if trying to ward off the damp and decay.",
                "The Sky-Temple Aerie": "Corvus soars in a tight circle above you, then lands, its gaze fixed on the distant, cloud-wreathed peaks."
            },
            "Salamander": {
                "The Ashen Woods": "Iggy seems to bask in the residual warmth of the ashen ground.",
                "The Crimson Depths": "Iggy flicks its tongue, tasting the mineral-laden air of the caves.",
                "The Volcanic Wastes": "Iggy looks quite at home amidst the heat and sulfurous fumes, its scales almost glowing.",
                "The Starfall Crater": "Iggy presses itself flat against a rock, wary of the strange energies.",
                "The Sunken Archives": "Iggy seems to enjoy the humidity, though it avoids the deeper pools.",
                "The Sky-Temple Aerie": "Iggy shivers slightly in the cool, high-altitude winds, seeking the warmth of your pack."
            },
             "Hound": {
                "The Ashen Woods": "Loyal tracks unseen scents through the ash, occasionally letting out a soft bark.",
                "The Crimson Depths": "Loyal's tail wags tentatively as it explores the echoing caverns.",
                "The Starfall Crater": "Loyal stays close, a low growl rumbling in its chest, its hackles slightly raised.",
                "The Sunken Archives": "Loyal whines softly, its ears drooping at the sight of so much decay.",
                "The Sky-Temple Aerie": "Loyal barks joyfully at the open sky, chasing after drifting cloud-wisps."
            },
            "Sprite": {
                "The Ashen Woods": "Glimmer flits nervously, its light dimming amidst the oppressive soot.",
                "The Crimson Depths": "Glimmer darts between crystals, its own light adding to the subterranean glow.",
                "The Volcanic Wastes": "Glimmer zips high above the heated ground, a tiny spark against the fiery backdrop.",
                "The Starfall Crater": "Glimmer's light flickers erratically, disturbed by the crater's alien aura.",
                "The Sunken Archives": "Glimmer hovers over ancient texts, as if trying to read them with its faint light.",
                "The Sky-Temple Aerie": "Glimmer dances on the wind currents, a joyful speck of light among the clouds."
            }
        };
        const COMPANION_NPC_REACTION_DIALOGUE = {
            "Fox": {
                "LOST_SOUL": "Sparky whimpers and presses close to your leg, sensing the Lost Soul's sorrow.",
                "ECHO_LUMINA": "Sparky tilts its head, its gaze fixed on the shimmering Echo of a Lumina.",
                "HERMIT_RUNESMITH": "Sparky lets out a soft growl, wary of the Hermit's gruffness.",
                "ARCHIVIST_CONSTRUCT": "Sparky sniffs curiously at the construct, then sneezes at a puff of dust.",
                "SKY_SEER_ECHO": "Sparky looks upwards, as if trying to see what the Sky-Seer perceives in the winds."
            },
            "Raven": {
                "LOST_SOUL": "Corvus watches the Lost Soul with an unblinking, ancient gaze.",
                "ECHO_LUMINA": "Corvus caws softly, as if trying to communicate with the ethereal Lumina.",
                "HERMIT_RUNESMITH": "Corvus lets out a sharp caw, as if challenging the Hermit's demeanor.",
                "ARCHIVIST_CONSTRUCT": "Corvus pecks curiously at a loose wire on the Archivist Construct.",
                "SKY_SEER_ECHO": "Corvus seems to listen intently to the Sky-Seer, its head cocked."
            },
            "Salamander": {
                "HERMIT_RUNESMITH": "Iggy basks for a moment near the Hermit's surprisingly warm forge-stone.",
                "VOLCANIC_SHRINE_1": "Iggy seems to draw energy from the volcanic shrine, its colors brightening.",
                "SKY_SEER_ECHO": "Iggy curls up, seemingly unimpressed by the Sky-Seer's pronouncements."
            },
            "Hound": {
                "LOST_SOUL": "Loyal nudges the Lost Soul gently with its nose, offering silent comfort.",
                "ECHO_LUMINA": "Loyal sits patiently, observing the Lumina echo with a calm demeanor.",
                "ARCHIVIST_CONSTRUCT": "Loyal circles the construct warily, unsure what to make of it."
            },
             "Sprite": {
                "LOST_SOUL": "Glimmer's light dims in the presence of the Lost Soul's sadness.",
                "ECHO_LUMINA": "Glimmer circles the Lumina's form, its light pulsing in time with the echo's faint glow.",
                "ARCHIVIST_CONSTRUCT": "Glimmer darts around the Archivist Construct, leaving trails of faint light.",
                "SKY_SEER_ECHO": "Glimmer hovers near the Sky-Seer, as if drawn to the ancient, airy magic."
            }
        };
        const EPITAPHS = [
            "Here lies a seeker of forgotten paths.", "They faced the shadows with courage.", "A silent watcher, now at rest.",
            "Their song unfinished, their journey done.", "Remembered only by the wind and dust.", "Dreamer of a brighter dawn.",
            "Fell chasing a whisper of hope.", "Guardian of a lost memory.", "Their name is lost, but their spirit lingers.",
            "Sought the First Song, found only silence.", "A traveler between worlds, now home."
        ];
        const NPCS = {
            "LOST_SOUL": {
                name: "Lost Soul",
                dialogue: [
                    "So cold... so long since the Light...", "Did you see them? The shadows... they took everything...",
                    "The Song... I almost remember the Song...", "Why did it fall? Why did we fall?",
                    "Is this... another dream? Or the long nightmare's end?",
                    "The rust... it claims everything, even memory."
                ]
            },
            "ECHO_LUMINA": {
                name: "Echo of a Lumina",
                dialogue: [
                    "...the constellations weep...", "...the Weave is torn, the Anchors lost...",
                    "Seek the resonance... the fragments of What Was...", "The Star-That-Devours... its hunger is eternal...",
                    "Our citadels... now dust on the wind. Only memory remains.",
                    "Did the Weavers foresee this? Or did their threads snap too soon?"
                ]
            },
            "HERMIT_RUNESMITH": {
                name: "Hermit Runesmith",
                dialogue: [
                    "Hmph. Another wanderer. These Runes... they are not toys.", "Each symbol holds a world. Handle them with care... or not. What do I care?",
                    "The Sky-Forges are cold, but their echoes remain in the deep places.", "The First Song... a fool's dream to remake it. Or perhaps... the only dream left.",
                    "Don't bother me unless you've something truly ancient. Or shiny.",
                    "Some say the Runes are but scars left by the First Song's breaking. Others, that they are its seeds."
                ]
            },
            "ARCHIVIST_CONSTRUCT": { 
                name: "Archivist Construct",
                dialogue: [
                    "Query? Data retrieval... compromised. Sector 7... flooded.", "The Great Unlearning... catastrophic data loss...",
                    "Knowledge is the light that holds back the Void. We... failed to shield it.", "Fragments remain. Seek them. Understand.",
                    "Error... memory banks corrupted... searching for... Prime Directive...",
                    "The Archives were meant to last eons. Eons... are shorter than we calculated."
                ]
            },
            "SKY_SEER_ECHO": { 
                name: "Sky-Seer's Echo",
                dialogue: [
                    "The winds carry whispers from above... and below.", "Once, we danced among the stars. Now, only their dust remains.",
                    "The Aerie remembers the First Song... listen closely to the silence between the gales.", "Beware the whispers from the Void... they promise power, but deliver only desolation.",
                    "The highest peaks touch the memory of what was. And what might be again.",
                    "Even the stars can die. We learned this... too late."
                ]
            }
        };
        const ARTIFACTS = [ 
            { key: "ART_LUMINA_LENS", name: "Cracked Lumina Lens", description: "Once used by Lumina Seers to gaze into the Weave of Fate. Its surface still shimmers with faint, unsettling patterns, hinting at futures best left unseen." },
            { key: "ART_RUNESMITHS_CHISEL", name: "Runesmith's Chisel Tip", description: "A fragment of a master Runesmith's tool. It hums with residual power, resonating faintly with any Runes you carry. It feels like it could shape more than just stone." },
            { key: "ART_PETRIFIED_SONGBIRD", name: "Petrified Songbird", description: "This tiny bird, frozen in a moment of song, is impossibly ancient. It's said such creatures carried notes of the First Song across the world." },
            { key: "ART_VOID_TAINTED_SEED", name: "Void-Tainted Seed", description: "A seed from the Starfall Crater, unnaturally cold to the touch. It pulses with a dark, alien vitality. What horrors might it grow into?" },
            { key: "ART_ARCHIVISTS_KEY", name: "Archivist's Data-Key", description: "A crystalline key from the Sunken Archives, its facets etched with complex Lumina script. It likely unlocked vast stores of knowledge, now lost to the depths." },
            { key: "ART_SILVER_LEAF_ASHEN", name: "Silver Leaf of Ashenwood", description: "A single, perfectly preserved silver leaf from the mythical sapling in the Ashen Woods. It radiates a gentle warmth, a tiny beacon of resilience." },
            { key: "ART_FROZEN_TEAR", name: "Frozen Tear of a Lumina", description: "This teardrop, solidified into a shimmering crystal, is said to have been shed by a Lumina watching their Sky-Citadel fall. It holds an echo of immense sorrow." },
            { key: "ART_LUMINA_SKY_SHARD", name: "Lumina Sky-Shard", description: "A fragment of a fallen Sky-Citadel, impossibly light and resonating with a faint celestial hum. It yearns for the open sky." },
            { key: "ART_RESONANT_WIND_CHIME", name: "Resonant Wind Chime", description: "Crafted from unknown alloys, this chime produces no audible sound, yet you feel its vibrations deep within your bones, like a forgotten melody." },
            { key: "ART_CELESTIAL_NAV_CHART", name: "Celestial Navigation Chart", description: "A tattered, metallic scroll depicting star patterns and energy currents unknown to modern understanding. It seems to map paths between worlds, or perhaps, between states of being." },
            { key: "ART_WEAVERS_THREAD", name: "Weaver's Thread", description: "An iridescent thread, stronger than any known material. It seems to shimmer with the raw potential of creation itself, a relic of the Weavers who predated even the Runesmiths." },
            { key: "ART_GUARDIAN_CORE_FRAGMENT", name: "Guardian Core Fragment", description: "The inert, crystalline core of a Lumina Guardian. It still pulses with a faint, rhythmic light, a ghost of its former power and purpose." },
            { key: "ART_SEAL_OF_A_CONSTELLATION", name: "Seal of a Lost Constellation", description: "A heavy, ornate seal bearing the emblem of a Lumina city-state whose name is lost to time. It speaks of forgotten allegiances and a structured, star-bound society." },
            { key: "ART_TOME_MIGHT", name: "Tome of Might", description: "This heavy, leather-bound book details forgotten martial disciplines. Reading it instills a surge of physical power. (Might +1)" },
            { key: "ART_TOME_WITS", name: "Tome of Cunning", description: "A slim volume filled with intricate diagrams and logical puzzles. Its study sharpens the mind. (Wits +1)" },
            { key: "ART_TOME_RESOLVE", name: "Tome of Resolve", description: "Bound in silver, this tome contains meditations and accounts of unwavering willpower. It fortifies the spirit. (Spirit +1)" },
            { key: "ART_RUNESMITHS_RESONATOR", name: "Runesmith's Resonator", description: "A curious device crafted by a Runesmith from a pristine crystal. It hums faintly, seeming to amplify the power of nearby Runes." },
            { key: "ART_ECHOING_CONCH", name: "Echoing Conch Shell", description: "Hold it to your ear, and you can almost hear the roar of oceans that dried up millennia ago, or perhaps, the faint strains of the First Song." },
            { key: "ART_STAR_METAL_INGOT", name: "Star-Metal Ingot", description: "Impossibly dense and cool to the touch, this ingot seems to have fallen from the heavens. It resonates with a strange, silent power." },
            { key: "ART_LUMINA_MOURNING_VEIL", name: "Lumina Mourning Veil", description: "A delicate, almost translucent fabric, embroidered with patterns of weeping stars. It carries an almost unbearable weight of sorrow." },
            { key: "ART_SEED_OF_THE_FIRST_TREE", name: "Seed of the First Tree", description: "A perfectly smooth, obsidian-black seed, warm to the touch. It feels ancient, potent, and full of a quiet, resilient life." },
            { key: "ART_VOID_SHACKLE_FRAGMENT", name: "Void-Shackle Fragment", description: "A piece of blackened, twisted metal that feels unnaturally cold. It emanates a sense of profound wrongness, a remnant of something designed to bind or corrupt." }
        ];
        const DECISIONS = {
            "END_OF_ASHEN_WOODS": {
                prompt: "The Ashen Woods give way to two paths. One descends into shimmering, crystalline caves. The other climbs towards a smoking peak. Where will your journey lead?",
                options: [
                    { text: "Descend into the Caves", outcomeKey: "PATH_TO_CRIMSON_DEPTHS", nextZoneIndex: 1 },
                    { text: "Ascend the Smoking Peak", outcomeKey: "PATH_TO_VOLCANIC_WASTES", nextZoneIndex: 2 }
                ],
                triggeredByZoneEnd: 0 
            },
            "END_OF_VOLCANIC_WASTES": { 
                prompt: "The Volcanic Wastes end at a precipice. Below, a vast, unnatural crater glows with eerie light. Do you dare venture into the Starfall Crater, or is it time to reflect on your journey thus far?",
                options: [
                    { text: "Enter the Starfall Crater", outcomeKey: "PATH_TO_STARFALL_CRATER", nextZoneIndex: 3 },
                    { text: "The Journey Pauses Here", outcomeKey: "JOURNEY_PAUSE_VOLCANIC", nextZoneIndex: -1, leaveMessage: true } 
                ],
                triggeredByZoneEnd: 2
            },
            "END_OF_STARFALL_CRATER": { 
                prompt: "Beyond the Starfall Crater, you sense a submerged path leading to ancient, waterlogged ruins. Alternatively, the biting winds call towards jagged mountain peaks where remnants of Sky-Temples are rumored to cling.",
                options: [
                    { text: "Explore the Sunken Archives", outcomeKey: "PATH_TO_SUNKEN_ARCHIVES", nextZoneIndex: 4},
                    { text: "Ascend to the Sky-Temple Aerie", outcomeKey: "PATH_TO_SKY_TEMPLE", nextZoneIndex: 5}, 
                ],
                triggeredByZoneEnd: 3
            },
            "END_OF_SUNKEN_ARCHIVES": { 
                prompt: "The Sunken Archives offer no further easy passage. Do you attempt to ascend to the rumored Sky-Temples above, or is this a point to gather your thoughts?",
                options: [
                    { text: "Seek the Sky-Temple Aerie", outcomeKey: "PATH_TO_SKY_TEMPLE_FROM_ARCHIVES", nextZoneIndex: 5 },
                    { text: "The Archives' Depths Suffice", outcomeKey: "JOURNEY_PAUSE_ARCHIVES", nextZoneIndex: -1, leaveMessage: true }
                ],
                triggeredByZoneEnd: 4
            }
        };
        const ZONES = [
            { // Zone 0
                name: "The Ashen Woods", width: 240, backgroundChar: ".", midgroundChar: "t", 
                foregroundElements: { 
                    10: [ { lane: 2, char: 'T' } ], 15: [ { lane: 0, char: '~' },{ lane: 1, char: '~' } ],
                    20: [ { lane: 1, char: '+' }, { lane: 0, char: '~' } ], 25: [ { lane: 3, char: 'c' } ], 
                    30: [ { lane: 2, char: 'w' }, { lane: 4, char: 'M'} ], 35: [ { lane: 0, char: 'L' }, { lane: 4, char: 'M'} ], 
                    40: [ { lane: 2, char: '§' }, { lane: 4, char: 'M'} ], 
                    45: [ { lane: 4, char: 'T' } ], 50: [ { lane: 1, char: 'A' } ], 55: [ { lane: 2, char: 'F'} ],
                    60: [ { lane: 3, char: 'P' } ], 
                    65: [ { lane: 4, char: '~' } ], 70: [ { lane: 2, char: 'm' },{ lane: 4, char: '~' }, { lane: 0, char: 'F' } ], 
                    75: [ { lane: 4, char: 'L' } ], 80: [ { lane: 0, char: 'T' } ], 
                    85: [ { lane: 0, char: '~' },{ lane: 1, char: '=' },{ lane: 2, char: '~' } ], 
                    90: [ { lane: 2, char: '#' } ], 95: [ { lane: 3, char: '+' } ], 100: [ { lane: 1, char: 'Y' }, { lane: 4, char: 'F'} ], 
                    105: [ { lane: 0, char: '0'} ], 
                    110: [ { lane: 2, char: 'H' } ], 120: [ { lane: 0, char: 'L' }, { lane: 4, char: 'M'} ], 
                    125: [ { lane: 4, char: 'M'} ], 130: [ { lane: 4, char: 'A' } ], 
                    140: [ { lane: 2, char: 'N', npcType: "LOST_SOUL" } ], 145: [ { lane: 3, char: 'T' } ], 150: [ { lane: 1, char: '.' }, { lane: 0, char: 'F'} ], 
                    160: [ { lane: 0, char: 'L' }, {lane: 4, char: '.'} ], 170: [ { lane: 2, char: 'm' } ], 175: [ { lane: 1, char: '+' } ], 
                    180: [ { lane: 3, char: 'T' } ], 190: [ { lane: 4, char: 'P' } ], 195: [ { lane: 2, char: 'Y' } ], 
                    200: [ { lane: 0, char: 'A' } ], 205: [ { lane: 1, char: '0'} ],
                    210: [ { lane: 3, char: 'c' } ], 220: [ { lane: 1, char: 'N', npcType: "LOST_SOUL" } ],
                    230: [ { lane: 4, char: 'L'} ]
                },
                color: "#ff8c00", bgColor: "#5c1f00", entryLoreKey: "ASHEN_WOODS_INTRO", shrineLoreKey: "ASHEN_SHRINE_1" 
            },
            { // Zone 1
                name: "The Crimson Depths", width: 290, backgroundChar: ":", midgroundChar: "*", 
                foregroundElements: {
                    15: [ { lane: 2, char: '♦' } ], 25: [ { lane: 0, char: '+' } ], 30: [ { lane: 4, char: '◊' } ], 
                    35: [ { lane: 0, char: 'M' }, { lane: 1, char: 'M' } ], 
                    40: [ { lane: 1, char: 'L' }, { lane: 0, char: 'M' } ], 50: [ { lane: 3, char: 'A' } ], 60: [ { lane: 2, char: '#' } ], 
                    70: [ { lane: 0, char: 'f' } ], 80: [ { lane: 4, char: 'N', npcType: "HERMIT_RUNESMITH" } ], 90: [ { lane: 2, char: 'Φ' } ],
                    100: [ { lane: 3, char: 'L' } ], 110: [ { lane: 1, char: '+' } ], 115: [ { lane: 4, char: '0'} ],
                    120: [ { lane: 2, char: '.' } ], 
                    130: [ { lane: 0, char: '✧' } ], 140: [ { lane: 4, char: 'A' } ], 150: [ { lane: 2, char: 'P' } ], 
                    160: [ { lane: 1, char: 'L' } ], 170: [ { lane: 3, char: '#' } ], 180: [ { lane: 0, char: '◊' } ], 
                    190: [ { lane: 2, char: 'N', npcType: "LOST_SOUL" } ], 200: [ { lane: 4, char: '✧' } ], 210: [ { lane: 1, char: 'f' } ], 
                    220: [ { lane: 2, char: 'Δ' } ], 230: [ { lane: 3, char: 'H' } ], 240: [ { lane: 0, char: 'A' } ], 
                    250: [ { lane: 4, char: 'L' } ], 260: [ { lane: 2, char: 'f' } ], 270: [ { lane: 1, char: 'L' } ],
                    280: [ { lane: 3, char: 'P' } ]
                },
                color: "#ff007f", bgColor: "#3b003b", entryLoreKey: "CRIMSON_DEPTHS_INTRO", shrineLoreKey: "CRIMSON_SHRINE_1"
            },
            { // Zone 2
                name: "The Volcanic Wastes", width: 340, backgroundChar: "`", midgroundChar: "^", 
                foregroundElements: { 
                    20: [ { lane: 2, char: ']' } ], 30: [ { lane: 0, char: 's' } ], 40: [ { lane: 4, char: 'A' } ], 
                    45: [ { lane: 0, char: 'M' }, { lane: 1, char: 'M' } ],
                    50: [ { lane: 1, char: 'L' }, { lane: 0, char: 'M' } ], 55: [ { lane: 3, char: '0'} ],
                    60: [ { lane: 3, char: '[' } ], 70: [ { lane: 2, char: '#' } ], 
                    80: [ { lane: 0, char: '+' } ], 90: [ { lane: 4, char: '.' } ], 100: [ { lane: 2, char: 'N', npcType: "HERMIT_RUNESMITH" } ],
                    110: [ { lane: 1, char: 's' } ], 120: [ { lane: 3, char: '§' } ], 130: [ { lane: 0, char: 'A' } ], 
                    140: [ { lane: 2, char: 'P' } ], 150: [ { lane: 4, char: ']' } ], 160: [ { lane: 1, char: 'L' } ], 
                    170: [ { lane: 2, char: 'H' } ], 180: [ { lane: 0, char: '#' } ], 190: [ { lane: 3, char: 's' } ], 
                    200: [ { lane: 4, char: '[' } ], 210: [ { lane: 1, char: '+' } ], 220: [ { lane: 2, char: 'A' } ], 
                    230: [ { lane: 0, char: '¦' } ], 240: [ { lane: 3, char: 'L' } ], 250: [ { lane: 2, char: 'Φ' } ], 
                    260: [ { lane: 4, char: 'L' } ], 270: [ { lane: 1, char: 'N', npcType: "ECHO_LUMINA" } ], 280: [ { lane: 0, char: 's' } ], 
                    290: [ { lane: 2, char: 'L' } ], 300: [ { lane: 3, char: '+' } ], 310: [ { lane: 4, char: 'A' } ], 
                    320: [ { lane: 1, char: 'P' } ], 330: [ { lane: 2, char: 'L' } ]
                },
                color: "#ff4500", bgColor: "#2b0f0f", entryLoreKey: "VOLCANIC_WASTES_INTRO", shrineLoreKey: "VOLCANIC_SHRINE_1"
            },
            { // Zone 3 
                name: "The Starfall Crater", width: 370, backgroundChar: "'", midgroundChar: "%", 
                foregroundElements: { 
                    10: [ { lane: 2, char: 'X' } ], 15: [ { lane: 0, char: 'M'}, { lane: 4, char: 'M'} ],
                    20: [ { lane: 0, char: 'E' }, { lane: 4, char: 'M'} ], 25: [ { lane: 2, char: '0'} ],
                    30: [ { lane: 4, char: 'V' } ], 
                    40: [ { lane: 1, char: 'A' } ], 50: [ { lane: 3, char: '+' } ], 60: [ { lane: 2, char: '.' } ], 
                    70: [ { lane: 0, char: 'E' } ], 80: [ { lane: 4, char: '#' } ], 90: [ { lane: 1, char: 'V' } ],
                    100: [ { lane: 3, char: 'N', npcType: "ECHO_LUMINA" } ], 110: [ { lane: 2, char: 'X' } ], 120: [ { lane: 0, char: 'P' } ], 
                    130: [ { lane: 4, char: 'E' } ], 140: [ { lane: 1, char: 'A' } ], 150: [ { lane: 2, char: 'L' } ], 
                    160: [ { lane: 3, char: 'X' } ], 170: [ { lane: 2, char: 'H' } ], 180: [ { lane: 0, char: '+' } ], 
                    190: [ { lane: 4, char: 'E' } ], 200: [ { lane: 1, char: 'V' } ], 210: [ { lane: 3, char: 'L' } ], 
                    220: [ { lane: 2, char: 'A' } ], 230: [ { lane: 0, char: '#' } ], 240: [ { lane: 4, char: 'E' } ], 
                    250: [ { lane: 1, char: 'N', npcType: "ECHO_LUMINA" } ], 260: [ { lane: 2, char: 'L' } ], 270: [ { lane: 3, char: 'X' } ], 
                    280: [ { lane: 0, char: '+' } ], 290: [ { lane: 4, char: 'A' } ], 300: [ { lane: 1, char: 'V' } ], 
                    310: [ { lane: 2, char: 'L' } ], 320: [ { lane: 3, char: 'X' } ], 330: [ { lane: 0, char: 'E' } ], 
                    340: [ { lane: 4, char: 'V' } ], 350: [ { lane: 1, char: 'P' } ], 360: [ { lane: 2, char: 'L' } ]
                },
                color: "#9370db", bgColor: "#100020", entryLoreKey: "STARFALL_CRATER_INTRO", shrineLoreKey: "STARFALL_SHRINE_1"
            },
            { // Zone 4 
                name: "The Sunken Archives", width: 400, backgroundChar: "~", midgroundChar: "c", 
                foregroundElements: { 
                    5: [ { lane: 0, char: '~'}, { lane: 1, char: '~'}, { lane: 3, char: '~'}, { lane: 4, char: '~'} ],
                    10: [ { lane: 2, char: 'S' }, { lane: 0, char: '~'}, { lane: 1, char: '~'}, { lane: 3, char: '~'}, { lane: 4, char: '~'} ], 
                    15: [ { lane: 2, char: '=' } ], 
                    20: [ { lane: 0, char: 'b' } ], 25: [ { lane: 1, char: '0'} ], 30: [ { lane: 4, char: '+' } ],
                    40: [ { lane: 1, char: 'A' } ], 50: [ { lane: 3, char: 'D' } ], 60: [ { lane: 2, char: '#' } ],
                    70: [ { lane: 0, char: 'N', npcType: "ARCHIVIST_CONSTRUCT"} ], 80: [ { lane: 4, char: 'S' } ], 90: [ { lane: 1, char: 'b' } ],
                    100: [ { lane: 3, char: 'L' } ], 110: [ { lane: 2, char: 'P' } ], 120: [ { lane: 0, char: 'D' } ],
                    130: [ { lane: 4, char: 'A' } ], 140: [ { lane: 1, char: 'S' } ], 150: [ { lane: 3, char: 'b' } ],
                    160: [ { lane: 2, char: 'L' } ], 170: [ { lane: 0, char: '#' } ], 180: [ { lane: 4, char: 'N', npcType: "ECHO_LUMINA" } ],
                    190: [ { lane: 1, char: 'D' } ], 200: [ { lane: 3, char: 'S' } ], 210: [ { lane: 2, char: 'H' } ],
                    220: [ { lane: 0, char: 'A' } ], 230: [ { lane: 4, char: '+' } ], 240: [ { lane: 1, char: 'L' } ],
                    250: [ { lane: 3, char: 'D' } ], 260: [ { lane: 2, char: '#' } ], 270: [ { lane: 0, char: 'P' } ],
                    280: [ { lane: 4, char: 'S' } ], 290: [ { lane: 1, char: 'b' } ], 300: [ { lane: 3, char: 'A' } ],
                    310: [ { lane: 2, char: 'N', npcType: "ARCHIVIST_CONSTRUCT"} ], 320: [ { lane: 0, char: 'D' } ], 330: [ { lane: 4, char: '+' } ],
                    340: [ { lane: 1, char: 'S' } ], 350: [ { lane: 3, char: 'b' } ], 360: [ { lane: 2, char: 'L' } ],
                    370: [ { lane: 0, char: 'L' } ], 380: [ { lane: 4, char: 'A' } ], 390: [ { lane: 2, char: 'N', npcType: "ECHO_LUMINA" } ]
                },
                color: "#20b2aa", 
                bgColor: "#003333", 
                entryLoreKey: "SUNKEN_ARCHIVES_INTRO",
                shrineLoreKey: "SUNKEN_ARCHIVES_SHRINE_1"
            },
            { // Zone 5 
                name: "The Sky-Temple Aerie", width: 420, backgroundChar: " ", midgroundChar: "C", 
                foregroundElements: {
                    10: [ { lane: 2, char: 'R' } ], 20: [ { lane: 0, char: '^' } ], 30: [ { lane: 4, char: '^' } ],
                    40: [ { lane: 1, char: 'A' } ], 50: [ { lane: 3, char: 'w' } ], 60: [ { lane: 2, char: '#' } ], 
                    70: [ { lane: 0, char: 'N', npcType: "SKY_SEER_ECHO"} ], 80: [ { lane: 4, char: 'R' } ], 90: [ { lane: 1, char: 'G' } ],
                    100: [ { lane: 3, char: 'L' } ], 110: [ { lane: 2, char: 'P' } ], 120: [ { lane: 0, char: 'w' } ],
                    130: [ { lane: 4, char: 'A' } ], 140: [ { lane: 1, char: 'R' } ], 150: [ { lane: 3, char: 'G' } ],
                    160: [ { lane: 2, char: 'L' } ], 170: [ { lane: 0, char: '#' } ], 180: [ { lane: 4, char: 'N', npcType: "ECHO_LUMINA" } ],
                    190: [ { lane: 1, char: 'w' } ], 200: [ { lane: 3, char: 'R' } ], 210: [ { lane: 2, char: 'H' } ],
                    220: [ { lane: 0, char: 'A' } ], 230: [ { lane: 4, char: '+' } ], 240: [ { lane: 1, char: 'L' } ],
                    250: [ { lane: 3, char: 'G' } ], 260: [ { lane: 2, char: '#' } ], 270: [ { lane: 0, char: 'P' } ],
                    280: [ { lane: 4, char: 'R' } ], 290: [ { lane: 1, char: 'w' } ], 300: [ { lane: 3, char: 'A' } ],
                    310: [ { lane: 2, char: 'N', npcType: "SKY_SEER_ECHO"} ], 320: [ { lane: 0, char: 'G' } ], 330: [ { lane: 4, char: '+' } ],
                    340: [ { lane: 1, char: 'R' } ], 350: [ { lane: 3, char: 'w' } ], 360: [ { lane: 2, char: 'L' } ],
                    370: [ { lane: 0, char: 'L' } ], 380: [ { lane: 4, char: 'A' } ], 390: [ { lane: 2, char: 'N', npcType: "ECHO_LUMINA" } ],
                    400: [ { lane: 1, char: 'G' } ], 410: [ { lane: 3, char: 'w' } ],
                    415: [ { lane: 2, char: 'O' }] 
                },
                color: "#add8e6", 
                bgColor: "#4682b420", 
                entryLoreKey: "SKY_TEMPLE_AERIE_INTRO",
                shrineLoreKey: "SKY_TEMPLE_AERIE_SHRINE_1"
            }
        ];

        // --- DOM Elements ---
        const gameScreenContent = document.getElementById('game-screen-content'); 
        const gameScreen = document.getElementById('game-screen');
        const statsZoneName = document.getElementById('zone-name');
        const statsExploredPercentage = document.getElementById('explored-percentage');
        const statsExplorationSpeed = document.getElementById('exploration-speed');
        const statsGlimmeringDust = document.getElementById('glimmering-dust');
        const statsAncientScraps = document.getElementById('ancient-scraps');
        const statsRunesCollected = document.getElementById('runes-collected');
        const voidEssenceDisplay = document.getElementById('void-essence-display');
        const statsVoidEssence = document.getElementById('void-essence');
        const companionDisplay = document.getElementById('companion-display');
        const companionInfo = document.getElementById('companion-info');
        const artifactsCollectedDisplay = document.getElementById('artifacts-collected'); 
        const statMightDisplay = document.getElementById('stat-might'); 
        const statWitsDisplay = document.getElementById('stat-wits');   
        const statSpiritDisplay = document.getElementById('stat-spirit'); 
        const playerLevelDisplay = document.getElementById('player-level'); 
        const playerXpDisplay = document.getElementById('player-xp');       
        const xpToNextLevelDisplay = document.getElementById('xp-to-next-level'); 
        const playerHpDisplay = document.getElementById('player-hp'); 
        const playerMaxHpDisplay = document.getElementById('player-max-hp'); 
        const playerClassDisplay = document.getElementById('player-class');
        const playerNameDisplay = document.getElementById('player-name-display'); 
        const logArea = document.getElementById('log-area');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const upgradeSpeedButton = document.getElementById('upgrade-speed-button');
        const decisionArea = document.getElementById('decision-area');
        const decisionPromptText = document.getElementById('decision-prompt-text');
        const decisionButtonsContainer = document.getElementById('decision-buttons-container');
        const messageInputArea = document.getElementById('message-input-area');
        const futureSelfTextarea = document.getElementById('future-self-textarea');
        const saveMessageButton = document.getElementById('save-message-button');
        const skipMessageButton = document.getElementById('skip-message-button');
        const summaryArea = document.getElementById('summary-area'); 
        const journeySummaryTextarea = document.getElementById('journey-summary-textarea'); 
        const newJourneyButton = document.getElementById('new-journey-button'); 
        const transcendButton = document.getElementById('transcend-button');


        // --- Game Logic Functions ---
        function getCurrentZone() { return ZONES[gameState.currentZoneIndex]; }
        
        function calculateMaxHp() {
            let hp = BASE_HP + (gameState.level * 5) + (gameState.stats.might * 2);
            if (gameState.playerClass === "Stalwart") hp += 5;
            return hp;
        }

        function awardXP(amount) {
            if (gameState.currentZoneIndex === -1) return; 
            let finalAmount = amount;
            if (gameState.playerClass === "Erudite") {
                finalAmount = Math.ceil(amount * 1.05); 
            }
            gameState.xp += finalAmount;
            addLogMessage(`Gained ${finalAmount} XP.`, "xp");
            checkForLevelUp();
        }

        function calculateXPForNextLevel(level) {
            if (level === 1) return XP_FOR_LEVEL_2;
            return XP_FOR_LEVEL_2 + ( (level -1) * (level -1) * XP_LEVEL_SCALING_BASE ); 
        }

        function checkForLevelUp() {
            while (gameState.xp >= gameState.xpToNextLevel) {
                gameState.level++;
                const overflowXp = gameState.xp - gameState.xpToNextLevel;
                gameState.xp = overflowXp; 
                gameState.xpToNextLevel = calculateXPForNextLevel(gameState.level);
                
                const stats = ["might", "wits", "spirit"];
                const randomStatIndex = seededRandomInt(0, stats.length - 1);
                const statToIncrease = stats[randomStatIndex];
                gameState.stats[statToIncrease]++;
                
                gameState.maxHp = calculateMaxHp(); 
                gameState.currentHp = gameState.maxHp; 

                playSound('levelUp');
                addLogMessage(`LEVEL UP! You are now Level ${gameState.level}! Your ${statToIncrease.charAt(0).toUpperCase() + statToIncrease.slice(1)} increased by 1! HP restored.`, "level-up-message");
            }
        }


        function addLogMessage(message, type = "normal") { 
            let classAttribute = "";
            if (type === "lore") classAttribute = "class='lore-message'";
            if (type === "world_lore") classAttribute = "class='world-lore-message'"; 
            if (type === "synergy") classAttribute = "class='synergy-message'"; 
            if (type === "artifact_synergy") classAttribute = "class='artifact-synergy-message'";
            if (type === "artifact") classAttribute = "class='artifact-message'";
            if (type === "npc") classAttribute = "class='npc-message'";
            if (type === "decision") classAttribute = "class='decision-outcome'";
            if (type === "future_self") classAttribute = "class='future-self-message'";
            if (type === "companion") classAttribute = "class='companion-message'";
            if (type === "grave") classAttribute = "class='grave-message'";
            if (type === "seed") classAttribute = "class='seed-message'";
            if (type === "startup") classAttribute = "class='startup-message'"; 
            if (type === "xp") classAttribute = "class='xp-message'";
            if (type === "level-up-message") classAttribute = "class='level-up-message'";
            if (type === "combat-message") classAttribute = "class='combat-message'";
            if (type === "combat-victory") classAttribute = "class='combat-victory'";
            if (type === "combat-defeat") classAttribute = "class='combat-defeat'";
            if (type === "quest") classAttribute = "class='quest-message'"; 
            if (type === "class-choice") classAttribute = "class='class-choice-message'";
            if (type === "name-choice") classAttribute = "class='name-choice-message'"; 
            
            gameState.logMessages.unshift(`<p ${classAttribute}>${message}</p>`); 
            if (gameState.logMessages.length > gameState.maxLogMessages) {
                gameState.logMessages.pop(); 
            }
            renderLog();
        }
        function renderLog() { 
            logArea.innerHTML = gameState.logMessages.join('');
            const firstLogEntry = logArea.querySelector('p:first-child');
            if (firstLogEntry && !firstLogEntry.classList.contains('lore-message') && 
                !firstLogEntry.classList.contains('world-lore-message') && 
                !firstLogEntry.classList.contains('synergy-message') &&
                !firstLogEntry.classList.contains('artifact-synergy-message') &&
                !firstLogEntry.classList.contains('artifact-message') &&
                !firstLogEntry.classList.contains('npc-message') &&
                !firstLogEntry.classList.contains('decision-outcome') &&
                !firstLogEntry.classList.contains('future-self-message') &&
                !firstLogEntry.classList.contains('companion-message') &&
                !firstLogEntry.classList.contains('grave-message') &&
                !firstLogEntry.classList.contains('seed-message') &&
                !firstLogEntry.classList.contains('startup-message') &&
                !firstLogEntry.classList.contains('xp-message') &&
                !firstLogEntry.classList.contains('level-up-message') &&
                !firstLogEntry.classList.contains('combat-message') &&
                !firstLogEntry.classList.contains('combat-victory') &&
                !firstLogEntry.classList.contains('combat-defeat') &&
                !firstLogEntry.classList.contains('quest-message') &&
                !firstLogEntry.classList.contains('class-choice-message') &&
                !firstLogEntry.classList.contains('name-choice-message') 
                ) {
                const zone = getCurrentZone();
                if(zone) firstLogEntry.style.color = lightenDarkenColor(zone.color, 60); 
            }
        }
        function renderStats() { 
            const zone = getCurrentZone();
            if (!zone && gameState.currentZoneIndex !== -1) return; 
            if (gameState.currentZoneIndex === -1) { 
                statsZoneName.textContent = "Journey Ended";
                statsExploredPercentage.textContent = "---";
            } else {
                statsZoneName.textContent = zone.name;
                const exploredPercentage = Math.min(100, Math.floor((gameState.playerZoneX / zone.width) * 100));
                statsExploredPercentage.textContent = exploredPercentage;
            }

            playerNameDisplay.textContent = gameState.playerName; 
            playerHpDisplay.textContent = gameState.currentHp;
            playerMaxHpDisplay.textContent = gameState.maxHp;
            playerClassDisplay.textContent = gameState.playerClass || "None"; 
            statsExplorationSpeed.textContent = `${gameState.explorationSpeedMultiplier.toFixed(1)}x`;
            statsGlimmeringDust.textContent = gameState.resources.glimmeringDust;
            statsAncientScraps.textContent = gameState.resources.ancientScraps;
            statsRunesCollected.textContent = gameState.runes.length > 0 ? gameState.runes.join(' ') : 'None';
            
            if (gameState.resources.voidEssence > 0) {
                voidEssenceDisplay.style.display = 'inline';
                statsVoidEssence.textContent = gameState.resources.voidEssence;
            } else {
                voidEssenceDisplay.style.display = 'none';
            }

            if (gameState.companion) {
                companionDisplay.style.display = 'inline'; 
                companionInfo.textContent = `${gameState.companion.name} the ${gameState.companion.type}`;
            } else {
                companionDisplay.style.display = 'none';
            }
            artifactsCollectedDisplay.textContent = `${gameState.collectedArtifacts.length}/${ARTIFACTS.length}`;

            statMightDisplay.textContent = gameState.stats.might;
            statWitsDisplay.textContent = gameState.stats.wits;
            statSpiritDisplay.textContent = gameState.stats.spirit;
            playerLevelDisplay.textContent = gameState.level;
            playerXpDisplay.textContent = gameState.xp;
            xpToNextLevelDisplay.textContent = gameState.xpToNextLevel;


            const upgradeCost = 50 * gameState.explorationSpeedMultiplier;
            upgradeSpeedButton.textContent = `Upgrade Speed (Cost: ${Math.round(upgradeCost)} .)`;
            upgradeSpeedButton.disabled = gameState.resources.glimmeringDust < upgradeCost || gameState.currentZoneIndex === -1;
        }
        
        function updateUIAccentColors() { 
            const zone = getCurrentZone();
            let primaryColor = "#800080"; 
            let bgColor = "#1a0f1a";

            if (zone && gameState.currentZoneIndex !== -1) {
                primaryColor = zone.color;
                bgColor = zone.bgColor;
            } else if (gameState.currentZoneIndex === -1) { 
                primaryColor = "#777777"; 
                bgColor = "#222222";
            }
            
            const gameContainer = document.querySelector('.game-container');
            if (gameContainer) {
                gameContainer.style.borderColor = primaryColor;
                gameContainer.style.boxShadow = `0 0 15px ${primaryColor}, inset 0 0 10px ${primaryColor}33`;
            }

            document.querySelectorAll('.stats-bar, .log-area, .controls-area, .decision-area, .message-input-area, .summary-area').forEach(el => {
                el.style.borderColor = lightenDarkenColor(primaryColor, -50);
                el.style.backgroundColor = lightenDarkenColor(bgColor, 10);
            });
            document.querySelectorAll('.controls-area button, .decision-area button, .message-input-area button, .summary-area button').forEach(button => {
                const baseButtonColor = lightenDarkenColor(primaryColor, -20);
                button.style.backgroundColor = baseButtonColor;
                button.style.color = lightenDarkenColor(primaryColor, 80); 
                button.style.borderColor = primaryColor;
            });
            const gameScreenEl = document.getElementById('game-screen');
            if (gameScreenEl) {
                 if (gameState.currentZoneIndex === -1) {
                    gameScreenEl.style.color = "#aaa"; 
                    gameScreenEl.style.backgroundColor = "#111";
                    gameScreenEl.style.borderColor = lightenDarkenColor(primaryColor, -30);
                 } else if (zone) {
                    gameScreenEl.style.color = zone.color; 
                    gameScreenEl.style.backgroundColor = zone.bgColor; 
                    gameScreenEl.style.borderColor = lightenDarkenColor(zone.color, -30);
                 }
            }
        }

        function renderGameScreen() { 
            const zone = getCurrentZone();
            
            if (!zone && gameState.currentZoneIndex === -1) { 
                gameScreenContent.innerHTML = Array(NUM_LANES).fill('').map((_, i) => {
                    if (i === gameState.playerLane) return ' '.repeat(PLAYER_VISUAL_POSITION - 5) + 'Path Fades...'; 
                    return ' '.repeat(SCREEN_WIDTH);
                }).join('\n');
                return;
            }
            if (!zone) return; 

            let screenLines = Array(NUM_LANES).fill(null).map(() => Array(SCREEN_WIDTH).fill(' '));

            for (let lane = 0; lane < NUM_LANES; lane++) {
                for (let i = 0; i < SCREEN_WIDTH; i++) {
                    if ((gameState.playerZoneX + i + lane) % 11 === 0) {
                        screenLines[lane][i] = zone.backgroundChar;
                    }
                    if ((gameState.playerZoneX + i + lane * 2) % (zone.midgroundChar === '%' ? 5 : (zone.midgroundChar === 'c' ? 6 : (zone.midgroundChar === 'C' ? 8 : 9))) === 0) { 
                        if(screenLines[lane][i] === ' ') screenLines[lane][i] = zone.midgroundChar;
                    }
                }
            }
            
            for (let screenX = 0; screenX < SCREEN_WIDTH; screenX++) {
                const worldX = gameState.playerZoneX - PLAYER_VISUAL_POSITION + screenX;
                if (zone.foregroundElements[worldX]) {
                    zone.foregroundElements[worldX].forEach(element => {
                        if (element.lane >= 0 && element.lane < NUM_LANES) {
                            if (!(element.lane === gameState.playerLane && screenX === PLAYER_VISUAL_POSITION)) {
                                let displayChar = element.char;
                                if (element.char === '~') displayChar = `<span style="${WATER_COLOR_STYLE}">~</span>`;
                                else if (element.char === '=') displayChar = `<span style="${BRIDGE_COLOR_STYLE}">=</span>`;
                                else if (element.char === 'M') displayChar = `<span style="${MOUNTAIN_COLOR_STYLE}">M</span>`;
                                else if (element.char === 'F') displayChar = `<span style="${FOREST_COLOR_STYLE}">F</span>`;
                                else if (element.char === '0') displayChar = `<span style="${DARK_FEATURE_COLOR_STYLE}">0</span>`;
                                else if (element.char === 'C') displayChar = `<span style="${CLOUD_COLOR_STYLE}">C</span>`;
                                else if (element.char === 'R') displayChar = `<span style="${RUIN_COLOR_STYLE}">R</span>`;
                                else if (element.char === 'w' && zone.name === "The Sky-Temple Aerie") displayChar = `<span style="${WINDCHIME_COLOR_STYLE}">w</span>`; 
                                else if (element.char === 'G') displayChar = `<span style="${GUARDIAN_COLOR_STYLE}">G</span>`;
                                else if (element.char === 'O') displayChar = `<span style="${ORACLE_DAIS_COLOR_STYLE}">O</span>`;
                                else if (element.char === 'E' && element.enemyKey) displayChar = `<span style="${ENEMY_COLOR_STYLE}">${element.char}</span>`; 
                                else if (element.char === 'B') displayChar = `<span style="${BLOCKED_PATH_COLOR_STYLE}">B</span>`;
                                else if (element.char === '?') displayChar = `<span style="${RUNIC_ETCHING_COLOR_STYLE}">?</span>`;
                                else if (element.char === '!') displayChar = `<span style="${WHISPERING_TOTEM_COLOR_STYLE}">!</span>`;
                                screenLines[element.lane][screenX] = displayChar;
                            }
                        }
                    });
                }
            }

            screenLines[gameState.playerLane][PLAYER_VISUAL_POSITION] = `<span style="${PLAYER_COLOR_STYLE}">@</span>`;

            gameScreenContent.innerHTML = screenLines.map(line => line.join('')).join('\n');
        }
        function lightenDarkenColor(col, amt) { /* ... (same) ... */ 
            let usePound = false;
            if (col[0] === "#") {
                col = col.slice(1);
                usePound = true;
            }
            const num = parseInt(col, 16);
            let r = (num >> 16) + amt;
            if (r > 255) r = 255; else if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255; else if (b < 0) b = 0;
            let g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255; else if (g < 0) g = 0;
            const newR = r.toString(16).padStart(2, '0');
            const newG = g.toString(16).padStart(2, '0');
            const newB = b.toString(16).padStart(2, '0');
            return (usePound ? "#" : "") + newR + newG + newB;
        }
        
        function resolveCombat(enemyKey) {
            const enemyData = ENEMY_TYPES[enemyKey];
            if (!enemyData) {
                addLogMessage("An unknown foe fades into the shadows...", "combat-message");
                return;
            }
            let enemy = {...enemyData}; 

            addLogMessage(`You encounter a ${enemy.name}! ${enemy.description}`, "combat-message");
            gameState.inCombat = true;
            pauseGameForDecision(true); 

            if (seededRandom() < SPONTANEOUS_VICTORY_CHANCE) {
                addLogMessage("A surge of unforeseen power courses through you! The " + enemy.name + " is instantly obliterated!", "combat-victory");
                playSound('combatVictory');
                awardXP(enemy.xp * 2); 
                const lootAmount = enemy.loot();
                if (lootAmount > 0) {
                    gameState.resources.glimmeringDust += lootAmount * 2; 
                    addLogMessage(`It drops ${lootAmount * 2} Glimmering Dust!`, "combat-message");
                }
                if (seededRandom() < 0.2) { 
                    const undiscoveredArtifacts = ARTIFACTS.filter(art => !gameState.collectedArtifacts.includes(art.key) && !art.key.startsWith("ART_TOME")); 
                    if (undiscoveredArtifacts.length > 0) {
                        const foundArtifact = undiscoveredArtifacts[seededRandomInt(0, undiscoveredArtifacts.length - 1)];
                        gameState.collectedArtifacts.push(foundArtifact.key);
                        gameState.narrativeFlags[foundArtifact.key] = true;
                        addLogMessage(`Amidst the fading essence of your foe, you find the <strong>${foundArtifact.name}</strong>!`, "artifact");
                        awardXP(25); 
                    }
                } else { 
                     const undiscoveredTomes = ARTIFACTS.filter(art => !gameState.collectedArtifacts.includes(art.key) && art.key.startsWith("ART_TOME"));
                     if (undiscoveredTomes.length > 0 && seededRandom() < 0.3) {
                        const foundTome = undiscoveredTomes[seededRandomInt(0, undiscoveredTomes.length - 1)];
                        gameState.collectedArtifacts.push(foundTome.key);
                        gameState.narrativeFlags[foundTome.key] = true;
                        addLogMessage(`A forgotten <strong>${foundTome.name}</strong> materializes from the dissipating foe!`, "artifact");
                         if (foundTome.key === "ART_TOME_MIGHT") { gameState.stats.might++; gameState.maxHp = calculateMaxHp(); gameState.currentHp = gameState.maxHp;}
                         else if (foundTome.key === "ART_TOME_WITS") { gameState.stats.wits++; }
                         else if (foundTome.key === "ART_TOME_RESOLVE") { gameState.stats.spirit++; gameState.maxHp = calculateMaxHp(); gameState.currentHp = gameState.maxHp;}
                         addLogMessage(`Your ${foundTome.name.split(' ')[2]} increases by 1!`, "synergy");
                        awardXP(20);
                     }
                }


                gameState.inCombat = false;
                pauseGameForDecision(false); 
                renderAll();
                return;
            }

            let combatLogMessages = [];
            let combatRound = 0;
            const maxCombatRounds = 5; 

            function processCombatRound() {
                if (combatRound >= maxCombatRounds || enemy.hp <= 0 || gameState.currentHp <= 0 || !gameState.inCombat) {
                    resolveCombatOutcome();
                    return;
                }

                combatRound++;
                combatLogMessages.push(`--- Round ${combatRound} ---`);

                let playerAttackPower = gameState.stats.might + seededRandomInt(0, Math.floor(gameState.level / 2));
                let attackType = "melee";
                if (gameState.stats.spirit > gameState.stats.might + 2) {
                    playerAttackPower = gameState.stats.spirit + seededRandomInt(0, Math.floor(gameState.level/2));
                    attackType = "spiritual energy";
                }
                const enemyDefenseSoak = Math.floor(enemy.defense / 2);
                const damageToEnemy = Math.max(1, playerAttackPower - enemyDefenseSoak);
                enemy.hp -= damageToEnemy;
                combatLogMessages.push(`You strike with ${attackType} for ${damageToEnemy} damage. ${enemy.name} HP: ${Math.max(0, enemy.hp)}`);
                playSound('combatHit');

                if (enemy.hp <= 0) {
                    resolveCombatOutcome();
                    return;
                }

                const enemyAttackPower = enemy.attack + seededRandomInt(-1, 1); 
                const playerDefenseSoak = Math.floor(gameState.stats.might / 3) + Math.floor(gameState.stats.spirit / 4); 
                const damageToPlayer = Math.max(0, enemyAttackPower - playerDefenseSoak); 
                gameState.currentHp -= damageToPlayer;
                combatLogMessages.push(`${enemy.name} attacks for ${damageToPlayer} damage. Your HP: ${Math.max(0, gameState.currentHp)}`);
                if (damageToPlayer > 0) playSound('combatMiss'); 

                if (gameState.currentHp <= 0) {
                    resolveCombatOutcome();
                    return;
                }
                
                combatLogMessages.forEach(msg => addLogMessage(msg, "combat-message"));
                combatLogMessages = []; 
                setTimeout(processCombatRound, 600); 
            }
            
            function resolveCombatOutcome() {
                combatLogMessages.forEach(msg => addLogMessage(msg, "combat-message"));

                if (enemy.hp <= 0) {
                    addLogMessage(`You have vanquished the ${enemy.name}!`, "combat-victory");
                    playSound('combatVictory');
                    awardXP(enemy.xp);
                    const lootAmount = enemy.loot();
                    if (lootAmount > 0) {
                        gameState.resources.glimmeringDust += lootAmount;
                        addLogMessage(`It drops ${lootAmount} Glimmering Dust.`, "combat-message");
                    }
                } else if (gameState.currentHp <= 0) {
                    addLogMessage(`You have been defeated by the ${enemy.name}... Darkness takes you.`, "combat-defeat");
                    playSound('combatDefeat');
                    handleGameEnd("Your journey has ended in defeat...");
                } else { 
                     addLogMessage(`The ${enemy.name} proves resilient! You disengage, losing ${COMBAT_ESCAPE_DUST_LOSS} Glimmering Dust.`, "combat-message");
                     playSound('combatMiss');
                     gameState.resources.glimmeringDust = Math.max(0, gameState.resources.glimmeringDust - COMBAT_ESCAPE_DUST_LOSS);
                }
                gameState.inCombat = false;
                pauseGameForDecision(false); 
                renderAll();
            }

            processCombatRound(); 
        }


        function handleEncounter() { 
            const zone = getCurrentZone();
            if (!zone) return;
            
            const elementsAtCurrentX = zone.foregroundElements[gameState.playerZoneX] || [];
            const npcEncounterKeyBase = `${gameState.currentZoneIndex}-${gameState.playerZoneX}`;

            elementsAtCurrentX.forEach(element => {
                const currentElementChar = element.char;
                const npcSpecificKey = npcEncounterKeyBase + '-' + element.lane; 

                if (element.lane === gameState.playerLane && (currentElementChar === '~' || currentElementChar === 'M')) {
                    return; 
                }

                switch (currentElementChar) {
                    case 'E': 
                        if (element.lane === gameState.playerLane && !gameState.inCombat && element.enemyKey) {
                           resolveCombat(element.enemyKey);
                        }
                        break;
                    case 'B': 
                        if (element.lane === gameState.playerLane) {
                            const pathKey = `BLOCKED_${gameState.currentZoneIndex}_${gameState.playerZoneX}_${element.lane}`;
                            if (!gameState.narrativeFlags[pathKey]) {
                                if (gameState.stats.might >= MGT_BLOCKED_PATH_THRESHOLD) {
                                    addLogMessage(STAT_CHALLENGE_LORE.BLOCKED_PATH_SUCCESS, "synergy");
                                    const bonusDust = seededRandomInt(5, 10);
                                    gameState.resources.glimmeringDust += bonusDust;
                                    addLogMessage(`You find ${bonusDust} Glimmering Dust!`, "lore");
                                    awardXP(10);
                                    gameState.narrativeFlags[pathKey] = true;
                                } else {
                                    addLogMessage(STAT_CHALLENGE_LORE.BLOCKED_PATH_FAIL, "lore");
                                }
                            } else {
                                addLogMessage("This path has already been cleared.", "lore");
                            }
                        }
                        break;
                    case '?': 
                        if (element.lane === gameState.playerLane) {
                            const etchingKey = `ETCHING_${gameState.currentZoneIndex}_${gameState.playerZoneX}_${element.lane}`;
                            if (!gameState.narrativeFlags[etchingKey]) {
                                if (gameState.stats.wits >= WIT_ETCHINGS_THRESHOLD) {
                                    const zoneSpecificHints = {
                                        "The Ashen Woods": "a forgotten ember still glowing faintly.",
                                        "The Crimson Depths": "a hidden vein of purest crystal.",
                                        "The Volcanic Wastes": "a path through the lava flows unseen by most.",
                                        "The Starfall Crater": "the true trajectory of a falling star.",
                                        "The Sunken Archives": "a lost page detailing a forgotten Lumina ritual.",
                                        "The Sky-Temple Aerie": "a celestial alignment of great import."
                                    };
                                    const hint = zoneSpecificHints[zone.name] || "a forgotten secret of this place.";
                                    addLogMessage(STAT_CHALLENGE_LORE.RUNIC_ETCHINGS_SUCCESS.replace("[a short, unique seeded lore snippet about the zone's deeper history or a nearby secret - TBD]", hint) , "synergy");
                                    awardXP(15);
                                    gameState.narrativeFlags[etchingKey] = true;
                                } else {
                                    addLogMessage(STAT_CHALLENGE_LORE.RUNIC_ETCHINGS_FAIL, "lore");
                                }
                            } else {
                                 addLogMessage("You've already gleaned all you can from these etchings.", "lore");
                            }
                        }
                        break;
                    case '!': 
                        if (element.lane === gameState.playerLane) {
                             const totemKey = `TOTEM_${gameState.currentZoneIndex}_${gameState.playerZoneX}_${element.lane}`;
                             if (!gameState.narrativeFlags[totemKey]) {
                                if (gameState.stats.spirit >= SPR_TOTEM_THRESHOLD) {
                                    addLogMessage(STAT_CHALLENGE_LORE.WHISPERING_TOTEM_SUCCESS, "synergy");
                                    awardXP(10); 
                                    const bonusScraps = seededRandomInt(1, 3);
                                    gameState.resources.ancientScraps += bonusScraps;
                                    addLogMessage(`The totem grants you ${bonusScraps} Ancient Scraps for your attentiveness.`, "lore");
                                    gameState.narrativeFlags[totemKey] = true;
                                } else {
                                    addLogMessage(STAT_CHALLENGE_LORE.WHISPERING_TOTEM_FAIL, "lore");
                                }
                            } else {
                                addLogMessage("The totem's whispers are silent now, having shared their secrets.", "lore");
                            }
                        }
                        break;
                    case 'O': 
                        if (element.lane === gameState.playerLane) { 
                            const daisKey = `DAIS_${gameState.currentZoneIndex}_${gameState.playerZoneX}_${element.lane}`;
                            if (!gameState.narrativeFlags[daisKey]) { 
                                if (gameState.collectedArtifacts.includes("ART_LUMINA_LENS")) {
                                    addLogMessage(ARTIFACT_SYNERGY_LORE["ORACLE_DAIS_LUMINA_LENS_SYNERGY"], "artifact_synergy");
                                    awardXP(25); 
                                    gameState.narrativeFlags[daisKey] = true; 
                                    const bonusScraps = seededRandomInt(3, 7);
                                    gameState.resources.ancientScraps += bonusScraps;
                                    addLogMessage(`The focused vision grants you ${bonusScraps} Ancient Scraps!`, "artifact_synergy");
                                } else {
                                    addLogMessage("You stand before an Oracle's Dais. Its surface is clouded, its visions obscured. Perhaps something could clear the view...", "lore");
                                }
                            } else {
                                 addLogMessage("This Oracle's Dais has already revealed its secrets to you.", "lore");
                            }
                        }
                        break;
                    case 'H': 
                        const shrineNarrativeKey = `SHRINE_${zone.shrineLoreKey}_${gameState.playerZoneX}_${element.lane}`; 
                        if (zone.shrineLoreKey && ZONE_LORE[zone.shrineLoreKey] && !gameState.narrativeFlags[shrineNarrativeKey]) {
                            addLogMessage(ZONE_LORE[zone.shrineLoreKey], "lore");
                            awardXP(5); 
                            gameState.narrativeFlags[shrineNarrativeKey] = true;
                            if (gameState.stats.spirit >= SPIRIT_SHRINE_THRESHOLD) {
                                addLogMessage("Your spirit resonates with the shrine, granting a deeper understanding of its purpose.", "synergy");
                            }
                             if (seededRandom() < 0.2 + (gameState.stats.spirit - BASE_STAT_VALUE) * 0.05) { 
                                const healAmount = Math.floor(gameState.maxHp * (seededRandomInt(15, 30) / 100)); 
                                gameState.currentHp = Math.min(gameState.maxHp, gameState.currentHp + healAmount);
                                addLogMessage(`The shrine's aura mends some of your weariness. (+${healAmount} HP)`, "synergy");
                                playSound('levelUp', 'A4', '8n'); 
                            }
                        } else if (zone.shrineLoreKey && gameState.narrativeFlags[shrineNarrativeKey]) {
                             addLogMessage("This shrine's power feels familiar, its story already known to you.", "lore");
                        } else {
                            addLogMessage("An ancient shrine hums with faint energy nearby.", "lore");
                        }
                        if (gameState.runes.includes('Φ') && gameState.runes.includes('Δ')) {
                            const synergyKey = zone.shrineLoreKey + "_SYNERGY_" + gameState.playerZoneX + "_" + element.lane;
                            if (SHRINE_SYNERGY_LORE[zone.shrineLoreKey + "_SYNERGY"] && !gameState.narrativeFlags[synergyKey]) { 
                                addLogMessage(SHRINE_SYNERGY_LORE[zone.shrineLoreKey + "_SYNERGY"], "synergy"); 
                                awardXP(15); 
                                gameState.narrativeFlags[synergyKey] = true;
                                const bonusDust = seededRandomInt(5, 15); 
                                gameState.resources.glimmeringDust += bonusDust;
                                addLogMessage(`The shrine's deepened resonance blesses you with ${bonusDust} Glimmering Dust!`, "synergy");
                            }
                        }
                        break;
                    case 'F': 
                        if (element.lane === gameState.playerLane) { 
                            let dustForaged = seededRandomInt(1, 2);
                            if (seededRandom() < ( (gameState.stats.might - BASE_STAT_VALUE) * MIGHT_BONUS_DUST_CHANCE_PER_POINT) ) {
                                dustForaged +=1;
                                addLogMessage("Your might allows for a more bountiful forage!", "synergy");
                            }
                            gameState.resources.glimmeringDust += dustForaged;
                            addLogMessage(`You forage in the forest and find ${dustForaged} Glimmering Dust.`, "lore");
                        }
                        break;
                    case '0': 
                        if (element.lane === gameState.playerLane) {
                            const darkFeatureMessages = [
                                "You pass over a shadowed depression in the earth.",
                                "The ground here feels unnaturally cold, like a forgotten wound.",
                                "Faint, unsettling whispers seem to emanate from this dark patch of land.",
                                "These could be the ruins of something ancient, or perhaps a shallow crater."
                            ];
                            addLogMessage(darkFeatureMessages[seededRandomInt(0, darkFeatureMessages.length - 1)], "lore");
                        }
                        break;
                    case 'w': 
                        if (zone.name === "The Sky-Temple Aerie" && element.lane === gameState.playerLane) {
                            if (seededRandom() < 0.5) {
                                addLogMessage("A gust of wind makes the ancient chimes sing a faint, ethereal note... a fragment of the First Song?", "world_lore");
                                awardXP(5); 
                            } else {
                                const scrapsFound = seededRandomInt(1,3);
                                gameState.resources.ancientScraps += scrapsFound;
                                addLogMessage(`The wind chime jingles, shaking loose ${scrapsFound} Ancient Scraps.`, "lore");
                            }
                        } else if (element.lane === gameState.playerLane) { 
                             addLogMessage(`Passed by a ${getElementDescription(currentElementChar)}.`);
                        }
                        break;
                    case 'G': 
                         if (element.lane === gameState.playerLane) {
                            addLogMessage("You encounter the remains of an ancient Lumina Guardian. Its optical sensors flicker faintly.", "world_lore");
                            awardXP(10); 
                            if (seededRandom() < 0.3) { 
                                const skyShardArtifact = ARTIFACTS.find(art => art.key === "ART_LUMINA_SKY_SHARD");
                                if (skyShardArtifact && !gameState.collectedArtifacts.includes(skyShardArtifact.key)) {
                                    gameState.collectedArtifacts.push(skyShardArtifact.key);
                                    gameState.narrativeFlags[skyShardArtifact.key] = true; 
                                    addLogMessage(`<strong>${skyShardArtifact.name}</strong>: ${skyShardArtifact.description}`, "artifact");
                                    awardXP(15); 
                                }
                            }
                        }
                        break;
                    case 'A': 
                        const artifactKey = `ARTIFACT_${gameState.playerZoneX}_${element.lane}`; 
                        if (!gameState.narrativeFlags[artifactKey]) {
                            const undiscoveredArtifacts = ARTIFACTS.filter(art => !gameState.collectedArtifacts.includes(art.key));
                            if (undiscoveredArtifacts.length > 0) {
                                const randomIndex = seededRandomInt(0, undiscoveredArtifacts.length - 1);
                                const foundArtifact = undiscoveredArtifacts[randomIndex];
                                gameState.collectedArtifacts.push(foundArtifact.key);
                                gameState.narrativeFlags[artifactKey] = true; 
                                addLogMessage(`<strong>${foundArtifact.name}</strong>: ${foundArtifact.description}`, "artifact");
                                
                                let artifactXp = 15;
                                if (foundArtifact.key === "ART_TOME_MIGHT") {
                                    gameState.stats.might++;
                                    gameState.maxHp = calculateMaxHp(); 
                                    gameState.currentHp = gameState.maxHp; 
                                    addLogMessage("Your Might increases by 1! You feel tougher.", "synergy");
                                    artifactXp = 20;
                                } else if (foundArtifact.key === "ART_TOME_WITS") {
                                    gameState.stats.wits++;
                                    addLogMessage("Your Wits increase by 1! The world seems clearer.", "synergy");
                                    artifactXp = 20;
                                } else if (foundArtifact.key === "ART_TOME_RESOLVE") {
                                    gameState.stats.spirit++;
                                    gameState.maxHp = calculateMaxHp();
                                    gameState.currentHp = gameState.maxHp; 
                                    addLogMessage("Your Spirit increases by 1! Your resolve hardens.", "synergy");
                                    artifactXp = 20;
                                } else if (gameState.stats.wits >= WIT_INSIGHT_THRESHOLD) {
                                    addLogMessage("Your keen wits discern a subtle detail about its craftsmanship or origin.", "synergy");
                                }
                                awardXP(artifactXp);
                            } else {
                                addLogMessage("You sense the lingering aura of an ancient artifact, but find nothing new.", "lore");
                            }
                        }
                        break;
                    case 'N': 
                        if (!gameState.encounteredNPCs[npcSpecificKey] && element.npcType) { 
                            const npcData = NPCS[element.npcType];
                            if (npcData) {
                                const dialogueIndex = seededRandomInt(0, npcData.dialogue.length - 1);
                                const dialogue = npcData.dialogue[dialogueIndex];
                                addLogMessage(`${npcData.name}: "${dialogue}"`, "npc");
                                awardXP(8); 
                                gameState.encounteredNPCs[npcSpecificKey] = true; 

                                if (gameState.companion && COMPANION_NPC_REACTION_DIALOGUE[gameState.companion.type] && COMPANION_NPC_REACTION_DIALOGUE[gameState.companion.type][element.npcType]) {
                                    addLogMessage(COMPANION_NPC_REACTION_DIALOGUE[gameState.companion.type][element.npcType], "companion");
                                }
                            }
                        }
                        break;
                    case 'D': 
                        addLogMessage("You found a Data Crystal, shimmering with lost Lumina knowledge!", "world_lore");
                        awardXP(10); 
                        if (seededRandom() < 0.3) { 
                            const scrapsFound = seededRandomInt(1, 3);
                            gameState.resources.ancientScraps += scrapsFound;
                            addLogMessage(`The crystal crumbles, revealing ${scrapsFound} Ancient Scraps.`, "lore");
                        }
                        const undiscoveredDataLore = WORLD_LORE_FRAGMENTS.filter(lore => !gameState.narrativeFlags[lore.key] && lore.key.includes("ARCHIVES"));
                         if (undiscoveredDataLore.length > 0) {
                            const foundLore = undiscoveredDataLore[0]; 
                            addLogMessage(foundLore.text, "world_lore");
                            gameState.narrativeFlags[foundLore.key] = true;
                        }
                        break;
                    case 'L': 
                        const loreFlagKey = `LORE_${gameState.playerZoneX}_${element.lane}`;
                        if (!gameState.narrativeFlags[loreFlagKey]) {
                            const undiscoveredLore = WORLD_LORE_FRAGMENTS.filter(lore => !gameState.narrativeFlags[lore.key]); 
                            if (undiscoveredLore.length > 0) {
                                const randomIndex = seededRandomInt(0, undiscoveredLore.length - 1);
                                const foundLore = undiscoveredLore[randomIndex];
                                addLogMessage(foundLore.text, "world_lore");
                                awardXP(10); 
                                gameState.narrativeFlags[foundLore.key] = true; 
                                gameState.narrativeFlags[loreFlagKey] = true; 
                                 if (gameState.stats.wits >= WIT_INSIGHT_THRESHOLD) {
                                    addLogMessage("Your sharp mind gleans a deeper meaning from the ancient text.", "synergy");
                                }
                            } else {
                                addLogMessage("The ancient whispers offer no new secrets in this lane...", "lore");
                            }
                        }
                        break;
                    case 'P': 
                        if (!gameState.companion) {
                            const companionIndex = seededRandomInt(0, COMPANIONS.length - 1);
                            const randomCompanion = COMPANIONS[companionIndex];
                            gameState.companion = { ...randomCompanion }; 
                            addLogMessage(`A shimmering presence solidifies. You've found a companion: ${gameState.companion.name} the ${gameState.companion.type}!`, "companion");
                            awardXP(15); 
                            if (gameState.stats.spirit >= SPIRIT_COMPANION_THRESHOLD) {
                                addLogMessage(`${gameState.companion.name} seems to bond with your spirit instantly.`, "synergy");
                            } else {
                                addLogMessage(`${gameState.companion.name} lets out a soft ${gameState.companion.call}.`, "companion");
                            }
                        } else {
                            addLogMessage(`You sense another friendly presence, but ${gameState.companion.name} remains by your side.`, "lore");
                        }
                        break;
                    case '+': 
                        const epitaphIndex = seededRandomInt(0, EPITAPHS.length - 1);
                        const epitaph = EPITAPHS[epitaphIndex];
                        addLogMessage(epitaph, "grave");
                        let dustFromGraveChance = 0.15;
                        if (gameState.stats.might > BASE_STAT_VALUE) { 
                            dustFromGraveChance += (gameState.stats.might - BASE_STAT_VALUE) * MIGHT_BONUS_DUST_CHANCE_PER_POINT;
                        }
                        if (seededRandom() < dustFromGraveChance) { 
                            const dustFoundGrave = seededRandomInt(1, 3);
                            gameState.resources.glimmeringDust += dustFoundGrave;
                            addLogMessage(`A small offering of ${dustFoundGrave} Glimmering Dust was left here.`, "grave");
                        }
                        break;
                    case 'c': 
                        if (zone.name === "The Sunken Archives") {
                             addLogMessage(`Passed by a ${getElementDescription(currentElementChar)}.`); 
                        } else {
                            addLogMessage("You pass a small, charred idol, its features eroded.", "lore"); 
                        }
                        break;
                    case 's': addLogMessage("A sulfurous vent hisses nearby, releasing acrid steam.", "lore"); break;
                    case 'V': 
                        gameState.resources.voidEssence++;
                        addLogMessage("A shard of pure Void, cold and unsettling, is perceived. (+1 Void Essence)", "world_lore");
                        break;
                    case 'X': addLogMessage("A patch of warped, alien growth twitches nearby. It feels wrong.", "lore"); break;
                    case '.':
                         if (element.lane === gameState.playerLane) {
                            let dustFound = seededRandomInt(1, 5);
                             if (seededRandom() < ( (gameState.stats.might - BASE_STAT_VALUE) * MIGHT_BONUS_DUST_CHANCE_PER_POINT) ) {
                                dustFound +=1;
                            }
                            gameState.resources.glimmeringDust += dustFound;
                            addLogMessage(`Found ${dustFound} Glimmering Dust (.)`);
                            if (gameState.companion && seededRandom() < COMPANION_FIND_CHANCE) {
                                gameState.resources.glimmeringDust += 1;
                                addLogMessage(`${gameState.companion.name} sniffs out an extra Glimmering Dust!`, "companion");
                            }
                        }
                        break;
                    case 'm': 
                        if (element.lane === gameState.playerLane) {
                            addLogMessage(`Passed by a ${getElementDescription(currentElementChar)}.`);
                            if (gameState.companion && seededRandom() < COMPANION_FIND_CHANCE) {
                                gameState.resources.glimmeringDust += 1;
                                addLogMessage(`${gameState.companion.name} paws at the moss, uncovering 1 Glimmering Dust!`, "companion");
                            }
                        }
                        break;
                    case '#':
                        if (element.lane === gameState.playerLane) {
                            const scrapsFound = seededRandomInt(1, 2);
                            gameState.resources.ancientScraps += scrapsFound;
                            addLogMessage(`Found ${scrapsFound} Ancient Scraps (#)!`);
                        }
                        break;
                    case '§': 
                        if (element.lane === gameState.playerLane && !gameState.runes.includes('§')) {
                            gameState.runes.push('§'); awardXP(20); 
                            gameState.explorationSpeedMultiplier += 0.2; updateGameTickSpeed();
                            addLogMessage("Discovered Rune of Swiftness (§)! Speed increased.");
                        } else if (element.lane === gameState.playerLane) { addLogMessage("Passed an already attuned Swiftness Rune.");}
                        break;
                    case 'Φ': 
                         if (element.lane === gameState.playerLane && !gameState.runes.includes('Φ')) {
                            gameState.runes.push('Φ'); awardXP(20); 
                            addLogMessage("Discovered Rune of Perception (Φ)! Senses sharpened.");
                        } else if (element.lane === gameState.playerLane) { addLogMessage("Passed an already attuned Perception Rune.");}
                        break;
                    case 'Δ': 
                        if (element.lane === gameState.playerLane && !gameState.runes.includes('Δ')) {
                            gameState.runes.push('Δ'); awardXP(20); 
                            addLogMessage("Discovered Rune of Resilience (Δ)! Fortitude increased.");
                        } else if (element.lane === gameState.playerLane) { addLogMessage("Passed an already attuned Resilience Rune.");}
                        break;
                    case 'T': case 't': case 'Y': case 'o': 
                    case 'S': case 'b': case 'R': case 'C': 
                        addLogMessage(`Passed by a ${getElementDescription(currentElementChar)}.`);
                        break;
                    case '♦': case '◊': case '✧':
                        addLogMessage(`Passed by a glistening ${getElementDescription(currentElementChar)}.`);
                         const crystalDust = seededRandomInt(1, 2);
                        gameState.resources.glimmeringDust += crystalDust;
                        addLogMessage(`A nearby crystal sheds ${crystalDust} Glimmering Dust.`);
                        // Pristine Crystal Shard logic
                        if (gameState.narrativeFlags.quest_PristineCrystal_Offered && 
                            !gameState.narrativeFlags.hasPristineCrystalShard &&
                            !gameState.narrativeFlags.quest_PristineCrystal_Completed &&
                            seededRandom() < 0.05) { // 5% chance for pristine if quest is active
                            gameState.narrativeFlags.hasPristineCrystalShard = true;
                            addLogMessage("This crystal shard gleams with an unusual purity! It must be the kind the Runesmith sought.", "quest");
                            awardXP(20); // XP for finding the quest item
                        }
                        break;
                    case '[': case ']': case '¦': case '^':
                        addLogMessage(`Navigated near ancient ${getElementDescription(currentElementChar)}.`);
                        break;
                    case '~': /* Water - No direct encounter, handled by movement */ break;
                    case '=': /* Bridge - No direct encounter, handled by movement */ break;
                    case 'M': /* Mountain - No direct encounter, handled by movement */ break;
                }
            });
        }
        function getElementDescription(elementChar) { 
             const descriptions = {
                'T': 'charred greatwood', 't': 'burnt sapling', 'Y': 'scorched tree', 
                'w': 'swaying wind chime / smoldering bush', 'm': 'patch of ash', 'o': 'heated rock',
                '♦': 'crimson shard', '◊': 'violet crystal', '✧': 'glowing ember', '*': 'sparkling geode',
                '[': 'obsidian wall', ']': 'broken column', '¦': 'volcanic archway', '^': 'jagged peak',
                '.': 'pile of dust', '`': 'cloud of ash', ':': 'crystal speckle', "'": 'glassy shard', '%': 'twisted remnant',
                '~': 'pool of water', 'S': 'submerged shelf', 'b': 'waterlogged book/slate', 
                'c': 'flickering conduit / charred idol', 
                '=': 'sturdy bridge', 'M': 'towering mountain', 'F': 'dense forest patch', '0': 'darkened earth/ruin',
                'C': 'drifting cloud', 'R': 'temple ruin', 'G': 'Guardian fragment', 'O': "Oracle's Dais",
                'B': 'blocked path', '?': 'faded runic etching', '!': 'whispering totem',
                'L': 'repository of fragmented lore', 'H': 'sacred, time-worn shrine', 'A': 'forgotten artifact',
                'P': 'shimmering presence', '+': 'weathered grave marker', 'N': 'lone figure',
                'D': 'Data Crystal',
                'V': 'Void Shard', 'X': 'warped growth', 'E': 'Hostile Presence / Void Echo' 
            };
            return descriptions[elementChar] || 'mysterious object';
        }
        function updateGameTickSpeed() { /* ... (same) ... */ 
            gameState.gameTickMs = INITIAL_GAME_TICK_MS / gameState.explorationSpeedMultiplier;
            if (gameInterval) { 
                clearInterval(gameInterval);
                if (!gameState.isPaused && !gameState.activeDecision && gameState.currentZoneIndex !== -1) { 
                    gameInterval = setInterval(gameLoop, gameState.gameTickMs);
                }
            }
        }
        function presentDecision(decisionKey) { /* ... (same) ... */ 
            const decisionData = DECISIONS[decisionKey];
            if (!decisionData) return;
            gameState.activeDecision = decisionData;
            pauseGameForDecision(true); 
            decisionPromptText.textContent = decisionData.prompt;
            decisionButtonsContainer.innerHTML = ''; 
            decisionData.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.onclick = () => resolveDecision(option);
                decisionButtonsContainer.appendChild(button);
            });
            decisionArea.style.display = 'block';
            updateUIAccentColors(); 
        }
        function resolveDecision(chosenOption) { 
            addLogMessage(`You chose: "${chosenOption.text}"`, "decision");
            gameState.narrativeFlags[chosenOption.outcomeKey] = true;
            
            decisionArea.style.display = 'none'; 

            if (chosenOption.leaveMessage) {
                messageInputArea.style.display = 'block';
                updateUIAccentColors(); 
                return; 
            }

            gameState.activeDecision = null; 

            if (chosenOption.nextZoneIndex === -1) { 
                handleGameEnd("The journey pauses here. The path ahead is shrouded, for now...");
                return;
            }

            if (chosenOption.nextZoneIndex !== undefined) {
                gameState.currentZoneIndex = chosenOption.nextZoneIndex;
            } else {
                gameState.currentZoneIndex++; 
            }
            
            gameState.playerZoneX = 0; 
            gameState.playerLane = PLAYER_INITIAL_LANE;
            gameState.encounteredNPCs = {}; 
            
            if (gameState.currentZoneIndex >= ZONES.length) { 
                handleGameEnd("You have explored all currently known realms! The journey ends... for now.");
            } else {
                 const newZone = getCurrentZone();
                 if (newZone) { 
                    const newZoneFlag = `ENTERED_ZONE_${newZone.name.replace(/\s+/g, '_')}`;
                    if (newZone.entryLoreKey && ZONE_LORE[newZone.entryLoreKey] && !gameState.narrativeFlags[newZone.entryLoreKey]) {
                        addLogMessage(ZONE_LORE[newZone.entryLoreKey], "lore");
                        gameState.narrativeFlags[newZone.entryLoreKey] = true; 
                    }
                    if(!gameState.narrativeFlags[newZoneFlag]){ 
                        awardXP(50); 
                        gameState.narrativeFlags[newZoneFlag] = true;
                    }
                    if (gameState.companion && COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type] && COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type][newZone.name]) {
                        addLogMessage(COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type][newZone.name], "companion");
                    }
                    addLogMessage(`Venturing into ${newZone.name}...`);
                    updateUIAccentColors(); 
                    renderAll(); // Render after UI colors are set for the new zone
                    pauseGameForDecision(false); 
                 } else { 
                    handleGameEnd("An unknown path was chosen. The journey ends abruptly.");
                 }
            }
        }
        function handleFutureSelfMessageSave(fromButton) { 
            const message = futureSelfTextarea.value.trim();
            if (message && fromButton === 'save') {
                try {
                    localStorage.setItem(FUTURE_SELF_MESSAGE_KEY, message);
                    addLogMessage("Your message is woven into the echoes, awaiting your return.", "future_self");
                } catch (e) {
                    console.error("Could not save message to localStorage:", e);
                    addLogMessage("The echoes couldn't carry your message (localStorage error).", "lore");
                }
            }
            futureSelfTextarea.value = ''; 
            messageInputArea.style.display = 'none';
            gameState.activeDecision = null; 
            handleGameEnd("The journey pauses here. The path ahead is shrouded, for now...");
        }
        saveMessageButton.addEventListener('click', () => handleFutureSelfMessageSave('save'));
        skipMessageButton.addEventListener('click', () => handleFutureSelfMessageSave('skip'));
        function pauseGameForDecision(isPausing) { 
            if (isPausing) {
                clearInterval(gameInterval);
            } else {
                if (!gameState.isPaused && gameState.currentZoneIndex !== -1 && !gameState.inCombat) { 
                    gameInterval = setInterval(gameLoop, gameState.gameTickMs);
                }
            }
        }
        
        function generateCharacterSummary() {
            let summary = `=== Journey's Echo ===\n`;
            summary += `Name: ${gameState.playerName}\n`; 
            summary += `World Seed: ${gameState.initialGameSeed}\n`;
            summary += `Level: ${gameState.level} (${gameState.xp}/${gameState.xpToNextLevel} XP)\n`;
            const lastZone = ZONES[gameState.lastExploredZoneIndex !== undefined ? gameState.lastExploredZoneIndex : gameState.currentZoneIndex] || {name: "An Unknown Place"};
            summary += `Final Zone Reached: ${lastZone.name}${gameState.currentZoneIndex === -1 ? " (Journey Paused/Ended)" : ""}\n`;
            summary += `HP: ${gameState.currentHp}/${gameState.maxHp}\n`;
            summary += `Class: ${gameState.playerClass || "None"}\n`;
            summary += `\n-- Stats --\n`;
            summary += `Might (MGT): ${gameState.stats.might}\n`;
            summary += `Wits (WIT): ${gameState.stats.wits}\n`;
            summary += `Spirit (SPR): ${gameState.stats.spirit}\n`;
            summary += `\n-- Resources --\n`;
            summary += `Glimmering Dust: ${gameState.resources.glimmeringDust}\n`;
            summary += `Ancient Scraps: ${gameState.resources.ancientScraps}\n`;
            if (gameState.resources.voidEssence > 0) {
                summary += `Void Essence: ${gameState.resources.voidEssence}\n`;
            }
            summary += `\n-- Discoveries --\n`;
            if (gameState.companion) {
                summary += `Companion: ${gameState.companion.name} the ${gameState.companion.type}\n`;
            } else {
                summary += `Companion: None\n`;
            }
            summary += `Runes: ${gameState.runes.length > 0 ? gameState.runes.join(', ') : 'None'}\n`;
            summary += `Artifacts (${gameState.collectedArtifacts.length}/${ARTIFACTS.length}):\n`;
            if (gameState.collectedArtifacts.length > 0) {
                gameState.collectedArtifacts.forEach(key => {
                    const artifact = ARTIFACTS.find(art => art.key === key);
                    if (artifact) summary += `  - ${artifact.name}\n`;
                });
            } else {
                summary += `  None Found\n`;
            }
            summary += `\nMay your next path be illuminated.`;
            return summary;
        }

        function handleGameEnd(message = "You have explored all realms. The echoes of this journey will linger. What path will you walk next?") { 
            addLogMessage(message, "decision");
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null; 
            gameState.lastExploredZoneIndex = gameState.currentZoneIndex; 
            gameState.currentZoneIndex = -1; 
            pauseResumeButton.textContent = "Journey Ended";
            pauseResumeButton.disabled = true;
            upgradeSpeedButton.disabled = true;
            
            const summaryText = generateCharacterSummary();
            journeySummaryTextarea.value = summaryText;
            summaryArea.style.display = 'block';
            
            if (gameState.level >= TRANSCEND_LEVEL_THRESHOLD) {
                transcendButton.style.display = 'inline-block';
            } else {
                transcendButton.style.display = 'none';
            }
            
            updateUIAccentColors(); 
            renderAll(); 
        }

        function presentNameChoice() {
            pauseGameForDecision(true);
            decisionPromptText.textContent = "The wind whispers through the charred trees... it seems to carry a sound... a name you faintly recall. What is it? Or will you remain the Wanderer?";
            
            decisionButtonsContainer.innerHTML = ''; 

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = 'playerNameInput';
            nameInput.placeholder = 'Enter your name...';
            nameInput.maxLength = MAX_NAME_LENGTH;
            decisionButtonsContainer.appendChild(nameInput);

            const confirmNameButton = document.createElement('button');
            confirmNameButton.textContent = "This is My Name";
            confirmNameButton.onclick = () => {
                const chosenName = nameInput.value.trim();
                gameState.playerName = chosenName || "Wanderer"; // Default to Wanderer if empty
                addLogMessage(`You are known as ${gameState.playerName}. The name feels... right.`, "name-choice");
                decisionArea.style.display = 'none';
                gameState.activeDecision = null;
                renderAll();
                pauseGameForDecision(false);
            };
            decisionButtonsContainer.appendChild(confirmNameButton);
            
            decisionArea.style.display = 'block';
            updateUIAccentColors();
            nameInput.focus(); 
        }

        function gameLoop() { 
            if (gameState.isPaused || gameState.activeDecision || gameState.currentZoneIndex === -1 || gameState.inCombat) return; 

            // Name Choice Event - Should trigger before class choice if both are at same X
            if (gameState.currentZoneIndex === 0 && gameState.playerZoneX === NAME_CHOICE_EVENT_X_POS && !gameState.narrativeFlags.nameChoiceOffered) {
                presentNameChoice();
                gameState.narrativeFlags.nameChoiceOffered = true;
                return; 
            }

            // Class Choice Event
            if (gameState.currentZoneIndex === 0 && gameState.playerZoneX === CLASS_CHOICE_EVENT_X_POS && !gameState.playerClass && !gameState.narrativeFlags.classChoiceOffered) {
                presentClassChoice();
                gameState.narrativeFlags.classChoiceOffered = true; 
                return; 
            }

            gameState.playerZoneX++;
            playSound('step'); 

            if (seededRandom() < VERTICAL_MOVE_CHANCE) {
                const direction = seededRandom() < 0.5 ? -1 : 1; 
                const newLane = gameState.playerLane + direction;

                if (newLane >= 0 && newLane < NUM_LANES) {
                    const zoneForCheck = getCurrentZone(); 
                    let isTargetLaneBlocked = false;
                    if (zoneForCheck && zoneForCheck.foregroundElements[gameState.playerZoneX]) {
                        const elementsInTargetColumn = zoneForCheck.foregroundElements[gameState.playerZoneX];
                        for (const el of elementsInTargetColumn) {
                            if (el.lane === newLane && (el.char === '~' || el.char === 'M')) { 
                                isTargetLaneBlocked = true;
                                break;
                            }
                        }
                    }
                    if (!isTargetLaneBlocked) {
                        gameState.playerLane = newLane;
                    }
                }
            }
            
            const zone = getCurrentZone();
            if (!zone) { 
                if (gameInterval) clearInterval(gameInterval); 
                return;
            }

            handleEncounter(); 

            let decisionTriggered = false;
            for (const key in DECISIONS) {
                const decision = DECISIONS[key];
                let alreadyMade = false;
                decision.options.forEach(opt => { if(gameState.narrativeFlags[opt.outcomeKey]) alreadyMade = true; });

                if (decision.triggeredByZoneEnd === gameState.currentZoneIndex && 
                    gameState.playerZoneX >= zone.width && 
                    !alreadyMade ) { 
                    presentDecision(key);
                    decisionTriggered = true;
                    break;
                }
            }

            if (!decisionTriggered && gameState.playerZoneX >= zone.width) {
                addLogMessage(`Fully explored ${zone.name}!`);
                if (gameState.activeDecision === null) { 
                    gameState.currentZoneIndex++; 
                    if (gameState.currentZoneIndex >= ZONES.length) {
                        handleGameEnd();
                        return; 
                    }
                    gameState.playerZoneX = 0;
                    gameState.playerLane = PLAYER_INITIAL_LANE; 
                    gameState.encounteredNPCs = {}; 
                    const newZone = getCurrentZone();
                    const newZoneFlag = `ENTERED_ZONE_${newZone.name.replace(/\s+/g, '_')}`;
                    if (newZone.entryLoreKey && ZONE_LORE[newZone.entryLoreKey] && !gameState.narrativeFlags[newZone.entryLoreKey]) {
                        addLogMessage(ZONE_LORE[newZone.entryLoreKey], "lore");
                        gameState.narrativeFlags[newZone.entryLoreKey] = true; 
                    }
                    if(!gameState.narrativeFlags[newZoneFlag]){ 
                        awardXP(50); 
                        gameState.narrativeFlags[newZoneFlag] = true;
                    }
                    if (gameState.companion && COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type] && COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type][newZone.name]) {
                        addLogMessage(COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type][newZone.name], "companion");
                    }
                    addLogMessage(`Venturing into ${newZone.name}...`);
                    updateUIAccentColors(); 
                    renderAll();
                }
            } else {
                 renderAll();
            }
        }

        function presentClassChoice() {
            pauseGameForDecision(true);
            decisionPromptText.textContent = "A weathered shrine stands at a crossroads, its ancient magic stirring within you. It offers a path of focus. Choose your specialization:";
            decisionButtonsContainer.innerHTML = '';

            const classes = [
                { name: "The Stalwart", description: "Strength and resilience. (+1 MGT, +5 Max HP)", stat: "might", hpBonus: 5 },
                { name: "The Erudite", description: "Knowledge and insight. (+1 WIT, +5% XP Gain)", stat: "wits", xpBonus: 0.05 },
                { name: "The Mystic", description: "Spiritual attunement. (+1 SPR, better Shrine/Totem luck)", stat: "spirit" }
            ];

            classes.forEach(cls => {
                const button = document.createElement('button');
                button.textContent = `${cls.name} - ${cls.description}`;
                button.onclick = () => {
                    gameState.playerClass = cls.name;
                    addLogMessage(`You have chosen the path of ${cls.name}. ${cls.description}`, "class-choice");
                    
                    if (cls.stat === "might") gameState.stats.might++;
                    else if (cls.stat === "wits") gameState.stats.wits++;
                    else if (cls.stat === "spirit") gameState.stats.spirit++;

                    gameState.maxHp = calculateMaxHp(); 
                    gameState.currentHp = gameState.maxHp; 

                    decisionArea.style.display = 'none';
                    gameState.activeDecision = null; 
                    renderAll();
                    pauseGameForDecision(false);
                };
                decisionButtonsContainer.appendChild(button);
            });
            decisionArea.style.display = 'block';
            updateUIAccentColors();
        }


        function renderAll() { 
            renderStats();
            renderGameScreen();
            renderLog(); 
        }
        function togglePause() { 
            if (gameState.activeDecision || gameState.currentZoneIndex === -1 || gameState.inCombat) return; 
            gameState.isPaused = !gameState.isPaused;
            if (gameState.isPaused) {
                clearInterval(gameInterval);
                pauseResumeButton.textContent = "Resume";
                addLogMessage("Exploration paused.");
            } else {
                gameInterval = setInterval(gameLoop, gameState.gameTickMs);
                pauseResumeButton.textContent = "Pause";
                addLogMessage("Exploration resumed.");
            }
            renderAll(); 
        }
        function attemptUpgradeSpeed() { 
            if (gameState.currentZoneIndex === -1) return; 
            const cost = 50 * gameState.explorationSpeedMultiplier;
            if (gameState.resources.glimmeringDust >= cost) {
                gameState.resources.glimmeringDust -= Math.round(cost);
                gameState.explorationSpeedMultiplier += 0.1; 
                updateGameTickSpeed();
                addLogMessage(`Exploration speed upgraded! (New Multiplier: ${gameState.explorationSpeedMultiplier.toFixed(1)}x)`);
                renderAll();
            } else {
                addLogMessage("Not enough Glimmering Dust to upgrade speed.");
            }
        }

        let gameInterval;
        const muteButton = document.getElementById('mute-button');

        muteButton.addEventListener('click', () => {
            gameState.isMuted = !gameState.isMuted;
            muteButton.textContent = gameState.isMuted ? "Unmute Sounds" : "Mute Sounds";
            if (Tone && Tone.Destination) { 
                Tone.Destination.mute = gameState.isMuted;
            }
            if (!gameState.isMuted && Tone && Tone.context.state !== 'running') {
                Tone.start().catch(e => console.warn("Tone.start() failed on mute toggle.", e));
            }
        });

        function resetGame(isTranscendence = false, chosenLegacyStat = null) {
            if (gameInterval) clearInterval(gameInterval);

            let legacyMight = 0;
            let legacyWits = 0;
            let legacySpirit = 0;

            if (isTranscendence) {
                legacyMight = parseInt(localStorage.getItem(LEGACY_MIGHT_KEY) || '0');
                legacyWits = parseInt(localStorage.getItem(LEGACY_WITS_KEY) || '0');
                legacySpirit = parseInt(localStorage.getItem(LEGACY_SPIRIT_KEY) || '0');

                if (chosenLegacyStat === 'might') legacyMight++;
                else if (chosenLegacyStat === 'wits') legacyWits++;
                else if (chosenLegacyStat === 'spirit') legacySpirit++;

                localStorage.setItem(LEGACY_MIGHT_KEY, legacyMight.toString());
                localStorage.setItem(LEGACY_WITS_KEY, legacyWits.toString());
                localStorage.setItem(LEGACY_SPIRIT_KEY, legacySpirit.toString());
                 addLogMessage("Echoes of your past empower your new beginning...", "legacy-message");
            } 
            
            gameState.playerName = "Wanderer"; 
            gameState.playerZoneX = 0;
            gameState.playerLane = PLAYER_INITIAL_LANE;
            gameState.currentZoneIndex = 0;
            gameState.explorationSpeedMultiplier = 1; 
            gameState.resources = { glimmeringDust: 0, ancientScraps: 0, voidEssence: 0 };
            
            gameState.stats = {
                might: BASE_STAT_VALUE + (isTranscendence ? legacyMight : 0),
                wits: BASE_STAT_VALUE + (isTranscendence ? legacyWits : 0),
                spirit: BASE_STAT_VALUE + (isTranscendence ? legacySpirit : 0)
            };
            
            gameState.level = 1;
            gameState.xp = 0;
            gameState.xpToNextLevel = XP_FOR_LEVEL_2;
            gameState.playerClass = null; 
            gameState.maxHp = calculateMaxHp();
            gameState.currentHp = gameState.maxHp;
            gameState.runes = [];
            gameState.companion = null; 
            gameState.collectedArtifacts = [];
            gameState.logMessages = [];
            gameState.narrativeFlags = {}; 
            gameState.activeDecision = null;
            gameState.encounteredNPCs = {};
            gameState.inCombat = false;
            gameState.lastStepSoundTime = 0;
            gameState.lastExploredZoneIndex = 0;

            gameState.initialGameSeed = Date.now() % 2147483647; 
            initializeSeed(gameState.initialGameSeed);

            summaryArea.style.display = 'none';
            if (transcendButton) transcendButton.style.display = 'none';
            journeySummaryTextarea.value = '';
            messageInputArea.style.display = 'none'; 
            decisionArea.style.display = 'none';

            pauseResumeButton.textContent = "Pause";
            pauseResumeButton.disabled = false;
            upgradeSpeedButton.disabled = gameState.resources.glimmeringDust < (50 * gameState.explorationSpeedMultiplier);

            const startupMessageIndex = seededRandomInt(0, STARTUP_MESSAGES.length - 1);
            const selectedStartupMessage = STARTUP_MESSAGES[startupMessageIndex];
             document.getElementById('game-screen-content').innerHTML = Array(NUM_LANES).fill('').map((_, i) => {
                if (i === PLAYER_INITIAL_LANE) return ' '.repeat(Math.max(0,PLAYER_VISUAL_POSITION - Math.floor(selectedStartupMessage.length / 2))) + selectedStartupMessage;
                return ' '.repeat(SCREEN_WIDTH);
            }).join('\n');
            addLogMessage(selectedStartupMessage, "startup"); 
            addLogMessage(`New World Seed: ${gameState.initialGameSeed}`, "seed"); 
            if (isTranscendence && (legacyMight > 0 || legacyWits > 0 || legacySpirit > 0)) {
                addLogMessage(`Legacy Stats: MGT+${legacyMight}, WIT+${legacyWits}, SPR+${legacySpirit}`, "legacy-message");
            }


            const initialZone = getCurrentZone();
            if (initialZone && initialZone.entryLoreKey && ZONE_LORE[initialZone.entryLoreKey] && !gameState.narrativeFlags[initialZone.entryLoreKey]) {
                addLogMessage(ZONE_LORE[initialZone.entryLoreKey], "lore");
                gameState.narrativeFlags[initialZone.entryLoreKey] = true; 
                awardXP(50); 
            }
            
            updateUIAccentColors(); 
            renderAll(); 
            
            gameInterval = setInterval(gameLoop, gameState.gameTickMs);
        }

        
        function handleTranscendence() {
            pauseGameForDecision(true); 
            summaryArea.style.display = 'none'; 

            decisionPromptText.textContent = "Your essence echoes. Choose a legacy to carry forward:";
            decisionButtonsContainer.innerHTML = '';
            const legacyOptions = [
                { text: "+1 Permanent Might", stat: "might" },
                { text: "+1 Permanent Wits", stat: "wits" },
                { text: "+1 Permanent Spirit", stat: "spirit" }
            ];

            legacyOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.onclick = () => {
                    addLogMessage(`You chose to carry forward an echo of ${option.stat}.`, "legacy-message");
                    decisionArea.style.display = 'none';
                    resetGame(true, option.stat); 
                };
                decisionButtonsContainer.appendChild(button);
            });
            decisionArea.style.display = 'block';
            updateUIAccentColors(); 
        }


        if(newJourneyButton) { 
            newJourneyButton.addEventListener('click', () => resetGame(false)); 
        }
        if(transcendButton) { 
            transcendButton.addEventListener('click', handleTranscendence);
        }


        document.addEventListener('DOMContentLoaded', () => { 
            initializeSounds(); 
            
            gameState.initialGameSeed = Date.now() % 2147483647; 
            initializeSeed(gameState.initialGameSeed);
            
            let initialLegacyMight = parseInt(localStorage.getItem(LEGACY_MIGHT_KEY) || '0');
            let initialLegacyWits = parseInt(localStorage.getItem(LEGACY_WITS_KEY) || '0');
            let initialLegacySpirit = parseInt(localStorage.getItem(LEGACY_SPIRIT_KEY) || '0');

            gameState.stats.might = BASE_STAT_VALUE + initialLegacyMight;
            gameState.stats.wits = BASE_STAT_VALUE + initialLegacyWits;
            gameState.stats.spirit = BASE_STAT_VALUE + initialLegacySpirit;
            
            gameState.maxHp = calculateMaxHp(); 
            gameState.currentHp = gameState.maxHp; 


            const startupMessageIndex = seededRandomInt(0, STARTUP_MESSAGES.length - 1);
            const selectedStartupMessage = STARTUP_MESSAGES[startupMessageIndex];
            document.getElementById('game-screen-content').innerHTML = Array(NUM_LANES).fill('').map((_, i) => {
                if (i === PLAYER_INITIAL_LANE) return ' '.repeat(Math.max(0,PLAYER_VISUAL_POSITION - Math.floor(selectedStartupMessage.length / 2))) + selectedStartupMessage;
                return ' '.repeat(SCREEN_WIDTH);
            }).join('\n');
            addLogMessage(selectedStartupMessage, "startup"); 
            addLogMessage(`World Seed: ${gameState.initialGameSeed}`, "seed"); 
            if (initialLegacyMight > 0 || initialLegacyWits > 0 || initialLegacySpirit > 0) {
                 addLogMessage(`Legacy Echoes whisper: MGT+${initialLegacyMight}, WIT+${initialLegacyWits}, SPR+${initialLegacySpirit}`, "legacy-message");
            }


            try {
                const savedMessage = localStorage.getItem(FUTURE_SELF_MESSAGE_KEY);
                if (savedMessage) {
                    addLogMessage("A message from a past journey echoes: \"" + savedMessage + "\"", "future_self");
                    localStorage.removeItem(FUTURE_SELF_MESSAGE_KEY);
                }
            } catch (e) {
                console.warn("Could not access localStorage for future self message:", e);
            }
            
            const initialZone = getCurrentZone();
            if (initialZone && initialZone.entryLoreKey && ZONE_LORE[initialZone.entryLoreKey] && !gameState.narrativeFlags[initialZone.entryLoreKey]) {
                addLogMessage(ZONE_LORE[initialZone.entryLoreKey], "lore");
                gameState.narrativeFlags[initialZone.entryLoreKey] = true; 
                awardXP(50); 
            }
            if (initialZone && gameState.companion && COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type] && COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type][initialZone.name]) {
                addLogMessage(COMPANION_ZONE_ENTRY_DIALOGUE[gameState.companion.type][initialZone.name], "companion");
            }

            updateUIAccentColors(); 
            renderAll(); 
            
            pauseResumeButton.addEventListener('click', togglePause);
            upgradeSpeedButton.addEventListener('click', attemptUpgradeSpeed);

            if (!gameState.isPaused && gameState.currentZoneIndex !== -1) {
                 gameInterval = setInterval(gameLoop, gameState.gameTickMs);
            } else if (gameState.currentZoneIndex === -1) {
                pauseResumeButton.textContent = "Journey Ended";
                pauseResumeButton.disabled = true;
                upgradeSpeedButton.disabled = true;
            }
        });

    </script>
</body>
</html>
