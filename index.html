<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wayfinder: Echoes of the Void</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Force body to be invisible immediately */
        body {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in; /* Smooth fade-in */
            background-color: #050510; /* Match your dark theme default to prevent white flash */
        }
        
        /* Ensure the fade-in class overrides the default */
        body.loaded {
            opacity: 1;
            visibility: visible;
        }
    </style>
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            // Create a terrifyingly visible error box
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: #000; color: #FF0000; z-index: 9999;
                padding: 40px; font-family: monospace; white-space: pre-wrap;
                border: 5px solid #FF0000; overflow: auto;
            `;
            
            div.innerHTML = `
                <h1 style="font-size:40px; margin-bottom:20px;">CRITICAL SYSTEM FAILURE</h1>
                <h2 style="color:#FFF;">${msg}</h2>
                <p style="color:#888;">Location: ${url.split('/').pop()}:${lineNo}:${columnNo}</p>
                <div style="border-top:1px solid #333; margin-top:20px; padding-top:20px; color:#AAA;">
                    ${error ? error.stack : 'No stack trace available.'}
                </div>
                <button onclick="location.reload()" style="margin-top:40px; padding:20px; background:#300; color:#F00; border:1px solid #F00; cursor:pointer;">ATTEMPT SYSTEM REBOOT</button>
            `;
            document.body.appendChild(div);
            return false;
        };
    </script>
</head>
<body class="crt">
    <script>
    // 1. Immediate Theme Check (Run before visual render)
    (function() {
        const savedTheme = localStorage.getItem('wayfinderTheme');
        const systemLight = window.matchMedia('(prefers-color-scheme: light)').matches;
        
        let isLight = false;
        if (savedTheme === 'light') isLight = true;
        else if (!savedTheme && systemLight) isLight = true;

        // 2. Set the "Curtain" Color on the HTML tag immediately
        // This ensures the background is already White (or Dark) before the fade-in starts.
        if (isLight) {
            document.documentElement.style.backgroundColor = '#FFFFFF';
        } else {
            document.documentElement.style.backgroundColor = '#050510';
        }
    })();
</script>

<style>
    /* Force body to be invisible immediately */
    body {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-in;
        /* REMOVED background-color here! We let the script above handle it. */
    }
    
    /* When JS adds this class, the content fades in */
    body.loaded {
        opacity: 1;
        visibility: visible;
    }
</style>

    <div id="titleOverlay">
        <div id="titleContainer">
            <h1 class="game-title">Wayfinder</h1>
            <p class="subtitle">Echoes of the Void</p>
            
            <div id="systemBoot" style="margin-top:20px; color:var(--accent-color); font-family:var(--main-font); animation: blink 1s infinite;">
                SYSTEM INITIALIZING...
            </div>
            
            <div id="saveSelectContainer" style="display:none;">
                <div class="save-list-header">SELECT COMMANDER</div>
                <div id="saveList" class="save-list">
                    </div>
                
                <div class="title-controls">
                    <button id="showNewGameBtn" class="title-button small-btn">New Campaign</button>
                    <label class="checkbox-container">
                        <input type="checkbox" id="autoLoginCheck">
                        <span class="checkmark"></span>
                        Auto-Login
                    </label>
                </div>
            </div>

            <div id="newGameContainer" style="display:none;">
                <div class="player-customization">
                    <div class="pfp-selector">
                        <button id="prevPfpBtn" class="pfp-arrow-btn">&lt;</button>
                        <img src="assets/pfp_01.png" id="pfpImage" alt="Profile">
                        <button id="nextPfpBtn" class="pfp-arrow-btn">&gt;</button>
                    </div>
                    <input type="text" id="playerNameInput" class="seed-input" placeholder="Captain Name">
                </div>

                <p class="seed-prompt-text">Enter World Seed (Optional)</p>
                <input type="text" id="seedInput" class="seed-input" placeholder="Random Seed">
                
                <div class="title-buttons">
                    <button id="startButton" class="title-button">Initialize Systems</button>
                    <button id="backToSavesBtn" class="title-button small-btn" style="display:none;">Back to Saves</button>
                </div>

            </div>
        </div>
    </div>

    <div id="app-container">
        
        <header id="top-hud">
            <div class="hud-group left">
                <div class="hud-stat">
                    <span class="label">HULL</span>
                    <div class="bar-container"><div id="hullBar" class="bar-fill hull"></div></div>
                    <span id="hullVal" class="value-text">100%</span>
                </div>
                <div class="hud-stat">
                    <span class="label">SHLD</span>
                    <div class="bar-container"><div id="shieldBar" class="bar-fill shield"></div></div>
                    <span id="shieldVal" class="value-text">100%</span>
                </div>
                <div class="hud-stat">
                    <span class="label">FUEL</span>
                    <div class="bar-container"><div id="fuelBar" class="bar-fill fuel"></div></div>
                    <span id="fuelVal" class="value-text">100%</span>
                </div>
            </div>

            <div class="hud-group center">
                <span id="sectorNameStat" class="sector-title">DEEP SPACE</span>
                <span id="sectorCoordsStat" class="coords">(0,0)</span>
            </div>

            <div class="hud-group right">
                <div class="hud-stat compact">
                    <span class="label">CR</span>
                    <span id="creditsStat" class="value-text gold">0</span>
                </div>
                <div class="hud-stat compact">
                    <span class="label">CARGO</span>
                    <span id="cargoStat" class="value-text">0/0</span>
                </div>
                <button id="menuToggle" class="icon-btn">SYS</button>
            </div>
        </header>

        <div id="systemMenu" class="hidden">
            <div class="sys-header">COMMANDER DATA</div>
            
            <div id="sys-stats-display">
                LVL: <span id="menuLevel">1</span> <span style="color:#555">|</span> XP: <span id="menuXP">0</span><br>
               SHIP: <span id="menuShip">Light Freighter</span><br>
               REP: <span id="menuRep">Neutral</span>
            </div>

            <button id="saveButton" class="sys-btn">Manual Save</button>
            <button id="loadButton" class="sys-btn">Load Manual Save</button>
            <button id="mainMenuButton" class="sys-btn">Main Menu</button>
            <button id="themeButton" class="sys-btn">Toggle Theme</button>
            <button id="soundButton" class="sys-btn">Mute Audio</button>
            <div id="versionInfo">v0.9.5</div>
         </div>

        <main id="main-view">
            <div id="statusOverlay" class="status-overlay"></div>

            <div class="side-border left"></div>
            <div class="side-border right"></div>

            <canvas id="gameCanvas"></canvas>

            <div id="mobileControls">
                <div class="dpad-row">
                    <button id="btnUp" class="dpad-btn">‚ñ≤</button>
                </div>
                <div class="dpad-row">
                    <button id="btnLeft" class="dpad-btn">‚óÄ</button>
                    <button id="btnWait" class="dpad-btn" style="font-size:10px;">WAIT</button>
                    <button id="btnRight" class="dpad-btn">‚ñ∂</button>
                </div>
                <div class="dpad-row">
                    <button id="btnDown" class="dpad-btn">‚ñº</button>
                </div>
            </div>

            <div id="gameOverOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(20,0,0,0.9); z-index:4000; align-items:center; justify-content:center;">
    <div class="confirm-window" style="border-color: var(--danger); box-shadow: 0 0 50px rgba(255, 0, 0, 0.2);">
        <div class="confirm-header" style="background: var(--danger); color: #000; animation: blink 0.5s infinite;">SIGNAL LOST</div>
        <div class="confirm-body">
            <h1 style="color: var(--danger); font-family: var(--title-font); font-size: 32px; margin: 10px 0;">CRITICAL FAILURE</h1>
            <p id="deathReason" style="font-size: 16px; color: #fff; margin-bottom: 20px;">Cause: Unknown</p>
            
            <div class="trade-math-area" style="border-color: #552222;">
                <div class="trade-stat-row"><span>Final Level:</span> <span id="deathLevel" class="value-text" style="color:#fff"></span></div>
                <div class="trade-stat-row"><span>Credits Lost:</span> <span id="deathCreditPenalty" class="value-text" style="color:var(--danger)"></span></div>
            </div>

            <p style="font-size: 12px; color: #888; margin-top: 15px;">Emergency Clone Protocol Available.</p>
            
            <div class="confirm-actions" style="flex-direction: column; gap: 10px;">
                <button id="respawnBtn" class="action-button" onclick="respawnPlayer()">INITIATE CLONE (RESPAWN)</button>
                <button class="action-button danger-btn" onclick="quitToTitle()">TERMINATE SIGNAL (QUIT)</button>
            </div>
        </div>
    </div>
</div>
<div id="genericModalOverlay" style="display:none;">
        <div class="trade-window" style="height:auto; min-height:300px;">
            <div class="trade-header">
                <span id="genericModalTitle">INFORMATION</span>
                <button onclick="closeGenericModal()" class="icon-btn">X</button>
            </div>
            <div id="genericModalContent" class="station-body" style="padding:20px; overflow-y:auto; max-height:60vh;">
                </div>
        </div>
    </div>

            <div id="stationOverlay" style="display:none;">
                <div class="trade-window" style="max-width: 800px;">
                    <div class="trade-header">
                        <span id="stationNameTitle">STATION NAME</span>
                        <button onclick="closeStationView()" class="icon-btn">X</button>
                    </div>
                    <div class="station-body">
                        <div class="station-visual-panel">
                            <canvas id="stationCanvas" width="200" height="200"></canvas>
                            <div id="stationFactionBadge" class="station-badge">FACTION</div>
                            <p id="stationDescText" class="station-desc">Station description goes here...</p>
                        </div>
                        
                        <div class="station-menu-grid">
                            <button class="station-action-btn" onclick="openTradeModal('buy')">
                                <div class="btn-icon">üõí</div>
                                <div class="btn-label">Marketplace<br><span class="btn-sub">Buy Commodities</span></div>
                            </button>
                            <button class="station-action-btn" onclick="openTradeModal('sell')">
                                <div class="btn-icon">üí∞</div>
                                <div class="btn-label">Sell Cargo<br><span class="btn-sub">Offload Goods</span></div>
                            </button>
                            <button class="station-action-btn" onclick="displayMissionBoard()">
                                <div class="btn-icon">üìú</div>
                                <div class="btn-label">Mission Board<br><span class="btn-sub">Contracts & Bounties</span></div>
                            </button>
                            <button class="station-action-btn" onclick="displayShipyard()">
                                <div class="btn-icon">üöÄ</div>
                                <div class="btn-label">Shipyard<br><span class="btn-sub">Buy New Hulls</span></div>
                            </button>
                            <button class="station-action-btn" onclick="displayOutfittingScreen()">
                                <div class="btn-icon">‚öôÔ∏è</div>
                                <div class="btn-label">Outfitting<br><span class="btn-sub">Upgrades & Parts</span></div>
                            </button>
                            <button class="station-action-btn" onclick="visitCantina()">
                                <div class="btn-icon">üç∏</div>
                                <div class="btn-label">Cantina<br><span class="btn-sub">Rumors & Rest (10c)</span></div>
                            </button>
                            <button class="station-action-btn repair-btn" onclick="repairShip()">
                                <div class="btn-icon">üîß</div>
                                <div class="btn-label">Repair Hull<br><span class="btn-sub" id="repairCostLabel">Check Cost</span></div>
                            </button>
                            <button class="station-action-btn leave-btn" onclick="closeStationView()">
                                <div class="btn-icon">üëã</div>
                                <div class="btn-label">Undock<br><span class="btn-sub">Return to Space</span></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="derelictOverlay" style="display:none;">
                <div class="trade-window" style="max-width: 800px; border-color: #FF5555;">
                    <div class="trade-header" style="background: rgba(50, 0, 0, 0.8);">
                        <span id="derelictNameTitle" style="color: #FF5555;">UNKNOWN WRECKAGE</span>
                        <button onclick="closeDerelictView()" class="icon-btn">X</button>
                    </div>
                    <div id="derelictInfoBar" class="modal-info-bar"></div>
                    
                    <div class="station-body">
                        <div class="station-visual-panel">
                            <canvas id="derelictCanvas" width="200" height="200"></canvas>
                            <div id="derelictClassBadge" class="station-badge" style="color:#FF5555; border-color:#552222;">CLASS: UNKNOWN</div>
                            <p id="derelictDescText" class="station-desc">Sensors detect hull breaches and faint energy signatures.</p>
                        </div>
                        
                        <div class="station-menu-grid">
                            <button class="station-action-btn" onclick="handleDerelictAction('SCAN')">
                                <div class="btn-icon">üì°</div>
                                <div class="btn-label">Remote Scan<br><span class="btn-sub">Safe. Gain Data (XP).</span></div>
                            </button>
                            
                            <button class="station-action-btn" onclick="handleDerelictAction('SALVAGE')">
                                <div class="btn-icon">üèóÔ∏è</div>
                                <div class="btn-label">Scrap Salvage<br><span class="btn-sub">Low Risk. Gather raw materials.</span></div>
                            </button>
                            
                            <button class="station-action-btn" style="border-left-color: #FF5555;" onclick="handleDerelictAction('BREACH')">
                                <div class="btn-icon">üí•</div>
                                <div class="btn-label">Breach Hull<br><span class="btn-sub" style="color:#F88">High Risk. Valuable Cargo.</span></div>
                            </button>
                            
                            <button class="station-action-btn leave-btn" onclick="closeDerelictView()">
                                <div class="btn-icon">üöÄ</div>
                                <div class="btn-label">Leave Area<br><span class="btn-sub">Ignore the wreckage.</span></div>
                            </button>
                        </div>
                    </div>
                    
                    <div id="derelictLog" style="padding: 10px; font-family: monospace; font-size: 12px; height: 80px; overflow-y: auto;">
                        > Link established with derelict vessel...
                    </div>
                </div>
            </div>

            <div id="xerxesOverlay" style="display:none;">
                <div class="trade-window" style="max-width: 800px; border-color: #9933FF; box-shadow: 0 0 30px rgba(138, 43, 226, 0.3);">
                    <div class="trade-header" style="background: rgba(30, 0, 60, 0.95); border-bottom: 1px solid #9933FF;">
                        <span style="color: #DDA0DD; font-weight:900; letter-spacing:3px;">XERXES PRIME</span>
                        <button onclick="closeXerxesView()" class="icon-btn" style="color:#DDA0DD; border-color:#9933FF;">X</button>
                    </div>
                    
                    <div id="xerxesInfoBar" class="modal-info-bar" style="border-bottom: 1px solid #551188;"></div>
                    
                    <div class="station-body" style="background: #050010;">
                        <div class="station-visual-panel" style="background: #080015; border-right: 1px solid #551188;">
                            <canvas id="xerxesCanvas" width="200" height="200" style="border-color:#551188; box-shadow: 0 0 20px rgba(138, 43, 226, 0.2);"></canvas>
                            <div class="station-badge" style="background:#220044; color:#DDA0DD; border-color:#9933FF;">ROGUE WORLD</div>
                            <p class="station-desc" style="color:#AA88CC; font-style:italic;">
                                "A sunless world drifting in the void. Ancient geothermal spires pierce the eternal night, lighting a city of thieves and exiles."
                            </p>
                        </div>
                        
                        <div id="xerxesMenu" class="station-menu-grid">
                            </div>
                    </div>
                    
                    <div id="xerxesLog" style="padding: 10px; background: rgba(20, 0, 40, 0.6); color: #DDA0DD; font-family: monospace; font-size: 12px; height: 80px; overflow-y: auto; border-top: 1px solid #551188;">
                        > Atmosphere toxic. Docking clamps engaged at The Spire.
                    </div>
                </div>
            </div>

            <div id="genericModalOverlay" style="display:none;">
                <div class="trade-window">
                    <div class="trade-header">
                        <span id="genericModalTitle">TITLE</span>
                        <button onclick="closeGenericModal()" class="icon-btn">X</button>
                    </div>
                    <div id="genericInfoBar" class="modal-info-bar"></div>
                    <div class="trade-body">
                        <div id="genericModalList" class="trade-list-container"></div>
                        <div id="genericModalDetails" class="trade-panel-right">
                            <h3 id="genericDetailTitle">SELECT ITEM</h3>
                            <div id="genericDetailContent"></div>
                            <div class="trade-btn-group" id="genericModalActions"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="cargoOverlay" style="display:none;">
                <div class="trade-window"> 
                    <div class="trade-header">
                        <span>CARGO MANIFEST</span>
                        <button id="closeCargoBtn" class="icon-btn">X</button>
                    </div>
                    <div id="cargoInfoBar" class="modal-info-bar"></div>
                    <div class="trade-body">
                        <div id="cargoList" class="trade-list-container"></div>
                        
                        <div id="cargoDetails" class="trade-panel-right">
                            <h3 id="cargoItemName">SELECT CARGO</h3>
                            <p id="cargoItemDesc" style="font-size:12px; color:#888;">Select an item to inspect or jettison.</p>
                            
                            <div class="trade-math-area">
                                <div class="trade-stat-row"><span>Quantity:</span> <span id="cargoItemQty" class="value-text">0</span></div>
                                <div class="trade-stat-row"><span>Base Value:</span> <span id="cargoItemVal" class="value-text">0c</span></div>
                            </div>

                            <div style="margin-top:auto">
                                <p style="color:#FF4444; font-size:11px; margin-bottom:5px;">WARNING: Jettisoned cargo is lost forever.</p>
                                <button id="jettisonBtn" class="action-button" style="border-color:#FF4444; color:#FF4444;" disabled>JETTISON 1 UNIT</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="systemView" class="view-panel"></div>
            <div id="planetView" class="view-panel"></div>
            <div id="combatView" class="view-panel"></div>
            
            <div id="codexOverlay">
                <div class="codex-header">
                    <span>GALACTIC DATABASE</span>
                    <button id="codexCloseButton">&times;</button>
                </div>
                <div id="codexContent">
                    <div id="codexCategories"></div>
                    <div id="codexEntries"></div>
                    <div id="codexEntryText">Select an entry...</div>
                </div>
            </div>
        </main>

        <footer id="bottom-deck">
            <div id="messageArea" class="log-panel">System Initialized...</div>
            <div id="context-panel">
                <div id="mission-tracker" class="mission-box">
                    <span class="label">MISSION</span>
                    <span id="missionText" class="value">No Active Mission</span>
                </div>
                <div id="contextual-actions" class="action-row"></div>
            </div>
        </footer>
    </div>

    <div style="display:none;">
        <span id="levelXpStat"></span><span id="shipClassStat"></span>
        <span id="notorietyStat"></span><span id="stardateStat"></span>
        <span id="fuelStat"></span><span id="shieldsStat"></span><span id="hullStat"></span>
    </div>

    <div id="confirmationOverlay" style="display:none;">
        <div class="confirm-window">
            <div class="confirm-header">! COMMAND AUTHORIZATION REQUIRED !</div>
            <div class="confirm-body">
                <p id="confirmMessage">Are you sure?</p>
                <div class="confirm-actions">
                    <button id="confirmYesBtn" class="action-button danger-btn">CONFIRM DELETION</button>
                    <button id="confirmNoBtn" class="action-button">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="config.js"></script>
    <script src="items.js"></script>
    <script src="biomes.js"></script>
    <script src="ships.js"></script>
    <script src="locations.js"></script>
    <script src="rumors.js"></script>
    <script src="lore.js"></script>

    <script src="perks.js"></script>

    <script src="audio.js"></script>
    
    <script src="script.js"></script>

    <div id="damageFlash" class="damage-flash"></div>
    
</body>
</html>
