<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedural Fantasy Map Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IM Fell English', serif;
            background-color: #f5f1e8; /* An off-white, parchment-like color */
        }
        .title-font {
             font-family: 'IM Fell English', serif;
        }
        .control-group {
            background-color: rgba(255,255,255,0.6);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d4c8b0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #mapCanvas {
            cursor: zoom-in;
        }
        /* Style for the notes area */
        #notesArea {
            background-color: #fdfaf2;
            border: 1px solid #d4c8b0;
            line-height: 1.8;
            font-family: 'IM Fell English', serif;
        }
    </style>
</head>
<body class="bg-[#f5f1e8] text-[#4a3f35] antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="mb-6 text-center">
            <h1 class="text-4xl md:text-5xl font-bold title-font">Digital Cartographer's Desk</h1>
            <p class="text-lg mt-2">Explore worlds, and chronicle your discoveries in the field notes.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <!-- Left Column: Map and Controls -->
            <div class="lg:col-span-2">
                <!-- Canvas for our map -->
                <div class="bg-white shadow-2xl rounded-lg overflow-hidden border-4 border-[#d4c8b0]">
                    <canvas id="mapCanvas"></canvas>
                </div>

                <!-- Controls -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                    <div class="control-group flex flex-col items-center justify-center h-full gap-3">
                        <button id="generateButton" class="bg-[#6b5b4b] text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-[#5a4d3f] transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#a89984]">
                            Conjure New World
                        </button>
                        <button id="resetViewButton" class="bg-gray-200 text-[#6b5b4b] font-bold py-2 px-6 rounded-lg shadow-md hover:bg-gray-300 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#a89984]">
                            Reset View
                        </button>
                    </div>
                    
                    <div class="control-group flex flex-col gap-3">
                         <div class="flex items-center justify-between gap-2">
                            <label for="themeSelector" class="font-semibold text-sm">Theme:</label>
                            <select id="themeSelector" class="bg-white border border-[#a89984] rounded-md py-1 px-2 accent-[#6b5b4b] text-sm">
                                <option value="earth">Earth-like</option>
                                <option value="parchment">Parchment Map</option>
                                <option value="verdant">Verdant World</option>
                                <option value="volcanic">Volcanic Hellscape</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <span class="font-semibold text-sm">Zoom Level:</span>
                            <span id="zoomLevelDisplay" class="font-mono text-sm bg-white px-2 py-1 rounded">1.00x</span>
                        </div>
                         <!-- NEW: Wrapping World Checkbox -->
                        <div class="flex items-center justify-start gap-2 pt-1">
                            <input type="checkbox" id="wrappingCheckbox" class="h-4 w-4 accent-[#6b5b4b]">
                            <label for="wrappingCheckbox" class="font-semibold text-sm">Wrapping World</label>
                        </div>
                    </div>

                     <div class="control-group flex flex-col gap-3">
                        <div class="flex items-center justify-between gap-2">
                            <label for="octavesSlider" class="font-semibold text-sm">Detail (Octaves):</label>
                            <input type="range" id="octavesSlider" min="1" max="8" value="5" class="w-48 accent-[#6b5b4b]">
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <label for="shapingSlider" class="font-semibold text-sm">Landmass Shaping:</label>
                            <input type="range" id="shapingSlider" min="1.0" max="3.0" value="1.5" step="0.1" class="w-48 accent-[#6b5b4b]">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Notes -->
            <div class="lg:col-span-1 mt-8 lg:mt-0">
                <div class="control-group p-4 h-full">
                    <h2 class="text-2xl title-font border-b-2 border-[#d4c8b0] pb-2 mb-4">Field Notes</h2>
                    <textarea id="notesArea" class="w-full h-96 lg:h-[calc(100%-40px)] p-3 text-lg rounded-md focus:outline-none focus:ring-2 focus:ring-[#a89984] resize-none" placeholder="Discovered a large continent in the west, marked by twin mountain ranges..."></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <!-- EMBEDDED LIBRARY -->
    <script>
    (function (global, factory) {
        typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
        typeof define === 'function' && define.amd ? define(factory) :
        (global.SimplexNoise = factory());
    }(this, (function () { 'use strict';const F3=1/3,G3=1/6,F2=.5*(Math.sqrt(3)-1),G2=(3-Math.sqrt(3))/6,grad3=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);function buildPermutationTable(random){const p=new Uint8Array(256);for(let i=0;i<256;i++){p[i]=i}for(let i=0;i<255;i++){const r=i+~~(random()*(256-i)),aux=p[i];p[i]=p[r],p[r]=aux}const perm=new Uint8Array(512);for(let i=0;i<512;i++){perm[i]=p[i&255]}return perm}class SimplexNoise{constructor(randomOrSeed){let random;if(typeof randomOrSeed=='function'){random=randomOrSeed}else if(randomOrSeed){let seed=randomOrSeed;random=function(){seed=(seed*9301+49297)%233280;return seed/233280}}else{random=Math.random}this.p=buildPermutationTable(random);this.perm=new Uint8Array(512);this.permMod12=new Uint8Array(512);for(let i=0;i<512;i++){this.perm[i]=this.p[i&255];this.permMod12[i]=this.perm[i]%12}}noise2D(x,y){const perm=this.perm,permMod12=this.permMod12;let n0=0,n1=0,n2=0;const s=(x+y)*F2,i=Math.floor(x+s),j=Math.floor(y+s),t=(i+j)*G2,X0=i-t,Y0=j-t,x0=x-X0,y0=y-Y0;let i1,j1;x0>y0? (i1=1,j1=0):(i1=0,j1=1);const x1=x0-i1+G2,y1=y0-j1+G2,x2=x0-1+2*G2,y2=y0-1+2*G2,ii=i&255,jj=j&255;let gi0=permMod12[ii+perm[jj]],t0=.5-x0*x0-y0*y0;if(t0>0){t0*=t0;n0=t0*t0*(grad3[gi0*3]*x0+grad3[gi0*3+1]*y0)}let gi1=permMod12[ii+i1+perm[jj+j1]],t1=.5-x1*x1-y1*y1;if(t1>0){t1*=t1;n1=t1*t1*(grad3[gi1*3]*x1+grad3[gi1*3+1]*y1)}let gi2=permMod12[ii+1+perm[jj+1]],t2=.5-x2*x2-y2*y2;if(t2>0){t2*=t2;n2=t2*t2*(grad3[gi2*3]*x2+grad3[gi2*3+1]*y2)}return 70*(n0+n1+n2)}noise3D(x,y,z){const perm=this.perm,permMod12=this.permMod12;let n0,n1,n2,n3;const s=(x+y+z)*F3,i=Math.floor(x+s),j=Math.floor(y+s),k=Math.floor(z+s),t=(i+j+k)*G3,X0=i-t,Y0=j-t,Z0=k-t,x0=x-X0,y0=y-Y0,z0=z-Z0;let i1,j1,k1,i2,j2,k2;if(x0>=y0){if(y0>=z0){i1=1,j1=0,k1=0,i2=1,j2=1,k2=0}else if(x0>=z0){i1=1,j1=0,k1=0,i2=1,j2=0,k2=1}else{i1=0,j1=0,k1=1,i2=1,j2=0,k2=1}}else{if(y0<z0){i1=0,j1=0,k1=1,i2=0,j2=1,k2=1}else if(x0<z0){i1=0,j1=1,k1=0,i2=0,j2=1,k2=1}else{i1=0,j1=1,k1=0,i2=1,j2=1,k2=0}}const x1=x0-i1+G3,y1=y0-j1+G3,z1=z0-k1+G3,x2=x0-i2+2*G3,y2=y0-j2+2*G3,z2=z0-k2+2*G3,x3=x0-1+3*G3,y3=y0-1+3*G3,z3=z0-1+3*G3,ii=i&255,jj=j&255,kk=k&255;let t0=.6-x0*x0-y0*y0-z0*z0;if(t0<0)n0=0;else{const gi0=permMod12[ii+perm[jj+perm[kk]]];t0*=t0;n0=t0*t0*(grad3[gi0*3]*x0+grad3[gi0*3+1]*y0+grad3[gi0*3+2]*z0)}let t1=.6-x1*x1-y1*y1-z1*z1;if(t1<0)n1=0;else{const gi1=permMod12[ii+i1+perm[jj+j1+perm[kk+k1]]];t1*=t1;n1=t1*t1*(grad3[gi1*3]*x1+grad3[gi1*3+1]*y1+grad3[gi1*3+2]*z1)}let t2=.6-x2*x2-y2*y2-z2*z2;if(t2<0)n2=0;else{const gi2=permMod12[ii+i2+perm[jj+j2+perm[kk+k2]]];t2*=t2;n2=t2*t2*(grad3[gi2*3]*x2+grad3[gi2*3+1]*y2+grad3[gi2*3+2]*z2)}let t3=.6-x3*x3-y3*y3-z3*z3;if(t3<0)n3=0;else{const gi3=permMod12[ii+1+perm[jj+1+perm[kk+1]]];t3*=t3;n3=t3*t3*(grad3[gi3*3]*x3+grad3[gi3*3+1]*y3+grad3[gi3*3+2]*z3)}return 32*(n0+n1+n2+n3)}}return SimplexNoise})));
    </script>

    <!-- Main application script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('mapCanvas');
            if (!canvas) { return; }
            const ctx = canvas.getContext('2d');
            const generateButton = document.getElementById('generateButton');
            const resetViewButton = document.getElementById('resetViewButton');
            const themeSelector = document.getElementById('themeSelector');
            const octavesSlider = document.getElementById('octavesSlider');
            const shapingSlider = document.getElementById('shapingSlider');
            const zoomLevelDisplay = document.getElementById('zoomLevelDisplay');
            const notesArea = document.getElementById('notesArea');
            const wrappingCheckbox = document.getElementById('wrappingCheckbox');

            const TILE_SIZE = 2;
            const INITIAL_NOISE_SCALE = 80; 
            let noiseScale = INITIAL_NOISE_SCALE;
            let octaves = 5;
            let landShapingPower = 1.5;
            let offsetX = 0, offsetY = 0;
            let simplex;

            const PALETTES = {
                 earth: { DEEP_WATER: '#003366', WATER: '#006994', SAND: '#c2b280', LAND: '#228b22', FOREST: '#556b2f', ROCK: '#8b4513', PEAK: '#d2b48c' },
                parchment: { DEEP_WATER: '#5c6e8f', WATER: '#8fa4c2', SAND: '#e6d5b8', LAND: '#c4a788', FOREST: '#845422', ROCK: '#6b5b4b', PEAK: '#4a3f35' },
                verdant: { DEEP_WATER: '#1e3a8a', WATER: '#3b82f6', SAND: '#fde68a', LAND: '#22c55e', FOREST: '#15803d', ROCK: '#a8a29e', PEAK: '#f8fafc' },
                volcanic: { DEEP_WATER: '#881337', WATER: '#e11d48', SAND: '#450a0a', LAND: '#171717', FOREST: '#262626', ROCK: '#57534e', PEAK: '#e5e5e5' }
            };
            let currentPalette = PALETTES.earth;

            function getFractalNoise(x, y, z) {
                let total = 0, frequency = 1, amplitude = 1, maxValue = 0;
                let use3D = z !== undefined;
                for (let i = 0; i < octaves; i++) {
                    if (use3D) {
                        total += simplex.noise3D(x * frequency, y * frequency, z * frequency) * amplitude;
                    } else {
                        total += simplex.noise2D(x * frequency, y * frequency) * amplitude;
                    }
                    maxValue += amplitude;
                    amplitude *= 0.5;
                    frequency *= 2;
                }
                return total / maxValue;
            }

            function renderMap() {
                if (!simplex) return;
                const width = canvas.clientWidth;
                const height = Math.floor(width * (9 / 16));
                canvas.width = width;
                canvas.height = height;

                const isWrapping = wrappingCheckbox.checked;

                for (let x = 0; x < width; x += TILE_SIZE) {
                    for (let y = 0; y < height; y += TILE_SIZE) {
                        const worldX = offsetX + (x / noiseScale);
                        const worldY = offsetY + (y / noiseScale);
                        
                        let rawNoise;
                        if (isWrapping) {
                            const circumference = (width / noiseScale) * (INITIAL_NOISE_SCALE / 40);
                            const angle = (worldX / circumference) * 2 * Math.PI;
                            const radius = 1; // Radius of our conceptual cylinder
                            const sampleX = Math.cos(angle) * radius;
                            const sampleY = Math.sin(angle) * radius;
                            rawNoise = getFractalNoise(sampleX, sampleY, worldY);
                        } else {
                            rawNoise = getFractalNoise(worldX, worldY);
                        }
                        
                        let normalizedNoise = (rawNoise + 1) / 2;
                        normalizedNoise = Math.pow(normalizedNoise, landShapingPower);
                        const shapedNoise = normalizedNoise * 2 - 1;

                        let color;
                        if (shapedNoise < -0.35) color = currentPalette.DEEP_WATER;
                        else if (shapedNoise < -0.1) color = currentPalette.WATER;
                        else if (shapedNoise < -0.05) color = currentPalette.SAND;
                        else if (shapedNoise < 0.3) color = currentPalette.LAND;
                        else if (shapedNoise < 0.5) color = currentPalette.FOREST;
                        else if (shapedNoise < 0.7) color = currentPalette.ROCK;
                        else color = currentPalette.PEAK;

                        ctx.fillStyle = color;
                        ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    }
                }
                updateZoomDisplay();
            }
            
            function updateZoomDisplay() {
                const zoomFactor = noiseScale / INITIAL_NOISE_SCALE;
                zoomLevelDisplay.textContent = `${zoomFactor.toFixed(2)}x`;
            }

            function resetView() {
                offsetX = 0;
                offsetY = 0;
                noiseScale = INITIAL_NOISE_SCALE;
                renderMap();
            }

            function generateAndRender() {
                simplex = new SimplexNoise(Math.random());
                notesArea.value = '';
                resetView();
            }

            function handleZoom(mouseX, mouseY, zoomFactor) {
                const minNoiseScale = INITIAL_NOISE_SCALE / 1.6;
                const proposedNoiseScale = noiseScale * zoomFactor;

                if (zoomFactor < 1 && proposedNoiseScale < minNoiseScale) {
                    noiseScale = Math.max(noiseScale, minNoiseScale);
                    return;
                }
                
                const worldMouseX = offsetX + (mouseX / noiseScale);
                const worldMouseY = offsetY + (mouseY / noiseScale);
                
                noiseScale = proposedNoiseScale;

                offsetX = worldMouseX - (mouseX / noiseScale);
                offsetY = worldMouseY - (mouseY / noiseScale);
                
                renderMap();
            }
            
            function initialize() {
                octaves = parseInt(octavesSlider.value);
                landShapingPower = parseFloat(shapingSlider.value);
                currentPalette = PALETTES[themeSelector.value];
                
                generateButton.addEventListener('click', generateAndRender);
                resetViewButton.addEventListener('click', resetView);
                wrappingCheckbox.addEventListener('change', renderMap);
                
                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    handleZoom(e.clientX - rect.left, e.clientY - rect.top, 2);
                });
                
                canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const zoomFactor = e.deltaY < 0 ? 1.5 : 1 / 1.5;
                    handleZoom(e.clientX - rect.left, e.clientY - rect.top, zoomFactor);
                }, { passive: false });

                octavesSlider.addEventListener('input', (e) => {
                    octaves = parseInt(e.target.value, 10);
                    renderMap();
                });
                
                shapingSlider.addEventListener('input', (e) => {
                    landShapingPower = parseFloat(e.target.value);
                    renderMap();
                });

                themeSelector.addEventListener('change', (e) => {
                    currentPalette = PALETTES[e.target.value];
                    renderMap();
                });
            
                window.addEventListener('resize', () => {
                    clearTimeout(window.resizeTimeout);
                    window.resizeTimeout = setTimeout(renderMap, 100);
                });

                generateAndRender();
            }
            
            initialize();
        });
    </script>
</body>
</html>
