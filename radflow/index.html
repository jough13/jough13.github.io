<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadFlow | Loading...</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- VISUAL THEME --- */
        :root {
            --bg-body: #f8fafc; --bg-sidebar: #ffffff; --bg-panel: #ffffff; --bg-card: #f1f5f9;
            --bg-input: #e2e8f0; --border: #cbd5e1; --text-main: #0f172a; --text-muted: #64748b;
            --accent: #059669; --accent-dim: rgba(5, 150, 105, 0.1);
            --danger: #dc2626; --warning: #d97706; --info: #2563eb; --rad: #9333ea; --money: #059669;
            --plan: #7c3aed; --comp: #475569;
            --navy: #1e40af; --navy-dim: #dbeafe;
            --cmd: #7e22ce; --cmd-dim: #f3e8ff; 
            --other: #475569; --other-dim: #f1f5f9;
            --col-plan: #f3f4f6; --col-act: #ecfdf5; --col-rev: #eff6ff; --col-comp: #e2e8f0;
        }
        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --bg-panel: #1e293b; --bg-card: #334155;
            --bg-input: #020617; --border: #475569; --text-main: #f8fafc; --text-muted: #94a3b8;
            --accent: #10b981; --accent-dim: rgba(16, 185, 129, 0.15);
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --rad: #d946ef; --money: #34d399;
            --plan: #8b5cf6; --comp: #94a3b8;
            --navy: #60a5fa; --navy-dim: #1e3a8a;
            --cmd: #c084fc; --cmd-dim: #581c87;
            --other: #94a3b8; --other-dim: #334155;
            --col-plan: #1e293b; --col-act: #064e3b; --col-rev: #1e3a8a; --col-comp: #334155;
        }
        * { box-sizing: border-box; outline: none; transition: background 0.2s, color 0.2s; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; background: var(--bg-body); color: var(--text-main); display: grid; grid-template-columns: 240px 1fr 300px; grid-template-rows: 100vh; overflow: hidden; }

/* Sticky Table Headers */
.sci-table th {
    position: sticky;
    top: 0;
    background: var(--bg-panel); /* Matches theme (Dark/Light) */
    z-index: 5;
    box-shadow: 0 1px 0 var(--border); /* subtle border line */
}

        /* Responsive */
        @media (max-width: 1100px) { body { grid-template-columns: 200px 1fr; grid-template-rows: 1fr auto; } .chat-panel { grid-column: 2; grid-row: 2; border-left: none; border-top: 1px solid var(--border); height: 300px; } .main { grid-column: 2; grid-row: 1; } }
        @media (max-width: 768px) { body { display: block; height: auto; overflow-y: auto; } .sidebar { width: 100%; height: auto; border-right: none; flex-direction: row; flex-wrap: wrap; } .main { padding: 1rem; height: auto; overflow: visible; } .chat-panel { height: 400px; border-top: 4px solid var(--border); } }
        
        /* Print Optimization */
        @media print { 
            body { display: block; background: white; color: black; height: auto; overflow: visible; }
            .sidebar, .chat-panel, .btn, .btn-sync, .btn-toggle, .header button, .sync-box, .nav-item { display: none !important; }
            .main { padding: 0; width: 100%; height: auto; overflow: visible; } 
            .widget { border: 1px solid #ccc; break-inside: avoid; background: white; color: black; box-shadow: none; margin-bottom: 20px; page-break-inside: avoid; }
            .header { border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .form-control, .live-edit, input, select { border: none !important; background: transparent !important; appearance: none; -webkit-appearance: none; padding: 0; font-size: inherit; color: black !important; }
            ::-webkit-scrollbar { display: none; }
            .view-section { display: none; }
            .view-section.active { display: block; }
            .search-bar, .modal-overlay, #btnShowComp, .quick-actions, .est-input-row, .date-adder { display: none !important; }
            table { width: 100% !important; border-collapse: collapse; }
            th, td { border: 1px solid #ddd !important; color: black !important; }
            :root { --bg-body: white; --bg-panel: white; --text-main: black; --text-muted: #444; }
        }

        /* Sidebar & Buttons */
        .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 10; overflow-y: auto; }
        .nav-item { padding: 0.8rem 0.5rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-main); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        
        .btn-sync, .btn-toggle { width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); cursor: pointer; font-size: 0.8rem; font-weight: bold; text-align: left; display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 8px; }
        .btn-sync:hover, .btn-toggle:hover { background: var(--accent); color: white; border-color: var(--accent); }
        
        .btn-sync.btn-danger { color: var(--danger); border-color: var(--danger); }
        .btn-sync.btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-sync.btn-ghost { color: var(--text-muted); border-color: transparent; background: transparent; }
        .btn-sync.btn-ghost:hover { background: var(--bg-input); color: var(--text-main); border-color: var(--border); }

        /* Layout */
        .main { padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 10px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .widget { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; margin-bottom: 1.5rem; }
        .widget-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.9rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        
/* Updated List Item for better spacing */
        .list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--bg-card); 
            padding: 0.8rem; 
            padding-right: 1rem; /* Ensure space */
            border-radius: 6px; 
            margin-bottom: 5px; 
            cursor: pointer; 
            border-left: 3px solid transparent; 
            font-size: 0.9rem; 
            transition: transform 0.2s; 
            position: relative; 
            overflow: hidden; /* Keeps the overlay inside the rounded corners */
        }

        .list-item:hover { border-left-color: var(--accent); transform: translateX(3px); background: var(--bg-input); }
        
        /* New Quick Actions Toolbar Style */
        .quick-actions { 
            display: none; 
            position: absolute; 
            right: 0; top: 0; bottom: 0; /* Stretch full height */
            align-items: center; 
            gap: 8px; 
            padding-right: 10px; 
            padding-left: 20px;
            /* Gradient fade so it blends in smoothly */
            background: linear-gradient(to right, transparent, var(--bg-input) 20%);
            z-index: 5;
        }
        .list-item:hover .quick-actions { display: flex; }
        
        /* Better Looking Action Buttons */
        .qa-btn { 
            width: 30px; height: 30px; /* Fixed square size */
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; 
            background: var(--bg-panel); 
            border: 1px solid var(--border); 
            border-radius: 50%; /* Circle buttons look cleaner */
            cursor: pointer; 
            color: var(--text-muted); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .qa-btn:hover { transform: scale(1.1); color: white; border-color: transparent; }
        
        /* Color coding the buttons */
        .qa-btn.qa-task:hover { background: var(--accent); } /* Green for Task */
        .qa-btn.qa-exp:hover { background: var(--money); }   /* Money Green/Teal for Expense */

        /* Elements */
        .rag-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .chart-container { display: flex; height: 20px; border-radius: 4px; overflow: hidden; background: var(--bg-input); margin-top: 10px; }
        .chart-seg { height: 100%; transition: width 0.5s; position: relative; }
        .chart-legend { display: flex; gap: 15px; margin-top: 5px; font-size: 0.7rem; color: var(--text-muted); flex-wrap: wrap; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .progress-bar { height: 6px; background: var(--bg-input); border-radius: 3px; width: 100px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent); }
        .tag { font-size:0.65rem; padding:2px 6px; border-radius:4px; background:var(--bg-body); border:1px solid var(--border); color:var(--text-muted); margin-left:5px; }
        .proj-link { color:var(--info); font-weight:bold; cursor:pointer; text-decoration:none; }
        .proj-link:hover { text-decoration:underline; color:var(--accent); }

/* New Small Rectangle Button */
        .btn-rect {
            appearance: none;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px; /* Rectangle with slight curve */
            padding: 0 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 24px; /* Match sort-select height */
            transition: all 0.2s;
        }
        .btn-rect:hover {
            border-color: var(--accent);
            background: var(--bg-card);
        }

/* New Sort Dropdown Style */
        .sort-select {
            appearance: none;
            -webkit-appearance: none; 
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 8px;
            padding-right: 18px; /* Space for arrow */
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            text-align: center;
            outline: none;
            transition: all 0.2s;
            height: 24px; 
            line-height: 1;
            
            /* Custom Arrow Icon */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2364748b%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 5px center;
            background-size: 8px auto;
        }

        /* FIX: Added :focus so it stays green when menu is open */
        .sort-select:hover, .sort-select:focus {
            background: var(--bg-card);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Clean up the dropdown options */
        option {
            background: var(--bg-panel);
            color: var(--text-main);
            padding: 4px;
        }

.chart-wrapper { 
    display: flex; 
    gap: 10px; 
    height: 180px; 
    width: 100%; 
    border: 1px solid var(--border); 
    background: var(--bg-card); 
    padding: 10px; 
    border-radius: 8px; 
}
        /* Fixed Y-Axis Column */
        .chart-y-axis { 
            display: flex; flex-direction: column; justify-content: space-between; 
            height: 100%; padding-bottom: 25px; /* Align with bars */
            padding-top: 15px;
            min-width: 50px; text-align: right; border-right: 1px dashed var(--border); 
            font-size: 0.65rem; color: var(--text-muted); font-weight: bold;
        }

        /* Scrollable Bar Area */
        .bar-chart-v { 
            display: flex; gap: 12px; height: 100%; width: 100%;
            padding-top: 20px; /* Space for labels */
            overflow-x: auto; overflow-y: hidden;
            scrollbar-width: thin; scrollbar-color: var(--accent) var(--bg-input);
        }

        /* Bars & Labels */
        .bar-col { 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end; 
            height: 100%; flex-shrink: 0; 
            min-width: 80px; /* Increased buffer spacing */
            position: relative; 
        }
        
        .bar-v { 
            width: 100%; background: var(--money); border-radius: 4px 4px 0 0; 
            min-height: 2px; transition: height 0.3s; opacity: 0.85; position: relative;
        }
        .bar-v:hover { opacity: 1; background: var(--accent); }

        /* The Dollar Amount on Top */
        .bar-top-lbl {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            font-size: 0.6rem; font-weight: bold; color: var(--text-main);
            margin-bottom: 4px; white-space: nowrap;
        }

        .bar-lbl { 
            font-size: 0.7rem; 
            color: var(--text-main); 
            font-weight: bold; 
            margin-top: 10px; 
            white-space: nowrap; 
            text-align: center; 
            width: 100%;
            /* Removed rotation/writing-mode for horizontal text */
        }

	.modal .chart-wrapper {
            height: 100% !important; 
            border: none;
            padding: 20px;
        }

        /* --- UPGRADED FUNDING CARDS --- */
        .fund-card {
            background: var(--bg-input); border-radius: 6px; padding: 12px; margin-bottom: 10px;
            border-left: 4px solid var(--text-muted); transition: transform 0.2s;
        }
        .fund-card:hover { transform: translateX(5px); background: var(--bg-card); border: 1px solid var(--border); border-left-width: 4px; }
        .fund-head { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        .fund-meta { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px; }
        .fund-bar-bg { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        .fund-bar-fill { height: 100%; border-radius: 4px; }

        /* Kanban */
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: start; }
        .kanban-col { background: var(--bg-input); border-radius: 8px; padding: 10px; min-height: 200px; transition: background 0.2s; border: 2px solid transparent; }
        .kanban-col.drag-over { border-color: var(--accent); background: var(--bg-card); }
        .kanban-head { font-weight: 800; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 10px; text-align: center; padding-bottom: 5px; border-bottom: 2px solid; }
        .kanban-card { background: var(--bg-panel); padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border); cursor: grab; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .kanban-card.over-budget { border-color: var(--danger); border-left: 3px solid var(--danger); }

        /* Finance */
        .fin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .fin-card { padding: 1rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .fin-card.interactive { cursor: pointer; transition: border-color 0.2s; }
        .fin-card.interactive:hover { border-color: var(--accent); background: var(--bg-input); }
        .fin-val { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin-top: 5px; white-space: nowrap; }
        .fin-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .mini-fin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mini-fin-box { background: var(--bg-input); padding: 10px; border-radius: 6px; text-align: center; }
        .mini-fin-val { font-weight: bold; font-size: 1rem; }
        .mini-fin-lbl { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; }

        /* Chat */
        .chat-panel { background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-header { padding: 1.5rem; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--text-muted); }
        .chat-feed { flex: 1; overflow-y: auto; padding: 1rem; }
        .chat-input-area { padding: 1rem; border-top: 1px solid var(--border); background: var(--bg-sidebar); }
        .msg { background: var(--bg-card); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; border: 1px solid var(--border); }
        .msg-meta { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.7rem; color: var(--text-muted); }

        /* Inputs */
        .form-control { width: 100%; padding: 0.7rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; margin-bottom: 1rem; }
        .search-bar { width: 300px; border-radius: 20px; padding: 0.5rem 1rem; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; background: var(--accent); color: white; white-space: nowrap; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-panel); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Tables & Edit */
        .sci-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .sci-table td, .sci-table th { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: middle; }
        .sci-table th { cursor: pointer; }
        .sci-table th:hover { color: var(--accent); }
        .live-edit { background: transparent; border: 1px solid transparent; width: 100%; padding: 4px; color: inherit; font-family: inherit; font-size: inherit; border-radius: 4px; }
        .live-edit:hover { border-color: var(--border); background: var(--bg-input); }
        .live-edit:focus { border-color: var(--accent); background: var(--bg-card); outline: none; }
        .edit-h1 { font-size: 1.6rem; font-weight: bold; background: transparent; border: 1px solid transparent; width: 100%; color: var(--text-main); margin-bottom: 0.5rem; }
        .edit-h1:hover { border-color: var(--border); }
        .edit-p { width: 100%; background: transparent; border: 1px solid transparent; color: var(--text-muted); font-size: 1rem; resize: vertical; min-height: 60px; font-family: inherit; }
        .edit-p:hover { border-color: var(--border); }

        .task-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .task-chk { cursor: pointer; font-size: 1.2rem; color: var(--text-muted); margin-right: 10px; }
        .task-chk.checked { color: var(--accent); }
        .task-txt.checked { text-decoration: line-through; color: var(--text-muted); }
        .task-input { flex: 1; border: none; background: transparent; color: inherit; font-family: inherit; }
        .assign-select { font-size: 0.7rem; background: var(--bg-input); padding: 2px; border-radius: 4px; color: var(--text-muted); border: 1px solid var(--border); width: 60px; }
        .date-input-mini { font-size: 0.7rem; background: var(--bg-input); padding: 2px; border-radius: 4px; color: var(--text-muted); border: 1px solid var(--border); width: 90px; margin-left:5px; }
        .date-overdue { color: var(--danger); font-weight: bold; border-color: var(--danger); }

        .link-row { display: flex; align-items: center; gap: 10px; padding: 5px; background: var(--bg-input); border-radius: 4px; margin-bottom: 5px; font-size: 0.85rem; }
        .link-row a { color: var(--info); text-decoration: none; overflow: hidden; text-overflow: ellipsis; }
        .input-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .input-grid > * { flex: 1 1 150px; } 

        /* Toast Notifications */
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .toast { background: var(--bg-panel); border-left: 4px solid var(--accent); padding: 12px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; min-width: 250px; animation: slideIn 0.3s ease-out; color: var(--text-main); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--info); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="font-size:1.2rem; font-weight:800; color:var(--accent); margin-bottom:2rem; display:flex; align-items:center; gap:10px;">
        <i class="fa-solid fa-atom"></i> <span id="app-title-display">RadFlow</span>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; margin-bottom: 1rem;">
        <div class="nav-item active" id="nav-dash" onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i> Dash</div>
        <div class="nav-item" id="nav-proj" onclick="nav('projects')"><i class="fa-solid fa-list-check"></i> Proj</div>
        <div class="nav-item" id="nav-fin" onclick="nav('finance')"><i class="fa-solid fa-sack-dollar"></i> Cost</div>
        <div class="nav-item" id="nav-est" onclick="nav('estimator')"><i class="fa-solid fa-file-invoice-dollar"></i> Est.</div>
        <div class="nav-item" id="nav-inv" onclick="nav('inventory')"><i class="fa-solid fa-boxes-stacked"></i> Inv</div>
        <div class="nav-item" id="nav-exempt" onclick="nav('exempt')"><i class="fa-solid fa-recycle"></i> Exempt</div>
        <div class="nav-item" id="nav-hp" onclick="nav('hp')"><i class="fa-solid fa-calculator"></i> HP</div>
        <div class="nav-item" id="nav-log" onclick="nav('logbook')"><i class="fa-solid fa-book-open"></i> Log</div>
    </div>

    <button class="btn-toggle" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i> Theme</button>
    <button class="btn-toggle" onclick="window.print()"><i class="fa-solid fa-print"></i> Report</button>
    <button class="btn-toggle" onclick="openModal('settingsModal')"><i class="fa-solid fa-users"></i> Settings</button>

    <div class="sync-box">
        <button class="btn-sync" onclick="openExportModal()"><i class="fa-solid fa-copy"></i> Export</button>
        <button class="btn-sync" onclick="openImportModal()"><i class="fa-solid fa-paste"></i> Import</button>
        <button class="btn-sync btn-danger" onclick="clearData()">Clear All</button>
        <button class="btn-sync btn-ghost" onclick="resetData()">Reset Data</button>
    </div>
</div>

<div class="main">
    <div id="view-dashboard" class="view-section active">
        <div class="header">
            <div><h1 style="margin:0;">Command Center</h1><p style="margin:0; color:var(--text-muted);" id="todayDate">Loading...</p></div>
            <input type="text" class="search-bar" placeholder="Search..." onkeyup="render(this.value)">
            <button class="btn" onclick="openModal('projectModal')">+ Project</button>
        </div>
        
        <div class="widget">
            <div class="widget-head">Operational Analytics</div>
            <div class="dashboard-grid">
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">PROJECT STATUS</div>
                    <div id="chart-proj" class="chart-container"></div>
                    <div id="legend-proj" class="chart-legend"></div>
                </div>
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">BUDGET UTILIZATION</div>
                    <div id="chart-money" class="chart-container"></div>
                    <div class="chart-legend"><div><span class="legend-dot" style="background:var(--money)"></span>Spent</div><div><span class="legend-dot" style="background:var(--bg-input)"></span>Remaining</div></div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="widget"><div class="widget-head"><span>Active Projects</span><span style="font-size:0.8rem; cursor:pointer; color:var(--accent);" onclick="nav('projects')">View All &rarr;</span></div><div id="dash-projects"></div></div>
            <div class="widget"><div class="widget-head"><span>Pending Actions</span><i class="fa-solid fa-bolt" style="color:var(--warning)"></i></div><div id="dash-tasks"></div></div>
            <div class="widget"><div class="widget-head">Inventory Snapshot</div><div id="dash-inv"></div></div>
            <div class="widget"><div class="widget-head">Financial Snapshot</div><div id="dash-fin"></div></div>
        </div>
    </div>

    <div id="view-project-detail" class="view-section"></div>
    <div id="view-projects" class="view-section">
        <div class="header">
            <h1>All Projects</h1>
            <div style="display:flex; gap:10px;">
                <button class="btn-toggle" style="margin:0" onclick="toggleProjView()"><i class="fa-solid fa-table-columns"></i> View</button>
                <button id="btnShowComp" class="btn-toggle" style="margin:0" onclick="toggleShowComp()"><i class="fa-solid fa-eye"></i> Show Done</button>
                <input type="text" class="search-bar" style="width:200px;" placeholder="Filter..." onkeyup="render(this.value)">
            </div>
        </div>
        <div class="widget"><div id="full-project-list"></div></div>
    </div>
    
<div id="view-finance" class="view-section">
        <div class="header">
            <div>
                <h1 style="margin:0;">Cost Tracker</h1>
                <div style="display:flex; gap:8px; align-items:center; margin-top:5px; font-size:0.8rem; color:var(--text-muted);">
                    <span><i class="fa-solid fa-filter"></i> Period:</span>
                    
                    <input type="date" id="fin-start" class="form-control" style="width:auto; padding:2px 5px; margin:0; height:auto;">
                    <span>to</span>
                    <input type="date" id="fin-end" class="form-control" style="width:auto; padding:2px 5px; margin:0; height:auto;">
                    
                    <button class="qa-btn" onclick="applyFinFilter()" title="Apply" style="background:var(--accent); color:white;">
                        <i class="fa-solid fa-check"></i>
                    </button>
                    <button class="qa-btn" onclick="clearFinFilter()" title="Clear">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                
                    <div style="border-left:1px solid var(--border); padding-left:8px; margin-left:4px;">
                        <button id="btn-budget-scope" class="btn-rect" onclick="toggleBudgetScope()" style="width:110px; background:var(--navy); color:white;">
                            <i class="fa-solid fa-infinity"></i> Lifetime
                        </button>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn" onclick="openModal('allocModal')">+ Funding</button>
                <button class="btn" onclick="openModal('expenseModal')">- Expense</button>
                <button class="btn-toggle" style="margin:0" onclick="downloadCSV()"><i class="fa-solid fa-file-csv"></i> to Excel</button>
            </div>
        </div>
        
        <div class="fin-grid">
            <div class="fin-card interactive" onclick="openBudgetManager()"><div class="fin-label">Total Budget <i class="fa-solid fa-pen" style="font-size:0.7rem; margin-left:5px;"></i></div><div class="fin-val" style="color:var(--info);" id="fin-total-budget">$0.00</div></div>
            <div class="fin-card"><div class="fin-label">Total Spent</div><div class="fin-val" style="color:var(--warning);" id="fin-total-spent">$0.00</div></div>
            <div class="fin-card"><div class="fin-label">Remaining Funds</div><div class="fin-val" id="fin-total-rem">$0.00</div></div>
            <div class="fin-card"><div class="fin-label">Active Spenders</div><div class="fin-val" style="color:var(--rad);" id="fin-proj-count">0</div></div>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-toggle" style="width:auto;" onclick="switchFinTab('overview')">Overview</button>
            <button class="btn-toggle" style="width:auto;" onclick="switchFinTab('exp')">Expenses</button>
            <button class="btn-toggle" style="width:auto;" onclick="switchFinTab('alloc')">Allocations</button>
        </div>

        <div class="widget">
            <div id="fin-tab-overview">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="widget-head" style="margin:0;">Spending Trend</div>
                        <button class="qa-btn" onclick="expandChart()" title="Fullscreen"><i class="fa-solid fa-expand"></i></button>
                    </div>
                    <div style="display:flex; gap:5px; background:var(--bg-input); padding:3px; border-radius:6px;">
                        <button class="qa-btn" onclick="setChartScale('week')" id="btn-scale-week">Wk</button>
                        <button class="qa-btn" onclick="setChartScale('month')" id="btn-scale-month" style="background:var(--accent); color:white;">Mo</button>
                        <button class="qa-btn" onclick="setChartScale('quarter')" id="btn-scale-quarter">Qr</button>
                        <button class="qa-btn" onclick="setChartScale('year')" id="btn-scale-year">Yr</button>
                    </div>
                </div>
                
                <div id="monthly-spend-chart" class="bar-chart-v"></div>

                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top: 20px;">
                    <div>
                        <div class="widget-head">Budget Rollup & Performance</div>
                        <div style="overflow-x:auto;">
                            <table class="sci-table" id="table-budget">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable('table-budget', 0)">Project <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                        <th onclick="sortTable('table-budget', 1)" style="width:50px; cursor:pointer;">
    Source <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i>
</th>
                                        <th onclick="sortTable('table-budget', 2)" style="text-align:right">Initial Budget <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                        <th onclick="sortTable('table-budget', 3)" style="text-align:right">Adjustments <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                        <th onclick="sortTable('table-budget', 4)" style="text-align:right">Total Funding <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                        <th onclick="sortTable('table-budget', 5)" style="text-align:right">Total Spent <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                        <th onclick="sortTable('table-budget', 6)" style="text-align:right">Remaining <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                        <th onclick="sortTable('table-budget', 7)" style="text-align:center">Burn % <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="budget-rollup-list"></tbody>
                                <tfoot id="budget-rollup-foot" style="font-weight:bold; background:var(--bg-input); border-top:2px solid var(--border);"></tfoot>
                            </table>
                        </div>
                    </div>
                    <div style="background:var(--bg-card); border-left:1px solid var(--border); padding-left:20px;">
                        <div class="widget-head">Funding Source Analysis</div>
                        <div id="finance-source-breakdown">Loading...</div>
                    </div>
                </div>
            </div>

            <div id="fin-tab-exp" style="display:none;">
                <div class="widget-head">Expense Log (Live Edit)</div>
                <div style="overflow-x:auto;"><table class="sci-table" id="table-exp"><thead><tr><th onclick="sortTable('table-exp',0)">Date <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-exp',1)">Project <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-exp',2)">Funding Source <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-exp',3)">Description <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-exp',4)">Amount <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th>Status</th><th></th></tr></thead><tbody id="expense-list"></tbody></table></div>
            </div>
            
            <div id="fin-tab-alloc" style="display:none;">
                <div class="widget-head">Funding Allocations</div>
                <div style="overflow-x:auto;"><table class="sci-table" id="table-alloc"><thead><tr><th onclick="sortTable('table-alloc',0)">Date <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-alloc',1)">Project <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-alloc',2)">Source <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-alloc',3)">Description <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-alloc',4)">Amount <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th></th></tr></thead><tbody id="alloc-list"></tbody></table></div>
            </div>
        </div>
    </div>
    <div id="view-estimator" class="view-section">
        <div class="header"><h1>Cost Estimator</h1>
            <div style="display:flex; gap:10px;">
                <select id="est-proj-select" class="form-control" style="width:200px; margin:0;" onchange="saveLocally()"><option value="">-- Select Project --</option></select>
                <select id="est-fund-select" class="form-control" style="width:180px; margin:0;">
                    <option>Navy General Fund</option><option>Command Funded</option><option>Other</option>
                </select>
                <button class="btn-sync" style="width:auto; margin:0;" onclick="clearEstimate()"><i class="fa-solid fa-trash"></i></button>
                
                <button class="btn" style="background:var(--text-muted)" onclick="saveEstimateAction('estimate')" title="Save as line item (No budget impact)">As Estimate</button>
                <button class="btn" style="background:var(--money)" onclick="saveEstimateAction('funding')" title="Add to Project Funding">As Funding</button>
                <button class="btn" style="background:var(--danger)" onclick="saveEstimateAction('expense')" title="Submit as Expense">As Cost</button>
            </div>
        </div>
        <div class="widget">
            <div class="widget-head">Estimate Line Items</div>
            <div class="est-input-row" style="display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;">
                <select id="est-cat" class="form-control" style="margin:0; width:150px;" onchange="updateEstItems()"><option value="disposal">Disposal</option><option value="container">Container</option><option value="sample">Sampling</option><option value="labor">Labor</option><option value="trans">Transportation</option></select>
                <select id="est-item" class="form-control" style="margin:0; width:200px;" onchange="updateEstUnit()"></select>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:0.8rem; color:var(--text-muted);">Rate: $</span>
                    <input id="est-rate" type="number" class="form-control" style="margin:0; width:100px;" placeholder="0.00">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input id="est-qty" type="number" class="form-control" style="margin:0; width:80px;" placeholder="0">
                    <span id="est-unit" style="font-size:0.8rem; color:var(--text-muted); width:80px;">Units</span>
                </div>
                <button class="btn" onclick="addEstItem()">Add</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="sci-table">
                    <thead><tr><th>Category</th><th>Item</th><th style="text-align:right">Rate</th><th style="text-align:right">Qty/Hrs</th><th style="text-align:right">Total</th><th></th></tr></thead>
                    <tbody id="est-list"></tbody>
                    <tfoot style="font-weight:bold; background:var(--bg-input);">
                        <tr style="font-size:1.1rem; color:var(--accent); border-top:2px solid var(--border);"><td colspan="4" style="text-align:right">ESTIMATE TOTAL (<span id="est-count">0</span> items):</td><td style="text-align:right" id="est-grand-total">$0.00</td><td></td></tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div id="view-exempt" class="view-section">
        <div class="header">
            <h1>Exempt Material Disposal Log</h1>
            <div style="display:flex; gap:10px;">
                <input type="text" class="search-bar" style="width:200px;" placeholder="Search Log..." onkeyup="render(this.value)">
                <button class="btn-toggle" style="margin:0" onclick="downloadExemptCSV()"><i class="fa-solid fa-file-csv"></i> Export Log</button>
                <button class="btn" onclick="openModal('exemptModal')">+ Add Entry</button>
            </div>
        </div>
        <div class="widget">
            <div style="overflow-x:auto;">
    <table class="sci-table" id="table-exempt">
    <thead>
        <tr>
            <th onclick="sortTable('table-exempt', 0)">Log # <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 1)">Date Rec'd <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th> 
            <th onclick="sortTable('table-exempt', 2)">Command <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 3)">Description <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 4)">Nuclide <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 5)">Activity <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 6)">Basis <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 7)">Pathway <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>
            <th onclick="sortTable('table-exempt', 8)">Auth Date <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th> 
            <th>Status</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="exempt-list"></tbody>
</table>
            </div>
        </div>
    </div>

    <div id="view-hp" class="view-section">
        <div class="header"><h1>HP Tools</h1></div>
        <div class="widget" style="margin-bottom:1.5rem; background:var(--bg-panel); border-left: 4px solid var(--accent);">
            <div class="widget-head" style="margin-bottom:5px;">Quick Converter</div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <input id="conv-in" type="number" class="form-control" style="margin:0; width:120px;" placeholder="Value" onkeyup="runConv()">
                <select id="conv-type" class="form-control" style="margin:0; width:150px;" onchange="runConv()">
                    <option value="ci-gbq">Ci &rarr; GBq</option>
                    <option value="gbq-ci">GBq &rarr; Ci</option>
                    <option value="mr-usv">mR &rarr; &mu;Sv</option>
                    <option value="usv-mr">&mu;Sv &rarr; mR</option>
                </select>
                <div style="font-weight:bold;">&rarr;</div>
                <div id="conv-out" style="font-weight:bold; color:var(--accent); min-width:80px;">0.00</div>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-toggle" style="width:auto;" onclick="switchHpTab('decay')">Decay</button>
            <button class="btn-toggle" style="width:auto;" onclick="switchHpTab('dist')">Distance</button>
            <button class="btn-toggle" style="width:auto;" onclick="switchHpTab('shield')">Shielding</button>
            <button class="btn-toggle" style="width:auto;" onclick="switchHpTab('stay')">Stay Time</button>
            <button class="btn-toggle" style="width:auto;" onclick="switchHpTab('alara')">ALARA Plan</button>
        </div>
        <div class="widget">
            <div id="hp-tab-decay">
                <div class="widget-head">Isotope Decay</div>
                <div class="dashboard-grid">
                    <div>
    <label style="color:var(--text-muted); font-size:0.8rem;">Isotope</label>
    <select id="calc-iso" class="form-control" onchange="saveHPState()"></select>
    
    <label style="color:var(--text-muted); font-size:0.8rem;">Initial Activity (mCi)</label>
    <input type="number" id="calc-a0" class="form-control" placeholder="100" onchange="saveHPState()">
    
    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label style="color:var(--text-muted); font-size:0.8rem;">Reference Date</label>
            <input type="date" id="calc-date" class="form-control" onchange="saveHPState()">
        </div>
        <div style="flex:1;">
            <label style="color:var(--text-muted); font-size:0.8rem;">Target Date (Default: Now)</label>
            <input type="date" id="calc-target-date" class="form-control" onchange="saveHPState()">
        </div>
    </div>

    <button class="btn" onclick="calculateDecay()" style="width:100%; background:var(--rad);">Calculate</button>
</div>
                    <div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px; display:flex; flex-direction:column; justify-content:center;">
                        <div style="color:var(--text-muted);">Current Activity</div>
                        <div id="calc-result" style="font-size:2.5rem; color:var(--rad); font-weight:bold; margin:10px 0;">---</div>
                    </div>
                </div>
            </div>
            <div id="hp-tab-dist" style="display:none;">
                <div class="widget-head">Inverse Square Law</div>
                <div style="margin-bottom:15px; padding:10px; background:var(--bg-input); border-radius:6px;">
                    <label style="font-size:0.7rem; font-weight:bold; color:var(--accent);">LOAD FROM INVENTORY</label>
                    <div style="display:flex; gap:10px;">
                        <select id="dist-inv-select" class="form-control" style="margin:0;"></select>
                        <button class="btn" onclick="loadInvToCalc()">Load</button>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div>
                        <label style="color:var(--text-muted); font-size:0.8rem;">Dose Rate (mR/hr)</label><input type="number" id="dist-d1" class="form-control" placeholder="Rate at source">
                        <label style="color:var(--text-muted); font-size:0.8rem;">Distance 1 (ft/m)</label><input type="number" id="dist-r1" class="form-control" placeholder="Initial Dist (e.g. 1)">
                        <label style="color:var(--text-muted); font-size:0.8rem;">Target Distance (ft/m)</label><input type="number" id="dist-r2" class="form-control" placeholder="New Dist">
                        <button class="btn" onclick="calcInverseSquare()" style="width:100%; background:var(--info);">Calculate New Rate</button>
                    </div>
                    <div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px; display:flex; flex-direction:column; justify-content:center;">
                        <div style="color:var(--text-muted);">Resulting Dose Rate</div>
                        <div id="dist-result" style="font-size:2.5rem; color:var(--info); font-weight:bold; margin:10px 0;">---</div>
                        <div id="dist-formula" style="font-size:0.8rem; color:var(--text-muted);">I₁ / (d₂/d₁)²</div>
                    </div>
                </div>
            </div>
            <div id="hp-tab-shield" style="display:none;">
                <div class="widget-head">Shielding Attenuation</div>
                <div class="dashboard-grid">
                    <div>
                        <div class="input-grid">
                            <div><label style="color:var(--text-muted); font-size:0.8rem;">Isotope (Data available for: Co-60, Cs-137, Ir-192)</label><select id="shield-iso" class="form-control"><option value="Co-60">Co-60</option><option value="Cs-137">Cs-137</option><option value="Ir-192">Ir-192</option></select></div>
                            <div><label style="color:var(--text-muted); font-size:0.8rem;">Material</label><select id="shield-mat" class="form-control"><option value="Pb">Lead (Pb)</option><option value="Fe">Iron (Fe)</option><option value="Conc">Concrete</option></select></div>
                        </div>
                        <label style="color:var(--text-muted); font-size:0.8rem;">Initial Dose Rate (mR/hr)</label><input type="number" id="shield-i0" class="form-control" placeholder="1000">
                        <label style="color:var(--text-muted); font-size:0.8rem;">Shield Thickness (cm)</label><input type="number" id="shield-x" class="form-control" placeholder="1.0">
                        <button class="btn" onclick="calcShielding()" style="width:100%; background:var(--comp);">Calculate Shielding</button>
                    </div>
                    <div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px; display:flex; flex-direction:column; justify-content:center;">
                        <div style="color:var(--text-muted);">Attenuated Rate</div>
                        <div id="shield-result" style="font-size:2.5rem; color:var(--comp); font-weight:bold; margin:10px 0;">---</div>
                        <div id="shield-hvl" style="font-size:0.8rem; color:var(--text-muted);">HVL Used: -</div>
                    </div>
                </div>
            </div>
            <div id="hp-tab-stay" style="display:none;">
                <div class="widget-head">Stay Time Calculator</div>
                <div class="dashboard-grid">
                    <div>
                        <label style="color:var(--text-muted); font-size:0.8rem;">Field Dose Rate (mR/hr)</label>
                        <input type="number" id="stay-rate" class="form-control" placeholder="500">
                        <label style="color:var(--text-muted); font-size:0.8rem;">Available Dose Margin (mR)</label>
                        <input type="number" id="stay-limit" class="form-control" placeholder="100">
                        <button class="btn" onclick="calcStayTime()" style="width:100%; background:var(--navy);">Calculate Time</button>
                    </div>
                    <div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px; display:flex; flex-direction:column; justify-content:center;">
                        <div style="color:var(--text-muted);">Allowed Stay Time</div>
                        <div id="stay-result" style="font-size:2rem; color:var(--navy); font-weight:bold; margin:10px 0;">---</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">Limit / Rate</div>
                    </div>
                </div>
            </div>
            <div id="hp-tab-alara" style="display:none;">
                <div class="widget-head">ALARA Job Planner</div>
                <div class="dashboard-grid">
                    <div>
                        <div class="input-grid">
                            <div><label style="color:var(--text-muted); font-size:0.8rem;">Dose Rate (mR/hr)</label><input type="number" id="alara-rate" class="form-control" placeholder="100"></div>
                            <div><label style="color:var(--text-muted); font-size:0.8rem;">Crew Size</label><input type="number" id="alara-crew" class="form-control" placeholder="3"></div>
                        </div>
                        <label style="color:var(--text-muted); font-size:0.8rem;">Job Duration (Minutes)</label>
                        <input type="number" id="alara-time" class="form-control" placeholder="60">
                        <button class="btn" onclick="calcAlara()" style="width:100%; background:var(--rad);">Estimate Collective Dose</button>
                    </div>
                    <div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px; display:flex; flex-direction:column; justify-content:center;">
                        <div style="color:var(--text-muted);">Total Collective Dose</div>
                        <div id="alara-result" style="font-size:2rem; color:var(--rad); font-weight:bold; margin:10px 0;">---</div>
                        <div id="alara-indiv" style="font-size:0.8rem; color:var(--text-muted);">Individual: ---</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-logbook" class="view-section"><div class="header"><h1>Logbook & Notes</h1></div><div class="widget" style="height: calc(100vh - 150px);">

<textarea id="wiki-text" class="live-edit" style="width:100%; height:100%; resize:none; font-family:monospace; padding:15px;" placeholder="Type your persistent notes here..." oninput="saveWiki()"></textarea>

</div></div>

    <div id="view-inventory" class="view-section">
        <div class="header"><h1>Inventory</h1>
            <div>
                <button class="btn-sync" onclick="decayInventory()" style="width:auto; display:inline-block; margin:0;"><i class="fa-solid fa-clock-rotate-left"></i> Decay Correct</button>
                <button class="btn" onclick="openModal('invModal')" style="margin:0;">+ Add Item</button>
            </div>
        </div>
        <div class="widget"><div style="overflow-x:auto;"><table class="sci-table" id="table-inv"><thead><tr><th onclick="sortTable('table-inv',0)">ID <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-inv',1)">Isotope <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-inv',2)">Activity <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-inv',3)">Dose <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th><th onclick="sortTable('table-inv',4)">Fill % <i class="fa-solid fa-sort" style="font-size:0.7rem; color:var(--text-muted)"></i></th>

<th>Project</th><th>Status</th><th></th></tr></thead>

<tbody id="full-inv-list"></tbody></table></div></div>

    </div>
</div>

<div class="chat-panel">
    <div class="chat-header"><i class="fa-regular fa-comments"></i> Team Log</div>
    <div id="chatFeed" class="chat-feed"></div>
    <div class="chat-input-area"><input type="text" id="chatInput" class="form-control" placeholder="Update team..." onkeypress="handleChat(event)"></div>
</div>

<div id="settingsModal" class="modal-overlay"><div class="modal"><h3>Team Settings</h3><div id="teamList" style="margin-bottom:10px;"></div><div style="display:flex; gap:10px;"><input id="newMember" class="form-control" style="margin:0" placeholder="Name/Initials"><button class="btn" onclick="addTeamMember()">Add</button></div><div style="text-align:right; margin-top:20px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('settingsModal')">Done</button></div></div></div>

<div id="estimateViewModal" class="modal-overlay">
    <div class="modal" style="max-width:600px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3><i class="fa-solid fa-file-invoice"></i> Estimate Details</h3>
            <div id="ige-dl-btn-container"></div> </div>
        <div style="background:var(--bg-input); padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.8rem; color:var(--text-muted);">
            <div id="ige-meta-desc" style="font-weight:bold; color:var(--text-main); margin-bottom:5px;"></div>
            <div id="ige-meta-date"></div>
        </div>
        <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:4px;">
            <table class="sci-table">
                <thead>
                    <tr style="background:var(--bg-card); position:sticky; top:0;">
                        <th>Category</th><th>Item</th><th style="text-align:right">Rate</th><th style="text-align:right">Qty</th><th style="text-align:right">Total</th>
                    </tr>
                </thead>
                <tbody id="ige-view-list"></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-top:10px;">
            <div style="font-weight:bold; font-size:1.1rem; color:var(--money);">Total: <span id="ige-view-total"></span></div>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('estimateViewModal')">Close</button>
        </div>
    </div>
</div>

<div id="chartModal" class="modal-overlay">
    <div class="modal" style="width:95%; max-width:1200px; height:80vh; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Financial Analysis</h3>
            <button class="btn-sync" style="width:auto;" onclick="closeModal('chartModal')"><i class="fa-solid fa-xmark"></i> Close</button>
        </div>
        <div id="large-chart-container" style="flex:1; width:100%; overflow:hidden; display:flex; flex-direction:column;"></div>
    </div>
</div>

<div id="projectModal" class="modal-overlay">
    <div class="modal">
        <h3>New Project</h3>
        <input id="pTitle" class="form-control" placeholder="Project Name">
        <input id="pDesc" class="form-control" placeholder="Brief Description">
        <div class="input-grid">
            <div><label style="font-size:0.7rem; color:var(--text-muted)">UIC</label><input id="pUic" class="form-control" placeholder="N00000"></div>
            <div><label style="font-size:0.7rem; color:var(--text-muted)">LOCATION</label><input id="pLoc" class="form-control" placeholder="City, ST"></div>
        </div>
        <div class="input-grid">
            <div><label style="font-size:0.7rem; color:var(--text-muted)">DUE DATE</label><input id="pDate" type="date" class="form-control"></div>
            <div><label style="font-size:0.7rem; color:var(--text-muted)">INITIAL BUDGET ($)</label><input id="pCost" type="number" class="form-control" placeholder="0.00"></div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('projectModal')">Cancel</button>
            <button class="btn" onclick="addProject()">Save</button>
        </div>
    </div>
</div>

<div id="expenseModal" class="modal-overlay"><div class="modal"><h3>Log Expense</h3><label style="font-size:0.7rem; color:var(--text-muted);">PROJECT</label><select id="expProj" class="form-control"></select><input id="expDesc" class="form-control" placeholder="Description"><div class="input-grid"><div style="flex:2;"><label style="font-size:0.7rem; color:var(--text-muted);">FUNDING SOURCE</label><select id="expFund" class="form-control"><option>Navy General Fund</option><option>Command Funded</option><option>Other</option></select></div><div style="flex:1;"><label style="font-size:0.7rem; color:var(--text-muted);">AMOUNT</label><input id="expAmt" type="number" class="form-control" placeholder="0.00"></div></div><div style="margin-bottom:10px;"><label style="font-size:0.7rem; color:var(--text-muted);">DATE</label><input id="expDate" type="date" class="form-control"></div><select id="expStatus" class="form-control"><option>Invoiced</option><option>Paid</option><option>Encumbered</option></select><div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('expenseModal')">Cancel</button><button class="btn" onclick="addExpense()">Add</button></div></div></div>
<div id="allocModal" class="modal-overlay"><div class="modal"><h3>Add Funding Allocation</h3><label style="font-size:0.7rem; color:var(--text-muted);">PROJECT</label><select id="allocProj" class="form-control"></select><div class="input-grid"><div style="flex:2;"><label style="font-size:0.7rem; color:var(--text-muted);">SOURCE</label><select id="allocFund" class="form-control"><option>Navy General Fund</option><option>Command Funded</option><option>Other</option></select></div><div style="flex:1;"><label style="font-size:0.7rem; color:var(--text-muted);">AMOUNT</label><input id="allocAmt" type="number" class="form-control" placeholder="0.00"></div></div><input id="allocDesc" class="form-control" placeholder="Description (e.g. Q3 Top-up)"><div style="margin-bottom:10px;"><label style="font-size:0.7rem; color:var(--text-muted);">DATE</label><input id="allocDate" type="date" class="form-control"></div><div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('allocModal')">Cancel</button><button class="btn" onclick="addAllocation()">Add Funds</button></div></div></div>
<div id="budgetModal" class="modal-overlay"><div class="modal"><h3>Base Budget Manager</h3><p style="color:var(--text-muted); font-size:0.8rem;">Edit the <b>Initial Budget</b> for projects below.</p><div id="budgetManagerList" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div><div style="background:var(--bg-input); padding:10px; border-radius:6px; font-size:0.75rem; color:var(--warning); margin-bottom:15px;"><i class="fa-solid fa-triangle-exclamation"></i> <b>Note:</b> Editing values here modifies the historical "Initial Budget" record. Default source is Navy General Fund. For specific sources, use "+ Funding".</div><div style="text-align:right;"><button class="btn-sync" style="width:auto;" onclick="closeModal('budgetModal')">Done</button></div></div></div>

<div id="invModal" class="modal-overlay">
    <div class="modal">
        <h3>Log Container</h3>

        <div class="input-grid">
            <input id="invId" class="form-control" placeholder="ID">
            
            <div style="display:flex; flex-direction:column; gap:5px;">
                <select id="invIso" class="form-control" style="margin:0;" onchange="toggleCustomIso(this.value)"></select>
                <input id="invIsoCustom" class="form-control" style="margin:0; display:none;" placeholder="Enter Isotope (e.g. Pu-239)">
            </div>
            
            <input id="invDate" type="date" class="form-control" title="Date Measured/Received">
        </div>

        <div class="input-grid">
            <input id="invAct" class="form-control" placeholder="Activity (e.g. 10 mCi or Unknown)">
            <input id="invDose" type="text" class="form-control" placeholder="Dose Rate (e.g. 5 or Unknown)">
        </div>

        <div style="margin:10px 0;">
            <label style="font-size:0.7rem; color:var(--text-muted);">FILL LEVEL: <span id="invFillLabel" style="font-weight:bold; color:var(--accent);">0%</span></label>
            <input id="invFill" type="range" min="0" max="100" value="0" style="width:100%" oninput="document.getElementById('invFillLabel').innerText = this.value + '%'">
        </div>

        <label style="font-size:0.7rem; color:var(--text-muted);">ASSIGN TO PROJECT</label>
        <select id="invProj" class="form-control"></select>
        
        <select id="invStatus" class="form-control">
            <option>Stored</option>
            <option>Staged</option>
            <option>Shipped</option>
        </select>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('invModal')">Cancel</button>
            <button class="btn" onclick="addInventory()">Log</button>
        </div>
    </div>
</div>

<div id="exportModal" class="modal-overlay"><div class="modal"><h3>Export Data</h3><p style="color:var(--text-muted);">Copy this code.</p><textarea id="exportText" class="form-control" style="height:200px; font-size:0.8rem;"></textarea><div style="text-align:right; margin-top:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('exportModal')">Close</button>

<button class="btn" onclick="copyExport()">Copy Text</button>
<button class="btn" style="background:var(--navy)" onclick="downloadBackup()">Download File</button>

<div id="importModal" class="modal-overlay"><div class="modal"><h3>Import Data</h3><p style="color:var(--text-muted);">Paste data code.</p><textarea id="importText" class="form-control" style="height:200px; font-size:0.8rem;"></textarea><div style="text-align:right; margin-top:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('importModal')">Cancel</button><button class="btn" onclick="runImport()">Load</button></div></div></div>

<div id="exemptModal" class="modal-overlay">
    <div class="modal">
        <h3>Log Exempt Disposal</h3>
        <div class="input-grid">
            <div><label style="font-size:0.7rem; color:var(--text-muted)">LOG ID (Optional)</label><input id="exLogId" class="form-control" placeholder="Auto-generate"></div>
            <div><label style="font-size:0.7rem; color:var(--text-muted)">DATE REC'D</label><input id="exDate" type="date" class="form-control"></div>
        </div>
        <label style="font-size:0.7rem; color:var(--text-muted)">GENERATING COMMAND</label>
        <input id="exCmd" class="form-control" placeholder="Command Name">
        <label style="font-size:0.7rem; color:var(--text-muted)">DESCRIPTION / ITEM</label>
        <input id="exDesc" class="form-control" placeholder="Item Description">
        <div class="input-grid">
            <input id="exQty" class="form-control" placeholder="Qty">
            <input id="exIso" class="form-control" placeholder="Isotope">
            <input id="exAct" class="form-control" placeholder="Activity">
        </div>
        <label style="font-size:0.7rem; color:var(--text-muted)">REGULATORY BASIS</label>
        <select id="exBasis" class="form-control">
            <option>10 CFR § 30.15</option>
            <option>10 CFR § 30.19</option>
            <option>10 CFR § 40.13</option>
            <option>Other</option>
        </select>
        <label style="font-size:0.7rem; color:var(--text-muted)">DISPOSAL PATHWAY</label>
        <select id="exPath" class="form-control">
            <option>E-Waste Recycling</option>
            <option>Scrap Metal</option>
            <option>Municipal Trash</option>
            <option>Transfer</option>
        </select>
        <div class="input-grid">
            <div><label style="font-size:0.7rem; color:var(--text-muted)">REVIEWER</label><input id="exRev" class="form-control" placeholder="Initials"></div>
            <div><label style="font-size:0.7rem; color:var(--text-muted)">AUTH DATE</label><input id="exAuthDate" type="date" class="form-control"></div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('exemptModal')">Cancel</button>
            <button class="btn" onclick="addExemptEntry()">Save Entry</button>
        </div>
    </div>
</div>

<script>
    const APP_VER = "RadFlow v25.7";

    const toastBox = document.createElement('div');
    toastBox.className = 'toast-container';
    document.body.appendChild(toastBox);

    document.title = APP_VER;
    document.getElementById('app-title-display').innerText = APP_VER;

    const COST_DB = {
        labor: {
            'sb': { name: 'Senior Broker', rate: 125.90, unit: 'Hour' },
            'st': { name: 'Senior Technician', rate: 85.83, unit: 'Hour' },
            'jt': { name: 'Junior Technician', rate: 79.68, unit: 'Hour' }
        },
        trans: {
            'truck': { name: 'Truck (Exclusive)', rate: 6.04, unit: 'Mile' },
            'van': { name: 'Van (Delivery)', rate: 4.64, unit: 'Mile' }
        },
        disposal: {
            'bulk': { name: 'Bulk Waste - Exempt', rate: 34.10, unit: 'Cubic Feet' },
            'classA': { name: 'Class A Sealed Source', rate: 384.33, unit: 'Source' },
            'classB': { name: 'Class B Sealed Source', rate: 469.50, unit: 'Source' },
            'classC': { name: 'Class C Sealed Source', rate: 557.24, unit: 'Source' },
            'daw': { name: 'Dry Active Waste (DAW)', rate: 162.29, unit: 'Cubic Feet' },
            'exempt': { name: 'Exempt Commodities', rate: 159.40, unit: 'Cubic Feet' },
            'llmw': { name: 'Low-Level Mixed Waste', rate: 435.45, unit: 'Cubic Feet' },
            'lsc': { name: 'Mixed Waste - LSC Vials', rate: 1327.26, unit: 'Cubic Feet' },
            'h3': { name: 'Tritium Recycling', rate: 20.75, unit: 'Curie' },
            'sol': { name: 'Acetate/Nitrate Sol.', rate: 407.53, unit: 'Gallon' }
        },
        container: {
            'tri': { name: '1 CY Tri-Wall', rate: 110.45, unit: 'Container' },
            '30gal': { name: '30 Gal Drum (Type A)', rate: 115.19, unit: 'Container' },
            '5gal': { name: '5 Gal Drum (Type A)', rate: 39.89, unit: 'Container' },
            '55gal': { name: '55 Gal Drum (Type A)', rate: 126.68, unit: 'Container' },
            'b25': { name: 'B25 Box (IP-1)', rate: 2026.90, unit: 'Container' },
            'b25a': { name: 'B25 Box (Type A)', rate: 4118.86, unit: 'Container' }
        },
        sample: {
            'gamma': { name: 'Gamma Spectroscopy', rate: 117.47, unit: 'Sample' },
            'h3': { name: 'Tritium Analysis', rate: 53.15, unit: 'Sample' },
            'sr': { name: 'Strontium Analysis', rate: 158.15, unit: 'Sample' },
            'tclp': { name: 'TCLP', rate: 1105.07, unit: 'Sample' }
        }
    };

    const ISOTOPE_DB = {
    'Co-60': { hl: 5.27, name: 'Cobalt-60' },
    'Cs-137': { hl: 30.17, name: 'Cesium-137' },
    'Ir-192': { hl: 0.202, name: 'Iridium-192' },
    'Am-241': { hl: 432.2, name: 'Americium-241' },
    'Sr-90':  { hl: 28.79, name: 'Strontium-90' },
    'H-3':    { hl: 12.32, name: 'Tritium' },
    'C-14':   { hl: 5730, name: 'Carbon-14' },
    'Ni-63':  { hl: 100.1, name: 'Nickel-63' },
    'Ra-226': { hl: 1600, name: 'Radium-226' },
    'Th-232': { hl: 1.405e10, name: 'Thorium-232' },
    'U-238':  { hl: 4.468e9, name: 'Uranium-238' },
    'I-131':  { hl: 0.022, name: 'Iodine-131' }, 
    'Tc-99m': { hl: 0.00068, name: 'Technetium-99m' },
    'Cf-252': { hl: 2.645, name: 'Californium-252' },
    'Unknown': { hl: 0, name: 'Unknown / Mixed' } // Safe fallback
};

    const getTodayStr = () => {
        const d = new Date();
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().split('T')[0];
    };

const STARTER_DATA = {
        projects: [
            { 
                id: 101, 
                title: "Class B Resin Shipment", 
                uic: "N00014", 
                location: "Norfolk, VA", 
                region: "East", 
                reqDate: "2025-06-15", 
                jmcId: "2025-045", 
                rcn: "25-0012", 
                pickupStatus: "Scheduled", 
                status: "Active", 
                health: "green", 
                due: "2025-12-30", 
                desc: "Transport of CNS 8-120B Cask containing exhausted resin liners.", 
                links:[], 
                tasks: [
                    {id: 1, text: "Verify Cask Cert", done: true, assign: "JD", prio: "high"}, 
                    {id: 2, text: "Notify Broker", done: true, assign: "AS", prio: "med"}, 
                    {id: 3, text: "Schedule 100-ton Crane", done: false, assign: "JD", prio: "high"}
                ],
                updatesSent: ["2025-10-01"]
            },
            { 
                id: 102, 
                title: "Lab 4 Cleanout", 
                uic: "N66001", 
                location: "San Diego, CA", 
                region: "West", 
                reqDate: "2025-08-01", 
                jmcId: "2025-099", 
                rcn: "25-0104", 
                pickupStatus: "Requested", 
                status: "Planning", 
                health: "yellow", 
                due: "2026-02-15", 
                desc: "Volume reduction and segregation of legacy Dry Active Waste (DAW).", 
                links:[], 
                tasks: [
                    {id: 1, text: "Order 10 B-25 Boxes", done: false, assign: "AS", prio: "low"},
                    {id: 2, text: "Survey Lab Corners", done: true, assign: "JD", prio: "med"}
                ],
                updatesSent: []
            },
            { 
                id: 103, 
                title: "Building 5 Decommissioning", 
                uic: "N4523A", 
                location: "Bremerton, WA", 
                region: "West", 
                reqDate: "2025-04-10", 
                jmcId: "2025-012", 
                rcn: "25-0003", 
                pickupStatus: "Shipped", 
                status: "Active", 
                health: "green", 
                due: "2025-11-20", 
                desc: "Large scale D&D of former radiography bay. Concrete scabbling required.", 
                links: [
                    {name: "Survey Map", url: "file:///S:/RadSafety/B5_Map.pdf"},
                    {name: "MARSSIM Plan", url: "https://www.nrc.gov/marssim"}
                ], 
                tasks: [
                    {id: 1, text: "Hire Scabbling Contractor", done: true, assign: "Admin", prio: "high"},
                    {id: 2, text: "Final Status Survey (FSS)", done: false, assign: "AS", prio: "high"},
                    {id: 3, text: "Dispose of Rubble", done: false, assign: "JD", prio: "med"}
                ],
                updatesSent: ["2025-09-15", "2025-08-01"]
            },
            { 
                id: 104, 
                title: "Quarterly Source Roundup", 
                uic: "N00014", 
                location: "Washington, DC", 
                region: "East", 
                reqDate: "2025-01-10", 
                jmcId: "2025-001", 
                rcn: "25-0001", 
                pickupStatus: "Complete", 
                status: "Complete", 
                health: "green", 
                due: "2025-03-01", 
                desc: "Consolidation of unwanted check sources from R&D labs.", 
                links:[], 
                tasks: [
                    {id: 1, text: "Collect Pu-239 sources", done: true, assign: "JD", prio: "high"}
                ],
                updatesSent: []
            },
            { 
                id: 105, 
                title: "Yokosuka Emergency Support", 
                uic: "N62742", 
                location: "Yokosuka, Japan", 
                region: "Far-East", 
                reqDate: "2025-11-01", 
                jmcId: "2025-200", 
                rcn: "25-0400", 
                pickupStatus: "Pending", 
                status: "Review", 
                health: "red", 
                due: "2025-12-01", 
                desc: "Emergency technical support for detection anomaly. Funding critical.", 
                links:[], 
                tasks: [
                    {id: 1, text: "Secure Travel Orders", done: true, assign: "Admin", prio: "high"},
                    {id: 2, text: "Ship Equipment", done: false, assign: "AS", prio: "high"}
                ],
                updatesSent: ["2025-10-20"]
            },
            { 
                id: 106, 
                title: "Base-wide Tritium Sign Disposal", 
                uic: "N00250", 
                location: "Rota, Spain", 
                region: "Europe", 
                reqDate: "2025-09-01", 
                jmcId: "2025-088", 
                rcn: "25-0210", 
                pickupStatus: "Staged", 
                status: "Active", 
                health: "green", 
                due: "2026-01-15", 
                desc: "Consolidation of expired H-3 exit signs from barracks renovation.", 
                links:[], 
                tasks: [
                    {id: 1, text: "Wipe Test 150 Signs", done: false, assign: "M. Scott", prio: "med"},
                    {id: 2, text: "Package into Tri-walls", done: false, assign: "M. Scott", prio: "low"}
                ],
                updatesSent: []
            },
            { 
                id: 107, 
                title: "NDT Source Exchange (SSN-774)", 
                uic: "N4523A", 
                location: "Pearl Harbor, HI", 
                region: "Far-East", 
                reqDate: "2025-02-14", 
                jmcId: "2025-030", 
                rcn: "25-0055", 
                pickupStatus: "Shipped", 
                status: "Complete", 
                health: "green", 
                due: "2025-02-28", 
                desc: "Urgent exchange of decayed Ir-192 radiography camera source.", 
                links: [
                   {name: "Source Cert (New)", url: "file:///S:/Certs/Ir192_New.pdf"}
                ], 
                tasks: [
                    {id: 1, text: "Receive New Source", done: true, assign: "JD", prio: "high"},
                    {id: 2, text: "Return Old Source", done: true, assign: "JD", prio: "high"}
                ],
                updatesSent: ["2025-02-20"]
            },
            { 
                id: 108, 
                title: "Medical Irradiator Decomm", 
                uic: "N00014", 
                location: "Bethesda, MD", 
                region: "East", 
                reqDate: "2025-07-01", 
                jmcId: "2025-110", 
                rcn: "25-0500", 
                pickupStatus: "Planning", 
                status: "Planning", 
                health: "yellow", 
                due: "2026-06-30", 
                desc: "Removal of legacy Cs-137 blood irradiator. Security escort required.", 
                links:[], 
                tasks: [
                    {id: 1, text: "Submit security plan", done: false, assign: "Admin", prio: "high"},
                    {id: 2, text: "Hire riggers", done: false, assign: "AS", prio: "med"}
                ],
                updatesSent: []
            }
        ],
        allocations: [
            { id: 1, projId: 101, date: "2025-01-01", amount: 85000, desc: "Initial Budget", type: 'base', fundSource: "Navy General Fund" },
            { id: 2, projId: 102, date: "2025-01-10", amount: 12000, desc: "Initial Budget", type: 'base', fundSource: "Navy General Fund" },
            { id: 3, projId: 103, date: "2025-02-01", amount: 150000, desc: "Initial Budget", type: 'base', fundSource: "Navy General Fund" },
            { id: 4, projId: 103, date: "2025-06-01", amount: 50000, desc: "Command Top-up", type: 'adj', fundSource: "Command Funded" },
            { id: 5, projId: 104, date: "2025-01-05", amount: 5000, desc: "Initial Budget", type: 'base', fundSource: "Other" },
            { id: 6, projId: 105, date: "2025-10-15", amount: 25000, desc: "Emergency Auth", type: 'base', fundSource: "Navy General Fund" },
            { id: 7, projId: 106, date: "2025-08-01", amount: 8000, desc: "Initial Budget", type: 'base', fundSource: "Command Funded" },
            { id: 8, projId: 107, date: "2025-01-20", amount: 3500, desc: "Exchange Fee", type: 'base', fundSource: "Navy General Fund" },
            { id: 9, projId: 108, date: "2025-06-15", amount: 250000, desc: "Initial Budget", type: 'base', fundSource: "Navy General Fund" }
        ],
        inventory: [
            {id: "HIC-24-01", iso: "Co-60", act: "35 Ci", dose: 4500, fill: 95, status: "Staged", projId: 101, logDate: "2025-01-01"}, 
            {id: "DRM-24-55", iso: "H-3", act: "15 mCi", dose: 0.5, fill: 40, status: "Stored", projId: null, logDate: "2025-01-15"},
            {id: "BOX-25-01", iso: "Cs-137", act: "200 mCi", dose: 150, fill: 100, status: "Shipped", projId: 103, logDate: "2025-03-10"},
            {id: "BOX-25-02", iso: "Cs-137", act: "180 mCi", dose: 140, fill: 100, status: "Shipped", projId: 103, logDate: "2025-03-12"},
            {id: "DRM-25-10", iso: "Am-241", act: "50 uCi", dose: 0.1, fill: 10, status: "Stored", projId: 102, logDate: "2025-08-05"},
            {id: "BOX-25-88", iso: "H-3", act: "5 Ci", dose: 1.2, fill: 85, status: "Staged", projId: 106, logDate: "2025-09-10"},
            {id: "CAM-774-A", iso: "Ir-192", act: "85 Ci", dose: 6500, fill: 100, status: "Shipped", projId: 107, logDate: "2025-02-15"},
            {id: "IRR-01-X", iso: "Cs-137", act: "1200 Ci", dose: 85000, fill: 100, status: "Stored", projId: 108, logDate: "2025-07-10"}
        ],
        expenses: [
            {id: 1, projId: 101, desc: "Cask Rental", amount: 15000, date: "2025-11-01", status: "Paid", fundSource: "Navy General Fund"},
            {id: 2, projId: 103, desc: "Contract Labor (Week 1)", amount: 12500, date: "2025-04-15", status: "Invoiced", fundSource: "Navy General Fund"},
            {id: 3, projId: 103, desc: "Contract Labor (Week 2)", amount: 12500, date: "2025-04-22", status: "Invoiced", fundSource: "Navy General Fund"},
            {id: 4, projId: 103, desc: "Specialized Tooling", amount: 8400, date: "2025-05-01", status: "Paid", fundSource: "Command Funded"},
            {id: 5, projId: 104, desc: "FedEx Shipping", amount: 450, date: "2025-02-15", status: "Paid", fundSource: "Other"},
            {id: 6, projId: 105, desc: "Last Minute Airfare", amount: 4200, date: "2025-10-25", status: "Encumbered", fundSource: "Navy General Fund"},
            {id: 7, projId: 107, desc: "Source Exchange Fee", amount: 3200, date: "2025-02-28", status: "Paid", fundSource: "Navy General Fund"}
        ],
        exemptLog: [
            {id: "2025-001", date: "2025-03-14", cmd: "PSNS & IMF", desc: "Electron Tube, JAN-CTL-6551", qty: "12", iso: "Kr-85", act: "30 µCi", basis: "10 CFR § 30.15", path: "E-Waste Recycling", rev: "J. Doe", authDate: "2025-07-25"},
            {id: "2025-002", date: "2025-05-07", cmd: "NAVSTA NORFOLK", desc: "Lensatic Compass", qty: "1", iso: "H-3", act: "120 mCi", basis: "10 CFR § 30.19", path: "Transfer", rev: "A. Smith", authDate: ""},
            {id: "2025-003", date: "2025-06-12", cmd: "NSWCDD", desc: "Smoke Detectors (Expired)", qty: "50", iso: "Am-241", act: "50 uCi", basis: "10 CFR § 30.20", path: "Municipal Trash", rev: "J. Doe", authDate: "2025-06-15"},
            {id: "2025-004", date: "2025-08-22", cmd: "NAS JAX", desc: "Gas Chromatograph Foil", qty: "2", iso: "Ni-63", act: "15 mCi", basis: "10 CFR § 31.5", path: "Transfer", rev: "AS", authDate: "2025-09-01"},
            {id: "2025-005", date: "2025-09-05", cmd: "FRC WEST", desc: "Thoriated Welding Rods", qty: "5 lbs", iso: "Th-232", act: "0.5 uCi", basis: "10 CFR § 40.13", path: "Scrap Metal", rev: "JD", authDate: "2025-09-10"},
            {id: "2025-006", date: "2025-10-12", cmd: "NAVSEA", desc: "Spark Gaps (F-18)", qty: "8", iso: "Kr-85", act: "2 mCi", basis: "10 CFR § 30.15", path: "Transfer", rev: "AS", authDate: ""},
            {id: "2025-007", date: "2025-11-01", cmd: "BUMED", desc: "LSC Vials (Deregulated)", qty: "10 gal", iso: "H-3/C-14", act: "<0.05 uCi/g", basis: "10 CFR § 20.2005", path: "Incineration", rev: "JD", authDate: "2025-11-05"},
            {id: "2025-008", date: "2025-11-15", cmd: "NUWC DIV", desc: "Static Eliminators (Brushes)", qty: "2", iso: "Po-210", act: "500 uCi", basis: "10 CFR § 31.3", path: "Transfer", rev: "Admin", authDate: ""}
        ],
        team: ["JD", "AS", "Admin", "M. Scott", "D. Schrute"],
        chat: [
            {user: "System", time: "01/01 08:00 AM", text: `${APP_VER} initialized.`},
            {user: "Admin", time: "01/01 09:15 AM", text: "Welcome to the new fiscal year tracker. Please update your project statuses."},
            {user: "JD", time: "01/02 10:00 AM", text: "Working on the Cask shipment. Crane is scheduled tentatively."},
            {user: "System", time: "03/10 02:30 PM", text: "Project <b>Building 5 Decommissioning</b> moved to Active."},
            {user: "AS", time: "04/05 11:45 AM", text: "Heads up: Medical Irradiator project is coming down the pipe. Big budget item."}
        ],
        wiki: "LOGBOOK:\n- Use this space for daily operational notes.\n- 01/15: Annual calibration due for meter SN: 44521.\n- 02/20: Updated waste acceptance criteria received from WCS.\n- 09/01: Tritium exit sign project approved for Rota."
    };

    let projects = []; let inventory = []; let expenses = []; let allocations = []; let chatLog = []; let team = []; let wikiText = "";
    let estItems = []; let exemptLog = [];
    let showComplete = false; let viewMode = 'list'; let hpState = {iso:'Co-60', a0:'', date:''};

let sortState = { table: '', col: 0, dir: 1 };

// Dashboard Widget States ---
    let dashTaskSort = 'prio';   // Options: 'prio', 'oldest', 'newest'
    let dashInvSort = 'dose';    // Options: 'dose', 'fill', 'recent'

    let dashProjSort = 'newest'; 

    function setDashSort(type, mode) {
        if(type === 'task') dashTaskSort = mode;
        if(type === 'inv') dashInvSort = mode;
        
        // NEW: Handle Project Sort
        if(type === 'proj') dashProjSort = mode; 
        
        render(); 
    }

    const esc = (t) => {
    if (t === null || t === undefined) return '';
    return t.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
};

    let budgetScope = 'all'; // 'range' or 'all'

    function toggleBudgetScope() {
        budgetScope = budgetScope === 'range' ? 'all' : 'range';
        render(); // Re-render to update the table numbers
    }

let finStart = "";
    let finEnd = "";

    function applyFinFilter() {
        finStart = document.getElementById('fin-start').value;
        finEnd = document.getElementById('fin-end').value;
        render(); // Re-render the dashboard with new filters
    }

    function clearFinFilter() {
        finStart = "";
        finEnd = "";
        document.getElementById('fin-start').value = "";
        document.getElementById('fin-end').value = "";
        render();
    }

// Escapes characters that break JavaScript strings inside HTML attributes
const jsEsc = (t) => {
    if (t === null || t === undefined) return '';
    return t.toString().replace(/['"\\]/g, '\\$&');
};
    
    function formatLink(url) {
        let clean = url.trim().replace(/^"|"$/g, '');
        if (/^[a-zA-Z]:\\/.test(clean) || /^[a-zA-Z]:\//.test(clean)) {
            return 'file:///' + clean;
        }
        if (!clean.startsWith('http') && !clean.startsWith('file:') && !clean.startsWith('//')) {
             if (clean.startsWith('www.')) return 'https://' + clean;
        }
        return clean;
    }

    function showToast(msg, type='success') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<span>${msg}</span><i class="fa-solid fa-xmark" style="cursor:pointer" onclick="this.parentElement.remove()"></i>`;
        toastBox.appendChild(t);
        setTimeout(() => { t.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    function logSystemAction(msg) {
        const now = new Date();
        const dateStr = (now.getMonth()+1).toString().padStart(2,'0') + '/' + now.getDate().toString().padStart(2,'0');
        const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        chatLog.push({user: "System", time: `${dateStr} ${timeStr}`, text: msg});
        saveLocally();
        render(); 
    }

    function generateLogId() {
        const yr = new Date().getFullYear();
        const count = exemptLog.length + 1;
        return `${yr}-${count.toString().padStart(3, '0')}`;
    }

    function addExemptEntry() {
        const entry = {
            id: document.getElementById('exLogId').value || generateLogId(),
            date: document.getElementById('exDate').value,
            cmd: document.getElementById('exCmd').value,
            desc: document.getElementById('exDesc').value,
            qty: document.getElementById('exQty').value,
            iso: document.getElementById('exIso').value,
            act: document.getElementById('exAct').value,
            basis: document.getElementById('exBasis').value,
            path: document.getElementById('exPath').value,
            rev: document.getElementById('exRev').value,
            authDate: document.getElementById('exAuthDate').value
        };
        exemptLog.push(entry);
        saveLocally();
        render();
        closeModal('exemptModal');
        showToast("Log Entry Added");
    }
    
    function downloadExemptCSV() {
        let csv = "Log #,Date Received,Command,Description,Qty,Nuclide,Activity,Basis,Pathway,Reviewer,Date Authorized\n";
        exemptLog.forEach(e => {
            const cleanDesc = `"${(e.desc||'').replace(/"/g, '""')}"`;
            csv += `${e.id},${e.date},"${e.cmd}",${cleanDesc},${e.qty},${e.iso},"${e.act}","${e.basis}","${e.path}","${e.rev}",${e.authDate}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `exempt_log_${getTodayStr()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function getProjectBudget(pid) {
        return allocations.filter(a => a.projId === pid).reduce((sum, a) => sum + (parseFloat(a.amount)||0), 0);
    }

function toggleCustomIso(val) {
    const input = document.getElementById('invIsoCustom');
    if (val === 'Custom') {
        input.style.display = 'block';
        input.focus();
    } else {
        input.style.display = 'none';
        input.value = ''; // Clear it if they switch back
    }
}
    
    function populateIsoSelects() {
    // Generate the list from DB
    let opts = Object.keys(ISOTOPE_DB).map(k => `<option value="${k}">${ISOTOPE_DB[k].name}</option>`).join('');
    
    // Add the Custom option at the end
    opts += `<option value="Custom">-- Custom / Other --</option>`;

    document.getElementById('calc-iso').innerHTML = opts;
    document.getElementById('invIso').innerHTML = opts;
}

    function getFundColor(f) {
        if(!f) return 'var(--text-muted)';
        if(f.includes('Navy')) return 'var(--navy)';
        if(f.includes('Command')) return 'var(--cmd)';
        return 'var(--text-muted)';
    }
    function getFundShort(f) {
        if(!f) return 'OTH';
        if(f.includes('Navy')) return 'NGF';
        if(f.includes('Command')) return 'CMD';
        return 'OTH';
    }

function expandChart() {
        // 1. Open the modal
        openModal('chartModal');
        
        // 2. Temporarily point the chart logic to the large container
        const originalContainer = document.getElementById('monthly-spend-chart');
        const largeContainer = document.getElementById('large-chart-container');
        
        // We create a temporary div ID for the render function to find
        largeContainer.innerHTML = '<div id="temp-large-chart" class="bar-chart-v" style="height:100%"></div>';
        
        // 3. Hijack the render function logic slightly
        // We need to pass the target ID to renderMonthlyChart. 
        // Since we can't easily change the function signature everywhere, 
        // we'll copy the logic specifically for this view or modify renderMonthlyChart.
        
        // EASIER WAY: Modify renderMonthlyChart to accept a targetID
        renderMonthlyChart(null, 'temp-large-chart'); 
    }

function calculateDecay() {
    const iso = document.getElementById('calc-iso').value;
    const a0 = parseFloat(document.getElementById('calc-a0').value);
    const dStr = document.getElementById('calc-date').value;
    
    // --- FIX: Define tStr so the math below works ---
    const tStr = document.getElementById('calc-target-date').value; 
    
    if(!iso || !a0 || !dStr) {
        document.getElementById('calc-result').innerText = "---";
        return;
    }

    const hl = ISOTOPE_DB[iso].hl; 
    const d1 = new Date(dStr);
    
    // This line works now because tStr is defined above
    const d2 = tStr ? new Date(tStr) : new Date();
    
    const years = (d2 - d1) / (1000 * 60 * 60 * 24 * 365.25);
    
    const lambda = Math.log(2) / hl;
    const at = a0 * Math.exp(-lambda * years);
    
    document.getElementById('calc-result').innerText = at < 1 ? at.toFixed(4) : at.toFixed(2);
    
    const timeLabel = years < 0 ? "years prior" : "years decay";
    showToast(`Calculated: ${Math.abs(years).toFixed(2)} ${timeLabel}`);
}

    // Clear Estimate
    function clearEstimate() {
        if(confirm("Clear current estimate line items?")) {
            estItems = [];
            calcEstimate();
            showToast("Estimate Cleared");
        }
    }

    function getDominantSource(pid) {
        const allocs = allocations.filter(a => a.projId === pid);
        if(!allocs.length) return { name: "Unfunded", short: "---", color: "var(--text-muted)" };
        const sums = {};
        allocs.forEach(a => {
            const s = a.fundSource || "Navy General Fund";
            sums[s] = (sums[s] || 0) + (parseFloat(a.amount)||0);
        });
        const sorted = Object.keys(sums).sort((a,b) => sums[b] - sums[a]);
        const dom = sorted[0];
        return { name: dom, short: getFundShort(dom), color: getFundColor(dom) };
    }

    function getDueStatus(dateStr) {
    if(!dateStr) return { text: "No Date", color: "var(--text-muted)" };
    
    // --- FIX: Compare "YYYY-MM-DD" strings directly to avoid Timezone math ---
    const todayStr = getTodayStr(); // Uses local time already
    
    if (dateStr === todayStr) return { text: "Due Today", color: "var(--warning)" };
    if (dateStr < todayStr) return { text: "Overdue", color: "var(--danger)" };
    
    // Calculate days left for future only
    const d1 = new Date(dateStr);
    const d2 = new Date(todayStr);
    const diff = (d1 - d2) / (1000 * 60 * 60 * 24);
    
    return { text: `${Math.ceil(diff)} Days Left`, color: "var(--info)" };
}

    function updateEstItems() {
        const cat = document.getElementById('est-cat').value;
        const sel = document.getElementById('est-item');
        sel.innerHTML = '';
        const items = COST_DB[cat];
        Object.keys(items).forEach(k => {
            sel.innerHTML += `<option value="${k}" data-rate="${items[k].rate}" data-unit="${items[k].unit}">${items[k].name}</option>`;
        });
        updateEstUnit();
    }
    function updateEstUnit() {
        const cat = document.getElementById('est-cat').value;
        const itemKey = document.getElementById('est-item').value;
        const itemData = COST_DB[cat][itemKey];
        document.getElementById('est-unit').innerText = itemData.unit;
        document.getElementById('est-rate').value = itemData.rate;
    }
    function addEstItem() {
        const cat = document.getElementById('est-cat').value;
        const itemKey = document.getElementById('est-item').value;
        const qty = parseFloat(document.getElementById('est-qty').value);
        const rate = parseFloat(document.getElementById('est-rate').value);
        if(!qty || !rate) return;
        const itemData = COST_DB[cat][itemKey];
        estItems.push({
            id: Date.now(),
            name: itemData.name,
            cat: cat.charAt(0).toUpperCase() + cat.slice(1),
            rate: rate,
            qty: qty,
            total: rate * qty
        });
        document.getElementById('est-qty').value = '';

	saveLocally();

        calcEstimate();
    }
    function removeEstItem(id) {
        if(confirm("Remove this line item?")) {
            estItems = estItems.filter(i => i.id !== id);

	    saveLocally();

            calcEstimate();
        }
    }
    function calcEstimate() {
        let itemsTotal = 0;
        const tbody = document.getElementById('est-list');
        tbody.innerHTML = estItems.map(i => {
            itemsTotal += i.total;
            return `<tr><td>${i.cat}</td><td>${i.name}</td><td style="text-align:right">$${i.rate.toFixed(2)}</td><td style="text-align:right">${i.qty}</td><td style="text-align:right">$${i.total.toFixed(2)}</td><td><i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="removeEstItem(${i.id})"></i></td></tr>`;
        }).join('');
        document.getElementById('est-grand-total').innerText = "$" + itemsTotal.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('est-count').innerText = estItems.length;
        window.currentEstTotal = itemsTotal;
    }
    
function saveEstimateAction(mode) {
        const pidVal = document.getElementById('est-proj-select').value;
        const fund = document.getElementById('est-fund-select').value;
        
        if(!pidVal) { showToast("Select a project first", "error"); return; }
        const pid = parseInt(pidVal);
        const p = projects.find(x => x.id === pid);
        const pName = p ? p.title : "Unknown Project";

        let currentTotal = estItems.reduce((acc, item) => acc + item.total, 0);
        if(currentTotal <= 0) { showToast("Calculate an estimate first", "error"); return; }

        // CAPTURE THE DATA SNAPSHOT (The IGE)
        const estimateSnapshot = JSON.parse(JSON.stringify(estItems));

        if (mode === 'funding') {
            allocations.push({
                id: Date.now(),
                projId: pid,
                date: getTodayStr(),
                amount: currentTotal,
                desc: "Estimated Budget Added",
                type: "adj",
                fundSource: fund,
                details: estimateSnapshot
            });
            // --- NEW: Smart Log ---
            logSystemAction(`Funding Estimate <b>$${currentTotal.toLocaleString()}</b> added to <b>${esc(pName)}</b>.`);
            showToast("Added to Project Funding");
        } 
        else if (mode === 'expense') {
            expenses.push({
                id: Date.now(),
                projId: pid,
                desc: "Estimated Cost",
                amount: currentTotal,
                date: getTodayStr(),
                status: "Encumbered", 
                fundSource: fund,
                details: estimateSnapshot
            });
            // --- NEW: Smart Log ---
            logSystemAction(`Cost Estimate <b>$${currentTotal.toLocaleString()}</b> posted to <b>${esc(pName)}</b>.`);
            showToast("Posted as Expense");
        } 
        else if (mode === 'estimate') {
            expenses.push({
                id: Date.now(),
                projId: pid,
                desc: "Cost Estimate (Draft)",
                amount: currentTotal,
                date: getTodayStr(),
                status: "Estimate", 
                fundSource: fund,
                details: estimateSnapshot
            });
            // --- NEW: Smart Log ---
            logSystemAction(`Draft Estimate <b>$${currentTotal.toLocaleString()}</b> saved for <b>${esc(pName)}</b>.`);
            showToast("Saved as Draft Estimate");
        }
        
        // WIPE THE TOOL
        resetEstimator();

        saveLocally();
        render(); 
        nav('finance');
        if(mode === 'funding') switchFinTab('alloc');
        else switchFinTab('exp');
    }

    // NEW: Helper to clean up the estimator after use
    function resetEstimator() {
        estItems = [];
        document.getElementById('est-proj-select').value = ""; // Clear Project
        document.getElementById('est-qty').value = "";
        calcEstimate(); // Clears the table UI
    }

// --- NEW GLOBAL STATE ---
    let chartScale = 'month'; 

    function setChartScale(s) {
        chartScale = s;
        // Update Button Styles
        ['week','month','quarter','year'].forEach(k => {
            const btn = document.getElementById('btn-scale-'+k);
            if(k === s) { btn.style.background = 'var(--accent)'; btn.style.color = 'white'; }
            else { btn.style.background = 'transparent'; btn.style.color = 'var(--text-muted)'; }
        });
        render(); // Re-render the whole view
    }

// NEW: Open the IGE Viewer Modal
    function viewEstimate(id, type) {
        // Find the record
        const list = type === 'alloc' ? allocations : expenses;
        const rec = list.find(x => x.id === id);
        if(!rec || !rec.details) { showToast("No details attached", "error"); return; }

        // Populate Metadata
        document.getElementById('ige-meta-desc').innerText = rec.desc;
        document.getElementById('ige-meta-date').innerText = `Date: ${rec.date} | Source: ${rec.fundSource || 'N/A'}`;
        document.getElementById('ige-view-total').innerText = "$" + rec.amount.toLocaleString(undefined, {minimumFractionDigits:2});

        // Populate Table
        const tbody = document.getElementById('ige-view-list');
        tbody.innerHTML = rec.details.map(d => `
            <tr>
                <td>${esc(d.cat)}</td>
                <td>${esc(d.name)}</td>
                <td style="text-align:right">$${d.rate}</td>
                <td style="text-align:right">${d.qty}</td>
                <td style="text-align:right">$${d.total.toFixed(2)}</td>
            </tr>
        `).join('');

        // Setup Download Button
        const btnContainer = document.getElementById('ige-dl-btn-container');
        btnContainer.innerHTML = `<button class="btn" style="padding:4px 10px; font-size:0.8rem;" onclick="downloadIGE(${id}, '${type}')"><i class="fa-solid fa-file-excel"></i> Download IGE</button>`;

        openModal('estimateViewModal');
    }

    // NEW: Generate CSV from attached details
    function downloadIGE(id, type) {
        const list = type === 'alloc' ? allocations : expenses;
        const rec = list.find(x => x.id === id);
        if(!rec || !rec.details) return;

        let csv = "Category,Item,Rate,Quantity,Total Cost\n";
        rec.details.forEach(d => {
            csv += `"${d.cat}","${d.name}",${d.rate},${d.qty},${d.total}\n`;
        });
        
        // Add footer totals
        csv += `,,,TOTAL,${rec.amount}\n`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `IGE_${rec.date}_${type}_${id}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

function renderMonthlyChart(data, targetId = 'monthly-spend-chart') {
        let chartData = data;
        
        // Handle fallback data if null passed
        if(!chartData) {
            const isDateInScope = (dateStr) => {
                if (!finStart && !finEnd) return true;
                if (finStart && dateStr < finStart) return false;
                if (finEnd && dateStr > finEnd) return false;
                return true;
            };
            chartData = expenses.filter(e => isDateInScope(e.date) && e.status !== 'Estimate');
        } else {
             // If data WAS passed (like from render function), make sure we filter it too
             chartData = chartData.filter(e => e.status !== 'Estimate');
        }

        const container = document.getElementById(targetId);
        
        if(chartData.length === 0) {
            container.innerHTML = '<div style="width:100%; text-align:center; color:var(--text-muted); padding:40px;">No activity in this period.</div>';
            return;
        }

        const timestamps = chartData.map(e => new Date(e.date + 'T12:00:00').getTime());
        if(finStart) timestamps.push(new Date(finStart + 'T12:00:00').getTime());
        if(finEnd) timestamps.push(new Date(finEnd + 'T12:00:00').getTime());
        
        const minDate = new Date(Math.min(...timestamps));
        const maxDate = new Date(Math.max(...timestamps));

        const timeline = [];
        let maxVal = 0;
        
        let current = new Date(minDate); 
        // Snap start date based on scale
        if(chartScale === 'month') current.setDate(1); 
        if(chartScale === 'year') { current.setMonth(0); current.setDate(1); }
        if(chartScale === 'week') { 
            const day = current.getDay(); 
            const diff = current.getDate() - day + (day == 0 ? -6 : 1); 
            current.setDate(diff);
        }

        while(current <= maxDate) {
            let lbl, nextDate;
            const y = current.getFullYear();
            
            if(chartScale === 'week') {
                const start = new Date(current);
                nextDate = new Date(current); nextDate.setDate(nextDate.getDate() + 7);
                lbl = `${start.getMonth()+1}/${start.getDate()}`;
            } 
            else if(chartScale === 'quarter') {
                const q = Math.floor(current.getMonth() / 3) + 1;
                lbl = `Q${q} ${y}`;
                nextDate = new Date(current); nextDate.setMonth(nextDate.getMonth() + 3);
            } 
            else if(chartScale === 'year') {
                lbl = `${y}`;
                nextDate = new Date(current); nextDate.setFullYear(nextDate.getFullYear() + 1);
            } 
            else { 
                const m = current.getMonth();
                lbl = current.toLocaleString('default', { month: 'short' }) + " '" + y.toString().substr(2);
                nextDate = new Date(current); nextDate.setMonth(nextDate.getMonth() + 1);
            }

            // FIX: Summing logic now uses Math.abs() to fix the "Negative Bar" glitch
            const bucketVal = chartData.reduce((acc, e) => {
                const d = new Date(e.date + 'T12:00:00');
                return (d >= current && d < nextDate) ? acc + Math.abs(parseFloat(e.amount)||0) : acc;
            }, 0);

            if(bucketVal > maxVal) maxVal = bucketVal;
            timeline.push({ label: lbl, val: bucketVal });

            current = nextDate; 
        }

        if(maxVal === 0) maxVal = 100;
        const fmt = (n) => n >= 1000 ? (n/1000).toFixed(1) + 'k' : n;

        const axisHtml = `
            <div class="chart-y-axis">
                <div>$${fmt(maxVal)}</div>
                <div>$${fmt(maxVal/2)}</div>
                <div>$0</div>
            </div>`;

        const barsHtml = `<div class="bar-chart-v" id="inner-chart-scroll-${targetId}">` + timeline.map(item => {
            const h = (item.val / maxVal) * 100;
            const opacity = item.val > 0 ? '1' : '0.3'; 
            const bg = item.val > 0 ? 'var(--money)' : 'var(--bg-input)';
            const valLbl = item.val > 0 ? `<div class="bar-top-lbl">$${fmt(item.val)}</div>` : '';
            
            return `<div class="bar-col">
                        <div class="bar-v" style="height:${h}%; background:${bg}; opacity:${opacity};">${valLbl}</div>
                        <div class="bar-lbl">${item.label}</div>
                    </div>`;
        }).join('') + `</div>`;

        container.innerHTML = `<div class="chart-wrapper" style="height:100%">${axisHtml}${barsHtml}</div>`;

        setTimeout(() => {
            const scroller = document.getElementById(`inner-chart-scroll-${targetId}`);
            if(scroller) scroller.scrollLeft = scroller.scrollWidth; 
        }, 50);
    }

    function quickAdd(type, pid) {
        if(type === 'task') {
            viewProject(pid);
            setTimeout(() => { document.getElementById('newT').focus(); }, 200);
        }
        if(type === 'expense') {
            openModal('expenseModal');
            document.getElementById('expProj').value = pid;
        }
    }

    // NEW: Helper for Updates Date List
    function addUpdateDate(pid, val) {
        if(!val) return;
        const p = projects.find(x => x.id === pid);
        if(!p.updatesSent) p.updatesSent = [];
        p.updatesSent.push(val);
        // Sort dates descending
        p.updatesSent.sort().reverse();
        saveLocally();
        viewProject(pid);
    }

// --- HELPER: Normalize Isotope Name ---
// Turns "co-60" -> "Co-60", "cs137" -> "Cs-137"
function normalizeIso(input) {
    if(!input) return "";
    
    // 1. Try to find a direct match in the DB (case-insensitive)
    const dbKey = Object.keys(ISOTOPE_DB).find(k => k.toLowerCase() === input.toLowerCase());
    if(dbKey) return dbKey;

    // 2. Formatting Fallback: Capitalize first letter (e.g., "am-241" -> "Am-241")
    return input.charAt(0).toUpperCase() + input.slice(1);
}
    
    function removeUpdateDate(pid, idx) {
        const p = projects.find(x => x.id === pid);
        p.updatesSent.splice(idx, 1);
        saveLocally();
        viewProject(pid);
    }

    function render(filter = "") {
        filter = filter.toLowerCase();
        document.getElementById('todayDate').innerText = new Date().toDateString();
        document.getElementById('btnShowComp').innerHTML = showComplete ? '<i class="fa-solid fa-eye-slash"></i> Hide Done' : '<i class="fa-solid fa-eye"></i> Show Done';
        
        // --- 1. PROJECT FILTERING (Global) ---
        let filteredProjs = projects.filter(p => p.title.toLowerCase().includes(filter) || p.desc.toLowerCase().includes(filter));
        if (!showComplete) filteredProjs = filteredProjs.filter(p => p.status !== 'Complete'); 

        const filteredInv = inventory.filter(i => i.id.toLowerCase().includes(filter));
        
        const dashProjDiv = document.getElementById('dash-projects');
        const projContainer = document.getElementById('full-project-list');
        
        // --- 2. DASHBOARD WIDGETS (Active Projects with Sorting) ---
        
        let displayProjs = [...filteredProjs]; 

        if(dashProjSort === 'newest') { displayProjs.reverse(); } 
        else if (dashProjSort === 'health') {
            const hMap = { 'red': 0, 'yellow': 1, 'green': 2 };
            displayProjs.sort((a,b) => (hMap[a.health]||2) - (hMap[b.health]||2));
        }
        else if (dashProjSort === 'status') {
             const sMap = { 'Active': 0, 'Review': 1, 'Planning': 2, 'Complete': 3 };
             displayProjs.sort((a,b) => (sMap[a.status]||4) - (sMap[b.status]||4));
        }

        const recentProjs = displayProjs.slice(0, 10);

        // UPDATED HEADER HTML: Tighter gap on left, more buffer on right
        const projHeaderHtml = `
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <span>Active Projects</span>
                    <select class="sort-select" onchange="setDashSort('proj', this.value)">
                        <option value="newest" ${dashProjSort==='newest'?'selected':''}>Newest</option>
                        <option value="oldest" ${dashProjSort==='oldest'?'selected':''}>Oldest</option>
                        <option value="health" ${dashProjSort==='health'?'selected':''}>Health</option>
                        <option value="status" ${dashProjSort==='status'?'selected':''}>Status</option>
                    </select>
                </div>
                <span style="font-size:0.75rem; cursor:pointer; color:var(--accent); font-weight:bold; white-space:nowrap; margin-left:15px;" onclick="nav('projects')">View All &rarr;</span>
            </div>`;

        const projListHtml = recentProjs.length ? recentProjs.map(p => {
            const pct = p.tasks && p.tasks.length ? Math.round((p.tasks.filter(t=>t.done).length/p.tasks.length)*100) : 0;
            return `
            <div class="list-item" onclick="viewProject(${p.id})">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:600;">
                            <span class="rag-dot" style="background:${p.health==='red'?'var(--danger)':(p.health==='yellow'?'var(--warning)':'var(--accent)')}"></span>
                            ${esc(p.title)}
                        </div>
                        <span style="font-size:0.7rem; color:var(--text-muted); margin-right:10px;">${p.status}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>
                <div class="quick-actions">
                    <div class="qa-btn qa-task" onclick="event.stopPropagation(); quickAdd('task', ${p.id})" title="Add Task"><i class="fa-solid fa-check"></i></div>
                    <div class="qa-btn qa-exp" onclick="event.stopPropagation(); quickAdd('expense', ${p.id})" title="Add Expense"><i class="fa-solid fa-dollar-sign"></i></div>
                </div>
            </div>`;
        }).join('') : '<div style="color:var(--text-muted); padding:10px;">No Matches</div>';

        // 6. Inject into DOM
        const projWidget = document.getElementById('dash-projects').parentElement;
        projWidget.querySelector('.widget-head').innerHTML = projHeaderHtml; 
        document.getElementById('dash-projects').innerHTML = projListHtml;

        // --- 3. PROJECT VIEW (List vs Kanban) ---
        if (viewMode === 'list') {
            projContainer.innerHTML = filteredProjs.map(p => {
                const src = getDominantSource(p.id);
                return `<div class="list-item" onclick="viewProject(${p.id})"><span><span class="rag-dot" style="background:${p.health==='red'?'var(--danger)':(p.health==='yellow'?'var(--warning)':'var(--accent)')}"></span>${esc(p.title)} <span class="tag" style="background:${src.color}; color:white; border:none; margin-left:8px;">${src.short}</span></span><span>${p.status} | Due: ${p.due}</span></div>`;
            }).join('');
        } else {
            const cols = { 'Planning': [], 'Active': [], 'Review': [], 'Complete': [] };
            filteredProjs.forEach(p => { if (cols[p.status]) cols[p.status].push(p); });
            const hCols = { 'Planning': 'var(--plan)', 'Active': 'var(--accent)', 'Review': 'var(--info)', 'Complete': 'var(--comp)' };
            projContainer.innerHTML = `<div class="kanban-board">${Object.keys(cols).map(status => `
                <div class="kanban-col" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="drop(event, '${status}')">
                    <div class="kanban-head" style="color:${hCols[status]}; border-bottom-color:${hCols[status]}">${status} (${cols[status].length})</div>
                    ${cols[status].map(p => { 
                        const spent = expenses.filter(e => e.projId === p.id).reduce((s, e) => s + parseFloat(e.amount), 0); 
                        const budget = getProjectBudget(p.id);
                        const isOver = spent > budget && budget > 0;
                        const src = getDominantSource(p.id);
                        return `<div class="kanban-card ${isOver?'over-budget':''}" draggable="true" ondragstart="drag(event, ${p.id})" onclick="viewProject(${p.id})">
                            <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px;">${esc(p.title)}</div>
                            <div style="margin-bottom:5px;"><span class="tag" style="background:${src.color}; color:white; border:none;">${src.short}</span></div>
                            <div style="display:flex; justify-content:space-between; align-items:center;"><span class="rag-dot" style="background:${p.health==='red'?'var(--danger)':(p.health==='yellow'?'var(--warning)':'var(--accent)')}"></span><span class="tag">${(p.tasks||[]).filter(t=>!t.done).length} open</span></div>
                        </div>`; 
                    }).join('')}
                </div>`).join('')}</div>`;
        }

        // --- 4. TASKS & INVENTORY WIDGETS (Dynamic Sorting) ---
        
        // A. PREPARE TASKS
        let allTasks = [];
        filteredProjs.forEach(p => { 
            if(p.tasks) {
                p.tasks.forEach(t => { 
                    if(!t.done && t.text.toLowerCase().includes(filter)) {
                        allTasks.push({ task: t, proj: p });
                    }
                });
            }
        });

        if(dashTaskSort === 'prio') {
            const pMap = {'high':0, 'med':1, 'low':2};
            allTasks.sort((a,b) => (pMap[a.task.prio]||1) - (pMap[b.task.prio]||1));
        } else if (dashTaskSort === 'oldest') {
            allTasks.sort((a,b) => a.task.id - b.task.id); 
        } else if (dashTaskSort === 'newest') {
            allTasks.sort((a,b) => b.task.id - a.task.id);
        }

        // UPDATED TASK HEADER
        const taskHeaderHtml = `
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <span>Pending Actions</span>
                <select class="sort-select" onchange="setDashSort('task', this.value)">
                    <option value="prio" ${dashTaskSort==='prio'?'selected':''}>Highest Prio</option>
                    <option value="newest" ${dashTaskSort==='newest'?'selected':''}>Newest</option>
                    <option value="oldest" ${dashTaskSort==='oldest'?'selected':''}>Oldest</option>
                </select>
            </div>`;

        const taskListHtml = allTasks.slice(0, 10).map(item => {
            const t = item.task;
            const p = item.proj;
            let borderCol = 'var(--border)';
            if(t.prio === 'high') borderCol = 'var(--danger)';
            if(t.prio === 'med') borderCol = 'var(--warning)';

            return `<div class="list-item" style="border-left-color:${borderCol}" onclick="viewProject(${p.id})">
                        <span>${esc(t.text)} <span class="tag">${esc(t.assign||'?')}</span></span>
                        <span style="font-size:0.7rem; color:var(--text-muted)">${esc(p.title)}</span>
                    </div>`; 
        }).join('') || '<div style="color:var(--text-muted); padding:10px;">No Pending Actions</div>';
        
        const taskWidget = document.getElementById('dash-tasks').parentElement;
        taskWidget.querySelector('.widget-head').innerHTML = taskHeaderHtml;
        document.getElementById('dash-tasks').innerHTML = taskListHtml;


        // B. PREPARE INVENTORY
        if(dashInvSort === 'dose') { filteredInv.sort((a,b) => b.dose - a.dose); } 
        else if (dashInvSort === 'fill') { filteredInv.sort((a,b) => (b.fill||0) - (a.fill||0)); } 
        else if (dashInvSort === 'recent') { filteredInv.sort((a,b) => (b.logDate || "").localeCompare(a.logDate || "")); }

        // UPDATED INVENTORY HEADER
        const invHeaderHtml = `
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <span>Inventory</span>
                <select class="sort-select" onchange="setDashSort('inv', this.value)">
                    <option value="dose" ${dashInvSort==='dose'?'selected':''}>Highest Dose</option>
                    <option value="fill" ${dashInvSort==='fill'?'selected':''}>Fullest</option>
                    <option value="recent" ${dashInvSort==='recent'?'selected':''}>Newest</option>
                </select>
            </div>`;

        const invListHtml = filteredInv.slice(0, 10).map(i => {
            let valDisplay = `${i.dose} mR/hr`;
            if(dashInvSort === 'fill') valDisplay = `${i.fill||0}% Full`;
            if(dashInvSort === 'recent') valDisplay = i.logDate || 'No Date';

            const isHighDose = i.dose >= 1000; 
            const rowStyle = isHighDose ? 'color:var(--danger); font-weight:bold;' : '';

            return `<div class="list-item">
                <span style="${rowStyle}">${esc(i.id)} <span style="font-size:0.7rem; color:var(--text-muted); font-weight:normal;">(${i.iso})</span></span>
                <span>${valDisplay}</span>
            </div>`;
        }).join('') || '<div style="color:var(--text-muted); padding:10px;">No Inventory</div>';

        const invWidget = document.getElementById('dash-inv').parentElement;
        invWidget.querySelector('.widget-head').innerHTML = invHeaderHtml;
        document.getElementById('dash-inv').innerHTML = invListHtml;

        // --- 5. GLOBAL FINANCIALS (For Dashboard Widget ONLY) ---
        // We use global 'allocations' and 'expenses' here for the "Snapshot"
        const globalBudg = allocations.reduce((s, a) => s + (parseFloat(a.amount)||0), 0);
        const globalSpent = expenses.filter(e => e.status !== 'Estimate').reduce((s, e) => s + (parseFloat(e.amount)||0), 0);
        const globalRem = globalBudg - globalSpent;
        const globalActive = new Set(expenses.map(e => e.projId)).size;
        
        const dashSources = {};
        expenses.forEach(e => { const s = e.fundSource || 'Other'; dashSources[s] = (dashSources[s]||0) + parseFloat(e.amount); });
        const dashSourceHtml = Object.keys(dashSources).map(k => `<div style="font-size:0.7rem; display:flex; justify-content:space-between; color:var(--text-muted);"><span><span class="legend-dot" style="background:${getFundColor(k)}"></span>${k}</span><span>$${dashSources[k].toLocaleString()}</span></div>`).join('');

        document.getElementById('dash-fin').innerHTML = `<div class="mini-fin-grid"><div class="mini-fin-box"><div class="mini-fin-val" style="color:var(--info);">$${globalBudg.toLocaleString()}</div><div class="mini-fin-lbl">Budget</div></div><div class="mini-fin-box"><div class="mini-fin-val" style="color:var(--warning);">$${globalSpent.toLocaleString()}</div><div class="mini-fin-lbl">Spent</div></div><div class="mini-fin-box"><div class="mini-fin-val" style="color:${globalRem<0?'var(--danger)':'var(--money)'};">$${globalRem.toLocaleString()}</div><div class="mini-fin-lbl">Rem.</div></div><div class="mini-fin-box"><div class="mini-fin-val" style="color:var(--rad);">${globalActive}</div><div class="mini-fin-lbl">Active</div></div></div><div style="margin-top:10px; padding-top:5px; border-top:1px dashed var(--border);">${dashSourceHtml || '<span style="font-size:0.7rem; color:var(--text-muted)">No data</span>'}</div>`;

        // --- 6. CHARTS (Project Status & Budget) ---
        const statuses = { 'Planning': 0, 'Active': 0, 'Review': 0, 'Complete': 0 };
        projects.forEach(p => { if (statuses[p.status] !== undefined) statuses[p.status]++; });
        const totalProjs = projects.length || 1;
        const sColors = { 'Planning': 'var(--plan)', 'Active': 'var(--accent)', 'Review': 'var(--info)', 'Complete': 'var(--comp)' };
        document.getElementById('chart-proj').innerHTML = Object.keys(statuses).map(k => { const pct = (statuses[k] / totalProjs) * 100; return pct > 0 ? `<div class="chart-seg" style="width:${pct}%; background:${sColors[k]}" title="${k}: ${statuses[k]}"></div>` : ''; }).join('');
        document.getElementById('legend-proj').innerHTML = Object.keys(statuses).map(k => statuses[k] > 0 ? `<div><span class="legend-dot" style="background:${sColors[k]}"></span>${k} (${statuses[k]})</div>` : '').join('');
        const spentPct = globalBudg > 0 ? Math.min((globalSpent/globalBudg)*100, 100) : 0;
        document.getElementById('chart-money').innerHTML = `<div class="chart-seg" style="width:${spentPct}%; background:var(--money);"></div>`;


        // ============================================================
        //  NEW: FINANCE VIEW LOGIC (WITH DATE FILTERS)
        // ============================================================
        
        // 1. Define Filter Function
        const isDateInScope = (dateStr) => {
            if (!dateStr) return false;
            // If user hasn't set filters, show everything
            if (!finStart && !finEnd) return true;
            
            // Compare string dates "YYYY-MM-DD" directly
            if (finStart && dateStr < finStart) return false;
            if (finEnd && dateStr > finEnd) return false;
            return true;
        };

        // 2. Create FILTERED lists
        const finExps = expenses.filter(e => isDateInScope(e.date));
        const finAllocs = allocations.filter(a => isDateInScope(a.date));

        // 3. Calculate Totals based on FILTERED data
        const finTotalBudg = finAllocs.reduce((s, a) => s + (parseFloat(a.amount)||0), 0);
        const finTotalSpent = finExps.filter(e => e.status !== 'Estimate').reduce((s, e) => s + Math.abs(parseFloat(e.amount)||0), 0);
        const finRemaining = finTotalBudg - finTotalSpent;
        const finActiveSpenders = new Set(finExps.map(e => e.projId)).size;
        
        // 4. Update Finance View Top Cards
        document.getElementById('fin-total-budget').innerText = "$" + finTotalBudg.toLocaleString();
        document.getElementById('fin-total-spent').innerText = "$" + finTotalSpent.toLocaleString();
        document.getElementById('fin-total-rem').innerText = "$" + finRemaining.toLocaleString();
        document.getElementById('fin-total-rem').style.color = finRemaining < 0 ? "var(--danger)" : "var(--money)";
        document.getElementById('fin-proj-count').innerText = finActiveSpenders;

        // 5. Update Monthly Chart (Pass filtered data!)
        renderMonthlyChart(finExps);

        // 6. Update Source Breakdown (Visualization Upgrade)
        const finSources = {};
        finExps.forEach(e => { const s = e.fundSource || 'Other'; finSources[s] = (finSources[s]||0) + parseFloat(e.amount); });

        document.getElementById('finance-source-breakdown').innerHTML = Object.keys(finSources).map(k => {
            const amt = finSources[k];
            const pct = finTotalSpent > 0 ? Math.round((amt / finTotalSpent) * 100) : 0;
            const color = getFundColor(k);
            
            // Choose icon based on source type
            let icon = 'fa-coins';
            if(k.includes('Navy')) icon = 'fa-anchor';
            if(k.includes('Command')) icon = 'fa-building-shield';

            return `
            <div class="fund-card" style="border-left-color:${color}">
                <div class="fund-head">
                    <span style="color:${color}"><i class="fa-solid ${icon}"></i> ${esc(k)}</span>
                    <span>${pct}%</span>
                </div>
                <div class="fund-meta">
                    <span>Total Spent</span>
                    <span style="font-weight:bold; color:var(--text-main);">$${amt.toLocaleString()}</span>
                </div>
                <div class="fund-bar-bg">
                    <div class="fund-bar-fill" style="width:${pct}%; background:${color}"></div>
                </div>
            </div>`;
        }).join('') || '<div style="color:var(--text-muted); font-size:0.8rem; text-align:center; padding:20px;">No expenses recorded in this period.</div>';

        // 7. Update Expense Table (Filtered)
        const sortedExps = getSortedData(finExps, 'table-exp');

	document.getElementById('expense-list').innerHTML = sortedExps.map(e => {
            const fund = e.fundSource || 'Other';
            let fundStyle = 'background:#f1f5f9; color:#64748b; border:1px solid #cbd5e1';
            if(fund.includes('Navy')) fundStyle = 'background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe';
            if(fund.includes('Command')) fundStyle = 'background:#f3e8ff; color:#6b21a8; border:1px solid #e9d5ff';
            const pTitle = projects.find(p => p.id === e.projId)?.title || "General";
            
            const isEst = e.status === 'Estimate';
            const rowStyle = isEst ? 'font-style:italic; opacity:0.7;' : '';

            // NEW: Check if IGE details exist
            const igeIcon = e.details 
                ? `<i class="fa-solid fa-file-invoice" style="cursor:pointer; color:var(--accent); margin-left:8px;" onclick="viewEstimate(${e.id}, 'expense')" title="View Estimate Details"></i>` 
                : '';

            return `<tr style="${rowStyle}">
                <td><input class="live-edit" type="date" value="${e.date}" onchange="updItem('expense', ${e.id}, 'date', this.value)"></td>
                <td><span class="proj-link" onclick="viewProject(${e.projId})">${esc(pTitle)}</span></td>
                <td><div class="tag" style="font-size:0.75rem; padding:4px 8px; border-radius:12px; display:inline-block; ${fundStyle}">${esc(fund)}</div></td>
                <td style="display:flex; align-items:center;"><input class="live-edit" value="${esc(e.desc)}" onchange="updItem('expense', ${e.id}, 'desc', this.value, this)"> ${igeIcon}</td>
                <td><input class="live-edit" type="number" value="${e.amount}" onchange="updItem('expense', ${e.id}, 'amount', this.value)"></td>
                <td>
                    <select class="live-edit" onchange="updItem('expense', ${e.id}, 'status', this.value)">
                        <option ${e.status==='Invoiced'?'selected':''}>Invoiced</option>
                        <option ${e.status==='Paid'?'selected':''}>Paid</option>
                        <option ${e.status==='Encumbered'?'selected':''}>Encumbered</option>
                        <option ${e.status==='Estimate'?'selected':''}>Estimate</option>
                    </select>
                </td>
                <td><div style="display:flex; gap:10px;"><i class="fa-solid fa-copy" style="cursor:pointer; color:var(--info)" onclick="cloneExpense(${e.id})" title="Duplicate"></i> <i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delExpense(${e.id})" title="Delete"></i></div></td>
            </tr>`;
        }).join('');
        
        // 8. Update Allocation Table (Filtered)
        const sortedAllocs = getSortedData(finAllocs, 'table-alloc');
	document.getElementById('alloc-list').innerHTML = sortedAllocs.map(a => {
            const fund = a.fundSource || 'Navy General Fund';
            const pTitle = projects.find(p => p.id === a.projId)?.title || "General";
            
            // NEW: Check if IGE details exist
            const igeIcon = a.details 
                ? `<i class="fa-solid fa-file-invoice" style="cursor:pointer; color:var(--accent); margin-left:8px;" onclick="viewEstimate(${a.id}, 'alloc')" title="View Estimate Details"></i>` 
                : '';

            return `<tr>
                <td><input class="live-edit" type="date" value="${a.date}" onchange="updItem('alloc', ${a.id}, 'date', this.value)"></td>
                <td><span class="proj-link" onclick="viewProject(${a.projId})">${esc(pTitle)}</span></td>
                <td><div class="tag">${esc(fund)}</div></td>
                <td style="display:flex; align-items:center;"><input class="live-edit" value="${esc(a.desc)}" onchange="updItem('alloc', ${a.id}, 'desc', this.value, this)"> ${igeIcon}</td>
                <td><input class="live-edit" type="number" value="${a.amount}" onchange="updItem('alloc', ${a.id}, 'amount', this.value)"></td>
                <td><i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delAlloc(${a.id})"></i></td>
            </tr>`;
        }).join('');

        // 9. Update Budget Rollup Logic (With Sorting!)
let grandInit = 0, grandAdj = 0, grandTot = 0, grandSpent = 0;

// A. Update the Scope Toggle Button
const btnScope = document.getElementById('btn-budget-scope');
if(btnScope) {
    btnScope.innerHTML = budgetScope === 'range' ? '<i class="fa-solid fa-filter"></i> In Range' : '<i class="fa-solid fa-infinity"></i> Lifetime';
    btnScope.style.background = budgetScope === 'range' ? 'var(--bg-input)' : 'var(--navy)';
    btnScope.style.color = budgetScope === 'range' ? 'var(--text-muted)' : 'white';
    btnScope.style.borderColor = budgetScope === 'range' ? 'var(--border)' : 'var(--navy)';
}

// B. Define Stats Helper
const getProjStats = (pid) => {
    const sourceAllocs = budgetScope === 'all' ? allocations : finAllocs;
    const sourceExps   = budgetScope === 'all' ? expenses    : finExps;
    const pAllocs = sourceAllocs.filter(a => a.projId === pid);
    const pExps = sourceExps.filter(e => e.projId === pid);
    
    const init = pAllocs.filter(a => a.type === 'base' || (!a.type && a.desc.toLowerCase().includes('initial'))).reduce((s,a)=>s+(parseFloat(a.amount)||0),0);
    const adj = pAllocs.filter(a => a.type !== 'base' && (a.type || !a.desc.toLowerCase().includes('initial'))).reduce((s,a)=>s+(parseFloat(a.amount)||0),0);
    const spent = pExps.filter(e => e.status !== 'Estimate').reduce((s,e)=>s+Math.abs(parseFloat(e.amount)||0),0);
    
    return { init, adj, total: init+adj, spent, rem: (init+adj)-spent };
};

// C. BUILD DATA ARRAY FIRST (Don't draw HTML yet)
let budgetData = projects.map(p => {
    const s = getProjStats(p.id);
    const src = getDominantSource(p.id);
    let burn = 0;
    if(s.total > 0) burn = Math.round((s.spent / s.total) * 100);
    else if(s.spent > 0) burn = 100;
    
    // Return a clean object we can sort
    return { 
        id: p.id, title: p.title, health: p.health, 
        srcName: src.short, srcColor: src.color,
        init: s.init, adj: s.adj, total: s.total, spent: s.spent, rem: s.rem, burn: burn 
    };
});

// D. SORT THE ARRAY (If table-budget is active)
if (sortState.table === 'table-budget') {
    budgetData.sort((a, b) => {
        // Map column index to our new object keys
        const keys = ['title', 'srcName', 'init', 'adj', 'total', 'spent', 'rem', 'burn'];
        const k = keys[sortState.col];
        
        let valA = a[k], valB = b[k];
        
        if (typeof valA === 'string') {
            return valA.localeCompare(valB) * sortState.dir;
        }
        return (valA - valB) * sortState.dir;
    });
}

// E. CALCULATE TOTALS & GENERATE HTML
let rollupHtml = budgetData.map(row => {
    // Accumulate Grands (Order doesn't matter for totals)
    grandInit += row.init; grandAdj += row.adj; grandTot += row.total; grandSpent += row.spent;

    // Burn Color Logic
    let burnBg = 'var(--col-act)'; let burnColor = 'var(--accent)'; let burnBorder = 'var(--accent)';    
    if(row.burn > 100) { burnBg = 'var(--danger)'; burnColor = 'white'; burnBorder = 'var(--danger)'; }
    else if (row.burn > 80) { burnBg = 'var(--warning)'; burnColor = 'white'; burnBorder = 'var(--warning)'; }

    return `<tr>
    <td><span class="rag-dot" style="background:${row.health==='red'?'var(--danger)':(row.health==='yellow'?'var(--warning)':'var(--accent)')}"></span><span class="proj-link" onclick="viewProject(${row.id})">${esc(row.title)}</span></td>
    <td style="text-align:center"><div class="tag" style="background:${row.srcColor}; color:white; border:none;">${row.srcName}</div></td>
    <td style="text-align:right; color:var(--text-muted);">$${row.init.toLocaleString()}</td>
    <td style="text-align:right; color:${row.adj>=0?'var(--info)':'var(--warning)'}">${row.adj>0?'+':''}${row.adj.toLocaleString()}</td>
    <td style="text-align:right; font-weight:bold;">$${row.total.toLocaleString()}</td>
    <td style="text-align:right; color:var(--warning);">$${row.spent.toLocaleString()}</td>
    <td style="text-align:right; font-weight:bold; color:${row.rem<0?'var(--danger)':'var(--money)'}">$${row.rem.toLocaleString()}</td>
    <td style="text-align:center"><div class="tag" style="width:45px; text-align:center; display:inline-block; background:${burnBg}; color:${burnColor}; border-color:${burnBorder}; font-weight:bold;">${row.burn}%</div></td>
    </tr>`;
}).join('');

        const genStats = getProjStats(null);
        if(genStats.total !== 0 || genStats.spent !== 0) {
            grandInit += genStats.init; grandAdj += genStats.adj; grandTot += genStats.total; grandSpent += genStats.spent;
            const genRem = genStats.total - genStats.spent;
            rollupHtml += `<tr style="background:var(--bg-body);"><td><i>General / Overhead</i></td><td style="text-align:center">-</td><td style="text-align:right; color:var(--text-muted);">$${genStats.init.toLocaleString()}</td><td style="text-align:right;">${genStats.adj.toLocaleString()}</td><td style="text-align:right; font-weight:bold;">$${genStats.total.toLocaleString()}</td><td style="text-align:right; color:var(--warning);">$${genStats.spent.toLocaleString()}</td><td style="text-align:right; font-weight:bold; color:${genRem<0?'var(--danger)':'var(--money)'}">$${genRem.toLocaleString()}</td><td style="text-align:center">-</td></tr>`;
        }
        document.getElementById('budget-rollup-list').innerHTML = rollupHtml || '<tr><td colspan="7" style="text-align:center; padding:10px; color:var(--text-muted)">No financial data found in this period.</td></tr>';
        
        const grandRem = grandTot - grandSpent;
        const grandBurn = grandTot > 0 ? Math.round((grandSpent/grandTot)*100) : 0;
        document.getElementById('budget-rollup-foot').innerHTML = `<tr><td>TOTALS</td><td></td><td style="text-align:right">$${grandInit.toLocaleString()}</td><td style="text-align:right">$${grandAdj.toLocaleString()}</td><td style="text-align:right">$${grandTot.toLocaleString()}</td><td style="text-align:right">$${grandSpent.toLocaleString()}</td><td style="text-align:right; color:${grandRem<0?'var(--danger)':'var(--money)'}">$${grandRem.toLocaleString()}</td><td style="text-align:center">${grandBurn}%</td></tr>`;

        // ============================================================
        //  END FINANCE LOGIC
        // ============================================================


        // --- 7. EXEMPT LOG & INVENTORY TABLES ---
        const sortedExempt = getSortedData(exemptLog, 'table-exempt');
	document.getElementById('exempt-list').innerHTML = sortedExempt.map(e => {
            const isAuth = e.authDate && e.authDate.trim() !== "";
            const statusBadge = isAuth 
                ? '<span class="tag" style="background:var(--accent); color:white; border:none;">Authorized</span>' 
                : '<span class="tag" style="background:var(--warning); color:white; border:none;">Pending</span>';
            
            return `<tr>
                <td>${esc(e.id)}</td>
                <td><input class="live-edit" type="date" value="${e.date}" onchange="updItem('exempt', '${e.id}', 'date', this.value)"></td>
                <td><input class="live-edit" value="${esc(e.cmd)}" onchange="updItem('exempt', '${e.id}', 'cmd', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(e.desc)}" onchange="updItem('exempt', '${e.id}', 'desc', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(e.iso)}" onchange="updItem('exempt', '${e.id}', 'iso', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(e.act)}" onchange="updItem('exempt', '${e.id}', 'act', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(e.basis)}" onchange="updItem('exempt', '${e.id}', 'basis', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(e.path)}" onchange="updItem('exempt', '${e.id}', 'path', this.value, this)"></td>
                <td><input class="live-edit" type="date" value="${e.authDate||''}" onchange="updItem('exempt', '${e.id}', 'authDate', this.value)"></td>
                <td style="text-align:center;" id="ex-status-${e.id}">${statusBadge}</td>
                <td><i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delExempt('${e.id}')"></i></td>
            </tr>`;
        }).join('');

const sortedInv = getSortedData(filteredInv, 'table-inv');
        document.getElementById('full-inv-list').innerHTML = sortedInv.map(i => {
            const pOptions = '<option value="">-- None --</option>' + projects.map(p => `<option value="${p.id}" ${i.projId===p.id?'selected':''}>${esc(p.title)}</option>`).join('');
            const linkIcon = i.projId ? `<i class="fa-solid fa-arrow-up-right-from-square" style="cursor:pointer; color:var(--info)" onclick="viewProject(${i.projId})" title="Go to Project"></i>` : '';
            const safeId = jsEsc(i.id);

            return `<tr>
                <td><input class="live-edit" value="${esc(i.id)}" onchange="updItem('inventory', '${safeId}', 'id', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(i.iso)}" onchange="updItem('inventory', '${safeId}', 'iso', this.value, this)"></td>
                <td><input class="live-edit" value="${esc(i.act)}" onchange="updItem('inventory', '${safeId}', 'act', this.value, this)"></td>
                
                <td><input class="live-edit" type="text" value="${i.dose}" onchange="updItem('inventory', '${safeId}', 'dose', this.value)"></td>
                
                <td style="width:100px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="number" class="live-edit" style="width:50px; text-align:right;" min="0" max="100" value="${i.fill||0}" onchange="updItem('inventory', '${safeId}', 'fill', this.value)">
                        <span style="font-size:0.7rem;">%</span>
                    </div>
                    <div class="progress-bar" style="height:4px; margin-top:2px;"><div class="progress-fill" style="width:${i.fill||0}%; background:${(i.fill||0)>90?'var(--danger)':'var(--info)'}"></div></div>
                </td>
                <td><div style="display:flex; align-items:center; gap:8px;"><select class="live-edit" onchange="updItem('inventory', '${safeId}', 'projId', this.value)">${pOptions}</select>${linkIcon}</div></td>
                <td><select class="live-edit" onchange="updItem('inventory', '${safeId}', 'status', this.value)"><option ${i.status==='Stored'?'selected':''}>Stored</option><option ${i.status==='Staged'?'selected':''}>Staged</option><option ${i.status==='Shipped'?'selected':''}>Shipped</option></select></td>
                
                <td><i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delInventory('${safeId}')"></i></td>
            </tr>`;
        }).join('');
        
        document.getElementById('chatFeed').innerHTML = chatLog.map(c => 
            `<div class="msg"><div class="msg-meta"><span>${esc(c.user)}</span><span>${c.time}</span></div><div>${c.user === 'System' ? c.text : esc(c.text)}</div></div>`
        ).join('');

        document.getElementById('chatFeed').scrollTop = 9999;
        document.getElementById('wiki-text').value = wikiText;
    }

function downloadBackup() {
    const data = JSON.stringify({
        projects, inventory, expenses, allocations, 
        chat: chatLog, team, wiki: wikiText, 
        hpState, viewMode, showComplete, estItems, exemptLog
    }, null, 2); // Pretty print for readability

    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `RadFlow_Backup_${getTodayStr()}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast("Backup Downloaded");
}

// --- HELPER: Parse Radioactivity ---
// Converts "10 mCi", "5 Ci", "500 uCi" into a comparable number (Curies)
function getActValue(str) {
    if (!str) return 0;
    
    // Handle "Unknown" or "N/A"
    const s = str.toString().toLowerCase();
    if (s.includes('unknown') || s.includes('n/a') || s.includes('tbd')) return -1;

    const match = str.toString().match(/([\d\.]+(?:[eE][-+]?\d+)?)\s*([a-zA-Z]+)/);
    if (!match) return 0;
    
    const val = parseFloat(match[1]);
    const unit = match[2].toLowerCase();
    
    if (unit === 'ci') return val;
    if (unit === 'mci') return val * 1e-3;
    if (unit === 'uci') return val * 1e-6;
    if (unit === 'nci') return val * 1e-9;
    if (unit === 'gbq') return val / 37;
    if (unit === 'mbq') return (val / 37) * 1e-3;
    
    return val;
}

function viewProject(id) {
    const p = projects.find(x => x.id === id); 
    if(!p) return;
    
    // 1. Update Browser Title (Context-Aware)
    document.title = `${p.title} | ${APP_VER}`;
    
    // 2. Navigation Logic (Remember where we came from)
    const activeEl = document.querySelector('.view-section.active');
    const currentView = activeEl ? activeEl.id.replace('view-', '') : 'dashboard';
    if(currentView !== 'project-detail') window.lastView = currentView;
    const backDest = window.lastView || 'dashboard';
    
    // 3. Financial Math (Excluding Draft Estimates)
    const projExp = expenses.filter(e => e.projId === id);
    let spentNavy = 0, spentCmd = 0, spentOther = 0;
    
    projExp.forEach(e => {
        // CRITICAL FIX: Don't count drafts as actual spending
        if(e.status === 'Estimate') return; 
        
        const val = Math.abs(parseFloat(e.amount)||0);
        const src = (e.fundSource||'');
        if(src.includes('Navy')) spentNavy += val;
        else if(src.includes('Command')) spentCmd += val;
        else spentOther += val;
    });
    
    const projAllocs = allocations.filter(a => a.projId === id);
    let budgetNavy = 0, budgetCmd = 0, budgetOther = 0;
    projAllocs.forEach(a => {
        const val = parseFloat(a.amount)||0;
        const src = (a.fundSource||'');
        if(src.includes('Navy')) budgetNavy += val;
        else if(src.includes('Command')) budgetCmd += val;
        else budgetOther += val;
    });

    // 4. Generate Lists
    const teamOpts = team.map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join('');
    
    // Inventory Assets
    const assignedItems = inventory.filter(i => i.projId === id);
    const assetsHtml = assignedItems.length ? assignedItems.map(i => `<div class="list-item" style="font-size:0.8rem;"><span><i class="fa-solid fa-box"></i> ${esc(i.id)} (${esc(i.iso)})</span><span>${i.dose} mR/hr</span></div>`).join('') : '<div style="color:var(--text-muted); font-size:0.8rem; font-style:italic;">No assets assigned.</div>';

    // Funding History (Allocations) with IGE Icon check
    const allocHtml = projAllocs.length ? projAllocs.map(a => {
        const igeIcon = a.details ? `<i class="fa-solid fa-file-invoice" style="cursor:pointer; color:var(--accent); margin-left:5px;" onclick="viewEstimate(${a.id}, 'alloc')" title="View IGE"></i>` : '';
        return `<div style="display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; padding:4px 0; border-bottom:1px solid var(--border);">
            <span>${esc(a.desc)} ${igeIcon} <span class="tag">${esc(a.fundSource||'Navy General Fund')}</span></span>
            <span>$${a.amount.toLocaleString()}</span>
        </div>`;
    }).join('') : '<div style="font-style:italic; font-size:0.8rem; color:var(--text-muted)">No funding records.</div>';

    // Pending Estimates (Drafts) List
    const estimates = projExp.filter(e => e.status === 'Estimate');
    const estHtml = estimates.length ? estimates.map(e => {
        const igeIcon = e.details ? `<i class="fa-solid fa-file-invoice" style="cursor:pointer; color:var(--accent); margin-left:5px;" onclick="viewEstimate(${e.id}, 'expense')" title="View IGE"></i>` : '';
        
        return `<div style="display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; padding:4px 0; border-bottom:1px solid var(--border); color:var(--text-muted); font-style:italic;">
            <span>${esc(e.desc)} ${igeIcon} <span class="tag" style="background:var(--bg-input); color:var(--text-muted); border:1px solid var(--border);">Draft</span></span>
            <div style="display:flex; align-items:center; gap:10px;">
                <span>$${e.amount.toLocaleString()}</span>
                <i class="fa-solid fa-trash" style="cursor:pointer; color:var(--text-muted);" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--text-muted)'" onclick="delExpense(${e.id})" title="Delete Estimate"></i>
            </div>
        </div>`;
    }).join('') : '';

    // Tasks (Sorted by Done state then Priority)
    const sortedTasks = (p.tasks||[]).sort((a,b) => {
        if(a.done !== b.done) return a.done ? 1 : -1;
        const pMap = {'high':0, 'med':1, 'low':2};
        return (pMap[a.prio]||1) - (pMap[b.prio]||1);
    });

    const tHtml = sortedTasks.map(t => `
        <div class="task-row">
            <div style="display:flex; align-items:center; gap:10px; width:100%;">
                <i class="fa-solid fa-fire prio-flag ${t.prio==='high'?'prio-high':(t.prio==='med'?'prio-med':(t.prio==='low'?'prio-low':'prio-none'))}" onclick="cycPrio(${p.id}, ${t.id})"></i>
                <i class="fa-solid ${t.done?'fa-square-check checked':'fa-square'} task-chk" onclick="togTask(${p.id},${t.id})"></i>
                <input class="task-input ${t.done?'checked':''}" value="${esc(t.text)}" onchange="updTask(${p.id}, ${t.id}, 'text', this.value)">
                <select class="assign-select" onchange="updTask(${p.id}, ${t.id}, 'assign', this.value)"><option value="">--</option>${team.map(m => `<option value="${esc(m)}" ${t.assign===m?'selected':''}>${esc(m)}</option>`).join('')}</select>
            </div>
            <i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger); margin-left:10px;" onclick="delTask(${p.id},${t.id})"></i>
        </div>`).join('');

    // Digital Binder Links
    const lHtml = (p.links || []).map((l, i) => `
        <div class="link-row">
            <i class="fa-solid fa-link"></i> 
            <a href="${formatLink(l.url)}" target="_blank">${esc(l.name)}</a> 
            <i class="fa-solid fa-trash" style="margin-left:auto; cursor:pointer; font-size:0.8rem; color:var(--text-muted);" onclick="delLink(${p.id}, ${i})"></i>
        </div>`).join('');
    
    // Due Date Status Badge
    const status = getDueStatus(p.due);
    const dueBadge = `<span class="tag" style="background:${status.color}; color:white; border:none; font-weight:bold;">${status.text}</span>`;
    
    // Updates Sent Tags
    const updatesListHtml = (p.updatesSent || []).map((date, idx) => 
        `<span class="tag" style="border:1px solid var(--border); color:var(--text-main);">${date} <i class="fa-solid fa-xmark" style="cursor:pointer; margin-left:5px; color:var(--danger)" onclick="removeUpdateDate(${p.id}, ${idx})"></i></span>`
    ).join(' ');

    // Progress Bar Percentages
    const navyPct = budgetNavy > 0 ? Math.min((spentNavy/budgetNavy)*100, 100) : 0;
    const cmdPct = budgetCmd > 0 ? Math.min((spentCmd/budgetCmd)*100, 100) : 0;
    const otherPct = budgetOther > 0 ? Math.min((spentOther/budgetOther)*100, 100) : 0;

    // 5. Inject HTML
    document.getElementById('view-project-detail').innerHTML = `
    <div class="header">
        <button class="btn-sync" style="width:auto" onclick="nav('${backDest}')">&larr; Back</button> 
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:var(--info)" onclick="cloneProject(${p.id})">Clone</button>
            <button class="btn" style="background:var(--danger)" onclick="delProj(${p.id})">Delete</button>
        </div>
    </div>
    <div class="widget">
        <input class="edit-h1" value="${esc(p.title)}" onchange="updItem('project', ${p.id}, 'title', this.value, this)">
        <textarea class="edit-p" onchange="updItem('project', ${p.id}, 'desc', this.value, this)">${esc(p.desc)}</textarea>
        
        <div class="input-grid">
            <div><label style="font-size:0.7rem; color:var(--text-muted)">STATUS</label><select class="form-control" style="margin:0;" onchange="updItem('project', ${p.id},'status',this.value)"><option ${p.status==='Planning'?'selected':''}>Planning</option><option ${p.status==='Active'?'selected':''}>Active</option><option ${p.status==='Review'?'selected':''}>Review</option><option ${p.status==='Complete'?'selected':''}>Complete</option></select></div>
            <div><label style="font-size:0.7rem; color:var(--text-muted)">HEALTH</label><select class="form-control" style="margin:0;" onchange="updItem('project', ${p.id},'health',this.value)"><option value="green" ${p.health==='green'?'selected':''}>🟢 On Track</option><option value="yellow" ${p.health==='yellow'?'selected':''}>🟡 Risk</option><option value="red" ${p.health==='red'?'selected':''}>🔴 Critical</option></select></div>
            <div><label style="font-size:0.7rem; color:var(--text-muted)">DUE DATE ${dueBadge}</label><input type="date" class="form-control" style="margin:0;" value="${p.due}" onchange="updItem('project', ${p.id}, 'due', this.value)"></div>
        </div>

        <div style="border:1px solid var(--border); padding:15px; border-radius:8px; margin:20px 0; background:transparent;">
            <div style="font-size:0.85rem; font-weight:bold; color:var(--text-main); text-transform:uppercase; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:5px;">Status and Logistics</div>
            <div class="input-grid" style="margin-bottom:10px;">
                <div><label style="font-size:0.7rem; color:var(--text-muted)">UIC / COMMAND</label><input class="form-control" value="${esc(p.uic||'')}" onchange="updItem('project', ${p.id}, 'uic', this.value)"></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">LOCATION</label><input class="form-control" value="${esc(p.location||'')}" onchange="updItem('project', ${p.id}, 'location', this.value)"></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">LLRW REGION</label><select class="form-control" onchange="updItem('project', ${p.id}, 'region', this.value)"><option value="">--</option><option ${p.region==='East'?'selected':''}>East</option><option ${p.region==='West'?'selected':''}>West</option><option ${p.region==='Far-East'?'selected':''}>Far-East</option><option ${p.region==='Europe'?'selected':''}>Europe</option></select></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">SHIPMENT TYPE</label><select class="form-control" onchange="updItem('project', ${p.id}, 'shipType', this.value)"><option value="">--</option><option ${p.shipType==='Level 1'?'selected':''}>Level 1</option><option ${p.shipType==='Level 2'?'selected':''}>Level 2</option><option ${p.shipType==='Level 3'?'selected':''}>Level 3</option></select></div>
            </div>
            <div class="input-grid" style="margin-bottom:10px;">
                <div><label style="font-size:0.7rem; color:var(--text-muted)">JMC PROJECT #</label><input class="form-control" value="${esc(p.jmcId||'')}" onchange="updItem('project', ${p.id}, 'jmcId', this.value)"></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">RCN</label><input class="form-control" value="${esc(p.rcn||'')}" onchange="updItem('project', ${p.id}, 'rcn', this.value)"></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">PLANNING STATUS</label><input class="form-control" value="${esc(p.planStatus||'')}" onchange="updItem('project', ${p.id}, 'planStatus', this.value)"></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">PICKUP STATUS</label><input class="form-control" value="${esc(p.pickupStatus||'')}" onchange="updItem('project', ${p.id}, 'pickupStatus', this.value)"></div>
            </div>
            <div class="input-grid">
                <div><label style="font-size:0.7rem; color:var(--text-muted)">REQ DATE</label><input type="date" class="form-control" value="${p.reqDate||''}" onchange="updItem('project', ${p.id}, 'reqDate', this.value)"></div>
                <div style="flex:2;">
                    <label style="font-size:0.7rem; color:var(--text-muted)">UPDATES SENT</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
                        <input type="date" id="newUpdateDate_${p.id}" class="form-control" style="margin:0; width:130px;">
                        <button class="qa-btn" onclick="addUpdateDate(${p.id}, document.getElementById('newUpdateDate_${p.id}').value)">Add</button>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px;">${updatesListHtml}</div>
                </div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">FWD TO JMC</label><input type="date" class="form-control" value="${p.jmcDate||''}" onchange="updItem('project', ${p.id}, 'jmcDate', this.value)"></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">DISP REC REC'D</label><input type="date" class="form-control" value="${p.dispRecDate||''}" onchange="updItem('project', ${p.id}, 'dispRecDate', this.value)"></div>
            </div>
            <div style="margin-top:10px;">
                <label style="font-size:0.7rem; color:var(--text-muted)">LOGISTICS NOTES</label>
                <textarea class="form-control" style="height:60px; resize:vertical;" onchange="updItem('project', ${p.id}, 'logisticsNotes', this.value)">${esc(p.logisticsNotes||'')}</textarea>
            </div>
        </div>

        <div style="background:var(--bg-card); padding:15px; border-radius:8px; margin:20px 0; border:1px solid var(--border);">
            <div style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:0.8rem; font-weight:bold; color:var(--navy);">Navy General Fund ($${budgetNavy.toLocaleString()})</span>
                    <span style="font-size:0.8rem; color:${spentNavy>budgetNavy?'var(--danger)':'var(--text-muted)'};">$${spentNavy.toLocaleString()} Spent</span>
                </div>
                <div class="progress-bar" style="background:var(--navy-dim);">
                    <div class="progress-fill" style="width:${navyPct}%; background:var(--navy);"></div>
                </div>
            </div>

            <div style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:0.8rem; font-weight:bold; color:var(--cmd);">Command Funded ($${budgetCmd.toLocaleString()})</span>
                    <span style="font-size:0.8rem; color:${spentCmd>budgetCmd?'var(--danger)':'var(--text-muted)'};">$${spentCmd.toLocaleString()} Spent</span>
                </div>
                <div class="progress-bar" style="background:var(--cmd-dim);">
                    <div class="progress-fill" style="width:${cmdPct}%; background:var(--cmd);"></div>
                </div>
            </div>

            <div style="margin-bottom:15px; ${budgetOther === 0 && spentOther === 0 ? 'display:none' : ''}">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:0.8rem; font-weight:bold; color:var(--text-muted);">Other Funding ($${budgetOther.toLocaleString()})</span>
                    <span style="font-size:0.8rem; color:${spentOther>budgetOther?'var(--danger)':'var(--text-muted)'};">$${spentOther.toLocaleString()} Spent</span>
                </div>
                <div class="progress-bar" style="background:var(--other-dim);">
                    <div class="progress-fill" style="width:${otherPct}%; background:var(--other);"></div>
                </div>
            </div>
            
            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed var(--border);">
                <div style="font-size:0.7rem; font-weight:bold; color:var(--text-muted); margin-bottom:5px;">FUNDING HISTORY</div>
                ${allocHtml}
                ${estHtml ? '<div style="margin-top:10px; font-size:0.7rem; font-weight:bold; color:var(--text-muted); margin-bottom:5px;">PENDING ESTIMATES (DRAFT)</div>' + estHtml : ''}
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h3>Action Items</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <input id="newT" class="form-control" style="margin:0" placeholder="Task">
                    <select id="newTA" class="form-control" style="margin:0; width:100px;"><option value="">Assign</option>${teamOpts}</select>
                    <button class="btn" onclick="addTask(${p.id})">Add</button>
                </div>
                <div>${tHtml}</div>
            </div>
            <div>
                <h3>Assigned Assets</h3>
                <div style="margin-bottom:15px;">${assetsHtml}</div>
                <h3>Digital Binder</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <input id="newLinkName" class="form-control" style="margin:0" placeholder="Name">
                    <input id="newLinkUrl" class="form-control" style="margin:0" placeholder="URL or C:\\Path\\To\\File">
                    <button class="btn" onclick="addLink(${p.id})">Link</button>
                </div>
                <div>${lHtml}</div>
            </div>
        </div>
    </div>`;
    
    // 6. Switch View
    nav('project-detail');
}

    function drag(ev, id) { ev.dataTransfer.setData("text", id); ev.target.classList.add('dragging'); }
    function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    function leaveDrop(ev) { ev.currentTarget.classList.remove('drag-over'); }
    function drop(ev, status) {
        ev.preventDefault(); ev.currentTarget.classList.remove('drag-over');
        const id = parseInt(ev.dataTransfer.getData("text"));
        const p = projects.find(x => x.id === id);
        if (p && p.status !== status) {
            const oldStatus = p.status; p.status = status;
            if(status === 'Complete') { p.health = 'green'; }
            logSystemAction(`Project <b>${esc(p.title)}</b> moved from ${oldStatus} to ${status}.`);
            showToast(`Moved to ${status}`); saveLocally(); render();
        }
    }

    function switchHpTab(tab) {
        ['decay','dist','shield','stay','alara'].forEach(t => document.getElementById('hp-tab-'+t).style.display = 'none');
        document.getElementById('hp-tab-'+tab).style.display = 'block';
        if(tab === 'dist') {
            const sel = document.getElementById('dist-inv-select');
            sel.innerHTML = '<option value="">-- Select Item --</option>';
            inventory.forEach(i => { sel.innerHTML += `<option value="${i.id}">${esc(i.id)} (${i.dose} mR/hr)</option>`; });
        }
    }
    function loadInvToCalc() {
        const id = document.getElementById('dist-inv-select').value; if(!id) return;
        const item = inventory.find(x => x.id == id);
        if(item) { document.getElementById('dist-d1').value = item.dose; document.getElementById('dist-r1').value = 1; showToast(`Loaded ${item.id}`); }
    }
    function calcInverseSquare() {
        const i1 = parseFloat(document.getElementById('dist-d1').value);
        const d1 = parseFloat(document.getElementById('dist-r1').value);
        const d2 = parseFloat(document.getElementById('dist-r2').value);
        if(i1 && d1 && d2) {
            if (d2 <= 0) { showToast("Target distance must be > 0", "error"); return; }
            const i2 = i1 * Math.pow((d1/d2), 2);
            let display = i2 < 1 ? i2.toFixed(4) : i2.toFixed(2);
            document.getElementById('dist-result').innerText = display + " mR/hr";
        }
    }
    function calcShielding() {
        const iso = document.getElementById('shield-iso').value;
        const mat = document.getElementById('shield-mat').value;
        const i0 = parseFloat(document.getElementById('shield-i0').value);
        const x = parseFloat(document.getElementById('shield-x').value);
        const hvls = {'Co-60': {'Pb': 1.2, 'Fe': 2.1, 'Conc': 6.3}, 'Cs-137': {'Pb': 0.65, 'Fe': 1.6, 'Conc': 4.8}, 'Ir-192': {'Pb': 0.5, 'Fe': 1.3, 'Conc': 4.3}};
        if(i0 && x) {
            const hvl = hvls[iso][mat];
            const i = i0 * Math.pow(0.5, x/hvl);
            let display = i < 1 ? i.toFixed(4) : i.toFixed(2);
            document.getElementById('shield-result').innerText = display + " mR/hr";
            document.getElementById('shield-hvl').innerText = `HVL (${mat}): ${hvl} cm`;
            showToast("Shielding calculated");
        }
    }
    
    function calcStayTime() {
        const rate = parseFloat(document.getElementById('stay-rate').value);
        const limit = parseFloat(document.getElementById('stay-limit').value);
        if(!rate || rate <= 0) {
            document.getElementById('stay-result').innerText = "---";
            return;
        }
        const hours = limit / rate;
        const mins = Math.floor(hours * 60);
        const displayHrs = Math.floor(mins / 60);
        const displayMins = mins % 60;
        document.getElementById('stay-result').innerText = `${displayHrs}h ${displayMins}m`;
    }

    function calcAlara() {
        const rate = parseFloat(document.getElementById('alara-rate').value);
        const time = parseFloat(document.getElementById('alara-time').value);
        const crew = parseFloat(document.getElementById('alara-crew').value);
        
        if(!rate || !time || !crew) { showToast("Please fill all fields", "error"); return; }
        
        const indivDose = rate * (time/60);
        const totalDose = indivDose * crew;
        
        document.getElementById('alara-result').innerText = totalDose.toFixed(1) + " mR";
        document.getElementById('alara-indiv').innerText = `Individual Dose: ${indivDose.toFixed(1)} mR`;
    }

    function cloneExpense(id) {
        const original = expenses.find(x => x.id === id);
        if(original) {
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = Date.now();
            copy.date = getTodayStr(); 
            copy.desc = copy.desc + " (Copy)";
            copy.status = "Invoiced"; 
            expenses.push(copy);
            saveLocally();
            render();
            showToast("Expense Duplicated");
        }
    }

    function runConv() {
        const val = parseFloat(document.getElementById('conv-in').value);
        const type = document.getElementById('conv-type').value;
        const out = document.getElementById('conv-out');
        if(isNaN(val)) { out.innerText = "---"; return; }
        let res = 0;
        if(type === 'ci-gbq') res = val * 37;
        if(type === 'gbq-ci') res = val / 37;
        if(type === 'mr-usv') res = val * 10;
        if(type === 'usv-mr') res = val / 10;
        out.innerText = res.toFixed(3);
    }

    function switchFinTab(tab) {
        document.getElementById('fin-tab-overview').style.display = tab === 'overview' ? 'block' : 'none';
        document.getElementById('fin-tab-exp').style.display = tab === 'exp' ? 'block' : 'none';
        document.getElementById('fin-tab-alloc').style.display = tab === 'alloc' ? 'block' : 'none';
    }

    function openBudgetManager() {
        const list = document.getElementById('budgetManagerList');
        list.innerHTML = '';
        if(projects.length === 0) {
            list.innerHTML = '<div style="color:var(--text-muted); padding:10px;">No active projects.</div>';
        } else {
            projects.forEach(p => {
                const initAlloc = allocations.find(a => a.projId === p.id && (a.type === 'base' || a.desc === "Initial Budget"));
                const val = initAlloc ? initAlloc.amount : 0;
                
                const row = document.createElement('div');
                row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center'; row.style.padding = '8px'; row.style.borderBottom = '1px solid var(--border)';
                row.innerHTML = `<span style="font-weight:bold; font-size:0.9rem;">${esc(p.title)}</span><input type="number" class="form-control" style="width:120px; margin:0;" value="${val}" onchange="updateBaseAlloc(${p.id}, this.value)">`;
                list.appendChild(row);
            });
        }
        openModal('budgetModal');
    }

    function updateBaseAlloc(pid, val) {
        // FIX: Add "|| 0" to handle empty strings/NaN
        const amount = parseFloat(val) || 0; 
        
        const existing = allocations.find(a => a.projId === pid && (a.type === 'base' || a.desc === "Initial Budget"));
        if(existing) {
            existing.amount = amount;
            existing.type = 'base';
        } else {
            allocations.push({ id: Date.now(), projId: pid, date: getTodayStr(), amount: amount, desc: "Initial Budget", type: 'base', fundSource: "Navy General Fund" });
        }
        saveLocally(); render();
    }

    function downloadCSV() {
        let csv = "Date,Project,Funding Source,Description,Amount,Status\n";
        expenses.forEach(e => {
            const pName = projects.find(p => p.id === e.projId)?.title || "General/Overhead";
            const safeDesc = `"${e.desc.replace(/"/g, '""')}"`; 
            const fund = e.fundSource || "Other";
            csv += `${e.date},"${pName}","${fund}",${safeDesc},${e.amount},${e.status}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `radflow_expenses_${getTodayStr()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel file downloaded");
    }

    let sortDir = 1;
    function sortTable(tableId, col) {
    // If clicking the same column, flip direction. Otherwise, reset to ascending (1).
    if (sortState.table === tableId && sortState.col === col) {
        sortState.dir *= -1;
    } else {
        sortState.table = tableId;
        sortState.col = col;
        sortState.dir = 1;
    }
    render(); // Re-draw the view with the new sort order applied
}

// --- HELPER: SORT DATA ARRAY ---
function getSortedData(data, tableId) {
    // If this table isn't the one currently being sorted, return data as-is
    if (sortState.table !== tableId) return data;

    // Create a shallow copy so we don't mutate the original ID order permanently
    return [...data].sort((a, b) => {
        let valA, valB;

        // MAP COLUMN INDEX TO DATA FIELDS
        // We have to map the visual column index (0, 1, 2) to the data key ('date', 'amount', etc)
        // Adjust these maps based on your specific table layouts in HTML
        if (tableId === 'table-exp') {
            const keys = ['date', 'projId', 'fundSource', 'desc', 'amount', 'status'];
            valA = a[keys[sortState.col]];
            valB = b[keys[sortState.col]];
            
            // Special handling for Project Name lookup
            if(sortState.col === 1) { 
                valA = projects.find(p => p.id === valA)?.title || '';
                valB = projects.find(p => p.id === valB)?.title || '';
            }
        } 
        else if (tableId === 'table-alloc') {
            const keys = ['date', 'projId', 'fundSource', 'desc', 'amount'];
            valA = a[keys[sortState.col]];
            valB = b[keys[sortState.col]];
            if(sortState.col === 1) { 
                valA = projects.find(p => p.id === valA)?.title || '';
                valB = projects.find(p => p.id === valB)?.title || '';
            }
        }
        else if (tableId === 'table-inv') {
        const keys = ['id', 'iso', 'act', 'dose', 'fill', 'projId', 'status'];
        
        // Special Sort: Activity (Physics aware)
        if (sortState.col === 2) {
            const numA = getActValue(a.act);
            const numB = getActValue(b.act);
            return (numA - numB) * sortState.dir;
        }

        // Special Sort: Dose (Handle "Unknown")
        if (sortState.col === 3) {
            // Helper: Convert to number, or -1 if "Unknown"
            const val = (v) => {
                if (typeof v === 'number') return v;
                const f = parseFloat(v);
                return isNaN(f) ? -1 : f;
            };
            return (val(a.dose) - val(b.dose)) * sortState.dir;
        }
        
        valA = a[keys[sortState.col]];
        valB = b[keys[sortState.col]];
    }

        else if (tableId === 'table-exempt') {
            const keys = ['id', 'date', 'cmd', 'desc', 'iso', 'act', 'basis', 'path', 'authDate'];
            valA = a[keys[sortState.col]];
            valB = b[keys[sortState.col]];
        }
        // Fallback for budget rollup or other tables if needed
        else { return 0; }

        // GENERIC COMPARISON
        // Handle nulls/undefined
        if (valA == null) valA = '';
        if (valB == null) valB = '';

        // Check for Numbers
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);
        
        // Use number comparison if both are valid numbers and not just strings that look like numbers
        if (!isNaN(numA) && !isNaN(numB) && typeof valA !== 'string') {
            return (numA - numB) * sortState.dir;
        }

        // String Comparison (Case insensitive)
        const strA = valA.toString().toLowerCase();
        const strB = valB.toString().toLowerCase();
        if (strA < strB) return -1 * sortState.dir;
        if (strA > strB) return 1 * sortState.dir;
        return 0;
    });
}

function updItem(type, id, key, val, elem) { 
    // 1. Update the Data Model
    if (type === 'project') { const p = projects.find(x => x.id === id); p[key] = val; }
    
    if (type === 'inventory') { 
    const i = inventory.find(x => x.id == id); 
    
    if(key === 'iso') {
        // Auto-correct the casing using our DB
        val = normalizeIso(val);
    } 
        if(key === 'fill') {
            val = parseInt(val);
            if(isNaN(val)) val = 0;
            if(val < 0) val = 0; if(val > 100) val = 100;
        }
        if(key === 'dose') val = parseFloat(val); 
        if(key === 'projId') val = val ? parseInt(val) : null; 
        i[key] = val; 
    }

    if (type === 'expense') { const e = expenses.find(x => x.id === id); if(key === 'amount') val = parseFloat(val); e[key] = val; }
    if (type === 'alloc') { const a = allocations.find(x => x.id === id); if(key === 'amount') val = parseFloat(val); a[key] = val; }
    if (type === 'exempt') { const ex = exemptLog.find(x => x.id === id); ex[key] = val; }
    
    saveLocally(); 
    
    // 2. Visual Feedback (Flash border)
    if(elem) {
        const oldBorder = elem.style.borderColor;
        elem.style.borderColor = 'var(--accent)';
        setTimeout(() => elem.style.borderColor = oldBorder, 500);
    }

    // --- Surgical DOM Updates ---
    
    // Special Case: Exempt Log Auth Date
    // If updating Auth Date, we update ONLY the badge and STOP (return) to prevent re-render
    if (type === 'exempt' && key === 'authDate') {
        const isAuth = val && val.trim() !== "";
        const badge = isAuth 
            ? '<span class="tag" style="background:var(--accent); color:white; border:none;">Authorized</span>' 
            : '<span class="tag" style="background:var(--warning); color:white; border:none;">Pending</span>';
        const cell = document.getElementById(`ex-status-${id}`);
        if(cell) cell.innerHTML = badge;
        return; 
    }

    // 3. General Render Logic
    // Fields that should NOT trigger a re-render (to prevent losing focus while typing)
    const skipRenderFields = ['desc', 'text', 'iso', 'act', 'basis', 'path', 'cmd', 'logisticsNotes', 'date', 'qty', 'rev', 'amount', 'dose', 'fill'];
    
    if(!skipRenderFields.includes(key)) {
        render();
    }
}
    
    function delExempt(id) {
        if(confirm("Delete Log Entry?")) {
            exemptLog = exemptLog.filter(x => x.id !== id);
            saveLocally();
            render();
            showToast("Entry Deleted");
        }
    }
    
    function updTask(pId, tId, key, val) { 
        const p = projects.find(x => x.id === pId);
        const t = p.tasks.find(x => x.id === tId);
        t[key] = val; 
        
        if(key === 'assign' && val) {
            logSystemAction(`Task <b>${esc(t.text)}</b> assigned to <b>${esc(val)}</b> in <b>${esc(p.title)}</b>.`);
        }

        saveLocally(); 
    }
    
function cycPrio(pId, tId) { const t = projects.find(x=>x.id===pId).tasks.find(x=>x.id===tId); const m = {'high':'low','med':'high','low':'med','undefined':'med'}; t.prio = m[t.prio] || 'med'; saveLocally(); viewProject(pId); }
    
function cloneProject(id) { 
    const original = projects.find(x => x.id === id); 
    const copy = JSON.parse(JSON.stringify(original)); 
    
    copy.id = Date.now(); 
    copy.title = "Copy of " + copy.title; 
    copy.status = "Planning"; 
    copy.health = "green"; 
    
    // --- FIX: RESET DATES & IDs ---
    copy.due = "";         // Don't inherit old deadlines
    copy.jmcId = "";       // Clear unique tracking IDs
    copy.rcn = "";
    copy.updatesSent = []; 
    // ------------------------------

    copy.links = [];
    copy.tasks.forEach(t => t.done = false); 
    
    projects.push(copy); 
    
    // Copy the Initial Budget if it exists
    const base = allocations.find(a => a.projId === id && (a.type === 'base' || a.desc === 'Initial Budget'));
    if (base) {
        allocations.push({ 
            id: Date.now() + 5, 
            projId: copy.id, 
            date: getTodayStr(), 
            amount: base.amount, 
            desc: "Initial Budget", 
            type: 'base', 
            fundSource: base.fundSource 
        });
    }

    logSystemAction(`Project <b>${esc(original.title)}</b> cloned to <b>${esc(copy.title)}</b>.`);

    saveLocally(); 
    viewProject(copy.id); 
    showToast("Project Cloned"); 
}
    
    function togTask(pId, tId) { 
        const p = projects.find(x=>x.id===pId);
        const t = p.tasks.find(x=>x.id===tId);
        t.done = !t.done; 
        
        const status = t.done ? "completed" : "re-opened";
        logSystemAction(`Task <b>${esc(t.text)}</b> marked ${status} in <b>${esc(p.title)}</b>.`);

        saveLocally(); viewProject(pId); 
    }
    
function addTask(pId) { 
        const t = document.getElementById('newT').value; 
        const a = document.getElementById('newTA').value; 
        if(t) { 
            const p = projects.find(x=>x.id===pId);
            p.tasks.push({id:Date.now(), text:t, done:false, assign:a, prio:'med'}); 
            
            logSystemAction(`Task <b>${esc(t)}</b> added to <b>${esc(p.title)}</b>.`);

            saveLocally(); viewProject(pId); 
        } 
    }
    
function delTask(pId, tId) { 
        const p = projects.find(x=>x.id===pId);
        const t = p.tasks.find(x=>x.id===tId);
        
        if(t) {

            logSystemAction(`Task <b>${esc(t.text)}</b> deleted from <b>${esc(p.title)}</b>.`);
            
            p.tasks = p.tasks.filter(x=>x.id!==tId); 
            saveLocally(); viewProject(pId); 
        }
    }
    
    function delProj(id) { 
        const p = projects.find(x => x.id === id);
        if(p && confirm("Delete Project and all associated expenses?")) { 

            logSystemAction(`Project <b>${esc(p.title)}</b> deleted.`);

            projects = projects.filter(x=>x.id!==id); 
            expenses = expenses.filter(x=>x.projId!==id); 
            allocations = allocations.filter(x=>x.projId!==id);
            inventory.forEach(i => { if(i.projId === id) i.projId = null; });
            
            saveLocally(); 
            nav('dashboard'); 
            showToast("Project Deleted", "error");
        } 
    }
    
    // Using sanitizer in addLink
    function addLink(pId) { 
        const n = document.getElementById('newLinkName').value; 
        let u = document.getElementById('newLinkUrl').value; 
        if(n && u) { 
            // Sanitize input before saving
            u = formatLink(u);
            const p = projects.find(x=>x.id===pId); 
            if(!p.links) p.links=[]; 
            p.links.push({name:n, url:u}); 
            saveLocally(); 
            viewProject(pId); 
        } 
    }
    
function addProject() { 
        const t=document.getElementById('pTitle').value; 
        const d=document.getElementById('pDesc').value; 
        const dt=document.getElementById('pDate').value; 
        const c=parseFloat(document.getElementById('pCost').value)||0; 
        const uic = document.getElementById('pUic').value;
        const loc = document.getElementById('pLoc').value;

        if(t) { 
            const pid = Date.now();
            projects.push({
                id: pid, 
                title: t, 
                desc: d, 
                due: dt, 
                status: "Planning", 
                health: "green", 
                uic: uic, 
                location: loc, 
                tasks: [], 
                links: []
            }); 
            if(c > 0) {
                allocations.push({id: Date.now()+1, projId: pid, date: dt || getTodayStr(), amount: c, desc: "Initial Budget", type: 'base', fundSource: "Navy General Fund"});
            }
            
            logSystemAction(`Project <b>${esc(t)}</b> created.`);

            saveLocally(); closeModal('projectModal'); render(); showToast("Project Created"); 
        } 
    }
    
function addExpense() { 
        const pidVal = document.getElementById('expProj').value; 
        const pid = pidVal === "" ? null : parseInt(pidVal); 
        const desc = document.getElementById('expDesc').value; 
        const amt = document.getElementById('expAmt').value; 
        const dt = document.getElementById('expDate').value; 
        const st = document.getElementById('expStatus').value; 
        const fund = document.getElementById('expFund').value || "Other";

        // VALIDATION CHECK
        if(!desc || !amt || !dt) {
            showToast("Please fill in Description, Amount, and Date.", "error");
            return; 
        }

        expenses.push({
            id: Date.now(), 
            projId: pid, 
            desc: desc, 
            amount: parseFloat(amt), 
            date: dt, 
            status: st, 
            fundSource: fund
        }); 

        // --- NEW: Smart Project Naming ---
        const p = projects.find(x => x.id === pid);
        const pName = p ? p.title : "General Overhead"; // If no PID, call it Overhead
        
        logSystemAction(`Expense <b>$${amt}</b> added to <b>${esc(pName)}</b>.`);
        // ---------------------------------

        showToast("Expense Logged");
        saveLocally(); 
        
        // CLEAR FORM DATA
        document.getElementById('expDesc').value = '';
        document.getElementById('expAmt').value = '';
        document.getElementById('expDate').value = getTodayStr(); 

        closeModal('expenseModal'); 
        render(); 

        if(pid && document.getElementById('view-project-detail').classList.contains('active')) {
            viewProject(pid);
        }
    }
    
    function addAllocation() {
        const pidVal = document.getElementById('allocProj').value;
        const pid = pidVal === "" ? null : parseInt(pidVal);
        const desc = document.getElementById('allocDesc').value;
        const amt = document.getElementById('allocAmt').value;
        const dt = document.getElementById('allocDate').value;
        const fund = document.getElementById('allocFund').value;

        if(!desc || !amt || !dt) {
            showToast("Missing Description, Amount, or Date.", "error");
            return;
        }

        allocations.push({
            id:Date.now(), 
            projId:pid, 
            desc:desc, 
            amount:parseFloat(amt), 
            date:dt, 
            type: 'adj', 
            fundSource: fund
        });

        // --- NEW: Smart Project Naming ---
        const p = projects.find(x => x.id === pid);
        const pName = p ? p.title : "General Overhead";
        
        logSystemAction(`Funding <b>$${amt}</b> allocated to <b>${esc(pName)}</b>.`);
        // ---------------------------------

        showToast("Funding Added");
        saveLocally(); 
        
        document.getElementById('allocDesc').value = '';
        document.getElementById('allocAmt').value = '';
        document.getElementById('allocDate').value = getTodayStr();

        closeModal('allocModal'); 
        render();
    }
    
    function delExpense(id) { 
        const e = expenses.find(x => x.id === id);
        
        if(e && confirm("Remove this item?")) { 
            // 1. Log the Action
            const p = projects.find(x => x.id === e.projId);
            const pName = p ? p.title : "General";
            const typeLabel = e.status === 'Estimate' ? "Draft Estimate" : "Expense";
            
            logSystemAction(`${typeLabel} <b>$${e.amount.toLocaleString()}</b> deleted from <b>${esc(pName)}</b>.`);

            // 2. Delete
            expenses = expenses.filter(x => x.id !== id); 
            
            saveLocally(); 
            render(); 
            showToast("Item Removed"); 
            
            // 3. Smart Refresh: If we are looking at the project, update that view too
            if(e.projId && document.getElementById('view-project-detail').classList.contains('active')) {
                viewProject(e.projId);
            }
        } 
    }

    function delAlloc(id) { 
        const a = allocations.find(x => x.id === id);
        
        if(a && confirm("Remove Funding Record?")) { 
            // 1. Log the Action
            const p = projects.find(x => x.id === a.projId);
            const pName = p ? p.title : "General";
            
            logSystemAction(`Funding <b>$${a.amount.toLocaleString()}</b> deleted from <b>${esc(pName)}</b>.`);

            // 2. Delete
            allocations = allocations.filter(x => x.id !== id); 
            
            saveLocally(); 
            render(); 
            showToast("Funding Removed");

            // 3. Smart Refresh
            if(a.projId && document.getElementById('view-project-detail').classList.contains('active')) {
                viewProject(a.projId);
            }
        } 
    }
    
function addInventory() { 
    const id = document.getElementById('invId').value; 
    let iso = document.getElementById('invIso').value;
    
    // 1. Handle Custom Isotope
    if (iso === 'Custom') {
        iso = document.getElementById('invIsoCustom').value;
        if (!iso) { showToast("Please enter a custom isotope name", "error"); return; }
    }
    iso = normalizeIso(iso);

    // 2. Handle Activity (Default to Unknown if empty)
    const act = document.getElementById('invAct').value || "Unknown"; 

    // 3. Handle Dose (Accept Text OR Number)
    let doseInput = document.getElementById('invDose').value;
    let dose;
    
    // If it looks like a number, save as number. Otherwise, save as text (or "Unknown" if empty).
    if(doseInput !== '' && !isNaN(parseFloat(doseInput)) && isFinite(doseInput)) {
        dose = parseFloat(doseInput);
    } else {
        dose = doseInput || "Unknown";
    }

    const fill = document.getElementById('invFill').value; 
    const stat = document.getElementById('invStatus').value; 
    const pidVal = document.getElementById('invProj').value;
    const pid = pidVal === "" ? null : parseInt(pidVal);
    const dateVal = document.getElementById('invDate').value || getTodayStr();

    if(inventory.some(i => i.id === id)) {
        showToast("Error: Item ID already exists", "error");
        return;
    }

    if(id) { 
        inventory.push({
            id, iso, act, dose, fill, status:stat, projId: pid, logDate: dateVal
        }); 
        
        logSystemAction(`Inventory <b>${esc(id)}</b> (${iso}) added.`);
        showToast("Item Added");
        
        toggleCustomIso('reset'); 
        saveLocally(); 
        closeModal('invModal'); 
        render(); 
    }
}

function delInventory(id) {
    if(confirm("Permanently delete this inventory item?")) {
        // Log the deletion for the team
        const i = inventory.find(x => x.id == id);
        if(i) logSystemAction(`Inventory <b>${esc(i.id)}</b> (${esc(i.iso)}) deleted.`);

        // Filter it out
        inventory = inventory.filter(x => x.id != id);
        
        saveLocally();
        render();
        showToast("Item Deleted");
    }
}

function decayInventory() {
    if(!confirm("Permanently update all inventory activities to current date?")) return;
    
    let count = 0;
    let skipped = 0;

    inventory.forEach(i => {
        // 1. SAFE LOOKUP: Find the matching DB key regardless of case
        const dbKey = Object.keys(ISOTOPE_DB).find(k => k.toLowerCase() === (i.iso || "").toLowerCase());
        
        // Only proceed if we found a match AND have a date
        if(dbKey && i.logDate) {
            const hl = ISOTOPE_DB[dbKey].hl;
            
            // 2. PARSE ACTIVITY (Using the helper we added in the previous step)
            // If you haven't added 'getActValue' yet, standard regex match works too
            const match = i.act.match(/^([\d\.]+(?:[eE][-+]?\d+)?)\s*([a-zA-Z]+)$/);
            
            if(match) {
                let val = parseFloat(match[1]);
                const unit = match[2]; 
                
                const d1 = new Date(i.logDate);
                const d2 = new Date();
                const years = (d2 - d1) / (1000 * 60 * 60 * 24 * 365.25);
                
                if(years > 0) {
                    const lambda = Math.log(2) / hl;
                    const newAct = val * Math.exp(-lambda * years);
                    
                    // Update the item
                    i.act = (newAct < 0.001 ? newAct.toExponential(2) : newAct.toFixed(3)) + " " + unit;
                    i.logDate = getTodayStr(); 
                    
                    // Optional: Fix the casing in the record while we are here
                    i.iso = dbKey; 
                    
                    count++;
                }
            } else {
                skipped++; // Format error (e.g. "10 bananas")
            }
        } else {
            skipped++; // Isotope not in DB
        }
    });

    saveLocally(); 
    render(); 
    
    let msg = `Updated ${count} items.`;
    if(skipped > 0) msg += ` (Skipped ${skipped} items - check spelling)`;
    
    showToast(msg, skipped > 0 ? "warning" : "success");
}
    
    function delLink(pId, idx) { const p = projects.find(x=>x.id===pId); p.links.splice(idx, 1); saveLocally(); viewProject(pId); }
    
    function renderTeamSettings() { document.getElementById('teamList').innerHTML = team.map((m, i) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:var(--bg-input); padding:5px; border-radius:4px;">${esc(m)} <i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="remTeam(${i})"></i></div>`).join(''); }
    function addTeamMember() { const m = document.getElementById('newMember').value; if(m) { team.push(m); saveLocally(); renderTeamSettings(); document.getElementById('newMember').value=''; } }
    function remTeam(idx) { team.splice(idx, 1); saveLocally(); renderTeamSettings(); }
    
    function toggleProjView() { viewMode = viewMode === 'list' ? 'board' : 'list'; saveLocally(); render(); }
    function toggleShowComp() { showComplete = !showComplete; saveLocally(); render(); }
    
    function saveHPState() { 
        // Save ALL HP related inputs
        hpState = {};
        const inputs = document.querySelectorAll('#view-hp input, #view-hp select');
        inputs.forEach(el => {
            if(el.id) hpState[el.id] = el.value;
        });
        saveLocally(); 
    }
    
    function saveWiki() { wikiText = document.getElementById('wiki-text').value; saveLocally(); }
    function handleChat(e) { if(e.key==='Enter'){ const t=document.getElementById('chatInput').value; if(t){ chatLog.push({user:"User", time:new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), text:t}); document.getElementById('chatInput').value=''; saveLocally(); render(); }}}

function nav(id) { 
    // 1. Reset Sort Direction (optional, keeps default behavior consistent)
    sortDir = 1; 

    // 2. Switch the Main View
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active')); 
    document.getElementById('view-' + id).classList.add('active'); 

    // 3. Highlight the Sidebar Button
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); 
    const btn = document.getElementById('nav-' + (id === 'project-detail' ? 'proj' : id));
    if(btn) btn.classList.add('active');

    // 4. Specific Tool Initialization logic
    if(id === 'hp') {
        switchHpTab('decay');
        loadHPState(); // Ensure inputs are restored from state
    }

    if(id === 'finance') {
        switchFinTab('overview');
    }

    if(id === 'estimator') {
         // Refresh the Project Dropdown in the Estimator
         const sel = document.getElementById('est-proj-select');
         const currentVal = sel.value; 
         let html = '<option value="">-- Select Project --</option>';
         projects.forEach(p => html += `<option value="${p.id}">${esc(p.title)}</option>`);
         sel.innerHTML = html;
         
         // Restore previous selection if it still exists
         if(currentVal) sel.value = currentVal; 
         
         updateEstItems(); 
         calcEstimate(); 
    }

    // 5. Update Browser Tab Title (Context-Aware)
    let title = APP_VER;
    switch(id) {
        case 'dashboard': title = "Dash | " + APP_VER; break;
        case 'projects': title = "Projects | " + APP_VER; break;
        case 'finance': title = "Cost | " + APP_VER; break;
        case 'estimator': title = "Estimator | " + APP_VER; break;
        case 'inventory': title = "Inv | " + APP_VER; break;
        case 'hp': title = "HP Tools | " + APP_VER; break;
        case 'exempt': title = "Exempt Log | " + APP_VER; break;
        case 'logbook': title = "Logbook | " + APP_VER; break;
    }
    document.title = title;
}
    
    function openModal(id) { 
    document.getElementById(id).classList.add('active'); 
    
    // Clear New Project inputs when opening
    if(id === 'projectModal') {
        document.getElementById('pTitle').value = '';
        document.getElementById('pDesc').value = '';
        document.getElementById('pDate').value = '';
        document.getElementById('pCost').value = '';
        if(document.getElementById('pUic')) document.getElementById('pUic').value = '';
        if(document.getElementById('pLoc')) document.getElementById('pLoc').value = '';
    }

    // --- FIX: POPULATE INVENTORY MODAL PROJECTS ---
    if(id === 'invModal') {
        const sel = document.getElementById('invProj');
        sel.innerHTML = '<option value="">-- None --</option>'; 
        projects.forEach(p => {
            sel.innerHTML += `<option value="${p.id}">${esc(p.title)}</option>`;
        });
    }
    // ----------------------------------------------

    if(id === 'expenseModal' || id === 'allocModal') { 
        const sel = document.getElementById(id === 'expenseModal' ? 'expProj' : 'allocProj'); 
        sel.innerHTML = '<option value="">-- General --</option>'; 
        projects.forEach(p => sel.innerHTML += `<option value="${p.id}">${esc(p.title)}</option>`); 
        
        if(id === 'expenseModal') {
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmt').value = '';
            document.getElementById('expDate').value = getTodayStr(); 
        } else {
            document.getElementById('allocDesc').value = '';
            document.getElementById('allocAmt').value = '';
            document.getElementById('allocDate').value = getTodayStr();
        }
    }
}

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function openExportModal() { 
        const data = JSON.stringify({projects,inventory,expenses,allocations,chat:chatLog, team, wiki:wikiText, hpState, viewMode, showComplete, estItems, exemptLog}); 
        document.getElementById('exportText').value = data;
        openModal('exportModal');
    }
    function copyExport() {
        const copyText = document.getElementById("exportText");
        copyText.select();
        document.execCommand("copy");
        showToast("Copied to clipboard", "info");
    }
    function openImportModal() {
        document.getElementById('importText').value = '';
        openModal('importModal');
    }
    function runImport() {
        try {
            const raw = document.getElementById('importText').value;
            const d = JSON.parse(raw);
            projects=d.projects||[]; inventory=d.inventory||[]; expenses=d.expenses||[]; allocations=d.allocations||[]; chatLog=d.chat||[]; team=d.team||[]; wikiText=d.wiki||""; 
            hpState=d.hpState||{}; viewMode=d.viewMode||'list'; showComplete=d.showComplete||false; 
            estItems=d.estItems||[]; exemptLog=d.exemptLog||[]; 
            // Data Migration for Updates
            projects.forEach(p => {
                if(!p.updatesSent) {
                    p.updatesSent = [];
                    // Migrate old single date if exists
                    if(p.updatesDate) {
                        p.updatesSent.push(p.updatesDate);
                        delete p.updatesDate;
                    }
                }
            });
            saveLocally(); render(); loadHPState();
            closeModal('importModal');
            showToast("Data Loaded Successfully");
        } catch(e) { alert("Invalid Data Code."); }
    }

    function saveLocally() { localStorage.setItem('rad25_7_data', JSON.stringify({projects,inventory,expenses,allocations,chat:chatLog,team,wiki:wikiText,hpState,viewMode,showComplete,estItems,exemptLog})); }
    
    function loadHPState() {
        // Updated state loader
        if(!hpState) return;
        Object.keys(hpState).forEach(k => {
            const el = document.getElementById(k);
            if(el) el.value = hpState[k];
        });
        // Recalculate if possible
        if(hpState['calc-a0']) calculateDecay();
        if(hpState['dist-d1']) calcInverseSquare();
        if(hpState['shield-i0']) calcShielding();
        if(hpState['stay-rate']) calcStayTime();
        if(hpState['alara-rate']) calcAlara();
    }

    function loadLocally() { 
    populateIsoSelects(); 
    const theme = localStorage.getItem('rad_theme'); 
    if (theme === 'dark') document.body.setAttribute('data-theme', 'dark'); 
    
    const d = JSON.parse(localStorage.getItem('rad25_7_data')); 
    
    // --- FIX: Check initialization flag ---
    const hasInitialized = localStorage.getItem('rad_init_flag');

    if(d) { 
        projects=d.projects||[]; inventory=d.inventory||[]; expenses=d.expenses||[]; allocations=d.allocations||[]; chatLog=d.chat||[]; team=d.team||[]; wikiText=d.wiki||""; 
        hpState=d.hpState||{}; viewMode=d.viewMode||'list'; showComplete=d.showComplete||false; 
        estItems=d.estItems||[]; exemptLog=d.exemptLog||[];
        
        // Migrations
        allocations.forEach(a => { if(!a.type && a.desc.toLowerCase().includes('initial')) a.type = 'base'; });
        projects.forEach(p => {
            if(p.cost && !allocations.find(a => a.projId === p.id)) {
                allocations.push({id: Date.now() + Math.random(), projId: p.id, date: p.due, amount: parseFloat(p.cost), desc: "Initial Budget", type: 'base'});
                delete p.cost;
            }
            if(!p.updatesSent) {
                p.updatesSent = [];
                if(p.updatesDate) { p.updatesSent.push(p.updatesDate); delete p.updatesDate; }
            }
        });
    } 
    else {
        // Only load starter data if we have NEVER initialized before
        if(!hasInitialized) {
            resetData(false); 
            localStorage.setItem('rad_init_flag', 'true');
        } else {
            // User presumably cleared data intentionally. Start clean.
            projects=[]; inventory=[]; expenses=[]; allocations=[]; chatLog=[]; team=[]; estItems=[]; exemptLog=[];
        }
    }
    
    render(); 
    loadHPState();
    updateEstItems(); 
    calcEstimate(); 
}
    
function resetData(ask=true) { 
        if(!ask || confirm("Restore Examples?")) { 
            projects = JSON.parse(JSON.stringify(STARTER_DATA.projects)); 
            inventory = JSON.parse(JSON.stringify(STARTER_DATA.inventory)); 
            expenses = JSON.parse(JSON.stringify(STARTER_DATA.expenses)); 
            allocations = JSON.parse(JSON.stringify(STARTER_DATA.allocations)); 
            chatLog = JSON.parse(JSON.stringify(STARTER_DATA.chat)); 
            team = STARTER_DATA.team; 
            wikiText = STARTER_DATA.wiki; 
            
            // FIX: This line was missing, so the log was always resetting to empty
            exemptLog = JSON.parse(JSON.stringify(STARTER_DATA.exemptLog || []));
            
            saveLocally(); 
            if(ask) location.reload(); 
        } 
    }

    function clearData() { if(confirm("Clear All?")) { projects=[]; inventory=[]; expenses=[]; allocations=[]; chatLog=[]; team=[]; wikiText=""; hpState={}; estItems=[]; exemptLog=[]; saveLocally(); render(); } }
    function toggleTheme() { const b=document.body; const newTheme = b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; if(newTheme === 'dark') b.setAttribute('data-theme', 'dark'); else b.removeAttribute('data-theme'); localStorage.setItem('rad_theme', newTheme); }

// --- GLOBAL SHORTCUTS & BEHAVIOR ---

// 1. Close Modals on "Escape" key
document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
        const active = document.querySelector('.modal-overlay.active');
        if (active) closeModal(active.id);
    }
});

// 2. Close Modals on Click Outside
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal(overlay.id);
    });
});
    
    loadLocally();
</script>
</body>
</html>
