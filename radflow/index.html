<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadFlow v15.2 | Light Mode Fixed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- VISUAL THEME (LIGHT MODE DEFAULT) --- */
        :root {
            /* Light Mode Variables (Now the Default) */
            --bg-body: #f8fafc;
            --bg-sidebar: #ffffff;
            --bg-panel: #ffffff;
            --bg-card: #f1f5f9;
            --bg-input: #e2e8f0;
            --border: #cbd5e1;
            --text-main: #0f172a;
            --text-muted: #64748b;
            
            /* Accents */
            --accent: #059669; /* Emerald Green */
            --accent-dim: rgba(5, 150, 105, 0.1);
            --danger: #dc2626; 
            --warning: #d97706; 
            --info: #2563eb; 
            --rad: #9333ea; 
            --money: #059669;
            --plan: #7c3aed;
            --comp: #64748b;
        }

        [data-theme="dark"] {
            /* Dark Mode Overrides */
            --bg-body: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-panel: #1e293b;
            --bg-card: #334155;
            --bg-input: #020617;
            --border: #475569;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --accent: #10b981; 
            --accent-dim: rgba(16, 185, 129, 0.15);
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --info: #3b82f6; 
            --rad: #d946ef; 
            --money: #34d399;
            --plan: #8b5cf6;
            --comp: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; transition: background 0.2s, color 0.2s; }
        
        /* --- LAYOUT --- */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; background: var(--bg-body); color: var(--text-main); display: grid; grid-template-columns: 240px 1fr 300px; grid-template-rows: 100vh; overflow: hidden; }

        @media (max-width: 1100px) { body { grid-template-columns: 200px 1fr; grid-template-rows: 1fr auto; } .chat-panel { grid-column: 2; grid-row: 2; border-left: none; border-top: 1px solid var(--border); height: 300px; } .main { grid-column: 2; grid-row: 1; } }
        @media (max-width: 768px) { body { display: block; height: auto; overflow-y: auto; } .sidebar { width: 100%; height: auto; border-right: none; flex-direction: row; flex-wrap: wrap; } .main { padding: 1rem; height: auto; overflow: visible; } .chat-panel { height: 400px; border-top: 4px solid var(--border); } }

        @media print {
            body { display: block; background: white; color: black; height: auto; overflow: visible; }
            .sidebar, .chat-panel, .btn, .btn-sync, .btn-toggle, .header button, .sync-box { display: none !important; }
            .main { padding: 0; margin: 0; width: 100%; }
            .widget { border: 1px solid #ccc; break-inside: avoid; background: white; color: black; box-shadow: none; margin-bottom: 20px; }
            .widget-head { border-bottom: 1px solid #000; color: black; }
            .sci-table th { color: black; border-bottom: 1px solid #000; }
            .sci-table td { border-bottom: 1px solid #ccc; color: black; }
            .list-item { background: white; border: 1px solid #eee; color: black; }
            :root { --text-main: black; --text-muted: #555; --bg-card: white; --bg-panel: white; }
        }

        /* --- COMPONENTS --- */
        .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 10; overflow-y: auto; }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--accent); display: flex; align-items: center; gap: 10px; margin-bottom: 2rem; }
        .nav-item { padding: 0.8rem 1rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-main); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }

        .sync-box { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .btn-sync { width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); cursor: pointer; font-size: 0.8rem; font-weight: bold; text-align: left; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .btn-sync:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-toggle { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 0.5rem; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; margin-bottom: 10px; }

        .main { padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 10px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .widget { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; margin-bottom: 1.5rem; }
        .widget-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.9rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 0.8rem; border-radius: 6px; margin-bottom: 5px; cursor: pointer; border-left: 3px solid transparent; font-size: 0.9rem; transition: transform 0.2s; }
        .list-item:hover { border-left-color: var(--accent); transform: translateX(3px); background: var(--bg-input); }
        .list-item.urgent { border-left-color: var(--danger); }
        
        .chart-container { display: flex; height: 20px; border-radius: 4px; overflow: hidden; background: var(--bg-input); margin-top: 10px; }
        .chart-seg { height: 100%; transition: width 0.5s; position: relative; }
        .chart-legend { display: flex; gap: 15px; margin-top: 5px; font-size: 0.7rem; color: var(--text-muted); flex-wrap: wrap; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        .progress-bar { height: 6px; background: var(--bg-input); border-radius: 3px; width: 100px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent); }

        .fin-card { padding: 1.5rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .fin-val { font-size: 1.8rem; font-weight: bold; color: var(--money); margin-top: 5px; }
        .fin-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .chat-panel { background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-header { padding: 1.5rem; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--text-muted); }
        .chat-feed { flex: 1; overflow-y: auto; padding: 1rem; }
        .chat-input-area { padding: 1rem; border-top: 1px solid var(--border); background: var(--bg-sidebar); }
        .msg { background: var(--bg-card); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; border: 1px solid var(--border); }
        .msg-meta { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.7rem; color: var(--text-muted); }
        
        .form-control { width: 100%; padding: 0.7rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; margin-bottom: 1rem; }
        .search-bar { width: 300px; border-radius: 20px; padding: 0.5rem 1rem; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); }
        
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; background: var(--accent); color: white; white-space: nowrap; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-panel); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .sci-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .sci-table td, .sci-table th { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
        .task-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .task-chk { cursor: pointer; font-size: 1.2rem; color: var(--text-muted); }
        .task-chk.checked { color: var(--accent); }
        .task-txt.checked { text-decoration: line-through; color: var(--text-muted); }
        
        .input-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .input-grid > * { flex: 1 1 150px; } 

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 1rem; overflow-x: auto; min-width: 300px; }
        .cal-day { background: var(--bg-card); min-height: 80px; padding: 5px; border-radius: 4px; border: 1px solid var(--border); font-size: 0.8rem; }
        .cal-day.today { border-color: var(--accent); background: var(--accent-dim); }
        .cal-day-header { text-align: center; font-size: 0.7rem; color: var(--text-muted); font-weight: bold; }
        .cal-event { font-size: 0.7rem; background: var(--info); color: white; padding: 2px 4px; border-radius: 3px; margin-top: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cal-event.due { background: var(--danger); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-atom"></i> RadFlow v15.2</div>
    
    <div style="display:flex; flex-wrap:wrap; gap:5px; width:100%; margin-bottom: 1rem;">
        <div class="nav-item active" id="nav-dash" onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i> Dash</div>
        <div class="nav-item" id="nav-proj" onclick="nav('projects')"><i class="fa-solid fa-list-check"></i> Proj</div>
        <div class="nav-item" id="nav-fin" onclick="nav('finance')"><i class="fa-solid fa-sack-dollar"></i> Cost</div>
        <div class="nav-item" id="nav-inv" onclick="nav('inventory')"><i class="fa-solid fa-boxes-stacked"></i> Inv</div>
        <div class="nav-item" id="nav-hp" onclick="nav('hp')"><i class="fa-solid fa-calculator"></i> HP</div>
    </div>

    <button class="btn-toggle" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i> Toggle Dark Mode</button>
    <button class="btn-toggle" onclick="window.print()"><i class="fa-solid fa-print"></i> Print Report</button>

    <div class="sync-box">
        <button class="btn-sync" onclick="exportData()"><i class="fa-solid fa-download"></i> Save Data</button>
        <button class="btn-sync" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-upload"></i> Load Data</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
        <button class="btn-sync" style="color:var(--danger); border-color:var(--danger);" onclick="clearData()">Clear All Data</button>
        <button class="btn-sync" style="color:var(--text-muted); border:none; background:transparent;" onclick="resetData()">Reset to Examples</button>
    </div>
</div>

<div class="main">
    <div id="view-dashboard" class="view-section active">
        <div class="header">
            <div><h1 style="margin:0;">Command Center</h1><p style="margin:0; color:var(--text-muted);" id="todayDate">Loading...</p></div>
            <input type="text" class="search-bar" placeholder="Search Projects & Inventory..." onkeyup="render(this.value)">
            <button class="btn" onclick="openModal('projectModal')">+ Quick Project</button>
        </div>
        
        <div class="widget">
            <div class="widget-head">Operational Analytics</div>
            <div class="dashboard-grid">
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">PROJECT STATUS OVERVIEW</div>
                    <div id="chart-proj" class="chart-container"></div>
                    <div id="legend-proj" class="chart-legend"></div>
                </div>
                <div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">GLOBAL BUDGET UTILIZATION</div>
                    <div id="chart-money" class="chart-container"></div>
                    <div class="chart-legend">
                        <div><span class="legend-dot" style="background:var(--money)"></span>Spent</div>
                        <div><span class="legend-dot" style="background:var(--bg-input)"></span>Remaining</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="widget"><div class="widget-head"><span>Active Projects</span><span style="font-size:0.8rem; cursor:pointer; color:var(--accent);" onclick="nav('projects')">View All &rarr;</span></div><div id="dash-projects"></div></div>
            <div class="widget"><div class="widget-head"><span>Pending Actions</span><i class="fa-solid fa-bolt" style="color:var(--warning)"></i></div><div id="dash-tasks"></div></div>
            <div class="widget"><div class="widget-head">Inventory Snapshot</div><div id="dash-inv"></div></div>
            <div class="widget"><div class="widget-head">Financial Snapshot</div><div id="dash-fin"></div></div>
        </div>
    </div>

    <div id="view-project-detail" class="view-section"></div>
    <div id="view-projects" class="view-section"><div class="header"><h1>All Projects</h1><input type="text" class="search-bar" placeholder="Filter..." onkeyup="render(this.value)"></div><div class="widget"><div id="full-project-list"></div></div></div>
    
    <div id="view-finance" class="view-section">
        <div class="header"><h1>Cost Tracker</h1><button class="btn" onclick="openModal('expenseModal')">+ Log Expense</button></div>
        <div class="dashboard-grid" style="margin-bottom:2rem;">
            <div class="fin-card"><div class="fin-label">Total Anticipated</div><div class="fin-val" id="fin-total-budget">$0.00</div></div>
            <div class="fin-card"><div class="fin-label">Total Spent</div><div class="fin-val" style="color:var(--warning);" id="fin-total-spent">$0.00</div></div>
        </div>
        <div class="widget"><div class="widget-head">Expense Log</div><div style="overflow-x:auto;"><table class="sci-table"><thead><tr><th>Date</th><th>Project</th><th>Description</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead><tbody id="expense-list"></tbody></table></div></div>
    </div>

    <div id="view-hp" class="view-section"><div class="header"><h1>HP Tools</h1></div><div class="widget"><div class="dashboard-grid"><div><label style="color:var(--text-muted); font-size:0.8rem;">Isotope</label><select id="calc-iso" class="form-control"><option value="Co-60" data-hl="5.27">Co-60</option><option value="Cs-137" data-hl="30.17">Cs-137</option><option value="Ir-192" data-hl="0.202">Ir-192</option></select><label style="color:var(--text-muted); font-size:0.8rem;">Initial (mCi)</label><input type="number" id="calc-a0" class="form-control" placeholder="100"><label style="color:var(--text-muted); font-size:0.8rem;">Date</label><input type="date" id="calc-date" class="form-control"><button class="btn" onclick="calculateDecay()" style="width:100%; background:var(--rad);">Calculate</button></div><div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px;"><div style="color:var(--text-muted);">Current Activity</div><div id="calc-result" style="font-size:2.5rem; color:var(--rad); font-weight:bold; margin:10px 0;">---</div></div></div></div></div>

    <div id="view-inventory" class="view-section"><div class="header"><h1>Inventory</h1><button class="btn" onclick="openModal('invModal')">+ Add Item</button></div><div class="widget"><div style="overflow-x:auto;"><table class="sci-table"><thead><tr><th>ID</th><th>Isotope</th><th>Activity</th><th>Dose</th><th>Status</th></tr></thead><tbody id="full-inv-list"></tbody></table></div></div></div>
</div>

<div class="chat-panel">
    <div class="chat-header"><i class="fa-regular fa-comments"></i> Team Log</div>
    <div id="chatFeed" class="chat-feed"></div>
    <div class="chat-input-area"><input type="text" id="chatInput" class="form-control" placeholder="Update team..." onkeypress="handleChat(event)"></div>
</div>

<div id="projectModal" class="modal-overlay">
    <div class="modal">
        <h3>New Project</h3>
        <input id="pTitle" class="form-control" placeholder="Project Name">
        <input id="pDesc" class="form-control" placeholder="Brief Description">
        <div class="input-grid"><div><label style="font-size:0.7rem; color:var(--text-muted);">DUE DATE</label><input id="pDate" type="date" class="form-control"></div><div><label style="font-size:0.7rem; color:var(--text-muted);">BUDGET ($)</label><input id="pCost" type="number" class="form-control" placeholder="0.00"></div></div>
        <div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('projectModal')">Cancel</button><button class="btn" onclick="addProject()">Save</button></div>
    </div>
</div>

<div id="expenseModal" class="modal-overlay">
    <div class="modal">
        <h3>Log Expense</h3>
        <label style="font-size:0.7rem; color:var(--text-muted);">PROJECT</label><select id="expProj" class="form-control"></select>
        <input id="expDesc" class="form-control" placeholder="Description">
        <div class="input-grid"><input id="expAmt" type="number" class="form-control" placeholder="Amount ($)"><input id="expDate" type="date" class="form-control"></div>
        <select id="expStatus" class="form-control"><option>Invoiced</option><option>Paid</option><option>Encumbered</option></select>
        <div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('expenseModal')">Cancel</button><button class="btn" onclick="addExpense()">Add</button></div>
    </div>
</div>

<div id="invModal" class="modal-overlay">
    <div class="modal">
        <h3>Log Container</h3>
        <div class="input-grid"><input id="invId" class="form-control" placeholder="ID"><input id="invIso" class="form-control" placeholder="Isotope"></div>
        <div class="input-grid"><input id="invAct" class="form-control" placeholder="Activity"><input id="invDose" type="number" class="form-control" placeholder="Dose (mR/hr)"></div>
        <select id="invStatus" class="form-control"><option>Stored</option><option>Staged</option><option>Shipped</option></select>
        <div style="display:flex; justify-content:flex-end; gap:10px;"><button class="btn-sync" style="width:auto;" onclick="closeModal('invModal')">Cancel</button><button class="btn" onclick="addInventory()">Log</button></div>
    </div>
</div>

<script>
    // --- STARTER DATA ---
    const STARTER_DATA = {
        projects: [
            { id: 101, title: "Class B Resin Shipment", status: "Active", due: "2025-12-30", cost: 85000, desc: "Transport of CNS 8-120B Cask.", tasks: [{id: 1, text: "Verify Cask Cert", done: true}, {id: 2, text: "Notify Broker", done: true}, {id: 3, text: "Schedule 100-ton Crane", done: false}] },
            { id: 102, title: "Lab 4 Cleanout", status: "Planning", due: "2026-02-15", cost: 12000, desc: "Volume reduction of DAW.", tasks: [{id: 1, text: "Order 10 B-25 Boxes", done: false}] },
            { id: 103, title: "Q4 NRC Waste Report", status: "Review", due: "2025-12-28", cost: 0, desc: "Urgent review required.", tasks: [{id: 1, text: "Compile Isotopes Table", done: true}, {id: 2, text: "RSO Sign-off", done: false}] },
            { id: 104, title: "Filter Bank 2B Changeout", status: "Active", due: "2026-01-10", cost: 45000, desc: "ALARA plan required.", tasks: [{id: 1, text: "Approve ALARA Plan", done: true}, {id: 2, text: "Stage Lead Shielding", done: false}] },
            { id: 105, title: "Soil Remediation: Sector 7", status: "Planning", due: "2026-03-01", cost: 150000, desc: "Excavation of contaminated soil.", tasks: [{id: 1, text: "Soil Sampling Plan", done: false}, {id: 2, text: "Intermodal Container Rental", done: false}] }
        ],
        inventory: [
            {id: "HIC-24-01", iso: "Co-60, Cs-137", act: "35 Ci", dose: 4500, status: "Staged"},
            {id: "LINER-8-120", iso: "Activation", act: "120 Ci", dose: 15000, status: "Staged"},
            {id: "DRM-24-55", iso: "H-3", act: "15 mCi", dose: 0.5, status: "Stored"},
            {id: "BOX-24-10", iso: "Mixed DAW", act: "100 mCi", dose: 12, status: "Stored"},
            {id: "SRC-IR-99", iso: "Ir-192", act: "5 Ci", dose: 2500, status: "Shipped"}
        ],
        expenses: [
            {id: 1, projId: 101, desc: "Cask Rental Fee", amount: 15000, date: "2025-11-01", status: "Paid"},
            {id: 2, projId: 101, desc: "Broker Surcharge", amount: 5000, date: "2025-11-05", status: "Invoiced"},
            {id: 3, projId: 104, desc: "Lead Shielding", amount: 8000, date: "2025-12-10", status: "Paid"},
            {id: 4, projId: 105, desc: "Excavator Deposit", amount: 12000, date: "2025-12-15", status: "Paid"}
        ],
        chat: [{user: "System", time: "08:00 AM", text: "RadFlow v15.2 initialized."}]
    };

    let projects = []; let inventory = []; let expenses = []; let chatLog = [];

    // --- RENDER & LOGIC ---
    function render(filter = "") {
        filter = filter.toLowerCase();
        document.getElementById('todayDate').innerText = new Date().toDateString();
        
        // 1. FILTER DATA
        const filteredProjs = projects.filter(p => p.title.toLowerCase().includes(filter) || p.desc.toLowerCase().includes(filter));
        const filteredInv = inventory.filter(i => i.id.toLowerCase().includes(filter) || i.iso.toLowerCase().includes(filter));
        const filteredExp = expenses.filter(e => e.desc.toLowerCase().includes(filter));

        // 2. DASHBOARD LISTS
        const pList = document.getElementById('dash-projects');
        pList.innerHTML = filteredProjs.length ? filteredProjs.map(p => {
            if(p.status === 'Complete') return '';
            const pct = p.tasks.length ? Math.round((p.tasks.filter(t=>t.done).length/p.tasks.length)*100) : 0;
            return `<div class="list-item" onclick="viewProject(${p.id})"><div style="flex:1;"><div style="display:flex; justify-content:space-between;"><span>${p.title}</span><span style="font-size:0.7rem; color:var(--text-muted)">${p.status}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div></div></div>`;
        }).join('') : '<div style="color:var(--text-muted); padding:10px;">No Matches</div>';

        const tList = document.getElementById('dash-tasks');
        let tHtml = '';
        filteredProjs.forEach(p => { if(p.status!=='Complete') p.tasks.forEach(t => { if(!t.done && t.text.toLowerCase().includes(filter)) tHtml += `<div class="list-item" style="border-left-color:var(--warning)" onclick="viewProject(${p.id})"><span>${t.text}</span><span style="font-size:0.7rem; color:var(--text-muted)">${p.title}</span></div>`; }); });
        tList.innerHTML = tHtml || '<div style="color:var(--text-muted); padding:10px;">No Pending Actions</div>';

        const iDash = document.getElementById('dash-inv');
        iDash.innerHTML = filteredInv.length ? filteredInv.slice(0,3).map(i => `<div class="list-item"><span>${i.id} (${i.iso})</span><span>${i.dose} mR/hr</span></div>`).join('') : '<div style="color:var(--text-muted); padding:10px;">Empty</div>';

        // 3. ANALYTICS (PROJECT STATUS)
        const statuses = { 'Planning': 0, 'Active': 0, 'Review': 0, 'Complete': 0 };
        projects.forEach(p => { if (statuses[p.status] !== undefined) statuses[p.status]++; });
        
        const totalProjs = projects.length || 1;
        const statusColors = { 'Planning': 'var(--plan)', 'Active': 'var(--accent)', 'Review': 'var(--info)', 'Complete': 'var(--comp)' };
        
        document.getElementById('chart-proj').innerHTML = Object.keys(statuses).map(k => {
            const pct = (statuses[k] / totalProjs) * 100;
            return pct > 0 ? `<div class="chart-seg" style="width:${pct}%; background:${statusColors[k]}" title="${k}: ${statuses[k]}"></div>` : '';
        }).join('');
        
        document.getElementById('legend-proj').innerHTML = Object.keys(statuses).map(k => statuses[k] > 0 ? `<div><span class="legend-dot" style="background:${statusColors[k]}"></span>${k} (${statuses[k]})</div>` : '').join('');

        // Budget Breakdown
        const totalBudg = projects.reduce((s, p) => s + (parseFloat(p.cost)||0), 0);
        const totalSpent = expenses.reduce((s, e) => s + (parseFloat(e.amount)||0), 0);
        const spentPct = totalBudg > 0 ? Math.min((totalSpent/totalBudg)*100, 100) : 0;
        document.getElementById('chart-money').innerHTML = `<div class="chart-seg" style="width:${spentPct}%; background:var(--money);"></div>`;
        document.getElementById('dash-fin').innerHTML = `<div style="text-align:center; padding:10px;"><div style="color:var(--text-muted); font-size:0.8rem;">TOTAL SPENT</div><div style="font-size:1.5rem; font-weight:bold; color:var(--warning);">$${totalSpent.toLocaleString()}</div><div style="color:var(--text-muted); font-size:0.7rem;">Budget: $${totalBudg.toLocaleString()}</div></div>`;

        // 4. SUB-PAGES
        document.getElementById('fin-total-budget').innerText = "$" + totalBudg.toLocaleString();
        document.getElementById('fin-total-spent').innerText = "$" + totalSpent.toLocaleString();
        document.getElementById('expense-list').innerHTML = filteredExp.map(e => `<tr><td>${e.date}</td><td>${projects.find(p => p.id == e.projId)?.title || "General"}</td><td>${e.desc}</td><td>$${e.amount.toLocaleString()}</td><td>${e.status}</td><td><i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delExpense(${e.id})"></i></td></tr>`).join('');
        document.getElementById('full-inv-list').innerHTML = filteredInv.map(i => `<tr><td>${i.id}</td><td style="color:var(--rad)">${i.iso}</td><td>${i.act}</td><td>${i.dose}</td><td>${i.status}</td></tr>`).join('');
        document.getElementById('full-project-list').innerHTML = filteredProjs.map(p => `<div class="list-item" onclick="viewProject(${p.id})"><span>${p.title}</span> <span>Due: ${p.due}</span></div>`).join('');
        
        const chat = document.getElementById('chatFeed');
        chat.innerHTML = chatLog.map(c => `<div class="msg"><div class="msg-meta"><span>${c.user}</span><span>${c.time}</span></div><div>${c.text}</div></div>`).join('');
        chat.scrollTop = chat.scrollHeight;
    }

    function viewProject(id) {
        const p = projects.find(x => x.id === id); if(!p) return;
        const spent = expenses.filter(e => e.projId == id).reduce((s, e) => s + parseFloat(e.amount), 0);
        const budget = parseFloat(p.cost) || 0;
        const burn = budget > 0 ? Math.min((spent/budget)*100, 100) : 0;
        const tHtml = p.tasks.map(t => `<div class="task-row"><div style="display:flex; gap:10px; align-items:center;"><i class="fa-solid ${t.done?'fa-square-check checked':'fa-square'} task-chk" onclick="togTask(${p.id},${t.id})"></i><span class="task-txt ${t.done?'checked':''}">${t.text}</span></div><i class="fa-solid fa-trash" style="margin-left:auto; cursor:pointer; color:var(--danger)" onclick="delTask(${p.id},${t.id})"></i></div>`).join('');
        
        document.getElementById('view-project-detail').innerHTML = `
            <div class="header"><button class="btn-sync" style="width:auto" onclick="nav('dashboard')">&larr; Back</button> <div style="display:flex; gap:10px;"><button class="btn" style="background:var(--info)" onclick="cloneProject(${p.id})">Clone</button><button class="btn" style="background:var(--danger)" onclick="delProj(${p.id})">Delete</button></div></div>
            <div class="widget"><h1 style="margin:0;">${p.title}</h1><p style="color:var(--text-muted); border-bottom:1px solid var(--border); padding-bottom:10px;">${p.desc}</p>
            <div class="input-grid"><div><label style="font-size:0.7rem; color:var(--text-muted)">STATUS</label><select class="form-control" style="margin:0;" onchange="updStatus(${p.id},this.value)"><option ${p.status==='Planning'?'selected':''}>Planning</option><option ${p.status==='Active'?'selected':''}>Active</option><option ${p.status==='Review'?'selected':''}>Review</option><option ${p.status==='Complete'?'selected':''}>Complete</option></select></div><div><label style="font-size:0.7rem; color:var(--text-muted)">DUE DATE</label><div style="font-size:1.1rem; padding:8px 0;">${p.due}</div></div></div>
            <div style="background:var(--bg-card); padding:15px; border-radius:8px; margin:20px 0; border:1px solid var(--border);"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="font-size:0.8rem; font-weight:bold;">BUDGET: $${budget.toLocaleString()}</span><span style="font-size:0.8rem; color:var(--warning);">SPENT: $${spent.toLocaleString()}</span></div><div class="progress-bar" style="width:100%; background:#1e293b;"><div class="progress-fill" style="width:${burn}%; background:var(--warning);"></div></div></div>
            <h3>Action Items</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><input id="newT" class="form-control" style="margin:0" placeholder="New task..."><button class="btn" onclick="addTask(${p.id})">Add</button></div><div>${tHtml}</div></div>`;
        nav('project-detail');
    }

    // --- ACTIONS ---
    function cloneProject(id) {
        const original = projects.find(x => x.id === id);
        const copy = JSON.parse(JSON.stringify(original));
        copy.id = Date.now();
        copy.title = "Copy of " + copy.title;
        copy.status = "Planning";
        copy.tasks.forEach(t => t.done = false); // Reset tasks
        projects.push(copy);
        saveLocally();
        viewProject(copy.id);
        alert("Project Cloned!");
    }

    function togTask(pId, tId) { projects.find(x=>x.id===pId).tasks.find(x=>x.id===tId).done ^= true; saveLocally(); viewProject(pId); }
    function addTask(pId) { const t = document.getElementById('newT').value; if(t) { projects.find(x=>x.id===pId).tasks.push({id:Date.now(), text:t, done:false}); saveLocally(); viewProject(pId); } }
    function delTask(pId, tId) { const p = projects.find(x=>x.id===pId); p.tasks = p.tasks.filter(x=>x.id!==tId); saveLocally(); viewProject(pId); }
    function updStatus(pId, s) { projects.find(x=>x.id===pId).status = s; saveLocally(); }
    function delProj(id) { if(confirm("Delete?")) { projects = projects.filter(x=>x.id!==id); saveLocally(); nav('dashboard'); } }
    function addProject() { const t=document.getElementById('pTitle').value; const d=document.getElementById('pDesc').value; const dt=document.getElementById('pDate').value; const c=document.getElementById('pCost').value; if(t) { projects.push({id:Date.now(), title:t, desc:d, due:dt, cost:c, status:"Planning", tasks:[]}); saveLocally(); closeModal('projectModal'); render(); } }
    function addExpense() { const pid=document.getElementById('expProj').value; const desc=document.getElementById('expDesc').value; const amt=document.getElementById('expAmt').value; const dt=document.getElementById('expDate').value; const st=document.getElementById('expStatus').value; if(desc && amt) { expenses.push({id:Date.now(), projId:pid, desc:desc, amount:parseFloat(amt), date:dt, status:st}); saveLocally(); closeModal('expenseModal'); render(); } }
    function delExpense(id) { if(confirm("Remove?")) { expenses = expenses.filter(x=>x.id!==id); saveLocally(); render(); } }
    function addInventory() { const id=document.getElementById('invId').value; const iso=document.getElementById('invIso').value; const act=document.getElementById('invAct').value; const dose=document.getElementById('invDose').value; const stat=document.getElementById('invStatus').value; if(id) { inventory.push({id, iso, act, dose, status:stat}); saveLocally(); closeModal('invModal'); render(); } }
    function calculateDecay() { const iso=document.getElementById('calc-iso'); const hl=parseFloat(iso.options[iso.selectedIndex].getAttribute('data-hl')); const a0=parseFloat(document.getElementById('calc-a0').value); const d=new Date(document.getElementById('calc-date').value); if(!a0 || isNaN(d.getTime())) return; const y=(new Date()-d)/(1000*60*60*24*365.25); const act=a0*Math.exp(-(Math.log(2)/hl)*y); document.getElementById('calc-result').innerText=act.toFixed(3)+" mCi"; }
    function handleChat(e) { if(e.key==='Enter'){ const t=document.getElementById('chatInput').value; if(t){ chatLog.push({user:"User", time:new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), text:t}); document.getElementById('chatInput').value=''; saveLocally(); render(); }}}
    function nav(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); }
    function openModal(id) { document.getElementById(id).classList.add('active'); if(id === 'expenseModal') { const sel = document.getElementById('expProj'); sel.innerHTML = '<option value="">-- General --</option>'; projects.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.title}</option>`); } }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    // --- IO ---
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({projects,inventory,expenses,chat:chatLog})); a.download="radflow_data.json"; a.click(); }
    function importData(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{setTimeout(()=>{try{const d=JSON.parse(e.target.result); projects=d.projects||[]; inventory=d.inventory||[]; expenses=d.expenses||[]; chatLog=d.chat||[]; saveLocally(); render(); alert("Data Loaded!");}catch(e){alert("Error");}},100)}; r.readAsText(f); input.value=''; }
    function saveLocally() { localStorage.setItem('rad151_data', JSON.stringify({projects,inventory,expenses,chat:chatLog})); }
    function loadLocally() { const d=JSON.parse(localStorage.getItem('rad151_data')); if(d) { projects=d.projects; inventory=d.inventory; expenses=d.expenses||[]; chatLog=d.chat; } else resetData(false); render(); }
    function resetData(ask=true) { if(!ask || confirm("Restore Examples?")) { projects=JSON.parse(JSON.stringify(STARTER_DATA.projects)); inventory=JSON.parse(JSON.stringify(STARTER_DATA.inventory)); expenses=JSON.parse(JSON.stringify(STARTER_DATA.expenses)); chatLog=JSON.parse(JSON.stringify(STARTER_DATA.chat)); saveLocally(); if(ask)location.reload(); } }
    function clearData() { if(confirm("Clear All?")) { projects=[]; inventory=[]; expenses=[]; chatLog=[]; saveLocally(); render(); } }
    function toggleTheme() {
        const b = document.body;
        // If current attribute is 'dark', removing it reverts to default (light). 
        // If it is null (default), set it to 'dark'.
        if (b.getAttribute('data-theme') === 'dark') {
            b.removeAttribute('data-theme');
        } else {
            b.setAttribute('data-theme', 'dark');
        }
    }

    // Init
    loadLocally();
</script>
</body>
</html>
