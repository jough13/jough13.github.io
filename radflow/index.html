<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadFlow v13.0 | Full Ops + Finance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- VISUAL THEME --- */
        :root {
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --bg-panel: #1e293b; --bg-card: #334155;
            --bg-input: #020617; --border: #475569; --text-main: #f8fafc; --text-muted: #94a3b8;
            --accent: #10b981; --accent-dim: rgba(16, 185, 129, 0.15);
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --rad: #d946ef; --money: #34d399;
        }
        [data-theme="light"] {
            --bg-body: #f8fafc; --bg-sidebar: #ffffff; --bg-panel: #ffffff; --bg-card: #f1f5f9;
            --bg-input: #e2e8f0; --border: #cbd5e1; --text-main: #0f172a; --text-muted: #64748b;
            --money: #059669;
        }
        * { box-sizing: border-box; outline: none; transition: background 0.2s, color 0.2s; }
        body { margin: 0; font-family: monospace; background: var(--bg-body); color: var(--text-main); display: grid; grid-template-columns: 240px 1fr 300px; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR & NAV --- */
        .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 10; }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--accent); display: flex; align-items: center; gap: 10px; margin-bottom: 2rem; }
        .nav-item { padding: 0.8rem 1rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-main); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }

        /* --- SYNC AREA --- */
        .sync-box { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .btn-sync { width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); cursor: pointer; font-size: 0.8rem; font-weight: bold; text-align: left; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .btn-sync:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .sync-label { font-size:0.65rem; color:var(--text-muted); text-align:center; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px; }

        /* --- MAIN & WIDGETS --- */
        .main { padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .widget { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; margin-bottom: 1.5rem; }
        .widget-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.9rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 0.8rem; border-radius: 6px; margin-bottom: 5px; cursor: pointer; border-left: 3px solid transparent; font-size: 0.9rem; transition: transform 0.2s; }
        .list-item:hover { border-left-color: var(--accent); transform: translateX(3px); background: #3f4d63; }
        
        .progress-bar { height: 4px; background: var(--bg-input); border-radius: 2px; width: 100px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent); }

        /* --- RIGHT SIDEBAR --- */
        .chat-panel { background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-header { padding: 1.5rem; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--text-muted); }
        .chat-feed { flex: 1; overflow-y: auto; padding: 1rem; }
        .chat-input-area { padding: 1rem; border-top: 1px solid var(--border); background: var(--bg-sidebar); }
        .msg { background: var(--bg-card); padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; }
        .msg-meta { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.7rem; color: var(--text-muted); }

        /* --- UTILS --- */
        .form-control { width: 100%; padding: 0.7rem; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; margin-bottom: 1rem; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; background: var(--accent); color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-panel); padding: 2rem; border-radius: 12px; width: 500px; border: 1px solid var(--border); }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .sci-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .sci-table td, .sci-table th { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
        .task-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .task-chk { cursor: pointer; font-size: 1.2rem; color: var(--text-muted); }
        .task-chk.checked { color: var(--accent); }
        .task-txt.checked { text-decoration: line-through; color: var(--text-muted); }

        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 1rem; }
        .cal-day-header { text-align: center; font-size: 0.7rem; color: var(--text-muted); font-weight: bold; padding: 5px; }
        .cal-day { background: var(--bg-card); min-height: 80px; padding: 5px; border-radius: 4px; border: 1px solid var(--border); font-size: 0.8rem; position: relative; }
        .cal-day.today { border-color: var(--accent); background: var(--accent-dim); }
        .cal-event { font-size: 0.7rem; background: var(--info); color: white; padding: 2px 4px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .cal-event.due { background: var(--danger); }

        /* Finance Specifics */
        .fin-card { padding: 1.5rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .fin-val { font-size: 1.8rem; font-weight: bold; color: var(--money); margin-top: 5px; }
        .fin-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-atom"></i> RadFlow v13</div>
    
    <div class="nav-item active" id="nav-dash" onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i> Dashboard</div>
    <div class="nav-item" id="nav-proj" onclick="nav('projects')"><i class="fa-solid fa-list-check"></i> Projects</div>
    <div class="nav-item" id="nav-fin" onclick="nav('finance')"><i class="fa-solid fa-sack-dollar"></i> Cost Tracker</div>
    <div class="nav-item" id="nav-cal" onclick="nav('calendar')"><i class="fa-solid fa-calendar-days"></i> Calendar</div>
    <div class="nav-item" id="nav-inv" onclick="nav('inventory')"><i class="fa-solid fa-boxes-stacked"></i> Inventory</div>
    <div class="nav-item" id="nav-hp" onclick="nav('hp')"><i class="fa-solid fa-calculator"></i> HP Tools</div>
    <div class="nav-item" id="nav-wiki" onclick="nav('wiki')"><i class="fa-solid fa-book-open"></i> Field Notes</div>

    <div class="sync-box">
        <div class="sync-label">JSON File Operations</div>
        <button class="btn-sync" onclick="exportData()"><i class="fa-solid fa-download"></i> Save Data to File</button>
        <button class="btn-sync" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-upload"></i> Load Data from File</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
        <button class="btn-sync" style="color:#ef4444; border-color:#ef4444;" onclick="clearData()"><i class="fa-solid fa-eraser"></i> Clear All Data</button>
        <button class="btn-sync" style="color:var(--text-muted); font-size:0.7rem; border:none; background:transparent;" onclick="resetData()">Reset to Examples</button>
    </div>
</div>

<div class="main">

    <div id="view-dashboard" class="view-section active">
        <div class="header">
            <div class="page-title"><h1>Command Center</h1><p id="todayDate">Loading...</p></div>
            <button class="btn" onclick="openModal('projectModal')">+ Quick Project</button>
        </div>
        <div class="dashboard-grid">
            <div class="widget"><div class="widget-head"><span>Active Projects</span><span style="font-size:0.8rem; cursor:pointer; color:var(--accent);" onclick="nav('projects')">View All &rarr;</span></div><div id="dash-projects"></div></div>
            <div class="widget"><div class="widget-head"><span>Pending Actions</span><i class="fa-solid fa-bolt" style="color:var(--warning)"></i></div><div id="dash-tasks"></div></div>
            <div class="widget"><div class="widget-head">Inventory Snapshot</div><div id="dash-inv"></div></div>
            <div class="widget" style="background: linear-gradient(145deg, var(--bg-panel), #2a1e38);"><div class="widget-head">Financial Snapshot</div><div id="dash-fin"></div></div>
        </div>
    </div>

    <div id="view-project-detail" class="view-section"></div>
    <div id="view-projects" class="view-section"><div class="header"><h1>All Projects</h1></div><div class="widget"><div id="full-project-list"></div></div></div>
    
    <div id="view-finance" class="view-section">
        <div class="header">
            <h1>Cost Tracker</h1>
            <button class="btn" onclick="openModal('expenseModal')">+ Log Expense</button>
        </div>
        <div class="dashboard-grid" style="margin-bottom:2rem;">
            <div class="fin-card">
                <div class="fin-label">Total Anticipated (Budgets)</div>
                <div class="fin-val" id="fin-total-budget">$0.00</div>
            </div>
            <div class="fin-card">
                <div class="fin-label">Total Actual (Spent)</div>
                <div class="fin-val" style="color:var(--warning);" id="fin-total-spent">$0.00</div>
            </div>
        </div>
        <div class="widget">
            <div class="widget-head">Expense Log</div>
            <table class="sci-table">
                <thead><tr><th>Date</th><th>Project</th><th>Description</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
                <tbody id="expense-list"></tbody>
            </table>
        </div>
    </div>

    <div id="view-calendar" class="view-section"><div class="header"><h1>Shared Calendar</h1></div><div class="widget"><div class="calendar-grid"><div class="cal-day-header">SUN</div><div class="cal-day-header">MON</div><div class="cal-day-header">TUE</div><div class="cal-day-header">WED</div><div class="cal-day-header">THU</div><div class="cal-day-header">FRI</div><div class="cal-day-header">SAT</div><div id="cal-days-container" style="display:contents;"></div></div></div></div>
    
    <div id="view-hp" class="view-section"><div class="header"><h1>HP Tools: Decay Calculator</h1></div><div class="widget"><div class="dashboard-grid"><div><label style="color:var(--text-muted); font-size:0.8rem;">Isotope</label><select id="calc-iso" class="form-control"><option value="Co-60" data-hl="5.27">Co-60</option><option value="Cs-137" data-hl="30.17">Cs-137</option><option value="Ir-192" data-hl="0.202">Ir-192</option></select><label style="color:var(--text-muted); font-size:0.8rem;">Initial Activity (mCi)</label><input type="number" id="calc-a0" class="form-control" placeholder="100"><label style="color:var(--text-muted); font-size:0.8rem;">Reference Date</label><input type="date" id="calc-date" class="form-control"><button class="btn" onclick="calculateDecay()" style="width:100%; background:var(--rad);">Calculate</button></div><div style="text-align:center; background:var(--bg-card); padding:20px; border-radius:10px;"><div style="color:var(--text-muted);">Current Activity</div><div id="calc-result" style="font-size:2.5rem; color:var(--rad); font-weight:bold; margin:10px 0;">---</div><div id="calc-details" style="font-size:0.8rem;">Waiting for input...</div></div></div></div></div>

    <div id="view-inventory" class="view-section"><div class="header"><h1>Scientific Inventory</h1><button class="btn" onclick="openModal('invModal')">+ Add Item</button></div><div class="widget"><table class="sci-table"><thead><tr><th>ID</th><th>Isotope</th><th>Activity</th><th>Dose (mR/hr)</th><th>Status</th></tr></thead><tbody id="full-inv-list"></tbody></table></div></div>

    <div id="view-wiki" class="view-section"><div class="header"><h1>Field Notes</h1></div><div class="widget"><textarea id="wiki-text" class="form-control" style="height:400px; font-family:monospace; background:var(--bg-body);" placeholder="Type shared notes here..."></textarea><button class="btn" onclick="saveWiki()">Save Notes</button></div></div>
</div>

<div class="chat-panel">
    <div class="chat-header"><i class="fa-regular fa-comments"></i> Team Log</div>
    <div id="chatFeed" class="chat-feed"></div>
    <div class="chat-input-area"><input type="text" id="chatInput" class="form-control" placeholder="Update team..." onkeypress="handleChat(event)"></div>
</div>

<div id="projectModal" class="modal-overlay">
    <div class="modal">
        <h3>New Project</h3>
        <input id="pTitle" class="form-control" placeholder="Project Name">
        <input id="pDesc" class="form-control" placeholder="Brief Description">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
                <label style="font-size:0.7rem; color:var(--text-muted);">DUE DATE</label>
                <input id="pDate" type="date" class="form-control">
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--text-muted);">ANTICIPATED COST ($)</label>
                <input id="pCost" type="number" class="form-control" placeholder="0.00">
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('projectModal')">Cancel</button>
            <button class="btn" onclick="addProject()">Save</button>
        </div>
    </div>
</div>

<div id="expenseModal" class="modal-overlay">
    <div class="modal">
        <h3>Log Expense</h3>
        <label style="font-size:0.7rem; color:var(--text-muted);">PROJECT LINK</label>
        <select id="expProj" class="form-control"></select>
        <input id="expDesc" class="form-control" placeholder="Description (e.g. Cask Rental)">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input id="expAmt" type="number" class="form-control" placeholder="Amount ($)">
            <input id="expDate" type="date" class="form-control">
        </div>
        <select id="expStatus" class="form-control"><option>Invoiced</option><option>Paid</option><option>Encumbered</option></select>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('expenseModal')">Cancel</button>
            <button class="btn" onclick="addExpense()">Add Expense</button>
        </div>
    </div>
</div>

<div id="invModal" class="modal-overlay">
    <div class="modal">
        <h3>Log Container</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input id="invId" class="form-control" placeholder="ID">
            <input id="invIso" class="form-control" placeholder="Isotope">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input id="invAct" class="form-control" placeholder="Activity (mCi)">
            <input id="invDose" type="number" class="form-control" placeholder="Dose (mR/hr)">
        </div>
        <select id="invStatus" class="form-control"><option>Stored</option><option>Staged</option><option>Shipped</option></select>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sync" style="width:auto;" onclick="closeModal('invModal')">Cancel</button>
            <button class="btn" onclick="addInventory()">Log</button>
        </div>
    </div>
</div>

<script>
    // --- MERGED STARTER DATA (FULL OPS + FINANCE) ---
    const STARTER_DATA = {
        projects: [
            { 
                id: 101, title: "Class B Resin Shipment", status: "Active", due: "2025-12-30", cost: 85000,
                desc: "Transport of CNS 8-120B Cask containing high activity resin liners.",
                tasks: [{id: 1, text: "Verify Cask Cert of Compliance", done: true}, {id: 2, text: "Contact Broker (Hittman)", done: true}, {id: 3, text: "Schedule 100-ton Crane", done: false}, {id: 4, text: "Final Manifest Sign-off", done: false}]
            },
            { 
                id: 102, title: "Lab 4 Cleanout", status: "Planning", due: "2026-02-15", cost: 12000,
                desc: "Volume reduction of DAW in Chemistry Lab 4.",
                tasks: [{id: 1, text: "Order 10 B-25 Boxes", done: false}, {id: 2, text: "Assign HP Tech Coverage", done: false}]
            },
            { 
                id: 103, title: "Q4 NRC Waste Report", status: "Review", due: "2025-12-28", cost: 0,
                desc: "End of quarter summary. Urgent review.",
                tasks: [{id: 1, text: "Compile Isotopes Table", done: true}, {id: 2, text: "RSO Sign-off", done: false}]
            },
            { 
                id: 104, title: "Filter Bank 2B Changeout", status: "Active", due: "2026-01-10", cost: 45000,
                desc: "High dose rate filter replacement. ALARA plan required.",
                tasks: [{id: 1, text: "Approve ALARA Plan", done: true}, {id: 2, text: "Stage Lead Shielding", done: false}]
            },
            { 
                id: 105, title: "Soil Remediation: Sector 7", status: "Planning", due: "2026-03-01", cost: 150000,
                desc: "Excavation of contaminated soil. Large volume shipment.",
                tasks: [{id: 1, text: "Soil Sampling Plan", done: false}, {id: 2, text: "Intermodal Container Rental", done: false}, {id: 3, text: "Profile Approval", done: false}]
            },
            { 
                id: 106, title: "Source Return: Ir-192", status: "Review", due: "2025-12-24", cost: 25000,
                desc: "Return of decayed sealed source to manufacturer.",
                tasks: [{id: 1, text: "Leak Test Source", done: true}, {id: 2, text: "Verify Type B Package", done: true}]
            }
        ],
        inventory: [
            {id: "HIC-24-01", iso: "Co-60, Cs-137", act: "35 Ci", dose: 4500, status: "Staged"},
            {id: "LINER-8-120", iso: "Activation Products", act: "120 Ci", dose: 15000, status: "Staged"},
            {id: "DRM-24-55", iso: "H-3", act: "15 mCi", dose: 0.5, status: "Stored"},
            {id: "BOX-24-10", iso: "Mixed DAW", act: "100 mCi", dose: 12, status: "Stored"},
            {id: "SRC-IR-99", iso: "Ir-192", act: "5 Ci", dose: 2500, status: "Shipped"}
        ],
        expenses: [
            {id: 1, projId: 101, desc: "Cask Rental Fee", amount: 15000, date: "2025-11-01", status: "Paid"},
            {id: 2, projId: 101, desc: "Broker Surcharge", amount: 5000, date: "2025-11-05", status: "Invoiced"},
            {id: 3, projId: 102, desc: "B-25 Box Purchase", amount: 2500, date: "2025-12-05", status: "Encumbered"},
            {id: 4, projId: 104, desc: "Lead Shielding Rental", amount: 8000, date: "2025-12-10", status: "Paid"},
            {id: 5, projId: 105, desc: "Excavator Rental (Deposit)", amount: 12000, date: "2025-12-15", status: "Paid"},
            {id: 6, projId: 106, desc: "Type B Container", amount: 5000, date: "2025-12-01", status: "Encumbered"}
        ],
        chat: [
            {user: "System", time: "08:00 AM", text: "RadFlow v13.0 Online."},
            {user: "JD", time: "09:15 AM", text: "Welcome back. The Soil Remediation budget has been approved."},
            {user: "AS", time: "09:20 AM", text: "Copy. I've logged the excavator deposit."}
        ],
        wiki: "EMERGENCY CONTACTS:\n- RSO (Alice): x5501\n- Broker (Bob): 555-0199\n- Disposal Site (Clive, UT): 888-555-1234\n\nWASTE CODES:\n- DAW: Dry Active Waste\n- HIC: High Integrity Container\n- LSA: Low Specific Activity\n\nPROCEDURES:\n- Daily checks must be logged by 0900.\n- Keys to the storage yard are in the Shift Supervisor office."
    };

    // --- STATE ---
    let projects = []; let inventory = []; let expenses = []; let chatLog = []; let wikiText = "";

    // --- IO ---
    function exportData() {
        const data = { projects, inventory, expenses, chat: chatLog, wiki: wikiText };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "radflow_data.json"; a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            setTimeout(() => {
                try {
                    const d = JSON.parse(e.target.result);
                    projects = d.projects || []; inventory = d.inventory || []; 
                    expenses = d.expenses || []; chatLog = d.chat || []; wikiText = d.wiki || "";
                    saveLocally(); render(); alert("Data Loaded Successfully!");
                } catch(err) { alert("Invalid File format."); }
            }, 100);
        };
        reader.readAsText(file);
        input.value = '';
    }

    function saveLocally() { localStorage.setItem('rad13_data', JSON.stringify({ projects, inventory, expenses, chat: chatLog, wiki: wikiText })); }
    
    function loadLocally() {
        const d = JSON.parse(localStorage.getItem('rad13_data'));
        if(d) { 
            projects = d.projects; inventory = d.inventory; expenses = d.expenses || []; chatLog = d.chat; wikiText = d.wiki || ""; 
        } else { resetData(false); }
        render();
    }

    function resetData(ask=true) { 
        if(!ask || confirm("Restore Full Ops Examples? (Current changes will be lost)")) { 
            projects = JSON.parse(JSON.stringify(STARTER_DATA.projects));
            inventory = JSON.parse(JSON.stringify(STARTER_DATA.inventory));
            expenses = JSON.parse(JSON.stringify(STARTER_DATA.expenses));
            chatLog = JSON.parse(JSON.stringify(STARTER_DATA.chat));
            wikiText = STARTER_DATA.wiki;
            saveLocally(); if(ask) location.reload();
        }
    }
    
    function clearData() { if(confirm("DELETE EVERYTHING?")) { projects=[]; inventory=[]; expenses=[]; chatLog=[]; wikiText=""; saveLocally(); render(); }}

    // --- RENDERERS ---
    function render() {
        document.getElementById('todayDate').innerText = new Date().toDateString();
        
        // PROJECTS
        const pList = document.getElementById('dash-projects');
        if(projects.length === 0) pList.innerHTML = '<div style="color:#64748b; font-size:0.8rem; padding:10px; text-align:center;">No Active Projects</div>';
        else pList.innerHTML = projects.map(p => {
            if(p.status === 'Complete') return '';
            const pct = p.tasks.length ? Math.round((p.tasks.filter(t=>t.done).length/p.tasks.length)*100) : 0;
            return `<div class="list-item" onclick="viewProject(${p.id})"><div style="flex:1;"><div style="display:flex; justify-content:space-between;"><span>${p.title}</span><span style="font-size:0.7rem; color:var(--text-muted)">${p.status}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div></div></div>`;
        }).join('');

        // TASKS
        const tList = document.getElementById('dash-tasks');
        let tHtml = '';
        projects.forEach(p => {
            if(p.status!=='Complete') p.tasks.forEach(t => { if(!t.done) tHtml += `<div class="list-item" style="border-left-color:var(--warning)" onclick="viewProject(${p.id})"><span>${t.text}</span><span style="font-size:0.7rem; color:var(--text-muted)">${p.title}</span></div>`; });
        });
        tList.innerHTML = tHtml || '<div style="color:#64748b; font-size:0.8rem; padding:10px; text-align:center;">No Pending Actions</div>';

        // FINANCE DASH WIDGET
        const totalBudg = projects.reduce((sum, p) => sum + (parseFloat(p.cost)||0), 0);
        const totalSpent = expenses.reduce((sum, e) => sum + (parseFloat(e.amount)||0), 0);
        document.getElementById('dash-fin').innerHTML = `
            <div style="text-align:center; padding:10px;">
                <div style="color:var(--text-muted); font-size:0.8rem;">TOTAL SPENT</div>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--warning);">$${totalSpent.toLocaleString()}</div>
                <div style="color:var(--text-muted); font-size:0.7rem;">Budget: $${totalBudg.toLocaleString()}</div>
                <div style="margin-top:10px; cursor:pointer; color:var(--accent); font-size:0.8rem;" onclick="nav('finance')">Open Cost Tracker &rarr;</div>
            </div>`;

        // FINANCE VIEW
        document.getElementById('fin-total-budget').innerText = "$" + totalBudg.toLocaleString();
        document.getElementById('fin-total-spent').innerText = "$" + totalSpent.toLocaleString();
        document.getElementById('expense-list').innerHTML = expenses.map(e => {
            const pName = projects.find(p => p.id == e.projId)?.title || "General";
            return `<tr><td>${e.date}</td><td>${pName}</td><td>${e.desc}</td><td>$${e.amount.toLocaleString()}</td><td>${e.status}</td><td><i class="fa-solid fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delExpense(${e.id})"></i></td></tr>`;
        }).join('');

        // INV
        document.getElementById('dash-inv').innerHTML = inventory.length === 0 ? '<div style="color:#64748b; padding:10px; text-align:center;">Empty</div>' : inventory.slice(0,3).map(i => `<div class="list-item"><span>${i.id} (${i.iso})</span><span>${i.dose} mR/hr</span></div>`).join('');
        document.getElementById('full-inv-list').innerHTML = inventory.map(i => `<tr><td>${i.id}</td><td style="color:var(--rad)">${i.iso}</td><td>${i.act}</td><td>${i.dose}</td><td>${i.status}</td></tr>`).join('');
        
        // FULL PROJECT LIST
        document.getElementById('full-project-list').innerHTML = projects.map(p => `<div class="list-item" onclick="viewProject(${p.id})"><span>${p.title}</span> <span>Due: ${p.due}</span></div>`).join('');

        // CHAT & WIKI
        document.getElementById('wiki-text').value = wikiText;
        document.getElementById('chatFeed').innerHTML = chatLog.map(c => `<div class="msg"><div class="msg-meta"><span>${c.user}</span><span>${c.time}</span></div><div>${c.text}</div></div>`).join('');
        document.getElementById('chatFeed').scrollTop = 9999;

        renderCalendar();
    }

    function viewProject(id) {
        const p = projects.find(x => x.id === id);
        if(!p) return;
        
        const spent = expenses.filter(e => e.projId == id).reduce((sum, e) => sum + parseFloat(e.amount), 0);
        const budget = parseFloat(p.cost) || 0;
        const burn = budget > 0 ? Math.min((spent/budget)*100, 100) : 0;

        const tHtml = p.tasks.map(t => `<div class="task-row"><i class="fa-solid ${t.done?'fa-square-check checked':'fa-square'} task-chk" onclick="togTask(${p.id},${t.id})"></i> <span class="task-txt ${t.done?'checked':''}">${t.text}</span> <i class="fa-solid fa-trash" style="margin-left:auto; cursor:pointer; color:var(--danger)" onclick="delTask(${p.id},${t.id})"></i></div>`).join('');
        
        document.getElementById('view-project-detail').innerHTML = `
            <div class="header"><button class="btn-sync" style="width:auto" onclick="nav('dashboard')">&larr; Back</button> <button class="btn" style="background:var(--danger)" onclick="delProj(${p.id})">Delete</button></div>
            <div class="widget"><h1 style="margin:0;">${p.title}</h1><p style="color:var(--text-muted); border-bottom:1px solid var(--border); padding-bottom:10px;">${p.desc}</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div><label style="font-size:0.7rem; color:var(--text-muted)">STATUS</label><select class="form-control" style="margin:0;" onchange="updStatus(${p.id},this.value)"><option ${p.status==='Planning'?'selected':''}>Planning</option><option ${p.status==='Active'?'selected':''}>Active</option><option ${p.status==='Review'?'selected':''}>Review</option><option ${p.status==='Complete'?'selected':''}>Complete</option></select></div>
                <div><label style="font-size:0.7rem; color:var(--text-muted)">DUE DATE</label><div style="font-size:1.1rem; padding:8px 0;">${p.due}</div></div>
            </div>
            <div style="background:var(--bg-card); padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="font-size:0.8rem; font-weight:bold;">BUDGET: $${budget.toLocaleString()}</span><span style="font-size:0.8rem; color:var(--warning);">SPENT: $${spent.toLocaleString()}</span></div>
                <div class="progress-bar" style="width:100%; background:#1e293b;"><div class="progress-fill" style="width:${burn}%; background:var(--warning);"></div></div>
            </div>
            <h3>Action Items</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><input id="newT" class="form-control" style="margin:0" placeholder="New task..."><button class="btn" onclick="addTask(${p.id})">Add</button></div><div>${tHtml}</div></div>`;
        nav('project-detail');
    }

    function renderCalendar() {
        const container = document.getElementById('cal-days-container'); container.innerHTML = '';
        for(let i=1; i<=31; i++) {
            const dayDiv = document.createElement('div'); dayDiv.className = 'cal-day';
            if(i === new Date().getDate()) dayDiv.classList.add('today');
            dayDiv.innerHTML = `<span style="font-weight:bold; color:var(--text-muted);">${i}</span>`;
            const dayStr = String(i).padStart(2, '0');
            projects.forEach(p => { if(p.due.endsWith(dayStr) && p.status !== 'Complete') dayDiv.innerHTML += `<div class="cal-event due" onclick="viewProject(${p.id})">${p.title}</div>`; });
            container.appendChild(dayDiv);
        }
    }

    // --- ACTIONS ---
    function togTask(pId, tId) { projects.find(x=>x.id===pId).tasks.find(x=>x.id===tId).done ^= true; saveLocally(); viewProject(pId); }
    function addTask(pId) { const t = document.getElementById('newT').value; if(t) { projects.find(x=>x.id===pId).tasks.push({id:Date.now(), text:t, done:false}); saveLocally(); viewProject(pId); } }
    function delTask(pId, tId) { const p = projects.find(x=>x.id===pId); p.tasks = p.tasks.filter(x=>x.id!==tId); saveLocally(); viewProject(pId); }
    function updStatus(pId, s) { projects.find(x=>x.id===pId).status = s; saveLocally(); }
    function delProj(id) { if(confirm("Delete?")) { projects = projects.filter(x=>x.id!==id); saveLocally(); nav('dashboard'); } }
    
    function addProject() { 
        const t=document.getElementById('pTitle').value; const d=document.getElementById('pDesc').value; const dt=document.getElementById('pDate').value; const c=document.getElementById('pCost').value;
        if(t) { projects.push({id:Date.now(), title:t, desc:d, due:dt, cost:c, status:"Planning", tasks:[]}); saveLocally(); closeModal('projectModal'); render(); } 
    }
    
    function addExpense() {
        const pid = document.getElementById('expProj').value; const desc = document.getElementById('expDesc').value; const amt = document.getElementById('expAmt').value; const dt = document.getElementById('expDate').value; const st = document.getElementById('expStatus').value;
        if(desc && amt) { expenses.push({id:Date.now(), projId:pid, desc:desc, amount:parseFloat(amt), date:dt, status:st}); saveLocally(); closeModal('expenseModal'); render(); }
    }
    function delExpense(id) { if(confirm("Remove this expense?")) { expenses = expenses.filter(x=>x.id!==id); saveLocally(); render(); } }

    function addInventory() {
        const id=document.getElementById('invId').value; const iso=document.getElementById('invIso').value; const act=document.getElementById('invAct').value; const dose=document.getElementById('invDose').value; const stat=document.getElementById('invStatus').value; 
        if(id) { inventory.push({id, iso, act, dose, status:stat}); saveLocally(); closeModal('invModal'); render(); } 
    }
    
    // --- HELPER STUFF ---
    function calculateDecay() { const iso=document.getElementById('calc-iso'); const hl=parseFloat(iso.options[iso.selectedIndex].getAttribute('data-hl')); const a0=parseFloat(document.getElementById('calc-a0').value); const d=new Date(document.getElementById('calc-date').value); if(!a0 || isNaN(d.getTime())) return; const y=(new Date()-d)/(1000*60*60*24*365.25); const act=a0*Math.exp(-(Math.log(2)/hl)*y); document.getElementById('calc-result').innerText=act.toFixed(3)+" mCi"; document.getElementById('calc-details').innerText=`Elapsed: ${y.toFixed(2)} yrs`; }
    function saveWiki() { wikiText = document.getElementById('wiki-text').value; saveLocally(); alert("Notes Saved"); }
    function handleChat(e) { if(e.key==='Enter'){ const t=document.getElementById('chatInput').value; if(t){ chatLog.push({user:"User", time:new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), text:t}); document.getElementById('chatInput').value=''; saveLocally(); render(); }}}
    function nav(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); }
    
    function openModal(id) { 
        document.getElementById(id).classList.add('active');
        if(id === 'expenseModal') {
            const sel = document.getElementById('expProj'); sel.innerHTML = '<option value="">-- General / Overhead --</option>';
            projects.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.title}</option>`);
        }
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // Init
    loadLocally();
</script>
</body>
</html>
