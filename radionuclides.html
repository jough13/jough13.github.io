<!DOCTYPE html>
<html lang="en">

<head>
  <!--Basic HTML Metadata-->
  <meta charset="UTF-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <script>
    (function() {

      // Function to apply the dark theme

      const applyTheme = () => {
        document.documentElement.classList.add('dark');
      };

      // Check 1: See if a theme is explicitly saved in localStorage

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        applyTheme();
        return;
      }

      // Check 2: If no saved theme, check the user's OS/browser preference

      if (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        applyTheme();
      }

    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
  <title>Health Physics Toolbox</title>
  <!--External Libraries & Frameworks-->
  <!--Tailwind CSS for styling-->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Enables Tailwind's dark mode feature, allowing class-based theme switching (e.g., <body class="dark">)

    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <!--React Libraries for building the user interface-->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!--Babel to transpile JSX (React's syntax) into plain JavaScript in the browser-->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!--Chart.js for creating data visualizations-->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!--Google Fonts for a clean, modern typeface-->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <!--Custom Application Styles-->
  <link href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer onload="renderMathInElement(document.body);" src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    /* --- Styles for the mouse coordinate display on the map --- */

    .leaflet-control-mouseposition {
      background-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 5px #bbb;
      padding: 3px 8px;
      margin: 0;
      color: #333;
      font: 12px/1.5 "Inter", sans-serif;
      border-radius: 4px;
      border: 1px solid #aaa;
    }
  </style>

  <style>
    /* --- STYLES FOR PERSISTENT NUMBER INPUT SPINNERS & CUSTOM DRAW CURSOR --- */
    .persistent-spinner::-webkit-inner-spin-button,
    .persistent-spinner::-webkit-outer-spin-button {
      opacity: 0.3;
      -webkit-appearance: inner-spin-button !important;
      cursor: pointer;
      transition: opacity 0.2s ease-in-out;
    }

    .persistent-spinner:hover::-webkit-inner-spin-button,
    .persistent-spinner:hover::-webkit-outer-spin-button,
    .persistent-spinner:focus::-webkit-inner-spin-button,
    .persistent-spinner:focus::-webkit-outer-spin-button {
      opacity: 1;
    }

    /* ADDED: This creates the yellow dot icon for the bias sample drawing tool */
    .leaflet-draw-biased-marker-icon {
      background-color: #facc15;
      /* amber-400 */
      border: 2px solid #ca8a04;
      /* amber-600 */
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    }
  </style>


  <style>
    /* This is now the only style block needed for the fade-in.
         It hides the main content area by default to prevent any FOUC.
         */
    #root {
      visibility: hidden;
      /* Hide it completely */
      opacity: 0;
      /* Start fully transparent */
      transform: translateY(-10px);
      /* Start slightly moved up */
      /* Prepare for a smooth transition when the 'visible' class is added */
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    }

    /* This class will be added by our script to trigger the animation */
    #root.visible {
      visibility: visible;
      /* Make it visible */
      opacity: 1;
      /* Fade it in */
      transform: translateY(0);
      /* Move it to its final position */
    }
  </style>

  <style>
    /* --- LOADER STYLES (NOW THEME-AWARE) --- */
    /* Light Mode Defaults */
    #loader {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background-color: #f1f5f9;
      /* slate-100 */
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid #cbd5e1;
      /* slate-300 */
      border-bottom-color: #38bdf8;
      /* sky-400 */
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: 20px;
      font-size: 1rem;
      font-weight: 500;
      color: #64748b;
      /* slate-500 */
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Dark Mode Overrides */
    .dark #loader {
      background-color: #0f172a;
      /* slate-900 */
    }

    .dark .spinner {
      border: 5px solid #334155;
      /* slate-700 */
      border-bottom-color: #38bdf8;
      /* sky-400 */
    }

    .dark .loading-text {
      color: #94a3b8;
      /* slate-400 */
    }

    /* General Loader Logic (Unchanged) */
    #loader.hidden {
      opacity: 0;
      visibility: hidden;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }
  </style>

  <style>
    body {
      /* Sets the default background to your dark theme color */
      background-color: #0f172a;
      /* This is Tailwind's slate-900 */
      font-family: "Inter", sans-serif;
    }

    /* Custom scrollbar styling for a consistent look across browsers */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1e293b;
    }

    ::-webkit-scrollbar-thumb {
      background: #64748b;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    /* Keyframe animation for new elements fading into view */
    .animate-fade-in {
      animation: fade-in 0.3s ease-out forwards;
    }

    /* Keyframe animation for toast notifications sliding in from the bottom */
    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-toast-in {
      animation: toast-in 0.3s ease-out forwards;
    }

    /* --- NEW, TARGETED STYLES FOR SAMPLE POINTS --- */
    .grid-sample-marker {
      stroke: #1E88E5;
      /* blue-600 */
      stroke-width: 1;
      fill: #1E88E5;
      fill-opacity: 1;
    }

    .origin-sample-marker {
      stroke: #9333ea;
      /* purple-600 */
      stroke-width: 2;
      fill: #c084fc;
      /* purple-400 */
      fill-opacity: 1;
    }

    .biased-sample-marker {
      stroke: #facc15;
      /* amber-400 */
      stroke-width: 1;
      fill: #facc15;
      fill-opacity: 1;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3/dist/geosearch.css" />
  <script src="https://unpkg.com/leaflet-geosearch@3/dist/geosearch.umd.js"></script>

  <script>
    // When the document is ready, add the 'visible' class to the #root element

    // to trigger our CSS transition.

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('root').classList.add('visible');
    });
  </script>
</head>

<body class="bg-slate-100 dark:bg-slate-900 transition-colors duration-300">
  <div id="loader">
    <div class="spinner"></div>
    <p class="loading-text">Health Physics Toolbox loading...</p>
  </div>
  <!--The root element where the React application will be mounted.-->
  <div id="root"></div>
  <div id="back-to-top-root"></div>
  <div id="modal-root"></div>
  <div id="toast-root"></div>
  <!--The primary dataset for all radionuclides.
         Keeping this in a separate script tag makes the main application logic cleaner and easier to manage.
         Each object conforms to a consistent structure for properties like name, symbol, halfLife, etc.-->
  <script>
    // Radionuclide data updated to include dosimetry values from 10 CFR 20, Appendix B

    const RADIONUCLIDE_DATA = [{
        name: 'Actinium-225',
        symbol: 'Ac-225',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.83 MeV (dominant)'],
          gamma: ['0.099 MeV', '0.150 MeV'],
          beta: []
        },
        daughterEmissions: {
          from: 'Fr-221',
          alpha: ['6.34 MeV']
        },
        halfLife: '9.92 days',
        decayConstant: '0.0693 day⁻¹',
        specificActivity: '7.8 x 10^13 Bq/g',
        parent: 'Thorium-229 (α)',
        daughter: 'Francium-221 (α)',
        commonUses: ['Targeted Alpha Therapy (TAT) for cancer, often called an "alpha-emitter generator" for its decay chain.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A promising but scarce alpha-emitter used in clinical trials for targeted cancer therapy.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.8,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 2,
            ingestion: 0.8
          },
          DAC: {
            inhalation_W: 9e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Actinium-227',
        symbol: 'Ac-227',
        emissionType: ['Beta-minus', 'Alpha'],
        emissionEnergies: {
          beta: ['0.045 MeV (max)'],
          alpha: ['4.95 MeV (1.38%)'],
          gamma: []
        },
        avgBetaEnergy: '0.015 MeV',
        daughterEmissions: {
          from: 'Th-227',
          alpha: ['6.038 MeV'],
          gamma: ['0.236 MeV']
        },
        halfLife: '21.77 years',
        decayConstant: '0.0318 year⁻¹',
        specificActivity: '9.7 x 10^11 Bq/g',
        parent: 'Protactinium-231',
        daughter: 'Thorium-227 (β) or Francium-223 (α)',
        commonUses: ['Actinium-225 generator (medical)', 'Research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used in limited research applications and as a source for Ac-225 generators.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.0001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.003,
            ingestion: 0.1
          },
          DAC: {
            inhalation_W: 2e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Actinium-228',
        symbol: 'Ac-228',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['2.14 MeV (max)'],
          gamma: ['0.911 MeV', '0.969 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.713 MeV',
        halfLife: '6.15 hours',
        decayConstant: '0.113 hour⁻¹',
        specificActivity: '1.2 x 10^17 Bq/g',
        parent: 'Radium-228',
        daughter: 'Thorium-228 (β-)',
        commonUses: ['Intermediate in Thorium-232 decay chain'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'Frequently encountered as a short-lived daughter product in the Thorium-232 natural decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.6,
          A2: 0.2,
          unit: 'TBq'
        },
        gammaConstant: '0.844 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_D: 400,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 2e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Americium-241',
        symbol: 'Am-241',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.486 MeV'],
          gamma: ['0.0595 MeV'],
          beta: []
        },
        halfLife: '432.2 years',
        decayConstant: '0.00160 year⁻¹',
        specificActivity: '1.27 x 10^11 Bq/g',
        parent: 'Plutonium-241 (β-)',
        daughter: 'Neptunium-237',
        commonUses: ['Smoke detectors', 'Industrial gauges (thickness, density)', 'Neutron sources'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'Used in virtually all household ionization smoke detectors and in various industrial gauges.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        gammaConstant: '0.012 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 0.006,
            ingestion: 0.8
          },
          DAC: {
            inhalation_W: 3e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Antimony-124',
        symbol: 'Sb-124',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['2.35 MeV (max)'],
          gamma: ['0.603 MeV', '1.691 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.783 MeV',
        halfLife: '60.2 days',
        decayConstant: '0.0115 day⁻¹',
        specificActivity: '7.8 x 10^14 Bq/g',
        parent: 'Tin-124',
        daughter: 'Tellurium-124 (stable)',
        commonUses: ['Tracer in hydrology', 'Industrial applications', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'Used for specialized industrial tracer studies but not in widespread applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.6,
          A2: 0.6,
          unit: 'TBq'
        },
        gammaConstant: '1.07 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_D: 80,
            ingestion: 100
          },
          DAC: {
            inhalation_D: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Antimony-125',
        symbol: 'Sb-125',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.767 MeV (max)'],
          gamma: ['0.428 MeV', '0.601 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.256 MeV',
        halfLife: '2.758 years',
        decayConstant: '0.251 year⁻¹',
        specificActivity: '1.6 x 10^13 Bq/g',
        parent: 'Tin-125',
        daughter: 'Tellurium-125m (IT) -> Tellurium-125 (stable)',
        commonUses: ['Environmental tracer (fission product)', 'Calibration source'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived fission product used occasionally as a calibration source or environmental tracer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            inhalation_W: 300,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 1e-7,
            inhalation_W: 2e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Arsenic-74',
        symbol: 'As-74',
        emissionType: ['Positron Emission', 'Beta-minus', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['1.35 MeV (max)'],
          gamma: ['0.596 MeV', '0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.450 MeV',
        halfLife: '17.77 days',
        decayConstant: '0.039 day⁻¹',
        specificActivity: '5.1 x 10^15 Bq/g',
        parent: 'Germanium-74',
        daughter: 'Selenium-74 (stable) or Germanium-74 (stable)',
        commonUses: ['PET imaging research', 'Tracer studies'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used only in specialized PET imaging research; not for routine clinical use.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Astatine-211',
        symbol: 'At-211',
        emissionType: ['Alpha', 'Electron Capture', 'X-ray'],
        emissionEnergies: {
          alpha: ['5.867 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '7.21 hours',
        decayConstant: '0.096 hour⁻¹',
        specificActivity: '7.8 x 10^16 Bq/g',
        parent: 'Bismuth-209 (α,2n)',
        daughter: 'Bismuth-207 (EC) or Polonium-211 (α)',
        commonUses: ['Targeted alpha therapy research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A promising research alpha-emitter that is difficult to produce and has a short half-life.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 20,
          A2: 0.005,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 9,
            ingestion: 7
          },
          DAC: {
            inhalation_W: 4e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Astatine-218',
        emissionType: ['Alpha', 'Beta-minus'],
        symbol: 'At-218',
        emissionEnergies: {
          alpha: ['6.757 MeV'],
          beta: ['2.88 MeV (max)']
        },
        avgBetaEnergy: '0.960 MeV',
        halfLife: '1.5 seconds',
        decayConstant: '0.462 s⁻¹',
        specificActivity: '4.8 x 10^19 Bq/g',
        parent: 'Polonium-218',
        daughter: 'Bismuth-214 (α) or Radon-218 (β-)',
        commonUses: ['Intermediate in U-238 decay chain'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain with no practical applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 10,
            ingestion: 10
          },
          DAC: {
            inhalation_W: 5e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Barium-133',
        symbol: 'Ba-133',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.356 MeV', '0.081 MeV'],
          alpha: []
        },
        halfLife: '10.51 years',
        decayConstant: '0.0659 year⁻¹',
        gammaConstant: '0.30 R·m²/hr·Ci',
        specificActivity: '9.3 x 10^12 Bq/g',
        parent: 'Lanthanum-133',
        daughter: 'Cesium-133 (stable)',
        commonUses: ['Calibration sources', 'Density gauging'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A common, long-lived gamma source used for calibrating gamma spectroscopy systems.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 3,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            inhalation_W: 90,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 1e-7,
            inhalation_W: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Barium-137',
        symbol: 'Ba-137',
        emissionType: ['Stable'],
        emissionEnergies: {
          alpha: [],
          beta: [],
          gamma: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        specificActivity: '0 Bq/g',
        parent: 'Barium-137m (IT)',
        daughter: 'Stable',
        commonUses: ['Final stable product of Cesium-137 decay', 'Stable isotope analysis'],
        category: 'Stable/Reference',
        commonality: 'Common',
        commonalityReason: 'The stable end-product of Cs-137 decay, one of the most common radioisotopes.',
        sourceRef: {},
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Barium-137m',
        symbol: 'Ba-137m',
        emissionType: ['Isomeric Transition', 'Gamma'],
        emissionEnergies: {
          alpha: [],
          beta: [],
          gamma: ['0.662 MeV']
        },
        halfLife: '2.55 minutes',
        decayConstant: '0.272 min⁻¹',
        specificActivity: '2.9 x 10^18 Bq/g',
        parent: 'Cesium-137 (β-)',
        daughter: 'Barium-137 (stable)',
        commonUses: ['Source of gamma rays from Cesium-137 calibration sources', 'Medical imaging (historical)'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'The immediate, gamma-emitting daughter of Cs-137, responsible for its characteristic 0.662 MeV gamma ray.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 0.6,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bismuth-207',
        symbol: 'Bi-207',
        emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.570 MeV', '1.063 MeV'],
          alpha: []
        },
        halfLife: '31.55 years',
        decayConstant: '0.0219 year⁻¹',
        specificActivity: '2.07 x 10^12 Bq/g',
        parent: 'Lead-207 (p,n)',
        daughter: 'Lead-207 (stable)',
        commonUses: ['Calibration sources', 'Environmental tracer'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived isotope used for specialized gamma calibration, but not in routine use.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            inhalation_W: 7,
            ingestion: 50
          },
          DAC: {
            inhalation_D: 1e-8,
            inhalation_W: 3e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bismuth-209',
        symbol: 'Bi-209',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['3.137 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '2.01 x 10¹⁹ years',
        decayConstant: '3.45 x 10⁻²⁰ year⁻¹',
        specificActivity: '0.001 Bq/g',
        parent: 'Primordial',
        daughter: 'Thallium-205 (stable)',
        commonUses: ['Considered stable for most practical purposes', 'Recently discovered to be radioactive'],
        category: 'Natural',
        commonality: 'Common',
        commonalityReason: 'The most abundant isotope of bismuth, long considered stable, with an extremely long half-life.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Bismuth-210',
        emissionType: ['Beta-minus', 'Alpha'],
        symbol: 'Bi-210',
        emissionEnergies: {
          beta: ['1.16 MeV (max)'],
          alpha: ['5.03 MeV'],
          gamma: []
        },
        avgBetaEnergy: '0.387 MeV',
        halfLife: '5.012 days',
        decayConstant: '0.138 day⁻¹',
        specificActivity: '9.6 x 10^15 Bq/g',
        parent: 'Lead-210',
        daughter: 'Polonium-210 (β-) or Thallium-206 (α)',
        commonUses: ['Intermediate in U-238 decay chain', 'Used in disequilibrium studies with Pb-210'],
        category: 'Natural',
        decaySeriesId: 'U-238-series',
        commonality: 'Moderate',
        commonalityReason: 'A key intermediate in the U-238 decay series, the daughter of the common environmental nuclide Pb-210.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 40,
            inhalation_W: 20,
            ingestion: 100
          },
          DAC: {
            inhalation_D: 2e-8,
            inhalation_W: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bismuth-211',
        emissionType: ['Alpha', 'Beta-minus', 'Gamma'],
        symbol: 'Bi-211',
        emissionEnergies: {
          alpha: ['6.623 MeV'],
          beta: ['0.579 MeV (max)'],
          gamma: ['0.351 MeV']
        },
        avgBetaEnergy: '0.193 MeV',
        halfLife: '2.14 minutes',
        decayConstant: '0.324 min⁻¹',
        specificActivity: '3.4 x 10^18 Bq/g',
        parent: 'Lead-211',
        daughter: 'Thallium-207 (α) or Polonium-211 (β-)',
        commonUses: ['Intermediate in Actinium-227 decay series'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bismuth-212',
        emissionType: ['Beta-minus', 'Alpha', 'Gamma'],
        symbol: 'Bi-212',
        emissionEnergies: {
          beta: ['2.25 MeV (max)'],
          alpha: ['6.09 MeV'],
          gamma: ['0.727 MeV', '1.621 MeV']
        },
        avgBetaEnergy: '0.750 MeV',
        halfLife: '60.55 minutes',
        decayConstant: '0.0114 min⁻¹',
        specificActivity: '1.2 x 10^17 Bq/g',
        parent: 'Lead-212',
        daughter: 'Polonium-212 (β-) or Thallium-208 (α)',
        commonUses: ['Research in targeted alpha/beta therapy'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A short-lived nuclide in the Th-232 decay series, notable for its high-energy gamma daughter (Tl-208).',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 90,
            ingestion: 70
          },
          DAC: {
            inhalation_D: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bismuth-213',
        emissionType: ['Beta-minus', 'Alpha', 'Gamma'],
        symbol: 'Bi-213',
        emissionEnergies: {
          beta: ['1.42 MeV (max)'],
          alpha: ['5.87 MeV'],
          gamma: ['0.440 MeV']
        },
        avgBetaEnergy: '0.473 MeV',
        halfLife: '45.6 minutes',
        decayConstant: '0.0152 min⁻¹',
        specificActivity: '1.09 x 10^17 Bq/g',
        parent: 'Actinium-225',
        daughter: 'Polonium-213 (β) or Thallium-209 (α)',
        commonUses: ['Targeted Alpha Therapy (TAT) for various cancers.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A short-lived daughter of Ac-225, used in targeted alpha therapy research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.8,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 800,
            ingestion: 600
          },
          DAC: {
            inhalation_D: 4e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bismuth-214',
        emissionType: ['Beta-minus', 'Alpha', 'Gamma'],
        symbol: 'Bi-214',
        emissionEnergies: {
          beta: ['3.27 MeV (max)'],
          gamma: ['0.609 MeV', '1.120 MeV', '1.764 MeV'],
          alpha: ['5.62 MeV']
        },
        avgBetaEnergy: '1.090 MeV',
        halfLife: '19.9 minutes',
        decayConstant: '0.0348 min⁻¹',
        specificActivity: '3.6 x 10^17 Bq/g',
        parent: 'Lead-214',
        daughter: 'Polonium-214 (β-) / Thallium-210 (α)',
        commonUses: ['Source of natural background gamma radiation (from Radon decay products)'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A prominent gamma-emitter in the Radon-222 decay chain, contributing to natural background radiation.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 400,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 2e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bromine-77',
        symbol: 'Br-77',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.239 MeV', '0.297 MeV'],
          alpha: []
        },
        halfLife: '57.04 hours',
        decayConstant: '0.0121 hour⁻¹',
        specificActivity: '1.2 x 10^16 Bq/g',
        parent: 'Krypton-77',
        daughter: 'Selenium-77 (stable)',
        commonUses: ['PET imaging research', 'Antibody labeling'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used for specialized medical research applications like antibody labeling.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 3,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2000,
            ingestion: 1000
          },
          DAC: {
            inhalation_D: 8e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Bromine-82',
        symbol: 'Br-82',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.444 MeV (max)'],
          gamma: ['0.777 MeV', '1.044 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.148 MeV',
        halfLife: '35.3 hours',
        decayConstant: '0.0196 hour⁻¹',
        specificActivity: '1.6 x 10^16 Bq/g',
        parent: 'Selenium-82',
        daughter: 'Krypton-82 (stable)',
        commonUses: ['Hydrological tracing', 'Flow measurements in pipelines', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A gamma-emitting tracer used for specialized industrial and hydrological studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.4,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Cadmium-109',
        symbol: 'Cd-109',
        emissionType: ['Electron Capture', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.088 MeV (γ)'],
          alpha: []
        },
        halfLife: '461.4 days',
        decayConstant: '0.00150 day⁻¹',
        specificActivity: '1.2 x 10^14 Bq/g',
        parent: 'Indium-109',
        daughter: 'Silver-109 (stable)',
        commonUses: ['X-ray fluorescence', 'Calibration source'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A common source for X-ray fluorescence (XRF) analyzers and instrument calibration.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 40,
            inhalation_Y: 3,
            ingestion: 100
          },
          DAC: {
            inhalation_W: 2e-8,
            inhalation_Y: 1e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Cadmium-115m',
        symbol: 'Cd-115m',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.62 MeV (max)'],
          gamma: ['0.934 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.540 MeV',
        halfLife: '44.6 days',
        decayConstant: '0.0155 day⁻¹',
        specificActivity: '1.3 x 10^15 Bq/g',
        parent: 'Silver-115',
        daughter: 'Indium-115',
        commonUses: ['Fission product', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fission product with limited use outside of specific research applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.7,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 70,
            inhalation_W: 100,
            inhalation_Y: 20,
            ingestion: 60
          },
          DAC: {
            inhalation_D: 3e-8,
            inhalation_W: 4e-8,
            inhalation_Y: 9e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Calcium-45',
        symbol: 'Ca-45',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.257 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.086 MeV',
        halfLife: '162.6 days',
        decayConstant: '0.00426 day⁻¹',
        specificActivity: '6.4 x 10^14 Bq/g',
        parent: 'Potassium-45',
        daughter: 'Scandium-45 (stable)',
        commonUses: ['Bone metabolism studies', 'Agricultural research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A pure beta-emitter used as a tracer in specialized biological and agricultural research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 900,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 4e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Calcium-47',
        symbol: 'Ca-47',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.694 MeV (max)'],
          gamma: ['1.297 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.231 MeV',
        daughterEmissions: {
          from: 'Sc-47',
          beta: ['0.601 MeV (max)'],
          gamma: ['0.159 MeV']
        },
        halfLife: '4.536 days',
        decayConstant: '0.153 day⁻¹',
        specificActivity: '2.07 x 10^16 Bq/g',
        parent: 'Potassium-47',
        daughter: 'Scandium-47',
        commonUses: ['Bone metabolism research (historical)', 'Medical studies'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Largely replaced by other isotopes for medical studies, now used only in limited research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            ingestion: 300
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Californium-252',
        symbol: 'Cf-252',
        emissionType: ['Alpha', 'Spontaneous Fission', 'Neutron', 'Gamma'],
        emissionEnergies: {
          alpha: ['6.118 MeV'],
          beta: [],
          gamma: ['~0.1-6 MeV (complex spectrum from fission)']
        },
        halfLife: '2.645 years',
        decayConstant: '0.262 year⁻¹',
        specificActivity: '2.0 x 10^13 Bq/g',
        parent: 'Curium-252',
        daughter: 'Curium-248 (α), Fission products',
        commonUses: ['Neutron source (neutron activation analysis)', 'Tumor treatment', 'Reactor startup', 'Well logging'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A powerful and widely used spontaneous fission neutron source for various industrial and medical applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.2,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.05,
            inhalation_Y: 0.02,
            ingestion: 0.2
          },
          DAC: {
            inhalation_W: 2e-11,
            inhalation_Y: 1e-11
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Carbon-11',
        symbol: 'C-11',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['0.960 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.320 MeV',
        halfLife: '20.36 minutes',
        decayConstant: '0.0340 min⁻¹',
        specificActivity: '1.9 x 10^18 Bq/g',
        parent: 'Boron-11 (p,n)',
        daughter: 'Boron-11 (stable)',
        commonUses: ['PET imaging for various tracers (e.g., methionine for tumors)'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 90000,
            ingestion: 60000
          },
          DAC: {
            inhalation_D: 4e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Carbon-14',
        symbol: 'C-14',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.156 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.052 MeV',
        halfLife: '5730 years',
        decayConstant: '1.21 x 10⁻⁴ year⁻¹',
        specificActivity: '1.65 x 10^11 Bq/g',
        parent: 'Nitrogen-14 (n,p)',
        daughter: 'Nitrogen-14 (stable)',
        commonUses: ['Radiometric dating (archeology, geology)', 'Tracers in biological and chemical research', 'Labeled compounds'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'Famously used for radiocarbon dating and as a tracer in countless biological and chemical research labs.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2000,
            ingestion: 2000
          },
          DAC: {
            inhalation_D: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_low_risk'
      },
      {
        name: 'Cerium-141',
        symbol: 'Ce-141',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.581 MeV (max)'],
          gamma: ['0.145 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.194 MeV',
        halfLife: '32.5 days',
        decayConstant: '0.0213 day⁻¹',
        specificActivity: '1.09 x 10^15 Bq/g',
        parent: 'Lanthanum-141',
        daughter: 'Praseodymium-141 (stable)',
        commonUses: ['Fission product', 'Medical research (historical)', 'Environmental tracer'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fission product with limited use outside of specialized research applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 300,
            inhalation_Y: 20,
            ingestion: 600
          },
          DAC: {
            inhalation_W: 1e-7,
            inhalation_Y: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Cerium-144',
        symbol: 'Ce-144',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.319 MeV (max)'],
          gamma: ['0.133 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.106 MeV',
        daughterEmissions: {
          from: 'Pr-144',
          beta: ['2.997 MeV (max)']
        },
        halfLife: '284.9 days',
        decayConstant: '0.00243 day⁻¹',
        specificActivity: '1.18 x 10^14 Bq/g',
        parent: 'Lanthanum-144',
        daughter: 'Praseodymium-144 (β-)',
        commonUses: ['Fission product', 'Environmental tracer'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fission product with limited use outside of specialized research applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 40,
            inhalation_Y: 20,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 2e-8,
            inhalation_Y: 8e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Cesium-134',
        symbol: 'Cs-134',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.658 MeV (max)'],
          gamma: ['0.605 MeV', '0.796 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.219 MeV',
        halfLife: '2.065 years',
        decayConstant: '0.335 year⁻¹',
        specificActivity: '4.8 x 10^13 Bq/g',
        parent: 'Cesium-133 (n,γ)',
        daughter: 'Barium-134 (stable)',
        commonUses: ['Environmental tracer (fallout)', 'Calibration sources'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'An activation product often seen alongside Cs-137 after reactor incidents, used as a tracer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.7,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 70,
            ingestion: 100
          },
          DAC: {
            inhalation_D: 3e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Cesium-137',
        symbol: 'Cs-137',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.512 MeV (max)', '1.174 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.171 MeV',
        daughterEmissions: {
          from: 'Ba-137m',
          gamma: ['0.662 MeV']
        },
        halfLife: '30.08 years',
        decayConstant: '0.0230 year⁻¹',
        gammaConstant: '0.33 R·m²/hr·Ci',
        specificActivity: '3.21 x 10^12 Bq/g',
        parent: 'Uranium Fission',
        daughter: 'Barium-137m (IT) -> Barium-137 (stable)',
        commonUses: ['Calibration sources', 'Industrial gauges (density, level)', 'Blood irradiators', 'Radiotherapy (historical)'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'A major fission product and one of the most common gamma sources for industrial gauging and calibration.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 2,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 100,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 6e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Cobalt-60',
        symbol: 'Co-60',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.318 MeV (max)'],
          gamma: ['1.173 MeV', '1.332 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.106 MeV',
        halfLife: '5.27 years',
        decayConstant: '0.131 year⁻¹',
        gammaConstant: '1.32 R·m²/hr·Ci',
        specificActivity: '4.18 x 10^13 Bq/g',
        parent: 'Cobalt-59 (n,γ)',
        daughter: 'Nickel-60 (stable)',
        commonUses: ['Industrial radiography', 'Sterilization of medical equipment and food', 'Radiotherapy (external beam)', 'Tracers'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'Widely used for industrial radiography, medical equipment sterilization, and cancer therapy.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 0.4,
          A2: 0.4,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 40,
            inhalation_Y: 10,
            ingestion: 700
          },
          DAC: {
            inhalation_W: 2e-8,
            inhalation_Y: 6e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Copper-64',
        symbol: 'Cu-64',
        emissionType: ['Positron Emission', 'Beta-minus', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['0.653 MeV (β+ max)', '0.579 MeV (β- max)'],
          gamma: ['1.345 MeV', '0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.193 MeV (β-)',
        halfLife: '12.7 hours',
        decayConstant: '0.0546 hour⁻¹',
        specificActivity: '1.74 x 10^17 Bq/g',
        parent: 'Nickel-64 (p,n)',
        daughter: 'Nickel-64 (stable) or Zinc-64 (stable)',
        commonUses: ['PET imaging (various applications)', 'Targeted radionuclide therapy research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A versatile medical isotope for PET imaging and therapy research, but not as widespread as F-18.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 5,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 900,
            inhalation_W: 300,
            ingestion: 2000
          },
          DAC: {
            inhalation_D: 4e-7,
            inhalation_W: 2e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Copper-67',
        symbol: 'Cu-67',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.576 MeV (max)'],
          gamma: ['0.185 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.192 MeV',
        halfLife: '61.83 hours',
        decayConstant: '0.0112 hour⁻¹',
        specificActivity: '1.2 x 10^16 Bq/g',
        parent: 'Zinc-67 (n,p)',
        daughter: 'Zinc-67 (stable)',
        commonUses: ['Radioimmunotherapy, theranostic partner for Copper-64 PET imaging.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A research isotope for targeted therapy, valued as a "theranostic" partner to the PET isotope Cu-64.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 900,
            inhalation_W: 1000,
            ingestion: 1000
          },
          DAC: {
            inhalation_D: 4e-7,
            inhalation_W: 5e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Curium-244',
        symbol: 'Cm-244',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.805 MeV'],
          gamma: ['0.043 MeV'],
          beta: []
        },
        halfLife: '18.1 years',
        decayConstant: '0.0383 year⁻¹',
        specificActivity: '3.0 x 10^12 Bq/g',
        parent: 'Americium-244 (β-)',
        daughter: 'Plutonium-240',
        commonUses: ['Alpha particle X-ray spectrometers (APXS) for space exploration', 'Neutron sources'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'Used in specialized applications like space exploration instruments due to its alpha emissions.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 0.002,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.2,
            inhalation_Y: 0.3,
            ingestion: 3
          },
          DAC: {
            inhalation_W: 1e-10,
            inhalation_Y: 1e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Erbium-169',
        symbol: 'Er-169',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.341 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.114 MeV',
        halfLife: '9.4 days',
        decayConstant: '0.0737 day⁻¹',
        specificActivity: '5.2 x 10^14 Bq/g',
        parent: 'Erbium-168 (n,γ)',
        daughter: 'Thulium-169 (stable)',
        commonUses: ['Radiation synovectomy for arthritis treatment.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used for a specific medical therapy (radiation synovectomy) that is not widely performed.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 3000,
            ingestion: 1000
          },
          DAC: {
            inhalation_W: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Europium-152',
        symbol: 'Eu-152',
        emissionType: ['Beta-minus', 'Electron Capture', 'Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['1.48 MeV (max)'],
          gamma: ['0.122 MeV', '1.408 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.493 MeV',
        halfLife: '13.54 years',
        decayConstant: '0.0512 year⁻¹',
        specificActivity: '6.4 x 10^12 Bq/g',
        parent: 'Samarium-152 (n,γ)',
        daughter: 'Samarium-152 (stable) or Gadolinium-152 (stable)',
        commonUses: ['Calibration sources for gamma spectroscopy', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived, multi-gamma emitting source excellent for calibration, but less common than Co-60 or Ba-133.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        gammaConstant: '0.744 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 30,
            inhalation_Y: 2,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 1e-8,
            inhalation_Y: 7e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Europium-154',
        symbol: 'Eu-154',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.85 MeV (max)'],
          gamma: ['1.274 MeV', '0.723 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.617 MeV',
        halfLife: '8.59 years',
        decayConstant: '0.0807 year⁻¹',
        specificActivity: '9.8 x 10^12 Bq/g',
        parent: 'Samarium-154 (n,γ)',
        daughter: 'Gadolinium-154 (stable)',
        commonUses: ['Environmental monitoring (fission product)', 'Calibration sources'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived fission product sometimes used for gamma calibration.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.9,
          A2: 0.6,
          unit: 'TBq'
        },
        gammaConstant: '0.756 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 30,
            inhalation_Y: 2,
            ingestion: 100
          },
          DAC: {
            inhalation_W: 1e-8,
            inhalation_Y: 9e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Fluorine-18',
        symbol: 'F-18',
        emissionType: ['Positron Emission'],
        emissionEnergies: {
          beta: ['0.6335 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.211 MeV',
        halfLife: '109.7 minutes',
        decayConstant: '0.00632 min⁻¹',
        specificActivity: '3.5 x 10^18 Bq/g',
        parent: 'Oxygen-18 (p,n)',
        daughter: 'Oxygen-18 (stable)',
        commonUses: ['PET imaging (Positron Emission Tomography)', 'Most common PET radioisotope, particularly for FDG (Fluorodeoxyglucose) scans'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'The most widely used radioisotope for PET scans, especially when labeled to FDG for cancer imaging.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20000,
            ingestion: 30000
          },
          DAC: {
            inhalation_D: 1e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Fluorine-19',
        symbol: 'F-19',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Stable',
        daughter: 'Stable',
        commonUses: ['NMR', 'Fluorinated compounds (not a radionuclide use)'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Gadolinium-153',
        symbol: 'Gd-153',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.097 MeV', '0.103 MeV'],
          alpha: []
        },
        halfLife: '240.4 days',
        decayConstant: '0.00288 day⁻¹',
        specificActivity: '1.3 x 10^14 Bq/g',
        parent: 'Europium-153 (n,γ)',
        daughter: 'Europium-153 (stable)',
        commonUses: ['Bone densitometry', 'X-ray absorption measurements', 'Calibration sources'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A key source used in dual-photon absorptiometry for bone density scanning.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 9,
          unit: 'TBq'
        },
        gammaConstant: '0.11 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_Y: 9,
            ingestion: 900
          },
          DAC: {
            inhalation_Y: 4e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Gadolinium-159',
        symbol: 'Gd-159',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.970 MeV (max)'],
          gamma: ['0.363 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.323 MeV',
        halfLife: '18.48 hours',
        decayConstant: '0.0375 hour⁻¹',
        specificActivity: '3.6 x 10^16 Bq/g',
        parent: 'Europium-159',
        daughter: 'Terbium-159 (stable)',
        commonUses: ['Boron Neutron Capture Therapy (BNCT) research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A short-lived isotope used in specialized medical therapy research (BNCT).',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 300,
            ingestion: 2000
          },
          DAC: {
            inhalation_Y: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Gallium-67',
        symbol: 'Ga-67',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.093 MeV', '0.185 MeV', '0.300 MeV'],
          alpha: []
        },
        halfLife: '3.26 days',
        decayConstant: '0.213 day⁻¹',
        specificActivity: '3.8 x 10^15 Bq/g',
        parent: 'Zinc-67 (p,n)',
        daughter: 'Zinc-67 (stable)',
        commonUses: ['Tumor imaging (lymphomas, lung cancer)', 'Infection imaging', 'Inflammation imaging'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A standard SPECT imaging agent for detecting tumors and inflammation.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 7,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 800,
            ingestion: 400
          },
          DAC: {
            inhalation_W: 4e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Gallium-68',
        symbol: 'Ga-68',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['1.90 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.633 MeV',
        halfLife: '67.71 minutes',
        decayConstant: '0.0102 min⁻¹',
        specificActivity: '1.45 x 10^17 Bq/g',
        parent: 'Germanium-68',
        daughter: 'Zinc-68 (stable)',
        commonUses: ['PET imaging, especially with DOTATATE/DOTATOC for neuroendocrine tumors'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'A major PET imaging isotope, especially for neuroendocrine tumors, often produced from a Ge-68 generator.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 1000,
            ingestion: 400
          },
          DAC: {
            inhalation_W: 6e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Germanium-68',
        symbol: 'Ge-68',
        emissionType: ['Electron Capture', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        daughterEmissions: {
          from: 'Ga-68',
          beta: ['1.90 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)']
        },
        halfLife: '270.95 days',
        decayConstant: '0.00256 day⁻¹',
        specificActivity: '2.8 x 10^14 Bq/g',
        parent: 'Arsenic-68',
        daughter: 'Gallium-68 (EC, β+)',
        commonUses: ['Generator for Ga-68 (PET imaging)'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'The long-lived parent used in generators to produce the short-lived PET isotope Ga-68.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            ingestion: 2000
          },
          DAC: {
            inhalation_D: 7e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Gold-195m',
        symbol: 'Au-195m',
        emissionType: ['Isomeric Transition', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.262 MeV'],
          alpha: []
        },
        halfLife: '30.5 seconds',
        decayConstant: '0.0227 s⁻¹',
        specificActivity: '1.5 x 10^18 Bq/g',
        parent: 'Mercury-195m',
        daughter: 'Gold-195',
        commonUses: ['Cardiac blood flow imaging (historical)'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used historically in medicine but has been replaced by other isotopes.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 10,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 10000,
            ingestion: 10000
          },
          DAC: {
            inhalation_D: 6e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Gold-198',
        symbol: 'Au-198',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.961 MeV (max)'],
          gamma: ['0.412 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.320 MeV',
        halfLife: '2.695 days',
        decayConstant: '0.257 day⁻¹',
        specificActivity: '9.3 x 10^15 Bq/g',
        parent: 'Gold-197 (n,γ)',
        daughter: 'Mercury-198 (stable)',
        commonUses: ['Radiotherapy (brachytherapy)', 'Tracers', 'Industrial applications'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'Used in specific brachytherapy applications and as an industrial tracer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        gammaConstant: '0.23 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 200,
            inhalation_Y: 20,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 9e-8,
            inhalation_Y: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Holmium-166',
        symbol: 'Ho-166',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.854 MeV (max)'],
          gamma: ['0.080 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.618 MeV',
        halfLife: '26.8 hours',
        decayConstant: '0.0258 hour⁻¹',
        specificActivity: '2.5 x 10^16 Bq/g',
        parent: 'Holmium-165 (n,γ)',
        daughter: 'Erbium-166 (stable)',
        commonUses: ['Radiotherapy for liver tumors, bone pain palliation, radiosynovectomy.'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A therapeutic isotope used for treating liver tumors and for bone pain palliation.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 40,
            ingestion: 700
          },
          DAC: {
            inhalation_W: 2e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Indium-111',
        symbol: 'In-111',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.171 MeV', '0.245 MeV'],
          alpha: []
        },
        halfLife: '2.80 days',
        decayConstant: '0.247 day⁻¹',
        specificActivity: '2.6 x 10^16 Bq/g',
        parent: 'Cadmium-111 (p,n)',
        daughter: 'Cadmium-111 (stable)',
        commonUses: ['White blood cell labeling (infection imaging)', 'Tumor imaging', 'CSF flow studies'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A standard SPECT imaging agent, particularly for labeling white blood cells to find infections.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 3,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 300,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Indium-113m',
        symbol: 'In-113m',
        emissionType: ['Isomeric Transition', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.392 MeV'],
          alpha: []
        },
        halfLife: '1.658 hours',
        decayConstant: '0.418 hour⁻¹',
        specificActivity: '4.1 x 10^17 Bq/g',
        parent: 'Tin-113',
        daughter: 'Indium-113 (stable)',
        commonUses: ['Medical diagnostic imaging (historical)'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used historically in medicine but has been replaced by other isotopes like Tc-99m.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 4,
          A2: 2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 9000,
            ingestion: 4000
          },
          DAC: {
            inhalation_D: 4e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Indium-115',
        symbol: 'In-115',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.499 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.166 MeV',
        halfLife: '4.41 x 10¹⁴ years',
        decayConstant: '1.57 x 10⁻¹⁵ year⁻¹',
        specificActivity: '2.6 x 10^2 Bq/g',
        parent: 'Primordial',
        daughter: 'Tin-115 (stable)',
        commonUses: ['Neutrino mass experiments', 'Research (extremely weak activity)'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A primordial isotope with an extremely long half-life, used in fundamental physics research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 1,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iodine-123',
        symbol: 'I-123',
        emissionType: ['Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.159 MeV'],
          alpha: []
        },
        halfLife: '13.22 hours',
        decayConstant: '0.0524 hour⁻¹',
        specificActivity: '7.4 x 10^16 Bq/g',
        parent: 'Xenon-123',
        daughter: 'Tellurium-123 (stable)',
        commonUses: ['SPECT imaging for thyroid function and tumors', 'Cardiac and neurological imaging'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'An ideal isotope for thyroid imaging (SPECT) due to its short half-life and clean gamma emission.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 6,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2000,
            ingestion: 1000
          },
          DAC: {
            inhalation_D: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iodine-125',
        symbol: 'I-125',
        emissionType: ['Electron Capture', 'X-ray', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.0355 MeV'],
          alpha: []
        },
        halfLife: '59.4 days',
        decayConstant: '0.0117 day⁻¹',
        specificActivity: '6.4 x 10^14 Bq/g',
        parent: 'Xenon-125',
        daughter: 'Tellurium-125 (stable)',
        commonUses: ['Brachytherapy (prostate cancer)', 'Radioimmunoassay', 'Bone mineral density (historical)'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'Widely used in permanent brachytherapy seeds for prostate cancer and in laboratory radioimmunoassays.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 20,
          A2: 3,
          unit: 'TBq'
        },
        gammaConstant: '0.07 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_D: 4,
            ingestion: 2
          },
          DAC: {
            inhalation_D: 2e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iodine-129',
        symbol: 'I-129',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.154 MeV (max)'],
          gamma: ['0.039 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.051 MeV',
        halfLife: '16.1 million years',
        decayConstant: '4.31 x 10⁻⁸ year⁻¹',
        specificActivity: '6.54 x 10^6 Bq/g',
        parent: 'Tellurium-129 (β-)',
        daughter: 'Xenon-129 (stable)',
        commonUses: ['Environmental tracer (long-lived fission product)', 'Geological dating'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'An extremely long-lived fission product used as a tracer in environmental and geological studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 4,
            ingestion: 2
          },
          DAC: {
            inhalation_D: 2e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iodine-131',
        symbol: 'I-131',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.606 MeV (max)'],
          gamma: ['0.364 MeV (dominant)'],
          alpha: []
        },
        avgBetaEnergy: '0.202 MeV',
        halfLife: '8.02 days',
        decayConstant: '0.0864 day⁻¹',
        gammaConstant: '0.22 R·m²/hr·Ci',
        specificActivity: '4.6 x 10^15 Bq/g',
        parent: 'Tellurium-131',
        daughter: 'Xenon-131 (stable)',
        commonUses: ['Diagnosis and treatment of thyroid cancer and hyperthyroidism', 'Medical imaging (diagnostic tracer)'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'A key radioisotope for the diagnosis and, at higher activities, the treatment of thyroid conditions.',
        sourceRef: {
          halfLife: 'nndc',
          decayConstant: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 3,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2,
            ingestion: 1
          },
          DAC: {
            inhalation_D: 1e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iridium-192',
        symbol: 'Ir-192',
        emissionType: ['Beta-minus', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['0.672 MeV (max)'],
          gamma: ['0.317 MeV', '0.468 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.224 MeV',
        halfLife: '73.83 days',
        decayConstant: '0.00939 day⁻¹',
        gammaConstant: '0.48 R·m²/hr·Ci',
        specificActivity: '3.41 x 10^14 Bq/g',
        parent: 'Iridium-191 (n,γ)',
        daughter: 'Platinum-192 (stable) / Osmium-192 (stable)',
        commonUses: ['High-dose-rate (HDR) brachytherapy', 'Industrial gamma radiography'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A primary source for industrial radiography and high-dose-rate (HDR) brachytherapy cancer treatment.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 1,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 8,
            ingestion: 60
          },
          DAC: {
            inhalation_Y: 4e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iron-52',
        symbol: 'Fe-52',
        emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['0.804 MeV (max)'],
          gamma: ['0.169 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.268 MeV',
        halfLife: '8.275 hours',
        decayConstant: '0.0838 hour⁻¹',
        specificActivity: '1.2 x 10^17 Bq/g',
        parent: 'Manganese-52m',
        daughter: 'Manganese-52',
        commonUses: ['PET imaging research (bone marrow imaging, iron metabolism)'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A short-lived PET isotope used in specialized research to study iron metabolism and bone marrow.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 400,
            inhalation_W: 200,
            ingestion: 500
          },
          DAC: {
            inhalation_D: 2e-7,
            inhalation_W: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iron-55',
        symbol: 'Fe-55',
        emissionType: ['Electron Capture', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.0059 MeV (X-ray)'],
          alpha: []
        },
        halfLife: '2.73 years',
        decayConstant: '0.254 year⁻¹',
        specificActivity: '8.4 x 10^13 Bq/g',
        parent: 'Manganese-55 (p,n)',
        daughter: 'Manganese-55 (stable)',
        commonUses: ['X-ray fluorescence sources', 'Electron capture detectors', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'Used as a low-energy X-ray source for analytical techniques like X-ray fluorescence.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 1000,
            ingestion: 800
          },
          DAC: {
            inhalation_W: 5e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Iron-59',
        symbol: 'Fe-59',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.475 MeV (max)'],
          gamma: ['1.099 MeV', '1.292 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.158 MeV',
        halfLife: '44.5 days',
        decayConstant: '0.0156 day⁻¹',
        specificActivity: '1.87 x 10^15 Bq/g',
        parent: 'Iron-58 (n,γ)',
        daughter: 'Cobalt-59 (stable)',
        commonUses: ['Red blood cell studies', 'Iron metabolism research', 'Industrial tracers'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A gamma-emitting tracer used in medical research to study iron metabolism and red blood cells.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.9,
          A2: 0.9,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 90,
            ingestion: 80
          },
          DAC: {
            inhalation_W: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Krypton-79',
        symbol: 'Kr-79',
        emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['0.604 MeV (max)'],
          gamma: ['0.261 MeV', '0.398 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.201 MeV',
        halfLife: '35.04 hours',
        decayConstant: '0.0198 hour⁻¹',
        specificActivity: '1.7 x 10^16 Bq/g',
        parent: 'Bromine-79',
        daughter: 'Bromine-79 (stable)',
        commonUses: ['Lung ventilation studies (PET)', 'Research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used in medical research, particularly for PET-based lung ventilation studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20000,
            ingestion: 20000
          },
          DAC: {
            inhalation_D: 9e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Krypton-81m',
        symbol: 'Kr-81m',
        emissionType: ['Gamma', 'Isomeric Transition'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.190 MeV'],
          alpha: []
        },
        halfLife: '13.1 seconds',
        decayConstant: '0.0529 s⁻¹',
        specificActivity: '4.85 x 10^18 Bq/g',
        parent: 'Rubidium-81',
        daughter: 'Krypton-81',
        commonUses: ['Lung ventilation studies (very short half-life allows for repeated scans)'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'A very short-lived gas used for lung ventilation scans, typically produced from a Rb-81 generator.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 500000,
            ingestion: 500000
          },
          DAC: {
            inhalation_D: 2e-4
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Krypton-85',
        symbol: 'Kr-85',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.687 MeV (max)'],
          gamma: ['0.514 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.229 MeV',
        halfLife: '10.76 years',
        decayConstant: '0.0644 year⁻¹',
        specificActivity: '1.45 x 10^13 Bq/g',
        parent: 'Uranium Fission',
        daughter: 'Rubidium-85 (stable)',
        commonUses: ['Atmospheric tracer', 'Industrial applications (leak detection, gauging)'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A fission product gas used in industrial applications like leak detection and thickness gauging.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 10,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 40000
          },
          DAC: {
            inhalation_D: 1e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lanthanum-140',
        symbol: 'La-140',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.68 MeV (max)'],
          gamma: ['1.596 MeV', '0.816 MeV', '0.487 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.560 MeV',
        halfLife: '1.678 days',
        decayConstant: '0.413 day⁻¹',
        specificActivity: '2.07 x 10^16 Bq/g',
        parent: 'Barium-140',
        daughter: 'Cerium-140 (stable)',
        commonUses: ['Fission product', 'Research tracer'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A short-lived fission product used as a tracer in research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.7,
          A2: 0.4,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 50,
            ingestion: 100
          },
          DAC: {
            inhalation_W: 2e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lead-206',
        symbol: 'Pb-206',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Polonium-210',
        daughter: 'Stable',
        commonUses: ['Final stable product of U-238 decay series', 'Geological dating'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Lead-207',
        symbol: 'Pb-207',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Polonium-211',
        daughter: 'Stable',
        commonUses: ['Final stable product of U-235 decay series', 'Geological dating'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Lead-208',
        symbol: 'Pb-208',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Thallium-208',
        daughter: 'Stable',
        commonUses: ['Final stable product of Th-232 decay series', 'Geological dating'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Lead-210',
        symbol: 'Pb-210',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.063 MeV (max)'],
          gamma: ['0.0465 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.021 MeV',
        daughterEmissions: {
          from: 'Bi-210',
          beta: ['1.16 MeV (max)']
        },
        halfLife: '22.23 years',
        decayConstant: '0.0312 year⁻¹',
        specificActivity: '2.8 x 10^12 Bq/g',
        parent: 'Polonium-214 (α)',
        daughter: 'Bismuth-210 (β-)',
        commonUses: ['Environmental tracers', 'Dating sediments and ice cores', 'Bone dosimetry'],
        category: 'Natural',
        commonality: 'Common',
        commonalityReason: 'A naturally occurring radionuclide from the U-238 series, widely used for dating recent sediments and ice cores.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.05,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 0.4,
            ingestion: 0.7
          },
          DAC: {
            inhalation_D: 2e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lead-211',
        emissionType: ['Beta-minus', 'Gamma'],
        symbol: 'Pb-211',
        emissionEnergies: {
          beta: ['1.36 MeV (max)'],
          gamma: ['0.405 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.453 MeV',
        halfLife: '36.1 minutes',
        decayConstant: '0.0192 min⁻¹',
        specificActivity: '2.0 x 10^17 Bq/g',
        parent: 'Polonium-215',
        daughter: 'Bismuth-211 (β-)',
        commonUses: ['Intermediate in Actinium-227 decay series'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 3000,
            ingestion: 800
          },
          DAC: {
            inhalation_D: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lead-212',
        symbol: 'Pb-212',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.570 MeV (max)'],
          gamma: ['0.238 MeV', '0.300 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.190 MeV',
        daughterEmissions: {
          from: 'Bi-212',
          beta: ['2.25 MeV (max)'],
          alpha: ['6.09 MeV'],
          gamma: ['0.727 MeV', '1.621 MeV']
        },
        halfLife: '10.64 hours',
        decayConstant: '0.0651 hour⁻¹',
        specificActivity: '6.9 x 10^16 Bq/g',
        parent: 'Polonium-216 (α)',
        daughter: 'Bismuth-212 (β-)',
        commonUses: ['Intermediate in Thorium-232 decay series', 'Research'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A key intermediate in the Th-232 decay chain with a relatively long half-life compared to its daughters.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 90,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lead-214',
        symbol: 'Pb-214',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.02 MeV (max)'],
          gamma: ['0.295 MeV', '0.352 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.340 MeV',
        halfLife: '26.8 minutes',
        decayConstant: '0.0259 min⁻¹',
        specificActivity: '2.7 x 10^17 Bq/g',
        parent: 'Polonium-218 (α)',
        daughter: 'Bismuth-214 (β-)',
        commonUses: ['Intermediate in Radon-222 decay chain', 'Environmental monitoring'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A prominent gamma-emitter in the Radon-222 decay chain, contributing to natural background radiation.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2000,
            ingestion: 700
          },
          DAC: {
            inhalation_D: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lutetium-176',
        symbol: 'Lu-176',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.593 MeV (max)'],
          gamma: ['0.202 MeV', '0.307 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.198 MeV',
        halfLife: '3.78 x 10¹⁰ years',
        decayConstant: '1.83 x 10⁻¹¹ year⁻¹',
        specificActivity: '2.0 x 10^6 Bq/g',
        parent: 'Primordial',
        daughter: 'Hafnium-176 (stable)',
        commonUses: ['Lutetium-Hafnium dating (geological)', 'Research'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A very long-lived primordial nuclide used for geological dating.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 0.7,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Lutetium-177',
        symbol: 'Lu-177',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.498 MeV (max)'],
          gamma: ['0.113 MeV', '0.208 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.166 MeV',
        halfLife: '6.647 days',
        decayConstant: '0.104 day⁻¹',
        specificActivity: '3.9 x 10^14 Bq/g',
        parent: 'Ytterbium-176 (n,γ)',
        daughter: 'Hafnium-177 (stable)',
        commonUses: ['Peptide receptor radionuclide therapy (PRRT) for neuroendocrine tumors'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A highly effective and increasingly common therapeutic isotope for treating neuroendocrine tumors (PRRT).',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 30,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 3000,
            ingestion: 700
          },
          DAC: {
            inhalation_W: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Manganese-54',
        symbol: 'Mn-54',
        emissionType: ['Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.835 MeV'],
          alpha: []
        },
        halfLife: '312.1 days',
        decayConstant: '0.00222 day⁻¹',
        gammaConstant: '0.47 R·m²/hr·Ci',
        specificActivity: '2.56 x 10^14 Bq/g',
        parent: 'Iron-54 (d,2n)',
        daughter: 'Chromium-54 (stable)',
        commonUses: ['Calibration sources', 'Environmental tracer'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A common activation product used as a calibration source and environmental tracer.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 100,
            inhalation_W: 100,
            ingestion: 400
          },
          DAC: {
            inhalation_D: 5e-8,
            inhalation_W: 6e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Molybdenum-99',
        symbol: 'Mo-99',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.214 MeV (max)'],
          gamma: ['0.739 MeV', '0.181 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.405 MeV',
        daughterEmissions: {
          from: 'Tc-99m',
          gamma: ['0.1405 MeV']
        },
        halfLife: '65.94 hours',
        decayConstant: '0.0105 hour⁻¹',
        specificActivity: '1.77 x 10^16 Bq/g',
        parent: 'Uranium-235 Fission',
        daughter: 'Technetium-99m',
        commonUses: ['Generator for Technetium-99m, the most widely used medical radioisotope.'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'The parent isotope used in generators to produce Tc-99m, making it essential to nuclear medicine.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        gammaConstant: '0.07 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 9e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Neptunium-237',
        symbol: 'Np-237',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.788 MeV'],
          beta: [],
          gamma: ['0.029 MeV', '0.086 MeV']
        },
        halfLife: '2.144 million years',
        decayConstant: '3.23 x 10⁻⁷ year⁻¹',
        specificActivity: '2.6 x 10^7 Bq/g',
        parent: 'Americium-241 (α)',
        daughter: 'Protactinium-233 (α)',
        commonUses: ['Intermediate in Neptunium series decay', 'Nuclear waste studies'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived transuranic isotope that is a major consideration in nuclear waste management.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.002,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.004,
            ingestion: 0.5
          },
          DAC: {
            inhalation_W: 2e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Nickel-56',
        symbol: 'Ni-56',
        emissionType: ['Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.158 MeV', '0.812 MeV'],
          alpha: []
        },
        halfLife: '6.075 days',
        decayConstant: '0.114 day⁻¹',
        specificActivity: '1.38 x 10^16 Bq/g',
        parent: 'Zinc-56',
        daughter: 'Cobalt-56',
        commonUses: ['Supernova studies (astrophysics)', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A short-lived isotope primarily of interest in astrophysical research related to supernovae.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 700,
            ingestion: 900
          },
          DAC: {
            inhalation_W: 3e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Nickel-59',
        symbol: 'Ni-59',
        emissionType: ['Electron Capture', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: '76,000 years',
        decayConstant: '9.12 x 10⁻⁶ year⁻¹',
        specificActivity: '1.03 x 10^9 Bq/g',
        parent: 'Copper-59',
        daughter: 'Cobalt-59 (stable)',
        commonUses: ['Neutron activation product (long-lived)', 'Geological dating (historical)', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A very long-lived activation product relevant in nuclear reactor decommissioning.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 4000,
            ingestion: 2000
          },
          DAC: {
            inhalation_W: 2e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Nickel-63',
        symbol: 'Ni-63',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.0669 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.022 MeV',
        halfLife: '100.1 years',
        decayConstant: '0.00692 year⁻¹',
        specificActivity: '2.14 x 10^12 Bq/g',
        parent: 'Nickel-62 (n,γ)',
        daughter: 'Copper-63 (stable)',
        commonUses: ['Electron capture detectors (gas chromatography)', 'Beta-voltaic batteries'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A long-lived, low-energy beta emitter used in electron capture detectors for gas chromatographs.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 30,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 700,
            ingestion: 800
          },
          DAC: {
            inhalation_W: 3e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_low_risk'
      },
      {
        name: 'Niobium-95',
        symbol: 'Nb-95',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.160 MeV (max)'],
          gamma: ['0.766 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.053 MeV',
        halfLife: '34.99 days',
        decayConstant: '0.0198 day⁻¹',
        specificActivity: '1.6 x 10^15 Bq/g',
        parent: 'Zirconium-95',
        daughter: 'Molybdenum-95 (stable)',
        commonUses: ['Fission product', 'Environmental tracer (daughter of Zr-95)'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fission product usually found in equilibrium with its parent, Zr-95.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 200,
            inhalation_Y: 200,
            ingestion: 300
          },
          DAC: {
            inhalation_W: 1e-7,
            inhalation_Y: 8e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Nitrogen-13',
        symbol: 'N-13',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['1.20 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.400 MeV',
        halfLife: '9.97 minutes',
        decayConstant: '0.0695 min⁻¹',
        specificActivity: '3.7 x 10^18 Bq/g',
        parent: 'Carbon-13 (p,n)',
        daughter: 'Carbon-13 (stable)',
        commonUses: ['Cardiac PET imaging for myocardial perfusion and viability'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 60000,
            ingestion: 50000
          },
          DAC: {
            inhalation_D: 3e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Nitrogen-14',
        symbol: 'N-14',
        emissionType: ['Stable'],
        emissionEnergies: {
          alpha: [],
          beta: [],
          gamma: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        specificActivity: '0 Bq/g',
        parent: 'Carbon-14 (β-)',
        daughter: 'Stable',
        commonUses: ['Most abundant stable isotope of nitrogen', 'NMR spectroscopy', 'Target material for producing Carbon-14'],
        category: 'Stable/Reference',
        commonality: 'Common',
        commonalityReason: 'The most abundant stable isotope of nitrogen and the stable daughter of Carbon-14.',
        sourceRef: {},
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Oxygen-15',
        symbol: 'O-15',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['1.73 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.577 MeV',
        halfLife: '122.2 seconds',
        decayConstant: '0.00567 s⁻¹',
        specificActivity: '3.3 x 10^18 Bq/g',
        parent: 'Nitrogen-15 (p,n)',
        daughter: 'Nitrogen-15 (stable)',
        commonUses: ['Brain blood flow', 'Oxygen metabolism PET imaging'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 60000,
            ingestion: 50000
          },
          DAC: {
            inhalation_D: 3e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Palladium-103',
        symbol: 'Pd-103',
        emissionType: ['Electron Capture', 'X-ray', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: '16.99 days',
        decayConstant: '0.0408 day⁻¹',
        specificActivity: '3.5 x 10^15 Bq/g',
        parent: 'Rhodium-103 (p,n)',
        daughter: 'Rhodium-103 (stable)',
        commonUses: ['Brachytherapy (prostate cancer)'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A key isotope, along with I-125, used in permanent brachytherapy seeds for prostate cancer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 3000,
            ingestion: 3000
          },
          DAC: {
            inhalation_W: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Phosphorus-32',
        symbol: 'P-32',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['1.710 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.570 MeV',
        halfLife: '14.26 days',
        decayConstant: '0.0486 day⁻¹',
        specificActivity: '1.07 x 10^16 Bq/g',
        parent: 'Sulfur-32 (n,p)',
        daughter: 'Sulfur-32 (stable)',
        commonUses: ['Molecular biology (DNA/RNA labeling)', 'Radiotherapy for polycythemia vera', 'Agricultural research'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A high-energy pure beta-emitter widely used in molecular biology labs and for some therapies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 70,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 3e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Plutonium-238',
        symbol: 'Pu-238',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.499 MeV'],
          gamma: ['0.043 MeV'],
          beta: []
        },
        halfLife: '87.7 years',
        decayConstant: '0.00790 year⁻¹',
        specificActivity: '6.34 x 10^11 Bq/g',
        parent: 'Neptunium-237 (n,γ) -> Np-238 (β-)',
        daughter: 'Uranium-234',
        commonUses: ['Radioisotope thermoelectric generators (RTGs) for spacecraft and pacemakers'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'The primary power source for RTGs used in deep space missions and other remote applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.02,
            inhalation_Y: 0.02,
            ingestion: 1
          },
          DAC: {
            inhalation_W: 7e-12,
            inhalation_Y: 8e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Plutonium-239',
        symbol: 'Pu-239',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.157 MeV (dominant)'],
          beta: [],
          gamma: ['0.0516 MeV']
        },
        halfLife: '24,110 years',
        decayConstant: '2.87 x 10⁻⁵ year⁻¹',
        specificActivity: '2.3 x 10^9 Bq/g',
        parent: 'Uranium-238 (n,γ) -> ... -> Np-239 (β-)',
        daughter: 'Uranium-235 (α)',
        commonUses: ['Nuclear weapons', 'Nuclear fuel (MOX fuel)'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A primary fissile material used in nuclear weapons and as a component of MOX fuel.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.006,
            inhalation_Y: 0.006,
            ingestion: 0.8
          },
          DAC: {
            inhalation_W: 3e-12,
            inhalation_Y: 3e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Polonium-208',
        symbol: 'Po-208',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.115 MeV'],
          beta: [],
          gamma: ['0.134 MeV']
        },
        halfLife: '2.898 years',
        decayConstant: '0.239 year⁻¹',
        specificActivity: '1.6 x 10^13 Bq/g',
        parent: 'Bismuth-209 (p,2n)',
        daughter: 'Lead-204 (stable)',
        commonUses: ['Alpha calibration', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A synthetic alpha-emitter used for specialized research and calibration.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.01,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 0.4,
            ingestion: 0.4
          },
          DAC: {
            inhalation_D: 2e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-210',
        symbol: 'Po-210',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['5.304 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '138.376 days',
        decayConstant: '0.00501 day⁻¹',
        specificActivity: '1.66 x 10^14 Bq/g',
        parent: 'Bismuth-210 (β-)',
        daughter: 'Lead-206 (stable)',
        commonUses: ['Antistatic devices', 'Neutron sources', 'Research (alpha spectroscopy)'],
        category: 'Natural',
        commonality: 'Common',
        commonalityReason: 'A naturally occurring alpha-emitter (from Radon decay) used commercially in antistatic devices.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 0.02,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 0.4,
            ingestion: 0.4
          },
          DAC: {
            inhalation_D: 2e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-211',
        symbol: 'Po-211',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['7.45 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '0.516 seconds',
        decayConstant: '1.34 s⁻¹',
        specificActivity: '1.4 x 10^20 Bq/g',
        parent: 'Bismuth-211',
        daughter: 'Lead-207 (stable)',
        commonUses: ['Fastest alpha emitter in natural series', 'Research'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 40,
            ingestion: 40
          },
          DAC: {
            inhalation_D: 2e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-212',
        symbol: 'Po-212',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['8.785 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '0.299 microseconds',
        decayConstant: '2.32 x 10⁶ s⁻¹',
        specificActivity: '2.5 x 10^22 Bq/g',
        parent: 'Bismuth-212 (β-)',
        daughter: 'Lead-208 (stable)',
        commonUses: ['Fastest alpha emitter in natural series', 'Research'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-214',
        symbol: 'Po-214',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['7.687 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '164.3 microseconds',
        decayConstant: '4218 s⁻¹',
        specificActivity: '4.4 x 10^21 Bq/g',
        parent: 'Bismuth-214',
        daughter: 'Lead-210 (α)',
        commonUses: ['Very short-lived intermediate in U-238 decay chain'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-215',
        symbol: 'Po-215',
        emissionType: ['Alpha', 'Beta-minus'],
        emissionEnergies: {
          alpha: ['7.386 MeV'],
          beta: ['0.71 MeV (max)'],
          gamma: []
        },
        avgBetaEnergy: '0.237 MeV',
        halfLife: '1.781 milliseconds',
        decayConstant: '389 s⁻¹',
        specificActivity: '2.5 x 10^21 Bq/g',
        parent: 'Radon-219',
        daughter: 'Lead-211 (α) or Astatine-215 (β-)',
        commonUses: ['Very short-lived intermediate in U-235 decay chain'],
        category: 'Natural',
        decaySeriesId: 'U-235-series',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-216',
        symbol: 'Po-216',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['6.778 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '0.145 seconds',
        decayConstant: '4.78 s⁻¹',
        specificActivity: '1.6 x 10^20 Bq/g',
        parent: 'Radon-220',
        daughter: 'Lead-212 (α)',
        commonUses: ['Very short-lived intermediate in Th-232 chain'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Polonium-218',
        emissionType: ['Alpha', 'Beta-minus'],
        symbol: 'Po-218',
        emissionEnergies: {
          alpha: ['6.002 MeV'],
          beta: ['0.26 MeV (max)']
        },
        avgBetaEnergy: '0.087 MeV',
        halfLife: '3.10 minutes',
        decayConstant: '0.224 min⁻¹',
        specificActivity: '2.3 x 10^18 Bq/g',
        parent: 'Radon-222',
        daughter: 'Lead-214 (α) or Astatine-218 (β-)',
        commonUses: ['Intermediate in U-238 decay chain'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Potassium-40',
        symbol: 'K-40',
        emissionType: ['Beta-minus', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['1.311 MeV (max)'],
          gamma: ['1.461 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.437 MeV',
        halfLife: '1.251 billion years',
        decayConstant: '5.54 x 10⁻¹⁰ year⁻¹',
        specificActivity: '2.6 x 10^5 Bq/g',
        parent: 'Primordial',
        daughter: 'Calcium-40 (β-) or Argon-40 (EC)',
        commonUses: ['Potassium-argon dating', 'Internal human radiation dose', 'Environmental monitoring'],
        category: 'Natural',
        commonality: 'Common',
        commonalityReason: 'A naturally occurring isotope found in soil, food (like bananas), and is a primary source of natural internal radiation dose in humans.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.9,
          A2: 0.9,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 90,
            ingestion: 100
          },
          DAC: {
            inhalation_D: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Praseodymium-144',
        symbol: 'Pr-144',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['2.997 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.999 MeV',
        halfLife: '17.28 minutes',
        decayConstant: '0.0401 min⁻¹',
        specificActivity: '1.96 x 10^17 Bq/g',
        parent: 'Cerium-144',
        daughter: 'Neodymium-144 (stable)',
        commonUses: ['High-energy beta source (daughter of Ce-144)'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A very short-lived daughter of Ce-144, notable for its high-energy beta emission.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 700,
            ingestion: 2000
          },
          DAC: {
            inhalation_W: 3e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Promethium-147',
        symbol: 'Pm-147',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.224 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.075 MeV',
        halfLife: '2.623 years',
        decayConstant: '0.264 year⁻¹',
        specificActivity: '3.4 x 10^13 Bq/g',
        parent: 'Neodymium-147 (β-)',
        daughter: 'Samarium-147',
        commonUses: ['Atomic batteries (historical)', 'Luminous paints', 'Thickness gauges'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fission product used in specialized applications like luminous paints and thickness gauges.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 300,
            inhalation_Y: 200,
            ingestion: 400
          },
          DAC: {
            inhalation_W: 1e-7,
            inhalation_Y: 7e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Protactinium-231',
        symbol: 'Pa-231',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.059 MeV'],
          beta: [],
          gamma: ['0.302 MeV', '0.283 MeV']
        },
        halfLife: '32,760 years',
        decayConstant: '2.11 x 10⁻⁵ year⁻¹',
        specificActivity: '1.75 x 10^9 Bq/g',
        parent: 'Thorium-231 (β-)',
        daughter: 'Actinium-227 (α)',
        commonUses: ['Intermediate in Actinium-227 decay series', 'Geological research'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A long-lived member of the U-235 decay series, used in geological dating.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 4,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.004,
            ingestion: 0.5
          },
          DAC: {
            inhalation_W: 2e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Protactinium-233',
        symbol: 'Pa-233',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.571 MeV (max)'],
          gamma: ['0.312 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.190 MeV',
        halfLife: '27.0 days',
        decayConstant: '0.0257 day⁻¹',
        specificActivity: '7.5 x 10^14 Bq/g',
        parent: 'Thorium-233 (β)',
        daughter: 'Uranium-233',
        commonUses: ['Intermediate in Th-232 to U-233 fuel cycle', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'An important intermediate in the process of breeding U-233 fuel from Thorium-232.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 5,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 200,
            inhalation_Y: 100,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 1e-7,
            inhalation_Y: 6e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Protactinium-234m',
        symbol: 'Pa-234m',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['2.29 MeV (max)'],
          gamma: ['1.001 MeV', '0.766 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.763 MeV',
        halfLife: '1.17 minutes',
        decayConstant: '0.592 min⁻¹',
        specificActivity: '1.7 x 10^19 Bq/g',
        parent: 'Thorium-234',
        daughter: 'Uranium-234 (β-)',
        commonUses: ['Intermediate in U-238 decay chain'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A very short-lived but commonly present intermediate in the U-238 decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.3,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 300,
            ingestion: 300
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Radium-220',
        symbol: 'Ra-220',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['6.818 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '27.4 seconds',
        decayConstant: '0.0253 s⁻¹',
        specificActivity: '1.8 x 10^18 Bq/g',
        parent: 'Thorium-224',
        daughter: 'Radon-216 (α)',
        commonUses: ['Intermediate in Thorium-232 decay series'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Radium-223',
        symbol: 'Ra-223',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.71 MeV (dominant)'],
          beta: [],
          gamma: ['0.269 MeV']
        },
        halfLife: '11.43 days',
        decayConstant: '0.0606 day⁻¹',
        specificActivity: '1.9 x 10^15 Bq/g',
        parent: 'Thorium-227',
        daughter: 'Radon-219 (α)',
        commonUses: ['Alpha-emitter for targeted alpha therapy (e.g., Xofigo for prostate cancer)'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A clinically approved alpha-emitter for treating bone metastases from prostate cancer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.9,
          A2: 0.005,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 2,
            ingestion: 1
          },
          DAC: {
            inhalation_W: 7e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Radium-224',
        symbol: 'Ra-224',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.685 MeV'],
          beta: [],
          gamma: ['0.241 MeV']
        },
        daughterEmissions: {
          from: 'Rn-220',
          alpha: ['6.288 MeV']
        },
        halfLife: '3.66 days',
        decayConstant: '0.189 day⁻¹',
        specificActivity: '5.9 x 10^15 Bq/g',
        parent: 'Thorium-228',
        daughter: 'Radon-220 (α)',
        commonUses: ['Intermediate in Thorium-232 decay series'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A short-lived alpha-emitter in the Th-232 decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.02,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 4,
            ingestion: 3
          },
          DAC: {
            inhalation_W: 2e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Radium-226',
        symbol: 'Ra-226',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.784 MeV'],
          beta: [],
          gamma: ['0.186 MeV']
        },
        daughterEmissions: {
          from: 'Rn-222',
          alpha: ['5.490 MeV']
        },
        halfLife: '1600 years',
        decayConstant: '4.33 x 10⁻⁴ year⁻¹',
        gammaConstant: '0.825 R·m²/hr·Ci',
        specificActivity: '3.7 x 10^10 Bq/g',
        parent: 'Thorium-230',
        daughter: 'Radon-222 (α)',
        commonUses: ['Historical medical brachytherapy', 'Neutron sources (Ra-Be)', 'Luminescent paint (historical)', 'Calibration sources'],
        category: 'Natural',
        decaySeriesId: 'U-238-series',
        commonality: 'Common',
        commonalityReason: 'Historically significant for its use in medicine and luminous paint; the direct parent of Radon-222 gas.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 0.3,
          A2: 0.002,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.2,
            ingestion: 0.7
          },
          DAC: {
            inhalation_W: 9e-11
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Radium-228',
        symbol: 'Ra-228',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.039 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.013 MeV',
        daughterEmissions: {
          from: 'Ac-228',
          beta: ['2.14 MeV (max)'],
          gamma: ['0.911 MeV', '0.969 MeV']
        },
        halfLife: '5.75 years',
        decayConstant: '0.120 year⁻¹',
        specificActivity: '8.1 x 10^12 Bq/g',
        parent: 'Thorium-232',
        daughter: 'Actinium-228 (β-)',
        commonUses: ['Intermediate in Thorium-232 decay chain', 'Environmental monitoring'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'The first daughter of Th-232, often monitored in environmental samples.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.6,
          A2: 0.2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.9,
            ingestion: 2
          },
          DAC: {
            inhalation_W: 4e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Radon-219',
        symbol: 'Rn-219',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['6.819 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '3.96 seconds',
        decayConstant: '0.175 s⁻¹',
        specificActivity: '1.14 x 10^19 Bq/g',
        parent: 'Radium-223',
        daughter: 'Polonium-215 (α)',
        commonUses: ['Intermediate in Actinium-227 decay series'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An extremely short-lived noble gas intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Radon-220',
        symbol: 'Rn-220',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['6.288 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '55.6 seconds',
        decayConstant: '0.0125 s⁻¹',
        specificActivity: '8.1 x 10^17 Bq/g',
        parent: 'Radium-224',
        daughter: 'Polonium-216 (α)',
        commonUses: ['Environmental monitoring (thoron gas)', 'Research'],
        category: 'Natural',
        commonality: 'Common',
        commonalityReason: 'A naturally occurring noble gas (also called Thoron) from the Th-232 decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Radon-221',
        symbol: 'Rn-221',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.19 MeV (max)'],
          gamma: ['0.078 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.397 MeV',
        halfLife: '25 minutes',
        decayConstant: '0.0277 min⁻¹',
        specificActivity: '1.8 x 10^17 Bq/g',
        parent: 'Radium-225',
        daughter: 'Francium-221',
        commonUses: ['Research (intermediate in artificial decay series)'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A short-lived intermediate in an artificial decay series with no practical applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Radon-222',
        symbol: 'Rn-222',
        emissionType: ['Alpha'],
        emissionEnergies: {
          alpha: ['5.490 MeV'],
          beta: [],
          gamma: []
        },
        halfLife: '3.823 days',
        decayConstant: '0.181 day⁻¹',
        specificActivity: '5.73 x 10^15 Bq/g',
        parent: 'Radium-226',
        daughter: 'Polonium-218 (α)',
        commonUses: ['Indoor air quality concern', 'Geological tracer', 'Research'],
        category: 'Natural',
        decaySeriesId: 'U-238-series',
        commonality: 'Common',
        commonalityReason: 'A naturally occurring noble gas from the U-238 series, well-known as an indoor air quality concern.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: null,
          A2: 0.1,
          unit: 'TBq'
        },
        dosimetry: {
          DAC: {
            inhalation_D: 3e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Rhenium-186',
        symbol: 'Re-186',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.07 MeV (max)'],
          gamma: ['0.137 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.357 MeV',
        halfLife: '3.718 days',
        decayConstant: '0.186 day⁻¹',
        gammaConstant: '0.08 R·m²/hr·Ci',
        parent: 'Tungsten-186 (n,γ)',
        daughter: 'Osmium-186 (stable)',
        commonUses: ['Radiotherapy for bone pain palliation'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A therapeutic isotope used for bone pain palliation in metastatic cancer.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 2,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 1000,
            ingestion: 1000
          },
          DAC: {
            inhalation_W: 5e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Rhenium-187',
        symbol: 'Re-187',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.0025 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.001 MeV',
        halfLife: '4.33 x 10¹⁰ years',
        decayConstant: '1.60 x 10⁻¹¹ year⁻¹',
        specificActivity: '1.03 x 10^6 Bq/g',
        parent: 'Primordial',
        daughter: 'Osmium-187 (stable)',
        commonUses: ['Rhenium-Osmium dating (geological)', 'Neutrino mass experiments'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A very long-lived primordial nuclide used for geological dating (Re-Os system).',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_low_risk'
      },
      {
        name: 'Rhenium-188',
        symbol: 'Re-188',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['2.12 MeV (max)'],
          gamma: ['0.155 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.707 MeV',
        halfLife: '17.0 hours',
        decayConstant: '0.0408 hour⁻¹',
        specificActivity: '3.7 x 10^16 Bq/g',
        parent: 'Tungsten-188',
        daughter: 'Osmium-188 (stable)',
        commonUses: ['Radiotherapy (bone pain palliation, synovectomy, arterial brachytherapy)'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A high-energy beta emitter produced from a W-188 generator for various therapeutic applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 200,
            ingestion: 300
          },
          DAC: {
            inhalation_W: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Rhodium-105',
        symbol: 'Rh-105',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.567 MeV (max)'],
          gamma: ['0.306 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.189 MeV',
        halfLife: '35.36 hours',
        decayConstant: '0.0196 hour⁻¹',
        specificActivity: '1.27 x 10^16 Bq/g',
        parent: 'Ruthenium-105',
        daughter: 'Palladium-105 (stable)',
        commonUses: ['Targeted radiotherapy research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A short-lived isotope used in targeted radiotherapy research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 200,
            ingestion: 1000
          },
          DAC: {
            inhalation_Y: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Rubidium-81',
        symbol: 'Rb-81',
        emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['1.05 MeV (max)'],
          gamma: ['0.446 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.350 MeV',
        daughterEmissions: {
          from: 'Kr-81m',
          gamma: ['0.190 MeV']
        },
        halfLife: '4.57 hours',
        decayConstant: '0.152 hour⁻¹',
        specificActivity: '1.3 x 10^17 Bq/g',
        parent: 'Strontium-81',
        daughter: 'Krypton-81m (IT) -> Krypton-81 (stable)',
        commonUses: ['Generator for Kr-81m (lung ventilation PET imaging)'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'The parent isotope used in generators to produce the short-lived gas Kr-81m for lung scans.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 10000,
            ingestion: 3000
          },
          DAC: {
            inhalation_D: 6e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Rubidium-82',
        symbol: 'Rb-82',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['3.38 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '1.127 MeV',
        halfLife: '76 seconds',
        decayConstant: '0.00912 s⁻¹',
        specificActivity: '8.3 x 10^17 Bq/g',
        parent: 'Strontium-82',
        daughter: 'Krypton-82 (stable)',
        commonUses: ['Cardiac PET imaging for myocardial perfusion'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'An extremely short-lived PET isotope produced from a Sr-82 generator for cardiac perfusion imaging.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.4,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20000,
            ingestion: 10000
          },
          DAC: {
            inhalation_D: 9e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Rubidium-84',
        symbol: 'Rb-84',
        emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['1.65 MeV (max)'],
          gamma: ['0.882 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.550 MeV',
        halfLife: '32.8 days',
        decayConstant: '0.0211 day⁻¹',
        specificActivity: '1.74 x 10^15 Bq/g',
        parent: 'Krypton-84',
        daughter: 'Krypton-84 (stable)',
        commonUses: ['Cardiac blood flow research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A research isotope used in studies of cardiac blood flow.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            ingestion: 300
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Rubidium-86',
        symbol: 'Rb-86',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.77 MeV (max)'],
          gamma: ['1.077 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.590 MeV',
        halfLife: '18.66 days',
        decayConstant: '0.0371 day⁻¹',
        specificActivity: '4.2 x 10^15 Bq/g',
        parent: 'Krypton-86',
        daughter: 'Strontium-86 (stable)',
        commonUses: ['Cardiac blood flow research'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A research isotope used in studies of cardiac blood flow.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 100,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 5e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Ruthenium-103',
        symbol: 'Ru-103',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.226 MeV (max)'],
          gamma: ['0.497 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.075 MeV',
        halfLife: '39.25 days',
        decayConstant: '0.0176 day⁻¹',
        specificActivity: '1.3 x 10^15 Bq/g',
        parent: 'Technetium-103',
        daughter: 'Rhodium-103 (stable)',
        commonUses: ['Fission product', 'Environmental tracer'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fission product with limited use outside of specialized research applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 300,
            inhalation_W: 200,
            inhalation_Y: 20,
            ingestion: 300
          },
          DAC: {
            inhalation_D: 1e-7,
            inhalation_W: 1e-7,
            inhalation_Y: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Samarium-153',
        symbol: 'Sm-153',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.808 MeV (max)'],
          gamma: ['0.103 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.269 MeV',
        halfLife: '46.28 hours',
        decayConstant: '0.0150 hour⁻¹',
        specificActivity: '3.5 x 10^15 Bq/g',
        parent: 'Samarium-152 (n,γ)',
        daughter: 'Europium-153 (stable)',
        commonUses: ['Palliative bone pain therapy (metastatic cancer)'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A clinically used therapeutic isotope for palliative treatment of bone pain from cancer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 4,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 300,
            ingestion: 800
          },
          DAC: {
            inhalation_W: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Scandium-44',
        symbol: 'Sc-44',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['1.47 MeV (max)'],
          gamma: ['1.157 MeV', '0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.490 MeV',
        halfLife: '3.97 hours',
        decayConstant: '0.174 hour⁻¹',
        parent: 'Titanium-44 (EC)',
        daughter: 'Calcium-44 (stable)',
        commonUses: ['PET imaging', 'Theranostic pair with Sc-47'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A research PET isotope, often explored as a "theranostic" partner to the therapeutic isotope Sc-47.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.6,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 300,
            ingestion: 500
          },
          DAC: {
            inhalation_W: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Scandium-46',
        symbol: 'Sc-46',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.357 MeV (max)'],
          gamma: ['0.889 MeV', '1.121 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.119 MeV',
        halfLife: '83.79 days',
        decayConstant: '0.00827 day⁻¹',
        specificActivity: '1.24 x 10^15 Bq/g',
        parent: 'Calcium-46 (n,p)',
        daughter: 'Titanium-46 (stable)',
        commonUses: ['Tracer in hydrology and industrial processes', 'Calibration source'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived gamma-emitter used as a tracer in specialized industrial processes.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.5,
          unit: 'TBq'
        },
        gammaConstant: '1.17 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 90,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Scandium-47',
        symbol: 'Sc-47',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.601 MeV (max)'],
          gamma: ['0.159 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.200 MeV',
        halfLife: '3.35 days',
        decayConstant: '0.207 day⁻¹',
        specificActivity: '3.1 x 10^16 Bq/g',
        parent: 'Titanium-47 (n,p)',
        daughter: 'Titanium-47 (stable)',
        commonUses: ['Theranostics (pairs with Sc-44 for PET), targeted radiotherapy research.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A research therapeutic isotope, often explored as a "theranostic" partner to the PET isotope Sc-44.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 9,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 900,
            ingestion: 700
          },
          DAC: {
            inhalation_W: 4e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Selenium-76',
        symbol: 'Se-76',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Stable',
        daughter: 'Stable',
        commonUses: ['Reference for stable selenium', 'not a radionuclide use'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Selenium-79',
        symbol: 'Se-79',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.151 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.050 MeV',
        halfLife: '327,000 years',
        decayConstant: '2.12 x 10⁻⁶ year⁻¹',
        specificActivity: '9.2 x 10^8 Bq/g',
        parent: 'Bromine-79 (n,p)',
        daughter: 'Bromine-79 (stable)',
        commonUses: ['Environmental tracer (long-lived fission product)'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'An extremely long-lived fission product relevant in nuclear waste management and environmental studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 400,
            ingestion: 300
          },
          DAC: {
            inhalation_D: 2e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Silver-110m',
        symbol: 'Ag-110m',
        emissionType: ['Beta-minus', 'Isomeric Transition', 'Gamma'],
        emissionEnergies: {
          beta: ['0.529 MeV (max)'],
          gamma: ['0.885 MeV', '0.658 MeV', '1.505 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.176 MeV',
        halfLife: '249.8 days',
        decayConstant: '0.00277 day⁻¹',
        specificActivity: '1.93 x 10^14 Bq/g',
        parent: 'Cadmium-108',
        daughter: 'Cadmium-110 (stable) or Palladium-110 (stable)',
        commonUses: ['Environmental monitoring (fission product', 'activation product)'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'An activation product sometimes used as a gamma calibration source or environmental tracer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.6,
          A2: 0.4,
          unit: 'TBq'
        },
        gammaConstant: '1.65 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 100,
            ingestion: 100
          },
          DAC: {
            inhalation_W: 5e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Sodium-22',
        symbol: 'Na-22',
        emissionType: ['Positron Emission', 'Gamma'],
        emissionEnergies: {
          beta: ['0.546 MeV (max)'],
          gamma: ['1.275 MeV', '0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.182 MeV',
        halfLife: '2.602 years',
        decayConstant: '0.266 year⁻¹',
        gammaConstant: '1.20 R·m²/hr·Ci',
        specificActivity: '6.45 x 10^13 Bq/g',
        parent: 'Magnesium-22 (EC)',
        daughter: 'Neon-22 (stable)',
        commonUses: ['Calibration sources for PET scanners', 'Tracers for biological studies'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A common long-lived positron emitter used to calibrate PET scanners and other detectors.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 0.5,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 80,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 4e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Sodium-23',
        symbol: 'Na-23',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Stable',
        daughter: 'Stable',
        commonUses: ['Reference for stable sodium', 'not a radionuclide use'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Sodium-24',
        symbol: 'Na-24',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.39 MeV (max)'],
          gamma: ['1.369 MeV', '2.754 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.463 MeV',
        halfLife: '14.96 hours',
        decayConstant: '0.0463 hour⁻¹',
        specificActivity: '1.8 x 10^17 Bq/g',
        parent: 'Magnesium-24 (n,p)',
        daughter: 'Magnesium-24 (stable)',
        commonUses: ['Hydrological tracer', 'Flow studies', 'Research'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A short-lived, high-energy gamma emitter used as a tracer in industrial and environmental flow studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.4,
          unit: 'TBq'
        },
        gammaConstant: '1.84 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Strontium-82',
        symbol: 'Sr-82',
        emissionType: ['Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.776 MeV'],
          alpha: []
        },
        daughterEmissions: {
          from: 'Rb-82',
          beta: ['3.38 MeV (max)'],
          gamma: ['0.511 MeV (annihilation)']
        },
        halfLife: '25.36 days',
        decayConstant: '0.0273 day⁻¹',
        specificActivity: '2.4 x 10^15 Bq/g',
        parent: 'Yttrium-85',
        daughter: 'Rubidium-82',
        commonUses: ['Generator for Rubidium-82, used for cardiac PET imaging.'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'The long-lived parent used in generators to produce the very short-lived PET isotope Rb-82 for cardiac scans.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            ingestion: 20
          },
          DAC: {
            inhalation_D: 7e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Strontium-89',
        symbol: 'Sr-89',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['1.49 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.497 MeV',
        halfLife: '50.5 days',
        decayConstant: '0.0137 day⁻¹',
        specificActivity: '1.09 x 10^15 Bq/g',
        parent: 'Uranium Fission',
        daughter: 'Yttrium-89 (stable)',
        commonUses: ['Palliative bone pain therapy (metastatic cancer)'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A clinically used high-energy beta-emitter for palliative treatment of bone pain from cancer.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 300,
            ingestion: 90
          },
          DAC: {
            inhalation_D: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Strontium-90',
        symbol: 'Sr-90',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.546 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.196 MeV',
        daughterEmissions: {
          from: 'Y-90',
          beta: ['2.28 MeV (max)']
        },
        halfLife: '28.9 years',
        decayConstant: '0.0240 year⁻¹',
        specificActivity: '5.15 x 10^12 Bq/g',
        parent: 'Uranium Fission',
        daughter: 'Yttrium-90',
        commonUses: ['Radioisotope thermoelectric generators (RTGs)', 'Industrial gauges', 'Medical radiation therapy for bone cancer'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'A major fission product and long-lived, high-energy beta source (via its Y-90 daughter) for industrial and medical uses.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2,
            ingestion: 8
          },
          DAC: {
            inhalation_D: 1e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Sulfur-34',
        symbol: 'S-34',
        emissionType: ['Stable'],
        emissionEnergies: {
          beta: [],
          gamma: [],
          alpha: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        parent: 'Stable',
        daughter: 'Stable',
        commonUses: ['Reference for stable sulfur', 'not a radionuclide use'],
        category: 'Stable/Reference',
        commonality: 'N/A',
        commonalityReason: 'This is a stable isotope and not radioactive.',
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Sulfur-35',
        symbol: 'S-35',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.167 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.056 MeV',
        halfLife: '87.51 days',
        decayConstant: '0.00792 day⁻¹',
        specificActivity: '1.57 x 10^15 Bq/g',
        parent: 'Chlorine-35 (n,p)',
        daughter: 'Chlorine-35 (stable)',
        commonUses: ['Molecular biology (protein labeling)', 'Metabolic studies'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A low-energy beta-emitter widely used in molecular biology labs for labeling proteins.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2000,
            ingestion: 2000
          },
          DAC: {
            inhalation_D: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_low_risk'
      },
      {
        name: 'Tantalum-182',
        symbol: 'Ta-182',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.526 MeV (max)'],
          gamma: ['1.121 MeV', '1.221 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.175 MeV',
        halfLife: '114.4 days',
        decayConstant: '0.00606 day⁻¹',
        specificActivity: '5.2 x 10^14 Bq/g',
        parent: 'Tantalum-181 (n,γ)',
        daughter: 'Tungsten-182 (stable)',
        commonUses: ['Radiography of heavy metals', 'Calibration sources'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'Used for specialized industrial radiography of dense materials.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.8,
          A2: 0.8,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 20,
            ingestion: 200
          },
          DAC: {
            inhalation_Y: 8e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Technetium-99',
        symbol: 'Tc-99',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.294 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.098 MeV',
        halfLife: '211,100 years',
        decayConstant: '3.28 x 10⁻⁶ year⁻¹',
        specificActivity: '6.3 x 10^8 Bq/g',
        parent: 'Technetium-99m',
        daughter: 'Ruthenium-99 (stable)',
        commonUses: ['Daughter product of Tc-99m', 'Environmental tracer', 'Long-lived fission product in nuclear waste'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'The long-lived daughter of Tc-99m, relevant in nuclear waste management and environmental studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 0.9,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 200,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 9e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Technetium-99m',
        symbol: 'Tc-99m',
        emissionType: ['Gamma', 'Isomeric Transition'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.1405 MeV'],
          alpha: []
        },
        halfLife: '6.01 hours',
        decayConstant: '0.115 hour⁻¹',
        specificActivity: '1.95 x 10^17 Bq/g',
        parent: 'Molybdenum-99',
        daughter: 'Technetium-99',
        commonUses: ['Medical diagnostic imaging (most common medical isotope for various scans: bone, heart, kidney, brain, etc.)'],
        category: 'Medical',
        commonality: 'Common',
        commonalityReason: 'The most widely used medical radioisotope for diagnostic imaging procedures worldwide.',
        sourceRef: {
          halfLife: 'nndc',
          decayConstant: 'nndc'
        },
        shipping: {
          A1: 8,
          A2: 0.7,
          unit: 'TBq'
        },
        gammaConstant: '0.08 R·m²/hr·Ci',
        dosimetry: {
          ALI: {
            inhalation_W: 80000,
            ingestion: 30000
          },
          DAC: {
            inhalation_W: 4e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Tellurium-123m',
        symbol: 'Te-123m',
        emissionType: ['Isomeric Transition', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.159 MeV'],
          alpha: []
        },
        halfLife: '119.7 days',
        decayConstant: '0.00579 day⁻¹',
        specificActivity: '4.1 x 10^14 Bq/g',
        parent: 'Antimony-123',
        daughter: 'Tellurium-123 (stable)',
        commonUses: ['Medical imaging (historical)', 'Research tracer'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used historically in medicine but has been replaced by other isotopes.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 8,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 700,
            ingestion: 200
          },
          DAC: {
            inhalation_D: 3e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Tellurium-128',
        symbol: 'Te-128',
        emissionType: ['Double Beta-minus'],
        emissionEnergies: {
          beta: ['0.867 MeV (total)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.289 MeV',
        halfLife: '2.2 x 10²⁴ years',
        decayConstant: '3.15 x 10⁻²⁵ year⁻¹',
        specificActivity: '1.4 x 10^-8 Bq/g',
        parent: 'Primordial',
        daughter: 'Xenon-128 (stable)',
        commonUses: ['Longest measured half-life', 'Fundamental physics research'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'Notable for having one of the longest measured half-lives of any isotope.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Tellurium-130',
        symbol: 'Te-130',
        emissionType: ['Double Beta-minus'],
        emissionEnergies: {
          beta: ['2.528 MeV (total)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.843 MeV',
        halfLife: '2.5 x 10²¹ years',
        decayConstant: '2.77 x 10⁻²² year⁻¹',
        specificActivity: '1.6 x 10^-5 Bq/g',
        parent: 'Primordial',
        daughter: 'Xenon-130 (stable)',
        commonUses: ['Double beta decay research'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An isotope with an extremely long half-life used in fundamental physics research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 0.7,
          unit: 'TBq'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Terbium-161',
        symbol: 'Tb-161',
        emissionType: ['Beta-minus', 'Gamma', 'Auger electron'],
        emissionEnergies: {
          beta: ['0.593 MeV (max)'],
          gamma: ['0.049 MeV', '0.075 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.198 MeV',
        halfLife: '6.89 days',
        decayConstant: '0.101 day⁻¹',
        specificActivity: '4.4 x 10^14 Bq/g',
        commonUses: ['Theranostics (combined therapy and diagnostics), particularly for cancer treatment research.'],
        parent: 'Gadolinium-160 (n,γ)',
        daughter: 'Dysprosium-161 (stable)',
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A promising research isotope for targeted radionuclide therapy due to its ideal decay properties.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 30,
          A2: 0.6,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 300,
            ingestion: 600
          },
          DAC: {
            inhalation_W: 1e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thallium-201',
        symbol: 'Tl-201',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.167 MeV', '0.135 MeV'],
          alpha: []
        },
        halfLife: '73.1 hours',
        decayConstant: '0.00948 hour⁻¹',
        specificActivity: '1.74 x 10^15 Bq/g',
        parent: 'Lead-201',
        daughter: 'Mercury-201 (stable)',
        commonUses: ['Cardiac imaging (myocardial perfusion)', 'Parathyroid gland imaging'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A once-common SPECT agent for cardiac imaging, still used for certain applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 4,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 1000,
            ingestion: 700
          },
          DAC: {
            inhalation_W: 6e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thallium-204',
        symbol: 'Tl-204',
        emissionType: ['Beta-minus', 'Electron Capture'],
        emissionEnergies: {
          beta: ['0.763 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.254 MeV',
        halfLife: '3.78 years',
        decayConstant: '0.183 year⁻¹',
        specificActivity: '1.6 x 10^13 Bq/g',
        parent: 'Lead-204 (d,2n)',
        daughter: 'Lead-204 (stable) or Mercury-204 (stable)',
        commonUses: ['Calibration sources (beta)', 'Thickness gauging'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived pure beta-emitter used in specialized industrial gauges.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 4,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 400,
            ingestion: 300
          },
          DAC: {
            inhalation_D: 2e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thallium-205',
        symbol: 'Tl-205',
        emissionType: ['Stable'],
        emissionEnergies: {
          alpha: [],
          beta: [],
          gamma: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        specificActivity: '0 Bq/g',
        parent: 'Bismuth-209 (α)',
        daughter: 'Stable',
        commonUses: ['Final stable product of Bismuth-209 decay', 'Nuclear Magnetic Resonance (NMR) research', 'Target material for isotope production'],
        category: 'Stable/Reference',
        commonality: 'Common',
        commonalityReason: 'The stable end-product of the extremely long-lived Bi-209.',
        sourceRef: {
          halfLife: 'nndc'
        },
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Thallium-207',
        symbol: 'Tl-207',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['1.42 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.473 MeV',
        halfLife: '4.77 minutes',
        decayConstant: '0.145 min⁻¹',
        specificActivity: '1.5 x 10^18 Bq/g',
        parent: 'Bismuth-211',
        daughter: 'Lead-207 (stable)',
        commonUses: ['Intermediate in Actinium-227 decay series'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.2,
          unit: 'TBq'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thallium-208',
        symbol: 'Tl-208',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['1.80 MeV (max)'],
          gamma: ['2.614 MeV (dominant)', '0.583 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.600 MeV',
        halfLife: '3.053 minutes',
        decayConstant: '0.227 min⁻¹',
        specificActivity: '2.4 x 10^18 Bq/g',
        parent: 'Bismuth-212 (α)',
        daughter: 'Lead-208 (stable)',
        commonUses: ['High-energy gamma source in natural background'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A daughter in the Th-232 series, notable for emitting one of the highest-energy natural gamma rays (2.6 MeV).',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.3,
          unit: 'TBq'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thorium-227',
        symbol: 'Th-227',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['6.038 MeV'],
          beta: [],
          gamma: ['0.236 MeV']
        },
        halfLife: '18.72 days',
        decayConstant: '0.037 day⁻¹',
        specificActivity: '1.2 x 10^15 Bq/g',
        parent: 'Actinium-227',
        daughter: 'Radium-223 (α)',
        commonUses: ['Intermediate in Actinium-227 decay series', 'Alpha therapy research'],
        category: 'Natural',
        commonality: 'Rare',
        commonalityReason: 'An alpha-emitter in the U-235 decay series, used in targeted alpha therapy research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.6,
            ingestion: 0.7
          },
          DAC: {
            inhalation_W: 3e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Thorium-228',
        symbol: 'Th-228',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.423 MeV'],
          beta: [],
          gamma: ['0.084 MeV']
        },
        daughterEmissions: {
          from: 'Ra-224',
          alpha: ['5.685 MeV'],
          gamma: ['0.241 MeV']
        },
        halfLife: '1.91 years',
        decayConstant: '0.363 year⁻¹',
        specificActivity: '3.0 x 10^13 Bq/g',
        parent: 'Actinium-228',
        daughter: 'Radium-224 (α)',
        commonUses: ['Intermediate in Thorium-232 decay chain', 'Calibration sources'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A key alpha-emitting member of the Th-232 decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.5,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.1,
            ingestion: 0.4
          },
          DAC: {
            inhalation_W: 6e-11
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Thorium-229',
        symbol: 'Th-229',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.845 MeV'],
          beta: [],
          gamma: ['0.029 MeV', '0.194 MeV']
        },
        halfLife: '7,340 years',
        decayConstant: '9.44 x 10⁻⁵ year⁻¹',
        specificActivity: '7.9 x 10^9 Bq/g',
        parent: 'Uranium-233',
        daughter: 'Radium-225 (α)',
        commonUses: ['Parent for Actinium-225 generators', 'Research in nuclear clocks due to its low-energy isomeric state'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A long-lived alpha emitter used to produce Ac-225 generators and for advanced physics research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 5,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.004,
            ingestion: 0.5
          },
          DAC: {
            inhalation_W: 2e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_very_high'
      },
      {
        name: 'Thorium-230',
        symbol: 'Th-230',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.688 MeV'],
          beta: [],
          gamma: ['0.067 MeV']
        },
        halfLife: '75,400 years',
        decayConstant: '9.19 x 10⁻⁶ year⁻¹',
        specificActivity: '7.6 x 10^8 Bq/g',
        parent: 'Uranium-234',
        daughter: 'Radium-226 (α)',
        commonUses: ['Dating of marine sediments', 'Component of natural decay series'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'A long-lived member of the U-238 decay series, used in geological dating.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.006,
            ingestion: 0.6
          },
          DAC: {
            inhalation_W: 3e-12
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'transuranics',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Thorium-231',
        symbol: 'Th-231',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.39 MeV (max)'],
          gamma: ['0.084 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.130 MeV',
        halfLife: '25.52 hours',
        decayConstant: '0.0272 hour⁻¹',
        specificActivity: '2.6 x 10^16 Bq/g',
        parent: 'Uranium-235',
        daughter: 'Protactinium-231',
        commonUses: ['Intermediate in U-235 decay chain'],
        category: 'Natural',
        decaySeriesId: 'U-235-series',
        commonality: 'Rare',
        commonalityReason: 'A short-lived intermediate in a natural decay chain.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 10000,
            ingestion: 10000
          },
          DAC: {
            inhalation_W: 6e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thorium-232',
        symbol: 'Th-232',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.012 MeV'],
          beta: [],
          gamma: ['0.059 MeV']
        },
        daughterEmissions: {
          from: 'Ra-228',
          beta: ['0.039 MeV (max)']
        },
        halfLife: '14.05 billion years',
        decayConstant: '4.93 x 10⁻¹¹ year⁻¹',
        specificActivity: '4,059 Bq/g',
        parent: 'Primordial',
        daughter: 'Radium-228 (α)',
        commonUses: ['Nuclear fuel cycle (fertile material)', 'Gas mantles (historical)', 'Welding electrodes', 'Thoriated optics', 'Catalysis'],
        category: 'Natural',
        decaySeriesId: 'Th-232-series',
        commonality: 'Common',
        commonalityReason: 'A primordial, naturally occurring fertile isotope that is the head of its own decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: null,
          A2: null,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 0.001,
            ingestion: 0.2
          },
          DAC: {
            inhalation_W: 4e-13
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Thorium-234',
        symbol: 'Th-234',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.193 MeV (max)'],
          gamma: ['0.063 MeV', '0.093 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.064 MeV',
        daughterEmissions: {
          from: 'Pa-234m',
          beta: ['2.29 MeV (max)'],
          gamma: ['1.001 MeV']
        },
        halfLife: '24.10 days',
        decayConstant: '0.0287 day⁻¹',
        specificActivity: '8.2 x 10^14 Bq/g',
        parent: 'Uranium-238',
        daughter: 'Protactinium-234m (β-)',
        commonUses: ['Intermediate in U-238 decay chain'],
        category: 'Natural',
        commonality: 'Moderate',
        commonalityReason: 'The first daughter of U-238, often found in equilibrium with its parent in natural samples.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.3,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 800,
            ingestion: 700
          },
          DAC: {
            inhalation_D: 3e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Thulium-170',
        symbol: 'Tm-170',
        emissionType: ['Beta-minus', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: ['0.968 MeV (max)'],
          gamma: ['0.084 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.323 MeV',
        halfLife: '128.6 days',
        decayConstant: '0.00539 day⁻¹',
        specificActivity: '1.02 x 10^15 Bq/g',
        parent: 'Erbium-170',
        daughter: 'Ytterbium-170 (stable)',
        commonUses: ['Portable industrial radiography', 'Brachytherapy', 'Medical imaging (historical)'],
        category: 'Industrial',
        commonality: 'Moderate',
        commonalityReason: 'A versatile isotope used for portable radiography and some brachytherapy applications.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 4,
          A2: 0.5,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 20,
            ingestion: 400
          },
          DAC: {
            inhalation_Y: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Tin-117m',
        symbol: 'Sn-117m',
        emissionType: ['Isomeric Transition', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.159 MeV'],
          alpha: []
        },
        halfLife: '13.76 days',
        decayConstant: '0.0504 day⁻¹',
        specificActivity: '4.8 x 10^15 Bq/g',
        parent: 'Tin-116 (n,γ)',
        daughter: 'Tin-117 (stable)',
        commonUses: ['Bone pain palliation for metastatic cancer.', 'Radiosynovectomy.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A therapeutic isotope used for treating bone pain and in radiosynovectomy.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.7,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 900,
            ingestion: 600
          },
          DAC: {
            inhalation_W: 4e-7
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Tin-126',
        symbol: 'Sn-126',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.380 MeV (max)'],
          gamma: ['0.087 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.127 MeV',
        halfLife: '230,000 years',
        decayConstant: '3.01 x 10⁻⁶ year⁻¹',
        specificActivity: '1.4 x 10^9 Bq/g',
        parent: 'Cadmium-126',
        daughter: 'Antimony-126 (β-)',
        commonUses: ['Long-lived fission product', 'Nuclear waste assessment'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'An extremely long-lived fission product relevant in nuclear waste management.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.4,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 100,
            ingestion: 90
          },
          DAC: {
            inhalation_W: 5e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Tritium',
        symbol: 'H-3',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['0.0186 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.006 MeV',
        halfLife: '12.32 years',
        decayConstant: '0.0563 year⁻¹',
        specificActivity: '3.59 x 10^14 Bq/g',
        parent: 'Lithium-6 (n,α)',
        daughter: 'Helium-3 (stable)',
        commonUses: ['Self-powered lighting (e.g., exit signs, watches)', 'Medical and biological tracer', 'Nuclear weapons component'],
        category: 'Industrial',
        commonality: 'Common',
        commonalityReason: 'Widely used in self-powered lighting (e.g., exit signs), as a biological tracer, and in nuclear weapons.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 40,
          A2: 40,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            ingestion: 80000,
            inhalation_D: 80000
          },
          DAC: {
            inhalation_D: 2e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_low_risk'
      },
      {
        name: 'Tungsten-188',
        symbol: 'W-188',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.349 MeV (max)'],
          gamma: ['0.227 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.116 MeV',
        daughterEmissions: {
          from: 'Re-188',
          beta: ['2.12 MeV (max)'],
          gamma: ['0.155 MeV']
        },
        halfLife: '69.4 days',
        decayConstant: '0.00999 day⁻¹',
        specificActivity: '3.6 x 10^14 Bq/g',
        parent: 'Tantalum-186',
        daughter: 'Rhenium-188',
        commonUses: ['Generator for Rhenium-188, used in therapeutic applications.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'The parent isotope used in generators to produce the therapeutic isotope Re-188.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.9,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 200,
            inhalation_Y: 40,
            ingestion: 1000
          },
          DAC: {
            inhalation_D: 9e-8,
            inhalation_Y: 2e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Uranium-230',
        symbol: 'U-230',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.888 MeV'],
          beta: [],
          gamma: ['0.053 MeV']
        },
        halfLife: '20.8 days',
        decayConstant: '0.0333 day⁻¹',
        specificActivity: '1.87 x 10^15 Bq/g',
        parent: 'Plutonium-234 (α)',
        daughter: 'Thorium-226',
        commonUses: ['Medical isotope production (e.g., Ra-223 from Th-226 generator)', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A research isotope sometimes used in generators to produce medical alpha-emitters.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 100,
            inhalation_W: 100,
            ingestion: 20
          },
          DAC: {
            inhalation_D: 4e-8,
            inhalation_W: 5e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Uranium-231',
        symbol: 'U-231',
        emissionType: ['Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.084 MeV', '0.143 MeV'],
          alpha: []
        },
        halfLife: '4.2 days',
        decayConstant: '0.165 day⁻¹',
        specificActivity: '1.27 x 10^16 Bq/g',
        parent: 'Neptunium-231 (EC)',
        daughter: 'Protactinium-231',
        commonUses: ['Intermediate in nuclear research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A short-lived isotope encountered only in specialized nuclear research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 100,
            inhalation_W: 100,
            ingestion: 20
          },
          DAC: {
            inhalation_D: 4e-8,
            inhalation_W: 5e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Uranium-232',
        symbol: 'U-232',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['5.320 MeV'],
          beta: [],
          gamma: ['0.058 MeV']
        },
        daughterEmissions: {
          from: 'Th-228',
          alpha: ['5.423 MeV'],
          gamma: ['0.084 MeV']
        },
        halfLife: '68.9 years',
        decayConstant: '0.0101 year⁻¹',
        specificActivity: '8.1 x 10^11 Bq/g',
        parent: 'Plutonium-236 (α)',
        daughter: 'Thorium-228 (α)',
        commonUses: ['Contaminant in U-233 from thorium fuel cycle', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'An isotope primarily known as a problematic contaminant in the thorium fuel cycle due to its high-energy gamma daughters.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 2,
            inhalation_W: 2,
            ingestion: 0.9
          },
          DAC: {
            inhalation_D: 1e-9,
            inhalation_W: 8e-10
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Uranium-233',
        symbol: 'U-233',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.824 MeV'],
          beta: [],
          gamma: ['0.042 MeV', '0.312 MeV']
        },
        halfLife: '159,200 years',
        decayConstant: '4.35 x 10⁻⁶ year⁻¹',
        specificActivity: '3.56 x 10^8 Bq/g',
        parent: 'Protactinium-233',
        daughter: 'Thorium-229 (α)',
        commonUses: ['Thorium fuel cycle (fissile material)', 'Research'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A fissile isotope that can be bred from Thorium-232, central to thorium fuel cycle research.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            inhalation_W: 20,
            ingestion: 2
          },
          DAC: {
            inhalation_D: 1e-8,
            inhalation_W: 8e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Uranium-234',
        symbol: 'U-234',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.776 MeV'],
          beta: [],
          gamma: ['0.053 MeV']
        },
        halfLife: '245,500 years',
        decayConstant: '2.82 x 10⁻⁶ year⁻¹',
        specificActivity: '2.3 x 10^8 Bq/g',
        parent: 'Protactinium-234m (β-)',
        daughter: 'Thorium-230',
        commonUses: ['Component of natural uranium', 'Geological dating (uranium-thorium dating)'],
        category: 'Natural',
        decaySeriesId: 'U-238-series',
        commonality: 'Moderate',
        commonalityReason: 'A member of the U-238 decay series present in all natural uranium.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            inhalation_W: 20,
            ingestion: 2
          },
          DAC: {
            inhalation_D: 1e-8,
            inhalation_W: 8e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Uranium-235',
        symbol: 'U-235',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.398 MeV'],
          beta: [],
          gamma: ['0.186 MeV', '0.144 MeV']
        },
        daughterEmissions: {
          from: 'Th-231',
          beta: ['0.39 MeV (max)'],
          gamma: ['0.084 MeV']
        },
        halfLife: '703.8 million years',
        decayConstant: '9.85 x 10⁻¹⁰ year⁻¹',
        specificActivity: '8.0 x 10^4 Bq/g',
        parent: 'Primordial',
        daughter: 'Thorium-231 (α)',
        commonUses: ['Nuclear fuel for reactors', 'Nuclear weapons'],
        category: 'Natural',
        decaySeriesId: 'U-235-series',
        commonality: 'Common',
        commonalityReason: 'The primary fissile isotope of uranium, used for nuclear power generation and weapons.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 10,
          A2: 0.001,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            inhalation_W: 20,
            ingestion: 2
          },
          DAC: {
            inhalation_D: 1e-8,
            inhalation_W: 8e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Uranium-238',
        symbol: 'U-238',
        emissionType: ['Alpha', 'Gamma'],
        emissionEnergies: {
          alpha: ['4.197 MeV'],
          beta: [],
          gamma: ['0.0496 MeV']
        },
        daughterEmissions: {
          from: 'Th-234',
          beta: ['0.193 MeV (max)'],
          gamma: ['0.063 MeV', '0.093 MeV']
        },
        halfLife: '4.468 billion years',
        decayConstant: '1.55 x 10⁻¹⁰ year⁻¹',
        specificActivity: '1.24 x 10^4 Bq/g',
        parent: 'Primordial',
        daughter: 'Thorium-234 (α)',
        commonUses: ['Geological dating', 'Nuclear fuel cycle (raw material)', 'Shielding (depleted uranium)'],
        category: 'Natural',
        decaySeriesId: 'U-238-series',
        commonality: 'Common',
        commonalityReason: 'The most abundant isotope of natural uranium (>99%) and the head of a primary natural decay series.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: null,
          A2: null,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 20,
            inhalation_W: 20,
            ingestion: 2
          },
          DAC: {
            inhalation_D: 1e-8,
            inhalation_W: 8e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'u_nat',
        ansiCategory: 'alpha_high'
      },
      {
        name: 'Xenon-131',
        symbol: 'Xe-131',
        emissionType: ['Stable'],
        emissionEnergies: {
          alpha: [],
          beta: [],
          gamma: []
        },
        halfLife: 'Stable',
        decayConstant: '0',
        specificActivity: '0 Bq/g',
        parent: 'Iodine-131 (β-)',
        daughter: 'Stable',
        commonUses: ['Stable end-product of Iodine-131 decay.', 'Stable isotope analysis.'],
        category: 'Stable/Reference',
        commonality: 'Common',
        commonalityReason: 'The stable end-product of I-131 decay, a very common medical isotope.',
        sourceRef: {},
        regGuideCategory: null,
        ansiCategory: null
      },
      {
        name: 'Xenon-133',
        symbol: 'Xe-133',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.346 MeV (max)'],
          gamma: ['0.081 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.115 MeV',
        halfLife: '5.24 days',
        decayConstant: '0.132 day⁻¹',
        specificActivity: '6.4 x 10^15 Bq/g',
        parent: 'Uranium Fission',
        daughter: 'Cesium-133 (stable)',
        commonUses: ['Lung ventilation studies (medical imaging)', 'Blood flow measurements'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A radioactive noble gas widely used for lung ventilation studies in nuclear medicine.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 20,
          A2: 10,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 40000
          },
          DAC: {
            inhalation_D: 1e-5
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Ytterbium-169',
        symbol: 'Yb-169',
        emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.198 MeV', '0.261 MeV', '0.308 MeV'],
          alpha: []
        },
        halfLife: '32.02 days',
        decayConstant: '0.0216 day⁻¹',
        gammaConstant: '0.18 R·m²/hr·Ci',
        specificActivity: '1.9 x 10^14 Bq/g',
        parent: 'Lutetium-169',
        daughter: 'Thulium-169 (stable)',
        commonUses: ['Medical imaging (historical)', 'Brain and CSF studies', 'Industrial radiography'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'Used for specialized, small-format industrial radiography and historically in medicine.',
        sourceRef: {
          halfLife: 'nndc',
          gammaConstant: 'hps'
        },
        shipping: {
          A1: 10,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 20,
            ingestion: 1000
          },
          DAC: {
            inhalation_Y: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Yttrium-90',
        symbol: 'Y-90',
        emissionType: ['Beta-minus'],
        emissionEnergies: {
          beta: ['2.28 MeV (max)'],
          gamma: [],
          alpha: []
        },
        avgBetaEnergy: '0.760 MeV',
        halfLife: '64.0 hours',
        decayConstant: '0.0108 hour⁻¹',
        specificActivity: '1.21 x 10^16 Bq/g',
        parent: 'Strontium-90',
        daughter: 'Zirconium-90 (stable)',
        commonUses: ['Radioembolization (liver cancer therapy)', 'Radioimmunotherapy', 'Brachytherapy'],
        category: 'Medical',
        commonality: 'Moderate',
        commonalityReason: 'A high-energy pure beta-emitter used for liver cancer therapy and other treatments.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 0.3,
          A2: 0.3,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_Y: 20,
            ingestion: 300
          },
          DAC: {
            inhalation_Y: 1e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Zinc-69m',
        symbol: 'Zn-69m',
        emissionType: ['Isomeric Transition', 'Gamma'],
        emissionEnergies: {
          beta: [],
          gamma: ['0.439 MeV'],
          alpha: []
        },
        halfLife: '13.76 hours',
        decayConstant: '0.0504 hour⁻¹',
        specificActivity: '4.8 x 10^16 Bq/g',
        parent: 'Zinc-69',
        daughter: 'Zinc-69',
        commonUses: ['Zinc metabolism studies (historical)'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'Used historically as a tracer for zinc metabolism but has been replaced by other methods.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 2,
          A2: 2,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_D: 4000,
            inhalation_W: 3000,
            ingestion: 3000
          },
          DAC: {
            inhalation_D: 2e-6,
            inhalation_W: 1e-6
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Zirconium-89',
        symbol: 'Zr-89',
        emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
        emissionEnergies: {
          beta: ['0.902 MeV (max)'],
          gamma: ['0.909 MeV', '0.511 MeV (annihilation)'],
          alpha: []
        },
        avgBetaEnergy: '0.301 MeV',
        halfLife: '78.41 hours',
        decayConstant: '0.00884 hour⁻¹',
        specificActivity: '1.18 x 10^16 Bq/g',
        parent: 'Yttrium-89 (p,n)',
        daughter: 'Yttrium-89 (stable)',
        commonUses: ['PET imaging, particularly for antibody-based imaging (immuno-PET) due to its longer half-life.'],
        category: 'Medical',
        commonality: 'Rare',
        commonalityReason: 'A PET isotope with a relatively long half-life, making it ideal for antibody-based imaging (immuno-PET).',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 1,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 100,
            inhalation_Y: 20,
            ingestion: 300
          },
          DAC: {
            inhalation_W: 5e-8,
            inhalation_Y: 9e-9
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      },
      {
        name: 'Zirconium-95',
        symbol: 'Zr-95',
        emissionType: ['Beta-minus', 'Gamma'],
        emissionEnergies: {
          beta: ['0.399 MeV (max)'],
          gamma: ['0.724 MeV', '0.757 MeV'],
          alpha: []
        },
        avgBetaEnergy: '0.133 MeV',
        daughterEmissions: {
          from: 'Nb-95',
          beta: ['0.160 MeV (max)'],
          gamma: ['0.766 MeV']
        },
        halfLife: '64.03 days',
        decayConstant: '0.0108 day⁻¹',
        specificActivity: '8.8 x 10^14 Bq/g',
        parent: 'Uranium Fission',
        daughter: 'Niobium-95',
        commonUses: ['Fission product', 'Environmental tracer'],
        category: 'Industrial',
        commonality: 'Rare',
        commonalityReason: 'A common fission product used as a tracer in environmental and fallout studies.',
        sourceRef: {
          halfLife: 'nndc'
        },
        shipping: {
          A1: 1,
          A2: 0.8,
          unit: 'TBq'
        },
        dosimetry: {
          ALI: {
            inhalation_W: 100,
            inhalation_Y: 70,
            ingestion: 200
          },
          DAC: {
            inhalation_W: 6e-8,
            inhalation_Y: 3e-8
          },
          sourceRef: '10CFR20'
        },
        regGuideCategory: 'beta_gamma',
        ansiCategory: 'beta_gamma'
      }
    ];
  </script>
  <script type="text/babel">


    /**
          * Radionuclide Database Tool - Core Data and Utility Functions
          * -----------------------------------------------------------
          * This script contains the core data structures, constants, and utility
          * functions for the radionuclide database application. It includes
          * decay series data, SVG icon paths, and various parsers for handling
          * physical quantities like half-life and energy.
          */
         
         //==============================================================================
         // --- APPLICATION METADATA & CONSTANTS
         //==============================================================================
         
         const VERSION = '3.5.6';
         const LAST_UPDATED = 'September 17, 2025';
         
         // NEW: A global constant for all navigation views
         
         const VIEWS = {
         HOME: 'home',
         DATABASE: 'database',
         COMPARE: 'compare',
         CALCULATOR: 'calculator',
         MDA: 'mda',
         MARSSIM_SAMPLES: 'marssim',
         MARSSIM_TESTS: 'marssimTests',
         WRS_TEST: 'wrs',
         EMC_TEST: 'emc',
         SERIES_CALCULATOR: 'seriesCalculator',
         EQUILIBRIUM: 'equilibrium',
         RADON: 'radon',
         ACTIVITY_MASS: 'activityMassTools',
         DOSE_RATE: 'doseRate',
         SHIELDING: 'shielding',
         STAY_TIME: 'stayTime',
         NEUTRON: 'neutron',
         OPERATIONAL_HP: 'operationalHp',
         TRANSPORTATION: 'transportation',
         CONVERTER: 'converter',
         SETTINGS: 'settings',
         DECAY_SERIES: 'decaySeries',
	 DETAIL: 'detail', 
         MEDICAL: 'medical',
         PEAK_ID: 'peakId',
         LAB_STATS: 'labStats',
         SCRATCHPAD: 'scratchpad',
         SCIENTIFIC_CALCULATOR: 'scientificCalculator',
         
         REFERENCES: 'references'
         };
         
         /**
          * Data sources used in the application.
          * Each key is a short identifier, and the value is an object
          * containing the full name and URL of the source.
          */
         
         const sources = {
             nndc: { name: 'NNDC', url: 'https://www.nndc.bnl.gov/nudat3/' },
             wiki: { name: 'Wikipedia', url: 'https://en.wikipedia.org/' },
             hps: { name: 'Health Physics Society', url: 'https://hps.org/' },
             rse: { name: 'Radiation Safety Engineering, Inc.', url: 'https://www.radpro.com/sourcehvl.htm' } // <-- New source added
         };
         
         /**
         * Configuration for smart unit selection.
         * For each type, it lists units from smallest to largest.
         * - threshold: The value above which the *next* unit in the list is considered.
         * - factor: How many of the current unit are in one base unit (e.g., 1000 mrem in 1 rem).
         */
         
         const SENSIBLE_UNIT_CONFIG = {
         
         doseRate: {
         baseUnit: 'mrem/hr',
         units: [
             { unit: 'µrem/hr', threshold: 1, factor: 0.001 },
             { unit: 'mrem/hr', threshold: 1000, factor: 1 },
             { unit: 'rem/hr',  threshold: Infinity, factor: 1000 }
         ]
         },
         dose: {
         baseUnit: 'mrem',
         units: [
             { unit: 'µrem', threshold: 1, factor: 0.001 },
             { unit: 'mrem', threshold: 1000, factor: 1 },
             { unit: 'rem',  threshold: Infinity, factor: 1000 }
         ]
         },
         distance: {
         baseUnit: 'cm',
         units: [
             { unit: 'mm', threshold: 1, factor: 0.1 },
             { unit: 'cm', threshold: 100, factor: 1 },
             { unit: 'm',  threshold: Infinity, factor: 100 }
         ]
         }
         // You can add more types here later (e.g., 'activity', 'time')
         };
         
         // --- MASTER LIST of Smart-Sorted Unit Arrays ---
         
         // For Activity
         
         const activityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'µCi', 'mCi', 'Ci', 'dps', 'dpm'];
         
         // For Dose & Dose Rate
         
         const doseRateUnits_ordered = ['µrem/hr', 'mrem/hr', 'rem/hr', 'R/hr', 'µSv/hr', 'mSv/hr', 'Sv/hr'];
         const doseUnits_ordered = ['µrem', 'mrem', 'rem', 'R', 'µSv', 'mSv', 'Sv'];
         
         // For Distance & Dimensions
         
         const distanceUnits_ordered = ['mm', 'cm', 'm', 'in', 'ft', 'km'];
         const areaUnits_ordered = ['cm²', 'm²', 'in²', 'ft²', 'barn'];
         
         // For Time
         
         const timeUnits_ordered = ['seconds', 'minutes', 'hours', 'days', 'years'];
         const longTimeUnits_ordered = ['seconds', 'minutes', 'hours', 'days', 'years', 'kiloyears', 'megayears', 'gigayears'];
         
         // For Mass
         
         const massUnits_ordered = ['µg', 'mg', 'g', 'kg'];
         
         // For Shipping (TBq based)
         
         const shippingActivityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'TBq', 'µCi', 'mCi', 'Ci'];
         
         // For Radioactive Concentration
         
         const concentrationUnits_ordered = ['Bq/L', 'pCi/L', 'Bq/m³', 'µCi/mL'];
         
         /**
         * Takes a raw value in a base unit and formats it into the most "sensible"
         * larger or smaller unit for display.
         * @param {number} value - The raw numerical value.
         * @param {string} unitType - The type of unit (e.g., 'doseRate', 'distance').
         * @param {number} [precision=3] - The number of significant figures to use.
         * @returns {{value: string, unit: string}} An object with the formatted value and the chosen unit.
         */
         
         const formatSensibleUnit = (value, unitType, precision = 3) => {
         const config = SENSIBLE_UNIT_CONFIG[unitType];
         if (!config) {
         return { value: value.toPrecision(precision), unit: '' };
         }
         
         for (const unitInfo of config.units) {
         if (Math.abs(value) < unitInfo.threshold) {
             const displayValue = value / unitInfo.factor;
             return {
                 value: displayValue.toPrecision(precision),
                 unit: unitInfo.unit
             };
         }
         }
         
         const largestUnit = config.units[config.units.length - 1];
         return {
         value: (value / largestUnit.factor).toPrecision(precision),
         unit: largestUnit.unit
         };
         };
         
         const THERAPY_NUCLIDES = ['I-131', 'Lu-177', 'Sm-153', 'Ra-223', 'Ho-166', 'Re-186', 'Au-198', 'I-125', 'Cs-137'];
         
         /**
         * Calculates the area of a polygon given its geographical coordinates.
         * @param {L.LatLng[]} latLngs - An array of Leaflet LatLng objects.
         * @returns {number} The area in square meters.
         */
         const calculatePolygonArea = (latLngs) => {
         if (!latLngs || latLngs.length === 0 || latLngs[0].length < 3) return 0;
         
         const points = latLngs[0];
         const earthRadius = 6378137; // Earth's radius in meters
         let area = 0;
         
         for (let i = 0; i < points.length; i++) {
         const j = (i + 1) % points.length;
         const xi = points[i].lng * Math.PI / 180;
         const yi = points[i].lat * Math.PI / 180;
         const xj = points[j].lng * Math.PI / 180;
         const yj = points[j].lat * Math.PI / 180;
         
         area += (xj - xi) * (2 + Math.sin(yi) + Math.sin(yj));
         }
         return Math.abs(area * earthRadius * earthRadius / 2.0);
         }; 
         
         /**
         * Calculates the distance between two lat lng points in meters using the Haversine formula.
         * @param {{lat: number, lng: number}} p1 - The first point.
         * @param {{lat: number, lng: number}} p2 - The second point.
         * @returns {number} The distance in meters.
         */
         
         const calculateDistance = (p1, p2) => {
         const R = 6371e3; // Earth's radius in meters
         const phi1 = p1.lat * Math.PI / 180;
         const phi2 = p2.lat * Math.PI / 180;
         const deltaPhi = (p2.lat - p1.lat) * Math.PI / 180;
         const deltaLambda = (p2.lng - p1.lng) * Math.PI / 180;
         
         const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
              Math.cos(phi1) * Math.cos(phi2) *
              Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
         const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
         
         return R * c;
         };
         
const REG_GUIDE_1_86_LIMITS = {
    'transuranics': { removable: 20, total: 100, label: 'Transuranics & other high-toxicity alpha emitters' },
    'u_nat': { removable: 1000, total: 5000, label: 'U-nat, U-235, U-238, and associated decay products' },
    'beta_gamma': { removable: 1000, total: 5000, label: 'Beta-gamma emitters (nuclides with decay modes other than alpha)' }
};
         
         const ANSI_13_12_LIMITS = {
         'alpha_very_high': { removable: 20, total: 100, label: 'Alpha Emitters (Very High Hazard - e.g., Pu-238, Am-241)' },
         'alpha_high': { removable: 200, total: 1000, label: 'Alpha Emitters (High Hazard - e.g., U-233, U-234)' },
         'beta_low_risk': { removable: 20000, total: 100000, label: 'Low-Hazard Beta Emitters (e.g., H-3, C-14)' },
         'beta_gamma': { removable: 2000, total: 10000, label: 'Other Beta-Gamma Emitters' }
         };
         
         /**
          * Half-Value Layer (HVL) data in cm for common gamma emitters and materials.
          * Source: Approximate values from various health physics resources.
          */
         
         const HVL_DATA = {
         'Am-241': { 'Lead': 0.02, 'Steel': 0.8, 'Concrete': 2.3, 'Aluminum': 1.5, 'Water': 4.2, sourceRef: 'rse' },
         'Au-198': { 'Lead': 0.33, 'Steel': 1.4, 'Concrete': 4.7, 'Aluminum': 2.5, 'Water': 6.8, sourceRef: 'rse' },
         'Ba-133': { 'Lead': 0.29, 'Steel': 1.2, 'Concrete': 4.1, 'Aluminum': 2.2, 'Water': 5.8, sourceRef: 'rse' },
         'Co-60':  { 'Lead': 1.2, 'Tungsten': 0.7, 'Steel': 2.1, 'Concrete': 6.0, 'Aluminum': 4.8, 'Water': 11.0, sourceRef: 'rse' },
         'Cs-137': { 'Lead': 0.65, 'Steel': 1.6, 'Concrete': 4.8, 'Aluminum': 3.0, 'Water': 8.0, sourceRef: 'rse' },
         'Eu-152': { 'Lead': 1.0,  'Steel': 2.0, 'Concrete': 5.8, 'Aluminum': 4.5, 'Water': 10.5, sourceRef: 'rse' },
         'Ga-67':  { 'Lead': 0.07, 'Steel': 0.8, 'Concrete': 3.0, 'Aluminum': 1.5, 'Water': 4.8, sourceRef: 'rse' },
         'I-125':  { 'Lead': 0.002,'Steel': 0.1, 'Concrete': 1.9, 'Aluminum': 0.6, 'Water': 1.8, sourceRef: 'rse' },
         'I-131':  { 'Lead': 0.3,  'Steel': 1.2, 'Concrete': 4.0, 'Aluminum': 2.2, 'Water': 6.0, sourceRef: 'rse' },
         'Ir-192': { 'Lead': 0.33, 'Steel': 1.3, 'Concrete': 4.3, 'Aluminum': 2.1, 'Water': 6.1, sourceRef: 'rse' },
         'Mn-54':  { 'Lead': 0.8,  'Steel': 1.8, 'Concrete': 5.2, 'Aluminum': 3.6, 'Water': 9.0, sourceRef: 'rse' },
         'Mo-99':  { 'Lead': 0.7,  'Steel': 1.7, 'Concrete': 5.0, 'Aluminum': 3.1, 'Water': 8.2, sourceRef: 'rse' },
         'Na-22':  { 'Lead': 1.1,  'Steel': 2.0, 'Concrete': 5.8, 'Aluminum': 4.5, 'Water': 10.2, sourceRef: 'rse' },
         'Na-24':  { 'Lead': 1.5,  'Steel': 2.5, 'Concrete': 7.2, 'Aluminum': 6.1, 'Water': 14.5, sourceRef: 'rse' },
         'Ra-226': { 'Lead': 1.4, 'Steel': 2.3, 'Concrete': 6.9, 'Aluminum': 5.5, 'Water': 13.0, sourceRef: 'rse' },
         'Sc-46':  { 'Lead': 1.0,  'Steel': 2.0, 'Concrete': 5.9, 'Aluminum': 4.2, 'Water': 10.0, sourceRef: 'rse' },
         'Tc-99m': { 'Lead': 0.03, 'Steel': 0.3, 'Concrete': 2.2, 'Aluminum': 0.8, 'Water': 4.6, sourceRef: 'rse' }
         };
         
         // New constant for Buildup Factor approximations
         
         const BUILDUP_K_FACTORS = {
         'Water': 0.40,
         'Concrete': 0.35,
         'Aluminum': 0.30,
         'Steel': 0.25,
         'Tungsten': 0.15,
         'Lead': 0.10,
         };
         
         const SHIELDING_MATERIALS = {
         'Plastic': { Z: 6, density: 1.18 }, // Using Carbon for approximation
         'Aluminum': { Z: 13, density: 2.70 },
         'Steel': { Z: 26, density: 7.85 }, // Using Iron for approximation
         'Lead': { Z: 82, density: 11.34 },
         'Water': { Z: 8, density: 1.00 }, // Using Oxygen for approximation
         'Concrete': { Z: 11.3, density: 2.35 } // Weighted average of common elements
         };
         
         //==============================================================================
         // --- CORE DATA
         //==============================================================================
         
         /**
          * Defines the primary natural decay chains. Each object represents a series
          * and contains an array of steps in its decay chain.
          */
         
         const decaySeriesData = [
             {
                 id: 'U-238-series',
                 name: 'Uranium-238 Decay Series (Uranium Series)',
                 startNuclide: 'Uranium-238',
                 chain: [
                     { nuclide: 'Uranium-238', decayType: 'Alpha', halfLife: '4.468 billion years', daughter: 'Thorium-234' },
                     { nuclide: 'Thorium-234', decayType: 'Beta-minus', halfLife: '24.10 days', daughter: 'Protactinium-234m' },
                     { nuclide: 'Protactinium-234m', decayType: 'Beta-minus', halfLife: '1.17 minutes', daughter: 'Uranium-234' },
                     { nuclide: 'Uranium-234', decayType: 'Alpha', halfLife: '245,500 years', daughter: 'Thorium-230' },
                     { nuclide: 'Thorium-230', decayType: 'Alpha', halfLife: '75,400 years', daughter: 'Radium-226' },
                     { nuclide: 'Radium-226', decayType: 'Alpha', halfLife: '1600 years', daughter: 'Radon-222' },
                     { nuclide: 'Radon-222', decayType: 'Alpha', halfLife: '3.82 days', daughter: 'Polonium-218' },
                     { nuclide: 'Polonium-218', decayType: 'Alpha', halfLife: '3.1 minutes', daughter: 'Lead-214' },
                     { nuclide: 'Lead-214', decayType: 'Beta-minus', halfLife: '26.8 minutes', daughter: 'Bismuth-214' },
                     { nuclide: 'Bismuth-214', decayType: 'Beta-minus', halfLife: '19.9 minutes', daughter: 'Polonium-214' },
                     { nuclide: 'Polonium-214', decayType: 'Alpha', halfLife: '164.3 microseconds', daughter: 'Lead-210' },
                     { nuclide: 'Lead-210', decayType: 'Beta-minus', halfLife: '22.2 years', daughter: 'Bismuth-210' },
                     { nuclide: 'Bismuth-210', decayType: 'Beta-minus', halfLife: '5.012 days', daughter: 'Polonium-210' },
                     { nuclide: 'Polonium-210', decayType: 'Alpha', halfLife: '138.376 days', daughter: 'Lead-206' },
                     { nuclide: 'Lead-206', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                 ]
             },
         
         {
             id: 'Th-232-series',
             name: 'Thorium-232 Decay Series (Thorium Series)',
             startNuclide: 'Thorium-232',
             chain: [
                 { nuclide: 'Thorium-232', decayType: 'Alpha', halfLife: '14.05 billion years', daughter: 'Radium-228' },
                 { nuclide: 'Radium-228', decayType: 'Beta-minus', halfLife: '5.75 years', daughter: 'Actinium-228' },
                 { nuclide: 'Actinium-228', decayType: 'Beta-minus', halfLife: '6.15 hours', daughter: 'Thorium-228' },
                 { nuclide: 'Thorium-228', decayType: 'Alpha', halfLife: '1.913 years', daughter: 'Radium-224' },
                 { nuclide: 'Radium-224', decayType: 'Alpha', halfLife: '3.63 days', daughter: 'Radon-220' },
                 { nuclide: 'Radon-220', decayType: 'Alpha', halfLife: '55.6 seconds', daughter: 'Polonium-216' },
                 { nuclide: 'Polonium-216', decayType: 'Alpha', halfLife: '0.145 seconds', daughter: 'Lead-212' },
                 { nuclide: 'Lead-212', decayType: 'Beta-minus', halfLife: '10.64 hours', daughter: 'Bismuth-212' },
                 {
                     nuclide: 'Bismuth-212',
                     decayType: 'Beta-minus (64.1%) / Alpha (35.9%)',
                     halfLife: '60.55 minutes',
         daughter: 'Polonium-212 / Thallium-208',
                     branches: [
                         [ // Path 1: Beta decay
                             { nuclide: 'Polonium-212', decayType: 'Alpha', halfLife: '0.299 microseconds', daughter: 'Lead-208' },
                             { nuclide: 'Lead-208', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                         ],
                         [ // Path 2: Alpha decay
                             { nuclide: 'Thallium-208', decayType: 'Beta-minus', halfLife: '3.053 minutes', daughter: 'Lead-208' },
                             { nuclide: 'Lead-208', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                         ]
                     ]
                 }
             ]
         },
             {
                 id: 'U-235-series',
                 name: 'Uranium-235 Decay Series (Actinium Series)',
                 startNuclide: 'Uranium-235',
                 chain: [
                     { nuclide: 'Uranium-235', decayType: 'Alpha', halfLife: '703.8 million years', daughter: 'Thorium-231' },
                     { nuclide: 'Thorium-231', decayType: 'Beta-minus', halfLife: '25.5 hours', daughter: 'Protactinium-231' },
                     { nuclide: 'Protactinium-231', decayType: 'Alpha', halfLife: '32,760 years', daughter: 'Actinium-227' },
                     { nuclide: 'Actinium-227', decayType: 'Beta-minus', halfLife: '21.77 years', daughter: 'Thorium-227' },
                     { nuclide: 'Thorium-227', decayType: 'Alpha', halfLife: '18.72 days', daughter: 'Radium-223' },
                     { nuclide: 'Radium-223', decayType: 'Alpha', halfLife: '11.43 days', daughter: 'Radon-219' },
                     { nuclide: 'Radon-219', decayType: 'Alpha', halfLife: '3.96 seconds', daughter: 'Polonium-215' },
                     { nuclide: 'Polonium-215', decayType: 'Alpha', halfLife: '1.78 milliseconds', daughter: 'Lead-211' },
         { nuclide: 'Lead-211', decayType: 'Beta-minus', halfLife: '36.1 minutes', daughter: 'Bismuth-211' },
         {
         nuclide: 'Bismuth-211',
         decayType: 'Alpha (99.72%) / Beta-minus (0.28%)',
         halfLife: '2.14 minutes',
         daughter: 'Thallium-207 / Polonium-211',
         branches: [
            [ // Path 1: Alpha decay
                { nuclide: 'Thallium-207', decayType: 'Beta-minus', halfLife: '4.77 minutes', daughter: 'Lead-207' },
                { nuclide: 'Lead-207', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
            ],
            [ // Path 2: Beta decay
                { nuclide: 'Polonium-211', decayType: 'Alpha', halfLife: '0.516 seconds', daughter: 'Lead-207' },
                { nuclide: 'Lead-207', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
            ]
         ]
         }
                 ]
             },
             {
                 id: 'Ra-226-series',
                 name: 'Radium-226 Decay Series',
                 startNuclide: 'Radium-226',
                 chain: [
                     { nuclide: 'Radium-226', decayType: 'Alpha', halfLife: '1600 years', daughter: 'Radon-222' },
                     { nuclide: 'Radon-222', decayType: 'Alpha', halfLife: '3.82 days', daughter: 'Polonium-218' },
                     { nuclide: 'Polonium-218', decayType: 'Alpha', halfLife: '3.1 minutes', daughter: 'Lead-214' },
                     { nuclide: 'Lead-214', decayType: 'Beta-minus', halfLife: '26.8 minutes', daughter: 'Bismuth-214' },
                     { nuclide: 'Bismuth-214', decayType: 'Beta-minus', halfLife: '19.9 minutes', daughter: 'Polonium-214' },
                     { nuclide: 'Polonium-214', decayType: 'Alpha', halfLife: '164.3 microseconds', daughter: 'Lead-210' },
                     { nuclide: 'Lead-210', decayType: 'Beta-minus', halfLife: '22.2 years', daughter: 'Bismuth-210' },
                     { nuclide: 'Bismuth-210', decayType: 'Beta-minus', halfLife: '5.012 days', daughter: 'Polonium-210' },
                     { nuclide: 'Polonium-210', decayType: 'Alpha', halfLife: '138.376 days', daughter: 'Lead-206' },
                     { nuclide: 'Lead-206', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                 ]
             },
             {
                 id: 'Np-237-series',
                 name: 'Neptunium-237 Decay Series (Artificial)',
                 startNuclide: 'Neptunium-237',
                 chain: [
                     { nuclide: 'Neptunium-237', decayType: 'Alpha', halfLife: '2.14 million years', daughter: 'Protactinium-233' },
                     { nuclide: 'Protactinium-233', decayType: 'Beta-minus', halfLife: '27.0 days', daughter: 'Uranium-233' },
                     { nuclide: 'Uranium-233', decayType: 'Alpha', halfLife: '159,200 years', daughter: 'Thorium-229' },
                     { nuclide: 'Thorium-229', decayType: 'Alpha', halfLife: '7,340 years', daughter: 'Radium-225' },
                     { nuclide: 'Radium-225', decayType: 'Beta-minus', halfLife: '14.9 days', daughter: 'Actinium-225' },
                     { nuclide: 'Actinium-225', decayType: 'Alpha', halfLife: '9.92 days', daughter: 'Francium-221' },
                     { nuclide: 'Francium-221', decayType: 'Alpha', halfLife: '4.8 minutes', daughter: 'Astatine-217' },
                     { nuclide: 'Astatine-217', decayType: 'Alpha', halfLife: '32.3 milliseconds', daughter: 'Bismuth-213' },
                     { nuclide: 'Bismuth-213', decayType: 'Beta-minus', halfLife: '45.6 minutes', daughter: 'Polonium-213' },
                     { nuclide: 'Polonium-213', decayType: 'Alpha', halfLife: '4.2 microseconds', daughter: 'Lead-209' },
                     { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                     { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                     { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                 ]
             },
             {
                 id: 'Ac-225-series',
                 name: 'Actinium-225 (Medical Alpha Generator)',
                 startNuclide: 'Actinium-225',
                 chain: [
                     { nuclide: 'Actinium-225', decayType: 'Alpha', halfLife: '9.92 days', daughter: 'Francium-221' },
                     { nuclide: 'Francium-221', decayType: 'Alpha', halfLife: '4.8 minutes', daughter: 'Astatine-217' },
                     { nuclide: 'Astatine-217', decayType: 'Alpha', halfLife: '32.3 milliseconds', daughter: 'Bismuth-213' },
                     { nuclide: 'Bismuth-213', decayType: 'Beta-minus', halfLife: '45.6 minutes', daughter: 'Polonium-213' },
                     { nuclide: 'Polonium-213', decayType: 'Alpha', halfLife: '4.2 microseconds', daughter: 'Lead-209' },
                     { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                     { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                     { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                 ]
             }
         ];
         
         /**
          * A comprehensive list of radionuclides pulled from the initial table above.
          */
         
         const radionuclides = RADIONUCLIDE_DATA;
         
         //==============================================================================
         // --- UTILITY & PARSER FUNCTIONS
         //==============================================================================
         
         /**
          * Normalizes a string by converting it to lowercase and removing spaces and hyphens.
          * @param {string} str - The input string.
          * @returns {string} The normalized string.
          */
         
         const normalizeString = (str) => (typeof str === 'string' ? str.toLowerCase().replace(/[^a-z0-9]/g, '') : '');
         
         /**
          * @description Creates a formatted string of key info for a nuclide tooltip.
          * @param {object} nuclide - The nuclide object.
          * @returns {string} A formatted string with half-life and emission types.
          */
         
         const generateQuickInfoText = (nuclide) => {
             if (!nuclide) return '';
             const halfLife = `Half-life: ${formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)))}`;
             const emissions = `Emissions: ${(nuclide.emissionType || []).join(', ')}`;
             return `${halfLife} | ${emissions}`;
         };
         
         /**
          * Implements the Bateman equations for a full decay series, including branching decays.
          * It iteratively builds an analytical solution for each nuclide as a sum of exponential terms.
          * @param {Array<object>} chain - The array of nuclide objects in the decay series.
          * @param {number} A1_0 - The initial activity of the parent nuclide.
          * @param {number} t_seconds - The elapsed time in seconds.
          * @returns {Array<number>} An array of activities for each nuclide in the chain at time t.
          */
         
         const runBatemanWithBranching = (chain, A1_0, t_seconds) => {
             const nuclideMap = new Map();
         
             // 1. Pre-process the chain into a graph-like map for easy lookup.
         
             chain.forEach(step => {
                 const lambda = parseHalfLifeToSeconds(step.halfLife) === Infinity ? 0 : Math.log(2) / parseHalfLifeToSeconds(step.halfLife);
                 if (!nuclideMap.has(step.nuclide)) {
                     nuclideMap.set(step.nuclide, { name: step.nuclide, lambda, parents: [], solution: [] });
                 } else {
                     nuclideMap.get(step.nuclide).lambda = lambda;
                 }
         
                 if (step.daughter !== 'N/A') {
                     const decayTypes = step.decayType.split(' / ').map(s => s.trim());
                     const daughters = step.daughter.split(' / ').map(s => s.trim());
                     daughters.forEach((daughterName, i) => {
                         // Extract branching ratio if present, e.g., "Beta-minus (64.1%)"
                         const match = decayTypes[i] ? decayTypes[i].match(/\(([\d.]+)%\)/) : null;
                         const br = match ? parseFloat(match[1]) / 100.0 : 1.0;
         
                         if (!nuclideMap.has(daughterName)) {
                             nuclideMap.set(daughterName, { name: daughterName, lambda: 0, parents: [], solution: [] });
                         }
                         nuclideMap.get(daughterName).parents.push({ name: step.nuclide, br: br });
                     });
                 }
             });
         
             // 2. Iteratively build the analytical solution for each nuclide.
         
             for (const step of chain) {
                 const nuclideName = step.nuclide;
                 const nuclide = nuclideMap.get(nuclideName);
         
                 if (nuclide.parents.length === 0) { // This is the root parent
                     if (nuclide.lambda === 0) continue;
                     const N0 = A1_0 / nuclide.lambda;
                     nuclide.solution.push({ coeff: N0, lambda: nuclide.lambda });
                 } else {
                     const solutionMap = new Map(); // Used to consolidate terms
                     for (const parent of nuclide.parents) {
                         const parentNuclide = nuclideMap.get(parent.name);
                         for (const term of parentNuclide.solution) {
                             const C = parent.br * parentNuclide.lambda * term.coeff;
         
                             // Handle the case where decay constants are identical (or very close)
         
                             if (Math.abs(nuclide.lambda - term.lambda) < 1e-20) {
         
                                 // This case leads to a t*e^(-lambda*t) term, which complicates the solution structure.
                                 // For simplicity and to avoid a full rewrite, we'll approximate by introducing a tiny difference.
                                 // This is a common numerical stability trick.
         
                                 term.lambda *= (1 + 1e-10);
                             }
         
                             const coeff = C / (nuclide.lambda - term.lambda);
                             // Add the two new terms to the solution map, consolidating as we go
                             solutionMap.set(term.lambda, (solutionMap.get(term.lambda) || 0) + coeff);
                             solutionMap.set(nuclide.lambda, (solutionMap.get(nuclide.lambda) || 0) - coeff);
                         }
                     }
                     // Convert the map back to the solution array format
                     nuclide.solution = Array.from(solutionMap, ([lambda, coeff]) => ({ lambda, coeff }));
                 }
             }
         
             // 3. Calculate the final activities at the specified time.
         
             const finalActivities = [];
             for (const step of chain) {
                 const nuclide = nuclideMap.get(step.nuclide);
                 if (nuclide.lambda === 0) {
                     finalActivities.push(0);
                     continue;
                 }
                 let N_t = 0;
                 for (const term of nuclide.solution) {
                     N_t += term.coeff * Math.exp(-term.lambda * t_seconds);
                 }
                 const A_t = N_t * nuclide.lambda;
                 finalActivities.push(A_t > 0 ? A_t : 0); // Ensure no negative activities from floating point errors
             }
             return finalActivities;
         };
         
         /**
          * Flattens a potentially nested decay chain into a simple, unique list of nuclides
          * for the Bateman calculator.
          * @param {Array<object>} chain - The potentially nested chain data.
          * @returns {Array<object>} A flat array of unique nuclide steps.
          */
         
         const flattenChainForCalculator = (chain) => {
             const seen = new Set();
             const flatChain = [];
         
             function recurse(steps) {
                 if (!steps) return;
                 for (const step of steps) {
                     if (!seen.has(step.nuclide)) {
                         flatChain.push(step);
                         seen.add(step.nuclide);
                     }
                     if (step.branches) {
                         step.branches.forEach(branch => recurse(branch));
                     }
                 }
             }
         
             recurse(chain);
             return flatChain;
         };
         
         /**
         * Formats a number for compact display on mobile screens.
         * Rounds to 3 significant figures and handles special cases.
         * @param {number} num - The number to format.
         * @returns {string} The compacted, formatted string.
         */
         
         const formatForMobile = (num) => {
         if (num === null || num === undefined || isNaN(num) || num === Infinity) return 'N/A';
         if (num === 0) return '0';
         return num.toPrecision(3);
         };
         
         /**
          * Parses a half-life string (e.g., "1600 years") into a total number of seconds.
          * Handles various units, scientific notation, and the "Stable" keyword.
          * @param {string} halfLifeStr - The half-life string to parse.
          * @returns {number} The half-life in seconds, or Infinity for "Stable".
          */
         
         const parseHalfLifeToSeconds = (halfLifeStr) => {
         if (!halfLifeStr || halfLifeStr.toLowerCase() === 'stable') return Infinity;
         
         const match = halfLifeStr.trim().match(/^(.*?)\s*([a-zA-Zμµ]+.*)$/);
         let numericStr, unitStr;
         if (match) {
         numericStr = match[1].trim();
         unitStr = match[2].trim();
         } else {
         numericStr = halfLifeStr.trim();
         unitStr = '';
         }
         
         let value;
         const sciNotationRegex = /([\d.,]+)\s*x\s*10\^?([⁻⁺\-−\d⁰¹²³⁴⁵⁶⁷⁸⁹]+)/i;
         const sciMatch = numericStr.match(sciNotationRegex);
         
         if (sciMatch) {
         const mantissa = parseFloat(sciMatch[1].replace(/,/g, ''));
         const exponentStr = sciMatch[2];
         const superToRegularMap = { '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9', '⁺': '+', '⁻': '-', '−': '-' };
         const regularExponentStr = [...exponentStr].map(char => superToRegularMap[char] || char).join('');
         const exponent = parseInt(regularExponentStr);
         if (!isNaN(mantissa) && !isNaN(exponent)) {
             value = mantissa * Math.pow(10, exponent);
         }
         } else {
         value = parseFloat(numericStr.replace(/,/g, ''));
         }
         
         if (isNaN(value)) return 0;
         
         const unit = unitStr.toLowerCase();
         const unitMultipliers = {
         'billion years': 3.15576e16,
         'million years': 3.15576e13,
         'kiloyears': 3.15576e10, // Note: The data does not contain this unit, but the logic is ready for it.
         'years': 31557600,
         'year': 31557600,
         'days': 86400,
         'day': 86400,
         'hours': 3600,
         'hour': 3600,
         'minutes': 60,
         'minute': 60,
         'seconds': 1,
         'second': 1,
         's': 1,
         'milliseconds': 1e-3,
         'millisecond': 1e-3,
         'microseconds': 1e-6,
         'microsecond': 1e-6,
         };
         
         // Sort keys by length in descending order to match 'billion years' before 'years'
         
         const sortedKeys = Object.keys(unitMultipliers).sort((a, b) => b.length - a.length);
         
         for (const key of sortedKeys) {
         if (unit.startsWith(key)) {
             return value * unitMultipliers[key];
         }
         }
         return value;
         };
         
         const getHalfLifeCategory = (seconds) => {
             if (seconds === Infinity) return { label: 'Stable', color: 'text-slate-500 dark:text-slate-400' };
             if (seconds < 3600) return { label: 'Very Short', color: 'text-red-500' }; // < 1 Hour
             if (seconds < 86400 * 2) return { label: 'Short', color: 'text-amber-500' }; // < 2 Days
             if (seconds < 31557600 * 10) return { label: 'Medium', color: 'text-sky-500' }; // < 10 Years
             if (seconds < 31557600 * 1000000) return { label: 'Long', color: 'text-indigo-500' }; // < 1 Million Years
             return { label: 'Geological', color: 'text-purple-500' };
         };
         
         /*
         * Parses a string to standardize its numeric part into "e" notation if it's very large or small.
         * Handles multiple formats: "1.23 x 10^4", "1.23 x 10⁻⁴", "4,059", and "0.0123".
         * @param {string} str - The input string (e.g., "1.55 x 10⁻¹⁰ year⁻¹").
         * @returns {string} The formatted string with standardized notation.
         */
         
         const standardizeScientificDisplay = (str) => {
         if (typeof str !== 'string' || !str) return str;
         
         // A map to convert unicode superscripts and minus signs to standard characters.
         
         const superToRegularMap = { '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9', '⁺': '+', '⁻': '-', '−': '-' };
         
         // Regex to capture the mantissa, exponent (in any format), and any trailing units.
         
         const sciNotationRegex = /([\d.,]+)\s*x\s*10\^?([⁻⁺\-−\d⁰¹²³⁴⁵⁶⁷⁸⁹]+)\s*(.*)/;
         const sciMatch = str.match(sciNotationRegex);
         
         if (sciMatch) {
         const mantissa = parseFloat(sciMatch[1].replace(/,/g, ''));
         const exponentStr = sciMatch[2];
         const units = sciMatch[3] || '';
         
         const regularExponentStr = [...exponentStr].map(char => superToRegularMap[char] || char).join('');
         const exponent = parseInt(regularExponentStr);
         
         if (isNaN(mantissa) || isNaN(exponent)) return str;
         
         const numericValue = mantissa * Math.pow(10, exponent);
         return `${numericValue.toExponential(2)} ${units}`.trim();
         }
         
         // If not in scientific notation, handle it as a plain number.
         
         const plainNumberRegex = /^([-\d.,]+)(.*)/;
         const plainMatch = str.match(plainNumberRegex);
         if (plainMatch) {
         const numberPart = plainMatch[1].replace(/,/g, '');
         const units = plainMatch[2] || '';
         const numericValue = parseFloat(numberPart);
         if (isNaN(numericValue)) return str;
         
         const absValue = Math.abs(numericValue);
         if (numericValue === 0) return `0 ${units}`.trim();
         
         // Use exponential notation for very large or very small numbers.
         
         if (absValue > 10000 || absValue < 0.001) {
             return `${numericValue.toExponential(2)} ${units}`.trim();
         }
         // For other numbers, use a fixed precision.
         
         return `${numericValue.toPrecision(3)} ${units}`.trim();
         }
         
         return str;
         };
         
         /**
          * Determines the most appropriate human-readable unit for a given duration in seconds.
          * @param {number} seconds - The duration in seconds.
          * @returns {string} The most fitting unit ('years', 'days', 'hours', 'minutes', or 'seconds').
          */
         
         	const getBestHalfLifeUnit = (seconds) => {
             	if (seconds === Infinity) return 'years';
         
             const secondsInMinute = 60;
             const secondsInHour = 3600;
             const secondsInDay = 86400;
             const secondsInYear = 31557600; // 365.25 days
         
             if (seconds >= secondsInYear) return 'years';
             if (seconds >= secondsInDay) return 'days';
             if (seconds >= secondsInHour) return 'hours';
             if (seconds >= secondsInMinute) return 'minutes';
             return 'seconds';
         };
         
         /**
          * Formats a half-life string into a specified target unit with appropriate precision.
          * @param {string} halfLifeStr - The original half-life string (e.g., "1.25 billion years").
          * @param {string} targetUnit - The desired unit for the output (e.g., 'years', 'days').
          * @returns {string} The formatted half-life string (e.g., "1.25e+9 years").
          */
         
         const formatHalfLife = (halfLifeStr, targetUnit) => {
         const seconds = parseHalfLifeToSeconds(halfLifeStr);
         
         if (seconds === Infinity) return 'Stable';
         if (seconds === 0 || !halfLifeStr) return 'N/A';
         
         const unitConversions = {
         'seconds': 1,
         'minutes': 60,
         'hours': 3600,
         'days': 86400,
         'years': 31557600,
         'kiloyears': 3.15576e10, // Use standardized scientific notation
         'megayears': 3.15576e13,
         'gigayears': 3.15576e16,
         };
         
         const value = seconds / unitConversions[targetUnit];
         
         // Use the existing standardization function to format the output
         
         const formattedValue = standardizeScientificDisplay(`${value} ${targetUnit}`);
         
         return formattedValue;
         };
         
         /**
          * Parses an array of energy strings and returns the primary energy value in MeV.
          * Assumes the first entry in the array is the most significant.
          * @param {string[]} energyArray - An array of energy strings (e.g., ["5.3 MeV", "5.2 MeV"]).
          * @returns {number} The energy value in MeV. Returns 0 if input is invalid.
          */
         
         const parseEnergyToMeV = (energyArray) => {
             if (!energyArray || energyArray.length === 0) return 0;
             const energyStr = energyArray[0];
             const parts = energyStr.split(' ');
             let value = parseFloat(parts[0]);
         
             if (isNaN(value)) return 0;
         
             const unit = parts[1]?.toLowerCase();
             if (unit && unit.includes('kev')) return value / 1000; // Convert keV to MeV
             return value;
         };
         
         /**
          * Parses a specific activity string, handling scientific notation (e.g., "3.7 x 10^10 Bq/g").
          * @param {string} saStr - The specific activity string.
          * @returns {number} The parsed specific activity as a number. Returns 0 if input is invalid.
          */
         
         const parseSpecificActivity = (saStr) => {
             if (!saStr) return 0;
             const parts = saStr.toLowerCase().split(' ');
         
             // Check for the specific "x 10^" format.
         
             if (parts.length < 3 || parts[1] !== 'x' || !parts[2].includes('10^')) {
                 return parseFloat(saStr.replace(/,/g, '')); // Fallback for simple numbers.
             }
         
             const value = parseFloat(parts[0]);
             const exponent = parseInt(parts[2].split('^')[1]);
         
             if (isNaN(value) || isNaN(exponent)) return 0;
         
             return value * Math.pow(10, exponent);
         };
         
         
         //==============================================================================
         // --- REACT COMPONENTS & ICONS
         //==============================================================================
         
         /**
          * A simple SVG icon component.
          * @param {{path: string, className?: string}} props - Component props.
          * @param {string} props.path - The SVG path data for the icon.
          * @param {string} [props.className="w-5 h-5"] - Optional CSS classes.
          * @returns {JSX.Element} A React component rendering an SVG icon.
          */
         
         const Icon = ({ path, className = "w-5 h-5" }) => (
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                 <path d={path} />
             </svg>
         );
         
         /**
          * A mapping of icon names to their corresponding SVG path data.
          */
         
         const ICONS = {
         
         // Standard UI Icons
         
         copy: "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-2-.9-2-2-2zm0 16H8V7h11v14z",
         check: "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z",
         search: "M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A8 8 0 1 0 10 18zm0-14a6 6 0 1 1-6 6 6 6 0 0 1 6-6z",
         help: "M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z",
         clear: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
         filter: "M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z",
         settings: "M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-2 11h4v-3h2v-2h-2v-2h-4v2h-2v2h2v3zm-4-7c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm8 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-4 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z",
	 popOut: "M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z",    

         northArrow: "M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z",    

 
         // Theme Icons
         
         sun: "M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zm-9-8c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zm0 16c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zM5.64 6.36c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 3.54c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41L5.64 6.36zm12.72 12.72c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41zM4.22 18.36c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41zM18.36 4.22c-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0z",
         moon: "M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-3.26-1.46-5.41-4.56-5.41-8.19 0-3.63 2.15-6.73 5.41-8.19A8.96 8.96 0 0012 3z",
         
         // Thematic Tool Icons
         
         home: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z",
         database: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z",
         compare: "M9.01 14H2v2h7.01v3L13 15l-3.99-4v3zm5.98-12H22v2h-7.01v3L11 3l3.99 4V4z",
         calculator: "M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-2-.9-2-2-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm4 8H10v-2h2v2zm0-4H10v-2h2v2zm0-4H10V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z",
         converter: "M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z",
         hourglass: "M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2H6z", // Half-life
         radioactive: "M12 2a9.97 9.97 0 0 0-5.49 1.76L12 15.35l5.49-11.59A9.97 9.97 0 0 0 12 2zm-9.24 9a10.016 10.016 0 0 0 14.48 0L12 17.65l-9.24-6.65zM4.93 16.24l-2.17-1.45A10.003 10.003 0 0 0 12 22a10.003 10.003 0 0 0 9.24-7.21l-2.17 1.45L12 19.35l-7.07-3.11z",
         activity: "M12 2a9.97 9.97 0 0 0-5.49 1.76L12 15.35l5.49-11.59A9.97 9.97 0 0 0 12 2zm-9.24 9a10.016 10.016 0 0 0 14.48 0L12 17.65l-9.24-6.65zM4.93 16.24l-2.17-1.45A10.003 10.003 0 0 0 12 22a10.003 10.003 0 0 0 9.24-7.21l-2.17 1.45L12 19.35l-7.07-3.11z", // Using trefoil for activity
         specificActivity: "M10 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 2c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm4-5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H4V7h16v10z", // Icon representing branching paths/emissions
         radon: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4H9V8h4V4h2v4h4v4h-4v4zm-1-8V4h-2v4h-2v2h2v4h2v-4h2v-2h-4z",
         doseRate: "M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H12v-2l-4 4 4 4v-2h9.5c.28 0 .5-.22.5-.5.01-2.09-1.26-3.87-3.15-4.96z", // Gauge icon
         shield: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z", // Renamed from doseRate
         mass: "M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm10 16H4V8h16v12z",
         series: "M21 8H3V6h18v2zm0 4H3v2h18v-2zm0 6H3v2h18v-2z",
         stopwatch: "M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.98-1.41-1.41l-1.42 1.42A8.962 8.962 0 0012 4c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-1.68-.46-3.24-1.25-4.55l.22-.16zm-1.07-1.01A6.995 6.995 0 115.34 19.66 6.995 6.995 0 0117.96 6.38z",
         transport: "M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z",
         internalDose: "M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z",
         neutron: "M21 10.78V8c0-1.65-1.35-3-3-3h-1V3c0-.55-.45-1-1-1s-1 .45-1 1v2h-4V3c0-.55-.45-1-1-1s-1 .45-1 1v2H8c-1.65 0-3 1.35-3 3v2.78c-.61.55-1 1.34-1 2.22v6c0 1.65 1.35 3 3 3h10c1.65 0 3-1.35 3-3v-6c0-.88-.39-1.67-1-2.22zM9 19H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm2-7h-2v-2h2v2z",
         medical: "M18 10.5V6H6v4.5c-1.1 0-2 .9-2 2v3c0 1.1.9 2 2 2h1v3h2v-3h8v3h2v-3h1c1.1 0 2-.9 2-2v-3c0-1.1-.9-2-2-2zM8 8h8v2H8V8zm10 7.5H6v-3h12v3zM11 2h2v2h-2z",
         labStats: "M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z",
         gammaSpec: "M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z",
         notepad: "M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z",
         scientificCalculator: "M7 21a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2H7zm2-2h6v-2H9v2zm0-4h6v-2H9v2zm4-4h2v-2h-2v2zm-4 0h2v-2H9v2zM7 7h10V5H7v2z",
         references: "M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"
         };
         
         //==============================================================================
         // --- GLOBAL SETTINGS & CONTEXT
         //==============================================================================
         
         const SettingsContext = React.createContext();
         
         
const SettingsProvider = ({ children }) => {
    // UPDATED: Default settings now only contain the theme.
    const defaultSettings = {
        theme: 'system', // 'light', 'dark', or 'system'
    };

    const [settings, setSettings] = React.useState(() => {
        try {
            const saved = localStorage.getItem('rad_tool_settings');
            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
        } catch (e) {
            return defaultSettings;
        }
    });

    const updateSettings = (newSettings) => {
        setSettings(prev => {
            const updated = { ...prev, ...newSettings };
            localStorage.setItem('rad_tool_settings', JSON.stringify(updated));
            return updated;
        });
    };

    // This effect to handle the theme remains the same.
    React.useEffect(() => {
        const root = window.document.documentElement;
        if (settings.theme === 'dark') {
            root.classList.add('dark');
        } else if (settings.theme === 'light') {
            root.classList.remove('dark');
        } else { // System theme
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            const handleChange = () => {
                if (mediaQuery.matches) { root.classList.add('dark'); } 
                else { root.classList.remove('dark'); }
            };
            mediaQuery.addEventListener('change', handleChange);
            handleChange(); // Initial check
            return () => mediaQuery.removeEventListener('change', handleChange);
        }
    }, [settings.theme]);

    return (
        // The context now provides a much simpler value.
        <SettingsContext.Provider value={{ settings, updateSettings }}>
            {children}
        </SettingsContext.Provider>
    );
};
         
         const CATEGORY_DESCRIPTIONS = {
         'Medical': 'Used for diagnosis, therapy, or medical research.',
         'Industrial': 'Used in manufacturing, gauging, sterilization, or other industrial processes.',
         'Natural': 'Occurs naturally in the environment or as part of a decay series.',
         'Stable/Reference': 'A stable isotope, often used as a reference or target material.',
         };
         
         const CATEGORY_STYLES = {
         'Medical':    {
         border: 'border-l-sky-400 dark:border-l-sky-600',
         hoverBg: 'hover:bg-sky-50 dark:hover:bg-sky-900/50'
         },
         'Industrial': {
         border: 'border-l-amber-400 dark:border-l-amber-600',
         hoverBg: 'hover:bg-amber-50 dark:hover:bg-amber-900/50'
         },
         'Natural':    {
         border: 'border-l-green-400 dark:border-l-green-600',
         hoverBg: 'hover:bg-green-50 dark:hover:bg-green-900/50'
         },
         'Stable/Reference': {
         border: 'border-l-slate-400 dark:border-l-slate-500',
         hoverBg: 'hover:bg-slate-50 dark:hover:bg-slate-800/50'
         },
         
         // A default style for any other categories
         
         'default': {
         border: 'border-l-slate-300 dark:border-l-slate-600',
         hoverBg: 'hover:bg-slate-50 dark:hover:bg-slate-800/50'
         }
         };
         
         //==============================================================================
         // --- TOAST NOTIFICATION SYSTEM
         // Provides pop-up messages for user feedback (e.g., "Copied to clipboard").
         //==============================================================================
         
         /**
          * @description React Context to provide toast notification functions to any component.
          */
         
         const ToastContext = React.createContext();
         
         /**
          * @description Provider component that manages the state of toast notifications.
          * It renders the toasts and provides a function to add new ones.
          * @param {{children: React.ReactNode}} props - The child components that will have access to the context.
          */
         
const ToastProvider = ({ children }) => {
    const [toasts, setToasts] = React.useState([]);

    const addToast = (message) => {
        const id = Date.now();
        setToasts(prevToasts => [...prevToasts, { id, message }]);
        setTimeout(() => {
            removeToast(id);
        }, 3000);
    };

    const removeToast = (id) => {
        setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id));
    };

    // ADDED: A variable to hold the toast container's JSX
    const toastContainer = (
        <div className="fixed bottom-4 right-4 z-50 space-y-2">
            {toasts.map(toast => (
                <div key={toast.id} className="animate-toast-in bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-800 px-4 py-3 rounded-lg shadow-lg flex items-center">
                    <Icon path={ICONS.check} className="w-5 h-5 mr-3 text-green-400" />
                    <span>{toast.message}</span>
                </div>
            ))}
        </div>
    );

    return (
        <ToastContext.Provider value={{ addToast }}>
            {children}
            
            {/* CHANGED: Use ReactDOM.createPortal to render toasts outside this component's DOM hierarchy */}
            {ReactDOM.createPortal(toastContainer, document.getElementById('toast-root'))}
            
        </ToastContext.Provider>
    );
};
        

/**
 * @description Custom hook that delays updating a value until a specified time
 * has passed without that value changing. This is useful for preventing
 * expensive operations (like API calls or history updates) from running on
 * every keystroke.
 * @param {*} value The value to debounce.
 * @param {number} delay The delay in milliseconds.
 * @returns {*} The debounced value.
 */
const useDebounce = (value, delay) => {
    // State to store the debounced value
    const [debouncedValue, setDebouncedValue] = React.useState(value);

    React.useEffect(() => {
        // Set up a timer to update the debounced value after the delay
        const handler = setTimeout(() => {
            setDebouncedValue(value);
        }, delay);

        // This is the cleanup function that runs every time the dependency [value] changes.
        // It clears the previous timer, effectively resetting it. The timer will only
        // complete if the user stops changing the value for the duration of the delay.
        return () => {
            clearTimeout(handler);
        };
    }, [value, delay]); // Only re-run the effect if value or delay changes

    return debouncedValue;
};


 
         /**
          * @description Custom hook to easily access the toast context's `addToast` function.
          * @returns {{addToast: (message: string) => void}}
          */
         
         const useToast = () => React.useContext(ToastContext);
         
         /**
         * @description Custom hook to manage a list of recent calculations in localStorage.
         * @returns {{addHistory: (item: object) => void}}
         */
         
         const useCalculationHistory = () => {
         const addHistory = React.useCallback((item) => {
         try {
            const history = JSON.parse(localStorage.getItem('rad_tool_calculation_history') || '[]');
            const newHistory = [item, ...history];
            // Keep only the 5 most recent calculations
            const limitedHistory = newHistory.slice(0, 5);
            localStorage.setItem('rad_tool_calculation_history', JSON.stringify(limitedHistory));
         } catch (e) {
            console.error("Failed to update calculation history:", e);
         }
         }, []); // Empty dependency array makes this function stable
         return { addHistory };
         };
         
         //==============================================================================
         // --- REUSABLE UI COMPONENTS
         //==============================================================================
         
         
         /**
          * @description Displays a compact summary of a nuclide's key properties within a calculator.
          * @param {{nuclide: object}} props - The nuclide object to display context for.
          */
         
         const NuclideContextDisplay = ({ nuclide }) => {
             if (!nuclide) return null;
         
             const properties = [
                 {
                     label: 'Half-life',
                     value: formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife))),
                     condition: nuclide.halfLife && nuclide.halfLife !== 'Stable'
                 },
                 {
                     label: 'β Eₘₐₓ',
                     value: (nuclide.emissionEnergies?.beta || [])[0]?.replace(' (max)', ''),
                     condition: nuclide.emissionEnergies?.beta?.length > 0
                 },
         {
                     label: 'β Eₐᵥ₉',
                     value: `${nuclide.avgBetaEnergy} MeV`,
                     condition: nuclide.avgBetaEnergy
                 },
                 {
                     label: 'Γ Constant',
                     value: nuclide.gammaConstant,
                     condition: nuclide.gammaConstant
                 },
                 {
                     label: 'Emissions',
                     value: (nuclide.emissionType || []).join(', '),
                     condition: nuclide.emissionType?.length > 0
                 },
                 {
                     label: 'Specific Activity',
                     value: nuclide.specificActivity,
                     condition: nuclide.specificActivity
                 },
             ];
         
             const availableProperties = properties.filter(p => p.condition);
         
             if (availableProperties.length === 0) return null;
         
             return (
                 <div className="p-3 my-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg animate-fade-in text-xs">
                     <div className={`grid grid-cols-2 gap-x-4 gap-y-1`}>
                         {availableProperties.map(prop => (
                             <div key={prop.label} className="truncate">
                                 <span className="font-semibold text-slate-500 dark:text-slate-400">{prop.label}: </span>
                                 <span className="text-slate-700 dark:text-slate-200" title={prop.value}>{prop.value}</span>
                             </div>
                         ))}
                     </div>
                 </div>
             );
         };
         

/**
 * @description Displays a styled note for disclaimers or contextual info.
 * @param {{children: React.ReactNode, type: 'info' | 'warning'}} props
 */
const ContextualNote = ({ children, type = 'info' }) => {
    const styles = {
        info: {
            container: 'bg-slate-100 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700',
            iconColor: 'text-slate-500 dark:text-slate-400',
        },
        warning: {
            container: 'bg-amber-50 dark:bg-amber-900/30 border-amber-300 dark:border-amber-700',
            iconColor: 'text-amber-600 dark:text-amber-400',
        }
    };
    const selectedStyle = styles[type] || styles.info;

    return (
        <div className={`mt-4 p-3 border-l-4 rounded-r-lg text-xs ${selectedStyle.container}`}>
            <div className="flex">
                <div className="flex-shrink-0">
                    <Icon path={ICONS.help} className={`w-4 h-4 mr-2 ${selectedStyle.iconColor}`} />
                </div>
                <div className="flex-grow text-slate-600 dark:text-slate-300">
                    {children}
                </div>
            </div>
        </div>
    );
};



         const Tooltip = ({ text, children, widthClass = 'w-96' }) => {
         
         // --- Modified state to hold a flexible style object ---
         
         const [tooltipState, setTooltipState] = React.useState({
         show: false,
         style: { opacity: 0, visibility: 'hidden' },
         position: 'bottom'
         });
         const triggerRef = React.useRef(null);
         const timeoutRef = React.useRef(null);
         
         // --- Rewrote handleMouseEnter with responsive logic ---
         
         const handleMouseEnter = () => {
         if (triggerRef.current) {
         const rect = triggerRef.current.getBoundingClientRect();
         const position = rect.top > window.innerHeight / 2 ? 'top' : 'bottom';
         const screenPadding = 8; // 8px padding from the viewport edge
         
         const newStyle = {
         top: position === 'bottom' ? rect.bottom : rect.top,
         visibility: 'visible',
         opacity: 1,
         };
         
         // Check if trigger is in the right half of the screen
         
         if (rect.left + rect.width / 2 > window.innerWidth / 2) {
         
         // Align tooltip's RIGHT edge with trigger's RIGHT edge
         
         newStyle.right = window.innerWidth - rect.right;
         newStyle.transformOrigin = 'right'; // Optional: for smoother animations
         } else {
         
         // Align tooltip's LEFT edge with trigger's LEFT edge
         
         newStyle.left = rect.left;
         newStyle.transformOrigin = 'left'; // Optional: for smoother animations
         }
         
         if (timeoutRef.current) clearTimeout(timeoutRef.current);
         
         setTooltipState({
         show: true,
         style: newStyle,
         position: position
         });
         
         timeoutRef.current = setTimeout(() => {
         setTooltipState(prev => ({ ...prev, show: false }));
         }, 2000);
         }
         };
         
         // --- Updated handleMouseLeave to correctly hide the tooltip ---
         const handleMouseLeave = () => {
         if (timeoutRef.current) clearTimeout(timeoutRef.current);
         
         // Hide by reverting style properties
         
         setTooltipState(prev => ({
         ...prev,
         show: false
         }));
         };
         
         React.useEffect(() => {
         return () => {
         if (timeoutRef.current) clearTimeout(timeoutRef.current);
         };
         }, []);
         
         const positionClasses = tooltipState.position === 'bottom'
         ? 'translate-y-2'
         : '-translate-y-full -translate-y-2';
         
         // --- Modified the rendered element to use the new style object ---
         // Note the removal of "-translate-x-1/2" from the className
         
         const tooltipElement = (
         ReactDOM.createPortal(
         <div
         style={{
         ...tooltipState.style,
         
         // Smoothly transition opacity for the fade effect
         
         transition: 'opacity 0.2s ease-out',
         
         // Conditionally set opacity based on the 'show' state
         
         opacity: tooltipState.show ? 1 : 0,
         }}
         className={`fixed top-0 p-2 text-xs text-white bg-slate-800 dark:bg-slate-900 rounded-md shadow-lg z-50 pointer-events-none ${widthClass} ${positionClasses}`}
         >
         {text}
         </div>,
         document.body
         )
         );
         
         return (
         <>
         {React.cloneElement(children, {
         ref: triggerRef,
         onMouseEnter: handleMouseEnter,
         onMouseLeave: handleMouseLeave,
         })}
         {tooltipElement}
         </>
         );
         };
         
         const renderInputField = (label, value, setter, isEnabled, unitValue, unitSetter, unitOptions) => (
          <div>
              <label className={`block text-sm font-medium ${isEnabled ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 dark:text-slate-500'}`}>{label}</label>
              <div className="flex gap-2 mt-1">
                  <input type="number" value={value} onChange={e => setter(e.target.value)} disabled={!isEnabled} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:cursor-not-allowed" />
                  {unitOptions && (
                      <select value={unitValue} onChange={e => unitSetter(e.target.value)} disabled={!isEnabled} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:cursor-not-allowed">
                          {unitOptions.map(u => <option key={u} value={u}>{u}</option>)}
                      </select>
                  )}
              </div>
          </div>
         );
         
         /**
         * @description A reusable component that parses a string for nuclide names and turns them into clickable buttons.
         * @param {{text: string, radionuclides: Array<object>, onNuclideClick: (nuclide: object) => void}} props
         */
         
         const ClickableNuclide = ({ text, radionuclides, onNuclideClick }) => {
         if (!text || !onNuclideClick) return <span>{text}</span>;
         
         // This splits the string by delimiters like ' or ' or ' -> ' while keeping them
         
         const parts = text.split(/(\s+or\s+|\s*\/\s*|\s*->\s*)/);
         
         return (
         <>
             {parts.map((part, index) => {
                 if (!part) return null;
                 const nuclideName = part.split('(')[0].trim();
                 const foundNuclide = radionuclides.find(n => n.name === nuclideName || n.symbol === nuclideName);
         
                 if (foundNuclide) {
                     return ( <button key={index} onClick={() => onNuclideClick(foundNuclide)} className="text-sky-500 hover:underline font-semibold">{part}</button> );
                 } else {
                     const isStable = text.toLowerCase().includes('stable') || radionuclides.find(n => n.name === nuclideName)?.halfLife === 'Stable';
                     return (
                         <span key={index}>
                             {part}
                             {isStable && <span className="text-xs font-medium text-slate-400 dark:text-slate-500 ml-1">(Stable)</span>}
                         </span>
                     );
                 }
             })}
         </>
         );
         };
         
         /**
         * @description A reusable modal dialog for confirming user actions.
         * @param {{isOpen: boolean, onClose: () => void, onConfirm: () => void, title: string, children: React.ReactNode}} props
         */
         
         const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children }) => {
         if (!isOpen) return null;
         
         // The modal's JSX is now wrapped in ReactDOM.createPortal()
         
         return ReactDOM.createPortal(
         
         // Backdrop
         
         <div
            className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4 animate-fade-in"
            onClick={onClose} // Close modal if backdrop is clicked
         >
            {/* Modal Panel */}
         
            <div
                className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl flex flex-col"
                onClick={e => e.stopPropagation()} // Prevent click inside from closing modal
            >
                <div className="p-6">
                    <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">{title}</h3>
                    <div className="mt-2 text-sm text-slate-600 dark:text-slate-300">
                        {children}
                    </div>
                </div>
         
                {/* Action Buttons */}
         
                <div className="bg-slate-50 dark:bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 rounded-b-2xl">
                    <button
                        onClick={onClose}
                        className="px-4 py-2 text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        onClick={onConfirm}
                        className="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors"
                    >
                        Confirm
                    </button>
                </div>
            </div>
         </div>,
         document.getElementById('modal-root') // This tells React where to render the modal
         );
         };
         
         const ClearButton = ({ onClick }) => (
         <button onClick={onClick} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1 ml-auto">
         <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
         </button>
         );
         
         /**
          * @description A button that copies a given text string to the clipboard and shows a confirmation.
          * @param {{textToCopy: string}} props - The text to be copied.
          */
         
         const CopyButton = ({ textToCopy }) => {
             const [copied, setCopied] = React.useState(false);
             const { addToast } = useToast();
         
             const handleCopy = () => {
                 if (textToCopy) {
                     navigator.clipboard.writeText(textToCopy).then(() => {
                         addToast('Copied to clipboard!');
                         setCopied(true);
                         // Revert the icon back to the copy icon after 2 seconds.
                         setTimeout(() => setCopied(false), 2000);
                     });
                 }
             };
         
             return (
                 <button onClick={handleCopy} className="p-2 text-slate-400 hover:text-sky-500 transition-colors" title="Copy to clipboard">
                     <Icon path={copied ? ICONS.check : ICONS.copy} className="w-5 h-5" />
                 </button>
             );
         };
         
         /**
          * @description The main header for the application.
          * @param {{onHelpClick: () => void, theme: string, toggleTheme: () => void}} props - Handlers and state for help and theme toggling.
          */
         
         const Header = ({ onHelpClick, theme, toggleTheme, onNavClick }) => (
         
         <header className="flex items-center p-4 md:p-6 border-b border-slate-200 dark:border-slate-700">
         
         <div className="flex-1 flex justify-start">
             <Tooltip text="Toggle Theme" widthClass="w-auto">
                 <button onClick={toggleTheme} className="p-2 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Toggle dark mode">
                     <Icon path={theme === 'dark' ? ICONS.sun : ICONS.moon} className="w-6 h-6" />
                 </button>
             </Tooltip>
         </div>
         
         <div className="flex-1 text-center">
             <h1 className="text-xl md:text-3xl font-bold text-gray-800 dark:text-slate-100">Health Physics Toolbox</h1>
             <p className="text-sm text-slate-500 dark:text-slate-400 mt-2">
                 Version: {VERSION} | Last Updated: {LAST_UPDATED}
             </p>
         </div>
         
         <div className="flex-1 flex justify-end items-center gap-2">
             {/* MODIFIED: Added rel="noopener noreferrer" for security */}
             <a href="https://www.buymeacoffee.com/jough" target="_blank" rel="noopener noreferrer" className="hidden md:block">
                 <img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} />
             </a>
             <div className="flex flex-col">
               <Tooltip text="Settings" widthClass="w-auto">
         
                   <button onClick={() => onNavClick(VIEWS.SETTINGS)} className="p-1 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open settings panel">
                       <Icon path={ICONS.settings} className="w-5 h-5" />
                   </button>
               </Tooltip>
                 <Tooltip text="Open User Manual" widthClass="w-auto">
                     <button onClick={onHelpClick} className="p-1 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open User Manual">
                         <Icon path={ICONS.help} className="w-5 h-5" />
                     </button>
                 </Tooltip>
             </div>
         </div>
         </header>
         );
         
         /**
          * @description The primary search input with auto-suggestions.
          * @param {object} props - Contains all state and handlers for the search functionality.
          * @param {string} props.nuclideName - The current value of the search input.
          * @param {React.RefObject} props.inputRef - Ref for the input element.
          * @param {(e: React.ChangeEvent) => void} props.handleNuclideNameChange - Handler for input changes.
          * @param {(e: React.KeyboardEvent) => void} props.handleKeyDown - Handler for keyboard events (arrow keys, Enter).
          * @param {() => void} props.onClear - Handler to clear the search input.
          * @param {Array<object>} props.suggestions - The list of suggestion items.
          * @param {number} props.activeSuggestionIndex - The index of the currently highlighted suggestion.
          * @param {React.RefObject} props.suggestionsRef - Ref for the suggestions list container.
          * @param {(nuclide: object) => void} props.handleNuclideSelection - Handler for when a nuclide is selected.
          */
         
const SearchBar = ({ nuclideName, inputRef, handleNuclideNameChange, handleKeyDown, onClear, suggestions, activeSuggestionIndex, suggestionsRef, handleNuclideSelection, onNavClick, isFocused, onFocus, onBlur }) => (
    <div className="relative p-4 flex items-center gap-2">
        <div className="relative flex-grow">
            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Icon path={ICONS.search} className="w-5 h-5 text-slate-400" />
            </div>
            <input
                ref={inputRef}
                type="text"
                value={nuclideName}
                onChange={handleNuclideNameChange}
                onKeyDown={handleKeyDown}
                onFocus={onFocus}
                onBlur={onBlur}
                placeholder="Search by name or symbol (e.g., U-238)"
                className="w-full p-3 pl-10 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition"
            />
            {nuclideName && (
                <button onClick={onClear} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-sky-500 focus:outline-none">
                    <Icon path={ICONS.clear} className="w-5 h-5" />
                </button>
            )}
        </div>

        <button
             onClick={() => onNavClick('home')}
             className="hidden md:flex items-center gap-2 p-3 md:px-4 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"
             aria-label="Home"
         >
             <Icon path={ICONS.home} className="w-5 h-5" />
             <span className="font-semibold">Home</span>
         </button>
        
        {isFocused && suggestions.length > 0 && (
            <ul ref={suggestionsRef} className="absolute z-20 top-full left-4 right-4 mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg shadow-lg max-h-72 overflow-y-auto">
                {suggestions.map((s, i) => {
                    const styles = CATEGORY_STYLES[s.category] || CATEGORY_STYLES['default'];
                    return (
                        <li
                            key={s.symbol}
                            className={`p-3 pl-4 cursor-pointer text-slate-700 dark:text-slate-200 border-l-2 ${styles.border} ${styles.hoverBg} ${i === activeSuggestionIndex ? 'bg-sky-100 dark:bg-sky-900/50' : ''}`}
                            onClick={() => handleNuclideSelection(s)}
                        >
                            {s.name} ({s.symbol}) <span className="text-xs text-slate-500 dark:text-slate-400">{s.commonality}</span>
                        </li>
                    );
                })}
                {suggestions.length > 4 && (
                    <div className="sticky bottom-0 bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm p-2 border-t border-slate-200 dark:border-slate-700">
                        <div className="flex flex-wrap justify-center gap-x-3 gap-y-1">
                            {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                const bgColor = styles.border.replace('border-l-', 'bg-');
                                return (
                                    <div key={category} className="flex items-center gap-1.5">
                                        <div className={`w-2.5 h-2.5 rounded-full ${bgColor}`}></div>
                                        <span className="text-xs text-slate-500 dark:text-slate-400">{category.replace('/', '/ ')}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
            </ul>
        )}
    </div>
);
         
         /**
         * @description A button that appears when the user scrolls down, allowing them to quickly return to the top of the page.
         */
         
         const BackToTopButton = () => {
         const [isVisible, setIsVisible] = React.useState(false);
         
         // This function is called whenever the user scrolls
         
         const toggleVisibility = () => {
         if (window.pageYOffset > 300) { // Show button if scrolled more than 300px
             setIsVisible(true);
         } else {
             setIsVisible(false);
         }
         };
         
         // This function scrolls the page to the top smoothly
         
         const scrollToTop = () => {
         window.scrollTo({
             top: 0,
             behavior: 'smooth'
         });
         };
         
         React.useEffect(() => {
         window.addEventListener('scroll', toggleVisibility);
         // Clean up the listener when the component is removed
         return () => {
             window.removeEventListener('scroll', toggleVisibility);
         };
         }, []);
         
         return (
         <div className="fixed bottom-4 right-4 z-50">
             {isVisible && (
                 <button
                     onClick={scrollToTop}
                     className="p-3 bg-sky-600 text-white rounded-full shadow-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-300 animate-fade-in"
                     aria-label="Go to top"
                 >
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                     </svg>
                 </button>
             )}
         </div>
         );
         };
         
         /**
          * @description The main navigation bar, which is responsive for mobile and desktop.
          * @param {{activeView: string, onNavClick: (view: string) => void}} props - The currently active view and the click handler.
          */
         
         const MainNav = ({ activeView, onNavClick }) => {
         
         const navItems = [
         { id: VIEWS.HOME, label: 'Home', icon: ICONS.home },
         { id: VIEWS.DATABASE, label: 'Database', icon: ICONS.database },
         { id: VIEWS.COMPARE, label: 'Compare', icon: ICONS.compare },
         { id: VIEWS.CALCULATOR, label: 'Decay', icon: ICONS.calculator },
         { id: VIEWS.MDA, label: 'MDA', icon: ICONS.search },
         { id: VIEWS.MARSSIM_SAMPLES, label: 'MARSSIM Sample Design', icon: ICONS.calculator },
         { id: VIEWS.MARSSIM_TESTS, label: 'MARSSIM Tests', icon: ICONS.database },
         { id: VIEWS.SERIES_CALCULATOR, label: 'Series Decay', icon: ICONS.series },
         { id: VIEWS.EQUILIBRIUM, label: 'Equilibrium', icon: ICONS.activity },
         { id: VIEWS.RADON, label: 'Radon', icon: ICONS.radon },
         { id: VIEWS.ACTIVITY_MASS, label: 'Activity/Mass', icon: ICONS.mass },
         { id: VIEWS.DOSE_RATE, label: 'Dose & Dose Rate', icon: ICONS.doseRate },
         { id: VIEWS.SHIELDING, label: 'Shielding', icon: ICONS.shield },
         { id: VIEWS.STAY_TIME, label: 'Stay Time', icon: ICONS.stopwatch },
         { id: VIEWS.NEUTRON, label: 'Neutron Tools', icon: ICONS.neutron },
         { id: VIEWS.OPERATIONAL_HP, label: 'Operational HP', icon: ICONS.shield },
         { id: VIEWS.TRANSPORTATION, label: 'Transportation', icon: ICONS.transport },
         { id: VIEWS.CONVERTER, label: 'Converter', icon: ICONS.converter },
         { id: VIEWS.LAB_STATS, label: 'Lab Stats', icon: ICONS.labStats },
         { id: VIEWS.PEAK_ID, label: 'Peak ID', icon: ICONS.gammaSpec },
         { id: VIEWS.MEDICAL, label: 'Medical', icon: ICONS.medical },
         
         { id: VIEWS.SCRATCHPAD, label: 'Scratchpad', icon: ICONS.notepad },

	 { id: VIEWS.SCIENTIFIC_CALCULATOR, label: 'Sci. Calculator', icon: ICONS.scientificCalculator },

         { id: VIEWS.REFERENCES, label: 'References', icon: ICONS.references }
         ];
         
         const NavButton = ({ item }) => (
         <button
            onClick={() => onNavClick(item.id)}
            className="flex-shrink-0 w-full"
         >
            <span
                 className={`mx-auto flex items-center justify-center gap-2 px-2 py-2 text-sm font-semibold rounded-md transition-all duration-200 ${
                    activeView === item.id
                        ? 'bg-white dark:bg-slate-900 text-sky-600 dark:text-sky-400 shadow'
                        : 'text-slate-600 dark:text-slate-300 hover:bg-sky-100 dark:hover:bg-sky-800 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md hover:-translate-y-1'
                }`}
            >
                <Icon path={item.icon} className="w-4 h-4" />
                <span className="truncate">{item.label}</span>
            </span>
         </button>
         );
         
         return (
         <div className="px-4 pb-2">
            <div className="md:hidden">
                <div className="grid grid-cols-2 gap-4">
                    {navItems.map(item => (
                        <button
                            key={item.id}
                            onClick={() => onNavClick(item.id)}
                            // --- MODIFIED LINE: Removed the col-span-2 conditional ---
                            className={`flex flex-col items-center justify-center p-4 rounded-lg text-center transition-all duration-150 ease-in-out ${
                                activeView === item.id
                                    ? 'bg-sky-100 dark:bg-sky-900/50 text-sky-600 dark:text-sky-400'
                                    : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-sky-100 dark:hover:bg-sky-900/50 active:scale-95'
                            }`}
                        >
                            <Icon path={item.icon} className="w-8 h-8 mb-2" />
                            <span className="text-sm font-semibold">{item.label}</span>
                        </button>
                    ))}
                </div>
            </div>
            <div className="hidden md:grid grid-cols-4 lg:grid-cols-6 gap-2">

	{navItems.map(item => <NavButton key={item.id} item={item} />)}

            </div>
         </div>
         );
         };
         
         //==============================================================================
         // --- VIEW COMPONENTS
         // These components represent the main content areas of the application.
         //==============================================================================
         
         const CalculationHistoryPanel = ({ onNavClick }) => {
         const [history, setHistory] = React.useState([]);
         const [isClearModalOpen, setIsClearModalOpen] = React.useState(false);
         
         React.useEffect(() => {
         const savedHistory = localStorage.getItem('rad_tool_calculation_history');
         if (savedHistory) {
           setHistory(JSON.parse(savedHistory));
         }
         }, []);
         
         const handleClearHistory = () => {
         localStorage.removeItem('rad_tool_calculation_history');
         setHistory([]);
         setIsClearModalOpen(false);
         };
         
         const handleItemClick = (view) => {
         if (view && onNavClick) {
           onNavClick(view);
         }
         };
         
         if (history.length === 0) {
         return null;
         }
         
         return (
         <>
           <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
               <div className="flex justify-between items-center mb-4">
                   <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Recent Calculations</h4>
                   <button onClick={() => setIsClearModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">
                       Clear History
                   </button>
               </div>
               <div className="space-y-3">
                   {history.map(item => (
                       <button
                           key={item.id}
                           onClick={() => handleItemClick(item.view)}
                           className="w-full text-left p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:ring-2 hover:ring-sky-500 transition-all duration-150"
                       >
                           
                           <div className="flex items-start gap-4">
                               {item.icon && <Icon path={item.icon} className="w-8 h-8 text-slate-400 dark:text-slate-500 mt-1 flex-shrink-0" />}
                               <div className="flex-grow">
                                   <p className="font-bold text-sky-600 dark:text-sky-400">{item.type}</p>
                                   <p className="text-sm text-slate-600 dark:text-slate-300">
                                       <span className="font-semibold">Inputs:</span> {item.inputs}
                                   </p>
                                   <p className="text-sm text-slate-800 dark:text-slate-100">
                                       <span className="font-semibold">Result:</span> {item.result}
                                   </p>
                               </div>
                           </div>
                           
                       </button>
                   ))}
               </div>
           </div>
         
           <ConfirmationModal
               isOpen={isClearModalOpen}
               onClose={() => setIsClearModalOpen(false)}
               onConfirm={handleClearHistory}
               title="Clear Calculation History"
           >
               <p>Are you sure you want to clear your five most recent calculations?</p>
           </ConfirmationModal>
         </>
         );
         };
         
         /**
         * @description The landing page view, showing suggestions, search history, favorites, or the main search result.
         * @param {object} props - Contains data and handlers for the home page.
         */
         
         const HomePage = ({ errorMessage, randomSuggestions, searchHistory, handleNuclideSelection, handleClearHistory, favorites, radionuclides, handleClearFavorites, onNavClick }) => {
         const [isFavoritesModalOpen, setIsFavoritesModalOpen] = React.useState(false);
         const [isHistoryModalOpen, setIsHistoryModalOpen] = React.useState(false);
         
         const favoriteNuclides = React.useMemo(() =>
         favorites.map(symbol => radionuclides.find(n => n.symbol === symbol)).filter(Boolean),
         [favorites, radionuclides]
         );
         
         const searchHistoryNuclides = React.useMemo(() =>
         searchHistory.map(symbol => radionuclides.find(n => n.symbol === symbol)).filter(Boolean),
         [searchHistory, radionuclides]
         );
         
         const confirmClearFavorites = () => {
         handleClearFavorites();
         setIsFavoritesModalOpen(false);
         };
         
         const confirmClearHistory = () => {
         handleClearHistory();
         setIsHistoryModalOpen(false);
         };
         
         return (
         <div className="p-4 sm:p-6 space-y-6">
            {errorMessage && (
                <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                    <p className="font-bold">Error</p><p>{errorMessage}</p>
                </div>
            )}
            
            {/* --- 1. FAVORITES --- */}
         
            {favoriteNuclides.length > 0 && (
                <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Your Favorites</h4>
                        <button onClick={() => setIsFavoritesModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline focus:outline-none">
                            Clear Favorites
                        </button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {favoriteNuclides.map(n => (
                            <NuclideCard
                                key={n.symbol}
                                nuclide={n}
                                isCompact={true}
                                onNuclideClick={handleNuclideSelection}
                            />
                        ))}
                    </div>
                </div>
            )}
         
            {/* --- 2. RECENT SEARCHES --- */}
         
            {searchHistoryNuclides.length > 0 && (
                <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Recent Searches</h4>
                        <button onClick={() => setIsHistoryModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline focus:outline-none">
                            Clear History
                        </button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {searchHistoryNuclides.map(n => (
                            <NuclideCard
                                key={n.symbol}
                                nuclide={n}
                                isCompact={true}
                                onNuclideClick={handleNuclideSelection}
                            />
                        ))}
                    </div>
                </div>
            )}
            
            {/* --- 3. RECENT CALCULATIONS --- */}
         
            <CalculationHistoryPanel onNavClick={onNavClick} />
         
            {/* --- 4. QUICK SUGGESTIONS --- */}
         
            <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl">
                <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 text-left">Quick Suggestions</h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {randomSuggestions.map(n => (
                        <NuclideCard
                            key={n.symbol}
                            nuclide={n}
                            isCompact={true}
                            onNuclideClick={handleNuclideSelection}
                        />
                    ))}
                </div>
            </div>
         
            <ConfirmationModal
                isOpen={isFavoritesModalOpen}
                onClose={() => setIsFavoritesModalOpen(false)}
                onConfirm={confirmClearFavorites}
                title="Clear All Favorites"
            >
                <p>Are you sure you want to clear your entire list of favorites? This action cannot be undone.</p>
            </ConfirmationModal>
         
            <ConfirmationModal
                isOpen={isHistoryModalOpen}
                onClose={() => setIsHistoryModalOpen(false)}
                onConfirm={confirmClearHistory}
                title="Clear Search History"
            >
                <p>Are you sure you want to clear your recent search history?</p>
            </ConfirmationModal>
         
         </div>
         );
         };
         
const Scratchpad = () => {
             const { addToast } = useToast();
             const [notes, setNotes] = React.useState(() => localStorage.getItem('user_scratchpad_notes') || '');
             const [isClearModalOpen, setIsClearModalOpen] = React.useState(false);
         
             React.useEffect(() => {
                 localStorage.setItem('user_scratchpad_notes', notes);
             }, [notes]);
         
             const handleCopyAll = () => {
                 if (notes) {
                    navigator.clipboard.writeText(notes);
                    addToast('Notes copied to clipboard!');
                 }
             };
         
             const handleExport = () => {
                 const blob = new Blob([notes], { type: 'text/plain;charset=utf-8' });
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 link.download = 'scratchpad-notes.txt';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
             };
         
             const handleInsertTimestamp = () => {
                 const timestamp = new Date().toLocaleString();
                 setNotes(prev => prev + `\n--- ${timestamp} ---\n`);
                 addToast('Timestamp inserted!');
             };
         
             const handleConfirmClear = () => {
                 setNotes('');
                 setIsClearModalOpen(false);
                 addToast('Scratchpad cleared.');
             };
         
             const characterCount = notes.length;
             const wordCount = notes.trim().split(/\s+/).filter(Boolean).length;
         
             return (
                 // The outer container has been removed. We now return a Fragment.
                 <>
                     <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">
                         Your notes are automatically saved in your browser's local storage.
                     </p>
                     
                     <div className="flex flex-wrap items-center gap-2 mb-2 p-2 bg-slate-100 dark:bg-slate-700/50 rounded-t-md border-b border-slate-200 dark:border-slate-700">
                     
                         <button onClick={handleCopyAll} className="px-3 py-1 text-sm bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold flex items-center gap-2">
                             <Icon path={ICONS.copy} className="w-4 h-4" />
                             Copy All
                         </button>
                         <button onClick={handleExport} className="px-3 py-1 text-sm bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold flex items-center gap-2">
                             <Icon path={ICONS.database} className="w-4 h-4" />
                             Export as .txt
                         </button>
                         <button onClick={handleInsertTimestamp} className="px-3 py-1 text-sm bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold flex items-center gap-2">
                             <Icon path={ICONS.stopwatch} className="w-4 h-4" />
                             Insert Timestamp
                         </button>
                         <div className="flex-grow"></div> {/* Spacer */}
                         <button onClick={() => setIsClearModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                             <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Notes
                         </button>
                     </div>
                     <textarea
                         value={notes}
                         onChange={(e) => setNotes(e.target.value)}
                         placeholder="Jot down your notes and calculations here..."
                         className="w-full h-96 p-4 rounded-b-md bg-slate-50 dark:bg-slate-900 font-mono text-sm border-x border-b border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-sky-500 focus:outline-none"
                     />
                     <div className="text-right text-xs text-slate-400 dark:text-slate-500 mt-2 pr-1">
                         <span>{characterCount.toLocaleString()} Characters</span>
                         <span className="mx-2">|</span>
                         <span>{wordCount.toLocaleString()} Words</span>
                     </div>
                     <ConfirmationModal
                         isOpen={isClearModalOpen}
                         onClose={() => setIsClearModalOpen(false)}
                         onConfirm={handleConfirmClear}
                         title="Clear Scratchpad?"
                     >
                         <p>Are you sure you want to permanently delete all notes from the scratchpad? This action cannot be undone.</p>
                     </ConfirmationModal>
                 </>
             );
         };
         
         /**
         * @description React component for a multi-purpose scientific calculator.
         * This component handles standard arithmetic, advanced functions (e.g., sin, log),
         * unit conversions, and physical constants, specifically tailored for scientific
         * and health physics applications.
         *
         * Key features:
         * - Real-time expression evaluation using the `math.js` library.
         * - Basic and scientific functions (trigonometry, logarithms, etc.).
         * - Unit conversion buttons for common radiological units (e.g., Ci ↔ Bq).
         * - Memory functions (M+, MR, MC).
         * - History of recent calculations.
         * - Support for keyboard input for a more fluid user experience.
         */
         
const ScientificCalculator = ({ calcState, setCalcState }) => {
    const { addToast } = useToast();

    // FIX 2: All state-updating functions are rewritten using the "functional update" form (e.g., setCalcState(currentState => ...)).
    // This is a more robust pattern that prevents bugs where functions might use "stale" state.
    // They are also wrapped in React.useCallback to ensure they don't get recreated unnecessarily on every render.

const handleInput = React.useCallback((value) => {
    setCalcState(currentState => {
        const { expression, result } = currentState;
        const newExpression = (expression === '' && result && !isNaN(parseFloat(result)) ? result : expression) + value;
        return { ...currentState, expression: newExpression, result: '' };
    });
}, [setCalcState]);

const handleCalculate = React.useCallback(() => {
    setCalcState(currentState => {
        if (!currentState.expression) return currentState;
        try {
            const evalResult = math.evaluate(currentState.expression);
            const resultStr = math.format(evalResult, { precision: 6 });
            return {
                ...currentState,
                result: resultStr,
                history: [`${currentState.expression} = ${resultStr}`, ...currentState.history].slice(0, 5),
                expression: ''
            };
        } catch (e) {
            const errorMessage = e.message || 'Invalid expression';
            addToast(errorMessage);
            return { ...currentState, result: 'Error', expression: '' };
        }
    });
}, [setCalcState, addToast]);

    const handleClear = React.useCallback(() => {
        setCalcState(currentState => ({ ...currentState, expression: '', result: '' }));
    }, [setCalcState]);

    const handleBackspace = React.useCallback(() => {
        setCalcState(currentState => ({ ...currentState, expression: currentState.expression.slice(0, -1) }));
    }, [setCalcState]);
    
    const handleMemoryClear = React.useCallback(() => {
        setCalcState(currentState => ({ ...currentState, memory: 0 }));
        addToast('Memory cleared');
    }, [setCalcState, addToast]);

    const handleMemoryRecall = React.useCallback(() => {
        setCalcState(currentState => ({ ...currentState, expression: currentState.expression + currentState.memory.toString() }));
    }, [setCalcState]);

    const handleMemoryAdd = React.useCallback(() => {
        setCalcState(currentState => {
            try {
                const currentValue = parseFloat(currentState.expression || currentState.result || '0');
                if (isNaN(currentValue)) throw new Error();
                const newMemory = currentState.memory + currentValue;
                addToast(`Added to memory. New value: ${newMemory}`);
                return { ...currentState, memory: newMemory };
            } catch {
                addToast('Invalid value to add to memory');
                return currentState;
            }
        });
    }, [setCalcState, addToast]);
    
    const handleKeyDown = React.useCallback((event) => {
        if ("1234567890+-*/.^()%=EnterBackspaceEscape".includes(event.key)) { event.preventDefault(); }
        const { key } = event;
        if (key >= '0' && key <= '9') { handleInput(key); }
        if (['+', '-', '*', '/', '.', '%', '(', ')', '^'].includes(key)) { handleInput(key); }
        if (key === 'Enter' || key === '=') { handleCalculate(); }
        if (key === 'Backspace') { handleBackspace(); }
        if (key === 'Escape') { handleClear(); }
    }, [handleInput, handleCalculate, handleBackspace, handleClear]); // FIX 2 (cont.): Dependency array updated to the stable handler functions.

    // The rest of the component's JSX remains the same...
    const { expression, result, history, memory } = calcState;
    const allButtons = [ 'AC', 'DEL', '(', ')', 'sin(', 'cos(', 'tan(', 'log10(', 'ln(', 'sqrt(', '^', 'π', '7', '8', '9', '/', '4', '5', '6', '*', '1', '2', '3', '-', 'e', '0', '.', '+' ];
    const constants = [ { name: 'Ci to Bq (3.7e10)', value: 3.7e10 }, { name: 'R to C/kg (2.58e-4)', value: 2.58e-4 }, { name: 'Avogadro (Na)', value: 6.02214076e23 }, { name: 'Speed of Light (c)', value: 299792458 }, { name: 'Electron Charge (e)', value: 1.60217663e-19 }, { name: 'Electron Mass (MeV)', value: 0.511 } ];
             
    const getButtonClass = (btn) => {
        if (['/', '*', '-', '+', '^', '%'].includes(btn)) return 'bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600';
        if (['sin(', 'cos(', 'tan(', 'log10(', 'ln(', 'sqrt(', '(', ')', 'π', 'e'].includes(btn)) return 'bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500';
        return 'bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700';
    };

    const handleConversion = (factor) => {
        setCalcState(currentState => {
            try {
                const currentValue = parseFloat(currentState.expression || currentState.result || '0');
                if (isNaN(currentValue)) throw new Error();
                const convertedValue = currentValue * factor;
                return { ...currentState, expression: convertedValue.toString(), result: '' };
            } catch {
                addToast('Invalid value for conversion');
                return { ...currentState, result: 'Error', expression: '' };
            }
        });
    };
    
    const handleConstant = (name, value) => {
        setCalcState(currentState => ({ ...currentState, expression: currentState.expression + value.toString() }));
        addToast(`${name} added`);
    };

    return (
        <div 
           onKeyDown={handleKeyDown} 
           tabIndex="0" 
           className="focus:outline-none focus:ring-2 focus:ring-sky-500/80 rounded-lg"
        >
            <div className="bg-slate-100 dark:bg-slate-900 rounded-lg p-4 text-right mb-4">
                <div className="h-20 text-xs text-slate-400 space-y-1 overflow-y-auto text-right flex flex-col-reverse">
                    {history.map((item, index) => <div key={index}>{item}</div>)}
                </div>
                <div className="text-slate-500 dark:text-slate-400 h-8 break-all font-semibold">{expression || '\u00A0'}</div>
                <div className="flex justify-end items-center h-10">
                    <div className="text-3xl font-bold text-slate-800 dark:text-slate-100">{result}</div>
                    {result && result !== 'Error' && <CopyButton textToCopy={result} />}
                </div>
            </div>
            <div className="grid grid-cols-5 gap-2 mb-2">
                <button onClick={() => handleConversion(3.7e10)} className="p-2 text-xs bg-slate-200 dark:bg-slate-700 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">Ci → Bq</button>
                <button onClick={() => handleConversion(1 / 3.7e10)} className="p-2 text-xs bg-slate-200 dark:bg-slate-700 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">Bq → Ci</button>
                <button onClick={() => handleConversion(0.01)} className="p-2 text-xs bg-slate-200 dark:bg-slate-700 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">rem → Sv</button>
                <button onClick={() => handleConversion(100)} className="p-2 text-xs bg-slate-200 dark:bg-slate-700 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">Sv → rem</button>
                <button onClick={handleCalculate} className="p-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 text-2xl row-span-2 flex items-center justify-center">=</button>
                <button onClick={handleMemoryClear} className="p-2 text-xs bg-amber-200 dark:bg-amber-800 font-bold rounded-lg hover:bg-amber-300 dark:hover:bg-amber-700">MC</button>
                <button onClick={handleMemoryRecall} className="p-2 text-xs bg-amber-200 dark:bg-amber-800 font-bold rounded-lg hover:bg-amber-300 dark:hover:bg-amber-700">MR</button>
                <button onClick={handleMemoryAdd} className="p-2 text-xs bg-amber-200 dark:bg-amber-800 font-bold rounded-lg hover:bg-amber-300 dark:hover:bg-amber-700">M+</button>
                <button onClick={() => handleInput('sqrt(')} className="p-2 text-xs bg-slate-200 dark:bg-slate-600 font-bold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">√</button>
            </div>
            <div className="grid grid-cols-4 gap-2">
                {allButtons.map(btn => {
                    let onClick;
                    let className = `p-3 font-bold rounded-lg transition-colors `;
                    if (btn === 'AC') {
                        onClick = handleClear;
                        className += 'bg-red-500 text-white hover:bg-red-600';
                    } else if (btn === 'DEL') {
                        onClick = handleBackspace;
                        className += 'bg-slate-300 dark:bg-slate-600 hover:bg-slate-400 dark:hover:bg-slate-500';
                    } else if (btn === 'π') {
                        onClick = () => handleInput('pi');
                        className += getButtonClass(btn);
                    } else {
                        onClick = () => handleInput(btn);
                        className += getButtonClass(btn);
                    }
                    return (<button key={btn} onClick={onClick} className={className}>{btn}</button>);
                })}
            </div>
            <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                <p className="text-sm font-semibold text-slate-500 dark:text-slate-400 mb-2 text-center">Constants</p>
                <div className="grid grid-cols-2 lg:grid-cols-3 gap-2">
                    {constants.map(c => <button key={c.name} onClick={() => handleConstant(c.name, c.value)} className="p-2 text-xs bg-slate-200 dark:bg-slate-700 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">{c.name}</button>)}
                </div>
            </div>
        </div>
    );
};

         /**
         * @description React component that serves as a static page for external links and references.
         * This component provides a curated list of authoritative resources relevant to the application's
         * domain, such as health physics, radiation safety, and nuclear data.
         *
         * It is a pure presentation component that renders a pre-defined array of links,
         * categorized for easy navigation. The links are grouped into sections for:
         * 1.  **Regulatory & Guidance:** Official documents from government agencies like the NRC and DOT.
         * 2.  **Data & Tools:** Databases and software from sources like NNDC and EPA.
         * 3.  **Professional Organizations:** Websites for key professional societies and international bodies.
         *
         * This component is intended to provide users with quick access to the foundational
         * knowledge and external data sources that underpin the calculations and information in the app.
         */
         
const ReferencesPage = () => {
    const referenceLinks = [
        {
            category: 'Regulatory & Guidance',
            items: [
                { title: '10 CFR Part 20 - Standards for Protection Against Radiation', url: 'https://www.nrc.gov/reading-rm/doc-collections/cfr/part020/', description: 'The foundational NRC regulation for radiation protection in the United States.' },
                { title: '49 CFR Part 173 - Shippers—General Requirements for Shipments', url: 'https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173', description: 'Department of Transportation regulations governing the transport of hazardous materials, including radioactive sources.' },
                { title: 'NUREG-1556 Series - Consolidated Guidance About Materials Licenses', url: 'https://www.nrc.gov/reading-rm/doc-collections/nuregs/staff/sr1556/index.html', description: 'A collection of NRC guidance documents for various types of materials licenses.' },
                { title: 'MARSSIM - Multi-Agency Radiation Survey and Site Investigation Manual', url: 'https://www.nrc.gov/reading-rm/doc-collections/nuregs/staff/sr1575/index.html', description: 'The primary guidance for performing final status surveys for decommissioning.' },
            ]
        },
        {
            category: 'Data & Tools',
            items: [
                { title: 'NNDC NuDat 3 - National Nuclear Data Center', url: 'https://www.nndc.bnl.gov/nudat3/', description: 'The primary source for the nuclear data in this toolbox. An authoritative database for nuclear structure and decay data.' },
                // CHANGED: The title, URL, and description for the EPA link have been updated.
                { title: 'EPA Radiation Protection', url: 'https://www.epa.gov/radiation', description: "The Environmental Protection Agency's main hub for radiation information and resources." },
                { title: 'REMM - Radiation Emergency Medical Management', url: 'https://remm.hhs.gov/', description: 'Guidance for health care providers on diagnosis and treatment of radiation injuries during emergencies.' },
            ]
        },
        {
            category: 'Professional Organizations',
            items: [
                { title: 'Health Physics Society (HPS)', url: 'https://hps.org/', description: 'A scientific organization of professionals in radiation safety.' },
                { title: 'American Association of Physicists in Medicine (AAPM)', url: 'https://www.aapm.org/', description: 'A scientific and professional organization for medical physicists.' },
                { title: 'International Atomic Energy Agency (IAEA)', url: 'https://www.iaea.org/', description: "The world's central intergovernmental forum for scientific and technical co-operation in the nuclear field." },
            ]
        }
    ];

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Links & References</h2>
                <div className="space-y-6">
                    {referenceLinks.map(section => (
                        <div key={section.category}>
                            <h3 className="text-lg font-semibold text-sky-600 dark:text-sky-400 border-b border-slate-300 dark:border-slate-600 pb-2 mb-3">{section.category}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {section.items.map(item => (
                                    <a href={item.url} target="_blank" rel="noopener noreferrer" key={item.title} className="block p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg hover:ring-2 hover:ring-sky-500 transition-all">
                                        <p className="font-bold text-slate-800 dark:text-slate-100">{item.title}</p>
                                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">{item.description}</p>
                                    </a>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};
         
         /**
          * @description Displays information about a single radionuclide. Can be a full detailed card or a compact version for lists.
          * @param {object} props - Component props.
          * @param {object} props.nuclide - The nuclide data object.
          * @param {boolean} [props.isCompact=false] - If true, renders a smaller card.
          * @param {(nuclide: object) => void} [props.onNuclideClick] - Click handler for the compact card.
          * @param {(seriesId: string) => void} [props.onDecaySeriesClick] - Click handler for the 'View Decay Series' button.
          * @param {string} [props.displayHalfLifeUnit] - The unit to display the half-life in for the detailed card.
          */
         
         const NuclideCard = ({ nuclide, radionuclides, isCompact = false, onNuclideClick, onDecaySeriesClick, displayHalfLifeUnit, favorites, toggleFavorite, onSendToCalculator, onAddToCompare, showBackButton, onBackClick }) => {
         
             const getSourceLink = (sourceKey) => {
                 const source = sources[sourceKey];
                 return source ? <a href={source.url} target="_blank" rel="noopener noreferrer" className="text-sky-500 hover:underline" title={source.name}>[{Object.keys(sources).indexOf(sourceKey) + 1}]</a> : '';
             };
             
             const DataPoint = ({ label, value, unit, sourceKey, iconPath, iconSymbol }) => {
                 const displayValue = value && (typeof value === 'string' || typeof value === 'number' || React.isValidElement(value)) ? value : 'N/A';
                 const shouldAppendUnit = unit && typeof displayValue === 'string' && displayValue !== 'N/A' && displayValue.toLowerCase() !== 'none' && !displayValue.toLowerCase().includes(unit.toLowerCase());
                 
                 return (
                     <div className="flex items-start py-2">
                         {iconPath && <Icon path={iconPath} className="w-5 h-5 text-sky-500 mr-3 flex-shrink-0 mt-1" />}
                         {iconSymbol && <span className="text-2xl font-serif text-sky-500 mr-3 -mt-1 w-5 text-center">{iconSymbol}</span>}
                         {!iconPath && !iconSymbol && <div className="w-5 mr-3 flex-shrink-0"></div>}
                         <div>
                             <p className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</p>
                             <p className="text-base font-semibold text-slate-800 dark:text-slate-100 flex items-center flex-wrap">
                                 {displayValue}
                                 {shouldAppendUnit ? <span className="ml-1">{unit}</span> : ''}
                                 {sourceKey && <sup className="ml-1"> {getSourceLink(sourceKey)}</sup>}
                             </p>
                         </div>
                     </div>
                 );
             };
             
             if (isCompact) {
                 const styles = CATEGORY_STYLES[nuclide.category] || CATEGORY_STYLES['default'];
                 const hlCategory = getHalfLifeCategory(parseHalfLifeToSeconds(nuclide.halfLife));
                 const compactCardJSX = (
                     <div
                         onClick={() => onNuclideClick(nuclide)}
                         className={`flex flex-col justify-between p-4 h-full bg-white dark:bg-slate-800 rounded-lg shadow-md hover:shadow-lg hover:ring-2 hover:ring-sky-500 cursor-pointer transition-all duration-200 border-l-4 ${styles.border} ${styles.hoverBg}`}
                     >
                         <div>
                             <div className="flex justify-between items-start">
                                 <h3 className="font-bold text-lg text-slate-800 dark:text-white">{nuclide.name} <span className="text-slate-500 font-normal">({nuclide.symbol})</span></h3>
                                 <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${hlCategory.color} bg-opacity-10`}>{hlCategory.label}</span>
                             </div>
                             <div className="flex items-baseline text-sm mt-2"><Icon path={ICONS.hourglass} className="w-4 h-4 text-slate-400 mr-2"/><span className="font-medium text-slate-600 dark:text-slate-300">{formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)))}</span></div>
                             <div className="flex items-baseline text-sm mt-1"><Icon path={ICONS.radioactive} className="w-4 h-4 text-slate-400 mr-2"/><span className="text-slate-500 dark:text-slate-400">{(nuclide.emissionType || []).slice(0, 2).join(', ')}</span></div>
                         </div>
                         <div className="flex items-center gap-1 text-xs font-semibold text-slate-600 dark:text-slate-400 mt-3 pt-2 border-t border-slate-200 dark:border-slate-700">
                             <span>{nuclide.category} - {nuclide.commonality}</span>
                         </div>
                     </div>
                 );
                 return compactCardJSX;
             }
             
             const isFavorite = favorites?.includes(nuclide.symbol);
             const hlCategory = getHalfLifeCategory(parseHalfLifeToSeconds(nuclide.halfLife));
             
             return (
                 <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 animate-fade-in">
                     <div className="flex justify-between items-start">
                         <div className="flex items-center gap-2">
                             <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
                                 <a href={`https://en.wikipedia.org/wiki/${nuclide.name.replace(/ /g, '_')}`} target="_blank" rel="noopener noreferrer" className="hover:text-sky-500 hover:underline transition-colors">
                                     {nuclide.name}
                                 </a>
                                 ({nuclide.symbol})
                             </h2>
                             {nuclide.commonalityReason ? (
                                 <Tooltip text={nuclide.commonalityReason} widthClass="w-72">
                                     <span className="flex items-center gap-1.5 text-sm font-medium text-sky-600 dark:text-sky-400 bg-sky-100 dark:bg-sky-900/50 px-3 py-1 rounded-full whitespace-nowrap cursor-help">
                                         {nuclide.category} - {nuclide.commonality}
                                         <Icon path={ICONS.help} className="w-4 h-4 opacity-75" />
                                     </span>
                                 </Tooltip>
                             ) : (
                                 <span className="text-sm font-medium text-sky-600 dark:text-sky-400 bg-sky-100 dark:bg-sky-900/50 px-3 py-1 rounded-full whitespace-nowrap">
                                     {nuclide.category} - {nuclide.commonality}
                                 </span>
                             )}
                         </div>
                         <div className="flex items-center gap-2 mt-1">
                             {toggleFavorite && (
                                 <button onClick={() => toggleFavorite(nuclide.symbol)} className={`p-2 rounded-full transition-colors ${isFavorite ? 'text-yellow-400 hover:text-yellow-500' : 'text-slate-300 dark:text-slate-600 hover:text-yellow-400'}`} title={isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}>
                                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-8 h-8"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                 </button>
                             )}
                         </div>
                     </div>
                 
                     <div className="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-x-6">
                         <div className="divide-y divide-slate-200 dark:divide-slate-700">
                             <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Decay Properties</h3>
                             <DataPoint
                                 label="Half-life"
                                 value={<>{formatHalfLife(nuclide.halfLife, displayHalfLifeUnit)} <span className={`ml-2 text-xs font-bold px-2 py-0.5 rounded-full ${hlCategory.color} bg-opacity-10`}>{hlCategory.label}</span></>}
                                 sourceKey={nuclide.sourceRef?.halfLife}
                                 iconPath={ICONS.hourglass}
                             />
                             <DataPoint label="Decay Constant (λ)" value={standardizeScientificDisplay(nuclide.decayConstant)} sourceKey={nuclide.sourceRef?.decayConstant} iconSymbol="λ" />
                         </div>
                         <div className="divide-y divide-slate-200 dark:divide-slate-700">
                             <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Physical Properties</h3>
                             <DataPoint label="Specific Activity" value={standardizeScientificDisplay(nuclide.specificActivity)} sourceKey={nuclide.sourceRef?.specificActivity} iconPath={ICONS.activity} />
                             <DataPoint label="Emission Type(s)" value={(nuclide.emissionType || []).join(', ')} sourceKey={nuclide.sourceRef?.emissionType} iconPath={ICONS.radioactive} />
                             {nuclide.gammaConstant && (
                                 <DataPoint label="Gamma Constant" value={nuclide.gammaConstant} sourceKey={nuclide.sourceRef?.gammaConstant} />
                             )}
                         </div>
                         <div className="divide-y divide-slate-200 dark:divide-slate-700">
                             <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Genealogy</h3>
                             <DataPoint label="Parent" value={<ClickableNuclide text={nuclide.parent} radionuclides={radionuclides} onNuclideClick={onNuclideClick} />} sourceKey={nuclide.sourceRef?.parent} />
                             <DataPoint label="Daughter" value={<ClickableNuclide text={nuclide.daughter} radionuclides={radionuclides} onNuclideClick={onNuclideClick} />} sourceKey={nuclide.sourceRef?.daughter} />
                         </div>
                         {nuclide.shipping && (
                             <div className="divide-y divide-slate-200 dark:divide-slate-700">
                                 <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Transportation Limits</h3>
                                 <DataPoint label="A₁ Limit" value={`${nuclide.shipping.A1 || 'N/A'}`} unit="TBq" iconPath={ICONS.transport} />
                                 <DataPoint label="A₂ Limit" value={`${nuclide.shipping.A2 || 'N/A'}`} unit="TBq" iconPath={ICONS.transport} />
                             </div>
                         )}
                     </div>
                 
                     {nuclide.dosimetry && (
                         <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                             <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-2">Internal Dosimetry <sup className="ml-1">{getSourceLink('10CFR20')}</sup></h3>
                             <div className="grid md:grid-cols-2 gap-x-6">
                                 <div className="flex items-start py-2">
                                      <Icon path={ICONS.internalDose} className="w-5 h-5 text-sky-500 mr-3 flex-shrink-0 mt-1" />
                                     <div>
                                         <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Annual Limit on Intake (ALI)</p>
                                         <ul className="text-base font-semibold text-slate-800 dark:text-slate-100 list-disc list-inside mt-1 space-y-1">
                                             {nuclide.dosimetry.ALI?.ingestion && <li>Ingestion: {nuclide.dosimetry.ALI.ingestion} µCi</li>}
                                             {nuclide.dosimetry.ALI?.inhalation_D && <li>Inhalation (Class D): {nuclide.dosimetry.ALI.inhalation_D} µCi</li>}
                                             {nuclide.dosimetry.ALI?.inhalation_W && <li>Inhalation (Class W): {nuclide.dosimetry.ALI.inhalation_W} µCi</li>}
                                             {nuclide.dosimetry.ALI?.inhalation_Y && <li>Inhalation (Class Y): {nuclide.dosimetry.ALI.inhalation_Y} µCi</li>}
                                         </ul>
                                     </div>
                                 </div>
                                 <div className="flex items-start py-2">
                                     <div className="w-5 mr-3 flex-shrink-0"></div> {/* Spacer for alignment */}
                                     <div>
                                          <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Derived Air Concentration (DAC)</p>
                                          <ul className="text-base font-semibold text-slate-800 dark:text-slate-100 list-disc list-inside mt-1 space-y-1">
                                             {nuclide.dosimetry.DAC?.inhalation_D && <li>Inhalation (Class D): {nuclide.dosimetry.DAC.inhalation_D.toExponential()} µCi/mL</li>}
                                             {nuclide.dosimetry.DAC?.inhalation_W && <li>Inhalation (Class W): {nuclide.dosimetry.DAC.inhalation_W.toExponential()} µCi/mL</li>}
                                             {nuclide.dosimetry.DAC?.inhalation_Y && <li>Inhalation (Class Y): {nuclide.dosimetry.DAC.inhalation_Y.toExponential()} µCi/mL</li>}
                                         </ul>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     )}
                 
                     <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                         <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Principal Emissions</h3>
                         <div className="space-y-4">
                             <div>
                                 <p className="text-sm font-medium text-slate-500 dark:text-slate-400">From Parent ({nuclide.symbol})</p>
                                 <div className="grid md:grid-cols-3 gap-4 mt-1">
                                     <DataPoint label="Alpha" value={(nuclide.emissionEnergies?.alpha || []).join(', ') || 'None'} unit="MeV" iconSymbol="α"/>
                                     <DataPoint label="Beta" value={`${(nuclide.emissionEnergies?.beta || []).join(', ') || 'None'}${nuclide.avgBetaEnergy ? ` (${nuclide.avgBetaEnergy} avg)` : ''}`} unit="MeV" iconSymbol="β"/>
                                     <DataPoint label="Gamma" value={(nuclide.emissionEnergies?.gamma || []).join(', ') || 'None'} unit="MeV" iconSymbol="γ"/>
                                 </div>
                             </div>
                             {nuclide.daughterEmissions && (
                                  <div className="animate-fade-in">
                                     <p className="text-sm font-medium text-slate-500 dark:text-slate-400">
                                         From Daughter (<ClickableNuclide text={nuclide.daughterEmissions.from} radionuclides={radionuclides} onNuclideClick={onNuclideClick} />)
                                     </p>
                                     <div className="grid md:grid-cols-3 gap-4 mt-1">
                                         <DataPoint label="Alpha" value={(nuclide.daughterEmissions.alpha || []).join(', ') || 'None'} unit="MeV" iconSymbol="α"/>
                                         <DataPoint label="Beta" value={(nuclide.daughterEmissions.beta || []).join(', ') || 'None'} unit="MeV" iconSymbol="β"/>
                                         <DataPoint label="Gamma" value={(nuclide.daughterEmissions.gamma || []).join(', ') || 'None'} unit="MeV" iconSymbol="γ"/>
                                     </div>
                                 </div>
                             )}
                         </div>
                     </div>
                     <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                         <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Common Uses</h3>
                         <ul className="list-disc list-inside text-slate-600 dark:text-slate-300 space-y-1">
                             {(nuclide.commonUses || []).map((use, i) => <li key={use}><ClickableNuclide text={use} radionuclides={radionuclides} onNuclideClick={onNuclideClick} /></li>)}
                         </ul>
                     </div>
                 
                     {HVL_DATA[nuclide.symbol] && (
                         <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                             <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Shielding Data (HVL in cm)</h3>
                             <div className="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                                 {Object.entries(HVL_DATA[nuclide.symbol]).map(([material, value]) => {
                                     if (material === 'sourceRef') return null;
                                     return (
                                         <div key={material}>
                                             <span className="font-semibold text-slate-500 dark:text-slate-400">{material}: </span>
                                             <span className="text-slate-700 dark:text-slate-200">{value} cm</span>
                                         </div>
                                     );
                                 })}
                             </div>
                         </div>
                     )}
                 
                     <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                             <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Quick Actions</h3>
                             <div className="flex flex-wrap justify-center gap-2">
                                 {showBackButton && (
                                     <Tooltip text="Go back to the previous view" widthClass="w-auto">
                                         <button
                                             onClick={onBackClick}
                                             className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center justify-center gap-2"
                                         >
                                             <Icon path={ICONS.database} className="w-4 h-4" />
                                             Back
                                         </button>
                                     </Tooltip>
                                 )}
                                 <Tooltip text="Add this nuclide to the comparison table." widthClass="w-64">
                                     <button onClick={() => onAddToCompare(nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                         <Icon path={ICONS.compare} className="w-4 h-4" /> Add to Compare
                                     </button>
                                 </Tooltip>
                                 <Tooltip text="Send this nuclide to the Decay Calculator." widthClass="w-64">
                                     <button onClick={() => onSendToCalculator('calculator', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                         <Icon path={ICONS.calculator} className="w-4 h-4" /> Decay Calc
                                     </button>
                                 </Tooltip>
                                 {nuclide.gammaConstant && (
                                     <Tooltip text="Send this nuclide to the Dose Rate Calculator." widthClass="w-64">
                                          <button onClick={() => onSendToCalculator('doseRate', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                             <Icon path={ICONS.doseRate} className="w-4 h-4" /> Dose Rate
                                         </button>
                                     </Tooltip>
                                 )}
                                 {nuclide.gammaConstant && (
                                     <Tooltip text="Send this nuclide to the Shielding Calculator." widthClass="w-64">
                                          <button onClick={() => onSendToCalculator('shielding', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                             <Icon path={ICONS.shield} className="w-4 h-4" /> Shielding
                                         </button>
                                     </Tooltip>
                                 )}
                                 {nuclide.shipping && (
                                     <Tooltip text="Send this nuclide to the Shipping Calculator." widthClass="w-64">
                                          <button onClick={() => onSendToCalculator('transportation', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                             <Icon path={ICONS.transport} className="w-4 h-4" /> Shipping
                                         </button>
                                     </Tooltip>
                                 )}
                             </div>
                         </div>
                 
                     {nuclide.decaySeriesId && (
                         <div className="mt-6 text-center">
                             <button onClick={() => onDecaySeriesClick(nuclide.decaySeriesId)} className="px-4 py-2 bg-slate-700 text-white rounded-lg font-semibold hover:bg-slate-800 transition">View Full Decay Series</button>
                         </div>
                     )}
                 </div>
             );
         };
         
         /**
          * @description Displays a full decay series chain.
          * @param {{seriesId: string, onBack: () => void, onNuclideClick: (nuclide: object) => void}} props - The series ID and navigation handlers.
          */
         
         const DecaySeriesViewer = ({ seriesId, onBack, onNuclideClick }) => {
             const series = decaySeriesData.find(s => s.id === seriesId);
             if (!series) return <p>Decay series not found.</p>;
         
             // --- INTERNAL COMPONENTS FOR THE DIAGRAM ---
         
             // A single nuclide in the chain
         
             const NuclideNode = ({ step }) => (
                 <div className="p-3 my-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-center shadow flex-shrink-0 border border-slate-200 dark:border-slate-600">
                     <span
                         className="font-bold text-lg text-sky-600 dark:text-sky-400 cursor-pointer hover:underline"
                         onClick={() => {
                             const found = radionuclides.find(n => normalizeString(n.name) === normalizeString(step.nuclide));
                             if (found) onNuclideClick(found);
                         }}
                     >
                         {step.nuclide}
                     </span>
                     <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">{step.halfLife}</div>
                 </div>
             );
         
             // An arrow representing a decay step
         
         const DecayArrow = ({ decayType }) => (
                 <div className="flex-shrink-0 flex items-center justify-center relative mx-2 w-40 text-center">
         
         {/* The horizontal line of the arrow */}
         
         <div className="absolute left-0 w-full h-0.5 bg-slate-300 dark:bg-slate-600"></div>
         
         {/* Arrowhead */}
         
         <div className="absolute right-0 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[8px] border-l-slate-400 dark:border-l-slate-500"></div>
         
         {/* Text label floating above the line */}
         
                     <div className="relative bg-white dark:bg-slate-800 px-2">
                         <span className="text-xs font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap">{decayType}</span>
                     </div>
                 </div>
             );
         
             // Recursive component that renders a chain or a sub-chain horizontally
         
             const RenderChain = ({ chain }) => (
                 <div className="flex items-center">
                     {chain.map((step, index) => (
                         <div key={step.nuclide + index} className="flex items-center">
                             <NuclideNode step={step} />
         
                             {/* If the step has branches, render them vertically stacked */}
         
                             {step.branches && (
                                 <>
                                     <DecayArrow decayType="" />
                                     <div className="flex flex-col">
                                         {step.branches.map((branch, branchIndex) => (
                                             <div key={branchIndex} className="flex items-center p-2">
                                                 <DecayArrow decayType={step.decayType.split('/')[branchIndex]?.trim() || ''} />
                                                 <RenderChain chain={branch} />
                                             </div>
                                         ))}
                                     </div>
                                 </>
                             )}
         
                             {/* If it's a linear step, render the arrow to the next step */}
         
                             {!step.branches && index < chain.length - 1 && chain[index+1].nuclide !== step.nuclide && (
                                 <DecayArrow decayType={step.decayType} />
                             )}
                         </div>
                     ))}
                 </div>
             );
         
             // --- MAIN COMPONENT RENDER ---
         
             return (
                 <div className="p-4 animate-fade-in">
                     <button onClick={onBack} className="mb-4 px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition">&larr; Back to Result</button>
                     <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                         <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">{series.name}</h2>
                         {/* Container that allows horizontal scrolling for long chains */}
                         <div className="overflow-x-auto pb-4">
                            <div className="inline-block min-w-full p-2">
                                 <RenderChain chain={series.chain} />
                            </div>
                         </div>
                     </div>
                 </div>
             );
         };
         
         /**
         * @description A sidebar for filtering and sorting the nuclide database. It is responsive.
         * @param {{filterProps: object, isFiltersVisible: boolean, setIsFiltersVisible: (isVisible: boolean) => void, handleClearFilters: () => void}} props
         */
         
         const FilterSidebar = ({ filterProps, isFiltersVisible, setIsFiltersVisible, scrollPositionRef, handleClearFilters }) => {
         
         const {
         sortBy, setSortBy, sortOrder, setSortOrder,
         selectedCategory, setSelectedCategory, allCategories,
         selectedEmissionType, setSelectedEmissionType, allEmissionTypes,
         selectedCommonality, setSelectedCommonality, allCommonalityCategories,
         minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy,
         minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy,
         minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy,
         minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit
         } = filterProps;
         
         const handleClose = () => {
         setIsFiltersVisible(false);
         setTimeout(() => {
             window.scrollTo({
                 top: scrollPositionRef.current,
                 behavior: 'smooth'
             });
         }, 300);
         };
         
         return (
         <>
             <div
                 className={`fixed inset-0 bg-black/50 z-40 lg:hidden transition-opacity ${isFiltersVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                 onClick={handleClose}
                 aria-hidden="true">
             </div>
         
             <aside
                 className={`fixed top-0 left-0 w-80 h-full bg-slate-50 dark:bg-slate-900 z-50 transform transition-transform duration-300 ease-in-out lg:relative lg:w-auto lg:h-auto lg:transform-none lg:col-span-1 ${
                     isFiltersVisible ? 'translate-x-0' : '-translate-x-full'
                 }`}
             >
                 <div className="p-4 space-y-4 h-full overflow-y-auto">
                     <div className="flex justify-between items-center border-b border-slate-300 dark:border-slate-600 pb-2">
                         <h3 className="text-lg font-bold text-slate-800 dark:text-white">Filters & Sorting</h3>
                         <div className="flex items-center gap-2">
         
                             <button
                                 onClick={handleClearFilters}
                                 className="flex items-center gap-2 px-3 py-1 text-sm font-semibold text-sky-700 dark:text-sky-300 bg-slate-200 dark:bg-slate-700 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
                             >
                                 <Icon path={ICONS.clear} className="w-4 h-4" />
                                 Clear All
                             </button>
                             <button onClick={handleClose} className="lg:hidden p-1 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700">
                                 <Icon path={ICONS.clear} className="w-6 h-6" />
                             </button>
                         </div>
                     </div>
         
                     {/* Sorting controls */}
         
                     <div>
                         <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Sort by</label>
                         <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                             <option value="name">Name</option>
                             <option value="halfLife">Half-life</option>
                             <option value="alphaEnergy">Alpha Energy</option>
                             <option value="betaEnergy">Beta Energy</option>
                             <option value="gammaEnergy">Gamma Energy</option>
                         </select>
                         <select value={sortOrder} onChange={e => setSortOrder(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                             <option value="asc">Ascending</option>
                             <option value="desc">Descending</option>
                         </select>
                     </div>
         
                     {/* Filtering controls */}
         
                     <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Category</label><select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                     <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Emission Type</label><select value={selectedEmissionType} onChange={e => setSelectedEmissionType(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allEmissionTypes.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                     <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Commonality</label><select value={selectedCommonality} onChange={e => setSelectedCommonality(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allCommonalityCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
         
                     {/* Half-life range filter */}
         
                     <div>
                         <h4 className="text-md font-semibold text-slate-700 dark:text-slate-300 mt-4">Half-life</h4>
                         <div className="flex gap-2 mt-2">
                             <input type="number" placeholder="Min" value={minHalfLife} onChange={e => setMinHalfLife(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                             <input type="number" placeholder="Max" value={maxHalfLife} onChange={e => setMaxHalfLife(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                         </div>
                         <select value={halfLifeFilterUnit} onChange={e => setHalfLifeFilterUnit(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                             <option value="seconds">Seconds</option>
                             <option value="minutes">Minutes</option>
                             <option value="hours">Hours</option>
                             <option value="days">Days</option>
                             <option value="years">Years</option>
                         </select>
                     </div>
         
                     {/* Energy range filters */}
         
                     <div>
                         <h4 className="text-md font-semibold text-slate-700 dark:text-slate-300 mt-4">Energy (MeV)</h4>
                         <div className="space-y-2 mt-2">
                             <label className="text-sm">Alpha</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minAlphaEnergy} onChange={e => setMinAlphaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxAlphaEnergy} onChange={e => setMaxAlphaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                             <label className="text-sm">Beta</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minBetaEnergy} onChange={e => setMinBetaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxBetaEnergy} onChange={e => setMaxBetaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                             <label className="text-sm">Gamma</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minGammaEnergy} onChange={e => setMinGammaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxGammaEnergy} onChange={e => setMaxGammaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                         </div>
                     </div>
                 </div>
             </aside>
         </>
         );
         };
         
         /**
         * @description The main view for Browse the entire database with filters.
         * @param {object} props - Component props.
         */
         
         const DatabaseView = ({ filteredList, filterProps, onNuclideClick, isFiltersVisible, setIsFiltersVisible, scrollPositionRef, handleClearFilters }) => {
         
         const { selectedCategory, setSelectedCategory } = filterProps;
         
         return (
         <div className="relative">
             <div className="px-4 pt-4 lg:hidden">
                 <button
                     onClick={() => {
                         scrollPositionRef.current = window.scrollY;
                         window.scrollTo({ top: 0, behavior: 'smooth' });
                         setIsFiltersVisible(true);
                     }}
                     className="w-full flex items-center justify-center gap-2 p-3 text-sm font-semibold bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                 >
                     <Icon path={ICONS.filter} className="w-5 h-5" /> Filters & Sorting
                 </button>
             </div>
         
             <div className="grid lg:grid-cols-4 gap-4 p-4">
         
                 <FilterSidebar
                     filterProps={filterProps}
                     isFiltersVisible={isFiltersVisible}
                     setIsFiltersVisible={setIsFiltersVisible}
                     scrollPositionRef={scrollPositionRef}
                     handleClearFilters={handleClearFilters}
                 />
         
                 <div className="col-span-4 lg:col-span-3 bg-slate-100 dark:bg-slate-800/50 rounded-lg p-4 h-[calc(100vh-350px)] md:h-[calc(100vh-320px)] lg:h-auto overflow-y-auto">
         
                     <div className="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <p className="text-sm text-slate-500 dark:text-slate-400 flex-shrink-0">
                             Showing {filteredList.length} of {radionuclides.length} nuclides.
                         </p>
         
                         <div className="flex flex-wrap items-center gap-x-3 gap-y-2 text-xs">
                             {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                 const bgColor = styles.border.replace('border-l-', 'bg-');
                                 const isActive = selectedCategory === category;
                                 return (
         
                                     // --- TOOLTIP FEATURE ADDED HERE ---
         
                                     <Tooltip key={category} text={CATEGORY_DESCRIPTIONS[category] || ''} widthClass="w-64">
                                         <button
                                             onClick={() => setSelectedCategory(prev => prev === category ? 'All' : category)}
                                             className={`flex items-center gap-1.5 px-2 py-1 rounded-full transition-all duration-200 ${isActive ? 'ring-2 ring-offset-2 ring-offset-slate-100 dark:ring-offset-slate-800 ring-sky-500 bg-white dark:bg-slate-700' : 'bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700'}`}
                                         >
                                             <div className={`w-3 h-3 rounded-full ${bgColor}`}></div>
                                             <span className="text-slate-600 dark:text-slate-300">{category.replace('/', '/ ')}</span>
                                         </button>
                                     </Tooltip>
                                 );
                             })}
         
                             <button
                                 onClick={() => setSelectedCategory('All')}
                                 className={`px-2 py-1 rounded-full transition-all duration-200 text-slate-600 dark:text-slate-300 ${selectedCategory === 'All' ? 'ring-2 ring-offset-2 ring-offset-slate-100 dark:ring-offset-slate-800 ring-slate-500 bg-white dark:bg-slate-700' : 'bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700'}`}
                             >
                                 Show All
                             </button>
                         </div>
                     </div>
         
                     <div className="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                         {filteredList.length > 0 ? (
                             filteredList.map(n => <NuclideCard key={n.symbol} nuclide={n} isCompact={true} onNuclideClick={onNuclideClick} />)
                         ) : (
                             <div className="col-span-full text-center py-16 px-4">
                                 <Icon path={ICONS.search} className="w-12 h-12 text-slate-400 dark:text-slate-500 mx-auto" />
                                 <h3 className="mt-4 text-lg font-semibold text-slate-600 dark:text-slate-300">No Results Found</h3>
                                 <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">Try adjusting your filter criteria.</p>
                             </div>
                         )}
                     </div>
                 </div>
             </div>
         </div>
         );
         };
         
         /**
          * @description A component that provides a user interface for converting between
          * various radiological and physical units, such as activity, dose, and energy.
          */
         
const UnitConverter = () => {
    const [value, setValue] = React.useState('');
    const [fromUnit, setFromUnit] = React.useState('Gy');
    const [toUnit, setToUnit] = React.useState('rad');
    const [result, setResult] = React.useState('');
    const [error, setError] = React.useState('');
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    const handleClearInputs = () => {
        setValue('');
        setFromUnit('Gy');
        setToUnit('rad');
        setResult('');
        setError('');
    };

    const units = {
    'Activity': ['Bq', 'kBq', 'MBq', 'GBq', 'µCi', 'mCi', 'Ci', 'dps', 'dpm'],
    'Radiation Dose': ['mrem', 'rem', 'µSv', 'mSv', 'Sv', 'rad', 'cGy', 'Gy', 'R'],
    'Dose Rate': ['µSv/hr', 'mSv/hr', 'Sv/hr', 'mrem/hr', 'rem/hr'],
    'Energy': ['eV', 'keV', 'MeV', 'J'],
    'Radioactive Concentration': ['pCi/L', 'Bq/L', 'Bq/m³', 'µCi/mL'],
    'Length': ['mm', 'cm', 'm', 'km', 'in', 'ft'],
    'Area': ['cm²', 'm²', 'in²', 'ft²', 'barn'],
    'Mass': ['µg', 'mg', 'g', 'kg', 'oz', 'lb'],
    };
    
    const factors = {
    'mrem': { base: 'dose', factor: 0.001 },
    'rem': { base: 'dose', factor: 1 },
    'µSv': { base: 'dose', factor: 0.0001 },
    'mSv': { base: 'dose', factor: 0.1 },
    'Sv': { base: 'dose', factor: 100 },
    'rad': { base: 'dose', factor: 1 },
    'cGy': { base: 'dose', factor: 1 },
    'Gy': { base: 'dose', factor: 100 },
    'R': { base: 'dose', factor: 0.96 },
    'µrem/hr': { base: 'doseRate', factor: 0.001 },
    'mrem/hr': { base: 'doseRate', factor: 1 },
    'rem/hr': { base: 'doseRate', factor: 1000 },
    'µSv/hr': { base: 'doseRate', factor: 0.1 },
    'mSv/hr': { base: 'doseRate', factor: 100 },
    'Sv/hr': { base: 'doseRate', factor: 100000 },
    'Bq': { base: 'activity', factor: 1 },
    'kBq': { base: 'activity', factor: 1e3 },
    'MBq': { base: 'activity', factor: 1e6 },
    'GBq': { base: 'activity', factor: 1e9 },
    'Ci': { base: 'activity', factor: 3.7e10 },
    'mCi': { base: 'activity', factor: 3.7e7 },
    'µCi': { base: 'activity', factor: 3.7e4 },
    'dps': { base: 'activity', factor: 1 },
    'dpm': { base: 'activity', factor: 1 / 60 },
    'J': { base: 'energy', factor: 1 },
    'eV': { base: 'energy', factor: 1.60218e-19 },
    'keV': { base: 'energy', factor: 1.60218e-16 },
    'MeV': { base: 'energy', factor: 1.60218e-13 },
    'Bq/L': { base: 'concentration', factor: 1 },
    'µCi/mL': { base: 'concentration', factor: 3.7e7 },
    'pCi/L': { base: 'concentration', factor: 0.037 },
    'Bq/m³': { base: 'concentration', factor: 0.001 },
    'm': { base: 'length', factor: 1 },
    'cm': { base: 'length', factor: 0.01 },
    'mm': { base: 'length', factor: 0.001 },
    'km': { base: 'length', factor: 1000 },
    'in': { base: 'length', factor: 0.0254 },
    'ft': { base: 'length', factor: 0.3048 },
    'm²': { base: 'area', factor: 1 },
    'cm²': { base: 'area', factor: 1e-4 },
    'in²': { base: 'area', factor: 0.00064516 },
    'ft²': { base: 'area', factor: 0.092903 },
    'barn': { base: 'area', factor: 1e-28 },
    'g': { base: 'mass', factor: 1 },
    'kg': { base: 'mass', factor: 1000 },
    'mg': { base: 'mass', factor: 0.001 },
    'µg': { base: 'mass', factor: 1e-6 },
    'lb': { base: 'mass', factor: 453.592 },
    'oz': { base: 'mass', factor: 28.3495 },
    };
    
    React.useEffect(() => {
       const fromBase = factors[fromUnit]?.base;
       const toBase = factors[toUnit]?.base;
    
       if (fromBase && fromBase !== toBase) {
           const newCategoryArray = Object.values(units).find(arr => arr.includes(fromUnit));
           if (newCategoryArray && newCategoryArray.length > 0) {
               let newToUnit = newCategoryArray[0];
               if (newCategoryArray.length > 1 && newToUnit === fromUnit) {
                   newToUnit = newCategoryArray[1];
               }
               setToUnit(newToUnit);
           }
       }
    }, [fromUnit]);
    
    const handleConvert = React.useCallback(() => {
    const val = parseFloat(value);
    if (isNaN(val)) {
        if (value) setError("Invalid input value.");
        setResult('');
        return;
    }
    
    const from = factors[fromUnit];
    const to = factors[toUnit];
    
    if (!from || !to || from.base !== to.base) {
        setError("Cannot convert between these units.");
        setResult('');
        return;
    }
    
    const convertedVal = val * (from.factor / to.factor);
    setError('');
    setResult(convertedVal.toPrecision(4));
    }, [value, fromUnit, toUnit, factors]);
    
    React.useEffect(() => {
    handleConvert();
    }, [value, fromUnit, toUnit, handleConvert]);

    const handleSaveToHistory = () => {
        if (result && value) {
            addHistory({
                id: Date.now(),
                type: 'Unit Conversion',
                icon: ICONS.converter,
                inputs: `${value} ${fromUnit}`,
                result: `${result} ${toUnit}`,
                view: VIEWS.CONVERTER
            });
            addToast("Calculation saved to history!");
        }
    };
    
    const handleSwap = () => {
    const from = factors[fromUnit];
    const to = factors[toUnit];
    if (from && to && from.base === to.base) {
        setFromUnit(toUnit);
        setToUnit(fromUnit);
    } else {
        setError("Cannot swap incompatible units.");
    }
    };
    
    const currentBase = factors[fromUnit]?.base;
    const compatibleUnits = Object.fromEntries(
    Object.entries(units)
        .map(([group, unitList]) => {
            const filteredList = unitList.filter(u => factors[u]?.base === currentBase);
            return [group, filteredList];
        })
        .filter(([group, unitList]) => unitList.length > 0)
    );
    
    return (
    <div className="p-4 animate-fade-in">
        <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Unit Converter</h2>
               <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                   <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
               </button>
           </div>
            <div className="space-y-4">
                <div>
                    <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Value</label>
                    <input type="number" value={value} onChange={e => setValue(e.target.value)} placeholder="Enter a value" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                </div>
    
                <div className="flex flex-col sm:flex-row gap-4 items-end">
                    <div className="w-full sm:flex-1">
                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">From</label>
                        <select value={fromUnit} onChange={e => setFromUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                            {Object.entries(units).map(([group, list]) => (
                                <optgroup label={group} key={group}>
                                    {list.map(u => <option key={u} value={u}>{u}</option>)}
                                </optgroup>
                            ))}
                        </select>
                    </div>
    
                    <div className="flex-shrink-0 pb-1">
                        <button onClick={handleSwap} className="p-2 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-sky-200 dark:hover:bg-sky-700 transition" aria-label="Swap units">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-600 dark:text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                        </button>
                    </div>
    
                    <div className="w-full sm:flex-1">
                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">To</label>
                        <select value={toUnit} onChange={e => setToUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                            {Object.entries(compatibleUnits).map(([group, list]) => (
                                <optgroup label={group} key={group}>
                                    {list.map(u => <option key={u} value={u}>{u}</option>)}
                                </optgroup>
                            ))}
                        </select>
                    </div>
                </div>
    
                <div className="text-center p-3 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
                    {error ? (
                        <p className="text-red-500 text-sm">{error}</p>
                    ) : result ? (
                        <div className="flex items-center justify-center gap-2">
                            <div className="flex-grow text-center">
                                <p className="text-lg font-bold">
                                    {value} {fromUnit} = {result} {toUnit}
                                </p>
                            </div>
                            <div className="flex flex-shrink-0">
                                <CopyButton textToCopy={result} />
                                <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                                    <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                        <Icon path={ICONS.notepad} className="w-5 h-5" />
                                    </button>
                                </Tooltip>
                            </div>
                        </div>
                    ) : (
                        <p className="text-sm italic text-slate-400 dark:text-slate-500 mt-2">
                            Enter a value to see the conversion.
                        </p>
                    )}
                </div>
            </div>
        </div>
    </div>
    );
};
         
         /**
         * @description A component that displays a prominent header for the selected nuclide
         * along with the detailed context display for use in calculators. It includes a clear button.
         * @param {{nuclide: object, onClear: () => void}} props - The nuclide object and the function to clear it.
         */
         
         const CalculatorNuclideInfo = ({ nuclide, onClear }) => {
         if (!nuclide) return null; // Don't render anything if no nuclide is selected
         
         return (
         <div className="my-2 animate-fade-in">
         
             <div className="relative text-center p-3 bg-slate-50 dark:bg-slate-800/50 border-y border-slate-200 dark:border-slate-700">
                 <h3 className="text-2xl font-bold text-sky-600 dark:text-sky-400">{nuclide.name}</h3>
                 <p className="text-sm font-semibold text-slate-500 dark:text-slate-400">({nuclide.symbol})</p>
         
                 {/* The "Clear Nuclide" button */}
         
                 <button
                     onClick={onClear}
                     className="absolute top-1 right-1 p-2 rounded-full text-slate-400 hover:text-sky-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                     title="Change nuclide"
                 >
                     <Icon path={ICONS.clear} className="w-5 h-5" />
                 </button>
             </div>
         
             {/* The existing context display is now included here */}
         
             <NuclideContextDisplay nuclide={nuclide} />
         </div>
         );
         };
         
         /**
          * @description A comprehensive calculator for various radioactive decay scenarios,
          * including finding remaining/initial activity, time elapsed, and daughter product activity.
          * It also generates data for a visual decay chart.
          * @param {{radionuclides: Array<object>}} props - The full list of radionuclide data.
          */
         



const DecayToLimitCalculator = ({ radionuclides, selectedNuclide, setSelectedNuclide, initialActivity, setInitialActivity, initialUnit, setInitialUnit, finalActivity, setFinalActivity, finalUnit, setFinalUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const nuclidesWithHalfLife = React.useMemo(() => radionuclides.filter(r => r.halfLife !== 'Stable').sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const activityFactorsCi = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1, 'dps': 1 / 3.7e10, 'dpm': 1 / (3.7e10 * 60) };

    // This hook now ONLY handles the calculation for instant UI feedback.
    React.useEffect(() => {
        try {
            setError('');
            if (!selectedNuclide) { setResult(null); return; }
            
            const A0 = parseFloat(initialActivity);
            const Af = parseFloat(finalActivity);
            
            if (isNaN(A0) || isNaN(Af) || A0 <= 0 || Af < 0) {
                if (initialActivity && finalActivity) setError("Activities must be positive numbers.");
                setResult(null); return;
            }
            
            const A0_Bq = A0 * (activityFactorsCi[initialUnit] * 3.7e10);
            const Af_Bq = Af * (activityFactorsCi[finalUnit] * 3.7e10);
            
            if (Af_Bq >= A0_Bq) {
                setError("Final activity must be less than initial activity.");
                setResult(null); return;
            }
            
            const T_half_seconds = parseHalfLifeToSeconds(selectedNuclide.halfLife);
            const lambda = Math.log(2) / T_half_seconds;
            
            const time_seconds = (-1 / lambda) * Math.log(Af_Bq / A0_Bq);
            const num_half_lives = time_seconds / T_half_seconds;
            
            const bestUnit = getBestHalfLifeUnit(time_seconds);
            const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
            const time_in_best_unit = time_seconds / unitConversions[bestUnit];
            
            setResult({
                time: time_in_best_unit.toPrecision(4),
                unit: bestUnit,
                halfLives: num_half_lives.toFixed(2)
            });
        } catch (e) {
            setError(e.message || "Calculation failed.");
            setResult(null);
        }
    }, [selectedNuclide, initialActivity, initialUnit, finalActivity, finalUnit]);

    // NEW: An explicit function to handle saving.
    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            addHistory({ 
                id: Date.now(), 
                type: 'Decay to Limit', 
                icon: ICONS.stopwatch, 
                inputs: `${initialActivity} ${initialUnit} ${selectedNuclide.symbol} to ${finalActivity} ${finalUnit}`, 
                result: `${result.time} ${result.unit}`, 
                view: VIEWS.CALCULATOR 
            });
            addToast('Calculation saved to history!');
        }
    };

    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates time required to decay to a specified activity level.</p>
            <div>
                <label className="text-sm font-medium">Radionuclide</label>
                <div className="mt-1 min-h-[42px]">
                    {selectedNuclide ? 
                        <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setSelectedNuclide(null)} /> :
                        <SearchableSelect options={nuclidesWithHalfLife} onSelect={(symbol) => setSelectedNuclide(radionuclides.find(n => n.symbol === symbol))} placeholder="Search for a radionuclide..." />
                    }
                </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium">Initial Activity</label>
                    <div className="flex">
                        <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                        <select value={initialUnit} onChange={e => setInitialUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Final (Target) Activity</label>
                    <div className="flex">
                        <input type="number" value={finalActivity} onChange={e => setFinalActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                        <select value={finalUnit} onChange={e => setFinalUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                    <div className="flex justify-between items-center">
                        <div></div> {/* Spacer */}
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Time to Decay</p>
                        {/* NEW: The Save button */}
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    <div className="flex items-center justify-center">
                        <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.time}</p>
                        <CopyButton textToCopy={result.time} />
                    </div>
                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">{result.unit}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">({result.halfLives} half-lives)</p>
                </div>
            )}
        </div>
    );
};
    



     
const DecayTools = ({ radionuclides, preselectedNuclide, theme }) => {
    const [activeCalculator, setActiveCalculator] = React.useState('standard');
    const { settings } = React.useContext(SettingsContext);
    
    // State for Standard Decay
    const [std_selectedNuclide, setStd_selectedNuclide] = React.useState(() => { const savedSymbol = localStorage.getItem('decayCalc_nuclideSymbol'); if (!savedSymbol) return null; return radionuclides.find(n => n.symbol === savedSymbol) || null; });
    const [std_calculationMode, setStd_calculationMode] = React.useState(() => localStorage.getItem('decayCalc_mode') || 'findRemaining');
    const [std_initialActivity, setStd_initialActivity] = React.useState(() => localStorage.getItem('decayCalc_initialActivity') || '100');
    const [std_initialDaughterActivity, setStd_initialDaughterActivity] = React.useState(() => localStorage.getItem('decayCalc_initialDaughterActivity') || '0');
    const [std_remainingActivity, setStd_remainingActivity] = React.useState(() => localStorage.getItem('decayCalc_remainingActivity') || '');
    const [std_timeElapsed, setStd_timeElapsed] = React.useState(() => localStorage.getItem('decayCalc_timeElapsed') || '1');
    const [std_timeUnit, setStd_timeUnit] = React.useState(() => localStorage.getItem('decayCalc_timeUnit') || 'days');
    const [std_useLogScale, setStd_useLogScale] = React.useState(() => JSON.parse(localStorage.getItem('decayCalc_useLogScale')) || false);
    
    // State for Source Correction
    const [corr_nuclideSymbol, setCorr_nuclideSymbol] = React.useState('');
    const [corr_originalActivity, setCorr_originalActivity] = React.useState('10');
    const [corr_originalActivityUnit, setCorr_originalActivityUnit] = React.useState('mCi');
    const getTodayString = () => new Date().toISOString().split('T')[0];
    const [corr_originalDate, setCorr_originalDate] = React.useState('2020-01-01');
    const [corr_targetDate, setCorr_targetDate] = React.useState(getTodayString());

    // State for Decay to Limit
    const [dtl_selectedNuclide, setDtl_selectedNuclide] = React.useState(null);
    const [dtl_initialActivity, setDtl_initialActivity] = React.useState('10');
    const [dtl_initialUnit, setDtl_initialUnit] = React.useState('mCi');
    const [dtl_finalActivity, setDtl_finalActivity] = React.useState('0.001');
    const [dtl_finalUnit, setDtl_finalUnit] = React.useState('mCi');
    const [dtl_result, setDtl_result] = React.useState(null);
    const [dtl_error, setDtl_error] = React.useState('');
    
    // --- Clear Logic ---
    const handleStandardClear = () => {
        setStd_selectedNuclide(null); setStd_calculationMode('findRemaining'); setStd_initialActivity('100');
        setStd_initialDaughterActivity('0'); setStd_remainingActivity(''); setStd_timeElapsed('1');
        setStd_timeUnit('days'); setStd_useLogScale(false);
    };
    const handleCorrectionClear = () => {
        setCorr_nuclideSymbol(''); setCorr_originalActivity('10'); setCorr_originalActivityUnit('mCi');
        setCorr_originalDate('2020-01-01'); setCorr_targetDate(getTodayString());
    };
    const handleDecayToLimitClear = () => {
        setDtl_selectedNuclide(null); setDtl_initialActivity('10'); setDtl_initialUnit('mCi');
        setDtl_finalActivity('0.001'); setDtl_finalUnit('mCi'); setDtl_result(null); setDtl_error('');
    };
    const handleClearActiveCalculator = () => {
        if (activeCalculator === 'standard') handleStandardClear();
        else if (activeCalculator === 'correction') handleCorrectionClear();
        else handleDecayToLimitClear();
    };
    
    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-lg mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Decay Tools</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                <div className="grid grid-cols-3 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6">
                    <button onClick={() => setActiveCalculator('standard')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'standard' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Standard</button>
                    <button onClick={() => setActiveCalculator('correction')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'correction' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Correction</button>
                    <button onClick={() => setActiveCalculator('toLimit')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'toLimit' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>To Limit</button>
                </div>
                {activeCalculator === 'standard' && 
                    <StandardDecayCalculator 
                        radionuclides={radionuclides} preselectedNuclide={preselectedNuclide}
                        selectedNuclide={std_selectedNuclide} setSelectedNuclide={setStd_selectedNuclide}
                        calculationMode={std_calculationMode} setCalculationMode={setStd_calculationMode}
                        initialActivity={std_initialActivity} setInitialActivity={setStd_initialActivity}
                        initialDaughterActivity={std_initialDaughterActivity} setInitialDaughterActivity={setStd_initialDaughterActivity}
                        remainingActivity={std_remainingActivity} setRemainingActivity={setStd_remainingActivity}
                        timeElapsed={std_timeElapsed} setTimeElapsed={setStd_timeElapsed}
                        timeUnit={std_timeUnit} setTimeUnit={setStd_timeUnit}
                        useLogScale={std_useLogScale} setUseLogScale={setStd_useLogScale}
                        theme={theme}
                    />
                }
                {activeCalculator === 'correction' && 
                    <SourceCorrectionCalculator
                        radionuclides={radionuclides}
                        nuclideSymbol={corr_nuclideSymbol} setNuclideSymbol={setCorr_nuclideSymbol}
                        originalActivity={corr_originalActivity} setOriginalActivity={setCorr_originalActivity}
                        originalActivityUnit={corr_originalActivityUnit} setOriginalActivityUnit={setCorr_originalActivityUnit}
                        originalDate={corr_originalDate} setOriginalDate={setCorr_originalDate}
                        targetDate={corr_targetDate} setTargetDate={setCorr_targetDate}
                    />
                }
                {activeCalculator === 'toLimit' &&
                    <DecayToLimitCalculator
                       radionuclides={radionuclides}
                       selectedNuclide={dtl_selectedNuclide} setSelectedNuclide={setDtl_selectedNuclide}
                       initialActivity={dtl_initialActivity} setInitialActivity={setDtl_initialActivity}
                       initialUnit={dtl_initialUnit} setInitialUnit={setDtl_initialUnit}
                       finalActivity={dtl_finalActivity} setFinalActivity={setDtl_finalActivity}
                       finalUnit={dtl_finalUnit} setFinalUnit={setDtl_finalUnit}
                       result={dtl_result} setResult={setDtl_result}
                       error={dtl_error} setError={setDtl_error}
                    />
                }
            </div>
        </div>
    );
};
         



         // This component is a source correction calculator that computes the activity of a radioactive source on a future date by applying the principle of radioactive decay. It requires the original activity, the calibration date, and the radionuclide's half-life to perform the calculation.
         
const SourceCorrectionCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, originalActivity, setOriginalActivity, originalActivityUnit, setOriginalActivityUnit, originalDate, setOriginalDate, targetDate, setTargetDate }) => {
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const activityUnits = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'TBq': 1e12, 'µCi': 3.7e4, 'mCi': 3.7e7, 'Ci': 3.7e10 };
    const nuclidesWithHalfLife = React.useMemo(() => radionuclides.filter(r => r.halfLife !== 'Stable').sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => radionuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, radionuclides]);
   
    React.useEffect(() => {
        if (!selectedNuclide) { setResult(null); return; }
        try {
            setError('');
            const A0 = parseFloat(originalActivity);
            if (isNaN(A0) || A0 < 0) throw new Error("Original activity must be a positive number.");
            const startDate = new Date(originalDate);
            const endDate = new Date(targetDate);
            if (endDate < startDate) throw new Error("Target date cannot be before the original date.");
            const timeElapsed_ms = endDate.getTime() - startDate.getTime();
            const timeElapsed_s = timeElapsed_ms / 1000;
            const T_half_s = parseHalfLifeToSeconds(selectedNuclide.halfLife);
            if (T_half_s === Infinity) throw new Error("Cannot calculate decay for a stable nuclide.");
            const activity_Bq_0 = A0 * activityUnits[originalActivityUnit];
            const activity_Bq_t = activity_Bq_0 * Math.pow(0.5, timeElapsed_s / T_half_s);
            const finalActivity = activity_Bq_t / activityUnits[originalActivityUnit];
            setResult({ currentActivity: finalActivity.toPrecision(4), timeElapsedDays: (timeElapsed_s / 86400).toFixed(2) });
        } catch(e) {
            setError(e.message);
            setResult(null);
        }
    }, [selectedNuclide, originalActivity, originalActivityUnit, originalDate, targetDate]);
    
    // NEW: Explicit save function
    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            addHistory({
                id: Date.now(),
                type: 'Source Correction',
                icon: ICONS.calculator,
                inputs: `${originalActivity} ${originalActivityUnit} ${selectedNuclide.symbol} on ${originalDate}`,
                result: `${result.currentActivity} ${originalActivityUnit} on ${targetDate}`,
                view: VIEWS.CALCULATOR
            });
            addToast("Calculation saved to history!");
        }
    };
    
    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates a source's activity on a specific date.</p>
            <div>
                <label className="text-sm font-medium">Radionuclide</label>
                <div className="mt-1 min-h-[42px]">
                    {selectedNuclide ? ( 
                        <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> 
                    ) : ( 
                        <SearchableSelect options={nuclidesWithHalfLife} onSelect={setNuclideSymbol} placeholder="Search for a radionuclide..."/> 
                    )}
                </div>
            </div>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium">Original Activity</label>
                        <div className="flex">
                            <input type="number" value={originalActivity} onChange={e => setOriginalActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                            <select value={originalActivityUnit} onChange={e => setOriginalActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Original Calibration Date</label>
                        <input type="date" value={originalDate} onChange={e => setOriginalDate(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Target Date</label>
                    <input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                </div>
            </div>
             {error && <p className="text-red-500 text-sm text-center">{error}</p>}
             {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                    <div className="flex justify-between items-center">
                        <div></div>
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Activity on {targetDate}</p>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.currentActivity}</p>
                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">{originalActivityUnit}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">({result.timeElapsedDays} days elapsed)</p>
                </div>
             )}
        </div>
    );
};






         // This component is a versatile radioactive decay calculator that supports four different modes: calculating remaining activity, finding the time elapsed, determining the initial activity, or calculating the activity of a radioactive daughter product. It visualizes the decay curve and handles various time units and logarithmic scales.         
         
const StandardDecayCalculator = ({ radionuclides, preselectedNuclide, selectedNuclide, setSelectedNuclide, calculationMode, setCalculationMode, initialActivity, setInitialActivity, initialDaughterActivity, setInitialDaughterActivity, remainingActivity, setRemainingActivity, timeElapsed, setTimeElapsed, timeUnit, setTimeUnit, useLogScale, setUseLogScale, theme }) => {
    const [result, setResult] = React.useState(null);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    const MODE_REMAINING = 'findRemaining'; const MODE_TIME = 'findTime'; const MODE_INITIAL = 'findInitial'; const MODE_DAUGHTER = 'findDaughterActivity';
    const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600, 'kiloyears': 31557600 * 1e3, 'megayears': 31557600 * 1e6, 'gigayears': 31557600 * 1e9 };
    const sortedRadionuclides = React.useMemo(() => { const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 }; return [...radionuclides].filter(r => r.halfLife !== 'Stable').sort((a, b) => { const orderA = commonalityOrder[a.commonality] || 0; const orderB = commonalityOrder[b.commonality] || 0; if (orderA !== orderB) { return orderB - orderA; } return a.name.localeCompare(b.name); }); }, [radionuclides]);
    
    React.useEffect(() => { localStorage.setItem('decayCalc_nuclideSymbol', selectedNuclide ? selectedNuclide.symbol : ''); localStorage.setItem('decayCalc_mode', calculationMode); localStorage.setItem('decayCalc_initialActivity', initialActivity); localStorage.setItem('decayCalc_initialDaughterActivity', initialDaughterActivity); localStorage.setItem('decayCalc_remainingActivity', remainingActivity); localStorage.setItem('decayCalc_timeElapsed', timeElapsed); localStorage.setItem('decayCalc_timeUnit', timeUnit); localStorage.setItem('decayCalc_useLogScale', JSON.stringify(useLogScale)); }, [selectedNuclide, calculationMode, initialActivity, initialDaughterActivity, remainingActivity, timeElapsed, timeUnit, useLogScale]);
    
    const handleNuclideSelect = React.useCallback((symbol) => { const nuclideToSet = sortedRadionuclides.find(n => n.symbol === symbol); if (nuclideToSet) { setSelectedNuclide(nuclideToSet); const hl_seconds = parseHalfLifeToSeconds(nuclideToSet.halfLife); if (hl_seconds !== Infinity) { const bestUnit = getBestHalfLifeUnit(hl_seconds); const unitConv = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 }; const hl_in_best_unit = hl_seconds / unitConv[bestUnit]; setTimeUnit(bestUnit); setTimeElapsed(parseFloat(hl_in_best_unit.toPrecision(2)).toString()); } } }, [sortedRadionuclides, setSelectedNuclide, setTimeUnit, setTimeElapsed]);
    
    React.useEffect(() => { if (preselectedNuclide) { handleNuclideSelect(preselectedNuclide); } }, [preselectedNuclide, handleNuclideSelect]);
    React.useEffect(() => { setResult(null); setChartData(null); setError(''); }, [calculationMode]);
    
    const handleCalculate = React.useCallback(() => { 
        if (!selectedNuclide) return; 
        try { 
            setError(''); 
            const T_half_seconds = parseHalfLifeToSeconds(selectedNuclide.halfLife); 
            const lambda = Math.log(2) / T_half_seconds; 
            const A0 = parseFloat(initialActivity); 
            const At = parseFloat(remainingActivity); 
            const t_input = parseFloat(timeElapsed); 
            const t_seconds = t_input * unitConversions[timeUnit]; 
            
            if (calculationMode === MODE_REMAINING) { 
                if (isNaN(A0) || isNaN(t_seconds)) throw new Error('Initial activity and time must be valid numbers.'); 
                const finalActivity = A0 * Math.exp(-lambda * t_seconds); 
                setResult({ label: 'Remaining Activity', value: finalActivity.toPrecision(4), unit: '' }); 
            } else if (calculationMode === MODE_TIME) { 
                if (isNaN(A0) || isNaN(At) || A0 <= 0 || At < 0 || At > A0) throw new Error('Initial and remaining activities must be valid numbers, with At <= A0.'); 
                const timeInSeconds = (-1 / lambda) * Math.log(At / A0); 
                const bestUnit = getBestHalfLifeUnit(timeInSeconds); 
                const timeInBestUnit = timeInSeconds / unitConversions[bestUnit]; 
                setResult({ label: 'Time Elapsed', value: timeInBestUnit.toPrecision(4), unit: bestUnit }); 
            } else if (calculationMode === MODE_INITIAL) { 
                if (isNaN(At) || isNaN(t_seconds)) throw new Error('Remaining activity and time must be valid numbers.'); 
                const initial = At / Math.exp(-lambda * t_seconds); 
                setResult({ label: 'Initial Activity', value: initial.toPrecision(4), unit: '' }); 
            } else if (calculationMode === MODE_DAUGHTER) { 
                if (selectedNuclide.daughter.includes('/')) { throw new Error('This calculator does not support branching decay. Please use the Series Decay calculator.'); } 
                const daughterName = selectedNuclide.daughter.split('(')[0].trim(); 
                const daughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName)); 
                if (!daughter) throw new Error('Daughter nuclide data not found.'); 
                const T_half_daughter_seconds = parseHalfLifeToSeconds(daughter.halfLife); 
                const lambda2 = T_half_daughter_seconds === Infinity ? 0 : Math.log(2) / T_half_daughter_seconds; 
                const N0_daughter = parseFloat(initialDaughterActivity); 
                if (isNaN(A0) || isNaN(t_seconds) || isNaN(N0_daughter)) throw new Error("All inputs must be valid numbers."); 
                const finalParentActivity = A0 * Math.exp(-lambda * t_seconds); 
                let finalDaughterActivity; 
                if (Math.abs(lambda - lambda2) < 1e-12 * lambda) { 
                    finalDaughterActivity = (N0_daughter * Math.exp(-lambda2 * t_seconds)) + (A0 * lambda2 * t_seconds * Math.exp(-lambda2 * t_seconds)); 
                } else { 
                    finalDaughterActivity = (N0_daughter * Math.exp(-lambda2 * t_seconds)) + ((lambda2 / (lambda2 - lambda)) * A0 * (Math.exp(-lambda * t_seconds) - Math.exp(-lambda2 * t_seconds))); 
                } 
                setResult({ parent: { name: selectedNuclide.name, value: finalParentActivity.toPrecision(4) }, daughter: { name: daughter.name, value: finalDaughterActivity.toPrecision(4), isStable: T_half_daughter_seconds === Infinity } }); 
            } 
            
            const labels = [], parentData = [], daughterData = []; 
            const totalTime = t_input; 
            const steps = 100; 
            for (let i = 0; i <= steps; i++) { 
                const timePoint = (totalTime / steps) * i; 
                const timePoint_seconds = timePoint * unitConversions[timeUnit]; 
                labels.push(timePoint.toFixed(2)); 
                parentData.push(A0 * Math.exp(-lambda * timePoint_seconds)); 
                if (calculationMode === MODE_DAUGHTER) { 
                    const N0_daughter = parseFloat(initialDaughterActivity); 
                    const daughterName = selectedNuclide.daughter.split('(')[0].trim(); 
                    const daughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName)); 
                    const T_half_daughter_seconds = parseHalfLifeToSeconds(daughter.halfLife); 
                    const lambda2 = T_half_daughter_seconds === Infinity ? 0 : Math.log(2) / T_half_daughter_seconds; 
                    let d_activity; 
                    if (Math.abs(lambda - lambda2) < 1e-12 * lambda) { 
                        d_activity = (N0_daughter * Math.exp(-lambda2 * timePoint_seconds)) + (A0 * lambda2 * timePoint_seconds * Math.exp(-lambda2 * timePoint_seconds)); 
                    } else { 
                        d_activity = (N0_daughter * Math.exp(-lambda2 * timePoint_seconds)) + ((lambda2 / (lambda2 - lambda)) * A0 * (Math.exp(-lambda * timePoint_seconds) - Math.exp(-lambda2 * timePoint_seconds))); 
                    } 
                    daughterData.push(d_activity); 
                } 
            } 
            setChartData({ labels, parentData, daughterData: daughterData.length > 0 ? daughterData : null, timeUnit: timeUnit, parentName: selectedNuclide.name, daughterName: calculationMode === MODE_DAUGHTER ? selectedNuclide.daughter.split('(')[0].trim() : null }); 
        } catch (e) { 
            setError(e.message); 
            setResult(null); 
            setChartData(null); 
        }
    }, [selectedNuclide, calculationMode, initialActivity, remainingActivity, timeElapsed, timeUnit, initialDaughterActivity, radionuclides]);
    
    React.useEffect(() => { 
        if (selectedNuclide) { 
            handleCalculate(); 
        } 
    }, [selectedNuclide, calculationMode, initialActivity, remainingActivity, timeElapsed, timeUnit, initialDaughterActivity, handleCalculate]);

    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            let inputs, res;
            if (result.label === 'Remaining Activity') {
                inputs = `${initialActivity} of ${selectedNuclide.symbol} for ${timeElapsed} ${timeUnit}`;
                res = `${result.value}`;
            } else if (result.label === 'Time Elapsed') {
                inputs = `${initialActivity} → ${remainingActivity} of ${selectedNuclide.symbol}`;
                res = `${result.value} ${result.unit}`;
            } else if (result.label === 'Initial Activity') {
                inputs = `? → ${remainingActivity} of ${selectedNuclide.symbol} over ${timeElapsed} ${timeUnit}`;
                res = `${result.value}`;
            } else { // Daughter
                inputs = `${initialActivity} of ${selectedNuclide.symbol} for ${timeElapsed} ${timeUnit}`;
                res = `Daughter: ${result.daughter.value}`;
            }
            
            addHistory({
                id: Date.now(),
                type: 'Decay',
                icon: ICONS.calculator,
                inputs: inputs,
                result: res,
                view: VIEWS.CALCULATOR
            });
            addToast("Calculation saved to history!");
        }
    };
    
    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates remaining activity, time, or daughter products.</p>
            <div><label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label><div className="mt-1 min-h-[42px]">{selectedNuclide ? ( <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => { setSelectedNuclide(null); }} /> ) : ( <SearchableSelect options={sortedRadionuclides} onSelect={handleNuclideSelect} placeholder="Search for a radionuclide..."/> )}</div></div>
            <div><label className="text-sm font-medium text-slate-700 dark:text-slate-300">Calculate</label><div className="grid grid-cols-2 gap-x-4 gap-y-2 mt-2">{[MODE_REMAINING, MODE_TIME, MODE_INITIAL, MODE_DAUGHTER].map(mode => ( <label key={mode} className="flex items-center gap-2 cursor-pointer"><input type="radio" name="calcMode" value={mode} checked={calculationMode === mode} onChange={() => setCalculationMode(mode)} className="form-radio h-4 w-4 text-sky-600"/><span className="text-sm">{ { [MODE_REMAINING]: 'Remaining Activity', [MODE_TIME]: 'Time Elapsed', [MODE_INITIAL]: 'Initial Activity', [MODE_DAUGHTER]: 'Daughter Activity' }[mode] }</span></label>))}</div></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">{renderInputField("Initial Activity", initialActivity, setInitialActivity, calculationMode !== MODE_INITIAL)}{calculationMode !== MODE_DAUGHTER && renderInputField("Remaining Activity", remainingActivity, setRemainingActivity, calculationMode === MODE_TIME || calculationMode === MODE_INITIAL)}{calculationMode === MODE_DAUGHTER && renderInputField("Initial Daughter Activity", initialDaughterActivity, setInitialDaughterActivity, true)}{renderInputField("Time Elapsed", timeElapsed, setTimeElapsed, calculationMode !== MODE_TIME, timeUnit, setTimeUnit, timeUnits_ordered)}</div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <div className="flex justify-end -mt-2 -mr-2">
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    {result.label ? (
                        <div className="flex items-center justify-center -mt-4">
                            <div className="text-lg font-bold text-center flex-grow">
                                <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.label}</span>
                                <span>{result.value} {result.unit}</span>
                            </div>
                            <CopyButton textToCopy={result.value} />
                        </div>
                    ) : (
                        <div className="space-y-2 -mt-4">
                            <div className="flex items-center justify-between">
                                <div className="text-lg font-bold text-left">
                                    <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Remaining {result.parent.name} Activity</span>
                                    <span>{result.parent.value}</span>
                                </div>
                                <CopyButton textToCopy={result.parent.value} />
                            </div>
                            <div className="flex items-center justify-between">
                                <div className="text-lg font-bold text-left">
                                    <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.daughter.name} Activity {result.daughter.isStable ? "(Stable Daughter)" : ""}</span>
                                    <span>{result.daughter.value}</span>
                                </div>
                                <CopyButton textToCopy={result.daughter.value} />
                            </div>
                        </div>
                    )}
                </div>
            )}
            {chartData && (<><div className="flex justify-end mt-4"><label className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" /> Use Logarithmic Scale</label></div><DecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} /></>)} 
        </div>
    );
};
         



const LeakTestCalculator = ({ grossCpm, setGrossCpm, backgroundCpm, setBackgroundCpm, instrumentEff, setInstrumentEff, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const LEAK_TEST_LIMIT_UCI = 0.005;
    const DPM_PER_UCI = 2.22e6;
    
    React.useEffect(() => {
    localStorage.setItem('leakTest_grossCpm', grossCpm);
    localStorage.setItem('leakTest_backgroundCpm', backgroundCpm);
    localStorage.setItem('leakTest_instrumentEff', instrumentEff);
    }, [grossCpm, backgroundCpm, instrumentEff]);
    
    React.useEffect(() => {
    try {
       setError('');
       const gross = parseFloat(grossCpm);
       const bkg = parseFloat(backgroundCpm);
       const eff = parseFloat(instrumentEff);
    
       if (isNaN(gross) || isNaN(bkg) || isNaN(eff)) {
           if (grossCpm || backgroundCpm || instrumentEff) setError("All inputs must be valid numbers.");
           setResult(null); return;
       }
       if (gross < bkg) throw new Error("Gross CPM cannot be less than background.");
       if (eff <= 0 || eff > 100) throw new Error("Efficiency must be between 0 and 100.");
    
       const netCpm = gross - bkg;
       const dpm = netCpm / (eff / 100.0);
       const activity_uCi = dpm / DPM_PER_UCI;
       const pass = activity_uCi < LEAK_TEST_LIMIT_UCI;
    
       setResult({ activity: activity_uCi.toExponential(2), pass: pass });
    } catch (e) {
       setError(e.message);
       setResult(null);
    }
    }, [grossCpm, backgroundCpm, instrumentEff, setResult, setError]);

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ 
                id: Date.now(), 
                type: 'Leak Test', 
                icon: ICONS.check, 
                inputs: `${grossCpm} cpm / ${backgroundCpm} cpm`, 
                result: `${result.activity} µCi`, 
                view: VIEWS.OPERATIONAL_HP 
            });
            addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4 max-w-md mx-auto">
       <p className="text-sm text-slate-600 dark:text-slate-400">
           Evaluates a sealed source wipe against the 0.005 µCi limit.
       </p>
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label className="block text-sm font-medium">Gross CPM</label><input type="number" value={grossCpm} onChange={e => setGrossCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Background CPM</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
       </div>
       <div><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
    
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${result.pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
               <div className="flex justify-between items-center -mt-2 -mb-2">
                    <div></div> {/* Spacer */}
                    <p className={`text-3xl font-extrabold ${result.pass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.pass ? 'PASS' : 'FAIL'}</p>
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
               </div>
    
               <div className="flex items-center justify-center mt-2">
                   <p className="text-xl font-bold">{result.activity} µCi</p>
                   <CopyButton textToCopy={result.activity} />
               </div>
    
               <p className={`text-xs font-semibold ${result.pass ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}`}>(Limit: {LEAK_TEST_LIMIT_UCI} µCi)</p>
           </div>
       )}
    </div>
    );
};
         
         /**
         * @description React component for a static surface contamination survey calculator.
         * This tool allows health physics professionals to quickly analyze a set of static
         * survey data points against regulatory or self-imposed limits.
         *
         * It is commonly used for a **2-part check**, verifying both:
         * 1.  The **average** contamination level is below the acceptable limit.
         * 2.  The **maximum** single reading is below a separate, often more conservative, limit.
         *
         * The component can automatically populate standard limits based on a selected radionuclide
         * and provides real-time feedback on whether the survey "passes" or "fails" both checks.
         *
         * @prop {array} radionuclides - Array of available radionuclides with their properties.
         * @prop {string} nuclideSymbol - The symbol of the currently selected nuclide.
         * @prop {function} setNuclideSymbol - State setter for the nuclide symbol.
         * @prop {string} surveyData - The raw, unparsed string of survey data points.
         * @prop {function} setSurveyData - State setter for the survey data string.
         * @prop {string} avgLimit - The average contamination limit.
         * @prop {function} setAvgLimit - State setter for the average limit.
         * @prop {string} maxLimit - The maximum contamination limit.
         * @prop {function} setMaxLimit - State setter for the maximum limit.
         * @prop {string} unit - The unit of measurement for the data (e.g., dpm/100cm²).
         * @prop {function} setUnit - State setter for the units.
         * @prop {object} result - Object containing the analysis results (average, max, pass/fail status).
         * @prop {function} setResult - State setter for the result object.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         
         const StaticSurveyCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, surveyData, setSurveyData, avgLimit, setAvgLimit, maxLimit, setMaxLimit, unit, setUnit, result, setResult, error, setError }) => {
         const surveyNuclides = React.useMemo(() => radionuclides.filter(n => n.regGuideCategory).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
         const selectedNuclide = React.useMemo(() => surveyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, surveyNuclides]);
         
         React.useEffect(() => {
         if (selectedNuclide) {
            const limits = REG_GUIDE_1_86_LIMITS[selectedNuclide.regGuideCategory];
            if (limits) {
                setAvgLimit(limits.total);
                setMaxLimit(limits.total * 3);
                setUnit('dpm/100cm²');
            }
         }
         }, [selectedNuclide, setAvgLimit, setMaxLimit, setUnit]);
         
         React.useEffect(() => {
         try {
            setError('');
            if (!surveyData.trim()) { setResult(null); return; }
            const dataPoints = surveyData.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
            if (dataPoints.length === 0) throw new Error("No valid numeric data found.");
            const avg = dataPoints.reduce((sum, val) => sum + val, 0) / dataPoints.length;
            const max = Math.max(...dataPoints);
            const avgL = parseFloat(avgLimit);
            const maxL = parseFloat(maxLimit);
            if (isNaN(avgL) || isNaN(maxL)) { if (avgLimit && maxLimit) { throw new Error("Limits must be valid numbers."); } else { return; } }
            setResult({ count: dataPoints.length, average: avg, max: max, avgPass: avg <= avgL, maxPass: max <= maxL });
         } catch (e) { setError(e.message); setResult(null); }
         }, [surveyData, avgLimit, maxLimit, setResult, setError]);
         
         return (
         <div className="space-y-4 max-w-md mx-auto">
           <div><label className="text-sm font-medium">Survey Nuclide</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={surveyNuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide to auto-fill limits..."/>}</div></div>
           <div>
               <label className="block text-sm font-medium">Survey Data</label>
               <textarea value={surveyData} onChange={e => setSurveyData(e.target.value)} rows="6" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
           </div>
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div><label className="block text-sm font-medium">Average Limit</label><input type="number" value={avgLimit} onChange={e => setAvgLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div>
                    <Tooltip text="This is a common rule of thumb for routine surveys where an occasional higher-than-average reading is acceptable. Always refer to your specific license conditions or survey procedures.">
                        <label className="block text-sm font-medium">Max Limit</label>
                    </Tooltip>
                    <input type="number" value={maxLimit} onChange={e => setMaxLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                </div>
           </div>
           <div><label className="block text-sm font-medium">Units</label><input type="text" value={unit} onChange={e => setUnit(e.target.value)} placeholder="e.g., mrem/hr, dpm/100cm²" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           {result && (
               <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Survey Analysis Results ({result.count} points)</p>
                   <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-4">
                       <div className={`p-2 rounded ${result.avgPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                         <p className="text-xs font-bold">Average</p>
                         <p className={`font-bold text-lg ${result.avgPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.avgPass ? 'PASS' : 'FAIL'}</p>
                         <div className="flex items-center justify-center">
                            <p className="text-sm">{result.average.toPrecision(3)}</p>
                            <CopyButton textToCopy={result.average.toPrecision(3)} />
                         </div>
                       </div>
                       <div className={`p-2 rounded ${result.maxPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                         <p className="text-xs font-bold">Maximum</p>
                         <p className={`font-bold text-lg ${result.maxPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.maxPass ? 'PASS' : 'FAIL'}</p>
                         <div className="flex items-center justify-center">
                            <p className="text-sm">{result.max.toPrecision(3)}</p>
                            <CopyButton textToCopy={result.max.toPrecision(3)} />
                         </div>
                       </div>
                   </div>
               </div>
           )}
            {!result && !error && (
                <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg mt-4">
                    <p className="text-slate-500 dark:text-slate-400">Enter survey data and limits to analyze the results.</p>
                </div>
            )}
         </div>
         );
         };
         
         // This component calculates the level of removable surface contamination in dpm/100cm² from gross count rate, background, and instrument efficiencies, then compares the result against regulatory limits from NRC Regulatory Guide 1.86 and ANSI N13.12.
         
         const ContaminationSurveyCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, grossCpm, setGrossCpm, backgroundCpm, setBackgroundCpm, instrumentEff, setInstrumentEff, removableFraction, setRemovableFraction, result, setResult, error, setError }) => {
         const surveyNuclides = React.useMemo(() => radionuclides.filter(n => n.regGuideCategory && n.ansiCategory).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
         const selectedNuclide = React.useMemo(() => surveyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, surveyNuclides]);
         
         React.useEffect(() => {
         try {
            setError('');
            if (!selectedNuclide) { setResult(null); return; }
            const gross = parseFloat(grossCpm); const bkg = parseFloat(backgroundCpm);
            const eff = parseFloat(instrumentEff) / 100; const frac = parseFloat(removableFraction);
            if ([gross, bkg, eff, frac].some(isNaN) || eff <= 0 || frac <= 0) throw new Error("All inputs must be valid, positive numbers.");
            if (gross < bkg) throw new Error("Gross CPM cannot be less than background.");
            const netCpm = gross - bkg;
            const dpm = netCpm / eff;
            const contamination = dpm / frac;
            const rgLimit = REG_GUIDE_1_86_LIMITS[selectedNuclide.regGuideCategory].removable;
            const ansiLimit = ANSI_13_12_LIMITS[selectedNuclide.ansiCategory].removable;
            setResult({ contamination: contamination.toFixed(0), rgPass: contamination <= rgLimit, ansiPass: contamination <= ansiLimit, rgLimit, ansiLimit });
         } catch (e) { setError(e.message); setResult(null); }
         }, [selectedNuclide, grossCpm, backgroundCpm, instrumentEff, removableFraction, setResult, setError]);
         
         return (
         <div className="space-y-4 max-w-md mx-auto">
           <div><label className="text-sm font-medium">Contaminant of Concern</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={surveyNuclides} onSelect={setNuclideSymbol} placeholder="Select a nuclide to find limits..."/>}</div></div>
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div><label className="block text-sm font-medium">Gross CPM</label><input type="number" value={grossCpm} onChange={e => setGrossCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><label className="block text-sm font-medium">Background CPM</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><label className="block text-sm font-medium">Instrument Eff. (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><Tooltip text="The fraction of removable contamination collected by the wipe, typically assumed to be 10% (0.1)."><label className="block text-sm font-medium">Smear Eff. (0.0-1.0)</label></Tooltip><input type="number" step="0.01" value={removableFraction} onChange={e => setRemovableFraction(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           </div>
           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           {result && (
               <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Removable Contamination</p>
                    <div className="flex items-center justify-center">
                        <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.contamination} <span className="text-2xl opacity-75">dpm/100cm²</span></p>
                        <CopyButton textToCopy={result.contamination} />
                    </div>
                   <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-4">
                       <div className={`p-2 rounded ${result.rgPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                         <p className="text-xs font-bold">Reg. Guide 1.86</p>
                         <p className={`font-bold text-lg ${result.rgPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.rgPass ? 'PASS' : 'FAIL'}</p>
                         <p className="text-xs">(Limit: {result.rgLimit})</p>
                       </div>
                       <div className={`p-2 rounded ${result.ansiPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                         <p className="text-xs font-bold">ANSI N13.12</p>
                         <p className={`font-bold text-lg ${result.ansiPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.ansiPass ? 'PASS' : 'FAIL'}</p>
                         <p className="text-xs">(Limit: {result.ansiLimit})</p>
                       </div>
                   </div>
               </div>
           )}
         </div>
         );
         };








         
  const AirborneCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, releaseActivity, setReleaseActivity, activityUnit, setActivityUnit, roomVolume, setRoomVolume, volumeUnit, setVolumeUnit, ventilationRate, setVentilationRate, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const dosimetryNuclides = React.useMemo(() => radionuclides.filter(n => n.dosimetry?.DAC).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    const selectedNuclide = React.useMemo(() => dosimetryNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, dosimetryNuclides]);
    
    React.useEffect(() => {
    if (!selectedNuclide) { setResult(null); return; }
    try {
       setError('');
       const act = parseFloat(releaseActivity); const vol = parseFloat(roomVolume); const vent = parseFloat(ventilationRate);
       if ([act, vol, vent].some(isNaN) || act < 0 || vol <= 0 || vent < 0) throw new Error("Inputs must be valid numbers.");
       const act_uCi = act * ({ 'pCi': 1e-6, 'nCi': 1e-3, 'µCi': 1, 'mCi': 1e3, 'Ci': 1e6 }[activityUnit]);
       const vol_mL = vol * ({ 'm³': 1e6, 'L': 1000, 'ft³': 28316.8 }[volumeUnit]);
       const dac_uCi_mL = selectedNuclide.dosimetry.DAC.inhalation_W || selectedNuclide.dosimetry.DAC.inhalation_D || selectedNuclide.dosimetry.DAC.inhalation_Y;
       if (!dac_uCi_mL) throw new Error(`DAC value not found for ${selectedNuclide.name}.`);
       const initialConc_uCi_mL = act_uCi / vol_mL;
       const lambda_eff_per_hr = vent;
       const time_to_1_dac_hr = lambda_eff_per_hr > 0 ? (-1 / lambda_eff_per_hr) * Math.log(dac_uCi_mL / initialConc_uCi_mL) : Infinity;
       setResult({ initialConc: initialConc_uCi_mL.toExponential(3), dacValue: dac_uCi_mL.toExponential(2), dacMultiple: (initialConc_uCi_mL / dac_uCi_mL).toPrecision(3), time_to_1_dac_hr: time_to_1_dac_hr > 0 ? time_to_1_dac_hr.toPrecision(3) : 0 });
    } catch (e) { setError(e.message); setResult(null); }
    }, [selectedNuclide, releaseActivity, activityUnit, roomVolume, volumeUnit, ventilationRate, setResult, setError]);

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ 
                id: Date.now(), 
                type: 'Airborne Release', 
                icon: ICONS.radon, 
                inputs: `${releaseActivity} ${activityUnit} in ${roomVolume} ${volumeUnit}`, 
                result: `${result.dacMultiple}x DAC`, 
                view: VIEWS.OPERATIONAL_HP 
            });
            addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4 max-w-md mx-auto">
      <div><label className="text-sm font-medium">Radionuclide</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={dosimetryNuclides} onSelect={setNuclideSymbol} placeholder="Select a nuclide with a DAC..."/>}</div></div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label className="block text-sm font-medium">Released Activity</label><div className="flex"><input type="number" value={releaseActivity} onChange={e => setReleaseActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600"><option>pCi</option><option>nCi</option><option>µCi</option><option>mCi</option><option>Ci</option></select></div></div>
          <div><label className="block text-sm font-medium">Room Volume</label><div className="flex"><input type="number" value={roomVolume} onChange={e => setRoomVolume(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={volumeUnit} onChange={e => setVolumeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600"><option>m³</option><option>L</option><option>ft³</option></select></div></div>
          <div className="md:col-span-2"><label className="block text-sm font-medium">Ventilation Rate (ACH)</label><input type="number" value={ventilationRate} onChange={e => setVentilationRate(e.target.value)} placeholder="Air Changes per Hour" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
      </div>
      {error && <p className="text-red-500 text-sm text-center">{error}</p>}
      {result && (
          <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 text-center animate-fade-in">
              <div className="flex justify-end -mt-2 -mr-2">
                  <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                     <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                         <Icon path={ICONS.notepad} className="w-5 h-5" />
                     </button>
                  </Tooltip>
              </div>
              <div className="grid grid-cols-2 gap-2 text-sm -mt-4"><p>Initial Concentration:</p><p className="font-mono">{result.initialConc} µCi/mL</p><p>Nuclide DAC:</p><p className="font-mono">{result.dacValue} µCi/mL</p></div>
              <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                  <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Initial Concentration</p>
                   <div className="flex items-center justify-center">
                       <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.dacMultiple}x DAC</p>
                       <CopyButton textToCopy={result.dacMultiple} />
                   </div>
              </div>
              <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                  <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Time to reach 1 DAC</p>
                  <div className="flex items-center justify-center">
                       <p className="text-2xl font-bold">{result.time_to_1_dac_hr} hours</p>
                       <CopyButton textToCopy={result.time_to_1_dac_hr} />
                  </div>
              </div>
          </div>
      )}
    </div>
    );
};
  


// Replace the entire SurfaceContaminationCalculator in your file with this one
const SurfaceContaminationCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, staticData, setStaticData, wipeGrossCpm, setWipeGrossCpm, wipeBackgroundCpm, setWipeBackgroundCpm, instrumentEff, setInstrumentEff, smearEff, setSmearEff, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const surveyNuclides = React.useMemo(() => radionuclides.filter(n => n.regGuideCategory && n.ansiCategory).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    const selectedNuclide = React.useMemo(() => surveyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, surveyNuclides]);
    const PROBE_AREA_CM2 = 100;

    React.useEffect(() => {
        try {
            setError('');
            if (!selectedNuclide) { setResult(null); return; }

            const staticPoints = staticData.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
            const wipeGross = parseFloat(wipeGrossCpm);
            const wipeBkg = parseFloat(wipeBackgroundCpm);
            const instEff = parseFloat(instrumentEff) / 100.0;
            const smearFraction = parseFloat(smearEff);

            if (isNaN(instEff) || instEff <= 0) throw new Error("Instrument efficiency must be a positive number.");

            let removableDPM = null, totalDPM = null, maxDPM = null;

            // Calculate Removable
            if (!isNaN(wipeGross) && !isNaN(wipeBkg)) {
                if (wipeGross < wipeBkg) throw new Error("Wipe gross CPM cannot be less than background.");
                if (isNaN(smearFraction) || smearFraction <= 0) throw new Error("Smear efficiency must be a positive number.");
                const netWipeCpm = wipeGross - wipeBkg;
                removableDPM = netWipeCpm / (instEff * smearFraction);
            }

            // Calculate Total
            if (staticPoints.length > 0) {
                const avgStaticCpm = staticPoints.reduce((sum, val) => sum + val, 0) / staticPoints.length;
                const maxStaticCpm = Math.max(...staticPoints);
                totalDPM = avgStaticCpm / instEff * (100 / PROBE_AREA_CM2);
                maxDPM = maxStaticCpm / instEff * (100 / PROBE_AREA_CM2);
            }

            if (removableDPM === null && totalDPM === null) { setResult(null); return; }

            const rgLimits = REG_GUIDE_1_86_LIMITS[selectedNuclide.regGuideCategory];
            const ansiLimits = ANSI_13_12_LIMITS[selectedNuclide.ansiCategory];

            setResult({
                removable: removableDPM,
                total_avg: totalDPM,
                total_max: maxDPM,
                rg: {
                    removable_limit: rgLimits.removable,
                    total_limit: rgLimits.total,
                    removable_pass: removableDPM === null || removableDPM <= rgLimits.removable,
                    total_pass: totalDPM === null || totalDPM <= rgLimits.total,
                },
                ansi: {
                    removable_limit: ansiLimits.removable,
                    total_limit: ansiLimits.total,
                    removable_pass: removableDPM === null || removableDPM <= ansiLimits.removable,
                    total_pass: totalDPM === null || totalDPM <= ansiLimits.total,
                }
            });
        } catch (e) {
            setError(e.message);
            setResult(null);
        }
    }, [selectedNuclide, staticData, wipeGrossCpm, wipeBackgroundCpm, instrumentEff, smearEff]);

    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            addHistory({ 
                id: Date.now(), 
                type: 'Surface Survey', 
                icon: ICONS.gammaSpec, 
                inputs: `${selectedNuclide.symbol} contamination`, 
                result: `Removable: ${result.removable?.toFixed(0) || 'N/A'} dpm`, 
                view: VIEWS.OPERATIONAL_HP 
            });
            addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="space-y-4">
            <div><label className="text-sm font-medium">Contaminant of Concern</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={surveyNuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide to find limits..."/>}</div></div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3">
                    <label className="block text-sm font-semibold">Total Contamination (Static Survey)</label>
                    <textarea value={staticData} onChange={e => setStaticData(e.target.value)} rows="4" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste static CPM values..."></textarea>
                </div>
                <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3">
                    <label className="block text-sm font-semibold">Removable Contamination (Wipe)</label>
                    <div><label className="block text-xs font-medium">Gross CPM</label><input type="number" value={wipeGrossCpm} onChange={e => setWipeGrossCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div><label className="block text-xs font-medium">Background CPM</label><input type="number" value={wipeBackgroundCpm} onChange={e => setWipeBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                </div>
            </div>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4">
               <div><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} placeholder="e.g., 25" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><Tooltip text="The fraction of removable contamination collected by the wipe, typically assumed to be 10% (0.1)."><label className="block text-sm font-medium">Smear Efficiency (0.0-1.0)</label></Tooltip><input type="number" step="0.01" value={smearEff} onChange={e => setSmearEff(e.target.value)} placeholder="e.g., 0.1" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
            </div>

            <ContextualNote>
                <strong>Note:</strong> ANSI N13.12 provides an alternative set of limits to NRC Regulatory Guide 1.86. Always adhere to the specific limits dictated by your license conditions or site procedures.
            </ContextualNote>

            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 animate-fade-in">
                    <div className="flex justify-between items-center -mt-2 -mb-1">
                        <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200">Survey Analysis (dpm/100cm²)</h3>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {result.removable !== null && <div className="p-3 bg-white dark:bg-slate-800 rounded-lg">
                            <p className="font-semibold text-center text-sm">Removable</p>
                            <p className="text-2xl font-bold text-center text-sky-600 dark:text-sky-400 my-2">{result.removable.toFixed(0)}</p>
                            <div className="grid grid-cols-2 gap-2 text-xs text-center">
                                <div className={`p-1 rounded ${result.rg.removable_pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}><b>RG 1.86:</b><br/>{result.rg.removable_pass ? 'PASS' : 'FAIL'}</div>
                                <div className={`p-1 rounded ${result.ansi.removable_pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}><b>ANSI:</b><br/>{result.ansi.removable_pass ? 'PASS' : 'FAIL'}</div>
                            </div>
                        </div>}
                        {result.total_avg !== null && <div className="p-3 bg-white dark:bg-slate-800 rounded-lg">
                            <p className="font-semibold text-center text-sm">Total (Average)</p>
                            <p className="text-2xl font-bold text-center text-sky-600 dark:text-sky-400 my-2">{result.total_avg.toFixed(0)}</p>
                             <div className="grid grid-cols-2 gap-2 text-xs text-center">
                                <div className={`p-1 rounded ${result.rg.total_pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}><b>RG 1.86:</b><br/>{result.rg.total_pass ? 'PASS' : 'FAIL'}</div>
                                <div className={`p-1 rounded ${result.ansi.total_pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}><b>ANSI:</b><br/>{result.ansi.total_pass ? 'PASS' : 'FAIL'}</div>
                            </div>
                        </div>}
                    </div>
                    <details className="text-xs mt-3 text-slate-500 dark:text-slate-400"><summary className="cursor-pointer font-semibold">View Applicable Limits</summary><div className="grid grid-cols-2 gap-2 p-2 bg-white dark:bg-slate-800 rounded-md mt-1"><div><b>Reg. Guide 1.86:</b><br/>Removable: {result.rg.removable_limit}<br/>Total: {result.rg.total_limit}</div><div><b>ANSI N13.12:</b><br/>Removable: {result.ansi.removable_limit}<br/>Total: {result.ansi.total_limit}</div></div></details>
                </div>
            )}
        </div>
    );
};

const OperationalHPCalculators = ({ radionuclides }) => {
    const [activeCalculator, setActiveCalculator] = React.useState('surfaceContam');
    
    // State for the NEW SurfaceContaminationCalculator
    const [sc_nuclideSymbol, setSc_nuclideSymbol] = React.useState('');
    const [sc_staticData, setSc_staticData] = React.useState('');
    const [sc_wipeGrossCpm, setSc_wipeGrossCpm] = React.useState('150');
    const [sc_wipeBackgroundCpm, setSc_wipeBackgroundCpm] = React.useState('50');
    const [sc_instrumentEff, setSc_instrumentEff] = React.useState('25');
    const [sc_smearEff, setSc_smearEff] = React.useState('0.1');
    const [sc_result, setSc_result] = React.useState(null);
    const [sc_error, setSc_error] = React.useState('');

    // State for LeakTestCalculator
    const [lt_grossCpm, setLt_grossCpm] = React.useState(() => localStorage.getItem('leakTest_grossCpm') || '150');
    const [lt_backgroundCpm, setLt_backgroundCpm] = React.useState(() => localStorage.getItem('leakTest_backgroundCpm') || '50');
    const [lt_instrumentEff, setLt_instrumentEff] = React.useState(() => localStorage.getItem('leakTest_instrumentEff') || '25');
    const [lt_result, setLt_result] = React.useState(null);
    const [lt_error, setLt_error] = React.useState('');
    
    // State for AirborneCalculator
    const [ac_nuclideSymbol, setAc_nuclideSymbol] = React.useState('');
    const [ac_releaseActivity, setAc_releaseActivity] = React.useState('1');
    const [ac_activityUnit, setAc_activityUnit] = React.useState('mCi');
    const [ac_roomVolume, setAc_roomVolume] = React.useState('100');
    const [ac_volumeUnit, setAc_volumeUnit] = React.useState('m³');
    const [ac_ventilationRate, setAc_ventilationRate] = React.useState('2');
    const [ac_result, setAc_result] = React.useState(null);
    const [ac_error, setAc_error] = React.useState('');
    
    // --- Updated Clear Logic ---
    const handleSurfaceContamClear = () => {
        setSc_nuclideSymbol(''); setSc_staticData(''); setSc_wipeGrossCpm('150');
        setSc_wipeBackgroundCpm('50'); setSc_instrumentEff('25'); setSc_smearEff('0.1');
        setSc_result(null); setSc_error('');
    };
    const handleLeakTestClear = () => {
        setLt_grossCpm('150'); setLt_backgroundCpm('50'); setLt_instrumentEff('25');
        setLt_result(null); setLt_error('');
    };
    const handleAirborneClear = () => {
        setAc_nuclideSymbol(''); setAc_releaseActivity('1'); setAc_activityUnit('mCi');
        setAc_roomVolume('100'); setAc_volumeUnit('m³'); setAc_ventilationRate('2');
        setAc_result(null); setAc_error('');
    };
    
    const handleClearActiveCalculator = () => {
        switch (activeCalculator) {
           case 'surfaceContam': handleSurfaceContamClear(); break;
           case 'leakTest': handleLeakTestClear(); break;
           case 'airborne': handleAirborneClear(); break;
           default: break;
        }
    };
    
    const calculatorViews = {
        surfaceContam: { 
            label: 'Surface Contam.', 
            icon: ICONS.gammaSpec, 
            component: <SurfaceContaminationCalculator 
                radionuclides={radionuclides}
                nuclideSymbol={sc_nuclideSymbol} setNuclideSymbol={setSc_nuclideSymbol}
                staticData={sc_staticData} setStaticData={setSc_staticData}
                wipeGrossCpm={sc_wipeGrossCpm} setWipeGrossCpm={setSc_wipeGrossCpm}
                wipeBackgroundCpm={sc_wipeBackgroundCpm} setWipeBackgroundCpm={setSc_wipeBackgroundCpm}
                instrumentEff={sc_instrumentEff} setInstrumentEff={setSc_instrumentEff}
                smearEff={sc_smearEff} setSmearEff={setSc_smearEff}
                result={sc_result} setResult={setSc_result}
                error={sc_error} setError={setSc_error}
            /> 
        },
        leakTest: { 
            label: 'Leak Test', 
            icon: ICONS.check, 
            component: <LeakTestCalculator
                grossCpm={lt_grossCpm} setGrossCpm={setLt_grossCpm}
                backgroundCpm={lt_backgroundCpm} setBackgroundCpm={setLt_backgroundCpm}
                instrumentEff={lt_instrumentEff} setInstrumentEff={setLt_instrumentEff}
                result={lt_result} setResult={setLt_result}
                error={lt_error} setError={setLt_error}
            /> 
        },
        airborne: { 
            label: 'Airborne', 
            icon: ICONS.radon, 
            component: <AirborneCalculator 
                radionuclides={radionuclides}
                nuclideSymbol={ac_nuclideSymbol} setNuclideSymbol={setAc_nuclideSymbol}
                releaseActivity={ac_releaseActivity} setReleaseActivity={setAc_releaseActivity}
                activityUnit={ac_activityUnit} setActivityUnit={setAc_activityUnit}
                roomVolume={ac_roomVolume} setRoomVolume={setAc_roomVolume}
                volumeUnit={ac_volumeUnit} setVolumeUnit={setAc_volumeUnit}
                ventilationRate={ac_ventilationRate} setVentilationRate={setAc_ventilationRate}
                result={ac_result} setResult={setAc_result}
                error={ac_error} setError={setAc_error}
            /> 
        }
    };
    
    return (
        <div className="p-4 animate-fade-in">
           <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <div className="flex justify-between items-center mb-4">
                   <h2 className="text-xl font-bold text-slate-800 dark:text-white">Operational HP Calculators</h2>
                   <ClearButton onClick={handleClearActiveCalculator} />
               </div>
               <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6 overflow-x-auto">
                   {Object.entries(calculatorViews).map(([key, { label, icon }]) => (
                       <button
                           key={key}
                           onClick={() => setActiveCalculator(key)}
                           className={`flex-shrink-0 w-1/3 p-2 rounded-md text-sm font-semibold transition-colors flex items-center justify-center gap-2 ${ activeCalculator === key ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}
                       >
                           <Icon path={icon} className="w-4 h-4" />
                           {label}
                       </button>
                   ))}
               </div>
               <div className="mt-4">
                   {calculatorViews[activeCalculator].component}
               </div>
           </div>
        </div>
    );
};

         
         /**
         * @description A calculator to determine radioactive material shipping classification (Excepted, Type A, Type B)
         * based on the nuclide, activity, and form, according to DOT/IAEA A1/A2 values.
         */
         
const TransportationCalculator = ({ radionuclides, preselectedNuclide }) => {
    const [selectedSymbol, setSelectedSymbol] = React.useState('');
    const [formType, setFormType] = React.useState('A2');
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState('Ci');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const transportNuclides = React.useMemo(() =>
    radionuclides.filter(n => n.shipping && (n.shipping.A1 !== null || n.shipping.A2 !== null)).sort((a,b) => a.name.localeCompare(b.name)),
    [radionuclides]
    );
    
    const selectedNuclide = React.useMemo(() =>
    transportNuclides.find(n => n.symbol === selectedSymbol),
    [selectedSymbol, transportNuclides]
    );
    
    React.useEffect(() => {
    if (preselectedNuclide && transportNuclides.some(n => n.symbol === preselectedNuclide)) {
       setSelectedSymbol(preselectedNuclide);
    }
    }, [preselectedNuclide, transportNuclides]);
    
    const activityFactorsTBq = {
    'TBq': 1, 'GBq': 0.001, 'MBq': 1e-6, 'kBq': 1e-9, 'Bq': 1e-12,
    'Ci': 0.037, 'mCi': 3.7e-5, 'µCi': 3.7e-8
    };
    
    const shippingActivityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'TBq', 'µCi', 'mCi', 'Ci'];
    
    const resultStyles = {
    EXCEPTED: { container: 'bg-green-100 dark:bg-green-900/50', title: 'text-green-600 dark:text-green-400', display: 'Excepted Package' },
    TYPE_A: { container: 'bg-sky-100 dark:bg-sky-900/50', title: 'text-sky-600 dark:text-sky-400', display: 'Type A Package' },
    TYPE_B: { container: 'bg-red-100 dark:bg-red-900/50', title: 'text-red-600 dark:text-red-400', display: 'Type B Package' }
    };
    
    const handleCalculate = () => {
    if (!selectedNuclide) {
       setError('Please select a radionuclide.');
       setResult(null); return;
    }
    const activityValue = parseFloat(activity);
    if (isNaN(activityValue) || activityValue < 0) {
       setError('Please enter a valid, non-negative activity.');
       setResult(null); return;
    }
    setError('');
    const userActivityTBq = activityValue * activityFactorsTBq[activityUnit];
    const limitTBq = selectedNuclide.shipping[formType];
    if (limitTBq === null) {
       setError(`An A-value for ${formType} is not defined for this nuclide.`);
       setResult(null);
       return;
    }
    
    let exceptedLimitFactor = 1e-4; // Generic factor
    if (selectedNuclide.symbol === 'H-3') {
       exceptedLimitFactor = 2e-2; // Special case factor for Tritium
    }
    const exceptedLimitTBq = exceptedLimitFactor * limitTBq;
    
    let classification = '';
    if (userActivityTBq <= exceptedLimitTBq) {
       classification = 'EXCEPTED';
    } else if (userActivityTBq <= limitTBq) {
       classification = 'TYPE_A';
    } else {
       classification = 'TYPE_B';
    }
    const newResult = {
       classification,
       userActivityTBq: userActivityTBq.toExponential(3),
       limitTBq,
       exceptedLimitTBq: exceptedLimitTBq.toExponential(3)
    };
    setResult(newResult);
    };

    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            addHistory({
              id: Date.now(),
              type: 'Transportation',
              icon: ICONS.transport,
              inputs: `${activity} ${activityUnit} of ${selectedNuclide.symbol} (${formType})`,
              result: resultStyles[result.classification].display,
              view: VIEWS.TRANSPORTATION
            });
            addToast("Calculation saved to history!");
        }
    };
    
    React.useEffect(() => {
    if (selectedNuclide && activity) {
       handleCalculate();
    } else {
       setResult(null);
       setError('');
    }
    }, [selectedNuclide, formType, activity, activityUnit]);
    
    const handleClearInputs = () => {
    setSelectedSymbol('');
    setFormType('A2');
    setActivity('1');
    setActivityUnit('Ci');
    setResult(null);
    setError('');
    };
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Shipping Calculator</h2>
               <ClearButton onClick={handleClearInputs} />
           </div>
           <div className="space-y-4">
               <div>
                   <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label>
                   <div className="mt-1 min-h-[42px]">
                       {selectedNuclide ? (
                           <CalculatorNuclideInfo
                               nuclide={selectedNuclide}
                               onClear={() => setSelectedSymbol('')}
                           />
                       ) : (
                           <SearchableSelect
                               options={transportNuclides}
                               onSelect={(symbol) => { setSelectedSymbol(symbol); }}
                               placeholder="Search for a radionuclide..."
                           />
                       )}
                   </div>
               </div>
               <div>
                   <label className="block text-sm font-medium">Material Form</label>
                   <div className="mt-2 grid grid-cols-2 gap-2">
                        <Tooltip text="Special Form: Non-dispersible solid material or an encapsulated source. (e.g., a sealed metal source)">
                           <label className={`flex items-center justify-center p-3 rounded-lg cursor-pointer ${formType === 'A1' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}><input type="radio" name="formType" value="A1" checked={formType === 'A1'} onChange={e => setFormType(e.target.value)} className="hidden"/>Special Form (A1)</label>
                       </Tooltip>
                       <Tooltip text="Normal Form: Dispersible material. (e.g., liquids, powders, gases)">
                           <label className={`flex items-center justify-center p-3 rounded-lg cursor-pointer ${formType === 'A2' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}><input type="radio" name="formType" value="A2" checked={formType === 'A2'} onChange={e => setFormType(e.target.value)} className="hidden"/>Normal Form (A2)</label>
                       </Tooltip>
                   </div>
               </div>
               <div>
                   <label className="block text-sm font-medium">Source Activity</label>
                   <div className="flex">
                       <input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                       <select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">
                           {shippingActivityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}
                       </select>
                   </div>
               </div>
    
               {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}
    
               {result && (
                   <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.classification].container}`}>
                        <div className="flex justify-between items-center -mt-2 mb-2">
                            <div></div> {/* Spacer */}
                            <p className={`text-3xl font-extrabold ${resultStyles[result.classification].title}`}>{resultStyles[result.classification].display}</p>
                            <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                               <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                   <Icon path={ICONS.notepad} className="w-5 h-5" />
                               </button>
                            </Tooltip>
                        </div>
                       <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                           <p>Your Activity:</p><p className="font-mono">{result.userActivityTBq} TBq</p>
                           <p>{formType} Limit:</p><p className="font-mono">{result.limitTBq} TBq</p>
                           <p>Excepted Limit:</p><p className="font-mono">≤ {result.exceptedLimitTBq} TBq</p>
                       </div>
                   </div>
               )}
           </div>
       </div>
    </div>
    );
};
          
         /**
         * @description React component acting as a container for various medical physics tools.
         * This component provides a tabbed interface to switch between different calculators
         * and utilities relevant to medical and hospital-based radiation safety.
         *
         * It manages the state for each sub-calculator independently and conditionally
         * renders the active tool based on the user's tab selection.
         *
         * The included tools are:
         * 1.  **X-Ray Shielding Calculator:** Used to determine the required shielding thickness for an X-ray room based on workload, distance, and other factors.
         * 2.  **Patient Release Calculator:** Assists in determining if a patient who has received a radiopharmaceutical can be released from the hospital under regulatory guidelines (e.g., 10 CFR 35).
         *
         * This component centralizes multiple specialized tools into a single, cohesive user interface.
         *
         * @prop {array} radionuclides - A comprehensive array of radionuclide data used by the patient release calculator.
         */
         
         const MedicalCalculator = ({radionuclides}) => {
         const [activeTab, setActiveTab] = React.useState('xrayShielding');
         
         // State for XRayShieldingCalculator
         const [xray_kvp, setXray_kvp] = React.useState('100');
         const [xray_workload, setXray_workload] = React.useState('200');
         const [xray_useFactor, setXray_useFactor] = React.useState('1');
         const [xray_occupancyFactor, setXray_occupancyFactor] = React.useState('1');
         const [xray_distance, setXray_distance] = React.useState('2.1');
         const [xray_doseLimit, setXray_doseLimit] = React.useState('2');
         const [xray_shieldMaterial, setXray_shieldMaterial] = React.useState('Lead');
         const [xray_result, setXray_result] = React.useState(null);
         const [xray_error, setXray_error] = React.useState('');
         
         // State for PatientReleaseCalculator
         const [pr_nuclideSymbol, setPr_nuclideSymbol] = React.useState('');
         const [pr_activity, setPr_activity] = React.useState('30');
         const [pr_activityUnit, setPr_activityUnit] = React.useState('mCi');
         const [pr_measuredDoseRate, setPr_measuredDoseRate] = React.useState('');
         const [pr_scenarios, setPr_scenarios] = React.useState([{ id: 1, name: 'Primary Scenario', hours: 8, distance: 1, distUnit: 'm' }]);
         const [pr_effectiveHalfLife, setPr_effectiveHalfLife] = React.useState('');
         const [pr_effectiveHalfLifeUnit, setPr_effectiveHalfLifeUnit] = React.useState('hours');
         const [pr_result, setPr_result] = React.useState(null);
         const [pr_error, setPr_error] = React.useState('');
         
         const handleXRayClear = () => {
         setXray_kvp('100'); setXray_workload('200'); setXray_useFactor('1');
         setXray_occupancyFactor('1'); setXray_distance('2.1'); setXray_doseLimit('2');
         setXray_shieldMaterial('Lead'); setXray_result(null); setXray_error('');
         };
         const handlePatientReleaseClear = () => {
         setPr_nuclideSymbol(''); setPr_activity('30'); setPr_activityUnit('mCi');
         setPr_measuredDoseRate(''); setPr_scenarios([{ id: 1, name: 'Primary Scenario', hours: 8, distance: 1, distUnit: 'm' }]);
         setPr_effectiveHalfLife(''); setPr_effectiveHalfLifeUnit('hours');
         setPr_result(null); setPr_error('');
         };
         
         const handleClearActiveCalculator = () => {
         if (activeTab === 'xrayShielding') {
            handleXRayClear();
         } else {
            handlePatientReleaseClear();
         }
         };
         
         return (
         <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Medical Physics Tools</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg my-4">
                    <button onClick={() => setActiveTab('xrayShielding')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'xrayShielding' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>X-Ray Shielding</button>
                    <button onClick={() => setActiveTab('patientRelease')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'patientRelease' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Patient Release</button>
                </div>
                {activeTab === 'xrayShielding' ?
                    <XRayShieldingCalculator 
                        kvp={xray_kvp} setKvp={setXray_kvp}
                        workload={xray_workload} setWorkload={setXray_workload}
                        useFactor={xray_useFactor} setUseFactor={setXray_useFactor}
                        occupancyFactor={xray_occupancyFactor} setOccupancyFactor={setXray_occupancyFactor}
                        distance={xray_distance} setDistance={setXray_distance}
                        doseLimit={xray_doseLimit} setDoseLimit={setXray_doseLimit}
                        shieldMaterial={xray_shieldMaterial} setShieldMaterial={setXray_shieldMaterial}
                        result={xray_result} setResult={setXray_result}
                        error={xray_error} setError={setXray_error}
                    /> :
                    <PatientReleaseCalculator 
                        radionuclides={radionuclides}
                        nuclideSymbol={pr_nuclideSymbol} setNuclideSymbol={setPr_nuclideSymbol}
                        activity={pr_activity} setActivity={setPr_activity}
                        activityUnit={pr_activityUnit} setActivityUnit={setPr_activityUnit}
                        measuredDoseRate={pr_measuredDoseRate} setMeasuredDoseRate={setPr_measuredDoseRate}
                        scenarios={pr_scenarios} setScenarios={setPr_scenarios}
                        effectiveHalfLife={pr_effectiveHalfLife} setEffectiveHalfLife={setPr_effectiveHalfLife}
                        effectiveHalfLifeUnit={pr_effectiveHalfLifeUnit} setEffectiveHalfLifeUnit={setPr_effectiveHalfLifeUnit}
                        result={pr_result} setResult={setPr_result}
                        error={pr_error} setError={setPr_error}
                    />
                }
            </div>
         </div>
         );
         };
         
         /**
         * @description React component for calculating the required shielding for an X-ray room.
         * This calculator uses the standard shielding design formula from NCRP Report No. 147,
         * which determines the necessary barrier thickness to reduce the weekly dose equivalent
         * to an acceptable limit.
         *
         * The formula is based on the relationship:
         * $$B = \frac{P \cdot d^2}{W \cdot U \cdot T}$$
         * where:
         * **B** = Required transmission factor
         * **P** = Weekly dose limit (mSv or mrem)
         * **d** = Distance from source to barrier (m)
         * **W** = Workload (mA-min/week)
         * **U** = Use factor
         * **T** = Occupancy factor
         *
         * The required shielding thickness is then calculated from the transmission factor **B**
         * using the tenth-value layer (TVL) data for the specified shielding material (lead, concrete, or drywall).
         *
         * @prop {string} kvp - The peak kilovoltage of the X-ray tube.
         * @prop {function} setKvp - State setter for kvp.
         * @prop {string} workload - The workload in milliampere-minutes per week.
         * @prop {function} setWorkload - State setter for workload.
         * @prop {string} useFactor - The fraction of the workload directed at a barrier.
         * @prop {function} setUseFactor - State setter for use factor.
         * @prop {string} occupancyFactor - The fraction of time an area is occupied.
         * @prop {function} setOccupancyFactor - State setter for occupancy factor.
         * @prop {string} distance - The distance from the X-ray source to the barrier.
         * @prop {function} setDistance - State setter for distance.
         * @prop {string} doseLimit - The weekly dose limit.
         * @prop {function} setDoseLimit - State setter for dose limit.
         * @prop {string} shieldMaterial - The type of shielding material.
         * @prop {function} setShieldMaterial - State setter for shield material.
         * @prop {object} result - Object containing the calculated thickness and other values.
         * @prop {function} setResult - State setter for the result.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */            
         
const XRayShieldingCalculator = ({ kvp, setKvp, workload, setWorkload, useFactor, setUseFactor, occupancyFactor, setOccupancyFactor, distance, setDistance, doseLimit, setDoseLimit, shieldMaterial, setShieldMaterial, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const TVL_DATA = { 'Lead': { 50: { TVL1: 0.06, TVLe: 0.06 }, 70: { TVL1: 0.17, TVLe: 0.17 }, 100: { TVL1: 0.27, TVLe: 0.27 }, 125: { TVL1: 0.28, TVLe: 0.28 }, 150: { TVL1: 0.30, TVLe: 0.30 } }, 'Concrete': { 50: { TVL1: 4.3, TVLe: 4.3 }, 70: { TVL1: 5.0, TVLe: 5.0 }, 100: { TVL1: 5.7, TVLe: 5.7 }, 125: { TVL1: 6.1, TVLe: 6.1 }, 150: { TVL1: 6.4, TVLe: 6.4 } }, 'Drywall': { 50: { TVL1: 2.1, TVLe: 2.1 }, 70: { TVL1: 2.6, TVLe: 2.6 }, 100: { TVL1: 3.3, TVLe: 3.2 }, 125: { TVL1: 3.8, TVLe: 3.6 }, 150: { TVL1: 4.1, TVLe: 3.8 } } };
    const K_FACTORS_R_PER_mA_min_at_1m = { 50: 0.034, 70: 0.075, 100: 0.165, 125: 0.26, 150: 0.37 };
    
    React.useEffect(() => {
    try {
       setError('');
       const W = parseFloat(workload); const U = parseFloat(useFactor); const T = parseFloat(occupancyFactor);
       const d = parseFloat(distance); const P = parseFloat(doseLimit) / 1000;
       if ([W, U, T, d, P].some(isNaN) || W <= 0 || d <= 0) { throw new Error("All inputs must be valid, positive numbers."); }
       const K = K_FACTORS_R_PER_mA_min_at_1m[kvp] || 0;
       const B = (P * Math.pow(d, 2)) / (K * W * U * T);
       if (B >= 1) { setResult({ thickness: 0, tvls: 0, transmission: B > 1 ? '>1' : B.toExponential(2) }); return; }
       const n_tvl = -Math.log10(B);
       const { TVL1, TVLe } = TVL_DATA[shieldMaterial][kvp];
       const thickness = TVL1 + (n_tvl - 1) * TVLe;
       setResult({ transmission: B.toExponential(2), tvls: n_tvl.toFixed(2), thickness: thickness.toFixed(2), });
    } catch (e) { setResult(null); setError(e.message); }
    }, [kvp, workload, useFactor, occupancyFactor, distance, doseLimit, shieldMaterial, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'X-Ray Shielding', icon: ICONS.medical, inputs: `${workload} mA-min/wk @ ${kvp} kVp`, result: `${result.thickness} ${shieldMaterial === 'Lead' ? 'mm' : 'cm'} ${shieldMaterial}`, view: VIEWS.MEDICAL });
           addToast("Calculation saved to history!");
        }
    };
    
    const useFactorOptions = [ { value: 1, label: '1 (Floors, full-time control rooms)' }, { value: 0.25, label: '1/4 (Doors, walls)' }, { value: 0.0625, label: '1/16 (Ceilings)' } ];
    const occupancyOptions = [ { value: 1, label: '1 (Work areas, offices, labs)' }, { value: 0.2, label: '1/5 (Corridors, patient rooms)' }, { value: 0.05, label: '1/20 (Public restrooms, waiting rooms)' } ];
    const doseLimitOptions = [ { value: 100, label: '100 mR/wk (Controlled Area)' }, { value: 2, label: '2 mR/wk (Uncontrolled Area)' } ];
    
    return (
    <div className="space-y-4">
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label className="block text-sm font-medium">Tube Potential (kVp)</label><select value={kvp} onChange={e => setKvp(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(K_FACTORS_R_PER_mA_min_at_1m).map(k => <option key={k} value={k}>{k} kVp</option>)}</select></div>
           <div><label className="block text-sm font-medium">Workload (mA-min/week)</label><input type="number" value={workload} onChange={e => setWorkload(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Use Factor (U)</label><select value={useFactor} onChange={e => setUseFactor(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{useFactorOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
           <div><label className="block text-sm font-medium">Occupancy Factor (T)</label><select value={occupancyFactor} onChange={e => setOccupancyFactor(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{occupancyOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
           <div><label className="block text-sm font-medium">Distance from Source (m)</label><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Weekly Dose Limit (P)</label><select value={doseLimit} onChange={e => setDoseLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{doseLimitOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
           <div className="md:col-span-2"><label className="block text-sm font-medium">Shielding Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="Lead">Lead</option><option value="Concrete">Concrete</option><option value="Drywall">Drywall</option></select></div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 text-center animate-fade-in">
               <div className="flex justify-end -mt-2 -mr-2">
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
               </div>
               <div className="grid grid-cols-2 gap-2 text-sm -mt-4"><p>Required Transmission (B):</p><p className="font-mono">{result.transmission}</p><p>Required TVLs:</p><p className="font-mono">{result.tvls}</p></div>
               <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Required Shield Thickness</p>
                   <div className="flex items-center justify-center">
                       <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.thickness}<span className="text-2xl ml-2 opacity-75">{shieldMaterial === 'Lead' ? 'mm' : 'cm'}</span></p>
                       <CopyButton textToCopy={result.thickness} />
                   </div>
               </div>
           </div>
       )}
    </div>
    );
};
         
         /**
         * @description React component for a patient release calculator. This tool helps medical
         * physics professionals determine if a patient treated with a radiopharmaceutical meets the
         * criteria for release from the hospital, as outlined in U.S. NRC regulations (e.g., 10 CFR 35.75).
         *
         * It evaluates patient release based on a three-tiered approach:
         * 1.  **Activity-based limit:** Checks if the administered activity is below a pre-defined threshold.
         * 2.  **Dose rate-based limit:** (For I-131 only) Checks if the measured dose rate at one meter
         * is below the regulatory limit.
         * 3.  **Integrated dose calculation:** If the first two criteria aren't met, it calculates the
         * Total Effective Dose Equivalent (TEDE) that a member of the public would receive from the
         * patient based on custom occupancy scenarios. This calculation uses the patient's
         * administered activity, the selected nuclide's gamma constant, and either the physical
         * or an inputted effective half-life.
         *
         * The calculator provides a clear PASS/FAIL result and details the specific criterion met or failed.
         *
         * @prop {array} radionuclides - Array of radionuclide data used for lookup.
         * @prop {string} nuclideSymbol - The symbol of the selected radionuclide.
         * @prop {function} setNuclideSymbol - State setter for the nuclide symbol.
         * @prop {string} activity - The administered activity.
         * @prop {function} setActivity - State setter for activity.
         * @prop {string} activityUnit - The unit of administered activity.
         * @prop {function} setActivityUnit - State setter for activity unit.
         * @prop {string} measuredDoseRate - The optional measured dose rate for I-131.
         * @prop {function} setMeasuredDoseRate - State setter for the measured dose rate.
         * @prop {array} scenarios - Array of objects describing various public occupancy scenarios.
         * @prop {function} setScenarios - State setter for the scenarios array.
         * @prop {string} effectiveHalfLife - An optional effective half-life for the nuclide.
         * @prop {function} setEffectiveHalfLife - State setter for effective half-life.
         * @prop {string} effectiveHalfLifeUnit - The unit for the effective half-life.
         * @prop {function} setEffectiveHalfLifeUnit - State setter for the effective half-life unit.
         * @prop {object} result - Object containing the final analysis result.
         * @prop {function} setResult - State setter for the result object.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         
  const PatientReleaseCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, activity, setActivity, activityUnit, setActivityUnit, measuredDoseRate, setMeasuredDoseRate, scenarios, setScenarios, effectiveHalfLife, setEffectiveHalfLife, effectiveHalfLifeUnit, setEffectiveHalfLifeUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const I131_ACTIVITY_RELEASE_LIMIT_MCI = 33;
    const I131_DOSE_RATE_RELEASE_LIMIT_MREM_HR = 7;
    const TEDE_RELEASE_LIMIT_MREM = 500;
    
    const therapyNuclides = React.useMemo(() => radionuclides.filter(n => THERAPY_NUCLIDES.includes(n.symbol) && n.gammaConstant).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => therapyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, therapyNuclides]);
    
    const handleScenarioChange = (id, field, value) => setScenarios(scenarios.map(s => s.id === id ? { ...s, [field]: value } : s));
    const addScenario = () => setScenarios([...scenarios, { id: Date.now(), name: '', hours: 1, distance: 3, distUnit: 'm' }]);
    const removeScenario = (id) => setScenarios(scenarios.filter(s => s.id !== id));
    
    React.useEffect(() => {
    if (!selectedNuclide) { setResult(null); setError('Please select a radionuclide.'); return; }
    try {
       setError('');
       const A0_mCi = parseFloat(activity) * ({'µCi': 1e-3, 'mCi': 1, 'Ci': 1000}[activityUnit]);
       if (isNaN(A0_mCi)) throw new Error("Invalid administered activity.");
       if (selectedNuclide.symbol === 'I-131') {
           if (A0_mCi <= I131_ACTIVITY_RELEASE_LIMIT_MCI) { setResult({ title: 'PASS (Activity Limit Met)', pass: true, details: [`Administered activity of ${A0_mCi.toFixed(1)} mCi is at or below the 33 mCi release limit.`] }); return; }
           const measuredRate = parseFloat(measuredDoseRate);
           if (!isNaN(measuredRate)) { if (measuredRate <= I131_DOSE_RATE_RELEASE_LIMIT_MREM_HR) { setResult({ title: 'PASS (Dose Rate Met)', pass: true, details: [`Measured dose rate of ${measuredRate} mrem/hr is at or below the 7 mrem/hr limit.`] }); return; } }
       }
       let T_half_hours_eff;
       const T_half_hours_phys = parseHalfLifeToSeconds(selectedNuclide.halfLife) / 3600;
       const effectiveHL_val = parseFloat(effectiveHalfLife);
       if (!isNaN(effectiveHL_val) && effectiveHL_val > 0) {
           const unitFactors = { 'hours': 1, 'days': 24 };
           T_half_hours_eff = effectiveHL_val * unitFactors[effectiveHalfLifeUnit];
           if (T_half_hours_eff > T_half_hours_phys) { throw new Error("Effective half-life cannot be longer than the physical half-life."); }
       } else { T_half_hours_eff = T_half_hours_phys; }
       const gammaConstant_R_m2_per_Ci_hr = parseFloat(selectedNuclide.gammaConstant);
       if (isNaN(T_half_hours_eff) || isNaN(gammaConstant_R_m2_per_Ci_hr)) { throw new Error("Invalid nuclide data for dose calculation."); }
       let totalDose_mrem = 0; let effectiveDoseRateFactor = 0;
       scenarios.forEach(s => {
           const hours = parseFloat(s.hours); const dist = parseFloat(s.distance);
           const dist_m = dist * ({'cm': 0.01, 'm': 1, 'ft': 0.3048}[s.distUnit]);
           if (isNaN(hours) || isNaN(dist) || dist <= 0) throw new Error("Occupancy inputs are invalid.");
           const totalDoseForScenario = (1.443 * gammaConstant_R_m2_per_Ci_hr * (A0_mCi/1000) * T_half_hours_eff * (hours/24)) / Math.pow(dist_m, 2);
           totalDose_mrem += totalDoseForScenario * 1000;
           effectiveDoseRateFactor += ( (hours/24) / Math.pow(dist_m, 2) );
       });
       const initialTotalDose = (1.443 * gammaConstant_R_m2_per_Ci_hr * (A0_mCi/1000) * T_half_hours_eff * effectiveDoseRateFactor) * 1000;
       let timeToRelease_hours = 0;
       if (initialTotalDose > TEDE_RELEASE_LIMIT_MREM) { timeToRelease_hours = (-T_half_hours_eff / Math.log(2)) * Math.log(500 / initialTotalDose); }
       const passesTede = totalDose_mrem <= 500;
       setResult({ title: passesTede ? 'PASS (Dose Calculation)' : 'FAIL (Dose Calculation)', pass: passesTede, details: [ `Total Integrated Dose (TEDE): ${totalDose_mrem.toFixed(1)} mrem`, `(Limit: ${TEDE_RELEASE_LIMIT_MREM} mrem)`, `Time to Meet Criteria: ${timeToRelease_hours.toFixed(1)} hours` ], totalDose: totalDose_mrem.toFixed(1), halfLifeUsed_hr: T_half_hours_eff.toFixed(2), isEffective: T_half_hours_eff !== T_half_hours_phys, });
    } catch (e) { setResult(null); setError(e.message); }
    }, [selectedNuclide, activity, activityUnit, scenarios, measuredDoseRate, effectiveHalfLife, effectiveHalfLifeUnit, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
           addHistory({ id: Date.now(), type: 'Patient Release', icon: ICONS.medical, inputs: `${activity} ${activityUnit} of ${selectedNuclide.symbol}`, result: result.title, view: VIEWS.MEDICAL });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <p className="text-sm text-slate-600 dark:text-slate-400">This tool evaluates patient release criteria based on 10 CFR 35.75 guidance. It checks against activity, dose rate, and integrated dose limits.</p>
       <div><label className="text-sm font-medium">Radionuclide</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> : <SearchableSelect options={therapyNuclides} onSelect={setNuclideSymbol} placeholder="Select a therapy nuclide..."/>}</div></div>
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-2">
               <label className="text-sm font-medium">Administered Activity</label>
               <div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600"><option>µCi</option><option>mCi</option><option>Ci</option></select></div>
               {selectedNuclide?.symbol === 'I-131' && ( <div className="animate-fade-in pt-2"><label className="text-sm font-medium">Measured Dose Rate @ 1m (Optional)</label><div className="flex"><input type="number" value={measuredDoseRate} onChange={e => setMeasuredDoseRate(e.target.value)} placeholder="e.g., 5.2" className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><span className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm flex items-center">mrem/hr</span></div></div> )}
               {selectedNuclide && ( <div className="animate-fade-in pt-2"><Tooltip text="Enter the effective half-life for the specific radiopharmaceutical. If left blank, the physical half-life will be used."><label className="text-sm font-medium">Effective Half-Life (Optional)</label></Tooltip><div className="flex"><input type="number" value={effectiveHalfLife} onChange={e => setEffectiveHalfLife(e.target.value)} placeholder={`e.g., ${(parseHalfLifeToSeconds(selectedNuclide.halfLife) / 3600).toPrecision(3)}`} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={effectiveHalfLifeUnit} onChange={e => setEffectiveHalfLifeUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm"><option>hours</option><option>days</option></select></div></div> )}
           </div>
           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3">
               <label className="text-sm font-medium">Occupancy Scenarios (for TEDE)</label>
               <div className="hidden sm:flex gap-2 items-center text-xs font-semibold text-slate-500 dark:text-slate-400"><div className="flex-grow">Scenario Name</div><div className="w-1/4">Hours/Day</div><div className="w-1/3">Distance</div><div className="w-[28px] flex-shrink-0"></div></div>
               {scenarios.map((s, index) => (
                   <div key={s.id} className="space-y-2">
                       <input type="text" placeholder={`Scenario #${index + 1}`} value={s.name} onChange={e => handleScenarioChange(s.id, 'name', e.target.value)} className="p-1 rounded bg-slate-100 dark:bg-slate-700 w-full text-sm" />
                       <div className="flex flex-wrap sm:flex-nowrap gap-2 items-center">
                           <input type="number" value={s.hours} onChange={e => handleScenarioChange(s.id, 'hours', e.target.value)} className="p-1 rounded bg-slate-100 dark:bg-slate-700 w-full sm:w-1/4" title="Hours per day"/>
                           <div className="flex w-full sm:w-1/3 flex-grow"><input type="number" value={s.distance} onChange={e => handleScenarioChange(s.id, 'distance', e.target.value)} className="p-1 rounded-l bg-slate-100 dark:bg-slate-700 w-full" title="Distance"/><select value={s.distUnit} onChange={e => handleScenarioChange(s.id, 'distUnit', e.target.value)} className="p-1 rounded-r bg-slate-200 dark:bg-slate-600 text-xs"><option>m</option><option>cm</option><option>ft</option></select></div>
                           <button onClick={() => removeScenario(s.id)} disabled={scenarios.length <= 1} className="p-1 text-red-500 disabled:opacity-30"><Icon path={ICONS.clear} className="w-5 h-5"/></button>
                       </div>
                   </div>
               ))}
               <button onClick={addScenario} className="text-sm font-semibold text-sky-600 hover:underline pt-2">+ Add Scenario</button>
           </div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className={`p-4 rounded-lg text-center ${result.pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                <div className="flex justify-between items-center -mt-2">
                    <div></div> {/* Spacer */}
                    <p className={`text-2xl font-extrabold ${result.pass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.title}</p>
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
                </div>
               <div className="mt-2 text-sm">
                   {result.details.map((line, i) => {
                       if (line.includes('TEDE')) {
                           return (
                               <div key={i} className="flex items-center justify-center">
                                   <p className={result.pass ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}>{line}</p>
                                   <CopyButton textToCopy={result.totalDose} />
                               </div>
                           );
                       }
                       return <p key={i} className={result.pass ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}>{line}</p>;
                   })}
               </div>
               {result.halfLifeUsed_hr && ( <p className="text-xs italic text-slate-500 dark:text-slate-400 mt-2">Calculation based on {result.isEffective ? 'effective' : 'physical'} half-life of {result.halfLifeUsed_hr} hours.</p> )}
           </div>
       )}
    </div>
    );
};
         
/**
 * @description A component to display sortable and filterable data tables of all radionuclide emissions.
 * It parses and flattens the entire radionuclide dataset into sortable lists for
 * gamma, alpha, and beta emissions, and allows for CSV export.
 */
const PeakDataTables = ({ radionuclides, onNuclideClick }) => {
    const [activeTable, setActiveTable] = React.useState('alpha');
    const [sortConfig, setSortConfig] = React.useState({ key: 'energyMeV', direction: 'ascending' });
    // NEW: State to hold the filter text
    const [filterText, setFilterText] = React.useState('');

    const parseEnergy = React.useCallback((energyStr) => {
        if (!energyStr) return null;
        const energyRegex = /([\d.]+)\s*(MeV|keV)/i;
        const energyMatch = energyStr.match(energyRegex);
        if (!energyMatch) return null;
        let energyMeV = parseFloat(energyMatch[1]);
        if (energyMatch[2].toLowerCase() === 'kev') {
            energyMeV /= 1000;
        }
        return { energyMeV, displayEnergy: energyStr.split(' (')[0] };
    }, []);

    const flattenedData = React.useMemo(() => {
        const data = { gamma: [], alpha: [], beta: [] };
        radionuclides.forEach(nuclide => {
            Object.keys(data).forEach(type => {
                nuclide.emissionEnergies?.[type]?.forEach(energyStr => {
                    const parsed = parseEnergy(energyStr);
                    if (parsed) {
                        data[type].push({ nuclideSymbol: nuclide.symbol, nuclideName: nuclide.name, category: nuclide.category, ...parsed });
                    }
                });
            });
            if (nuclide.daughterEmissions) {
                 const daughterNuclide = radionuclides.find(n => n.symbol === nuclide.daughterEmissions.from);
                 const daughterCategory = daughterNuclide ? daughterNuclide.category : 'N/A';
                 Object.keys(data).forEach(type => {
                    nuclide.daughterEmissions?.[type]?.forEach(energyStr => {
                        const parsed = parseEnergy(energyStr);
                        if (parsed) {
                            const daughterName = `${nuclide.daughterEmissions.from} (from ${nuclide.symbol})`;
                            data[type].push({ nuclideSymbol: nuclide.daughterEmissions.from, nuclideName: daughterName, category: daughterCategory, ...parsed });
                        }
                    });
                });
            }
        });
        return data;
    }, [radionuclides, parseEnergy]);

    // UPDATED: This memoized value now filters the data before sorting it.
    const sortedAndFilteredData = React.useMemo(() => {
        let dataToProcess = [...flattenedData[activeTable]];

        // Apply filtering if filterText is not empty
        if (filterText) {
            dataToProcess = dataToProcess.filter(item =>
                item.nuclideName.toLowerCase().includes(filterText.toLowerCase())
            );
        }
        
        // Apply sorting to the filtered data
        if (sortConfig.key !== null) {
            dataToProcess.sort((a, b) => {
                const valA = a[sortConfig.key] || '';
                const valB = b[sortConfig.key] || '';
                if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                return 0;
            });
        }
        return dataToProcess;
    }, [flattenedData, activeTable, sortConfig, filterText]); // Added filterText as a dependency

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
    };

    const getSortIndicator = (key) => {
        if (sortConfig.key !== key) return '↕';
        return sortConfig.direction === 'ascending' ? '▲' : '▼';
    };
    
    // NEW: Handler to export the current view to a CSV file.
    const handleExportCSV = () => {
        if (sortedAndFilteredData.length === 0) return;
        const headers = ['Nuclide', 'Energy', 'Category'];
        const rows = sortedAndFilteredData.map(item => [
            `"${item.nuclideName}"`, // Enclose in quotes to handle potential commas
            item.displayEnergy,
            item.category
        ].join(','));
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", `${activeTable}_emissions_data.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="animate-fade-in">
            <div className="flex w-full p-1 bg-slate-100 dark:bg-slate-900/50 rounded-lg mb-4 border border-slate-200 dark:border-slate-700">
                <button onClick={() => setActiveTable('alpha')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTable === 'alpha' ? 'bg-white dark:bg-slate-700 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>α Alpha</button>
                <button onClick={() => setActiveTable('beta')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTable === 'beta' ? 'bg-white dark:bg-slate-700 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>β Beta</button>
                <button onClick={() => setActiveTable('gamma')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTable === 'gamma' ? 'bg-white dark:bg-slate-700 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>γ Gamma</button>
            </div>
            
            {/* NEW: Filter and Export controls */}
            <div className="flex justify-between items-center mb-2 gap-4">
                <div className="relative flex-grow">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <Icon path={ICONS.search} className="w-4 h-4 text-slate-400" />
                    </div>
                    <input
                        type="text"
                        placeholder={`Filter by nuclide name...`}
                        value={filterText}
                        onChange={(e) => setFilterText(e.target.value)}
                        className="w-full p-2 pl-9 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm"
                    />
                </div>
                <button
                    onClick={handleExportCSV}
                    className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2 flex-shrink-0"
                >
                    <Icon path={ICONS.database} className="w-4 h-4" />
                    Export CSV
                </button>
            </div>

            <div className="overflow-y-auto max-h-[55vh] border border-slate-200 dark:border-slate-700 rounded-lg">
                <table className="w-full text-sm text-left">
                    <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0">
                        <tr>
                            <th className="p-3 cursor-pointer whitespace-nowrap" onClick={() => requestSort('nuclideName')}>Nuclide {getSortIndicator('nuclideName')}</th>
                            <th className="p-3 cursor-pointer whitespace-nowrap" onClick={() => requestSort('energyMeV')}>Energy {getSortIndicator('energyMeV')}</th>
                            <th className="p-3 cursor-pointer whitespace-nowrap" onClick={() => requestSort('category')}>Category {getSortIndicator('category')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                        {sortedAndFilteredData.map((item, index) => {
                            const categoryStyle = CATEGORY_STYLES[item.category] || CATEGORY_STYLES['default'];
                            const bgColor = categoryStyle.border.replace('border-l-', 'bg-').replace('-400', '-100').replace('-600', '-900/50');
                            const textColor = categoryStyle.border.replace('border-l-', 'text-').replace('-400', '-700').replace('-600', '-300');

                            return (
                                <tr key={`${item.nuclideSymbol}-${item.displayEnergy}-${index}`} className="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                    <td className="p-3 font-medium">
                                        <button onClick={() => { const nuclideToFind = radionuclides.find(n => n.symbol === item.nuclideSymbol); if (nuclideToFind) onNuclideClick(nuclideToFind);}} className="text-sky-600 dark:text-sky-400 hover:underline">
                                            {item.nuclideName}
                                        </button>
                                    </td>
                                    <td className="p-3 font-mono">{item.displayEnergy}</td>
                                    <td className="p-3">
                                        <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${bgColor} ${textColor}`}>
                                            {item.category || 'N/A'}
                                        </span>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

/**
         * @description A calculator to identify radionuclides and analyze common spectroscopic artifacts
         * by matching a gamma or alpha peak energy against the database. Now includes sortable data tables.
         */
         const PeakIdentifier = ({ radionuclides, onNuclideClick }) => {
             // NEW: State to manage the view between Search and Data Tables
             const [peakIdMode, setPeakIdMode] = React.useState('search'); 
         
             // Existing state for the search tool
             const [searchMode, setSearchMode] = React.useState('gamma');
             const [targetEnergy, setTargetEnergy] = React.useState('662');
             const [tolerance, setTolerance] = React.useState('2');
             const [energyUnit, setEnergyUnit] = React.useState('keV');
             const [results, setResults] = React.useState([]);
             const [analysis, setAnalysis] = React.useState(null);
             const [error, setError] = React.useState('');
         
             const LEAD_XRAYS = [
                 { name: 'Pb K-α2', energy: 0.07280 },
                 { name: 'Pb K-α1', energy: 0.07497 },
                 { name: 'Pb K-β3', energy: 0.08445 },
                 { name: 'Pb K-β1', energy: 0.08494 },
                 { name: 'Pb K-β2', energy: 0.08736 },
             ];
         
             const parseSingleEnergyToMeV = (energyStr) => {
                 if (!energyStr || typeof energyStr !== 'string') return null;
                 const parts = energyStr.trim().split(' ');
                 let value = parseFloat(parts[0]);
                 if (isNaN(value)) return null;
                 const unit = parts[1]?.toLowerCase();
                 if (unit && unit.includes('kev')) return value / 1000;
                 return value;
             };
         
             // UPDATED: handleClearInputs now resets the view mode as well
             const handleClearInputs = () => {
                 setPeakIdMode('search'); // Go back to search view
                 setSearchMode('gamma');
                 setTargetEnergy('662');
                 setTolerance('2');
                 setEnergyUnit('keV');
                 setResults([]);
                 setAnalysis(null);
                 setError('');
             };
             
             React.useEffect(() => {
                 if (searchMode === 'gamma') {
                     setTargetEnergy('662'); setTolerance('2'); setEnergyUnit('keV');
                 } else {
                     setTargetEnergy('5.486'); setTolerance('0.05'); setEnergyUnit('MeV');
                 }
             }, [searchMode]);
         
             React.useEffect(() => {
                 try {
                     setError('');
                     const target = parseFloat(targetEnergy); const tol = parseFloat(tolerance);
                     if (isNaN(target) || isNaN(tol) || target <= 0 || tol < 0) {
                         if (targetEnergy || tolerance) setError('Energy and tolerance must be positive numbers.');
                         setResults([]); setAnalysis(null); return;
                     }
                     const targetMeV = energyUnit === 'keV' ? target / 1000 : target;
                     const toleranceMeV = energyUnit === 'keV' ? tol / 1000 : tol;
                     const minEnergy = targetMeV - toleranceMeV; const maxEnergy = targetMeV + toleranceMeV;
                     
                     const matches = [];
                     const emissionKey = searchMode === 'gamma' ? 'gamma' : 'alpha';
                     
                     radionuclides.forEach(nuclide => {
                         const emissions = nuclide.emissionEnergies?.[emissionKey];
                         if (emissions && emissions.length > 0) {
                             emissions.forEach(emissionStr => {
                                 const peakMeV = parseSingleEnergyToMeV(emissionStr);
                                 if (peakMeV !== null && peakMeV >= minEnergy && peakMeV <= maxEnergy) {
                                     // MODIFIED: Store more detailed match information
                                     matches.push({ 
                                         nuclide, 
                                         matchedEnergy: emissionStr.split(' (')[0], // Get just the energy string
                                         diff: Math.abs(peakMeV - targetMeV) * 1000 // Difference in keV
                                     });
                                 }
                             });
                         }
                     });

                     // Sort matches by how close they are to the target energy
                     matches.sort((a, b) => a.diff - b.diff);

                     setResults(matches);
                     
                     if (searchMode === 'gamma') {
                         const mc2 = 0.511;
                         const comptonEdge = targetMeV / (1 + (mc2 / (2 * targetMeV)));
                         const singleEscape = targetMeV > 1.022 ? targetMeV - 0.511 : null;
                         const doubleEscape = targetMeV > 1.022 ? targetMeV - 1.022 : null;
                         const leadXrayMatch = LEAD_XRAYS.find(xray => Math.abs(xray.energy - targetMeV) <= toleranceMeV);
                         setAnalysis({
                             comptonEdge: comptonEdge.toFixed(3),
                             singleEscape: singleEscape ? singleEscape.toFixed(3) : null,
                             doubleEscape: doubleEscape ? doubleEscape.toFixed(3) : null,
                             isLeadXray: leadXrayMatch ? leadXrayMatch.name : null,
                         });
                     } else { setAnalysis(null); }
                 } catch (e) {
                     setError('An error occurred during search.'); setResults([]); setAnalysis(null);
                 }
             }, [targetEnergy, tolerance, energyUnit, searchMode, radionuclides]);
         
             return (
                 <div className="p-4 animate-fade-in">
                     <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                         <div className="flex justify-between items-center mb-4">
                             <h2 className="text-xl font-bold text-slate-800 dark:text-white">Peak Identifier</h2>
                             <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                                 <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
                             </button>
                         </div>
                         
                         {/* NEW: Main tabs to switch between Search and Data Tables */}
                         <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                             <button onClick={() => setPeakIdMode('search')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${peakIdMode === 'search' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Search</button>
                             <button onClick={() => setPeakIdMode('tables')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${peakIdMode === 'tables' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Data Tables</button>
                         </div>
         
                         {/* NEW: Conditional rendering based on the selected mode */}
                         {peakIdMode === 'search' ? (
                             <div className="animate-fade-in">
                                 <div className="flex w-full p-1 bg-slate-100 dark:bg-slate-900/50 rounded-lg mb-4 border border-slate-200 dark:border-slate-700">
                                     <button onClick={() => setSearchMode('gamma')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${searchMode === 'gamma' ? 'bg-white dark:bg-slate-700 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Gamma Spec</button>
                                     <button onClick={() => setSearchMode('alpha')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${searchMode === 'alpha' ? 'bg-white dark:bg-slate-700 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Alpha Spec</button>
                                 </div>
                                 <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                         <div><label className="block text-sm font-medium">Peak Energy</label><input type="number" value={targetEnergy} onChange={e => setTargetEnergy(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                                         <div><label className="block text-sm font-medium">Tolerance (±)</label><input type="number" value={tolerance} onChange={e => setTolerance(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                                     </div>
                                     <div><label className="block text-sm font-medium">Energy Unit</label><select value={energyUnit} onChange={e => setEnergyUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="keV">keV</option><option value="MeV">MeV</option></select></div>
                                 </div>
                                 {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
                                 {analysis && ( <div className="mt-6 p-4 bg-slate-100 dark:bg-slate-700/50 rounded-lg animate-fade-in"><h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-2">Spectrum Analysis</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"><div><Tooltip text="The maximum energy a gamma can impart to an electron in a single Compton scattering event. Expect a sharp drop-off in the continuum here."><p className="font-semibold text-slate-500 dark:text-slate-400">Compton Edge</p></Tooltip><p className="font-mono text-slate-800 dark:text-slate-100">{analysis.comptonEdge} MeV</p></div>{analysis.singleEscape && (<div><Tooltip text="A peak seen at 511 keV below the full energy peak, caused by one annihilation photon escaping the detector after pair production. (E > 1.022 MeV)"><p className="font-semibold text-slate-500 dark:text-slate-400">Single Escape</p></Tooltip><p className="font-mono text-slate-800 dark:text-slate-100">{analysis.singleEscape} MeV</p></div>)}{analysis.doubleEscape && (<div><Tooltip text="A peak seen at 1022 keV below the full energy peak, caused by both annihilation photons escaping the detector after pair production. (E > 1.022 MeV)"><p className="font-semibold text-slate-500 dark:text-slate-400">Double Escape</p></Tooltip><p className="font-mono text-slate-800 dark:text-slate-100">{analysis.doubleEscape} MeV</p></div>)}{analysis.isLeadXray && (<div className="col-span-2 md:col-span-3 mt-2 pt-2 border-t border-slate-300 dark:border-slate-600"><p className="font-semibold text-amber-600 dark:text-amber-400"><Icon path={ICONS.help} className="w-4 h-4 inline-block mr-1" />This energy is consistent with a {analysis.isLeadXray} X-ray, often seen from lead shielding.</p></div>)}</div></div> )}
                                 <div className="mt-6">
                                     <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-2">Matching Radionuclides ({results.length})</h3>
                                     <div className="max-h-96 overflow-y-auto space-y-2 pr-2">
                                         {results.length > 0 ? ( 
                                             results.map(({ nuclide, matchedEnergy, diff }, index) => ( 
                                                 <div key={`${nuclide.symbol}-${index}`} onClick={() => onNuclideClick(nuclide)} className="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg hover:ring-2 hover:ring-sky-500 cursor-pointer transition-all duration-150">
                                                     <div className="flex justify-between items-start">
                                                         <p className="font-bold text-sky-600 dark:text-sky-400">{nuclide.name} ({nuclide.symbol})</p>
                                                         <span className="text-xs font-mono text-slate-500 dark:text-slate-400 whitespace-nowrap">Δ = {diff.toFixed(2)} keV</span>
                                                     </div>
                                                     <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Matched Peak: <span className="font-semibold text-slate-700 dark:text-slate-200">{matchedEnergy}</span></p>
                                                 </div> 
                                             )) 
                                         ) : ( 
                                             <p className="text-center text-slate-500 dark:text-slate-400 py-4">{targetEnergy && tolerance ? "No matches found." : "Enter an energy to begin."}</p> 
                                         )}
                                     </div>
                                 </div>
                             </div>
                         ) : (
                             <PeakDataTables radionuclides={radionuclides} onNuclideClick={onNuclideClick} />
                         )}
                     </div>
                 </div>
             );
         };
         
         /**
          * @description A calculator that uses the Bateman equations to model the activity of every
          * nuclide in a full decay series over time.
          * @param {{radionuclides: Array<object>, decaySeriesData: Array<object>}} props
          */
         
         const DecaySeriesCalculator = ({ radionuclides, decaySeriesData, theme }) => { // <-- MODIFIED: Added 'theme' to the props
         
         const { settings } = React.useContext(SettingsContext);
         const [selectedSeriesId, setSelectedSeriesId] = React.useState(decaySeriesData[0].id);
         const [initialActivity, setInitialActivity] = React.useState('100');
         const [timeElapsed, setTimeElapsed] = React.useState('1000');
         const [timeUnit, setTimeUnit] = React.useState('years');
         const [results, setResults] = React.useState([]);
         const [chartData, setChartData] = React.useState(null);
         const [error, setError] = React.useState('');
         const [isLoading, setIsLoading] = React.useState(false);
         // ADDED: State for the log scale toggle, defaulting to your settings
         const [useLogScale, setUseLogScale] = React.useState(settings.chartScale === 'Logarithmic');
         
         const timeUnits = longTimeUnits_ordered;
         const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600, 'kiloyears': 31557600 * 1e3, 'megayears': 31557600 * 1e6, 'gigayears': 31557600 * 1e9 };
         
         const handleCalculate = () => {
         const series = decaySeriesData.find(s => s.id === selectedSeriesId);
         if (!series) { setError('Please select a decay series.'); return; }
         const A0 = parseFloat(initialActivity);
         const t_input = parseFloat(timeElapsed);
         if (isNaN(A0) || A0 < 0 || isNaN(t_input) || t_input < 0) {
         setError('Initial activity and time must be non-negative numbers.');
         setResults([]); setChartData(null); return;
         }
         setError(''); setIsLoading(true);
         setTimeout(() => {
         try {
            const t_seconds = t_input * unitConversions[timeUnit];
            const flatChain = flattenChainForCalculator(series.chain);
            const calculatedActivities = runBatemanWithBranching(flatChain, A0, t_seconds);
            const finalResults = flatChain.map((step, i) => ({ name: step.nuclide, activity: calculatedActivities[i] }));
            setResults(finalResults);
            const chartLabels = [];
            const datasets = flatChain.map((step, i) => ({
                label: step.nuclide, data: [],
                borderColor: `hsl(${(i * 360 / Math.min(series.chain.length, 15)) % 360}, 70%, 50%)`,
                borderWidth: 2, pointRadius: 0, tension: 0.4, hidden: i > 5
            }));
            const steps = 100;
            for (let i = 0; i <= steps; i++) {
                const timePoint = (t_input / steps) * i;
                chartLabels.push(timePoint.toPrecision(2));
                const timePoint_seconds = timePoint * unitConversions[timeUnit];
                const activitiesAtTimePoint = runBatemanWithBranching(flatChain, A0, timePoint_seconds);
                activitiesAtTimePoint.forEach((act, j) => { datasets[j].data.push(act); });
            }
            setChartData({ labels: chartLabels, datasets, timeUnit });
         } catch (e) {
            setError('An error occurred. Inputs may be too large or small for a stable result.');
            console.error(e);
         } finally {
            setIsLoading(false);
         }
         }, 50);
         };
         
         React.useEffect(() => {
         if (selectedSeriesId) { handleCalculate(); }
         }, [selectedSeriesId, initialActivity, timeElapsed, timeUnit]);
         
         const handleClearInputs = () => {
         setSelectedSeriesId(decaySeriesData[0].id);
         setInitialActivity('100');
         setTimeElapsed('1000');
         setTimeUnit('years');
         setResults([]);
         setChartData(null);
         setError('');
         setIsLoading(false);
         };
         
         return (
         <div className="p-4 animate-fade-in">
         <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white">Decay Series Calculator (Bateman)</h2>
                <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                    <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Decay Series</label>
                    <select value={selectedSeriesId} onChange={e => setSelectedSeriesId(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                        {decaySeriesData.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Initial Parent Activity</label>
                    <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Time Elapsed</label>
                    <div className="flex gap-2 mt-1">
                        <input type="number" value={timeElapsed} onChange={e => setTimeElapsed(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                        <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                            {timeUnits.map(u => <option key={u} value={u}>{u}</option>)}
                        </select>
                    </div>
                </div>
                <button onClick={handleCalculate} disabled={isLoading} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition disabled:bg-sky-800 disabled:cursor-wait">
                    {isLoading ? 'Calculating...' : 'Calculate'}
                </button>
            </div>
            {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="max-h-[400px] overflow-y-auto pr-2">
                    <h3 className="text-lg font-semibold mb-2">Results at {timeElapsed} {timeUnit}</h3>
                    {results.length > 0 ? (
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0">
                                <tr><th className="p-2">Nuclide</th><th className="p-2">Activity</th></tr>
                            </thead>
                            <tbody>
                                {results.map(r => (
                                    <tr key={r.name} className="border-b border-slate-200 dark:border-slate-700">
                                        <td className="p-2 font-medium">{r.name}</td>
                                        <td className="p-2">{r.activity.toPrecision(4)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : <p className="text-slate-500 text-center py-4">No results to display.</p>}
                </div>
                <div className="min-h-[300px]">
                    {chartData ? (
                        <>
                           
                           <div className="flex justify-end mb-2">
                                <label className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" />
                                    Use Logarithmic Scale
                                </label>
                            </div>
                           
                           <SeriesDecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} />
                        </>
                    ) : (
                        <div className="flex items-center justify-center h-full bg-slate-100 dark:bg-slate-800/50 rounded-lg">
                            <p className="text-slate-500">Chart will be displayed here.</p>
                        </div>
                    )}
                </div>
            </div>
         </div>
         </div>
         );
         };
         
         /**
          * @description A React component that renders a line chart for a decay series using Chart.js.
          * It's designed to display the activity of all nuclides in a chain over time.
          * @param {{chartData: object}} props - The data object for the chart, including labels and datasets.
          */
         
         const SeriesDecayChart = ({ chartData, useLogScale, theme }) => { // <-- MODIFIED: Accepted 'theme' prop
         const chartRef = React.useRef(null);
         const chartInstance = React.useRef(null);
         
         React.useEffect(() => {
         if (chartInstance.current) {
            chartInstance.current.destroy();
         }
         
         if (chartRef.current && chartData) {
         
            // Determine colors based on the theme prop
         
            const isDarkMode = theme === 'dark';
            const textColor = isDarkMode ? '#cbd5e1' : '#334155';
            const gridColor = isDarkMode ? '#334155' : '#e2e8f0';
         
            const ctx = chartRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { 
                                boxWidth: 20, 
                                font: { size: 10 },
                                color: textColor 
                            } 
                        },
                        title: {
                            display: true,
                            text: 'Decay Series Activity Over Time',
                            color: textColor
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: `Time (${chartData.timeUnit})`,
                                color: textColor
                            },
                            ticks: { 
                                maxRotation: 0, 
                                autoSkip: true, 
                                autoSkipPadding: 20,
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            type: useLogScale ? 'logarithmic' : 'linear',
                            title: { 
                                display: true, 
                                text: `Activity (${useLogScale ? 'Log Scale' : 'Linear Scale'})`,
                                color: textColor
                            },
                            beginAtZero: !useLogScale,
                            min: useLogScale ? (Math.max(...chartData.datasets.flatMap(d => d.data)) > 0 ? 1e-9 : 0) : undefined,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
         }
         
         return () => {
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }
         };
         }, [chartData, useLogScale, theme]);
         
         const handleExport = () => {
         if (chartInstance.current) {
           const link = document.createElement('a');
           link.href = chartInstance.current.toBase64Image();
           link.download = 'decay-chart.png';
           link.click();
         }
         };
         
         return (
         <div className="mt-4">
           <div className="h-64">
               <canvas ref={chartRef}></canvas>
           </div>
           <div className="text-center mt-2">
               <button
                   onClick={handleExport}
                   className="px-3 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold"
               >
                   Export as PNG
               </button>
           </div>
         </div>
         );
         };
         
         /**
         * @description A combined calculator for mass-to-activity conversions and for calculating
         * specific activity from first principles.
         * @param {{radionuclides: Array<object>}} props
         */
         
const MassActivityModule = ({ radionuclides, selectedNuclide, setSelectedNuclide, mass, setMass, massUnit, setMassUnit, activity, setActivity, activityUnit, setActivityUnit, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const massUnits = { 'g': 1, 'mg': 1e-3, 'µg': 1e-6, 'kg': 1000 };
    const activityUnits = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'Ci': 3.7e10, 'mCi': 3.7e7, 'µCi': 3.7e4 };
    const nuclidesWithSA = React.useMemo(() => radionuclides.filter(r => r.specificActivity && r.halfLife !== 'Stable').sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    
    const handleNuclideSelect = React.useCallback((symbol) => {
    const nuclideToSet = nuclidesWithSA.find(n => n.symbol === symbol);
    setSelectedNuclide(nuclideToSet);
    setMass(''); setActivity(''); setError('');
    }, [nuclidesWithSA, setSelectedNuclide, setMass, setActivity, setError]);
    
    const calculateActivity = (massValue, newMassUnit, newActivityUnit) => {
    if (!selectedNuclide || isNaN(massValue) || massValue < 0) { setActivity(''); setError(''); return; }
    const saBqPerG = parseSpecificActivity(selectedNuclide.specificActivity);
    if (saBqPerG > 0) {
       const massInG = massValue * massUnits[newMassUnit];
       const activityInBq = massInG * saBqPerG;
       const finalActivity = activityInBq / activityUnits[newActivityUnit];
       setActivity(finalActivity.toPrecision(4));
       setError('');
    }
    };
    const calculateMass = (activityValue, newActivityUnit, newMassUnit) => {
    if (!selectedNuclide || isNaN(activityValue) || activityValue < 0) { setMass(''); setError(''); return; }
    const saBqPerG = parseSpecificActivity(selectedNuclide.specificActivity);
    if (saBqPerG > 0) {
       const activityInBq = activityValue * activityUnits[newActivityUnit];
       const massInG = activityInBq / saBqPerG;
       const finalMass = massInG / massUnits[newMassUnit];
       setMass(finalMass.toPrecision(4));
       setError('');
    }
    };
    
    const handleMassChange = (e) => { setMass(e.target.value); calculateActivity(parseFloat(e.target.value), massUnit, activityUnit); };
    const handleMassUnitChange = (e) => { setMassUnit(e.target.value); calculateActivity(parseFloat(mass), e.target.value, activityUnit); };
    const handleActivityChange = (e) => { setActivity(e.target.value); calculateMass(parseFloat(e.target.value), activityUnit, massUnit); };
    const handleActivityUnitChange = (e) => { setActivityUnit(e.target.value); calculateMass(parseFloat(activity), e.target.value, massUnit); };

    const handleSaveToHistory = () => {
        if (selectedNuclide && mass && activity) {
            addHistory({
                id: Date.now(),
                type: 'Mass ↔ Activity',
                icon: ICONS.mass,
                inputs: `${mass} ${massUnit} of ${selectedNuclide.symbol}`,
                result: `${activity} ${activityUnit}`,
                view: VIEWS.ACTIVITY_MASS
            });
            addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="min-h-[42px]">{selectedNuclide ? ( <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setSelectedNuclide(null)} /> ) : ( <SearchableSelect options={nuclidesWithSA} onSelect={handleNuclideSelect} placeholder="Search for a radionuclide..."/> )}</div>
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
           <label className="text-md font-semibold">Mass</label>
           <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
               <input type="number" placeholder="Enter Mass" value={mass} onChange={handleMassChange} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
               <select value={massUnit} onChange={handleMassUnitChange} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700">{massUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
           </div>
       </div>
       <div className="text-center text-2xl font-bold text-slate-400 dark:text-slate-500">↕</div>
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
           <label className="text-md font-semibold">Activity</label>
           <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
               <input type="number" placeholder="Enter Activity" value={activity} onChange={handleActivityChange} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
               <select value={activityUnit} onChange={handleActivityUnitChange} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
           </div>
       </div>
       {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}
       {selectedNuclide && mass && activity && (
           <div className="mt-4">
               <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition animate-fade-in">
                   Save to Calculations
               </button>
           </div>
       )}
    </div>
    );
};         
         /**
         * @description React component for calculating the specific activity of a pure radionuclide.
         * This calculator determines the activity per unit mass of a radioactive substance, a fundamental
         * quantity in health physics and radiochemistry.
         *
         * It uses the following formula, derived from the decay constant and Avogadro's number:
         *
         * $$SA = \frac{\ln(2) \cdot N_A}{t_{1/2} \cdot A}$$
         *
         * where:
         * **SA** = Specific Activity (Bq/g)
         * **$N_A$** = Avogadro's constant ($6.022 \times 10^{23}$ atoms/mol)
         * **$t_{1/2}$** = Half-life of the nuclide (in seconds)
         * **A** = Atomic weight of the nuclide (in g/mol)
         *
         * The component takes the atomic weight and half-life as inputs and outputs the specific activity
         * in both becquerels per gram (Bq/g) and curies per gram (Ci/g).
         *
         * @prop {string} atomicWeight - The atomic weight of the radionuclide.
         * @prop {function} setAtomicWeight - State setter for atomic weight.
         * @prop {string} halfLifeValue - The numeric value of the half-life.
         * @prop {function} setHalfLifeValue - State setter for half-life value.
         * @prop {string} halfLifeUnit - The unit of the half-life (e.g., 'years', 'days').
         * @prop {function} setHalfLifeUnit - State setter for half-life unit.
         * @prop {object} result - Object containing the calculated specific activity in Bq/g and Ci/g.
         * @prop {function} setResult - State setter for the result.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         

const SpecificActivityModule = ({ atomicWeight, setAtomicWeight, halfLifeValue, setHalfLifeValue, halfLifeUnit, setHalfLifeUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const unitMultipliers = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600, 'kiloyears': 31557600 * 1e3, 'megayears': 31557600 * 1e6, 'gigayears': 31557600 * 1e9 };
    
    React.useEffect(() => {
        localStorage.setItem('specActivity_atomicWeight', atomicWeight);
        localStorage.setItem('specActivity_halfLifeValue', halfLifeValue);
        localStorage.setItem('specActivity_halfLifeUnit', halfLifeUnit);
    }, [atomicWeight, halfLifeValue, halfLifeUnit]);
    
    React.useEffect(() => {
        const A = parseFloat(atomicWeight);
        const T_val = parseFloat(halfLifeValue);
        if (isNaN(A) || A <= 0 || isNaN(T_val) || T_val <= 0) {
           if (atomicWeight && halfLifeValue) setError('Atomic weight and half-life must be positive numbers.');
           setResult(null); return;
        }
        setError('');
        const T_seconds = T_val * unitMultipliers[halfLifeUnit];
        const lambda = Math.log(2) / T_seconds;
        const Na = 6.02214076e23;
        const sa_bq_per_g = (lambda * Na) / A;
        const sa_ci_per_g = sa_bq_per_g / 3.7e10;
        setResult({ bq: sa_bq_per_g.toPrecision(4), ci: sa_ci_per_g.toPrecision(4) });
    }, [atomicWeight, halfLifeValue, halfLifeUnit, setResult, setError]);

    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ 
               id: Date.now(), 
               type: 'Specific Activity', 
               icon: ICONS.specificActivity, 
               inputs: `A: ${atomicWeight}, T½: ${halfLifeValue} ${halfLifeUnit}`, 
               result: `${result.ci} Ci/g`, 
               view: VIEWS.ACTIVITY_MASS 
           });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
        <div className="space-y-4">
           <div>
               <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Atomic Weight (g/mol)</label>
               <input type="number" value={atomicWeight} onChange={e => setAtomicWeight(e.target.value)} placeholder="e.g., 60 for Co-60" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
           </div>
           <div>
               <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Half-life</label>
               <div className="flex gap-2 mt-1">
                   <input type="number" value={halfLifeValue} onChange={e => setHalfLifeValue(e.target.value)} placeholder="e.g., 5.27" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                   <select value={halfLifeUnit} onChange={e => setHalfLifeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700">{longTimeUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
               </div>
           </div>
           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
               <div className="flex justify-between items-center -mt-2 -mb-2">
                   <div></div> {/* Spacer */}
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Specific Activity</p>
                   <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} disabled={!result} className="p-2 text-slate-400 hover:text-sky-500 transition-colors disabled:opacity-30">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                   </Tooltip>
               </div>
               {result ? ( <> <p className="text-lg font-bold">{result.bq} Bq/g</p><p className="text-md font-medium text-slate-600 dark:text-slate-300">({result.ci} Ci/g)</p> </> ) : ( <p className="text-sm italic text-slate-400 dark:text-slate-500 mt-2">Enter values above to see the result.</p> )}
           </div>
        </div>
    );
};

const ActivityFromDoseRate = ({ radionuclides, nuclideSymbol, setNuclideSymbol, doseRate, setDoseRate, doseRateUnit, setDoseRateUnit, distance, setDistance, distanceUnit, setDistanceUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => gammaNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, gammaNuclides]);
    
    const doseRateFactors_R_hr = { 'µrem/hr': 1e-6, 'mrem/hr': 1e-3, 'rem/hr': 1, 'R/hr': 1, 'µSv/hr': 1e-4, 'mSv/hr': 0.1, 'Sv/hr': 100 };
    const distanceFactors_m = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };

    React.useEffect(() => {
        try {
            setError('');
            if (!selectedNuclide) {
                setResult(null);
                return;
            }
            const doseRateVal = parseFloat(doseRate);
            const distanceVal = parseFloat(distance);
            if (isNaN(doseRateVal) || isNaN(distanceVal) || doseRateVal <= 0 || distanceVal <= 0) {
                if (doseRate && distance) setError("Dose rate and distance must be positive numbers.");
                setResult(null);
                return;
            }

            const gammaConstant = parseFloat(selectedNuclide.gammaConstant);
            const doseRate_R_hr = doseRateVal * doseRateFactors_R_hr[doseRateUnit];
            const distance_m = distanceVal * distanceFactors_m[distanceUnit];

            const activity_Ci = (doseRate_R_hr * Math.pow(distance_m, 2)) / gammaConstant;
            
            setResult({
                activity: formatSensibleUnit(activity_Ci * 1e6, 'activity_µCi') // Using a custom sensible unit config for activity
            });
        } catch (e) {
            setError(e.message || "Calculation failed.");
            setResult(null);
        }
    }, [selectedNuclide, doseRate, doseRateUnit, distance, distanceUnit]);

    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
           addHistory({ id: Date.now(), type: 'Activity from Dose', icon: ICONS.activity, inputs: `${doseRate} ${doseRateUnit} @ ${distance} ${distanceUnit}`, result: `${result.activity.value} ${result.activity.unit} ${selectedNuclide.symbol}`, view: VIEWS.ACTIVITY_MASS });
           addToast("Calculation saved to history!");
        }
    };

    // Temporary addition to SENSIBLE_UNIT_CONFIG for local use.
    const tempSensibleUnitConfig = {
        ...SENSIBLE_UNIT_CONFIG,
        activity_µCi: {
            baseUnit: 'µCi',
            units: [
                { unit: 'nCi', threshold: 1, factor: 0.001 },
                { unit: 'µCi', threshold: 1000, factor: 1 },
                { unit: 'mCi', threshold: 1000, factor: 1000 },
                { unit: 'Ci',  threshold: Infinity, factor: 1e6 }
            ]
        }
    };
    const formatSensibleUnit = (value, unitType, precision = 3) => {
        const config = tempSensibleUnitConfig[unitType];
        if (!config) return { value: value.toPrecision(precision), unit: '' };
        for (const unitInfo of config.units) {
            if (Math.abs(value) < unitInfo.threshold) {
                const displayValue = value / unitInfo.factor;
                return { value: displayValue.toPrecision(precision), unit: unitInfo.unit };
            }
        }
        const largestUnit = config.units[config.units.length - 1];
        return { value: (value / largestUnit.factor).toPrecision(precision), unit: largestUnit.unit };
    };

    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates source activity from a gamma dose rate measurement.</p>
            <div>
                <label className="text-sm font-medium">Radionuclide</label>
                <div className="mt-1">
                    {selectedNuclide ? 
                        <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> :
                        <SearchableSelect options={gammaNuclides} onSelect={setNuclideSymbol} placeholder="Select a gamma emitter..." />
                    }
                </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium">Measured Dose Rate</label>
                    <div className="flex">
                        <input type="number" value={doseRate} onChange={e => setDoseRate(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                        <select value={doseRateUnit} onChange={e => setDoseRateUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{doseRateUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Distance from Source</label>
                    <div className="flex">
                        <input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                        <select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                    <div className="flex justify-between items-center -mb-2">
                        <div></div> {/* Spacer */}
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Source Activity</p>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    <div className="flex items-center justify-center">
                        <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.activity.value}</p>
                        <CopyButton textToCopy={result.activity.value} />
                    </div>
                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">{result.activity.unit}</p>
                </div>
            )}
        </div>
    );
};

         const ActivityAndMassTools = ({ radionuclides }) => {
             const MODE_MASS_ACTIVITY = 'massActivity';
             const MODE_SPECIFIC_ACTIVITY = 'specificActivity';
             const MODE_ACTIVITY_FROM_DOSE = 'activityFromDose'; // New Mode
         
             const [calcMode, setCalcMode] = React.useState(MODE_MASS_ACTIVITY);
             
             // State for MassActivityModule
             const [mass_selectedNuclide, setMass_selectedNuclide] = React.useState(() => { const savedSymbol = localStorage.getItem('massActivity_symbol'); if (!savedSymbol) return null; return radionuclides.find(n => n.symbol === savedSymbol) || null; });
             const [mass_mass, setMass_mass] = React.useState(() => localStorage.getItem('massActivity_mass') || '');
             const [mass_massUnit, setMass_massUnit] = React.useState(() => localStorage.getItem('massActivity_massUnit') || 'g');
             const [mass_activity, setMass_activity] = React.useState(() => localStorage.getItem('massActivity_activity') || '');
             const [mass_activityUnit, setMass_activityUnit] = React.useState(() => localStorage.getItem('massActivity_activityUnit') || 'Ci');
             const [mass_error, setMass_error] = React.useState('');
             
             // State for SpecificActivityModule
             const [spec_atomicWeight, setSpec_atomicWeight] = React.useState(() => localStorage.getItem('specActivity_atomicWeight') || '');
             const [spec_halfLifeValue, setSpec_halfLifeValue] = React.useState(() => localStorage.getItem('specActivity_halfLifeValue') || '');
             const [spec_halfLifeUnit, setSpec_halfLifeUnit] = React.useState(() => localStorage.getItem('specActivity_halfLifeUnit') || 'years');
             const [spec_result, setSpec_result] = React.useState(null);
             const [spec_error, setSpec_error] = React.useState('');

             // NEW: State for ActivityFromDoseRate calculator
             const [afd_nuclideSymbol, setAfd_nuclideSymbol] = React.useState('');
             const [afd_doseRate, setAfd_doseRate] = React.useState('10');
             const [afd_doseRateUnit, setAfd_doseRateUnit] = React.useState('mrem/hr');
             const [afd_distance, setAfd_distance] = React.useState('1');
             const [afd_distanceUnit, setAfd_distanceUnit] = React.useState('m');
             const [afd_result, setAfd_result] = React.useState(null);
             const [afd_error, setAfd_error] = React.useState('');
             
             const handleMassActivityClear = () => {
                 setMass_selectedNuclide(null); setMass_mass(''); setMass_massUnit('g');
                 setMass_activity(''); setMass_activityUnit('Ci'); setMass_error('');
             };
             const handleSpecificActivityClear = () => {
                 setSpec_atomicWeight(''); setSpec_halfLifeValue(''); setSpec_halfLifeUnit('years');
                 setSpec_result(null); setSpec_error('');
             };
             const handleActivityFromDoseClear = () => {
                 setAfd_nuclideSymbol(''); setAfd_doseRate('10'); setAfd_doseRateUnit('mrem/hr');
                 setAfd_distance('1'); setAfd_distanceUnit('m'); setAfd_result(null); setAfd_error('');
             };
             
             const handleClearActiveCalculator = () => {
                 if (calcMode === MODE_MASS_ACTIVITY) handleMassActivityClear();
                 else if (calcMode === MODE_SPECIFIC_ACTIVITY) handleSpecificActivityClear();
                 else handleActivityFromDoseClear();
             };
             
             return (
                 <div className="p-4 animate-fade-in">
                    <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white">Activity & Mass Tools</h2>
                            <ClearButton onClick={handleClearActiveCalculator} />
                        </div>
                        <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                            <button onClick={() => setCalcMode(MODE_MASS_ACTIVITY)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_MASS_ACTIVITY ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Mass ↔ Activity</button>
                            <button onClick={() => setCalcMode(MODE_ACTIVITY_FROM_DOSE)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_ACTIVITY_FROM_DOSE ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Act. from Dose</button>
                            <button onClick={() => setCalcMode(MODE_SPECIFIC_ACTIVITY)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_SPECIFIC_ACTIVITY ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Specific Activity</button>
                        </div>
                        {calcMode === MODE_MASS_ACTIVITY && 
                            <MassActivityModule 
                                radionuclides={radionuclides}
                                selectedNuclide={mass_selectedNuclide} setSelectedNuclide={setMass_selectedNuclide}
                                mass={mass_mass} setMass={setMass_mass}
                                massUnit={mass_massUnit} setMassUnit={setMass_massUnit}
                                activity={mass_activity} setActivity={setMass_activity}
                                activityUnit={mass_activityUnit} setActivityUnit={setMass_activityUnit}
                                error={mass_error} setError={setMass_error}
                            />
                        }
                        {calcMode === MODE_ACTIVITY_FROM_DOSE &&
                            <ActivityFromDoseRate
                                radionuclides={radionuclides}
                                nuclideSymbol={afd_nuclideSymbol} setNuclideSymbol={setAfd_nuclideSymbol}
                                doseRate={afd_doseRate} setDoseRate={setAfd_doseRate}
                                doseRateUnit={afd_doseRateUnit} setDoseRateUnit={setAfd_doseRateUnit}
                                distance={afd_distance} setDistance={setAfd_distance}
                                distanceUnit={afd_distanceUnit} setDistanceUnit={setAfd_distanceUnit}
                                result={afd_result} setResult={setAfd_result}
                                error={afd_error} setError={setAfd_error}
                            />
                        }
                        {calcMode === MODE_SPECIFIC_ACTIVITY && 
                            <SpecificActivityModule 
                                atomicWeight={spec_atomicWeight} setAtomicWeight={setSpec_atomicWeight}
                                halfLifeValue={spec_halfLifeValue} setHalfLifeValue={setSpec_halfLifeValue}
                                halfLifeUnit={spec_halfLifeUnit} setHalfLifeUnit={setSpec_halfLifeUnit}
                                result={spec_result} setResult={setSpec_result}
                                error={spec_error} setError={setSpec_error}
                            />
                        }
                    </div>
                 </div>
             );
         };
         
         /**
         * @description A calculator to determine the activities of a parent-daughter pair over time,
         * and to analyze the type of equilibrium present based on their half-lives.
         * @param {{radionuclides: Array<object>}} props
         */
         
const EquilibriumCalculator = ({ radionuclides, theme }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast(); // Added for the save confirmation toast

    const [parentNuclide, setParentNuclide] = React.useState(() => {
    const savedSymbol = localStorage.getItem('equilibrium_parentSymbol');
    if (!savedSymbol) return null;
    return radionuclides.find(n => n.symbol === savedSymbol) || null;
    });
    const [daughterNuclide, setDaughterNuclide] = React.useState(null);
    const [initialActivity, setInitialActivity] = React.useState(() => localStorage.getItem('equilibrium_initialActivity') || '100');
    const [initialDaughterActivity, setInitialDaughterActivity] = React.useState(() => localStorage.getItem('equilibrium_initialDaughterActivity') || '0');
    const [timeElapsed, setTimeElapsed] = React.useState(() => localStorage.getItem('equilibrium_timeElapsed') || '10');
    const [timeUnit, setTimeUnit] = React.useState(() => localStorage.getItem('equilibrium_timeUnit') || 'days');
    const [result, setResult] = React.useState(null);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');
    const [analysis, setAnalysis] = React.useState(null);
    const [useLogScale, setUseLogScale] = React.useState(() => JSON.parse(localStorage.getItem('equilibrium_useLogScale')) || false);
    
    React.useEffect(() => {
    localStorage.setItem('equilibrium_parentSymbol', parentNuclide ? parentNuclide.symbol : '');
    localStorage.setItem('equilibrium_initialActivity', initialActivity);
    localStorage.setItem('equilibrium_initialDaughterActivity', initialDaughterActivity);
    localStorage.setItem('equilibrium_timeElapsed', timeElapsed);
    localStorage.setItem('equilibrium_timeUnit', timeUnit);
    localStorage.setItem('equilibrium_useLogScale', JSON.stringify(useLogScale));
    }, [parentNuclide, initialActivity, initialDaughterActivity, timeElapsed, timeUnit, useLogScale]);
    
    const parentNuclides = React.useMemo(() => {
    return radionuclides.filter(parent => {
       if (!parent.daughter || parent.halfLife === 'Stable' || parent.daughter.includes('/')) return false;
       const daughterName = parent.daughter.split('(')[0].trim();
       const daughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
       return daughter && daughter.halfLife !== 'Stable';
    }).sort((a, b) => a.name.localeCompare(b.name));
    }, [radionuclides]);
    
    React.useEffect(() => {
    if (!parentNuclide) {
       setAnalysis(null);
       setDaughterNuclide(null);
       return;
    }
    const daughterName = parentNuclide.daughter.split('(')[0].trim();
    const foundDaughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
    if (!foundDaughter) {
       setAnalysis({ type: 'Analysis Error', message: 'Daughter nuclide data not found.' });
       setDaughterNuclide(null);
       return;
    }
    setDaughterNuclide(foundDaughter);
    const T1_seconds = parseHalfLifeToSeconds(parentNuclide.halfLife);
    const T2_seconds = parseHalfLifeToSeconds(foundDaughter.halfLife);
    let type, message, ratio = null, timeToEq = null, timeToMax = null;
    if (T1_seconds < T2_seconds) {
       type = 'No Equilibrium';
       message = `The parent half-life (${parentNuclide.halfLife}) is shorter than the daughter half-life (${foundDaughter.halfLife}). The daughter will never reach equilibrium.`;
    } else if (T1_seconds > 100 * T2_seconds) {
       type = 'Secular Equilibrium';
       ratio = 1;
       timeToEq = (7 * T2_seconds);
       message = `The parent half-life is much longer than the daughter's. The daughter activity will rise to become equal to the parent's activity.`;
    } else {
       type = 'Transient Equilibrium';
       const lambda1 = Math.log(2) / T1_seconds;
       const lambda2 = Math.log(2) / T2_seconds;
       ratio = lambda2 / (lambda2 - lambda1);
       timeToEq = (7 * T2_seconds);
       timeToMax = Math.log(lambda2 / lambda1) / (lambda2 - lambda1);
       message = `The parent decays at a rate comparable to the daughter. The daughter's activity will rise, exceed the parent's, and then decay with the parent's apparent half-life.`;
    }
    setAnalysis({ type, message, ratio, timeToEq, timeToMax });
    if (timeToEq) {
       const bestUnit = getBestHalfLifeUnit(timeToEq);
       const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
       setTimeUnit(bestUnit);
       setTimeElapsed(Math.ceil(timeToEq / unitConversions[bestUnit]).toString());
    }
    }, [parentNuclide, radionuclides]);
    
    const handleCalculate = () => {
    if (!parentNuclide || !daughterNuclide) { setError('Please select a valid parent nuclide.'); return; }
    const N0_parent = parseFloat(initialActivity);
    const N0_daughter = parseFloat(initialDaughterActivity);
    const t_input = parseFloat(timeElapsed);
    if (isNaN(N0_parent) || N0_parent < 0 || isNaN(t_input) || t_input < 0 || isNaN(N0_daughter) || N0_daughter < 0) { setError('All activity and time inputs must be non-negative numbers.'); return; }
    setError('');
    const T1_seconds = parseHalfLifeToSeconds(parentNuclide.halfLife);
    const T2_seconds = parseHalfLifeToSeconds(daughterNuclide.halfLife);
    const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
    const t_seconds = t_input * unitConversions[timeUnit];
    const lambda1 = Math.log(2) / T1_seconds;
    const lambda2 = Math.log(2) / T2_seconds;
    const A_parent = N0_parent * Math.exp(-lambda1 * t_seconds);
    const initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * t_seconds);
    let daughterIngrowth;
    if (Math.abs(lambda1 - lambda2) < 1e-12) { daughterIngrowth = N0_parent * lambda1 * t_seconds * Math.exp(-lambda1 * t_seconds); } 
    else { daughterIngrowth = (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * t_seconds) - Math.exp(-lambda2 * t_seconds)); }
    const A_daughter = initialDaughterDecay + daughterIngrowth;
    const newResult = { parent: { name: parentNuclide.name, activity: A_parent.toPrecision(4) }, daughter: { name: daughterNuclide.name, activity: A_daughter.toPrecision(4) } };
    setResult(newResult);
    // REMOVED addHistory call from here
    const labels = [], parentData = [], daughterData = [], ratioData = [];
    const totalTime = t_input;
    const steps = 100;
    for (let i = 0; i <= steps; i++) {
       const timePoint = (totalTime / steps) * i;
       const timePoint_seconds = timePoint * unitConversions[timeUnit];
       labels.push(timePoint.toFixed(2));
       const current_A_parent = N0_parent * Math.exp(-lambda1 * timePoint_seconds);
       parentData.push(current_A_parent);
       const current_initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * timePoint_seconds);
       let current_daughterIngrowth;
       if (Math.abs(lambda1 - lambda2) < 1e-12) { current_daughterIngrowth = N0_parent * lambda1 * timePoint_seconds * Math.exp(-lambda1 * timePoint_seconds); } 
       else { current_daughterIngrowth = (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * timePoint_seconds) - Math.exp(-lambda2 * timePoint_seconds)); }
       const d_activity = current_initialDaughterDecay + current_daughterIngrowth;
       daughterData.push(d_activity);
       ratioData.push(current_A_parent > 1e-9 ? d_activity / current_A_parent : 0);
    }
    setChartData({ labels, parentData, daughterData, ratioData, parentName: parentNuclide.name, daughterName: daughterNuclide.name, timeUnit });
    };

    // ADDED this new function to handle saving
    const handleSaveToHistory = () => {
        if (result && parentNuclide) {
            addHistory({ 
                id: Date.now(), 
                type: 'Equilibrium', 
                icon: ICONS.activity, 
                inputs: `${initialActivity} of ${parentNuclide.symbol} for ${timeElapsed} ${timeUnit}`, 
                result: `Daughter: ${result.daughter.activity}`, 
                view: VIEWS.EQUILIBRIUM 
            });
            addToast("Calculation saved to history!");
        }
    };
    
    React.useEffect(() => {
    if (parentNuclide && daughterNuclide) { handleCalculate(); }
    }, [parentNuclide, daughterNuclide, initialActivity, initialDaughterActivity, timeElapsed, timeUnit]);
    
    const handleParentChange = (symbol) => {
    const parent = parentNuclides.find(p => p.symbol === symbol);
    setResult(null); setChartData(null); setError(''); setParentNuclide(parent || null);
    };
    
    const handleClearInputs = () => {
    setParentNuclide(null);
    setDaughterNuclide(null);
    setInitialActivity('100');
    setInitialDaughterActivity('0');
    setTimeElapsed('10');
    setTimeUnit('days');
    setResult(null);
    setChartData(null);
    setError('');
    setAnalysis(null);
    setUseLogScale(false);
    };
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Parent-Daughter Equilibrium Analyzer</h2>
               <ClearButton onClick={handleClearInputs} />
           </div>
           <div className="space-y-4">
               <div>
                   <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Parent Nuclide</label>
                   <div className="mt-1 min-h-[42px]">
                       {parentNuclide ? 
                          <CalculatorNuclideInfo 
                              nuclide={parentNuclide} 
                              onClear={() => setParentNuclide(null)} 
                          /> 
                       : <SearchableSelect options={parentNuclides} onSelect={handleParentChange} placeholder="Search for a parent nuclide..."/>}
                   </div>
               </div>
               {analysis && (
                   <div className="p-4 bg-slate-100 dark:bg-slate-700/80 rounded-lg animate-fade-in border border-slate-200 dark:border-slate-600">
                        <h3 className="text-lg font-bold text-sky-600 dark:text-sky-400 mb-2">{analysis.type}</h3>
                       <p className="text-sm text-slate-600 dark:text-slate-300 mb-3">{analysis.message}</p>
                       {analysis.ratio && (
                           <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm border-t border-slate-300 dark:border-slate-600 pt-3">
                               <div><p className="font-semibold">Equilibrium Ratio (A₂/A₁):</p><p>{analysis.ratio.toFixed(4)}</p></div>
                               <div><p className="font-semibold">Time to ~Equilibrium:</p><p>≈ {formatHalfLife(analysis.timeToEq.toString() + ' seconds', getBestHalfLifeUnit(analysis.timeToEq))}</p></div>
                               {analysis.timeToMax && ( <div className="col-span-1 sm:col-span-2"><p className="font-semibold">Time to Max Daughter Activity:</p><p>{formatHalfLife(analysis.timeToMax.toString() + ' seconds', getBestHalfLifeUnit(analysis.timeToMax))}</p></div> )}
                           </div>
                       )}
                   </div>
               )}
               {parentNuclide && (
                   <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><label className="block text-sm font-medium">Initial Parent Activity</label><input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full p-2 mt-1 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                           <div><label className="block text-sm font-medium">Initial Daughter Activity</label><input type="number" value={initialDaughterActivity} onChange={e => setInitialDaughterActivity(e.target.value)} className="w-full p-2 mt-1 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                       </div>
                        <div>
                           <label className="block text-sm font-medium">Time Elapsed</label>
                           <div className="flex gap-2 mt-1">
                               <input type="number" value={timeElapsed} onChange={e => setTimeElapsed(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                               <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700">{timeUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select>
                           </div>
                       </div>
                   </div>
               )}
               {error && <p className="text-red-500 text-sm text-center">{error}</p>}
               {result && (
                   <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg space-y-2">
                       <div className="flex justify-between items-center">
                           <p className="font-semibold text-center text-sm flex-grow">Activity at {timeElapsed} {timeUnit}</p>
                           {/* ADDED the save button */}
                           <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                               <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors -mr-2">
                                   <Icon path={ICONS.notepad} className="w-5 h-5" />
                               </button>
                           </Tooltip>
                       </div>
                       <div className="flex justify-between items-center">
                           <p>{result.parent.name}:</p>
                           <div className="flex items-center">
                               <p className="font-bold">{result.parent.activity}</p>
                               <CopyButton textToCopy={result.parent.activity} />
                           </div>
                       </div>
                       <div className="flex justify-between items-center">
                           <p>{result.daughter.name}:</p>
                           <div className="flex items-center">
                               <p className="font-bold">{result.daughter.activity}</p>
                               <CopyButton textToCopy={result.daughter.activity} />
                           </div>
                       </div>
                   </div>
               )}
               {chartData && (
                   <>
                       <div className="flex justify-end mt-4">
                           <label className="flex items-center gap-2 text-sm cursor-pointer">
                               <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" />
                               Use Logarithmic Scale
                           </label>
                       </div>
                       <DecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} />
                   </>
               )}
           </div>
       </div>
    </div>
    );
};    
         
         /**
         * @description React component for a Kusnetz Method calculator. This tool is used in
         * radiation protection to quickly estimate the **Working Level (WL)** of radon progeny
         * (radium A, B, and C) in the air.
         *
         * The method relies on a relationship between the alpha activity of a sample collected on
         * a filter and the equilibrium concentration of the radon progeny. It uses a specific
         * "Kusnetz factor" (K) that accounts for the decay of the progeny during a fixed
         * counting delay period (40 to 90 minutes).
         *
         * The core calculation is:
         * $$WL = \frac{C_{net}}{K \cdot \epsilon \cdot V_{total}}$$
         *
         * where:
         * **WL** = Working Level
         * **$C_{net}$** = Net counts per minute of the filter
         * **K** = Kusnetz factor (based on the delay time)
         * **$\epsilon$** = Detector efficiency
         * **$V_{total}$** = Total volume of air sampled
         *
         * The component calculates the total air volume and net counts per minute from user inputs,
         * interpolates the correct Kusnetz factor, and provides the final Working Level value.
         *
         * @prop {string} flowRate - The flow rate of the air sampling pump (LPM).
         * @prop {function} setFlowRate - State setter for flow rate.
         * @prop {string} sampleTime - The duration of the air sampling (minutes).
         * @prop {function} setSampleTime - State setter for sample time.
         * @prop {string} delayTime - The time from end of sampling to start of counting (minutes).
         * @prop {function} setDelayTime - State setter for delay time.
         * @prop {string} grossCounts - The total counts observed on the filter.
         * @prop {function} setGrossCounts - State setter for gross counts.
         * @prop {string} countDuration - The duration of the count (minutes).
         * @prop {function} setCountDuration - State setter for count duration.
         * @prop {string} backgroundCpm - The background counts per minute of the detector.
         * @prop {function} setBackgroundCpm - State setter for background cpm.
         * @prop {string} efficiency - The alpha detector's efficiency (%).
         * @prop {function} setEfficiency - State setter for efficiency.
         * @prop {object} result - Object containing the calculated WL and intermediate values.
         * @prop {function} setResult - State setter for the result.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         
const KusnetzCalculator = ({ flowRate, setFlowRate, sampleTime, setSampleTime, delayTime, setDelayTime, grossCounts, setGrossCounts, countDuration, setCountDuration, backgroundCpm, setBackgroundCpm, efficiency, setEfficiency, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const KUSNETZ_FACTORS = { 40: 150, 45: 138, 50: 128, 55: 119, 60: 112, 65: 105, 70: 100, 75: 95, 80: 90, 85: 86, 90: 82 };
    
    React.useEffect(() => {
    localStorage.setItem('kusnetz_flowRate', flowRate); localStorage.setItem('kusnetz_sampleTime', sampleTime); localStorage.setItem('kusnetz_delayTime', delayTime);
    localStorage.setItem('kusnetz_grossCounts', grossCounts); localStorage.setItem('kusnetz_countDuration', countDuration);
    localStorage.setItem('kusnetz_backgroundCpm', backgroundCpm); localStorage.setItem('kusnetz_efficiency', efficiency);
    }, [flowRate, sampleTime, delayTime, grossCounts, countDuration, backgroundCpm, efficiency]);
    
    const interpolate = (x, points) => {
    const keys = Object.keys(points).map(Number).sort((a, b) => a - b);
    if (x <= keys[0]) return points[keys[0]]; if (x >= keys[keys.length - 1]) return points[keys[keys.length - 1]];
    const x1 = Math.max(...keys.filter(k => k <= x)); const x2 = Math.min(...keys.filter(k => k > x));
    const y1 = points[x1]; const y2 = points[x2];
    return y1 + (y2 - y1) * (x - x1) / (x2 - x1);
    };
    
    React.useEffect(() => {
    try {
       setError('');
       const params = { V_flow: parseFloat(flowRate), T_sample: parseFloat(sampleTime), T_delay: parseFloat(delayTime), C_gross: parseFloat(grossCounts), T_count: parseFloat(countDuration), cpm_bkg: parseFloat(backgroundCpm), eff: parseFloat(efficiency) };
       if (Object.values(params).some(isNaN) || params.V_flow <= 0 || params.T_sample <= 0 || params.T_delay < 40 || params.eff <= 0) {
           if (Object.values(params).every(p => p || p === 0)) setError("Please enter valid positive numbers. Delay time must be ≥ 40 min.");
           setResult(null); return;
       }
       const totalVolume_L = params.V_flow * params.T_sample;
       const gross_cpm = params.C_gross / params.T_count;
       const net_cpm = gross_cpm - params.cpm_bkg;
       const k_factor = interpolate(params.T_delay, KUSNETZ_FACTORS);
       const workingLevel = net_cpm / (k_factor * (params.eff / 100) * totalVolume_L);
       setResult({ workingLevel: workingLevel.toPrecision(3), k_factor: k_factor.toFixed(1), totalVolume_L: totalVolume_L.toPrecision(3), net_cpm: net_cpm.toPrecision(3) });
    } catch (e) { setError("Calculation error."); setResult(null); }
    }, [flowRate, sampleTime, delayTime, grossCounts, countDuration, backgroundCpm, efficiency, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Kusnetz Method (WL)', icon: ICONS.radon, inputs: `Delay: ${delayTime} min, Vol: ${result.totalVolume_L} L`, result: `${result.workingLevel} WL`, view: VIEWS.RADON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <p className="text-sm text-slate-600 dark:text-slate-400">Determine the Working Level (WL) of radon progeny.</p>
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div className="grid grid-cols-2 gap-4">
               <div><label className="block text-sm font-medium">Flow Rate (LPM)</label><input type="number" value={flowRate} onChange={e => setFlowRate(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
               <div><label className="block text-sm font-medium">Sample Time (min)</label><input type="number" value={sampleTime} onChange={e => setSampleTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
               <div><label className="block text-sm font-medium">Gross Counts</label><input type="number" value={grossCounts} onChange={e => setGrossCounts(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
               <div><label className="block text-sm font-medium">Count Duration (min)</label><input type="number" value={countDuration} onChange={e => setCountDuration(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
               <div><label className="block text-sm font-medium">Background (cpm)</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
               <div><label className="block text-sm font-medium">Alpha Efficiency (%)</label><input type="number" value={efficiency} onChange={e => setEfficiency(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
           </div>
           <div><Tooltip text="Time between end-of-sampling and start-of-count. Must be between 40 and 90 minutes for standard method."><label className="block text-sm font-medium">Delay Time (minutes)</label></Tooltip><input type="number" value={delayTime} onChange={e => setDelayTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in space-y-3">
               <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                   <span className="font-semibold text-slate-600 dark:text-slate-300">Net Count Rate:</span><span className="font-mono text-right">{result.net_cpm} cpm</span>
                   <span className="font-semibold text-slate-600 dark:text-slate-300">Total Air Volume:</span><span className="font-mono text-right">{result.totalVolume_L} L</span>
                   <span className="font-semibold text-slate-600 dark:text-slate-300">Interpolated K Factor:</span><span className="font-mono text-right">{result.k_factor}</span>
               </div>
               <div className="text-center pt-3 border-t border-slate-300 dark:border-slate-600">
                   <div className="flex justify-between items-center -mt-2 -mb-2">
                       <div></div> {/* Spacer */}
                       <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Progeny Concentration</p>
                       <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                          <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                              <Icon path={ICONS.notepad} className="w-5 h-5" />
                          </button>
                       </Tooltip>
                   </div>
                   <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.workingLevel}</p>
                   <p className="text-md font-medium text-slate-600 dark:text-slate-300">Working Levels (WL)</p>
               </div>
           </div>
       )}
    </div>
    );
};
         
         /**
         * @description React component for a radon concentration-to-dose calculator and interconversion tool.
         * This tool allows users to convert between various units of radon concentration and to estimate
         * the annual dose received from a given exposure.
         *
         * It provides four different calculation modes:
         * 1.  **Dose from Concentration:** Estimates the annual dose based on radon concentration, equilibrium factor, and occupancy factor.
         * 2.  **Find Working Level (WL):** Calculates the Working Level from a given radon concentration and equilibrium factor.
         * 3.  **Find Concentration:** Calculates the radon concentration needed to produce a given Working Level, for a specified equilibrium factor.
         * 4.  **Find Equilibrium Factor:** Calculates the equilibrium factor based on a known concentration and Working Level.
         *
         * The module handles conversions between common units like **picocuries per liter (pCi/L)** and **becquerels per cubic meter (Bq/m³)**,
         * as well as the conversion to **Potential Alpha Energy Concentration (PAEC)** and finally to **Working Level Months (WLM)** and dose.
         *
         * @prop {string} calcMode - The active calculation mode ('doseFromConc', 'findWL', 'findConc', 'findEF').
         * @prop {function} setCalcMode - State setter for the calculation mode.
         * @prop {string} concentration - The radon concentration value.
         * @prop {function} setConcentration - State setter for concentration.
         * @prop {string} unit - The unit of concentration ('pCi/L' or 'Bq/m³').
         * @prop {function} setUnit - State setter for the unit.
         * @prop {string} equilibriumFactor - The equilibrium factor (F).
         * @prop {function} setEquilibriumFactor - State setter for the equilibrium factor.
         * @prop {string} workingLevel - The Working Level (WL) value.
         * @prop {function} setWorkingLevel - State setter for Working Level.
         * @prop {string} occupancyFactor - The occupancy factor.
         * @prop {function} setOccupancyFactor - State setter for the occupancy factor.
         * @prop {object} result - Object containing all calculated results.
         * @prop {function} setResult - State setter for the result object.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         
const ConcentrationDoseModule = ({ calcMode, setCalcMode, concentration, setConcentration, unit, setUnit, equilibriumFactor, setEquilibriumFactor, workingLevel, setWorkingLevel, occupancyFactor, setOccupancyFactor, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const Bq_per_m3_in_pCi_per_L = 37; const PAEC_J_per_m3_in_WL = 2.08e-5; const dose_conversion_mrem_per_WLM = 500;
    
    React.useEffect(() => {
    localStorage.setItem('radon_calcMode', calcMode); localStorage.setItem('radon_concentration', concentration); localStorage.setItem('radon_unit', unit);
    localStorage.setItem('radon_equilibriumFactor', equilibriumFactor); localStorage.setItem('radon_workingLevel', workingLevel); localStorage.setItem('radon_occupancyFactor', occupancyFactor);
    }, [calcMode, concentration, unit, equilibriumFactor, workingLevel, occupancyFactor]);
    
    React.useEffect(() => {
    try {
       setError('');
       const conc_val = parseFloat(concentration); const ef_val = parseFloat(equilibriumFactor); const wl_val = parseFloat(workingLevel); const of_val = parseFloat(occupancyFactor);
       let final_pCi_L, final_Bq_m3, final_WL, final_EF;
       switch(calcMode) {
           case 'doseFromConc':
               if (isNaN(conc_val) || isNaN(ef_val)) throw new Error('Concentration and Equilibrium Factor must be numbers.');
               final_pCi_L = unit === 'pCi/L' ? conc_val : conc_val / Bq_per_m3_in_pCi_per_L; final_EF = ef_val;
               final_WL = (final_pCi_L / 100) * final_EF; break;
           case 'findWL':
               if (isNaN(conc_val) || isNaN(ef_val)) throw new Error('Concentration and Equilibrium Factor must be numbers.');
               final_pCi_L = unit === 'pCi/L' ? conc_val : conc_val / Bq_per_m3_in_pCi_per_L; final_EF = ef_val;
               final_WL = (final_pCi_L / 100) * final_EF; setWorkingLevel(final_WL.toPrecision(3)); break;
           case 'findConc':
               if (isNaN(wl_val) || isNaN(ef_val)) throw new Error('Working Level and Equilibrium Factor must be numbers.');
               if (ef_val <= 0) throw new Error('Equilibrium Factor must be greater than zero.');
               final_WL = wl_val; final_EF = ef_val; final_pCi_L = (final_WL * 100) / final_EF;
               const final_conc_display = unit === 'pCi/L' ? final_pCi_L : final_pCi_L * Bq_per_m3_in_pCi_per_L;
               setConcentration(final_conc_display.toPrecision(3)); break;
           case 'findEF':
                if (isNaN(wl_val) || isNaN(conc_val)) throw new Error('Working Level and Concentration must be numbers.');
                final_pCi_L = unit === 'pCi/L' ? conc_val : conc_val / Bq_per_m3_in_pCi_per_L;
                if (final_pCi_L <= 0) throw new Error('Concentration must be greater than zero.');
                final_WL = wl_val; final_EF = (final_WL * 100) / final_pCi_L;
                setEquilibriumFactor(final_EF.toPrecision(3)); break;
       }
       if (isNaN(of_val)) throw new Error('Occupancy Factor must be a number.');
       final_Bq_m3 = final_pCi_L * Bq_per_m3_in_pCi_per_L;
       const paec_J_m3 = final_WL * PAEC_J_per_m3_in_WL; const wlm_per_year = final_WL * (8760 * of_val) / 170;
       const annualDose_mrem = wlm_per_year * dose_conversion_mrem_per_WLM;
       setResult({ pCi_L: final_pCi_L.toPrecision(3), Bq_m3: final_Bq_m3.toPrecision(3), workingLevels: final_WL.toPrecision(3), equilibriumFactor: final_EF.toPrecision(3), paec_J_m3: paec_J_m3.toExponential(2), wlm_year: wlm_per_year.toPrecision(3), annualDose: formatSensibleUnit(annualDose_mrem, 'dose') });
    } catch (e) { setError(e.message); setResult(null); }
    }, [concentration, unit, equilibriumFactor, workingLevel, occupancyFactor, calcMode, setConcentration, setEquilibriumFactor, setWorkingLevel, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Radon Dose', icon: ICONS.radon, inputs: `${result.pCi_L} pCi/L, F=${result.equilibriumFactor}`, result: `${result.annualDose.value} ${result.annualDose.unit}/yr`, view: VIEWS.RADON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
           <button onClick={() => setCalcMode('doseFromConc')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'doseFromConc' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dose from Conc.</button>
           <button onClick={() => setCalcMode('findWL')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findWL' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find WL</button>
           <button onClick={() => setCalcMode('findConc')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findConc' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find Concentration</button>
           <button onClick={() => setCalcMode('findEF')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findEF' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find Equilibrium</button>
       </div>
       <div className="space-y-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
           <div><label className="block text-sm font-medium">Radon Concentration</label><div className="flex"><input type="number" value={concentration} onChange={e => setConcentration(e.target.value)} disabled={calcMode === 'findConc'} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700 disabled:bg-slate-200 dark:disabled:bg-slate-800" /><select value={unit} onChange={e => setUnit(e.target.value)} disabled={calcMode === 'findConc'} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 disabled:opacity-50"><option>pCi/L</option><option>Bq/m³</option></select></div></div>
           <div><Tooltip text="The fraction of radon progeny in equilibrium with the parent radon gas. 0.4 is a standard assumption for homes."><label className="block text-sm font-medium">Equilibrium Factor (F)</label></Tooltip><input type="number" value={equilibriumFactor} onChange={e => setEquilibriumFactor(e.target.value)} step="0.05" min="0" max="1" disabled={calcMode === 'findEF'} placeholder="e.g., 0.4" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 disabled:bg-slate-200 dark:disabled:bg-slate-800" /></div>
           <div><label className="block text-sm font-medium">Working Level (WL)</label><input type="number" value={workingLevel} onChange={e => setWorkingLevel(e.target.value)} disabled={calcMode === 'findWL' || calcMode === 'doseFromConc'} placeholder="e.g., 0.02" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 disabled:bg-slate-200 dark:disabled:bg-slate-800" /></div>
       </div>
       {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
       {result && (
           <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 animate-fade-in">
               <h3 className="text-lg font-bold text-center text-slate-700 dark:text-slate-200 mb-2">Calculation Results</h3>
               <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                   <span className="font-semibold text-slate-500 dark:text-slate-400">Radon Concentration:</span><p className="font-mono text-right">{result.pCi_L} pCi/L ({result.Bq_m3} Bq/m³)</p>
                   <span className="font-semibold text-slate-500 dark:text-slate-400">Equilibrium Factor:</span><p className="font-mono text-right">{result.equilibriumFactor}</p>
                   <span className="font-semibold text-slate-500 dark:text-slate-400">Working Level (WL):</span><p className="font-mono text-right">{result.workingLevels}</p>
                   <span className="font-semibold text-slate-500 dark:text-slate-400">PAEC:</span><p className="font-mono text-right">{result.paec_J_m3} J/m³</p>
               </div>
               <div className="border-t border-slate-300 dark:border-slate-600 pt-3 mt-3">
                    <div className="flex justify-between items-center -mb-2">
                       <div className="flex-grow text-center">
                           <label className="block text-sm font-medium mb-2">Annual Dose Estimation</label>
                       </div>
                       <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                          <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors -mr-2">
                              <Icon path={ICONS.notepad} className="w-5 h-5" />
                          </button>
                       </Tooltip>
                   </div>
                   <div className="flex justify-center items-center"><label className="text-sm">Occupancy:</label><input type="number" value={occupancyFactor} onChange={e => setOccupancyFactor(e.target.value)} step="0.05" min="0" max="1" className="w-20 mx-2 p-1 rounded-md bg-white dark:bg-slate-800 text-center" /></div>
                   <div className="text-center mt-2">
                       <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Estimated Annual Dose</p>
                       <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.annualDose.value} <span className="text-2xl opacity-75">{result.annualDose.unit}</span></p>
                       <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">({result.wlm_year} WLM/year)</p>
                   </div>
               </div>
           </div>
       )}
    </div>
    );
};

         
         /**
         * @description React component that serves as a container for two radon-related calculation tools.
         * It provides a tabbed interface for users to switch between the two functionalities:
         * 1.  **Concentration & Dose:** Converts between different units of radon concentration and estimates the annual radiation dose from radon exposure.
         * 2.  **Kusnetz Method:** Calculates the Working Level (WL) of radon progeny from air sampling and counting data.
         *
         * This component manages the state for both sub-calculators, ensuring their inputs and outputs are isolated
         * while being accessible through a unified interface. It also includes functions to reset the inputs
         * of the currently active calculator.
         */
         
const RadonIngrowthCalculator = ({ result, setResult, error, setError, ra226Mass, setRa226Mass, massUnit, setMassUnit, time, setTime, timeUnit, setTimeUnit }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const RA226_SPECIFIC_ACTIVITY_BQ_PER_G = 3.7e10; // By definition of the Curie, for 1g Ra-226
    const RN222_HALFLIFE_SECONDS = 3.823 * 24 * 3600;
    const RN222_LAMBDA_PER_SECOND = Math.log(2) / RN222_HALFLIFE_SECONDS;

    const massUnits = { 'ng': 1e-9, 'µg': 1e-6, 'mg': 1e-3, 'g': 1 };
    const timeUnits = { 'minutes': 60, 'hours': 3600, 'days': 86400, 'weeks': 604800 };

    React.useEffect(() => {
        try {
            setError('');
            const mass_g = parseFloat(ra226Mass) * (massUnits[massUnit] || 0);
            const time_s = parseFloat(time) * (timeUnits[timeUnit] || 0);

            if (isNaN(mass_g) || isNaN(time_s) || mass_g <= 0 || time_s < 0) {
                if (ra226Mass && time) setError("Mass and time must be positive numbers.");
                setResult(null);
                return;
            }

            const ra226_activity_Bq = mass_g * RA226_SPECIFIC_ACTIVITY_BQ_PER_G;
            const rn222_activity_Bq = ra226_activity_Bq * (1 - Math.exp(-RN222_LAMBDA_PER_SECOND * time_s));
            const percentEquilibrium = (rn222_activity_Bq / ra226_activity_Bq) * 100;

            setResult({
                ra226_activity: formatSensibleUnit(ra226_activity_Bq / 3.7e4, 'activity'), // Convert to µCi for sensible unit formatting
                rn222_activity: formatSensibleUnit(rn222_activity_Bq / 3.7e4, 'activity'),
                percentEquilibrium: percentEquilibrium.toFixed(2)
            });
        } catch (e) {
            setError(e.message || "Calculation failed.");
            setResult(null);
        }
    }, [ra226Mass, massUnit, time, timeUnit]);

    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Radon Ingrowth', icon: ICONS.radon, inputs: `${ra226Mass} ${massUnit} Ra-226 for ${time} ${timeUnit}`, result: `${result.rn222_activity.value} ${result.rn222_activity.unit} Rn-222`, view: VIEWS.RADON });
           addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates the Rn-222 activity from a given mass of Ra-226 over time.</p>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div>
                    <label className="block text-sm font-medium">Mass of Ra-226</label>
                    <div className="flex">
                        <input type="number" value={ra226Mass} onChange={e => setRa226Mass(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                        <select value={massUnit} onChange={e => setMassUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Ingrowth Time</label>
                    <div className="flex">
                        <input type="number" value={time} onChange={e => setTime(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                        <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(timeUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Parent Ra-226 Activity</p>
                    <p className="text-xl font-bold text-slate-600 dark:text-slate-300">{result.ra226_activity.value} {result.ra226_activity.unit}</p>
                    <div className="mt-3 pt-3 border-t border-slate-300 dark:border-slate-600">
                        <div className="flex justify-between items-center -mb-2">
                           <div></div> {/* Spacer */}
                           <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Resulting Rn-222 Activity</p>
                           <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                              <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                  <Icon path={ICONS.notepad} className="w-5 h-5" />
                              </button>
                           </Tooltip>
                        </div>
                        <div className="flex items-center justify-center">
                            <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.rn222_activity.value} <span className="text-2xl opacity-75">{result.rn222_activity.unit}</span></p>
                            <CopyButton textToCopy={result.rn222_activity.value} />
                        </div>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">({result.percentEquilibrium}% of secular equilibrium)</p>
                    </div>
                </div>
            )}
        </div>
    );
};

const RadonCalculator = () => {
    const [activeTab, setActiveTab] = React.useState('concentration');
    
    // State for KusnetzCalculator
    const [kusnetz_flowRate, setKusnetz_flowRate] = React.useState(() => localStorage.getItem('kusnetz_flowRate') || '10');
    const [kusnetz_sampleTime, setKusnetz_sampleTime] = React.useState(() => localStorage.getItem('kusnetz_sampleTime') || '5');
    const [kusnetz_delayTime, setKusnetz_delayTime] = React.useState(() => localStorage.getItem('kusnetz_delayTime') || '40');
    const [kusnetz_grossCounts, setKusnetz_grossCounts] = React.useState(() => localStorage.getItem('kusnetz_grossCounts') || '5000');
    const [kusnetz_countDuration, setKusnetz_countDuration] = React.useState(() => localStorage.getItem('kusnetz_countDuration') || '5');
    const [kusnetz_backgroundCpm, setKusnetz_backgroundCpm] = React.useState(() => localStorage.getItem('kusnetz_backgroundCpm') || '0.5');
    const [kusnetz_efficiency, setKusnetz_efficiency] = React.useState(() => localStorage.getItem('kusnetz_efficiency') || '25');
    const [kusnetz_result, setKusnetz_result] = React.useState(null);
    const [kusnetz_error, setKusnetz_error] = React.useState('');
    
    // State for ConcentrationDoseModule
    const [conc_calcMode, setConc_calcMode] = React.useState(() => localStorage.getItem('radon_calcMode') || 'doseFromConc');
    const [conc_concentration, setConc_concentration] = React.useState(() => localStorage.getItem('radon_concentration') || '4.0');
    const [conc_unit, setConc_unit] = React.useState(() => localStorage.getItem('radon_unit') || 'pCi/L');
    const [conc_equilibriumFactor, setConc_equilibriumFactor] = React.useState(() => localStorage.getItem('radon_equilibriumFactor') || '0.4');
    const [conc_workingLevel, setConc_workingLevel] = React.useState(() => localStorage.getItem('radon_workingLevel') || '');
    const [conc_occupancyFactor, setConc_occupancyFactor] = React.useState(() => localStorage.getItem('radon_occupancyFactor') || '0.8');
    const [conc_result, setConc_result] = React.useState(null);
    const [conc_error, setConc_error] = React.useState('');

    // NEW: State for RadonIngrowthCalculator
    const [ingrowth_ra226Mass, setIngrowth_ra226Mass] = React.useState('1');
    const [ingrowth_massUnit, setIngrowth_massUnit] = React.useState('mg');
    const [ingrowth_time, setIngrowth_time] = React.useState('30');
    const [ingrowth_timeUnit, setIngrowth_timeUnit] = React.useState('days');
    const [ingrowth_result, setIngrowth_result] = React.useState(null);
    const [ingrowth_error, setIngrowth_error] = React.useState('');
    
    const handleKusnetzClear = () => {
        setKusnetz_flowRate('10'); setKusnetz_sampleTime('5'); setKusnetz_delayTime('40');
        setKusnetz_grossCounts('5000'); setKusnetz_countDuration('5'); setKusnetz_backgroundCpm('0.5');
        setKusnetz_efficiency('25'); setKusnetz_result(null); setKusnetz_error('');
    };
    
    const handleConcentrationClear = () => {
        setConc_calcMode('doseFromConc'); setConc_concentration('4.0'); setConc_unit('pCi/L');
        setConc_equilibriumFactor('0.4'); setConc_workingLevel(''); setConc_occupancyFactor('0.8');
        setConc_result(null); setConc_error('');
    };

    const handleIngrowthClear = () => {
       setIngrowth_ra226Mass('1'); setIngrowth_massUnit('mg'); setIngrowth_time('30');
       setIngrowth_timeUnit('days'); setIngrowth_result(null); setIngrowth_error('');
    };
    
    const handleClearActiveCalculator = () => {
        if (activeTab === 'concentration') {
           handleConcentrationClear();
        } else if (activeTab === 'kusnetz') {
           handleKusnetzClear();
        } else {
           handleIngrowthClear();
        }
    };
    
    return (
        <div className="p-4 animate-fade-in">
           <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <div className="flex justify-between items-center">
                   <h2 className="text-xl font-bold text-slate-800 dark:text-white">Radon Tools</h2>
                   <ClearButton onClick={handleClearActiveCalculator} />
               </div>
               <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg my-4">
                   <button onClick={() => setActiveTab('concentration')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'concentration' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Concentration</button>
                   <button onClick={() => setActiveTab('ingrowth')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'ingrowth' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Ingrowth</button>
                   <button onClick={() => setActiveTab('kusnetz')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'kusnetz' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Kusnetz (WL)</button>
               </div>
               {activeTab === 'concentration' && 
                   <ConcentrationDoseModule 
                       calcMode={conc_calcMode} setCalcMode={setConc_calcMode}
                       concentration={conc_concentration} setConcentration={setConc_concentration}
                       unit={conc_unit} setUnit={setConc_unit}
                       equilibriumFactor={conc_equilibriumFactor} setEquilibriumFactor={setConc_equilibriumFactor}
                       workingLevel={conc_workingLevel} setWorkingLevel={setConc_workingLevel}
                       occupancyFactor={conc_occupancyFactor} setOccupancyFactor={setConc_occupancyFactor}
                       result={conc_result} setResult={setConc_result}
                       error={conc_error} setError={setConc_error}
                   />
               }
               {activeTab === 'ingrowth' &&
                   <RadonIngrowthCalculator
                       ra226Mass={ingrowth_ra226Mass} setRa226Mass={setIngrowth_ra226Mass}
                       massUnit={ingrowth_massUnit} setMassUnit={setIngrowth_massUnit}
                       time={ingrowth_time} setTime={setIngrowth_time}
                       timeUnit={ingrowth_timeUnit} setTimeUnit={setIngrowth_timeUnit}
                       result={ingrowth_result} setResult={setIngrowth_result}
                       error={ingrowth_error} setError={setIngrowth_error}
                   />
               }
               {activeTab === 'kusnetz' && 
                   <KusnetzCalculator 
                       flowRate={kusnetz_flowRate} setFlowRate={setKusnetz_flowRate}
                       sampleTime={kusnetz_sampleTime} setSampleTime={setKusnetz_sampleTime}
                       delayTime={kusnetz_delayTime} setDelayTime={setKusnetz_delayTime}
                       grossCounts={kusnetz_grossCounts} setGrossCounts={setKusnetz_grossCounts}
                       countDuration={kusnetz_countDuration} setCountDuration={setKusnetz_countDuration}
                       backgroundCpm={kusnetz_backgroundCpm} setBackgroundCpm={setKusnetz_backgroundCpm}
                       efficiency={kusnetz_efficiency} setEfficiency={setKusnetz_efficiency}
                       result={kusnetz_result} setResult={setKusnetz_result}
                       error={kusnetz_error} setError={setKusnetz_error}
                   />
               }
           </div>
        </div>
    );
};   
         
         /**
         * @description React component for displaying the application's user manual, FAQ, and technical reference.
         * This component functions as a modal dialog that presents static, detailed information about the
         * "Health Physics Toolbox" application.
         *
         * The manual content is an in-depth guide covering:
         * - **Getting Started:** How to search for and view radionuclide data.
         * - **Core Features:** A comprehensive breakdown of each major section of the app (Database, Compare, Calculators).
         * - **Settings & Customization:** How to configure user preferences.
         * - **Formulas & Equations:** A reference section detailing the key mathematical formulas used in various calculators.
         * - **Contact & Copyright:** Information for user feedback and legal disclaimers.
         * - **FAQ:** Answers to common questions, such as the source of the data and why certain nuclides may not appear in specific calculators.
         *
         * This component is purely for display and serves as the primary source of documentation for the user.
         *
         * @prop {boolean} isOpen - Boolean to control the visibility of the modal.
         * @prop {function} onClose - A callback function to close the modal.
         */
         
/**
 * @description React component for displaying the application's user manual, FAQ, and technical reference.
 * This component functions as a modal dialog that presents static, detailed information about the
 * "Health Physics Toolbox" application.
 *
 * The manual content is an in-depth guide covering:
 * - **Getting Started:** How to search for and view radionuclide data.
 * - **Core Features:** A comprehensive breakdown of each major section of the app (Database, Compare, Calculators).
 * - **Settings & Customization:** How to configure user preferences.
 * - **Formulas & Equations:** A reference section detailing the key mathematical formulas used in various calculators.
 * - **Contact & Copyright:** Information for user feedback and legal disclaimers.
 * - **FAQ:** Answers to common questions, such as the source of the data and why certain nuclides may not appear in specific calculators.
 *
 * This component is purely for display and serves as the primary source of documentation for the user.
 *
 * @prop {boolean} isOpen - Boolean to control the visibility of the modal.
 * @prop {function} onClose - A callback function to close the modal.
 */
const ManualModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;

    // Internal component for the static content of the manual to keep JSX clean.
    const ManualContent = () => {
        return (
            <div className="prose prose-slate dark:prose-invert max-w-none p-6 text-slate-700 dark:text-slate-300">
                <h1 className="text-slate-900 dark:text-slate-100"><strong>User Manual & FAQ</strong></h1>
                <p>
                    Welcome to the Health Physics Toolbox! This application is designed to be a comprehensive, all-in-one resource for students, health physicists, and nuclear professionals. Our philosophy is to centralize the essential data and calculations you need, removing the reliance on scattered spreadsheets, outdated software, or manual lookups. This guide will walk you through the various features to help you get the most out of the tool.
                </p>
        
                <hr className="my-4" />
        
                <h2 className="text-slate-900 dark:text-slate-100"><strong>Getting Started: Finding a Nuclide</strong></h2>
                <p>
                    The primary function of the tool is to look up detailed information on a specific radionuclide. The search bar at the top of the page is your main entry point.
                </p>
                <h4 className="italic mt-4">Searching</h4>
                <p>
                    You can search by either the nuclide's full name (e.g., <code>"Cesium-137"</code>) or its symbol (e.g., <code>"Cs-137"</code>). The search is flexible and ignores spaces or hyphens, so <code>"cs137"</code> will also work. As you type, a list of the top 10 suggestions will appear, prioritized by how common the nuclide is, to help you find what you're looking for faster.
                </p>
                <h4 className="italic mt-4">The Nuclide Card</h4>
                <p>
                    Once you select a nuclide, its detailed information card is displayed. This card is a comprehensive summary, containing key data points grouped into logical sections like **Decay Properties**, **Physical Properties**, **Genealogy**, **Transportation Limits**, **Internal Dosimetry**, and **Principal Emissions**. You can add a nuclide to your persistent <strong>Favorites</strong> list by clicking the star icon in the top right, making it easily accessible from the home page.
                </p>
        
                <hr className="my-4" />
        
                <h2 className="text-slate-900 dark:text-slate-100"><strong>Core Features</strong></h2>
                <p>The main navigation bar provides access to all the specialized tools and views within the application.</p>
        
                <h3 className="mt-6"><strong>Database & Compare</strong></h3>
                <ul>
                    <li><strong>Database:</strong> This view is for discovery and exploration. It allows you to browse and sort the entire collection of radionuclides. The sidebar on the left provides a powerful set of filters to help you find nuclides with specific properties, such as category, emission type, half-life, and energy ranges. This is perfect for finding the right nuclide for a specific application.</li>
                    <li><strong>Compare:</strong> This tool is designed for nuanced analysis, allowing you to view multiple nuclides in a side-by-side table. This is especially useful for comparing similar candidates for a task, such as different isotopes for brachytherapy or medical imaging. The table automatically highlights the minimum and maximum values in each numerical row and displays in-cell data bars to provide an immediate visual sense of magnitude. This view also includes an <strong>Export to CSV</strong> function.</li>
                </ul>
        
                <h3 className="mt-6"><strong>Calculators</strong></h3>
                <p>The application includes a comprehensive suite of calculators for a wide range of radiological scenarios.</p>
        
                <h4 className="italic mt-4">Decay Calculators</h4>
                <p>This group of tools handles the physics of radioactive decay over time.</p>
                <ul>
                    <li><strong>Decay Tools:</strong> A multi-tool for fundamental decay calculations. The <strong>Standard</strong> tab solves the fundamental decay equation for any one variable (initial activity, remaining activity, or time). The <strong>Correction</strong> tab is a specialized tool for correcting a source's activity from its calibration date to a new date. The <strong>To Limit</strong> tab calculates the time required for a source to decay to a specific activity level, which is useful for waste management.</li>
                    <li><strong>Series Decay:</strong> This advanced tool uses the full Bateman equations to model the activity of <em>every</em> nuclide in a long decay chain (like the Uranium or Thorium series) over time. It provides both a final activity table and an interactive chart showing the in-growth and decay of each progeny, which is essential for understanding complex decay dynamics.</li>
                    <li><strong>Equilibrium:</strong> This calculator specifically analyzes a parent-daughter pair to determine their equilibrium relationship. It will automatically classify the relationship as <strong>Secular</strong> (parent half-life is much longer than daughter's) or <strong>Transient</strong> (parent half-life is longer, but not by a huge margin) and calculates important metrics like the time to maximum daughter activity.</li>
                </ul>
                
                <h4 className="italic mt-4">Dose & Shielding Calculators</h4>
                <p>These tools are for external dosimetry, helping to estimate radiation dose and the shielding required to reduce it.</p>
                <ul>
                    <li><strong>Dose & Dose Rate:</strong> A versatile tool with multiple modes. <strong>Gamma</strong> mode models dose from Point, Line, and Area (Disk) geometries. <strong>Beta</strong> mode includes two sub-calculators: Skin Dose from surface contamination and Dose in Air from a point source. <strong>Bremsstrahlung</strong> mode estimates the secondary X-ray dose produced when beta particles are stopped by shielding. <strong>Internal</strong> mode calculates the Committed Effective Dose Equivalent (CEDE) from an intake using 10 CFR 20 ALI values.</li>
                    <li><strong>Shielding:</strong> This calculator models the attenuation of radiation. The <strong>Gamma</strong> modes calculate the final dose rate after passing through a shield or the required shield thickness to reach a target dose rate. It includes an optional Buildup Factor correction for a more accurate result in broad beam geometries. The <strong>Beta Range</strong> mode calculates the thickness of low-Z material required to completely stop beta particles.</li>
                    <li><strong>Stay Time:</strong> A practical tool for ALARA planning. It calculates the maximum time a person can stay in an area with a known dose rate before accumulating a specific dose limit.</li>
                </ul>
        
                <h4 className="italic mt-4">Operational HP Tools</h4>
                <p>A suite of calculators designed for day-to-day radiation safety tasks and survey analysis.</p>
                <ul>
                   <li><strong>Surface Contamination:</strong> A comprehensive tool that calculates both removable contamination (from a wipe test) and total contamination (from a static probe survey). It automatically compares the results against the standard limits found in both NRC Regulatory Guide 1.86 and ANSI N13.12.</li>
                   <li><strong>Leak Test:</strong> A specialized version of the wipe survey calculator for evaluating sealed sources against the common 0.005 µCi regulatory limit for removable contamination.</li>
                   <li><strong>Airborne Release:</strong> This tool models a theoretical airborne release in a room to calculate the initial concentration in DAC (Derived Air Concentration) units. It also estimates the time required for the room's ventilation system (in Air Changes per Hour) to reduce the concentration back down to 1 DAC.</li>
                </ul>
                
                <h4 className="italic mt-4">Neutron Tools</h4>
                <p>A set of specialized calculators for dealing with neutron radiation, a common consideration in reactor and accelerator facilities.</p>
                <ul>
                   <li><strong>Fluence/Dose:</strong> Converts between neutron fluence (n/cm²) and dose equivalent (rem or Sv) for a given neutron energy. The conversion is performed using a log-log interpolation of the quality factors and fluence-per-rem data specified in 10 CFR 20.</li>
                   <li><strong>Activation:</strong> Calculates the activity of a product nuclide created by irradiating a specific target material in a known thermal neutron flux for a given amount of time. It includes both a database of common (n,γ) reactions and a manual input mode for custom scenarios.</li>
                   <li><strong>Composite Activation:</strong> Estimates the principal activation products from irradiating common composite materials like concrete or steel, which contain trace elements that can become significant activation products.</li>
                   <li><strong>Shielding:</strong> Estimates the attenuation of fast or thermal neutrons through various common shielding materials using approximate Half-Value Layer (HVL) data.</li>
                </ul>
                
                <h4 className="italic mt-4">Medical Physics Tools</h4>
                <p>Calculators tailored to scenarios commonly found in a medical or hospital environment.</p>
                <ul>
                   <li><strong>X-Ray Shielding:</strong> A screening tool to calculate the required thickness of lead, concrete, or drywall for diagnostic X-ray rooms. It is based on the NCRP Report No. 147 methodology, accounting for workload, use factor, occupancy, and distance.</li>
                   <li><strong>Patient Release:</strong> This tool helps determine if a patient administered with a radiopharmaceutical can be released from the hospital based on the criteria in 10 CFR 35.75. It checks against activity-based limits, dose-rate limits, or a full public dose calculation (TEDE) based on occupancy scenarios.</li>
                </ul>
        
                <h4 className="italic mt-4">MARSSIM Tools</h4>
                <p>A suite of tools dedicated to planning and evaluating final status surveys according to the Multi-Agency Radiation Survey and Site Investigation Manual.</p>
                <ul>
                    <li><strong>MDA/MDC:</strong> Calculates key decision values for radiation counting instrumentation. It includes a mode for <strong>Static Count MDA</strong> (based on NUREG-1507) and <strong>Scan Survey MDC</strong> (based on MARSSIM formulas) to ensure your survey methods can detect contamination at the required levels.</li>
                    <li><strong>Sample Design:</strong> A two-part suite. The <strong>Calculator</strong> determines the required number of statistical samples for a survey unit using the Wilcoxon Rank Sum (WRS) test methodology. The <strong>Drawing Tool</strong> provides an interactive map to draw survey unit boundaries and automatically generate sample locations in a square grid, triangular grid, or random pattern.</li>
                    <li><strong>Statistical Tests:</strong> Performs the two primary MARSSIM statistical tests on a set of data. The <strong>WRS Test</strong> is used to compare a survey unit to a reference area to determine if it meets the release criteria. The <strong>EMC Sign Test</strong> is used for evaluating localized areas of elevated activity to ensure they are not a significant risk.</li>
                </ul>
        
                <h4 className="italic mt-4">Lab Statistics & QA/QC</h4>
                <p>Tools for quality assurance and control of radiation counting equipment and laboratory processes.</p>
                <ul>
                   <li><strong>Chi-Squared (χ²) Test:</strong> This is a key performance test for a counting system. It performs a chi-squared test on a set of repeated counts of a stable source to check if the observed variance is consistent with a random Poisson distribution, ensuring the detector is functioning properly.</li>
                   <li><strong>Dead Time Correction:</strong> Corrects an observed count rate for counts that were missed due to detector dead time—the brief period after detecting a particle when the system is busy and cannot register another. This is crucial for accurate measurements at high count rates.</li>
                   <li><strong>RPD:</strong> Calculates the Relative Percent Difference between two duplicate samples to evaluate measurement precision and the reproducibility of your lab processes.</li>
                   <li><strong>FWHM / Resolution:</strong> Calculates a detector's Full Width at Half Maximum (FWHM) and energy resolution from a photopeak's properties (centroid and half-max energies). This is a fundamental measure of a gamma spectroscopy system's performance.</li>
                </ul>
                
                <h4 className="italic mt-4">Utility Tools</h4>
                <p>A collection of helpful tools to streamline your workflow.</p>
                <ul>
                    <li><strong>Peak Identifier:</strong> An essential tool for spectroscopy. The <strong>Search</strong> tab finds matching radionuclides for a given peak energy and tolerance. It also analyzes for common spectral artifacts like Compton Edges, escape peaks, and lead X-rays. The <strong>Data Tables</strong> tab provides a comprehensive, sortable, and filterable list of all alpha, beta, and gamma emissions in the database.</li>
                    <li><strong>Activity/Mass Tools:</strong> A three-in-one module. <strong>Mass ↔ Activity</strong> converts between a nuclide's mass and its activity using its specific activity. <strong>Activity from Dose</strong> calculates a source's activity based on a gamma dose rate measurement. <strong>Specific Activity</strong> is a first-principles calculator for determining a nuclide's SA (Bq/g) from its atomic weight and half-life.</li>
                    <li><strong>Radon Tools:</strong> A three-part suite for radon analysis. <strong>Concentration</strong> converts between radon concentration units (e.g., pCi/L and Bq/m³) and estimates annual dose. <strong>Ingrowth</strong> calculates the Rn-222 activity from a given mass of its parent, Ra-226. <strong>Kusnetz (WL)</strong> determines the Working Level of radon progeny from air sampling data.</li>
                    <li><strong>Transportation:</strong> Determines the required shipping package type (Excepted, Type A, or Type B) for a given radionuclide and activity, based on its IAEA A₁ (special form) and A₂ (normal form) values.</li>
                    <li><strong>Converter:</strong> A general-purpose unit converter for activity, dose, dose rate, energy, concentration, and other common physical units.</li>
                    <li><strong>Scratchpad & Sci. Calculator:</strong> Simple utility tools for jotting down notes or performing quick calculations. Both can be popped out into a separate window.</li>
                </ul>
        
                <hr className="my-4" />
        
                <h2 className="text-slate-900 dark:text-slate-100"><strong>Formulas & Equations Reference</strong></h2>
        
                <h3 className="mt-6"><b>Decay & Activity Formulas</b></h3>
                <h4 className="italic mt-4">Radioactive Decay</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>A(t) = A₀ · e<sup>-λt</sup></pre>
                </div>
                <ul>
                    <li><code>A(t)</code> = Activity at time t</li>
                    <li><code>A₀</code> = Initial activity at t=0</li>
                    <li><code>λ</code> = Decay constant (ln(2) / T<sub>1/2</sub>)</li>
                    <li><code>t</code> = Elapsed time</li>
                </ul>

                <h4 className="italic mt-4">Series (Bateman) Decay for a 2-step chain (A → B)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>A₂(t) = [A₁(0)·λ₂/(λ₂-λ₁)]·[e<sup>-λ₁t</sup> - e<sup>-λ₂t</sup>] + A₂(0)e<sup>-λ₂t</sup></pre>
                </div>
                 <ul>
                    <li><code>A₂(t)</code> = Activity of the daughter at time t</li>
                    <li><code>A₁(0)</code> = Initial activity of the parent</li>
                    <li><code>A₂(0)</code> = Initial activity of the daughter</li>
                    <li><code>λ₁</code>, <code>λ₂</code> = Decay constants for parent and daughter, respectively</li>
                </ul>

                <h4 className="italic mt-4">Specific Activity (SA)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>SA (Bq/g) = (Nₐ · λ) / Mₐ</pre>
                </div>
                <ul>
                    <li><code>Nₐ</code> = Avogadro's Number (6.022 x 10²³ atoms/mol)</li>
                    <li><code>Mₐ</code> = Molar mass of the radionuclide (g/mol)</li>
                    <li><code>λ</code> = Decay constant in seconds⁻¹</li>
                </ul>
        
                <h3 className="mt-6"><b>Dose & Shielding Formulas</b></h3>
                <h4 className="italic mt-4">Gamma Dose Rate (Point Source)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Dose Rate = (Γ · A) / d²</pre>
                </div>
                <ul>
                    <li><code>Γ</code> = Specific gamma-ray constant (e.g., in R·m²/hr·Ci)</li>
                    <li><code>A</code> = Source activity (in Ci)</li>
                    <li><code>d</code> = Distance from the source (in m)</li>
                </ul>

                <h4 className="italic mt-4">Gamma Shielding</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>D(x) = D₀ · B · (0.5)<sup>(x / HVL)</sup></pre>
                </div>
                <ul>
                    <li><code>D(x)</code> = Dose rate after shielding</li>
                    <li><code>D₀</code> = Initial dose rate</li>
                    <li><code>B</code> = Buildup Factor, for scattered photons</li>
                    <li><code>x</code> = Shield thickness</li>
                    <li><code>HVL</code> = Half-Value Layer thickness for the material</li>
                </ul>

                <h4 className="italic mt-4">X-Ray Shielding (NCRP-147)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>B = (P · d²) / (K · W · U · T)</pre>
                </div>
                <ul>
                    <li><code>B</code> = Required transmission factor</li>
                    <li><code>P</code> = Weekly dose limit (in R/wk)</li>
                    <li><code>d</code> = Distance from source to barrier (m)</li>
                    <li><code>K</code> = Air kerma rate constant (R·m²/mA·min)</li>
                    <li><code>W</code> = Workload (mA·min/wk)</li>
                    <li><code>U</code> = Use Factor (fraction of time beam is on)</li>
                    <li><code>T</code> = Occupancy Factor (fraction of time area is occupied)</li>
                </ul>

                <h4 className="italic mt-4">Patient Release TEDE (10 CFR 35.75)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>TEDE (rem) ≈ 1.443 · Γ · A₀ · T<sub>eff</sub> · Σ(tᵢ / dᵢ²)</pre>
                </div>
                <ul>
                    <li><code>Γ</code> = Gamma constant (R·m²/hr·mCi)</li>
                    <li><code>A₀</code> = Initial activity (mCi)</li>
                    <li><code>T<sub>eff</sub></code> = Effective half-life (hours)</li>
                    <li><code>tᵢ</code> = Occupancy time fraction for scenario i (hours/24)</li>
                    <li><code>dᵢ</code> = Distance for scenario i (m)</li>
                </ul>
                
                <h3 className="mt-6"><b>Operational HP Formulas</b></h3>
                <h4 className="italic mt-4">Wipe / Leak Test Activity</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Activity (µCi) = (CPM<sub>net</sub>) / (ε<sub>inst</sub> · ε<sub>smear</sub> · 2.22x10⁶)</pre>
                </div>
                <ul>
                    <li><code>CPM<sub>net</sub></code> = Gross CPM - Background CPM</li>
                    <li><code>ε<sub>inst</sub></code> = Instrument efficiency (as a fraction)</li>
                    <li><code>ε<sub>smear</sub></code> = Smear/wipe efficiency (typically 0.1)</li>
                    <li><code>2.22x10⁶</code> = DPM per µCi</li>
                </ul>

                <h4 className="italic mt-4">Airborne Concentration</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>C(t) = (A / V) · e<sup>(-ACH · t)</sup></pre>
                </div>
                <ul>
                    <li><code>C(t)</code> = Concentration at time t</li>
                    <li><code>A</code> = Released activity</li>
                    <li><code>V</code> = Room volume</li>
                    <li><code>ACH</code> = Air Changes per Hour</li>
                    <li><code>t</code> = Time in hours</li>
                </ul>

                <h3 className="mt-6"><b>Neutron Formulas</b></h3>
                <h4 className="italic mt-4">Thermal Neutron Activation</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>A(t) = N · σ · φ · (1 - e<sup>-λt</sup>)</pre>
                </div>
                <ul>
                    <li><code>A(t)</code> = Activity of product at time t (Bq)</li>
                    <li><code>N</code> = Number of target atoms</li>
                    <li><code>σ</code> = Thermal neutron cross-section (cm²)</li>
                    <li><code>φ</code> = Neutron flux (n/cm²·s)</li>
                    <li><code>λ</code> = Decay constant of the product nuclide</li>
                    <li><code>t</code> = Irradiation time (s)</li>
                </ul>
                
                <h3 className="mt-6">MARSSIM Formulas</h3>
                <h4 className="italic mt-4">Static Count MDA (NUREG-1507)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>LLD (counts) = 3.29 · √(R<sub>b</sub>·t<sub>g</sub>·(1 + t<sub>g</sub>/t<sub>b</sub>)) + 3</pre>
                </div>
                <ul>
                    <li><code>R<sub>b</sub></code> = Background count rate (cpm)</li>
                    <li><code>t<sub>g</sub></code>, <code>t<sub>b</sub></code> = Gross (sample) and background count times (min)</li>
                </ul>

                <h4 className="italic mt-4">Scan MDC</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Scan MDC = MDCR / (√(p) · ε<sub>total</sub>)</pre>
                </div>
                <ul>
                    <li><code>MDCR</code> = Minimum Detectable Count Rate</li>
                    <li><code>p</code> = Surveyor efficiency</li>
                    <li><code>ε<sub>total</sub></code> = Total efficiency (instrument * surface)</li>
                </ul>

                <h4 className="italic mt-4">Number of Samples (WRS Test)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>N = (Z₁<sub>-α</sub> + Z₁<sub>-β</sub>)² / (3 · (Pᵣ - 0.5)²)</pre>
                </div>
                 <ul>
                    <li><code>Z₁<sub>-α</sub></code>, <code>Z₁<sub>-β</sub></code> = Z-scores for Type I/II error rates</li>
                    <li><code>Pᵣ</code> = Probability value from MARSSIM Table 5.2 based on Relative Shift</li>
                </ul>

                <h3 className="mt-6"><b>Lab Statistics Formulas</b></h3>
                <h4 className="italic mt-4">Chi-Squared (χ²) Test</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>χ² = Σ((xᵢ - x̄)²) / x̄</pre>
                </div>
                 <ul>
                    <li><code>xᵢ</code> = Individual count value</li>
                    <li><code>x̄</code> = Mean of all count values</li>
                </ul>

                <h4 className="italic mt-4">Dead Time Correction</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>N = R / (1 - Rτ)</pre>
                </div>
                 <ul>
                    <li><code>N</code> = True count rate (cps)</li>
                    <li><code>R</code> = Observed count rate (cps)</li>
                    <li><code>τ</code> = Detector dead time (seconds)</li>
                </ul>

                <h4 className="italic mt-4">Relative Percent Difference (RPD)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>RPD (%) = |S₁ - S₂| / ((S₁ + S₂) / 2) · 100</pre>
                </div>
                <ul>
                    <li><code>S₁</code>, <code>S₂</code> = Values for the two duplicate samples</li>
                </ul>

                <h4 className="italic mt-4">Energy Resolution</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Resolution (%) = (FWHM / E) · 100</pre>
                </div>
                 <ul>
                    <li><code>FWHM</code> = Full Width at Half Maximum of the peak (keV)</li>
                    <li><code>E</code> = Peak centroid energy (keV)</li>
                </ul>
        
                <hr className="my-4" />
        
                <h2 className="text-slate-900 dark:text-slate-100"><strong>Frequently Asked Questions (FAQ)</strong></h2>
                <h4 className="italic mt-4">Where does the data come from?</h4>
                <p>The data is aggregated from highly reliable, standard industry sources:</p>
                <ul>
                    <li><strong>Nuclear Data (Half-life, emissions, etc.):</strong> National Nuclear Data Center's (NNDC) NuDat 3 database.</li>
                    <li><strong>Dosimetry Data (ALI, DAC):</strong> U.S. Nuclear Regulatory Commission, 10 CFR 20, Appendix B.</li>
                    <li><strong>Gamma Constants & HVL Data:</strong> Standard, commonly-cited values from health physics texts and publications from organizations like the Health Physics Society (HPS).</li>
                    <li><strong>MARSSIM Formulas:</strong> NUREG-1575 (MARSSIM), NUREG-1507.</li>
                </ul>
        
                <h4 className="italic mt-4">Why doesn't a specific nuclide appear in a calculator?</h4>
                <p>Calculators are populated only with nuclides that have the necessary data for that specific calculation. For example, the <strong>Dose Rate</strong>, <strong>Shielding</strong>, and <strong>Stay Time</strong> calculators all require a nuclide to have a defined "Gamma Constant" (Γ). Therefore, pure beta emitters (like Tritium or Carbon-14) or pure alpha emitters will not be available in those specific tools. Similarly, the **Activation Calculator** only lists target nuclides known to produce common activation products.</p>
        
                <h4 className="italic mt-4">What is the disclaimer?</h4>
                <p><strong>This tool is for informational and educational purposes only.</strong> The data and calculations have not been independently peer-reviewed or validated and may contain errors. It should not be used for radiation protection, safety-critical applications, operational decision-making, or for demonstrating regulatory compliance. All use of this tool is at your own risk.</p>
            </div>
        );
    };

    return (
        <div className="fixed inset-0 bg-black/60 z-[5000] flex justify-center items-start p-4" onClick={onClose}>
            <div className="bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h2 className="text-xl font-bold">User Manual & FAQ</h2>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                        <Icon path={ICONS.clear} className="w-6 h-6" />
                    </button>
                </div>
                <div className="overflow-y-auto">
                    <ManualContent />
                </div>
            </div>
        </div>
    );
};         
         /**
         * @description React component for managing user settings and preferences.
         * This panel provides a user interface to configure various default units and modes
         * for the application's calculators, tailoring the user experience to their specific
         * needs and regional standards.
         *
         * Key functionalities include:
         * - **Unit Selection:** Users can set their preferred default units for common
         * quantities like Activity, Dose Rate, and Distance.
         * - **Mode Selection:** Users can choose the default calculator mode for multi-mode tools,
         * such as the Dose Calculator.
         * - **Data Management:** A "Reset to Defaults" button allows users to clear all locally
         * saved data, including their custom settings, favorites list, and calculator inputs,
         * via a confirmation modal. This ensures a clean slate, if needed.
         *
         * This component utilizes a global `SettingsContext` to persist and retrieve user preferences
         * across the application's various tools.
         */
         
const SettingsPanel = () => {
    const { settings, updateSettings } = React.useContext(SettingsContext);
    const [isResetModalOpen, setIsResetModalOpen] = React.useState(false);

    const handleSettingChange = (key, value) => {
        updateSettings({ [key]: value });
    };

    const handleResetDefaults = () => {
        localStorage.clear();
        sessionStorage.setItem('showResetToast', 'true');
        window.location.reload();
    };

    return (
        <>
            <div className="p-4 animate-fade-in">
                <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Settings</h2>
                    <p className="text-sm text-slate-600 dark:text-slate-300 mb-6">
                        Manage application theme and saved data.
                    </p>

                    {/* --- Theme Section --- */}
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">Theme</label>
                            <div className="grid grid-cols-3 gap-2 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
                                 <button onClick={() => handleSettingChange('theme', 'light')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.theme === 'light' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Light</button>
                                 <button onClick={() => handleSettingChange('theme', 'dark')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.theme === 'dark' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dark</button>
                                 <button onClick={() => handleSettingChange('theme', 'system')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.theme === 'system' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>System</button>
                            </div>
                        </div>
                    </div>

                    {/* --- About Section --- */}
                    <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-2 text-center text-xs text-slate-500 dark:text-slate-400">
                         <p><strong>Health Physics Toolbox</strong> Version {VERSION}</p>
                         <p>Last Updated: {LAST_UPDATED}</p>
                         <p>Created by Jough Donakowski</p>
                    </div>

                    {/* --- Reset Section --- */}
                    <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                        <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200">Application Data</h3>
                         <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">This will clear all saved calculator inputs, favorites, search history, and settings.</p>
                        <button onClick={() => setIsResetModalOpen(true)} className="w-full py-2 bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 font-semibold rounded-lg hover:bg-red-200 dark:hover:bg-red-900 transition">Reset All Saved Data</button>
                    </div>
                </div>
            </div>
            <ConfirmationModal isOpen={isResetModalOpen} onClose={() => setIsResetModalOpen(false)} onConfirm={handleResetDefaults} title="Reset All Settings & Saved Data?"><p>Are you sure? This will clear <strong>all</strong> saved calculator inputs, favorites, search history, and default settings. The application will reload with its original defaults. This action cannot be undone.</p></ConfirmationModal>
        </>
    );
};


const PopoutWindow = ({ children, title, onClose, width = 450, height = 750 }) => {
             const [container, setContainer] = React.useState(null);
             const newWindow = React.useRef(null);
         
             React.useEffect(() => {
                 newWindow.current = window.open('', title, `width=${width},height=${height},resizable=yes`);
                 
                 // --- THIS LINE IS UPDATED to include text colors ---
                 newWindow.current.document.body.className = "bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200";
                 
                 const popoutRoot = newWindow.current.document.createElement('div');
                 newWindow.current.document.body.appendChild(popoutRoot);

        const reactScript = newWindow.current.document.createElement('script');
        reactScript.src = "https://unpkg.com/react@18/umd/react.development.js";
        reactScript.crossOrigin = true;
        newWindow.current.document.head.appendChild(reactScript);

        const reactDomScript = newWindow.current.document.createElement('script');
        reactDomScript.src = "https://unpkg.com/react-dom@18/umd/react-dom.development.js";
        reactDomScript.crossOrigin = true;
        newWindow.current.document.head.appendChild(reactDomScript);

        const babelScript = newWindow.current.document.createElement('script');
        babelScript.src = "https://unpkg.com/@babel/standalone/babel.min.js";
        newWindow.current.document.head.appendChild(babelScript);
                 
                 document.head.querySelectorAll('link[rel="stylesheet"], style').forEach(node => {
                     newWindow.current.document.head.appendChild(node.cloneNode(true));
                 });

                 const tailwindScript = newWindow.current.document.createElement('script');
                 tailwindScript.src = "https://cdn.tailwindcss.com";
                 newWindow.current.document.head.appendChild(tailwindScript);
                 const tailwindConfigScript = newWindow.current.document.createElement('script');
                 tailwindConfigScript.innerHTML = `tailwind.config = { darkMode: 'class' }`;
                 newWindow.current.document.head.appendChild(tailwindConfigScript);
                 
                 newWindow.current.document.documentElement.className = document.documentElement.className;
                 
                 setContainer(popoutRoot);
                 
                 const handleUnload = () => { onClose(); };
                 newWindow.current.addEventListener('beforeunload', handleUnload);

                 return () => {
                     newWindow.current.removeEventListener('beforeunload', handleUnload);
                     if (newWindow.current) {
                        newWindow.current.close();
                     }
                     setContainer(null);
                 };
             }, []);

             if (!container) return null;

             return ReactDOM.createPortal(children, container);
         };



/**
 * @description The root component of the entire application.
 * It manages all primary state, handles routing between views, and orchestrates all user interactions.
 */

const App = () => {
    const [activeView, setActiveView] = React.useState(VIEWS.HOME);
    const [showCalcPopout, setShowCalcPopout] = React.useState(false);
    const [showScratchpadPopout, setShowScratchpadPopout] = React.useState(false);
    const [detailedNuclide, setDetailedNuclide] = React.useState(null);
    const [errorMessage, setErrorMessage] = React.useState('');
    const [preselectedNuclide, setPreselectedNuclide] = React.useState(null);
    const [comparisonList, setComparisonList] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideComparisonList') || '[]'); } catch (e) { return []; } });
    const [nuclideName, setNuclideName] = React.useState('');
    const debouncedSearchTerm = useDebounce(nuclideName, 250);
    const [suggestions, setSuggestions] = React.useState([]);
    const [activeSuggestionIndex, setActiveSuggestionIndex] = React.useState(-1);
    const [isManualOpen, setIsManualOpen] = React.useState(false);
    const [isFiltersVisible, setIsFiltersVisible] = React.useState(false);
    const [displayHalfLifeUnit, setDisplayHalfLifeUnit] = React.useState('years');
    const [currentDecaySeriesId, setCurrentDecaySeriesId] = React.useState(null);
    const [theme, setTheme] = React.useState(() => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
    const [searchHistory, setSearchHistory] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideSearchHistory') || '[]'); } catch (e) { return []; } });
    const [favorites, setFavorites] = React.useState(() => { try { return JSON.parse(localStorage.getItem('favoriteNuclides') || '[]'); } catch (e) { return []; } });
    const [randomSuggestions, setRandomSuggestions] = React.useState([]);
    const [isSearchFocused, setIsSearchFocused] = React.useState(false);

    const [scientificCalculatorState, setScientificCalculatorState] = React.useState({
        expression: '',
        result: '',
        history: [],
        memory: 0
    });

    const [sortBy, setSortBy] = React.useState(() => localStorage.getItem('filterSortBy') || 'name');
    const [sortOrder, setSortOrder] = React.useState(() => localStorage.getItem('filterSortOrder') || 'asc');
    const [selectedCategory, setSelectedCategory] = React.useState(() => localStorage.getItem('filterCategory') || 'All');
    const [selectedEmissionType, setSelectedEmissionType] = React.useState(() => localStorage.getItem('filterEmissionType') || 'All');
    const [selectedCommonality, setSelectedCommonality] = React.useState(() => localStorage.getItem('filterCommonality') || 'All');
    const [minAlphaEnergy, setMinAlphaEnergy] = React.useState(() => localStorage.getItem('filterMinAlphaEnergy') || '');
    const [maxAlphaEnergy, setMaxAlphaEnergy] = React.useState(() => localStorage.getItem('filterMaxAlphaEnergy') || '');
    const [minBetaEnergy, setMinBetaEnergy] = React.useState(() => localStorage.getItem('filterMinBetaEnergy') || '');
    const [maxBetaEnergy, setMaxBetaEnergy] = React.useState(() => localStorage.getItem('filterMaxBetaEnergy') || '');
    const [minGammaEnergy, setMinGammaEnergy] = React.useState(() => localStorage.getItem('filterMinGammaEnergy') || '');
    const [maxGammaEnergy, setMaxGammaEnergy] = React.useState(() => localStorage.getItem('filterMaxGammaEnergy') || '');
    const [minHalfLife, setMinHalfLife] = React.useState(() => localStorage.getItem('filterMinHalfLife') || '');
    const [maxHalfLife, setMaxHalfLife] = React.useState(() => localStorage.getItem('filterMaxHalfLife') || '');
    const [halfLifeFilterUnit, setHalfLifeFilterUnit] = React.useState(() => localStorage.getItem('filterHalfLifeUnit') || 'years');

    const handleSearchFocus = () => setIsSearchFocused(true);
    const handleSearchBlur = () => {
        setTimeout(() => { setIsSearchFocused(false); }, 150);
    };

    React.useEffect(() => {
        const handleHashChange = () => {
            const hash = window.location.hash.replace('#', '');
            const validViews = Object.values(VIEWS);
            let targetView = VIEWS.HOME;
            if (hash && validViews.includes(hash)) {
                targetView = hash;
            } else {
                history.replaceState(null, '', `#${VIEWS.HOME}`);
            }
            setActiveView(targetView);
            setPreselectedNuclide(null);
            if (targetView === VIEWS.HOME) {
                setDetailedNuclide(null);
                setNuclideName(''); 
                setSuggestions([]); 
                setErrorMessage('');
            }
        };
        window.addEventListener('hashchange', handleHashChange);
        handleHashChange();
        return () => window.removeEventListener('hashchange', handleHashChange);
    }, []);

    const mainContentRef = React.useRef(null);
    const scrollPositionRef = React.useRef(null);
    const inputRef = React.useRef(null);
    const suggestionsRef = React.useRef(null);
    const { addToast } = useToast();

    React.useEffect(() => {
        const initialHash = window.location.hash.replace('#', '');
        if ((initialHash === VIEWS.HOME || initialHash === '') && window.innerWidth > 768) {
            inputRef.current?.focus();
        }
    }, []);

    React.useEffect(() => {
        if (sessionStorage.getItem('showResetToast') === 'true') {
            addToast('All settings and saved data have been reset.');
            sessionStorage.removeItem('showResetToast');
        }
    }, [addToast]);

    const scrollToMainContent = () => {
        const isMobile = window.innerWidth < 768;
        if (isMobile && mainContentRef.current) {
            mainContentRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    const handleNavClick = (view) => {
        if (view !== VIEWS.DETAIL) {
            setDetailedNuclide(null);
        }
        setActiveView(view);
        window.location.hash = view;
        scrollToMainContent();
        if (view === VIEWS.HOME) { inputRef.current?.blur(); }
    };
    
    const handleClearSearch = () => {
        setNuclideName('');
        setSuggestions([]);
        setDetailedNuclide(null);
        handleNavClick(VIEWS.HOME);
        inputRef.current?.focus();
    };

    const handleSendToCalculator = (viewId, nuclideSymbol) => {
        setPreselectedNuclide(nuclideSymbol);
        window.location.hash = viewId;
    };

    const handleAddToCompare = (nuclideSymbol) => {
        const nuclideToAdd = radionuclides.find(n => n.symbol === nuclideSymbol);
        if (nuclideToAdd && !comparisonList.find(n => n.symbol === nuclideSymbol)) {
            setComparisonList(prevList => [...prevList, nuclideToAdd]);
            addToast(`${nuclideToAdd.name} added to comparison.`);
        } else if (nuclideToAdd) {
            addToast(`${nuclideToAdd.name} is already in the comparison.`);
        }
        window.location.hash = VIEWS.COMPARE;
    };

    const handleRemoveFromCompare = (nuclideSymbol) => { setComparisonList(prevList => prevList.filter(n => n.symbol !== nuclideSymbol)); };
    const handleClearCompare = () => { setComparisonList([]); addToast('Comparison list cleared.'); };

    React.useEffect(() => {
        localStorage.setItem('filterSortBy', sortBy);
        localStorage.setItem('filterSortOrder', sortOrder);
        localStorage.setItem('filterCategory', selectedCategory);
        localStorage.setItem('filterEmissionType', selectedEmissionType);
        localStorage.setItem('filterCommonality', selectedCommonality);
        localStorage.setItem('filterMinAlphaEnergy', minAlphaEnergy);
        localStorage.setItem('filterMaxAlphaEnergy', maxAlphaEnergy);
        localStorage.setItem('filterMinBetaEnergy', minBetaEnergy);
        localStorage.setItem('filterMaxBetaEnergy', maxBetaEnergy);
        localStorage.setItem('filterMinGammaEnergy', minGammaEnergy);
        localStorage.setItem('filterMaxGammaEnergy', maxGammaEnergy);
        localStorage.setItem('filterMinHalfLife', minHalfLife);
        localStorage.setItem('filterMaxHalfLife', maxHalfLife);
        localStorage.setItem('filterHalfLifeUnit', halfLifeFilterUnit);
    }, [sortBy, sortOrder, selectedCategory, selectedEmissionType, selectedCommonality, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit]);

    React.useEffect(() => {
        const root = window.document.documentElement;
        root.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('theme', theme);
    }, [theme]);

    React.useEffect(() => {
        localStorage.setItem('radionuclideComparisonList', JSON.stringify(comparisonList));
    }, [comparisonList]);

    React.useEffect(() => {
        const handleClickOutside = (e) => {
            if (suggestionsRef.current && !suggestionsRef.current.contains(e.target) && inputRef.current && !inputRef.current.contains(e.target)) {
                setSuggestions([]);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    React.useEffect(() => {
        const common = radionuclides.filter(n => n.commonality === 'Common');
        setRandomSuggestions([...common].sort(() => 0.5 - Math.random()).slice(0, 5));
    }, [radionuclides]);

    const allCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.category))].sort()], [radionuclides]);
    const allEmissionTypes = React.useMemo(() => ['All', ...[...new Set(radionuclides.flatMap(n => n.emissionType || []))].sort()], [radionuclides]);
    const allCommonalityCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.commonality).filter(Boolean))].sort()], [radionuclides]);

    const getFilteredAndSortedRadionuclides = React.useCallback(() => {
        let filtered = [...radionuclides];
        if (selectedCategory !== 'All') { filtered = filtered.filter(n => n.category === selectedCategory); }
        if (selectedEmissionType !== 'All') { filtered = filtered.filter(n => n.emissionType?.includes(selectedEmissionType)); }
        if (selectedCommonality !== 'All') { filtered = filtered.filter(n => n.commonality === selectedCommonality); }
        const filterByEnergyRange = (nuclide, type, min, max) => {
            const energy = parseEnergyToMeV(nuclide.emissionEnergies?.[type]);
            if (energy === 0 && (min || max)) return false;
            const minVal = parseFloat(min); const maxVal = parseFloat(max);
            if (!isNaN(minVal) && !isNaN(maxVal)) return energy >= minVal && energy <= maxVal;
            if (!isNaN(minVal)) return energy >= minVal;
            if (!isNaN(maxVal)) return energy <= maxVal;
            return true;
        };
        if (minAlphaEnergy || maxAlphaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'alpha', minAlphaEnergy, maxAlphaEnergy));
        if (minBetaEnergy || maxBetaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'beta', minBetaEnergy, maxBetaEnergy));
        if (minGammaEnergy || maxGammaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'gamma', minGammaEnergy, maxGammaEnergy));
        if (minHalfLife || maxHalfLife) {
            const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
            const minSeconds = minHalfLife ? parseFloat(minHalfLife) * unitConversions[halfLifeFilterUnit] : null;
            const maxSeconds = maxHalfLife ? parseFloat(maxHalfLife) * unitConversions[halfLifeFilterUnit] : null;
            filtered = filtered.filter(n => {
                const nuclideSeconds = parseHalfLifeToSeconds(n.halfLife);
                if (nuclideSeconds === Infinity && (minSeconds || maxSeconds)) return false;
                const checkMin = minSeconds ? nuclideSeconds >= minSeconds : true;
                const checkMax = maxSeconds ? nuclideSeconds <= maxSeconds : true;
                return checkMin && checkMax;
            });
        }
        filtered.sort((a, b) => {
            let compare = 0;
            if (sortBy === 'name') compare = a.name.localeCompare(b.name);
            else if (sortBy === 'halfLife') compare = parseHalfLifeToSeconds(a.halfLife) - parseHalfLifeToSeconds(b.halfLife);
            else if (sortBy === 'alphaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.alpha) - parseEnergyToMeV(b.emissionEnergies?.alpha);
            else if (sortBy === 'betaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.beta) - parseEnergyToMeV(b.emissionEnergies?.beta);
            else if (sortBy === 'gammaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.gamma) - parseEnergyToMeV(b.emissionEnergies?.gamma);
            return sortOrder === 'asc' ? compare : -compare;
        });
        return filtered;
    }, [selectedCategory, selectedEmissionType, selectedCommonality, sortBy, sortOrder, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit, radionuclides]);

    const filteredList = getFilteredAndSortedRadionuclides();
    const toggleTheme = () => setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
    const handleClearHistory = () => { setSearchHistory([]); localStorage.removeItem('radionuclideSearchHistory'); addToast('Search history cleared.'); };
    const handleDecaySeriesClick = (seriesId) => { setCurrentDecaySeriesId(seriesId); window.location.hash = VIEWS.DECAY_SERIES; };
    const toggleFavorite = (symbol) => { const nuclide = radionuclides.find(n => n.symbol === symbol); const isCurrentlyFavorite = favorites.includes(symbol); const newFavorites = isCurrentlyFavorite ? favorites.filter(s => s !== symbol) : [...favorites, symbol]; setFavorites(newFavorites); localStorage.setItem('favoriteNuclides', JSON.stringify(newFavorites)); if (isCurrentlyFavorite) { addToast(`${nuclide ? nuclide.name : symbol} removed from favorites.`); } else { addToast(`${nuclide ? nuclide.name : symbol} added to favorites!`); } };
    const handleClearFavorites = () => { setFavorites([]); localStorage.removeItem('favoriteNuclides'); addToast('Favorites list cleared.'); };
    const updateSearchHistory = (nuclide) => { setSearchHistory(prev => { const newHistory = [nuclide.symbol, ...prev.filter(symbol => symbol !== nuclide.symbol)]; const limitedHistory = newHistory.slice(0, 5); localStorage.setItem('radionuclideSearchHistory', JSON.stringify(limitedHistory)); return limitedHistory; }); }
    
    const handleNuclideSelection = (nuclide) => {
        setNuclideName(nuclide.name);
        updateSearchHistory(nuclide);
        setDetailedNuclide(nuclide);
        setSuggestions([]);
        setErrorMessage('');
        setCurrentDecaySeriesId(null);
        handleNavClick(VIEWS.DETAIL);
    };


// Corrected useEffect in the App component
React.useEffect(() => {
    if (debouncedSearchTerm.length > 0) {
        // Don't show suggestions if the search term already matches the displayed nuclide
        if (detailedNuclide && debouncedSearchTerm === detailedNuclide.name) {
            setSuggestions([]);
            return;
        }
        const normVal = normalizeString(debouncedSearchTerm);
        const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 };

        // ** THIS IS THE RESTORED LOGIC **
        const filtered = radionuclides
            .filter(n => normalizeString(n.name).includes(normVal) || normalizeString(n.symbol).includes(normVal))
            .sort((a, b) => {
                const orderA = commonalityOrder[a.commonality] || 0;
                const orderB = commonalityOrder[b.commonality] || 0;
                if (orderB !== orderA) return orderB - orderA; // Sort by commonality first
                return a.name.localeCompare(b.name); // Then alphabetically
            })
            .slice(0, 10);
            
        setSuggestions(filtered);
    } else {
        // If the search term is empty, clear suggestions and the detailed result.
        setSuggestions([]);
        if (detailedNuclide) { // Only change state if there's something to clear
            setDetailedNuclide(null);
            handleNavClick(VIEWS.HOME);
        }
    }
}, [debouncedSearchTerm, radionuclides]); // Simplified dependencies

    const handleNuclideNameChange = (e) => {
        setNuclideName(e.target.value);
    };
    
    const handleClearFilters = () => { setSortBy('name'); setSortOrder('asc'); setSelectedCategory('All'); setSelectedEmissionType('All'); setSelectedCommonality('All'); setMinAlphaEnergy(''); setMaxAlphaEnergy(''); setMinBetaEnergy(''); setMaxBetaEnergy(''); setMinGammaEnergy(''); setMaxGammaEnergy(''); setMinHalfLife(''); setMaxHalfLife(''); setHalfLifeFilterUnit('years'); };
    
    const handleLookup = () => { 
        setSuggestions([]); 
        const normInput = normalizeString(nuclideName); 
        const found = radionuclides.find(n => normalizeString(n.name) === normInput || normalizeString(n.symbol) === normInput); 
        if (found) { 
            handleNuclideSelection(found); 
        } else { 
            setDetailedNuclide(null);
            setErrorMessage(`Nuclide "${nuclideName}" not found.`); 
            setActiveView(VIEWS.HOME); 
        } 
    };
    
    const handleKeyDown = (e) => { 
        if (e.key === 'Enter') { 
            if (activeSuggestionIndex !== -1 && suggestions.length > 0) { 
                handleNuclideSelection(suggestions[activeSuggestionIndex]); 
            } else { 
                handleLookup(); 
            } 
        } else if (e.key === 'ArrowDown') { 
            e.preventDefault(); 
            setActiveSuggestionIndex(prev => (prev < suggestions.length - 1 ? prev + 1 : 0)); 
        } else if (e.key === 'ArrowUp') { 
            e.preventDefault(); 
            setActiveSuggestionIndex(prev => (prev > 0 ? prev - 1 : suggestions.length - 1)); 
        } else if (e.key === 'Escape') { 
            setSuggestions([]); 
        } 
    };
    
    const renderActiveView = () => {
        const filterProps = { sortBy, setSortBy, sortOrder, setSortOrder, selectedCategory, setSelectedCategory, allCategories, selectedEmissionType, setSelectedEmissionType, allEmissionTypes, selectedCommonality, setSelectedCommonality, allCommonalityCategories, minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy, minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy, minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy, minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit, clearFilters: handleClearFilters };
        switch (activeView) {
            case VIEWS.DATABASE: return <DatabaseView filteredList={filteredList} onNuclideClick={handleNuclideSelection} filterProps={filterProps} isFiltersVisible={isFiltersVisible} setIsFiltersVisible={setIsFiltersVisible} scrollPositionRef={scrollPositionRef} handleClearFilters={handleClearFilters} />;
            case VIEWS.CALCULATOR: return <DecayTools radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} theme={theme} />;
            case VIEWS.MDA: return <MDACalculator />;
            case VIEWS.MARSSIM_SAMPLES: return <MARSSIM_SampleDesign />;
            case VIEWS.WRS_TEST: return <WRS_Calculator />;
            case VIEWS.EMC_TEST: return <EMC_Calculator />;
            case VIEWS.SERIES_CALCULATOR: return <DecaySeriesCalculator radionuclides={radionuclides} decaySeriesData={decaySeriesData} theme={theme} />;
            case VIEWS.EQUILIBRIUM: return <EquilibriumCalculator radionuclides={radionuclides} theme={theme} />;
            case VIEWS.RADON: return <RadonCalculator />;
            case VIEWS.COMPARE: return <ComparisonView radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} comparisonList={comparisonList} onAddToCompare={handleAddToCompare} onRemoveFromCompare={handleRemoveFromCompare} onClearCompare={handleClearCompare} />;
            case VIEWS.ACTIVITY_MASS: return <ActivityAndMassTools radionuclides={radionuclides} />;
            case VIEWS.DOSE_RATE: return <DoseRateCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.SHIELDING: return <ShieldingCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.STAY_TIME: return <StayTimeCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.NEUTRON: return <NeutronCalculator radionuclides={radionuclides} />;
            case VIEWS.OPERATIONAL_HP: return <OperationalHPCalculators radionuclides={radionuclides} />;
            case VIEWS.TRANSPORTATION: return <TransportationCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.CONVERTER: return <UnitConverter />;
            case VIEWS.LAB_STATS: return <LabStatistics />;
            case VIEWS.PEAK_ID: return <PeakIdentifier radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} />;
            case VIEWS.SETTINGS: return <SettingsPanel />;
            case VIEWS.MARSSIM_TESTS: return <MARSSIM_Statistical_Tests />;
            case VIEWS.DECAY_SERIES: return <DecaySeriesViewer seriesId={currentDecaySeriesId} onBack={() => { setDetailedNuclide(null); handleNavClick(VIEWS.HOME); }} onNuclideClick={handleNuclideSelection} />;
            case VIEWS.DETAIL:
                if (detailedNuclide) {
                    return (
                        <div className="p-4">
                            <NuclideCard 
                                nuclide={detailedNuclide} 
                                radionuclides={radionuclides} 
                                onDecaySeriesClick={handleDecaySeriesClick} 
                                displayHalfLifeUnit={displayHalfLifeUnit} 
                                favorites={favorites} 
                                toggleFavorite={toggleFavorite} 
                                onSendToCalculator={handleSendToCalculator} 
                                onAddToCompare={handleAddToCompare} 
                                onNuclideClick={handleNuclideSelection} 
                                showBackButton={true} 
                                onBackClick={() => handleNavClick(VIEWS.HOME)} 
                            />
                        </div>
                    );
                }
                return <HomePage errorMessage={errorMessage} randomSuggestions={randomSuggestions} searchHistory={searchHistory} handleNuclideSelection={handleNuclideSelection} handleClearHistory={handleClearHistory} favorites={favorites} radionuclides={radionuclides} handleClearFavorites={handleClearFavorites} onNavClick={handleNavClick} />;
            case VIEWS.MEDICAL:return <MedicalCalculator radionuclides={radionuclides} />;
            case VIEWS.SCRATCHPAD: return ( <div className="p-4 animate-fade-in"><div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 dark:text-white">Scratchpad</h2><Tooltip text="Open in New Window" widthClass="w-auto"><button onClick={() => setShowScratchpadPopout(true)} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.popOut} className="w-5 h-5" /></button></Tooltip></div><Scratchpad /></div></div> );
            case VIEWS.SCIENTIFIC_CALCULATOR: return ( <div className="p-4 animate-fade-in"><div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 dark:text-white">Scientific Calculator</h2><Tooltip text="Open in New Window" widthClass="w-auto"><button onClick={() => setShowCalcPopout(true)} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.popOut} className="w-5 h-5" /></button></Tooltip></div><ScientificCalculator calcState={scientificCalculatorState} setCalcState={setScientificCalculatorState} /></div></div> );
            case VIEWS.REFERENCES: return <ReferencesPage />;
            case VIEWS.HOME: 
            default: 
                return <HomePage errorMessage={errorMessage} randomSuggestions={randomSuggestions} searchHistory={searchHistory} handleNuclideSelection={handleNuclideSelection} handleClearHistory={handleClearHistory} favorites={favorites} radionuclides={radionuclides} handleClearFavorites={handleClearFavorites} onNavClick={handleNavClick} />;
        }
    };
    
    return (
        <div className="min-h-screen p-0 sm:p-2 md:p-4 text-slate-800 dark:text-slate-200">
            <div className="max-w-7xl mx-auto bg-white dark:bg-slate-900/70 rounded-none sm:rounded-2xl shadow-2xl backdrop-blur-lg border-slate-200 dark:border-slate-800">
                <Header onHelpClick={() => setIsManualOpen(true)} theme={theme} toggleTheme={toggleTheme} onNavClick={handleNavClick} />
                <SearchBar 
                    nuclideName={nuclideName} 
                    inputRef={inputRef} 
                    handleNuclideNameChange={handleNuclideNameChange} 
                    handleKeyDown={handleKeyDown} 
                    onClear={handleClearSearch} 
                    suggestions={suggestions} 
                    activeSuggestionIndex={activeSuggestionIndex} 
                    suggestionsRef={suggestionsRef} 
                    handleNuclideSelection={handleNuclideSelection} 
                    onNavClick={handleNavClick}
                    isFocused={isSearchFocused}
                    onFocus={handleSearchFocus}
                    onBlur={handleSearchBlur}
                />
                <MainNav activeView={activeView} onNavClick={handleNavClick} />
                <main ref={mainContentRef} className="min-h-[400px]">{renderActiveView()}</main>
                <footer className="text-center p-6 mt-4 border-t border-slate-200 dark:border-slate-700">
                    <p className="text-xs text-slate-500 dark:text-slate-400"><strong>Disclaimer:</strong> This tool is for informational and educational purposes only. The data and calculations have not been validated and may contain errors. Use of this tool is at your own risk.</p>
                    <div className="mt-4 flex justify-center md:hidden"><a href="https://www.buymeacoffee.com/jough" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} /></a></div>
                </footer>
                <ManualModal isOpen={isManualOpen} onClose={() => setIsManualOpen(false)} />
    
                {showCalcPopout && (
                    <PopoutWindow 
                        title="Scientific Calculator" 
                        onClose={() => setShowCalcPopout(false)}
                        height={850}
                    >
                        <div className={`${theme} bg-slate-100 dark:bg-slate-900 h-full p-4`}>
                            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Scientific Calculator</h2>
                                <ScientificCalculator calcState={scientificCalculatorState} setCalcState={setScientificCalculatorState} />
                            </div>
                        </div>
                    </PopoutWindow>
                )}
                
                {showScratchpadPopout && (
                    <PopoutWindow 
                        title="Scratchpad" 
                        onClose={() => setShowScratchpadPopout(false)}
                        width={800} 
                        height={660}
                    >
                        <div className={`${theme} bg-slate-100 dark:bg-slate-900 h-full p-4`}>
                            <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col h-full">
                                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Scratchpad</h2>
                                <div className="flex-grow flex flex-col">
                                   <Scratchpad />
                                </div>
                            </div>
                        </div>
                    </PopoutWindow>
                )}
            </div>
        </div>
    );
};
 
         /**
         * @description A searchable dropdown component for selecting items from a large list.
         */
         
         const SearchableSelect = ({ options, onSelect, placeholder }) => {
         
         const [inputValue, setInputValue] = React.useState('');
         const [isOpen, setIsOpen] = React.useState(false);
         const [activeIndex, setActiveIndex] = React.useState(-1);
         const containerRef = React.useRef(null);
         const listRef = React.useRef(null);
         
         const handleClear = () => {
         setInputValue('');
         setIsOpen(false);
         setActiveIndex(-1);
         };
         
         const filteredOptions = React.useMemo(() => {
         if (!inputValue) return [];
         const normInput = normalizeString(inputValue);
         const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 };
         
         return options
             .filter(opt => normalizeString(opt.name).includes(normInput) || normalizeString(opt.symbol).includes(normInput))
             .sort((a, b) => {
                 const aStartsWith = normalizeString(a.name).startsWith(normInput) || normalizeString(a.symbol).startsWith(normInput);
                 const bStartsWith = normalizeString(b.name).startsWith(normInput) || normalizeString(b.symbol).startsWith(normInput);
                 if (aStartsWith !== bStartsWith) return aStartsWith ? -1 : 1;
                 const orderA = commonalityOrder[a.commonality] || 0;
                 const orderB = commonalityOrder[b.commonality] || 0;
                 if (orderB !== orderA) return orderB - orderA;
                 return a.name.localeCompare(b.name);
             })
             .slice(0, 10);
         }, [inputValue, options]);
         
         React.useEffect(() => {
         const handleClickOutside = (event) => {
             if (containerRef.current && !containerRef.current.contains(event.target)) {
                 setIsOpen(false);
             }
         };
         document.addEventListener('mousedown', handleClickOutside);
         return () => document.removeEventListener('mousedown', handleClickOutside);
         }, []);
         
         const handleKeyDown = (e) => {
         if (filteredOptions.length === 0) return;
         if (e.key === 'ArrowDown') {
             e.preventDefault();
             setActiveIndex(prev => (prev < filteredOptions.length - 1 ? prev + 1 : 0));
         } else if (e.key === 'ArrowUp') {
             e.preventDefault();
             setActiveIndex(prev => (prev > 0 ? prev - 1 : filteredOptions.length - 1));
         } else if (e.key === 'Enter') {
             if (activeIndex > -1 && filteredOptions[activeIndex]) {
                 handleSelect(filteredOptions[activeIndex]);
             } else if (filteredOptions.length > 0) {
                 handleSelect(filteredOptions[0]);
             }
         } else if (e.key === 'Escape') {
             setIsOpen(false);
         }
         };
         
         React.useEffect(() => {
         if (activeIndex !== -1 && listRef.current?.children[activeIndex]) {
             listRef.current.children[activeIndex].scrollIntoView({ block: 'nearest' });
         }
         }, [activeIndex]);
         
         const handleSelect = (option) => {
         onSelect(option.symbol);
         setInputValue('');
         setIsOpen(false);
         setActiveIndex(-1);
         };
         
         return (
         <div className="relative w-full" ref={containerRef}>
         <div className="relative">
         <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <Icon path={ICONS.search} className="w-5 h-5 text-slate-400" />
         </div>
         <input
             type="text"
             value={inputValue}
             onChange={(e) => {
                 setInputValue(e.target.value);
                 setIsOpen(true);
                 setActiveIndex(-1);
             }}
             onKeyDown={handleKeyDown}
             onFocus={() => { if(inputValue) setIsOpen(true); }}
             placeholder={placeholder}
             className="w-full p-2 pl-10 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"
             autoComplete="off"
         />
         
         {inputValue && (
             <button
                 onClick={handleClear}
                 className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-sky-500 focus:outline-none"
             >
                 <Icon path={ICONS.clear} className="w-5 h-5" />
             </button>
         )}
         </div>
         {isOpen && filteredOptions.length > 0 && (
                 <ul ref={listRef} className="absolute z-30 w-full mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-72 overflow-y-auto">
                     {filteredOptions.map((option, index) => {
                         const styles = CATEGORY_STYLES[option.category] || CATEGORY_STYLES['default'];
                         return (
                             <li
                                 key={option.symbol}
                                 onClick={() => handleSelect(option)}
                                 onMouseEnter={() => setActiveIndex(index)}
                                 className={`p-3 pl-4 cursor-pointer text-slate-700 dark:text-slate-200 border-l-2 ${styles.border} ${styles.hoverBg} ${
                                     index === activeIndex ? 'bg-sky-100 dark:bg-sky-900/50' : ''
                                 }`}
                             >
                                 {option.name} ({option.symbol})
                             </li>
                         )
                     })}
                     {/* MODIFIED: Conditionally render the footer */}
                     {filteredOptions.length > 4 && (
                         <div className="sticky bottom-0 bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm p-2 border-t border-slate-200 dark:border-slate-700">
                             <div className="flex flex-wrap justify-center gap-x-3 gap-y-1">
                                 {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                     const bgColor = styles.border.replace('border-l-', 'bg-');
                                     return (
                                         <div key={category} className="flex items-center gap-1.5">
                                             <div className={`w-2.5 h-2.5 rounded-full ${bgColor}`}></div>
                                             <span className="text-xs text-slate-500 dark:text-slate-400">{category.replace('/', '/ ')}</span>
                                         </div>
                                     );
                                 })}
                             </div>
                         </div>
                     )}
                 </ul>
             )}
         </div>
         );
         };
         
         /**
         * @description An advanced view for comparing multiple radionuclides side-by-side.
         * Features dynamic highlighting, in-cell data bars, and an integrated
         * percentage difference tag when comparing two nuclides.
         */
         
         const ComparisonView = ({ radionuclides, onNuclideClick, comparisonList, onAddToCompare, onRemoveFromCompare, onClearCompare }) => {
         
         const [isModalOpen, setIsModalOpen] = React.useState(false);
         
         // This array MUST be defined INSIDE the component to access its props.
         
         const propertiesToCompare = [
         { label: 'Half-life (seconds)', key: 'halfLife', type: 'numeric', format: (val) => parseHalfLifeToSeconds(val) },
         { label: 'Emission Type(s)', key: 'emissionType', type: 'categorical', format: (val) => val?.join(', ') || 'N/A' },
         { label: 'Alpha Energy (MeV)', key: 'emissionEnergies', type: 'numeric', format: (val) => parseEnergyToMeV(val?.alpha) },
         { label: 'Beta Energy (MeV)', key: 'emissionEnergies', type: 'numeric', format: (val) => parseEnergyToMeV(val?.beta) },
         { label: 'Gamma Energy (MeV)', key: 'emissionEnergies', type: 'numeric', format: (val) => parseEnergyToMeV(val?.gamma) },
         { label: 'Specific Activity (Bq/g)', key: 'specificActivity', type: 'numeric', format: (val) => parseSpecificActivity(val) },
         { label: 'Gamma Constant', key: 'gammaConstant', type: 'numeric', format: (val) => parseFloat(val) },
         { label: 'ALI (Ingestion, µCi)', key: 'dosimetry', type: 'numeric', format: (val) => val?.ALI?.ingestion },
         { label: 'ALI (Inh. Class W, µCi)', key: 'dosimetry', type: 'numeric', format: (val) => val?.ALI?.inhalation_W },
         { label: 'DAC (Inh. Class W, µCi/mL)', key: 'dosimetry', type: 'numeric', format: (val) => val?.DAC?.inhalation_W },
         { label: 'A₁ Limit (TBq)', key: 'shipping', type: 'numeric', format: (val) => val?.A1 },
         { label: 'A₂ Limit (TBq)', key: 'shipping', type: 'numeric', format: (val) => val?.A2 },
         // The 'render' functions now have access to the 'radionuclides' and 'onNuclideClick' props.
         { label: 'Parent', key: 'parent', type: 'categorical', render: (nuclide) => <ClickableNuclide text={nuclide.parent} radionuclides={radionuclides} onNuclideClick={onNuclideClick} /> },
         { label: 'Daughter', key: 'daughter', type: 'categorical', render: (nuclide) => <ClickableNuclide text={nuclide.daughter} radionuclides={radionuclides} onNuclideClick={onNuclideClick} /> },
         ];
         
         const sortedNuclides = React.useMemo(() =>
         [...radionuclides].sort((a, b) => a.name.localeCompare(b.name)),
         [radionuclides]
         );
         
         const handleAddNuclide = (symbol) => {
         onAddToCompare(symbol);
         };
         
         const handleExportToCSV = (properties, nuclides) => {
         const headers = ['Property', ...nuclides.map(n => n.name)];
         
         const rows = properties.map(prop => {
             const rowData = [prop.label];
             nuclides.forEach(nuclide => {
                 let formattedValue;
                 // Handle renderable props differently for CSV export
                 if (prop.render) {
                     formattedValue = nuclide[prop.key] || 'N/A';






                 } else {
                     const rawValue = prop.key === 'emissionEnergies' ? nuclide.emissionEnergies : nuclide[prop.key];
                     formattedValue = prop.format ? prop.format(rawValue) : (rawValue || 'N/A');
                 }
         
                 if (typeof formattedValue === 'number' && !isNaN(formattedValue) && formattedValue !== Infinity) {
                     rowData.push(formattedValue.toExponential(3));
                 } else {
                     const cleanString = String(formattedValue).includes(',') ? `"${formattedValue}"` : formattedValue;
                     rowData.push(cleanString);
                 }
             });
             return rowData.join(',');
         });
         
         const csvContent = [headers.join(','), ...rows].join('\n');
         
         const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
         const link = document.createElement("a");
         if (link.download !== undefined) {
             const url = URL.createObjectURL(blob);
             link.setAttribute("href", url);
             link.setAttribute("download", "radionuclide_comparison.csv");
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
         }
         };
         
         const handleConfirmClear = () => {
         onClearCompare();
         setIsModalOpen(false);
         };
         
         return (
         <div className="p-4 animate-fade-in">
             <div className="max-w-7xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                 <div className="flex justify-between items-center mb-4">
                     <h2 className="text-xl font-bold text-slate-800 dark:text-white">Compare Radionuclides</h2>
                     <div className="flex items-center gap-2">
                         {comparisonList.length > 0 && (
                             <button
                                 onClick={() => setIsModalOpen(true)}
                                 className="px-3 py-2 text-sm bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition flex items-center gap-2"
                             >
                                 <Icon path={ICONS.clear} className="w-4 h-4" />
                                 Clear All
                             </button>
                         )}
                         {comparisonList.length > 0 && (
                             <button
                                 onClick={() => handleExportToCSV(propertiesToCompare, comparisonList)}
                                 className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2"
                             >
                                 <Icon path={ICONS.database} className="w-4 h-4" />
                                 Export to CSV
                             </button>
                         )}
                     </div>
                 </div>
         
                 <div className="flex items-center gap-2 mb-6 p-4 bg-slate-100 dark:bg-slate-800/50 rounded-lg">
                     <SearchableSelect
                         options={sortedNuclides.filter(n => !comparisonList.find(c => c.symbol === n.symbol))}
                         onSelect={handleAddNuclide}
                         placeholder="Search to add a nuclide..."/>
                 </div>
         
                 {comparisonList.length === 0 ? (
                     <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg">
                         <h3 className="text-lg font-semibold">The Comparison Table is Empty</h3>
                         <p className="text-slate-500 dark:text-slate-400 mt-2">Use the search box or a nuclide's detail card to add to the comparison.</p>
                     </div>
                 ) : (
                     <div className="overflow-x-auto">
                         <table className="w-full min-w-[600px] text-left border-collapse">
                             <thead>
                                 <tr>
                                     <th className="sticky left-0 bg-slate-50 dark:bg-slate-700 p-3 text-sm font-semibold z-10 border-b border-r border-slate-200 dark:border-slate-600">Property</th>
                                     {comparisonList.map(nuclide => (
                                         <th key={nuclide.symbol} className="sticky top-0 bg-slate-100 dark:bg-slate-800 p-3 text-sm font-semibold border-b border-slate-200 dark:border-slate-600">
                                             <div className="flex justify-between items-center">
                                                 <span className="cursor-pointer hover:text-sky-500" onClick={() => onNuclideClick(nuclide)}>{nuclide.name}</span>
                                                 <button onClick={() => onRemoveFromCompare(nuclide.symbol)} className="ml-2 text-red-400 hover:text-red-600 font-bold">✕</button>
                                             </div>
                                         </th>
                                     ))}
                                 </tr>
                             </thead>
                             <tbody>
                                 {propertiesToCompare.map(prop => {
                                     let values = [], maxVal = -Infinity, minVal = Infinity;
                                     if (prop.type === 'numeric') {
                                         values = comparisonList.map(nuclide => {
                                             const rawValue = prop.key === 'emissionEnergies' ? nuclide.emissionEnergies : nuclide[prop.key];
                                             const formattedVal = prop.format(rawValue);
                                             return isNaN(formattedVal) || formattedVal === Infinity ? null : formattedVal;
                                         }).filter(v => v !== null);
         
                                         if (values.length > 1) {
                                             maxVal = Math.max(...values);
                                             minVal = Math.min(...values);
                                         }
                                     }
         
                                     return (
                                         <tr key={prop.label} className="group hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                             <td className="sticky left-0 bg-white dark:bg-slate-800 group-hover:bg-slate-50 dark:group-hover:bg-slate-800/50 p-3 font-medium text-slate-500 dark:text-slate-400 border-b border-r border-slate-200 dark:border-slate-600 z-10">{prop.label}</td>
         
                                             {comparisonList.map((nuclide, nuclideIndex) => {
                                                 let cellContent;
                                                 let cellClass = 'border-b border-slate-200 dark:border-slate-600';
         
                                                 if (prop.render) {
                                                     cellContent = prop.render(nuclide);




} else {
                                             const rawValue = prop.key === 'emissionEnergies' ? nuclide.emissionEnergies : nuclide[prop.key];
                                             const formattedValue = prop.format ? prop.format(rawValue) : (rawValue || 'N/A');
                                             let displayValue = formattedValue; // This will hold the text for categorical props
                                             
                                             // --- FIX 1: Declare variables with 'let' in the outer scope ---
                                             let numericVal;
                                             let differenceTag = null;
                                             
                                             const barWidth = (prop.type === 'numeric' && maxVal > 0) ? (formattedValue / maxVal) * 100 : 0;

                                             if (prop.type === 'numeric') {
                                                 numericVal = parseFloat(formattedValue); // --- FIX 2: Assign to the outer variable ---

                                                 if (values.length > 1 && numericVal === maxVal && maxVal !== minVal) cellClass += ' bg-sky-100 dark:bg-sky-900/50 font-bold text-sky-800 dark:text-sky-200';
                                                 if (values.length > 1 && numericVal === minVal && maxVal !== minVal) cellClass += ' bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200';

                                                 // Corrected difference logic to use numericVal
                                                 if (comparisonList.length === 2 && nuclideIndex === 1) {
                                                     const val1 = values[0]; // Value from the first nuclide
                                                     if (val1 !== null && !isNaN(val1) && !isNaN(numericVal) && val1 !== 0) {
                                                         const diff = ((numericVal - val1) / val1) * 100;
                                                         const diffColor = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                         const sign = diff >= 0 ? '+' : '';
                                                         differenceTag = <span className={`block text-xs font-semibold mt-1 ${diffColor}`}>{`${sign}${diff.toFixed(1)}% vs. ${comparisonList[0].symbol}`}</span>;
                                                     }
                                                 }
                                             }
                                             
                                             // --- FIX 3: Conditionally render numeric formats OR categorical text ---
                                             cellContent = (
                                                 <>
                                                     {prop.type === 'numeric' && barWidth > 0 && <div className="absolute ..." style={{ width: `${barWidth}%` }}></div>}
                                                     <div className="relative">
                                                         {prop.type === 'numeric' ? (
                                                             <>
                                                                 <span className="md:hidden">
                                                                     {formatForMobile(numericVal)}
                                                                 </span>
                                                                 <span className="hidden md:inline">
                                                                     {isNaN(numericVal) || numericVal === Infinity ? 'N/A' : numericVal.toPrecision(6)}
                                                                 </span>
                                                             </>
                                                         ) : (
                                                             <span>{displayValue}</span> /* This just displays the raw string (e.g., "Alpha, Gamma") */
                                                         )}
                                                         {differenceTag}
                                                     </div>
                                                 </>
                                             );
                                         }


// Fixed code
return (
    <td key={nuclide.symbol} className={`${cellClass} p-3 relative`}>
        {cellContent}
    </td>
);

                                             })}
                                         </tr>
                                     );
                                 })}
                             </tbody>
                         </table>
                     </div>
                 )}
             </div>
         
             <ConfirmationModal
                 isOpen={isModalOpen}
                 onClose={() => setIsModalOpen(false)}
                 onConfirm={handleConfirmClear}
                 title="Clear Comparison List"
             >
                 <p>Are you sure you want to clear the entire comparison list? This action cannot be undone.</p>
             </ConfirmationModal>
         
         </div>
         );
         };
         
         const QuickNuclideSelector = ({ onSelect }) => {
         const commonNuclides = ['Cs-137', 'Co-60', 'Ir-192', 'Tc-99m', 'Am-241'];
         
         return (
         <div className="p-2 my-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg">
            <p className="text-xs text-center font-semibold text-slate-500 dark:text-slate-400 mb-2">
                Quick Select
            </p>
            <div className="flex flex-wrap justify-center gap-2">
                {commonNuclides.map(symbol => (
                    <button
                        key={symbol}
                        onClick={() => onSelect(symbol)}
                        className="px-3 py-1 text-sm bg-slate-200 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold"
                    >
                        {symbol}
                    </button>
                ))}
            </div>
         </div>
         );
         };
         
         /**
         * @description React component for a versatile dose and dose rate calculation suite.
         * This component functions as a multi-tool, allowing users to estimate dose from various
         * types of radiation and source geometries. It integrates with a pre-populated database
         * of radionuclide properties but also supports manual input for greater flexibility.
         *
         * The calculator provides four primary modes:
         * 1.  **Gamma:** Calculates dose rate from gamma-emitting sources in different geometries
         * (point, line, or area) using the specific gamma-ray constant and the inverse-square law,
         * with appropriate geometric corrections.
         * 2.  **Beta:** Estimates dose from beta sources in two sub-modes:
         * - **Skin Dose:** Calculates the absorbed dose at the skin surface from a
         * surface contamination.
         * - **Dose in Air:** Calculates the dose rate in air from a point source,
         * considering the beta particle's maximum range.
         * 3.  **Bremsstrahlung:** Calculates the dose rate from Bremsstrahlung (braking radiation)
         * produced when a beta source is shielded by a high-Z material.
         * 4.  **Internal:** Estimates the **Committed Effective Dose Equivalent (CEDE)** from a
         * known intake of a radionuclide, based on the **Annual Limit on Intake (ALI)**
         * values specified in 10 CFR 20 Appendix B.
         *
         * This component is a central hub for many fundamental dose and dose rate calculations,
         * simplifying complex radiological physics for practical application.
         *
         * @prop {array} radionuclides - A comprehensive array of all known radionuclides,
         * used as the data source for the calculator's modes.
         * @prop {string} preselectedNuclide - An optional prop to pre-fill the calculator with
         * a specific nuclide symbol from another part of the application (e.g., from the main
         * nuclide search).
         */
         
const DoseRateCalculator = ({ radionuclides, preselectedNuclide }) => {
    const CALC_MODE_GAMMA = 'gamma';
    const CALC_MODE_BETA = 'beta';
    const CALC_MODE_BREMS = 'bremsstrahlung';
    const CALC_MODE_INTERNAL = 'internal';
    const INPUT_MODE_DB = 'fromSource';
    const INPUT_MODE_MANUAL = 'manual';
    const GEOMETRY_POINT = 'point';
    const GEOMETRY_LINE = 'line';
    const GEOMETRY_AREA = 'area';
    const BETA_MODE_SKIN = 'skin';
    const BETA_MODE_AIR = 'air';
    
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const [calcMode, setCalcMode] = React.useState(() => localStorage.getItem('doseRate_calcMode') || CALC_MODE_GAMMA);
    const [inputMode, setInputMode] = React.useState(() => localStorage.getItem('doseRate_inputMode') || INPUT_MODE_DB);
    const [geometryMode, setGeometryMode] = React.useState(() => localStorage.getItem('doseRate_geometryMode') || GEOMETRY_POINT);
    const [activity, setActivity] = React.useState(() => localStorage.getItem('doseRate_activity') || '1');
    const [activityUnit, setActivityUnit] = React.useState(() => localStorage.getItem('doseRate_activityUnit') || 'mCi');
    const [distance, setDistance] = React.useState(() => localStorage.getItem('doseRate_distance') || '1');
    const [distanceUnit, setDistanceUnit] = React.useState(() => localStorage.getItem('doseRate_distanceUnit') || 'm');
    const [lineLength, setLineLength] = React.useState(() => localStorage.getItem('doseRate_lineLength') || '1');
    const [lineLengthUnit, setLineLengthUnit] = React.useState(() => localStorage.getItem('doseRate_lineLengthUnit') || 'm');
    const [diskRadius, setDiskRadius] = React.useState(() => localStorage.getItem('doseRate_diskRadius') || '10');
    const [diskRadiusUnit, setDiskRadiusUnit] = React.useState(() => localStorage.getItem('doseRate_diskRadiusUnit') || 'cm');
    const [shieldMaterial, setShieldMaterial] = React.useState(() => localStorage.getItem('doseRate_shieldMaterial') || 'Plastic');
    const [linearActivityUnit, setLinearActivityUnit] = React.useState(() => localStorage.getItem('doseRate_linearActivityUnit') || 'mCi/m');
    const [arealActivityUnit, setArealActivityUnit] = React.useState(() => localStorage.getItem('doseRate_arealActivityUnit') || 'µCi/cm²');
    const [intakeRoute, setIntakeRoute] = React.useState(() => localStorage.getItem('doseRate_intakeRoute') || 'inhalation');
    const [solubility, setSolubility] = React.useState(() => localStorage.getItem('doseRate_solubility') || '');
    const [intakeAmount, setIntakeAmount] = React.useState(() => localStorage.getItem('doseRate_intakeAmount') || '1');
    const [intakeUnit, setIntakeUnit] = React.useState(() => localStorage.getItem('doseRate_intakeUnit') || 'µCi');
    const [nuclideSymbol, setNuclideSymbol] = React.useState(() => localStorage.getItem('doseRate_nuclideSymbol') || '');
    const [manualGammaConstant, setManualGammaConstant] = React.useState(() => localStorage.getItem('doseRate_manualGammaConstant') || '');
    const [manualBetaEnergy, setManualBetaEnergy] = React.useState(() => localStorage.getItem('doseRate_manualBetaEnergy') || '');
    const [betaMode, setBetaMode] = React.useState(() => localStorage.getItem('doseRate_betaMode') || BETA_MODE_SKIN);
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    const isInitialMount = React.useRef(true);
    
    React.useEffect(() => {
    localStorage.setItem('doseRate_calcMode', calcMode);
    localStorage.setItem('doseRate_inputMode', inputMode);
    localStorage.setItem('doseRate_geometryMode', geometryMode);
    localStorage.setItem('doseRate_activity', activity);
    localStorage.setItem('doseRate_activityUnit', activityUnit);
    localStorage.setItem('doseRate_distance', distance);
    localStorage.setItem('doseRate_distanceUnit', distanceUnit);
    localStorage.setItem('doseRate_lineLength', lineLength);
    localStorage.setItem('doseRate_lineLengthUnit', lineLengthUnit);
    localStorage.setItem('doseRate_diskRadius', diskRadius);
    localStorage.setItem('doseRate_diskRadiusUnit', diskRadiusUnit);
    localStorage.setItem('doseRate_shieldMaterial', shieldMaterial);
    localStorage.setItem('doseRate_linearActivityUnit', linearActivityUnit);
    localStorage.setItem('doseRate_arealActivityUnit', arealActivityUnit);
    localStorage.setItem('doseRate_intakeRoute', intakeRoute);
    localStorage.setItem('doseRate_solubility', solubility);
    localStorage.setItem('doseRate_intakeAmount', intakeAmount);
    localStorage.setItem('doseRate_intakeUnit', intakeUnit);
    localStorage.setItem('doseRate_nuclideSymbol', nuclideSymbol);
    localStorage.setItem('doseRate_manualGammaConstant', manualGammaConstant);
    localStorage.setItem('doseRate_manualBetaEnergy', manualBetaEnergy);
    localStorage.setItem('doseRate_betaMode', betaMode);
    }, [ calcMode, inputMode, geometryMode, activity, activityUnit, distance, distanceUnit, lineLength, lineLengthUnit, diskRadius, diskRadiusUnit, shieldMaterial, linearActivityUnit, arealActivityUnit, intakeRoute, solubility, intakeAmount, intakeUnit, nuclideSymbol, manualGammaConstant, manualBetaEnergy, betaMode ]);
    
    const activityFactorsCi = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1, 'dps': 1 / 3.7e10, 'dpm': 1 / (3.7e10 * 60) };
    const distanceFactorsM = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048, 'km': 1000 };
    const linearActivityFactorsCi_per_m = { 'µCi/cm': 1e-4, 'mCi/cm': 0.1, 'Ci/cm': 100, 'µCi/m': 1e-6, 'mCi/m': 1e-3, 'Ci/m': 1 };
    const arealActivityFactorsCi_per_m2 = { 'µCi/cm²': 0.01, 'mCi/cm²': 10, 'Ci/cm²': 10000, 'µCi/m²': 1e-6, 'mCi/m²': 1e-3, 'Ci/m²': 1 };
    const intakeUnitFactors = { 'pCi': 1e-6, 'nCi': 1e-3, 'µCi': 1, 'mCi': 1000, 'Bq': 1/37000, 'kBq': 1/37 };
    const concentrationFactors_uCi_per_cm2 = { 'µCi/cm²': 1, 'mCi/cm²': 1000, 'Ci/cm²': 1e6, 'Bq/cm²': 1 / 37000 };
    const concentrationUnits_ordered = ['Bq/cm²', 'µCi/cm²', 'mCi/cm²', 'Ci/cm²'];
    const activityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'µCi', 'mCi', 'Ci'];
    const distanceUnits_ordered = ['mm', 'cm', 'm', 'in', 'ft'];
    const linearActivityUnits_ordered = ['µCi/cm', 'mCi/cm', 'Ci/cm', 'µCi/m', 'mCi/m', 'Ci/m'];
    const arealActivityUnits_ordered = ['µCi/cm²', 'mCi/cm²', 'Ci/cm²', 'µCi/m²', 'mCi/m²', 'Ci/m²'];
    const intakeUnits_ordered = ['pCi', 'nCi', 'µCi', 'mCi', 'Bq', 'kBq'];
    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const betaNuclides = React.useMemo(() => radionuclides.filter(n => n.emissionEnergies?.beta?.length > 0 || n.daughterEmissions?.beta?.length > 0).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const dosimetryNuclides = React.useMemo(() => radionuclides.filter(n => n.dosimetry?.ALI).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    
    const availableNuclides = React.useMemo(() => {
    switch (calcMode) {
       case CALC_MODE_GAMMA: return gammaNuclides;
       case CALC_MODE_BETA: case CALC_MODE_BREMS: return betaNuclides;
       case CALC_MODE_INTERNAL: return dosimetryNuclides;
       default: return [];
    }
    }, [calcMode, gammaNuclides, betaNuclides, dosimetryNuclides]);
    
    const selectedNuclide = React.useMemo(() => radionuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, radionuclides]);
    const availableClasses = React.useMemo(() => {
    if (!selectedNuclide || !selectedNuclide.dosimetry?.ALI) return [];
    return Object.keys(selectedNuclide.dosimetry?.ALI).filter(k => k.startsWith('inhalation_')).map(k => k.split('_')[1]);
    }, [selectedNuclide]);
    
    React.useEffect(() => {
    if (isInitialMount.current) { isInitialMount.current = false; return; }
    setNuclideSymbol(''); setResult(null); setError(''); setInputMode(INPUT_MODE_DB);
    setManualGammaConstant(''); setManualBetaEnergy(''); setBetaMode(BETA_MODE_SKIN);
    if (calcMode === CALC_MODE_BETA) { setActivityUnit('µCi/cm²'); } 
    else { setActivityUnit('mCi'); }
    }, [calcMode]);
    
React.useEffect(() => {
    // If a nuclide is selected but it's not in the list of available nuclides for the current mode...
    if (nuclideSymbol && !availableNuclides.find(n => n.symbol === nuclideSymbol)) {
        setNuclideSymbol(''); // ...clear the invalid selection.
    }
}, [calcMode, availableNuclides, nuclideSymbol]);

    React.useEffect(() => {
    if (preselectedNuclide) {
       const isGamma = gammaNuclides.some(n => n.symbol === preselectedNuclide);
       const isBeta = betaNuclides.some(n => n.symbol === preselectedNuclide);
       if (isGamma) { setCalcMode(CALC_MODE_GAMMA); setNuclideSymbol(preselectedNuclide); } 
       else if (isBeta) { setCalcMode(CALC_MODE_BETA); setNuclideSymbol(preselectedNuclide); }
    }
    }, [preselectedNuclide, gammaNuclides, betaNuclides]);
    
    React.useEffect(() => {
    if (calcMode === CALC_MODE_INTERNAL && intakeRoute === 'inhalation' && availableClasses.length > 0) {
       if (!availableClasses.includes(solubility)) { setSolubility(availableClasses[0]); }
    } else { setSolubility(''); }
    }, [calcMode, intakeRoute, availableClasses, solubility]);
    
    React.useEffect(() => {
    if (!isInitialMount.current) {
       if (geometryMode === GEOMETRY_POINT) { setActivityUnit('mCi'); } 
       else if (geometryMode === GEOMETRY_LINE) { setLinearActivityUnit('mCi/m'); } 
       else if (geometryMode === GEOMETRY_AREA) { setArealActivityUnit('µCi/cm²'); }
    }
    }, [geometryMode]);
    
    // --- THIS IS THE CORRECTED CALCULATION LOGIC ---
    React.useEffect(() => {
    try {
       setError(''); setResult(null);
       const activityValue = parseFloat(activity);
       const distanceValue = parseFloat(distance);
       switch (calcMode) {
           case CALC_MODE_GAMMA: {
               let gammaConstant;
               if (inputMode === INPUT_MODE_DB) {
                   if (!selectedNuclide) throw new Error('Please select a radionuclide or switch to Manual Input.');
                   if (!selectedNuclide.gammaConstant) throw new Error(`${selectedNuclide.name} has no gamma constant defined.`);
                   gammaConstant = parseFloat(selectedNuclide.gammaConstant);
               } else {
                   gammaConstant = parseFloat(manualGammaConstant);
                   if (isNaN(gammaConstant) || gammaConstant <= 0) throw new Error('Please enter a valid, positive Gamma Constant.');
               }
               if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0) throw new Error('Invalid activity or distance.');
               const distanceInM = distanceValue * distanceFactorsM[distanceUnit];
               let doseRateR_hr = 0;
               switch (geometryMode) {
                   case GEOMETRY_POINT: { const activityInCi = activityValue * activityFactorsCi[activityUnit]; doseRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2); break; }
                   case GEOMETRY_LINE: { const len_val = parseFloat(lineLength); if (isNaN(len_val) || len_val <= 0) throw new Error('Line length must be a positive number.'); const len_m = len_val * distanceFactorsM[lineLengthUnit]; const linearActivityCi_per_m = activityValue * linearActivityFactorsCi_per_m[linearActivityUnit]; doseRateR_hr = ((2 * gammaConstant * linearActivityCi_per_m) / distanceInM) * Math.atan(len_m / (2 * distanceInM)); break; }
                   case GEOMETRY_AREA: { const rad_val = parseFloat(diskRadius); if (isNaN(rad_val) || rad_val <= 0) throw new Error('Disk radius must be a positive number.'); const rad_m = rad_val * distanceFactorsM[diskRadiusUnit]; const arealActivityCi_per_m2 = activityValue * arealActivityFactorsCi_per_m2[arealActivityUnit]; doseRateR_hr = Math.PI * gammaConstant * arealActivityCi_per_m2 * Math.log(1 + Math.pow(rad_m / distanceInM, 2)); break; }
               }
               const doseRate_mrem_hr = doseRateR_hr * 1000;
               const newResult = { type: 'gamma', dose: formatSensibleUnit(doseRate_mrem_hr, 'doseRate') };
               setResult(newResult);
               break;
           }
           case CALC_MODE_BETA:
           case CALC_MODE_BREMS: {
               let E_max, E_avg, effectiveSourceName = null;
               if (inputMode === INPUT_MODE_DB) {
                   if (!selectedNuclide) throw new Error('Please select a radionuclide or switch to Manual Input.');
                   
                   let effectiveBetaSource = selectedNuclide;
                   // Check if there's a daughter with a significant beta emission (like Sr-90 -> Y-90)
                   if (selectedNuclide.daughterEmissions?.beta?.length > 0) {
                       const daughter = radionuclides.find(n => n.symbol === selectedNuclide.daughterEmissions.from);
                       if (daughter) {
                           effectiveBetaSource = daughter;
                           effectiveSourceName = daughter.name;
                       }
                   }
                   
                   if (!effectiveBetaSource.emissionEnergies?.beta?.length > 0) throw new Error(`${selectedNuclide.name} and its daughter have no significant beta emissions defined.`);
                   E_max = parseEnergyToMeV(effectiveBetaSource.emissionEnergies.beta);
                   E_avg = parseFloat(effectiveBetaSource.avgBetaEnergy);
                   if(isNaN(E_avg)) { E_avg = E_max / 3; }

               } else { // Manual Mode
                   E_max = parseFloat(manualBetaEnergy); 
                   if (isNaN(E_max) || E_max <= 0) throw new Error('Please enter a valid, positive Max Beta Energy.'); 
                   E_avg = E_max / 3; 
               }
               if (isNaN(activityValue) || (betaMode === BETA_MODE_AIR && (isNaN(distanceValue) || distanceValue <= 0)) || activityValue < 0) throw new Error('Invalid activity or distance.');
               if (calcMode === CALC_MODE_BETA) {
                   if (betaMode === BETA_MODE_SKIN) {
                       const concentration_uCi_per_cm2 = activityValue * concentrationFactors_uCi_per_cm2[activityUnit];
                       const doseRate_rad_hr = 2.13 * concentration_uCi_per_cm2 * E_avg;
                       const doseRate_mrem_hr = doseRate_rad_hr * 1000;
                       const newResult = { type: 'beta_skin', dose: formatSensibleUnit(doseRate_mrem_hr, 'doseRate'), e_max: E_max, sourceNote: effectiveSourceName };
                       setResult(newResult);
                   } else { // Dose in Air
                       const activityInCi = activityValue * activityFactorsCi[activityUnit]; 
                       const distance_cm = (distanceValue * distanceFactorsM[distanceUnit]) * 100;
                       let range_m; 
                       if (E_max > 0.6) { range_m = (E_max - 0.25) / 1.83; } 
                       else { const range_mg_cm2 = 407 * Math.pow(E_max, 1.38); range_m = (range_mg_cm2 / 1.225) / 100; }
                       const range_cm = range_m * 100; 
                       let doseRate_mrem_hr = 0; 
                       if (distance_cm < range_cm) { 
                           const doseRate_rad_hr = (400 * (activityInCi * 1000) * E_avg) / Math.pow(distance_cm, 2); 
                           doseRate_mrem_hr = doseRate_rad_hr * 1000; 
                       }
                       const newResult = { type: 'beta_air', dose: formatSensibleUnit(doseRate_mrem_hr, 'doseRate'), e_max: E_max, isBeyondRange: distance_cm >= range_cm, range_m: range_m.toPrecision(2), range_ft: (range_m * 3.28084).toPrecision(2), sourceNote: effectiveSourceName };
                       setResult(newResult);
                   }
               } else { // Bremsstrahlung
                   const activityInCi = activityValue * activityFactorsCi[activityUnit]; const distanceInM = distanceValue * distanceFactorsM[distanceUnit];
                   const Z = SHIELDING_MATERIALS[shieldMaterial].Z; const doseRate_rad_hr_at_1m = 0.57 * activityInCi * Z * Math.pow(E_max, 2);
                   const doseRate_rad_hr = doseRate_rad_hr_at_1m / Math.pow(distanceInM, 2); const doseRate_mrem_hr = doseRate_rad_hr * 1000; const f = 3.5e-4 * Z * E_max;
                   const newResult = { type: 'bremsstrahlung', dose: formatSensibleUnit(doseRate_mrem_hr, 'doseRate'), bremsstrahlungFraction: (f * 100).toPrecision(2), sourceNote: effectiveSourceName };
                   setResult(newResult);
               }
               break;
           }
           case CALC_MODE_INTERNAL: {
               if (!selectedNuclide) { throw new Error("Please select a radionuclide for internal dose calculation.")}
               const intake = parseFloat(intakeAmount); if (isNaN(intake) || intake < 0) throw new Error('Invalid intake amount.');
               const intakeInMuCi = intake * intakeUnitFactors[intakeUnit]; let aliKey = intakeRoute === 'ingestion' ? 'ingestion' : `inhalation_${solubility}`;
               const ALI = selectedNuclide.dosimetry.ALI[aliKey]; if (!ALI) throw new Error(`ALI value for ${aliKey} not found for this nuclide.`);
               const cede_mrem = (intakeInMuCi / ALI) * 5000;
               const newResult = { type: 'internal', dose: formatSensibleUnit(cede_mrem, 'dose') };
               setResult(newResult);
               break;
           }
           default: throw new Error("Calculation mode not implemented.");
       }
    } catch (e) { setError(e.message); }
    }, [ nuclideSymbol, calcMode, inputMode, manualGammaConstant, manualBetaEnergy, geometryMode, activity, activityUnit, linearActivityUnit, arealActivityUnit, distance, distanceUnit, lineLength, lineLengthUnit, diskRadius, diskRadiusUnit, shieldMaterial, intakeRoute, solubility, intakeAmount, intakeUnit, betaMode, radionuclides ]); // Added radionuclides to dependency array
    
    const handleSaveToHistory = () => {
        if (!result) return;
        let historyEntry = { id: Date.now(), view: VIEWS.DOSE_RATE };
        switch(result.type) {
            case 'gamma':
                historyEntry.type = 'Gamma Dose Rate';
                historyEntry.icon = ICONS.doseRate;
                historyEntry.inputs = `${activity} ${activityUnit} at ${distance} ${distanceUnit}`;
                historyEntry.result = `${result.dose.value} ${result.dose.unit}`;
                break;
            case 'beta_skin':
                historyEntry.type = 'Beta Skin Dose';
                historyEntry.icon = ICONS.doseRate;
                historyEntry.inputs = `${activity} ${activityUnit}`;
                historyEntry.result = `${result.dose.value} ${result.dose.unit}`;
                break;
            case 'beta_air':
                 historyEntry.type = 'Beta Air Dose';
                 historyEntry.icon = ICONS.doseRate;
                 historyEntry.inputs = `${activity} ${activityUnit} at ${distance} ${distanceUnit}`;
                 historyEntry.result = `${result.dose.value} ${result.dose.unit}`;
                 break;
            case 'bremsstrahlung':
                historyEntry.type = 'Bremsstrahlung Dose';
                historyEntry.icon = ICONS.shield;
                historyEntry.inputs = `${activity} ${activityUnit} behind ${shieldMaterial}`;
                historyEntry.result = `${result.dose.value} ${result.dose.unit}`;
                break;
            case 'internal':
                historyEntry.type = 'Internal Dose (CEDE)';
                historyEntry.icon = ICONS.internalDose;
                historyEntry.inputs = `${intakeAmount} ${intakeUnit} via ${intakeRoute}`;
                historyEntry.result = `${result.dose.value} ${result.dose.unit}`;
                break;
        }
        addHistory(historyEntry);
        addToast("Calculation saved to history!");
    };
    
    const resultTitles = { 'gamma': 'Gamma Dose Rate', 'beta_skin': 'Beta Skin Dose (Surface)', 'beta_air': 'Beta Dose in Air (Point)', 'bremsstrahlung': 'Bremsstrahlung Dose Rate', 'internal': 'Committed Effective Dose (CEDE)' };
    const handleNuclideSelect = React.useCallback((symbol) => {
    setNuclideSymbol(symbol); const nuclideToSet = availableNuclides.find(n => n.symbol === symbol);
    if (nuclideToSet && nuclideToSet.dosimetry) {
       setIntakeRoute('inhalation'); const newAvailableClasses = Object.keys(nuclideToSet.dosimetry?.ALI || {}).filter(k => k.startsWith('inhalation_')).map(k => k.split('_')[1]);
       if (newAvailableClasses.length > 0) { setSolubility(newAvailableClasses[0]); } else { setSolubility(''); }
    } else { setSolubility(''); setIntakeRoute('inhalation'); }
    }, [availableNuclides]);
    
const handleClearInputs = () => {
    setCalcMode(CALC_MODE_GAMMA);
    setInputMode(INPUT_MODE_DB);
    setGeometryMode(GEOMETRY_POINT);
    setActivity('1');
    setActivityUnit('mCi');
    setDistance('1');
    setDistanceUnit('m');
    setLineLength('1');
    setLineLengthUnit('m');
    setDiskRadius('10');
    setDiskRadiusUnit('cm');
    setShieldMaterial('Plastic');
    setLinearActivityUnit('mCi/m');
    setArealActivityUnit('µCi/cm²');
    setIntakeRoute('inhalation');
    setSolubility('');
    setIntakeAmount('1');
    setIntakeUnit('µCi');
    setNuclideSymbol('');
    setManualGammaConstant('');
    setManualBetaEnergy('');
    setBetaMode(BETA_MODE_SKIN);
    setResult(null);
    setError('');
};
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Dose Calculator</h2>
               <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                   <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
               </button>
           </div>
           <div className="grid grid-cols-2 md:grid-cols-4 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
               <button onClick={() => setCalcMode(CALC_MODE_GAMMA)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === CALC_MODE_GAMMA ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Gamma</button>
               <button onClick={() => setCalcMode(CALC_MODE_BETA)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === CALC_MODE_BETA ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Beta</button>
               <button onClick={() => setCalcMode(CALC_MODE_BREMS)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === CALC_MODE_BREMS ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Brems.</button>
               <button onClick={() => setCalcMode(CALC_MODE_INTERNAL)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === CALC_MODE_INTERNAL ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Internal</button>
           </div>
           <div className="space-y-3">
               {(calcMode === CALC_MODE_GAMMA || calcMode === CALC_MODE_BETA || calcMode === CALC_MODE_BREMS) && (
                   <div className="p-2 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3">
                       <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
                           <button onClick={() => setInputMode(INPUT_MODE_DB)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === INPUT_MODE_DB ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>From Database</button>
                           <button onClick={() => setInputMode(INPUT_MODE_MANUAL)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === INPUT_MODE_MANUAL ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Manual Input</button>
                       </div>
                       {inputMode === INPUT_MODE_DB ? (
                           <div className="animate-fade-in">
                               {selectedNuclide ? ( 
                                   <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => { setNuclideSymbol(''); }} /> 
                               ) : ( 
                                   <>
                                       <SearchableSelect options={availableNuclides} onSelect={handleNuclideSelect} placeholder={`Select a ${calcMode} emitter...`} />
                                       {calcMode === CALC_MODE_GAMMA && <QuickNuclideSelector onSelect={handleNuclideSelect} />}
                                   </>
                               )}
                           </div>
                       ) : (
                           <div className="animate-fade-in p-2">
                               <label className="block text-sm font-medium">{calcMode === CALC_MODE_GAMMA ? 'Gamma Constant (Γ)' : 'Max Beta Energy (Eₘₐₓ)'}</label>
                               <div className="relative">
                                   {calcMode === CALC_MODE_GAMMA ? (
                                       <input type="number" value={manualGammaConstant} onChange={e => setManualGammaConstant(e.target.value)} placeholder="e.g., 0.33 for Cs-137" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                                   ) : (
                                       <input type="number" value={manualBetaEnergy} onChange={e => setManualBetaEnergy(e.target.value)} placeholder="e.g., 2.28 for Y-90" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                                   )}
                                   <span className="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500 dark:text-slate-400">{calcMode === CALC_MODE_GAMMA ? 'R·m²/hr·Ci' : 'MeV'}</span>
                               </div>
                           </div>
                       )}
                   </div>
               )}
               {calcMode === CALC_MODE_INTERNAL && ( <>{selectedNuclide ? ( <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => { setNuclideSymbol(''); }} /> ) : ( <SearchableSelect options={dosimetryNuclides} onSelect={handleNuclideSelect} placeholder="Select an internal emitter..." /> )}</> )}
               {inputMode === INPUT_MODE_DB && selectedNuclide?.dosimetry && (<div className="p-3 my-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg animate-fade-in text-xs"><h4 className="font-semibold text-slate-500 dark:text-slate-400 mb-1">10 CFR 20 Appendix B Values:</h4><ul className="list-disc list-inside space-y-1">{selectedNuclide.dosimetry?.ALI && Object.entries(selectedNuclide.dosimetry.ALI).map(([key, val]) => (<li key={key}><span className="font-medium text-slate-700 dark:text-slate-200">ALI ({key.replace('inhalation_', 'Inh. ')}):</span><span className="text-slate-700 dark:text-slate-200">{val} µCi</span></li>))}{selectedNuclide.dosimetry?.DAC && Object.entries(selectedNuclide.dosimetry.DAC).map(([key, val]) => (<li key={key}><span className="font-medium text-slate-700 dark:text-slate-200">DAC ({key.replace('inhalation_', 'Inh. ')}):</span><span className="text-slate-700 dark:text-slate-200">{val.toExponential(2)} µCi/mL</span></li>))}</ul></div>)}
               {calcMode === CALC_MODE_BREMS && (<div className="space-y-3 animate-fade-in"><div><label className="block text-sm font-medium">Source Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div><div><label className="block text-sm font-medium">Distance to Source</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div><div><label className="block text-sm font-medium">Shield Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(SHIELDING_MATERIALS).map(m => <option key={m} value={m}>{m}</option>)}</select></div></div>)}
               {calcMode === CALC_MODE_BETA && (<div className="p-2 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3 animate-fade-in"><div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg"><button onClick={() => { setBetaMode(BETA_MODE_SKIN); setActivityUnit('µCi/cm²'); }} className={`p-2 rounded-md text-sm font-semibold transition-colors ${betaMode === BETA_MODE_SKIN ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Skin Dose (Surface)</button><button onClick={() => { setBetaMode(BETA_MODE_AIR); setActivityUnit('mCi'); }} className={`p-2 rounded-md text-sm font-semibold transition-colors ${betaMode === BETA_MODE_AIR ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dose in Air (Point)</button></div>

<ContextualNote>
                           <strong>Note:</strong> Beta dose calculations are based on standard empirical formulas and should be considered estimates for operational purposes.
                       </ContextualNote>

{betaMode === BETA_MODE_SKIN ? (<div className="animate-fade-in"><label className="block text-sm font-medium">Activity Concentration</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{concentrationUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>) : (<div className="space-y-3 animate-fade-in"><div><label className="block text-sm font-medium">Source Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div><div><label className="block text-sm font-medium">Distance to Source</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div></div>)}</div>)}
               {calcMode === CALC_MODE_GAMMA && (<div className="space-y-3 animate-fade-in"><div><label className="block text-sm font-medium">Source Geometry</label><div className="grid grid-cols-3 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mt-1"><button onClick={() => setGeometryMode(GEOMETRY_POINT)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${geometryMode === GEOMETRY_POINT ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Point</button><button onClick={() => setGeometryMode(GEOMETRY_LINE)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${geometryMode === GEOMETRY_LINE ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Line</button><button onClick={() => setGeometryMode(GEOMETRY_AREA)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${geometryMode === GEOMETRY_AREA ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Area (Disk)</button></div></div>{geometryMode === GEOMETRY_POINT && (<div><label className="block text-sm font-medium">Source Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}{geometryMode === GEOMETRY_LINE && (<div><label className="block text-sm font-medium">Linear Activity Concentration</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={linearActivityUnit} onChange={e => setLinearActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{linearActivityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}{geometryMode === GEOMETRY_AREA && (<div><label className="block text-sm font-medium">Areal Activity Concentration</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={arealActivityUnit} onChange={e => setArealActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{arealActivityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}{(geometryMode === GEOMETRY_LINE || geometryMode === GEOMETRY_AREA) && (<div className="space-y-4">{geometryMode === GEOMETRY_LINE && (<div><label className="block text-sm font-medium">Line Length</label><div className="flex"><input type="number" value={lineLength} onChange={e => setLineLength(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={lineLengthUnit} onChange={e => setLineLengthUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}{geometryMode === GEOMETRY_AREA && (<div><label className="block text-sm font-medium">Disk Radius</label><div className="flex"><input type="number" value={diskRadius} onChange={e => setDiskRadius(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={diskRadiusUnit} onChange={e => setDiskRadiusUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}</div>)}<div><Tooltip text="Assumes a perpendicular distance from the center of the source." widthClass="w-72"><label className="block text-sm font-medium">Distance from Source</label></Tooltip><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div></div>)}
               {calcMode === CALC_MODE_INTERNAL && (<div className="space-y-3 animate-fade-in p-4 border border-slate-200 dark:border-slate-700 rounded-lg"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium">Intake Route</label><select value={intakeRoute} onChange={e => setIntakeRoute(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="inhalation">Inhalation</option><option value="ingestion">Ingestion</option></select></div>{intakeRoute === 'inhalation' && (<div><label className="block text-sm font-medium">Solubility Class</label><select value={solubility} onChange={e => setSolubility(e.target.value)} disabled={availableClasses.length === 0} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{availableClasses.map(c => <option key={c} value={c}>{c}</option>)}</select></div>)}</div><div><label className="block text-sm font-medium">Intake Amount</label><div className="flex"><input type="number" value={intakeAmount} onChange={e => setIntakeAmount(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={intakeUnit} onChange={e => setIntakeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{intakeUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div></div>)}
               {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}
               {result && (<div className="text-center p-6 bg-sky-50 dark:bg-sky-900/50 rounded-lg mt-4 border-2 border-sky-500">
                    <div className="flex justify-between items-center -mt-2 -mb-2">
                        <div></div> {/* Spacer */}
                        <p className="font-semibold block text-sm text-sky-700 dark:text-sky-300">{resultTitles[result.type]}</p>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                   {result.type === 'gamma' && <><p className="text-4xl font-bold text-sky-600 dark:text-sky-400 my-1">{result.dose.value}<span className="text-3xl ml-2 opacity-75">{result.dose.unit}</span></p></>}
                   {result.type === 'beta_skin' && (<><p className="text-4xl font-bold text-sky-600 dark:text-sky-400 my-1">{result.dose.value}<span className="text-3xl ml-2 opacity-75">{result.dose.unit}</span></p><div className="mt-4 pt-4 border-t border-sky-200 dark:border-sky-800 text-sm text-slate-500 dark:text-slate-400"><p>Max Energy (Eₘₐₓ): <strong>{result.e_max} MeV</strong></p>{result.sourceNote && <p className="text-xs italic">Based on <strong>{result.sourceNote}</strong> daughter emission.</p>}</div></>)}
                   {result.type === 'beta_air' && (<>{result.isBeyondRange ? (<p className="text-4xl font-bold text-slate-600 dark:text-slate-300 my-1">0</p>) : (<p className="text-4xl font-bold text-sky-600 dark:text-sky-400 my-1">{result.dose.value}<span className="text-3xl ml-2 opacity-75">{result.dose.unit}</span></p>)}<div className="mt-4 pt-4 border-t border-sky-200 dark:border-sky-800 text-sm text-slate-500 dark:text-slate-400">{result.isBeyondRange && <p className="font-semibold text-amber-600 dark:text-amber-400">Distance is beyond the beta's maximum range in air.</p>}<p>Max Range: <strong>{result.range_m} m / {result.range_ft} ft</strong></p><p>Max Energy (Eₘₐₓ): <strong>{result.e_max} MeV</strong></p>{result.sourceNote && <p className="text-xs italic">Based on <strong>{result.sourceNote}</strong> daughter emission.</p>}</div></>)}
                   {result.type === 'bremsstrahlung' && <><p className="text-4xl font-bold text-sky-600 dark:text-sky-400 my-1">{result.dose.value}<span className="text-3xl ml-2 opacity-75">{result.dose.unit}</span></p><p className="text-sm font-medium text-slate-600 dark:text-slate-300">~{result.bremsstrahlungFraction}% of beta energy converted to X-rays.</p>{result.sourceNote && <p className="text-xs italic">Based on <strong>{result.sourceNote}</strong> daughter emission.</p>}</>}
                   {result.type === 'internal' && <><p className="text-4xl font-bold text-sky-600 dark:text-sky-400 my-1">{result.dose.value}<span className="text-3xl ml-2 opacity-75">{result.dose.unit}</span></p></>}
               </div>)}
           </div>
       </div>
    </div>
    );
};
     
         /**
         * @description A calculator for photon shielding with three modes:
         * 1. (From Source) Calculates final dose rate from a specific radionuclide.
         * 2. (Find Thickness) Calculates required shielding thickness for a specific radionuclide.
         * 3. (Generic Rate) Calculates final OR initial dose rate from a user-inputted HVL.
         */
         
const ShieldingCalculator = ({ radionuclides, preselectedNuclide }) => {
    const MODE_FROM_SOURCE = 'fromSource';
    const MODE_FIND_THICKNESS = 'findThickness';
    const MODE_GENERIC = 'genericRate';
    const CALC_MODE_BETA = 'beta';
    const INPUT_MODE_DB = 'fromSource';
    const INPUT_MODE_MANUAL = 'manual';
    
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const [calcMode, setCalcMode] = React.useState(() => localStorage.getItem('shielding_calcMode') || MODE_FROM_SOURCE);
    const [inputMode, setInputMode] = React.useState(() => localStorage.getItem('shielding_inputMode') || INPUT_MODE_DB);
    const [useManualHVL, setUseManualHVL] = React.useState(() => JSON.parse(localStorage.getItem('shielding_useManualHVL')) || false);
    const [useBuildup, setUseBuildup] = React.useState(() => JSON.parse(localStorage.getItem('shielding_useBuildup')) || false);
    const [nuclideSymbol, setNuclideSymbol] = React.useState(() => localStorage.getItem('shielding_nuclideSymbol') || '');
    const [activity, setActivity] = React.useState(() => localStorage.getItem('shielding_activity') || '1');
    const [activityUnit, setActivityUnit] = React.useState(() => localStorage.getItem('shielding_activityUnit') || 'mCi');
    const [distance, setDistance] = React.useState(() => localStorage.getItem('shielding_distance') || '1');
    const [distanceUnit, setDistanceUnit] = React.useState(() => localStorage.getItem('shielding_distanceUnit') || 'm');
    const [knownDoseRate, setKnownDoseRate] = React.useState(() => localStorage.getItem('shielding_knownDoseRate') || '100');
    const [knownDoseRateUnit, setKnownDoseRateUnit] = React.useState(() => localStorage.getItem('shielding_knownDoseRateUnit') || 'mrem/hr');
    const [manualHVL, setManualHVL] = React.useState(() => localStorage.getItem('shielding_manualHVL') || '');
    const [manualBetaEnergy, setManualBetaEnergy] = React.useState(() => localStorage.getItem('shielding_manualBetaEnergy') || '');
    const [shieldMaterial, setShieldMaterial] = React.useState(() => localStorage.getItem('shielding_shieldMaterial') || 'Lead');
    const [shieldThickness, setShieldThickness] = React.useState(() => localStorage.getItem('shielding_shieldThickness') || '1');
    const [thicknessUnit, setThicknessUnit] = React.useState(() => localStorage.getItem('shielding_thicknessUnit') || 'cm');
    const [targetDoseRate, setTargetDoseRate] = React.useState(() => localStorage.getItem('shielding_targetDoseRate') || '2');
    const [targetDoseRateUnit, setTargetDoseRateUnit] = React.useState(() => localStorage.getItem('shielding_targetDoseRateUnit') || 'mrem/hr');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    const materials = ['Lead', 'Concrete', 'Steel', 'Water', 'Tungsten', 'Aluminum'];
    const betaShieldMaterials = ['Plastic', 'Aluminum', 'Water'];
    const activityFactors = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1, 'dps': 1 / 3.7e10, 'dpm': 1 / (3.7e10 * 60) };
    const distanceFactors = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };
    const thicknessFactors = { 'mm': 0.1, 'cm': 1, 'in': 2.54 };
    const doseRateFactors = { 'µrem/hr': 0.001, 'mrem/hr': 1, 'rem/hr': 1000, 'mR/hr': 1, 'R/hr': 1000, 'µSv/hr': 0.1, 'mSv/hr': 100, 'Sv/hr': 100000 };
    const activityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'µCi', 'mCi', 'Ci'];
    const distanceUnits_ordered = ['mm', 'cm', 'm', 'in', 'ft'];
    const thicknessUnits_ordered = ['mm', 'cm', 'in'];
    const doseRateUnits_ordered = ['µrem/hr', 'mrem/hr', 'rem/hr', 'µSv/hr', 'mSv/hr', 'Sv/hr'];
    const shieldingNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant && HVL_DATA[n.symbol]).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    const betaNuclides = React.useMemo(() => radionuclides.filter(n => n.emissionEnergies?.beta?.length > 0).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const availableMaterials = React.useMemo(() => { const nuclideHVLData = HVL_DATA[nuclideSymbol]; return nuclideHVLData ? Object.keys(nuclideHVLData).filter(key => key !== 'sourceRef') : []; }, [nuclideSymbol]);
    
    const complexGammaNuclides = ['Ir-192', 'Eu-152', 'Ra-226', 'Na-24'];

    React.useEffect(() => {
    localStorage.setItem('shielding_calcMode', calcMode);
    localStorage.setItem('shielding_inputMode', inputMode);
    localStorage.setItem('shielding_useManualHVL', JSON.stringify(useManualHVL));
    localStorage.setItem('shielding_useBuildup', JSON.stringify(useBuildup));
    localStorage.setItem('shielding_nuclideSymbol', nuclideSymbol);
    localStorage.setItem('shielding_activity', activity);
    localStorage.setItem('shielding_activityUnit', activityUnit);
    localStorage.setItem('shielding_distance', distance);
    localStorage.setItem('shielding_distanceUnit', distanceUnit);
    localStorage.setItem('shielding_knownDoseRate', knownDoseRate);
    localStorage.setItem('shielding_knownDoseRateUnit', knownDoseRateUnit);
    localStorage.setItem('shielding_manualHVL', manualHVL);
    localStorage.setItem('shielding_manualBetaEnergy', manualBetaEnergy);
    localStorage.setItem('shielding_shieldMaterial', shieldMaterial);
    localStorage.setItem('shielding_shieldThickness', shieldThickness);
    localStorage.setItem('shielding_thicknessUnit', thicknessUnit);
    localStorage.setItem('shielding_targetDoseRate', targetDoseRate);
    localStorage.setItem('shielding_targetDoseRateUnit', targetDoseRateUnit);
    }, [calcMode, inputMode, useManualHVL, useBuildup, nuclideSymbol, activity, activityUnit, distance, distanceUnit, knownDoseRate, knownDoseRateUnit, manualHVL, manualBetaEnergy, shieldMaterial, shieldThickness, thicknessUnit, targetDoseRate, targetDoseRateUnit]);
    
    // --- NEWLY ADDED EFFECT TO PREVENT THIS BUG ---
    React.useEffect(() => {
        if (nuclideSymbol) {
            const validMaterials = availableMaterials;
            if (validMaterials.length > 0 && !validMaterials.includes(shieldMaterial)) {
                setShieldMaterial(validMaterials[0]);
            }
        }
    }, [nuclideSymbol, shieldMaterial, availableMaterials]);
    // ---------------------------------------------

React.useEffect(() => {
    if (nuclideSymbol) {
        const validMaterials = availableMaterials;
        if (validMaterials.length > 0 && !validMaterials.includes(shieldMaterial)) {
            setShieldMaterial(validMaterials[0]);
        }
    }
}, [nuclideSymbol, shieldMaterial, availableMaterials]);
    
    React.useEffect(() => {
    if (preselectedNuclide) {
       if (shieldingNuclides.find(n => n.symbol === preselectedNuclide)) { setNuclideSymbol(preselectedNuclide); setCalcMode(MODE_FROM_SOURCE); } 
       else if (betaNuclides.find(n => n.symbol === preselectedNuclide)) { setNuclideSymbol(preselectedNuclide); setCalcMode(CALC_MODE_BETA); }
    }
    }, [preselectedNuclide, shieldingNuclides, betaNuclides]);
    
    React.useEffect(() => {
    try {
       setError('');
       if (calcMode === CALC_MODE_BETA) {
           let E_max;
           if (inputMode === INPUT_MODE_DB) {
               const nuclide = betaNuclides.find(n => n.symbol === nuclideSymbol);
               if (!nuclide) { throw new Error('Please select a beta-emitting radionuclide.'); }
               E_max = parseEnergyToMeV(nuclide.emissionEnergies.beta);
           } else {
               E_max = parseFloat(manualBetaEnergy);
               if (isNaN(E_max) || E_max <= 0) { throw new Error('Please enter a valid, positive Max Beta Energy.'); }
           }
           let range_mg_cm2;
           if (E_max > 0.8) { range_mg_cm2 = 542 * E_max - 133; } 
           else if (E_max >= 0.15) { range_mg_cm2 = 407 * Math.pow(E_max, 1.38); } 
           else { throw new Error('Beta energy is too low for this range calculation.'); }
           const materialDensity = SHIELDING_MATERIALS[shieldMaterial]?.density;
           if (!materialDensity) { throw new Error('Selected material density not found.'); }
           const requiredThickness_cm = range_mg_cm2 / (materialDensity * 1000);
           const Z = SHIELDING_MATERIALS[shieldMaterial].Z;
           const bremsstrahlungFraction = 3.5e-4 * Z * E_max;
           setResult({ type: 'beta', thickness: formatSensibleUnit(requiredThickness_cm, 'distance'), bremsstrahlungFraction: (bremsstrahlungFraction * 100).toPrecision(2) });
       } else { // Gamma Modes
           let hvl_cm;
           if (useManualHVL) { hvl_cm = parseFloat(manualHVL); } 
           else if (calcMode === MODE_GENERIC) { hvl_cm = HVL_DATA['Cs-137'][shieldMaterial]; } 
           else if (nuclideSymbol) { const nuclide = shieldingNuclides.find(n => n.symbol === nuclideSymbol); if (!nuclide) return; hvl_cm = HVL_DATA[nuclide.symbol][shieldMaterial]; } 
           else { return; }
           if (isNaN(hvl_cm) || hvl_cm <= 0) { setError('Please select a material or enter a valid HVL value.'); return; }
           if (calcMode === MODE_GENERIC) {
               const knownRateVal = parseFloat(knownDoseRate);
               const thicknessVal = parseFloat(shieldThickness);
               if (isNaN(knownRateVal) || isNaN(thicknessVal) || knownRateVal < 0 || thicknessVal < 0) { if (knownDoseRate && shieldThickness) setError("Please enter valid positive numbers."); return; }
               const knownRate_mrem_hr = knownRateVal * doseRateFactors[knownDoseRateUnit];
               const thickness_cm = thicknessVal * thicknessFactors[thicknessUnit];
               const finalRate_mrem_hr = knownRate_mrem_hr * Math.pow(0.5, thickness_cm / hvl_cm);
               setResult({ type: 'genericRateFinal', initial: formatSensibleUnit(knownRate_mrem_hr, 'doseRate'), final: formatSensibleUnit(finalRate_mrem_hr, 'doseRate') });
           } else if (nuclideSymbol) {
               const nuclide = shieldingNuclides.find(n => n.symbol === nuclideSymbol);
               if (!nuclide) return;
               const activityValue = parseFloat(activity);
               const distanceValue = parseFloat(distance);
               const thicknessValue = parseFloat(shieldThickness);
               if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0 || isNaN(thicknessValue) || thicknessValue < 0) { if (activity && distance && shieldThickness) setError("Please enter valid positive numbers."); return; }
               const gammaConstant = parseFloat(nuclide.gammaConstant);
               const activityInCi = activityValue * activityFactors[activityUnit];
               const distanceInM = distanceValue * distanceFactors[distanceUnit];
               const unshieldedRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2);
               const unshielded_mrem_hr = unshieldedRateR_hr * 1000;
               const thicknessInCm = thicknessValue * thicknessFactors[thicknessUnit];
               let buildupFactor = 1;
               if (useBuildup && thicknessInCm > 0) {
                   const mu = Math.log(2) / hvl_cm;
                   const meanFreePaths = mu * thicknessInCm;
                   const k = BUILDUP_K_FACTORS[shieldMaterial] || 0.1;
                   buildupFactor = 1 + (k * meanFreePaths);
               }
               if (calcMode === MODE_FROM_SOURCE) {
                  const shieldedRateR_hr = buildupFactor * unshieldedRateR_hr * Math.pow(0.5, thicknessInCm / hvl_cm);
                  const shielded_mrem_hr = shieldedRateR_hr * 1000;
                  const newResult = { type: 'doseRate', unshielded: formatSensibleUnit(unshielded_mrem_hr, 'doseRate'), shielded: formatSensibleUnit(shielded_mrem_hr, 'doseRate'), buildup: buildupFactor.toFixed(2) };
                  setResult(newResult);
              } else {
                   const targetRateValue = parseFloat(targetDoseRate);
                   if (isNaN(targetRateValue) || targetRateValue <= 0) { setError('Please enter a valid, positive target dose rate.'); return; }
                   const targetRateR_hr = targetRateValue * (doseRateFactors[targetDoseRateUnit] / 1000);
                   if (targetRateR_hr >= unshieldedRateR_hr * (useBuildup ? 5 : 1)) { setError('Target dose rate is higher than the unshielded dose rate. No shielding is required.'); return; }
                   let requiredThickness_cm = hvl_cm * Math.log2(unshieldedRateR_hr / targetRateR_hr);
                   if (useBuildup) {
                       for (let i=0; i < 5; i++) {
                           const mu = Math.log(2) / hvl_cm;
                           const meanFreePaths = mu * requiredThickness_cm;
                           const k = BUILDUP_K_FACTORS[shieldMaterial] || 0.1;
                           const B = 1 + (k * meanFreePaths);
                           requiredThickness_cm = hvl_cm * Math.log2((unshieldedRateR_hr * B) / targetRateR_hr);
                       }
                   }
                   setResult({ type: 'thickness', unshielded: formatSensibleUnit(unshielded_mrem_hr, 'doseRate'), thickness: formatSensibleUnit(requiredThickness_cm, 'distance') });
               }
           }
       }
    } catch (e) { setError(e.message); setResult(null); }
    }, [calcMode, inputMode, useManualHVL, useBuildup, nuclideSymbol, activity, activityUnit, distance, distanceUnit, knownDoseRate, knownDoseRateUnit, manualHVL, manualBetaEnergy, shieldMaterial, shieldThickness, thicknessUnit, targetDoseRate, targetDoseRateUnit]);
    
    const handleSaveToHistory = () => {
        if (!result) return;
        let historyEntry = { id: Date.now(), view: VIEWS.SHIELDING };
    
        switch(result.type) {
            case 'doseRate':
                historyEntry.type = 'Gamma Shielding';
                historyEntry.icon = ICONS.shield;
                historyEntry.inputs = `${shieldThickness} ${thicknessUnit} of ${shieldMaterial}`;
                historyEntry.result = `${result.shielded.value} ${result.shielded.unit}`;
                break;
            case 'thickness':
                historyEntry.type = 'Gamma Shielding';
                historyEntry.icon = ICONS.shield;
                historyEntry.inputs = `Target: ${targetDoseRate} ${targetDoseRateUnit}`;
                historyEntry.result = `${result.thickness.value} ${result.thickness.unit} ${shieldMaterial}`;
                break;
            case 'genericRateFinal':
                historyEntry.type = 'Generic Shielding';
                historyEntry.icon = ICONS.shield;
                historyEntry.inputs = `${knownDoseRate} ${knownDoseRateUnit} -> ?`;
                historyEntry.result = `${result.final.value} ${result.final.unit}`;
                break;
            case 'beta':
                historyEntry.type = 'Beta Shielding';
                historyEntry.icon = ICONS.shield;
                historyEntry.inputs = `${nuclideSymbol || 'Manual'} Eₘₐₓ`;
                historyEntry.result = `${result.thickness.value} ${result.thickness.unit} ${shieldMaterial}`;
                break;
            default:
                return;
        }
    
        addHistory(historyEntry);
        addToast("Calculation saved to history!");
    };

    const handleModeChange = (mode) => {
    setCalcMode(mode);
    setResult(null);
    setError('');
    setUseManualHVL(false);
    setUseBuildup(false);
    setNuclideSymbol('');
    setInputMode(INPUT_MODE_DB);
    if (mode === CALC_MODE_BETA) {
       setShieldMaterial('Plastic');
    } else if (availableMaterials.length > 0) {
       setShieldMaterial(availableMaterials[0]);
    }
    };
    
    const handleClearInputs = () => {
    setCalcMode(MODE_FROM_SOURCE);
    setInputMode(INPUT_MODE_DB);
    setUseManualHVL(false);
    setUseBuildup(false);
    setNuclideSymbol('');
    setActivity('1');
    setActivityUnit('mCi');
    setDistance('1');
    setDistanceUnit('m');
    setKnownDoseRate('100');
    setKnownDoseRateUnit('mrem/hr');
    setManualHVL('');
    setManualBetaEnergy('');
    setShieldMaterial('Lead');
    setShieldThickness('1');
    setThicknessUnit('cm');
    setTargetDoseRate('2');
    setTargetDoseRateUnit('mrem/hr');
    setResult(null);
    setError('');
    };
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Shielding Calculator</h2>
               <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                   <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
               </button>
           </div>
           <div className="grid grid-cols-2 md:grid-cols-4 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
               <button onClick={() => handleModeChange(MODE_FROM_SOURCE)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_FROM_SOURCE ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Gamma Dose</button>
               <button onClick={() => handleModeChange(MODE_FIND_THICKNESS)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_FIND_THICKNESS ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Gamma Thick</button>
               <button onClick={() => handleModeChange(MODE_GENERIC)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_GENERIC ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Generic Photon</button>
               <button onClick={() => handleModeChange(CALC_MODE_BETA)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === CALC_MODE_BETA ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Beta Range</button>
           </div>
           <div className="space-y-4">
               {calcMode === CALC_MODE_BETA ? (
                   <div className="animate-fade-in space-y-4">
                       <p className="text-sm text-center text-slate-500 dark:text-slate-400">Calculates the shield thickness required to stop all beta particles.</p>
                       <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
                           <button onClick={() => setInputMode(INPUT_MODE_DB)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === INPUT_MODE_DB ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>From Database</button>
                           <button onClick={() => setInputMode(INPUT_MODE_MANUAL)} className={`p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === INPUT_MODE_MANUAL ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Manual Input</button>
                       </div>
                       {inputMode === INPUT_MODE_DB ? ( <div className="animate-fade-in">{nuclideSymbol ? ( <CalculatorNuclideInfo nuclide={betaNuclides.find(n => n.symbol === nuclideSymbol)} onClear={() => { setNuclideSymbol(''); }} /> ) : ( <SearchableSelect options={betaNuclides} onSelect={(symbol) => setNuclideSymbol(symbol)} placeholder={`Select a beta emitter...`} /> )}</div> ) : ( <div className="animate-fade-in p-2"><label className="block text-sm font-medium">Max Beta Energy (Eₘₐₓ)</label><div className="relative"><input type="number" value={manualBetaEnergy} onChange={e => setManualBetaEnergy(e.target.value)} placeholder="e.g., 2.28 for Y-90" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/><span className="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500 dark:text-slate-400">MeV</span></div></div> )}
                       <div>
                           <label className="block text-sm font-medium">Shield Material</label>
                           <select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                               {betaShieldMaterials.map(m => <option key={m} value={m}>{m}</option>)}
                           </select>
                       </div>
                   </div>
               ) : (
                   <div className="animate-fade-in space-y-4">
                       {calcMode !== MODE_GENERIC && (
                           <div className="animate-fade-in space-y-4">
                               <div>
                                   <label className="block text-sm font-medium">Radionuclide</label>
                                   <div className="mt-1">
                                       {nuclideSymbol ? <CalculatorNuclideInfo nuclide={shieldingNuclides.find(n => n.symbol === nuclideSymbol)} onClear={() => { setNuclideSymbol(''); }} /> : (
                                           <>
                                               <SearchableSelect options={shieldingNuclides} onSelect={(symbol) => setNuclideSymbol(symbol)} placeholder="Select a gamma emitter..." />
                                               <QuickNuclideSelector onSelect={(symbol) => setNuclideSymbol(symbol)} />
                                           </>
                                       )}
                                   </div>

                           {nuclideSymbol && complexGammaNuclides.includes(nuclideSymbol) && (
                               <ContextualNote type="warning">
                                   <strong>Beam Hardening:</strong> {nuclideSymbol} has a complex gamma spectrum. For thick shields, the actual dose rate may be higher than calculated as lower-energy gammas are filtered out.
                               </ContextualNote>
                           )}



                               </div>
                               <div className="grid grid-cols-2 gap-4">
                                   <div><label className="block text-xs font-medium">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                                   <div><label className="block text-xs font-medium">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                               </div>
                           </div>
                       )}
                       {calcMode === MODE_GENERIC && (
                           <div className="animate-fade-in space-y-4">
                               <div><label className="block text-sm font-medium">Initial Dose Rate</label><div className="flex"><input type="number" value={knownDoseRate} onChange={e => setKnownDoseRate(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={knownDoseRateUnit} onChange={e => setKnownDoseRateUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{doseRateUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                           </div>
                       )}
                       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                           <div className="flex items-center justify-between mb-2">
                               <label className="block text-sm font-medium">Shield Material / HVL</label>
                               <label className="flex items-center gap-2 cursor-pointer"><span className="text-xs text-slate-500">Manual HVL</span><input type="checkbox" checked={useManualHVL} onChange={e => setUseManualHVL(e.target.checked)} className="form-checkbox h-4 w-4 rounded text-sky-600" /></label>
                           </div>
                           {useManualHVL ? ( <div className="relative"><input type="number" value={manualHVL} onChange={e => setManualHVL(e.target.value)} placeholder="HVL in cm" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/><div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-500">cm</div></div> ) : ( <select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700">{calcMode === MODE_GENERIC ? materials.map(m => <option key={m} value={m}>{m}</option>) : availableMaterials.map(m => <option key={m} value={m}>{m}</option>)}</select> )}
                           {calcMode === MODE_FROM_SOURCE && ( <div><label className="block text-sm font-medium">Shield Thickness</label><div className="flex"><input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{thicknessUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div> )}
                           {calcMode === MODE_FIND_THICKNESS && ( <div><label className="block text-sm font-medium">Target Dose Rate</label><div className="flex"><input type="number" value={targetDoseRate} onChange={e => setTargetDoseRate(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={targetDoseRateUnit} onChange={e => setTargetDoseRateUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{doseRateUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div> )}
                           {calcMode === MODE_GENERIC && ( <div><label className="block text-sm font-medium">Shield Thickness</label><div className="flex"><input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{thicknessUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div> )}
                           <div className="flex items-center justify-end mt-2">
                               <Tooltip text="Accounts for the contribution of scattered photons (broad beam geometry), providing a more realistic, conservative result.">
                                   <label className="flex items-center gap-2 text-sm cursor-pointer">
                                       <span className="font-semibold text-slate-600 dark:text-slate-300">Advanced:</span>
                                       Use Buildup Factor
                                       <input type="checkbox" checked={useBuildup} onChange={e => setUseBuildup(e.target.checked)} className="form-checkbox h-4 w-4 rounded text-sky-600" />
                                   </label>
                               </Tooltip>
                           </div>
                       </div>
                   </div>
               )}
               {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}
               {result && (
                   <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-2">
                       <div className="flex justify-end -mt-2 -mr-2">
                           <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                               <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                   <Icon path={ICONS.notepad} className="w-5 h-5" />
                               </button>
                           </Tooltip>
                       </div>
                      { result.type === 'doseRate' && <>
                           <div className="-mt-4">
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Unshielded Dose Rate</p>
                               <p className="text-xl font-bold text-slate-600 dark:text-slate-300">{result.unshielded.value} {result.unshielded.unit}</p>
                           </div>
                           <div className="font-bold text-2xl">↓</div>
                           <div>
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Shielded Dose Rate</p>
                               <div className="flex items-center justify-center">
                                   <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.shielded.value} {result.shielded.unit}</p>
                                   <CopyButton textToCopy={result.shielded.value} />
                               </div>
                               {useBuildup && <p className="text-xs text-slate-500 dark:text-slate-400">(with Buildup Factor B = {result.buildup})</p>}
                           </div>
                       </>}
                      { result.type === 'thickness' && <>
                           <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400 -mt-4">To reduce from {result.unshielded.value} {result.unshielded.unit} to {targetDoseRate} {targetDoseRateUnit}, you need:</p>
                           <div className="flex items-center justify-center mt-2">
                               <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.thickness.value} {result.thickness.unit}</p>
                               <CopyButton textToCopy={result.thickness.value} />
                           </div>
                           <p className="text-md font-medium text-slate-600 dark:text-slate-300">of {useManualHVL ? 'custom material' : shieldMaterial}</p>
                       </>}
                      { result.type === 'genericRateFinal' && <>
                           <div className="-mt-4">
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Initial Dose Rate</p>
                               <p className="text-xl font-bold text-slate-600 dark:text-slate-300">{result.initial.value} {result.initial.unit}</p>
                           </div>
                           <div className="font-bold text-2xl">↓</div>
                           <div>
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Final (Shielded) Dose Rate</p>
                               <div className="flex items-center justify-center">
                                   <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.final.value} {result.final.unit}</p>
                                   <CopyButton textToCopy={result.final.value} />
                               </div>
                           </div>
                       </>}
                      { result.type === 'beta' && <>
                           <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400 -mt-4">Required Beta Shield Thickness</p>
                           <div className="flex items-center justify-center my-1">
                               <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.thickness.value} <span className="text-2xl opacity-75">{result.thickness.unit}</span></p>
                               <CopyButton textToCopy={result.thickness.value} />
                           </div>
                           <p className="text-md font-medium text-slate-600 dark:text-slate-300">of {shieldMaterial}</p>
                           <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 text-xs text-amber-800 dark:text-amber-200 p-3 rounded-md bg-amber-100 dark:bg-amber-900/50">
                               <p className="font-semibold">⚠️ Bremsstrahlung Warning</p>
                               <p>Approximately {result.bremsstrahlungFraction}% of the beta energy will be converted to X-rays in this shield. Always use the lowest-Z material practical for primary beta shielding.</p>
                           </div>
                       </>}
                   </div>
               )}
           </div>
       </div>
    </div>
    );
};
         
         /**
         * @description A calculator for determining allowable stay time and total dose received.
         * The dose rate can be calculated from a specific source or entered manually.
         */
         
const StayTimeCalculator = ({ radionuclides, preselectedNuclide }) => {
    const INPUT_MODE_SOURCE = 'fromSource';
    const INPUT_MODE_MANUAL = 'manualRate';
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const [inputMode, setInputMode] = React.useState(() => localStorage.getItem('stayTime_inputMode') || INPUT_MODE_SOURCE);
    const [nuclideSymbol, setNuclideSymbol] = React.useState(() => localStorage.getItem('stayTime_nuclideSymbol') || '');
    const [activity, setActivity] = React.useState(() => localStorage.getItem('stayTime_activity') || '1');
    const [activityUnit, setActivityUnit] = React.useState(() => localStorage.getItem('stayTime_activityUnit') || 'mCi');
    const [distance, setDistance] = React.useState(() => localStorage.getItem('stayTime_distance') || '1');
    const [distanceUnit, setDistanceUnit] = React.useState(() => localStorage.getItem('stayTime_distanceUnit') || 'm');
    const [manualDoseRate, setManualDoseRate] = React.useState(() => localStorage.getItem('stayTime_manualDoseRate') || '10');
    const [manualDoseRateUnit, setManualDoseRateUnit] = React.useState(() => localStorage.getItem('stayTime_manualDoseRateUnit') || 'mrem/hr');
    const [doseLimit, setDoseLimit] = React.useState(() => localStorage.getItem('stayTime_doseLimit') || '2');
    const [plannedTime, setPlannedTime] = React.useState(() => localStorage.getItem('stayTime_plannedTime') || '10');
    const [plannedTimeUnit, setPlannedTimeUnit] = React.useState(() => localStorage.getItem('stayTime_plannedTimeUnit') || 'minutes');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    const activityFactors = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1, 'dps': 1 / 3.7e10, 'dpm': 1 / (3.7e10 * 60) };
    const distanceFactors = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };
    const timeFactors = { 'minutes': 1 / 60, 'hours': 1, 'days': 24 };
    const doseRateFactors = { 'µrem/hr': 0.001, 'mrem/hr': 1, 'rem/hr': 1000, 'mR/hr': 1, 'R/hr': 1000, 'µSv/hr': 0.1, 'mSv/hr': 100, 'Sv/hr': 100000 };
    const activityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'µCi', 'mCi', 'Ci'];
    const distanceUnits_ordered = ['mm', 'cm', 'm', 'in', 'ft'];
    const doseRateUnits_ordered = ['µrem/hr', 'mrem/hr', 'rem/hr', 'µSv/hr', 'mSv/hr', 'Sv/hr'];
    const timeUnits_ordered = ['minutes', 'hours', 'days'];
    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    
    React.useEffect(() => {
    localStorage.setItem('stayTime_inputMode', inputMode);
    localStorage.setItem('stayTime_nuclideSymbol', nuclideSymbol);
    localStorage.setItem('stayTime_activity', activity);
    localStorage.setItem('stayTime_activityUnit', activityUnit);
    localStorage.setItem('stayTime_distance', distance);
    localStorage.setItem('stayTime_distanceUnit', distanceUnit);
    localStorage.setItem('stayTime_manualDoseRate', manualDoseRate);
    localStorage.setItem('stayTime_manualDoseRateUnit', manualDoseRateUnit);
    localStorage.setItem('stayTime_doseLimit', doseLimit);
    localStorage.setItem('stayTime_plannedTime', plannedTime);
    localStorage.setItem('stayTime_plannedTimeUnit', plannedTimeUnit);
    }, [inputMode, nuclideSymbol, activity, activityUnit, distance, distanceUnit, manualDoseRate, manualDoseRateUnit, doseLimit, plannedTime, plannedTimeUnit]);
    
    React.useEffect(() => {
    if (preselectedNuclide && gammaNuclides.find(n => n.symbol === preselectedNuclide)) {
       setNuclideSymbol(preselectedNuclide);
       setInputMode(INPUT_MODE_SOURCE);
    }
    }, [preselectedNuclide, gammaNuclides]);
    
    const handleCalculate = () => {
    let doseRate_mrem_hr = 0;
    try {
       if (inputMode === INPUT_MODE_SOURCE) {
           const nuclide = gammaNuclides.find(n => n.symbol === nuclideSymbol);
           if (!nuclide) { throw new Error('Please select a radionuclide.'); }
           const activityValue = parseFloat(activity);
           const distanceValue = parseFloat(distance);
           if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0) { throw new Error('Please enter valid, positive numbers for activity and distance.'); }
           const gammaConstant = parseFloat(nuclide.gammaConstant);
           const activityInCi = activityValue * activityFactors[activityUnit];
           const distanceInM = distanceValue * distanceFactors[distanceUnit];
           const doseRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2);
           doseRate_mrem_hr = doseRateR_hr * 1000;
       } else { // manualRate
           const manualRate = parseFloat(manualDoseRate);
           if (isNaN(manualRate) || manualRate < 0) { throw new Error('Please enter a valid, non-negative dose rate.'); }
           doseRate_mrem_hr = manualRate * doseRateFactors[manualDoseRateUnit];
       }
       const limit = parseFloat(doseLimit);
       const plannedTimeValue = parseFloat(plannedTime);
       if (isNaN(limit) || isNaN(plannedTimeValue) || limit <= 0 || plannedTimeValue < 0) { throw new Error('Please enter valid, positive numbers for dose limit and planned time.'); }
       if (doseRate_mrem_hr <= 0) { throw new Error('Dose rate must be greater than zero to calculate stay time.'); }
       const stayTimeHours = limit / doseRate_mrem_hr;
       const totalMinutes = stayTimeHours * 60;
       const minutes = Math.floor(totalMinutes);
       const seconds = Math.round((totalMinutes - minutes) * 60);
       const plannedTimeInHours = plannedTimeValue * timeFactors[plannedTimeUnit];
       const totalDoseReceived = doseRate_mrem_hr * plannedTimeInHours;
       const isSafe = totalDoseReceived <= limit;
       setResult({ 
            doseRate: formatSensibleUnit(doseRate_mrem_hr, 'doseRate'), 
            stayTime: `${minutes} min ${seconds} sec`, 
            totalDoseReceived: formatSensibleUnit(totalDoseReceived, 'dose'), 
            isSafe: isSafe,
            rawDoseRate_mrem_hr: doseRate_mrem_hr // Store raw value for history
       });
    } catch(e) {
       setError(e.message);
       setResult(null);
    }
    };
    
    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ 
                id: Date.now(), 
                type: 'Stay Time', 
                icon: ICONS.stopwatch, 
                inputs: `${result.rawDoseRate_mrem_hr.toPrecision(3)} mrem/hr, ${doseLimit} mrem limit`, 
                result: result.stayTime, 
                view: VIEWS.STAY_TIME 
            });
            addToast("Calculation saved to history!");
        }
    };
    
    React.useEffect(() => {
    setResult(null);
    setError('');
    if (inputMode === INPUT_MODE_SOURCE && !nuclideSymbol) { return; }
    handleCalculate();
    }, [ inputMode, nuclideSymbol, activity, activityUnit, distance, distanceUnit, manualDoseRate, manualDoseRateUnit, doseLimit, plannedTime, plannedTimeUnit ]);
    
    // --- THIS IS THE CORRECTED FUNCTION ---
    const handleClearInputs = () => {
        setInputMode(INPUT_MODE_SOURCE);
        setNuclideSymbol('');
        setActivity('1');
        setActivityUnit('mCi');
        setDistance('1');
        setDistanceUnit('m');
        setManualDoseRate('10');
        setManualDoseRateUnit('mrem/hr');
        setDoseLimit('2');
        setPlannedTime('10');
        setPlannedTimeUnit('minutes');
        setError('');
        setResult(null);
    };
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Stay Time & Dose Calculator</h2>
               <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                   <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
               </button>
           </div>
           <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
               <button onClick={() => setInputMode(INPUT_MODE_SOURCE)} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === INPUT_MODE_SOURCE ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Calculate from Source</button>
               <button onClick={() => setInputMode(INPUT_MODE_MANUAL)} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === INPUT_MODE_MANUAL ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Enter Dose Rate</button>
           </div>
           <div className="space-y-4">
               {inputMode === INPUT_MODE_SOURCE ? (
                   <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
                       <label className="block text-sm font-semibold">Source Information</label>
                       {nuclideSymbol && gammaNuclides.find(n => n.symbol === nuclideSymbol) ? ( 
                           <CalculatorNuclideInfo nuclide={gammaNuclides.find(n => n.symbol === nuclideSymbol)} onClear={() => { setNuclideSymbol(''); }} /> 
                       ) : ( 
                           <>
                               <SearchableSelect options={gammaNuclides} onSelect={(symbol) => setNuclideSymbol(symbol)} placeholder="Search for a gamma emitter..." />
                               <QuickNuclideSelector onSelect={(symbol) => setNuclideSymbol(symbol)} />
                           </>
                       )}
                       <div className="grid grid-cols-2 gap-4">
                           <div><label className="block text-xs font-medium">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{activityUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                           <div><label className="block text-xs font-medium">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{distanceUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                       </div>
                   </div>
               ) : (
                   <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
                       <label className="block text-sm font-semibold">Known Dose Rate</label>
                       <div className="flex"><input type="number" value={manualDoseRate} onChange={e => setManualDoseRate(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={manualDoseRateUnit} onChange={e => setManualDoseRateUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{doseRateUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                   </div>
               )}
               <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                   <div className="flex justify-between items-center">
                       <label className="block text-sm font-semibold">Planning</label>
                   </div>
                   <div>
                       <Tooltip text="Common limits: 2 mrem (unrestricted area), 5 mrem (minor), 100 mrem (public annual limit), 5000 mrem (occupational annual limit). Always follow site-specific procedures.">
                           <label className="block text-xs font-medium">Dose Limit (mrem)</label>
                       </Tooltip>
                       <input type="number" value={doseLimit} onChange={e => setDoseLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                   </div>
               </div>
               {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}
               {result && (
                   <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-4">
                       <div className="flex justify-between items-center">
                           <div className="text-center w-full">
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Dose Rate in Area: <span className="font-bold text-slate-700 dark:text-slate-200">{result.doseRate.value} {result.doseRate.unit}</span></p>
                           </div>
                           <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                               <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors -mr-2 -mt-2">
                                   <Icon path={ICONS.notepad} className="w-5 h-5" />
                               </button>
                           </Tooltip>
                       </div>
                       <div className="grid grid-cols-2 gap-4 text-center">
                           <div className="p-2 bg-white dark:bg-slate-800 rounded-lg">
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Max Stay Time</p>
                           
                               <div className="flex items-center justify-center">
                                   <p className="text-xl font-bold text-sky-600 dark:text-sky-400">{result.stayTime}</p>
                                   <CopyButton textToCopy={result.stayTime} />
                               </div>
                           
                               <p className="text-xs text-slate-400">(to reach {doseLimit} mrem)</p>
                           </div>
                           <div className={`p-2 rounded-lg ${result.isSafe ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                               <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Total Dose Received</p>
                         
                               <div className="flex items-center justify-center">
                                   <p className={`text-xl font-bold ${result.isSafe ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.totalDoseReceived.value} {result.totalDoseReceived.unit}</p>
                                   <CopyButton textToCopy={result.totalDoseReceived.value} />
                               </div>
                                
                               <p className="text-xs text-slate-400">(in {plannedTime} {plannedTimeUnit})</p>
                           </div>
                       </div>
                       {!result.isSafe && <p className="text-center font-bold text-red-500 text-sm">WARNING: Exceeds dose limit!</p>}
                   </div>
               )}
           </div>
       </div>
    </div>
    );
};
         
         /**
         * Data and components for the Neutron Tools module.
         */
         
         // --- Data from 10 CFR 20.1004 for Fluence/Dose Conversion ---
         
         const NEUTRON_CONVERSION_FACTORS = [
         { energyMeV: 2.5e-8, fluencePerRem: 980e6, q: 2, label: 'Thermal (0.025 eV)' },
         { energyMeV: 1e-7, fluencePerRem: 980e6, q: 2, label: '0.1 eV' },
         { energyMeV: 1e-6, fluencePerRem: 810e6, q: 2, label: '1 eV' },
         { energyMeV: 1e-5, fluencePerRem: 810e6, q: 2, label: '10 eV' },
         { energyMeV: 1e-4, fluencePerRem: 840e6, q: 2, label: '100 eV' },
         { energyMeV: 1e-3, fluencePerRem: 980e6, q: 2, label: '1 keV' },
         { energyMeV: 1e-2, fluencePerRem: 1000e6, q: 2.5, label: '10 keV' },
         { energyMeV: 1e-1, fluencePerRem: 170e6, q: 7.5, label: '100 keV' },
         { energyMeV: 5e-1, fluencePerRem: 39e6, q: 11, label: '0.5 MeV' },
         { energyMeV: 1, fluencePerRem: 27e6, q: 11, label: '1 MeV' },
         { energyMeV: 2.5, fluencePerRem: 29e6, q: 9, label: '2.5 MeV' },
         { energyMeV: 5, fluencePerRem: 23e6, q: 8, label: '5 MeV' },
         { energyMeV: 7, fluencePerRem: 24e6, q: 7, label: '7 MeV' },
         { energyMeV: 10, fluencePerRem: 24e6, q: 6.5, label: '10 MeV' },
         { energyMeV: 14, fluencePerRem: 17e6, q: 7.5, label: '14 MeV' },
         { energyMeV: 20, fluencePerRem: 16e6, q: 8, label: '20 MeV' },
         { energyMeV: 40, fluencePerRem: 14e6, q: 7, label: '40 MeV' },
         { energyMeV: 60, fluencePerRem: 16e6, q: 5.5, label: '60 MeV' },
         { energyMeV: 100, fluencePerRem: 20e6, q: 4, label: '100 MeV' },
         { energyMeV: 200, fluencePerRem: 19e6, q: 3.5, label: '200 MeV' },
         { energyMeV: 300, fluencePerRem: 19e6, q: 3.5, label: '300 MeV' },
         { energyMeV: 400, fluencePerRem: 20e6, q: 3.5, label: '400 MeV' }
         ];
         
         const NEUTRON_ACTIVATION_DATA = [
         { targetSymbol: 'Co-59', name: 'Cobalt-59', atomicWeight: 58.933, thermalCrossSection_barns: 37.2, productSymbol: 'Co-60' },
         { targetSymbol: 'Na-23', name: 'Sodium-23', atomicWeight: 22.990, thermalCrossSection_barns: 0.53, productSymbol: 'Na-24' },
         { targetSymbol: 'Au-197', name: 'Gold-197', atomicWeight: 196.967, thermalCrossSection_barns: 98.65, productSymbol: 'Au-198' },
         { targetSymbol: 'Ir-191', name: 'Iridium-191', atomicWeight: 190.960, thermalCrossSection_barns: 954, productSymbol: 'Ir-192' },
         { targetSymbol: 'Ho-165', name: 'Holmium-165', atomicWeight: 164.930, thermalCrossSection_barns: 64.7, productSymbol: 'Ho-166' },
         { targetSymbol: 'Fe-58', name: 'Iron-58', atomicWeight: 57.933, thermalCrossSection_barns: 1.3, productSymbol: 'Fe-59' },
         { targetSymbol: 'Lu-176', name: 'Lutetium-176', atomicWeight: 175.942, thermalCrossSection_barns: 2090, productSymbol: 'Lu-177' },
         { targetSymbol: 'Ta-181', name: 'Tantalum-181', atomicWeight: 180.948, thermalCrossSection_barns: 20.6, productSymbol: 'Ta-182' },
         { targetSymbol: 'Sc-45', name: 'Scandium-45', atomicWeight: 44.956, thermalCrossSection_barns: 27.5, productSymbol: 'Sc-46' },
         { targetSymbol: 'Cu-63', name: 'Copper-63', atomicWeight: 62.929, thermalCrossSection_barns: 4.5, productSymbol: 'Cu-64' },
         { targetSymbol: 'Ag-109', name: 'Silver-109', atomicWeight: 108.905, thermalCrossSection_barns: 89, productSymbol: 'Ag-110m' },
         { targetSymbol: 'Sb-123', name: 'Antimony-123', atomicWeight: 122.904, thermalCrossSection_barns: 4.1, productSymbol: 'Sb-124' },
         { targetSymbol: 'Eu-151', name: 'Europium-151', atomicWeight: 150.920, thermalCrossSection_barns: 9200, productSymbol: 'Eu-152' },
         { targetSymbol: 'Ca-44', name: 'Calcium-44', atomicWeight: 43.955, thermalCrossSection_barns: 1.0, productSymbol: 'Ca-45' },
         ].sort((a,b) => a.name.localeCompare(b.name));
         
         const COMPOSITE_MATERIALS_DATA = {
         'Ordinary Concrete': {
         density_g_cm3: 2.3,
         composition: [ { element: 'Sodium-23', targetSymbol: 'Na-23', massFraction: 0.01 }, { element: 'Iron-58', targetSymbol: 'Fe-58', massFraction: 0.015 * 0.0028 }, { element: 'Cobalt-59', targetSymbol: 'Co-59', massFraction: 0.00001 }, { element: 'Europium-151', targetSymbol: 'Eu-151', massFraction: 0.000001 }, { element: 'Calcium-44', targetSymbol: 'Ca-44', massFraction: 0.08 * 0.02086 }, ]
         },
         'Standard Human Tissue': {
         density_g_cm3: 1.0,
         composition: [ { element: 'Sodium-23', targetSymbol: 'Na-23', massFraction: 0.0015 } ]
         },
         'Stainless Steel 304': {
         density_g_cm3: 8.0,
         composition: [ { element: 'Iron-58', targetSymbol: 'Fe-58', massFraction: 0.70 * 0.0028 }, { element: 'Cobalt-59', targetSymbol: 'Co-59', massFraction: 0.001 }, ]
         }
         };
         
         const FAST_NEUTRON_SHIELDING_DATA = {
         'Water': { hvl_cm: 6.1 },
         'Polyethylene': { hvl_cm: 5.3 },
         'Concrete': { hvl_cm: 10.7 },
         'Borated Poly (5%)': { hvl_cm: 5.1 },
         'Steel': { hvl_cm: 7.9 },
         'Lead': { hvl_cm: 15.0 },
         };
         const THERMAL_NEUTRON_SHIELDING_DATA = {
         'Cadmium': { hvl_cm: 0.02 },
         'Borated Poly (5%)': { hvl_cm: 0.1 },
         'Water': { hvl_cm: 2.8 },
         'Polyethylene': { hvl_cm: 3.5 },
         'Concrete': { hvl_cm: 4.8 },
         'Lead': { hvl_cm: 4.5 },
         };
         
const FluenceDoseConverter = ({ calcMode, setCalcMode, energy, setEnergy, inputValue, setInputValue, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    React.useEffect(() => {
    if (calcMode === 'fluenceToDose') { setInputValue('1e6'); } else { setInputValue('100'); }
    }, [calcMode, setInputValue]);
    
    const logLogInterpolate = (targetX, x1, y1, x2, y2) => y1 * Math.pow(targetX / x1, Math.log(y2 / y1) / Math.log(x2 / x1));
    
    React.useEffect(() => {
    try {
       setError('');
       const inputVal = parseFloat(inputValue);
       const energyVal = parseFloat(energy);
       if (isNaN(inputVal) || isNaN(energyVal) || inputVal < 0 || energyVal <= 0) { 
           if (inputValue && energy) setError('Inputs must be positive numbers.'); 
           setResult(null); 
           return; 
       }
       let p1 = NEUTRON_CONVERSION_FACTORS[0], p2 = NEUTRON_CONVERSION_FACTORS[NEUTRON_CONVERSION_FACTORS.length - 1];
       if (energyVal < p1.energyMeV) { p2 = p1; } 
       else if (energyVal > p2.energyMeV) { p1 = p2; } 
       else {
           for (let i = 0; i < NEUTRON_CONVERSION_FACTORS.length - 1; i++) {
               if (energyVal >= NEUTRON_CONVERSION_FACTORS[i].energyMeV && energyVal <= NEUTRON_CONVERSION_FACTORS[i + 1].energyMeV) { 
                   p1 = NEUTRON_CONVERSION_FACTORS[i]; 
                   p2 = NEUTRON_CONVERSION_FACTORS[i + 1]; 
                   break; 
               }
           }
       }
       const fluencePerRem = (p1.energyMeV === p2.energyMeV) ? p1.fluencePerRem : logLogInterpolate(energyVal, p1.energyMeV, p1.fluencePerRem, p2.energyMeV, p2.fluencePerRem);
       const doseConvFactor = 1 / fluencePerRem;
       if (calcMode === 'fluenceToDose') {
           const dose_rem = inputVal * doseConvFactor;
           const formattedDose = formatSensibleUnit(dose_rem * 1000, 'dose');
           setResult({ title: 'Resulting Dose (or Dose Rate)', displayValue: formattedDose.value, unit: formattedDose.unit, factor: doseConvFactor.toExponential(3), factorUnit: 'rem per n/cm²' });
       } else {
           const fluence_n_cm2 = inputVal / doseConvFactor;
           setResult({ title: 'Required Fluence (or Fluence Rate)', displayValue: fluence_n_cm2.toExponential(3), unit: 'n/cm²', factor: fluencePerRem.toExponential(3), factorUnit: 'n/cm² per rem' });
       }
    } catch (e) { setError('Calculation error.'); setResult(null); }
    }, [calcMode, energy, inputValue, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Neutron Fluence/Dose', icon: ICONS.neutron, inputs: `Energy: ${energy} MeV`, result: `${result.displayValue} ${result.unit}`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
           <button onClick={() => setCalcMode('fluenceToDose')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'fluenceToDose' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Fluence to Dose</button>
           <button onClick={() => setCalcMode('doseToFluence')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'doseToFluence' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dose to Fluence</button>
       </div>
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div><label className="block text-sm font-medium">Neutron Energy</label><select value={energy} onChange={e => setEnergy(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{NEUTRON_CONVERSION_FACTORS.map(f => <option key={f.energyMeV} value={f.energyMeV}>{f.label}</option>)}</select></div>
           <div>
               <label className="block text-sm font-medium">{calcMode === 'fluenceToDose' ? 'Fluence (n/cm²)' : 'Dose (rem)'}</label>
               <input type="text" value={inputValue} onChange={e => setInputValue(e.target.value)} placeholder={calcMode === 'fluenceToDose' ? 'e.g., 1e7' : 'e.g., 100'} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
               <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">For rates, use fluence rate (n/cm²·s) and dose rate (rem/s).</p>
           </div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in">
                <div className="flex justify-between items-center -mt-2 -mb-2">
                    <div></div> {/* Spacer */}
                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.title}</p>
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
                </div>
               <div className="flex items-center justify-center">
                   <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.displayValue} <span className="text-xl opacity-75">{result.unit}</span></p>
                   <CopyButton textToCopy={result.displayValue} />
               </div>
               <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">Conversion Factor: {result.factor} {result.factorUnit}</p>
           </div>
       )}
    </div>
    );
};
         
const ActivationCalculator = ({ radionuclides, inputMode, setInputMode, targetMass, setTargetMass, massUnit, setMassUnit, neutronFlux, setNeutronFlux, irradiationTime, setIrradiationTime, timeUnit, setTimeUnit, result, setResult, error, setError, targetSymbol, setTargetSymbol, manualAW, setManualAW, manualCS, setManualCS, manualHL, setManualHL, manualHLUnit, setManualHLUnit, manualProductName, setManualProductName }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const massUnits = { 'µg': 1e-6, 'mg': 1e-3, 'g': 1, 'kg': 1000 };
    const timeUnits = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400 };
    
    React.useEffect(() => {
    try {
       setError('');
       let atomicWeight, crossSection, halfLife_s, productName;
       if (inputMode === 'fromDB') {
           const targetData = NEUTRON_ACTIVATION_DATA.find(t => t.targetSymbol === targetSymbol);
           if (!targetData) throw new Error('Target material data not found.');
           const productData = radionuclides.find(r => r.symbol === targetData.productSymbol);
           if (!productData) throw new Error(`Product nuclide ${targetData.productSymbol} not found in the main database.`);
           atomicWeight = targetData.atomicWeight;
           crossSection = targetData.thermalCrossSection_barns;
           halfLife_s = parseHalfLifeToSeconds(productData.halfLife);
           productName = `${productData.name} (${productData.symbol})`;
       } else {
           atomicWeight = parseFloat(manualAW);
           crossSection = parseFloat(manualCS);
           const hl_val = parseFloat(manualHL);
           halfLife_s = hl_val * (parseHalfLifeToSeconds(`1 ${manualHLUnit}`));
           productName = manualProductName || 'Product';
           if (isNaN(atomicWeight) || isNaN(crossSection) || isNaN(hl_val)) { if(manualAW && manualCS && manualHL) setError('Manual inputs must be valid numbers.'); setResult(null); return; }
       }
       const mass_g = parseFloat(targetMass) * massUnits[massUnit];
       const flux_n_cm2_s = parseFloat(neutronFlux);
       const time_s = parseFloat(irradiationTime) * timeUnits[timeUnit];
       if (isNaN(mass_g) || isNaN(flux_n_cm2_s) || isNaN(time_s) || mass_g <= 0 || flux_n_cm2_s < 0 || time_s < 0) { if (targetMass && neutronFlux && irradiationTime) setError('Mass, flux, and time must be positive numbers.'); setResult(null); return; }
       if (halfLife_s === Infinity) throw new Error('Product nuclide cannot be stable.');
       const AVOGADRO = 6.02214076e23; const BARN_TO_CM2 = 1e-24;
       const num_target_atoms = (mass_g / atomicWeight) * AVOGADRO;
       const product_lambda = Math.log(2) / halfLife_s;
       const cross_section_cm2 = crossSection * BARN_TO_CM2;
       const saturation_factor = 1 - Math.exp(-product_lambda * time_s);
       const activity_Bq = num_target_atoms * cross_section_cm2 * flux_n_cm2_s * saturation_factor;
       setResult({ productName: productName, activity_Bq: activity_Bq.toExponential(3), activity_Ci: (activity_Bq / 3.7e10).toExponential(3), saturation: (saturation_factor * 100).toFixed(2) });
    } catch (e) { setError(e.message); setResult(null); }
    }, [inputMode, targetSymbol, targetMass, massUnit, neutronFlux, irradiationTime, timeUnit, manualAW, manualCS, manualHL, manualHLUnit, manualProductName, radionuclides, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           const inputs = inputMode === 'fromDB' ? `${targetMass} ${massUnit} of ${targetSymbol}` : `${targetMass} ${massUnit} of Manual Target`;
           addHistory({ id: Date.now(), type: 'Neutron Activation', icon: ICONS.neutron, inputs: inputs, result: `${result.activity_Ci} Ci of ${result.productName}`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
           <button onClick={() => setInputMode('fromDB')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === 'fromDB' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>From Database</button>
           <button onClick={() => setInputMode('manual')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === 'manual' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Manual Input</button>
       </div>
       {inputMode === 'fromDB' ? (
           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
               <div><label className="block text-sm font-medium">Target Material</label><select value={targetSymbol} onChange={e => setTargetSymbol(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{NEUTRON_ACTIVATION_DATA.map(t => <option key={t.targetSymbol} value={t.targetSymbol}>{t.name}</option>)}</select></div>
           </div>
       ) : (
           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
               <div className="grid grid-cols-2 gap-4">
                   <div><label className="block text-sm font-medium">Target Atomic Weight (g/mol)</label><input type="number" value={manualAW} onChange={e => setManualAW(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                   <div><label className="block text-sm font-medium">Cross-Section (barns)</label><input type="number" value={manualCS} onChange={e => setManualCS(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               </div>
               <div><label className="block text-sm font-medium">Product Nuclide Name</label><input type="text" value={manualProductName} onChange={e => setManualProductName(e.target.value)} placeholder="For display only" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><label className="block text-sm font-medium">Product Half-Life</label><div className="flex"><input type="number" value={manualHL} onChange={e => setManualHL(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={manualHLUnit} onChange={e => setManualHLUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{longTimeUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
           </div>
       )}
       <div className="space-y-4">
           <div><label className="block text-sm font-medium">Target Mass</label><div className="flex"><input type="number" value={targetMass} onChange={e => setTargetMass(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={massUnit} onChange={e => setMassUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
           <div><label className="block text-sm font-medium">Thermal Neutron Flux (n/cm²·s)</label><input type="text" value={neutronFlux} onChange={e => setNeutronFlux(e.target.value)} placeholder="e.g., 1e12" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Irradiation Time</label><div className="flex"><input type="number" value={irradiationTime} onChange={e => setIrradiationTime(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(timeUnits).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
       </div>
       <ContextualNote>
           <strong>Note:</strong> This calculation assumes a purely thermal neutron flux and uses the thermal capture cross-section. Results may vary for other neutron energy spectra.
       </ContextualNote>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in">
               <div className="flex justify-between items-center -mt-2 -mb-2">
                   <div></div> {/* Spacer */}
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Activity of Produced {result.productName}</p>
                   <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                      <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                          <Icon path={ICONS.notepad} className="w-5 h-5" />
                      </button>
                   </Tooltip>
               </div>
               <div className="flex items-center justify-center my-1">
                   <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.activity_Ci} Ci</p>
                   <CopyButton textToCopy={result.activity_Ci} />
               </div>
               <p className="text-md text-slate-600 dark:text-slate-300">({result.activity_Bq} Bq)</p>
               <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">Saturation: {result.saturation}% of maximum possible activity</p>
           </div>
       )}
    </div>
    );
};

         
 const CompositeActivationCalculator = ({ radionuclides, material, setMaterial, totalMass, setTotalMass, massUnit, setMassUnit, neutronFlux, setNeutronFlux, irradiationTime, setIrradiationTime, timeUnit, setTimeUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const massUnits = { 'µg': 1e-6, 'mg': 1e-3, 'g': 1, 'kg': 1000 };
    const timeUnits = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400 };
    
    React.useEffect(() => {
    try {
       setError('');
       const materialData = COMPOSITE_MATERIALS_DATA[material];
       if (!materialData) throw new Error("Selected material data not found.");
       const total_mass_g = parseFloat(totalMass) * massUnits[massUnit];
       const flux_n_cm2_s = parseFloat(neutronFlux);
       const time_s = parseFloat(irradiationTime) * timeUnits[timeUnit];
       if (isNaN(total_mass_g) || isNaN(flux_n_cm2_s) || isNaN(time_s)) { if(totalMass && neutronFlux && irradiationTime) setError("Inputs must be valid numbers."); setResult(null); return; }
       const activationProducts = [];
       for (const component of materialData.composition) {
           const targetData = NEUTRON_ACTIVATION_DATA.find(t => t.targetSymbol === component.targetSymbol);
           if (!targetData) continue;
           const productData = radionuclides.find(r => r.symbol === targetData.productSymbol);
           if (!productData || productData.halfLife === 'Stable') continue;
           const component_mass_g = total_mass_g * component.massFraction;
           const AVOGADRO = 6.02214076e23; const BARN_TO_CM2 = 1e-24;
           const num_target_atoms = (component_mass_g / targetData.atomicWeight) * AVOGADRO;
           const product_half_life_s = parseHalfLifeToSeconds(productData.halfLife);
           const product_lambda = Math.log(2) / product_half_life_s;
           const cross_section_cm2 = targetData.thermalCrossSection_barns * BARN_TO_CM2;
           const saturation_factor = 1 - Math.exp(-product_lambda * time_s);
           const activity_Bq = num_target_atoms * cross_section_cm2 * flux_n_cm2_s * saturation_factor;
           if (activity_Bq > 1e-3) { activationProducts.push({ product: productData, targetElement: component.element, activity_Bq: activity_Bq, activity_Ci: activity_Bq / 3.7e10 }); }
       }
       activationProducts.sort((a, b) => b.activity_Bq - a.activity_Bq);
       setResult(activationProducts);
    } catch (e) { setError(e.message); setResult(null); }
    }, [material, totalMass, massUnit, neutronFlux, irradiationTime, timeUnit, radionuclides, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Composite Activation', icon: ICONS.neutron, inputs: `${totalMass} ${massUnit} of ${material}`, result: `${result.length} products found`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div><label className="block text-sm font-medium">Composite Material</label><select value={material} onChange={e => setMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(COMPOSITE_MATERIALS_DATA).map(m => <option key={m} value={m}>{m}</option>)}</select></div>
           <div><label className="block text-sm font-medium">Total Mass of Material</label><div className="flex"><input type="number" value={totalMass} onChange={e => setTotalMass(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={massUnit} onChange={e => setMassUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
           <div><label className="block text-sm font-medium">Thermal Neutron Flux (n/cm²·s)</label><input type="text" value={neutronFlux} onChange={e => setNeutronFlux(e.target.value)} placeholder="e.g., 1e12" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Irradiation Time</label><div className="flex"><input type="number" value={irradiationTime} onChange={e => setIrradiationTime(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(timeUnits).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (<div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in">
            <div className="flex justify-between items-center -mt-2">
                <h3 className="text-lg font-bold text-center text-slate-700 dark:text-slate-200 mb-2">Principal Activation Products</h3>
                <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                   <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                       <Icon path={ICONS.notepad} className="w-5 h-5" />
                   </button>
                </Tooltip>
            </div>
            <div className="space-y-2">{result.length > 0 ? result.map(p => (<div key={p.product.symbol} className="grid grid-cols-3 items-center text-sm"><span className="font-semibold text-sky-600 dark:text-sky-400">{p.product.name}</span><span className="text-xs text-center text-slate-500 dark:text-slate-400">(from {p.targetElement})</span><span className="font-mono text-right">{p.activity_Ci.toExponential(2)} Ci</span></div>)) : <p className="text-center text-sm text-slate-500 dark:text-slate-400">No significant activation products found with available data.</p>}</div>
            <p className="text-xs italic text-slate-500 dark:text-slate-400 mt-3 text-center">Note: Results based on typical compositions and available data. Actual activation may vary.</p>
        </div>)}
    </div>
    );
};
         
 const NeutronShieldingCalculator = ({ selectedEnergy, setSelectedEnergy, initialFlux, setInitialFlux, shieldMaterial, setShieldMaterial, shieldThickness, setShieldThickness, thicknessUnit, setThicknessUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const thicknessFactors_cm = { 'mm': 0.1, 'cm': 1, 'in': 2.54, 'ft': 30.48 };
    const currentShieldingData = React.useMemo(() => {
    const energyMeV = parseFloat(selectedEnergy);
    return energyMeV < 1e-4 ? THERMAL_NEUTRON_SHIELDING_DATA : FAST_NEUTRON_SHIELDING_DATA;
    }, [selectedEnergy]);
    
    React.useEffect(() => {
    if (!Object.keys(currentShieldingData).includes(shieldMaterial)) {
       setShieldMaterial(Object.keys(currentShieldingData)[0]);
    }
    }, [currentShieldingData, shieldMaterial, setShieldMaterial]);
    
    const logLogInterpolate = (targetX, x1, y1, x2, y2) => y1 * Math.pow(targetX / x1, Math.log(y2 / y1) / Math.log(x2 / x1));
    
    React.useEffect(() => {
    try {
       setError('');
       const flux_val = parseFloat(initialFlux); const thickness_val = parseFloat(shieldThickness); const energyVal = parseFloat(selectedEnergy);
       if (isNaN(flux_val) || isNaN(thickness_val) || isNaN(energyVal) || flux_val < 0 || thickness_val < 0 || energyVal <= 0) { 
           if(initialFlux && shieldThickness && selectedEnergy) setError("Please enter valid positive numbers for inputs."); 
           setResult(null); return; 
       }
       const hvl_cm = currentShieldingData[shieldMaterial]?.hvl_cm;
       if (!hvl_cm) { throw new Error("Shielding data not available for this material/energy combination."); }
       let p1 = NEUTRON_CONVERSION_FACTORS[0], p2 = NEUTRON_CONVERSION_FACTORS[NEUTRON_CONVERSION_FACTORS.length - 1];
       if (energyVal < p1.energyMeV) { p2 = p1; } 
       else if (energyVal > p2.energyMeV) { p1 = p2; } 
       else {
           for (let i = 0; i < NEUTRON_CONVERSION_FACTORS.length - 1; i++) {
               if (energyVal >= NEUTRON_CONVERSION_FACTORS[i].energyMeV && energyVal <= NEUTRON_CONVERSION_FACTORS[i + 1].energyMeV) { 
                   p1 = NEUTRON_CONVERSION_FACTORS[i]; p2 = NEUTRON_CONVERSION_FACTORS[i + 1]; break; 
               }
           }
       }
       const fluencePerRem = (p1.energyMeV === p2.energyMeV) ? p1.fluencePerRem : logLogInterpolate(energyVal, p1.energyMeV, p1.fluencePerRem, p2.energyMeV, p2.fluencePerRem);
       const FLUX_TO_DOSE_RATE_FACTOR = (1 / fluencePerRem) * 1000 * 3600;
       const thickness_cm = thickness_val * thicknessFactors_cm[thicknessUnit];
       const final_flux = flux_val * Math.pow(0.5, thickness_cm / hvl_cm);
       const initial_dose_rate_mrem_hr = flux_val * FLUX_TO_DOSE_RATE_FACTOR;
       const final_dose_rate_mrem_hr = final_flux * FLUX_TO_DOSE_RATE_FACTOR;
       setResult({ initialFlux: flux_val.toExponential(3), finalFlux: final_flux.toExponential(3), initialDose: formatSensibleUnit(initial_dose_rate_mrem_hr, 'doseRate'), finalDose: formatSensibleUnit(final_dose_rate_mrem_hr, 'doseRate') });
    } catch(e) { setError("Calculation error."); setResult(null); }
    }, [initialFlux, shieldMaterial, shieldThickness, thicknessUnit, selectedEnergy, currentShieldingData, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Neutron Shielding', icon: ICONS.shield, inputs: `${shieldThickness} ${thicknessUnit} of ${shieldMaterial}`, result: `Final: ${result.finalDose.value} ${result.finalDose.unit}`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div><label className="block text-sm font-medium">Neutron Energy</label><select value={selectedEnergy} onChange={e => setSelectedEnergy(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{NEUTRON_CONVERSION_FACTORS.map(f => <option key={f.energyMeV} value={f.energyMeV}>{f.label}</option>)}</select></div>
           <div><label className="block text-sm font-medium">Initial Neutron Flux (n/cm²·s)</label><input type="text" value={initialFlux} onChange={e => setInitialFlux(e.target.value)} placeholder="e.g., 1e6" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Shield Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(currentShieldingData).map(m => <option key={m} value={m}>{m} (HVL: {currentShieldingData[m].hvl_cm} cm)</option>)}</select><p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Note: HVL data is an approximation for broad "fast" or "thermal" categories.</p></div>
           <div><label className="block text-sm font-medium">Shield Thickness</label><div className="flex"><input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(thicknessFactors_cm).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-2 animate-fade-in">
               <div className="flex justify-end -mt-2 -mr-2">
                   <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                      <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                          <Icon path={ICONS.notepad} className="w-5 h-5" />
                      </button>
                   </Tooltip>
               </div>
               <div className="-mt-4">
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Unshielded</p>
                   <p className="text-xl font-bold text-slate-600 dark:text-slate-300">{result.initialDose.value} {result.initialDose.unit}</p>
                   <p className="text-xs font-mono">({result.initialFlux} n/cm²·s)</p>
               </div>
               <div className="font-bold text-2xl">↓</div>
               <div>
                   <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Shielded</p>
                   <div className="flex items-center justify-center">
                       <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.finalDose.value} {result.finalDose.unit}</p>
                       <CopyButton textToCopy={result.finalDose.value} />
                   </div>
                   <p className="text-xs font-mono">({result.finalFlux} n/cm²·s)</p>
               </div>
           </div>
       )}
    </div>
    );
};
         
         /**
         * @description React component that serves as a container for various neutron-related calculation tools.
         * It provides a tabbed interface for users to switch between four different functionalities
         * relevant to neutron radiation protection and analysis.
         *
         * This component manages the state for all four sub-calculators, ensuring their inputs and outputs
         * are distinct and isolated. It also includes a single "Clear All" button that resets the state
         * of the currently active calculator.
         *
         * The included tools are:
         * 1.  **Fluence/Dose:** Converts between neutron fluence (n/cm²) and dose equivalent (rem or Sv)
         * for a given neutron energy, based on standard fluence-to-dose conversion factors.
         * 2.  **Activation:** Calculates the activity produced in a pure target material after irradiation
         * in a neutron flux. It supports both database lookup for common reactions and manual input.
         * 3.  **Composite Activation:** Estimates the activity of the principal activation products
         * from irradiating common composite materials like concrete or steel.
         * 4.  **Shielding:** Calculates the attenuation of fast or thermal neutrons through various
         * shielding materials based on their half-value layer (HVL) data.
         *
         * @prop {array} radionuclides - A comprehensive array of radionuclide data, used by the activation
         * and composite activation calculators.
         */
         
         const NeutronCalculator = ({radionuclides}) => {
         const [activeTab, setActiveTab] = React.useState('fluenceDose');
         
         // State for FluenceDoseConverter
         const [fluence_calcMode, setFluence_calcMode] = React.useState('fluenceToDose');
         const [fluence_energy, setFluence_energy] = React.useState('1');
         const [fluence_inputValue, setFluence_inputValue] = React.useState('1e6');
         const [fluence_result, setFluence_result] = React.useState(null);
         const [fluence_error, setFluence_error] = React.useState('');
         
         // State for ActivationCalculator
         const [act_inputMode, setAct_inputMode] = React.useState('fromDB');
         const [act_targetMass, setAct_targetMass] = React.useState('1');
         const [act_massUnit, setAct_massUnit] = React.useState('g');
         const [act_neutronFlux, setAct_neutronFlux] = React.useState('1e12');
         const [act_irradiationTime, setAct_irradiationTime] = React.useState('1');
         const [act_timeUnit, setAct_timeUnit] = React.useState('hours');
         const [act_result, setAct_result] = React.useState(null);
         const [act_error, setAct_error] = React.useState('');
         const [act_targetSymbol, setAct_targetSymbol] = React.useState('Co-59');
         const [act_manualAW, setAct_manualAW] = React.useState('58.933');
         const [act_manualCS, setAct_manualCS] = React.useState('37.2');
         const [act_manualHL, setAct_manualHL] = React.useState('5.27');
         const [act_manualHLUnit, setAct_manualHLUnit] = React.useState('years');
         const [act_manualProductName, setAct_manualProductName] = React.useState('Co-60');
         
         // State for CompositeActivationCalculator
         const [comp_material, setComp_material] = React.useState('Ordinary Concrete');
         const [comp_totalMass, setComp_totalMass] = React.useState('100');
         const [comp_massUnit, setComp_massUnit] = React.useState('kg');
         const [comp_neutronFlux, setComp_neutronFlux] = React.useState('1e12');
         const [comp_irradiationTime, setComp_irradiationTime] = React.useState('8');
         const [comp_timeUnit, setComp_timeUnit] = React.useState('hours');
         const [comp_result, setComp_result] = React.useState(null);
         const [comp_error, setComp_error] = React.useState('');
         
         // State for NeutronShieldingCalculator
         const [shield_selectedEnergy, setShield_selectedEnergy] = React.useState('2.5');
         const [shield_initialFlux, setShield_initialFlux] = React.useState('1e6');
         const [shield_shieldMaterial, setShield_shieldMaterial] = React.useState('Polyethylene');
         const [shield_shieldThickness, setShield_shieldThickness] = React.useState('10');
         const [shield_thicknessUnit, setShield_thicknessUnit] = React.useState('cm');
         const [shield_result, setShield_result] = React.useState(null);
         const [shield_error, setShield_error] = React.useState('');
         
         const handleFluenceClear = () => {
         setFluence_calcMode('fluenceToDose'); setFluence_energy('1'); setFluence_inputValue('1e6');
         setFluence_result(null); setFluence_error('');
         };
         const handleActivationClear = () => {
         setAct_inputMode('fromDB'); setAct_targetMass('1'); setAct_massUnit('g'); setAct_neutronFlux('1e12');
         setAct_irradiationTime('1'); setAct_timeUnit('hours'); setAct_targetSymbol('Co-59');
         setAct_manualAW('58.933'); setAct_manualCS('37.2'); setAct_manualHL('5.27'); setAct_manualHLUnit('years');
         setAct_manualProductName('Co-60'); setAct_result(null); setAct_error('');
         };
         const handleCompositeClear = () => {
         setComp_material('Ordinary Concrete'); setComp_totalMass('100'); setComp_massUnit('kg');
         setComp_neutronFlux('1e12'); setComp_irradiationTime('8'); setComp_timeUnit('hours');
         setComp_result(null); setComp_error('');
         };
         const handleShieldingClear = () => {
         setShield_selectedEnergy('2.5'); setShield_initialFlux('1e6'); setShield_shieldMaterial('Polyethylene');
         setShield_shieldThickness('10'); setShield_thicknessUnit('cm'); setShield_result(null); setShield_error('');
         };
         
         const handleClearActiveCalculator = () => {
         switch (activeTab) {
            case 'fluenceDose': handleFluenceClear(); break;
            case 'activation': handleActivationClear(); break;
            case 'composite': handleCompositeClear(); break;
            case 'shielding': handleShieldingClear(); break;
            default: break;
         }
         };
         
         return (
         <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Neutron Tools</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setActiveTab('fluenceDose')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'fluenceDose' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Fluence</button>
                    <button onClick={() => setActiveTab('activation')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'activation' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Activation</button>
                    <button onClick={() => setActiveTab('composite')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'composite' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Composite</button>
                    <button onClick={() => setActiveTab('shielding')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'shielding' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Shielding</button>
                </div>
                {activeTab === 'fluenceDose' && <FluenceDoseConverter 
                    calcMode={fluence_calcMode} setCalcMode={setFluence_calcMode}
                    energy={fluence_energy} setEnergy={setFluence_energy}
                    inputValue={fluence_inputValue} setInputValue={setFluence_inputValue}
                    result={fluence_result} setResult={setFluence_result}
                    error={fluence_error} setError={setFluence_error}
                />}
                {activeTab === 'activation' && <ActivationCalculator 
                    radionuclides={radionuclides}
                    inputMode={act_inputMode} setInputMode={setAct_inputMode}
                    targetMass={act_targetMass} setTargetMass={setAct_targetMass}
                    massUnit={act_massUnit} setMassUnit={setAct_massUnit}
                    neutronFlux={act_neutronFlux} setNeutronFlux={setAct_neutronFlux}
                    irradiationTime={act_irradiationTime} setIrradiationTime={setAct_irradiationTime}
                    timeUnit={act_timeUnit} setTimeUnit={setAct_timeUnit}
                    result={act_result} setResult={setAct_result}
                    error={act_error} setError={setAct_error}
                    targetSymbol={act_targetSymbol} setTargetSymbol={setAct_targetSymbol}
                    manualAW={act_manualAW} setManualAW={setAct_manualAW}
                    manualCS={act_manualCS} setManualCS={setAct_manualCS}
                    manualHL={act_manualHL} setManualHL={setAct_manualHL}
                    manualHLUnit={act_manualHLUnit} setManualHLUnit={setAct_manualHLUnit}
                    manualProductName={act_manualProductName} setManualProductName={setAct_manualProductName}
                />}
                {activeTab === 'composite' && <CompositeActivationCalculator 
                    radionuclides={radionuclides}
                    material={comp_material} setMaterial={setComp_material}
                    totalMass={comp_totalMass} setTotalMass={setComp_totalMass}
                    massUnit={comp_massUnit} setMassUnit={setComp_massUnit}
                    neutronFlux={comp_neutronFlux} setNeutronFlux={setComp_neutronFlux}
                    irradiationTime={comp_irradiationTime} setIrradiationTime={setComp_irradiationTime}
                    timeUnit={comp_timeUnit} setTimeUnit={setComp_timeUnit}
                    result={comp_result} setResult={setComp_result}
                    error={comp_error} setError={setComp_error}
                />}
                {activeTab === 'shielding' && <NeutronShieldingCalculator 
                    selectedEnergy={shield_selectedEnergy} setSelectedEnergy={setShield_selectedEnergy}
                    initialFlux={shield_initialFlux} setInitialFlux={setShield_initialFlux}
                    shieldMaterial={shield_shieldMaterial} setShieldMaterial={setShield_shieldMaterial}
                    shieldThickness={shield_shieldThickness} setShieldThickness={setShield_shieldThickness}
                    thicknessUnit={shield_thicknessUnit} setThicknessUnit={setShield_thicknessUnit}
                    result={shield_result} setResult={setShield_result}
                    error={shield_error} setError={setShield_error}
                />}
            </div>
         </div>
         );
         };
         
         /**
         * @description A unified calculator for determining detection limits for both
         * MARSSIM-compliant static counts and scanning surveys.
         */
         


const MDACalculator = () => {
    const MDA_MODE_STATIC = 'static';
    const MDA_MODE_SCAN = 'scan';
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast(); // Added for the save confirmation message
    
    const [mdaMode, setMdaMode] = React.useState(() => localStorage.getItem('mda_mdaMode') || MDA_MODE_STATIC);
    
    // State for Static MDA
    const [backgroundCounts, setBackgroundCounts] = React.useState(() => localStorage.getItem('mda_backgroundCounts') || '1000');
    const [backgroundTime, setBackgroundTime] = React.useState(() => localStorage.getItem('mda_backgroundTime') || '10');
    const [grossTime, setGrossTime] = React.useState(() => localStorage.getItem('mda_grossTime') || '1');
    const [confidence, setConfidence] = React.useState(() => localStorage.getItem('mda_confidence') || '1.645');
    const [outputUnit, setOutputUnit] = React.useState(() => localStorage.getItem('mda_outputUnit') || 'dpm');
    const [sampleVolume, setSampleVolume] = React.useState(() => localStorage.getItem('mda_sampleVolume') || '1');
    const [sampleMass, setSampleMass] = React.useState(() => localStorage.getItem('mda_sampleMass') || '100');
    
    // State for Scan MDC
    const [scanBackground, setScanBackground] = React.useState(() => localStorage.getItem('mda_scanBackground') || '300');
    const [scanSpeed, setScanSpeed] = React.useState(() => localStorage.getItem('mda_scanSpeed') || '12.6');
    const [hotspotDiameter, setHotspotDiameter] = React.useState(() => localStorage.getItem('mda_hotspotDiameter') || '15');
    const [dprime, setDprime] = React.useState(() => localStorage.getItem('mda_dprime') || '1.38');
    const [surveyorEff, setSurveyorEff] = React.useState(() => localStorage.getItem('mda_surveyorEff') || '0.5');
    
    // Shared State
    const [probeShape, setProbeShape] = React.useState(() => localStorage.getItem('mda_probeShape') || 'rectangle');
    const [probeWidth, setProbeWidth] = React.useState(() => localStorage.getItem('mda_probeWidth') || '10');
    const [probeLength, setProbeLength] = React.useState(() => localStorage.getItem('mda_probeLength') || '12.6');
    const [probeDiameter, setProbeDiameter] = React.useState(() => localStorage.getItem('mda_probeDiameter') || '4.5');
    const [probeArea, setProbeArea] = React.useState(() => localStorage.getItem('mda_probeArea') || '126');
    const [instrumentEff, setInstrumentEff] = React.useState(() => localStorage.getItem('mda_instrumentEff') || '22');
    const [surfaceEff, setSurfaceEff] = React.useState(() => localStorage.getItem('mda_surfaceEff') || '50');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    const MDA_UNIT_CONFIG = { 'counts': { label: 'LLD (counts)', category: 'Counts', requires: [] }, 'cpm': { label: 'MDCR (cpm)', category: 'Rate', requires: [] }, 'dpm': { label: 'Activity (dpm)', category: 'Activity', requires: ['efficiency'] }, 'Bq': { label: 'Activity (Bq)', category: 'Activity', requires: ['efficiency'] }, 'µCi': { label: 'Activity (µCi)', category: 'Activity', requires: ['efficiency'] }, 'mCi': { label: 'Activity (mCi)', category: 'Activity', requires: ['efficiency'] }, 'Ci': { label: 'Activity (Ci)', category: 'Activity', requires: ['efficiency'] }, 'dpm/100cm²': { label: 'Surface (dpm/100cm²)', category: 'Concentration', requires: ['efficiency', 'area'] }, 'Bq/L': { label: 'Liquid (Bq/L)', category: 'Concentration', requires: ['efficiency', 'volume'] }, 'pCi/g': { label: 'Solid (pCi/g)', category: 'Concentration', requires: ['efficiency', 'mass'] } };
    const dpmFactors = { 'dpm': 1, 'Bq': 1 / 60, 'µCi': 1 / 2.22e6, 'mCi': 1 / 2.22e9, 'Ci': 1 / 2.22e12 };
    const confidenceOptions = [ { value: '1.282', label: '90%' }, { value: '1.645', label: '95%' }, { value: '2.326', label: '99%' } ];
    const dprimeOptions = [ { value: '0.4', label: '0.4 (Conservative)' }, { value: '1.0', label: '1.0 (Computer-aided GWS)' }, { value: '1.04', label: '1.04 (85% detection prob.)' }, { value: '1.28', label: '1.28 (90% detection prob.)' }, { value: '1.38', label: '1.38 (95% detection prob.)' } ];
    const surveyorEffOptions = [ { value: '0.25', label: '0.25 (Very conservative)' }, { value: '0.5', label: '0.5 (Realistic default)' }, { value: '0.75', label: '0.75 (Highly trained/attentive)' }, { value: '1.0', label: '1.0 (Computer-aided scan)' } ];
    
    React.useEffect(() => {
    localStorage.setItem('mda_mdaMode', mdaMode);
    localStorage.setItem('mda_backgroundCounts', backgroundCounts);
    localStorage.setItem('mda_backgroundTime', backgroundTime);
    localStorage.setItem('mda_grossTime', grossTime);
    localStorage.setItem('mda_confidence', confidence);
    localStorage.setItem('mda_outputUnit', outputUnit);
    localStorage.setItem('mda_sampleVolume', sampleVolume);
    localStorage.setItem('mda_sampleMass', sampleMass);
    localStorage.setItem('mda_scanBackground', scanBackground);
    localStorage.setItem('mda_scanSpeed', scanSpeed);
    localStorage.setItem('mda_hotspotDiameter', hotspotDiameter);
    localStorage.setItem('mda_dprime', dprime);
    localStorage.setItem('mda_surveyorEff', surveyorEff);
    localStorage.setItem('mda_probeShape', probeShape);
    localStorage.setItem('mda_probeWidth', probeWidth);
    localStorage.setItem('mda_probeLength', probeLength);
    localStorage.setItem('mda_probeDiameter', probeDiameter);
    localStorage.setItem('mda_probeArea', probeArea);
    localStorage.setItem('mda_instrumentEff', instrumentEff);
    localStorage.setItem('mda_surfaceEff', surfaceEff);
    }, [ mdaMode, backgroundCounts, backgroundTime, grossTime, confidence, outputUnit, sampleVolume, sampleMass, scanBackground, scanSpeed, hotspotDiameter, dprime, surveyorEff, probeShape, probeWidth, probeLength, probeDiameter, probeArea, instrumentEff, surfaceEff ]);
    
    const handleStaticCalculate = () => {
        const params = { Cb: parseFloat(backgroundCounts), tb: parseFloat(backgroundTime), tg: parseFloat(grossTime), ei: parseFloat(instrumentEff), es: parseFloat(surfaceEff), A: parseFloat(probeArea), V: parseFloat(sampleVolume), M: parseFloat(sampleMass) };
        if (isNaN(params.Cb) || isNaN(params.tb) || isNaN(params.tg) || params.tb <= 0 || params.tg <= 0) { throw new Error('Please enter valid, positive numbers for counts and times.'); }
        const rb = params.Cb / params.tb;
        const LLD = 3.29 * Math.sqrt(rb * params.tg * (1 + params.tg / params.tb)) + 3;
        if (outputUnit === 'counts') { setResult({ type: 'static', LLD: LLD.toPrecision(3), MDA: LLD.toPrecision(3), unit: 'counts', backgroundActivity: rb.toPrecision(3) }); return; }
        if (isNaN(params.ei) || isNaN(params.es) || params.ei <= 0 || params.es <= 0) { throw new Error('Valid efficiencies are required for this unit.'); }
        const E_total = (params.ei / 100.0) * (params.es / 100.0);
        const mda_dpm = (LLD / params.tg) / E_total;
        const background_dpm = rb / E_total;
        let finalMDA, finalBackground, finalUnit = outputUnit;
        if (MDA_UNIT_CONFIG[outputUnit].category === 'Activity') { finalMDA = mda_dpm / dpmFactors[outputUnit]; finalBackground = background_dpm / dpmFactors[outputUnit]; } 
        else if (outputUnit === 'dpm/100cm²') { if (isNaN(params.A) || params.A <= 0) throw new Error('Probe Area is required for this unit.'); finalMDA = mda_dpm * (100 / params.A); finalBackground = background_dpm * (100 / params.A); } 
        else if (outputUnit === 'Bq/L') { if (isNaN(params.V) || params.V <= 0) throw new Error('Sample Volume is required for this unit.'); finalMDA = (mda_dpm / 60) / params.V; finalBackground = (background_dpm / 60) / params.V; } 
        else if (outputUnit === 'pCi/g') { if (isNaN(params.M) || params.M <= 0) throw new Error('Sample Mass is required for this unit.'); finalMDA = (mda_dpm / 2.22) / params.M; finalBackground = (background_dpm / 2.22) / params.M; } 
        else if (outputUnit === 'cpm') { finalMDA = LLD / params.tg; finalBackground = rb; } 
        else { throw new Error('Selected unit calculation not implemented.'); }
        const newResult = { type: 'static', LLD: LLD.toPrecision(3), MDA: finalMDA.toPrecision(3), backgroundActivity: finalBackground.toPrecision(3), unit: finalUnit };
        setResult(newResult);
        // REMOVED addHistory CALL
    };
    
    const handleScanCalculate = () => {
        const params = { b_cpm: parseFloat(scanBackground), width_cm: parseFloat(probeWidth), length_cm: parseFloat(probeLength), diameter_cm: parseFloat(probeDiameter), eff_i: parseFloat(instrumentEff), eff_s: parseFloat(surfaceEff), speed_cms: parseFloat(scanSpeed), dp: parseFloat(dprime), p: parseFloat(surveyorEff) };
        if (isNaN(params.b_cpm) || isNaN(params.eff_i) || isNaN(params.eff_s) || isNaN(params.speed_cms) || params.b_cpm < 0 || params.eff_i <= 0 || params.eff_s <= 0 || params.speed_cms <= 0) { throw new Error('Please enter valid, positive numbers for all required fields.'); }
        let residence_time_s; let total_area_cm2;
        const hotspot_diam_cm = parseFloat(hotspotDiameter);
        if (probeShape === 'rectangle') {
           if (isNaN(params.width_cm) || isNaN(params.length_cm) || params.width_cm <= 0 || params.length_cm <= 0) { throw new Error('Probe Width and Length must be positive numbers for a rectangle.'); }
           let effective_dimension_cm = params.width_cm; if (!isNaN(hotspot_diam_cm) && hotspot_diam_cm > 0 && hotspot_diam_cm < effective_dimension_cm) { effective_dimension_cm = hotspot_diam_cm; }
           residence_time_s = effective_dimension_cm / params.speed_cms; total_area_cm2 = params.width_cm * params.length_cm;
        } else {
           if (isNaN(params.diameter_cm) || params.diameter_cm <= 0) { throw new Error('Probe Diameter must be a positive number for a circle.'); }
           let effective_dimension_cm = params.diameter_cm; if (!isNaN(hotspot_diam_cm) && hotspot_diam_cm > 0 && hotspot_diam_cm < effective_dimension_cm) { effective_dimension_cm = hotspot_diam_cm; }
           residence_time_s = effective_dimension_cm / params.speed_cms; total_area_cm2 = Math.PI * Math.pow(params.diameter_cm / 2, 2);
        }
        const b_cps = params.b_cpm / 60.0; const E_total = (params.eff_i / 100.0) * (params.eff_s / 100.0);
        const B_i = b_cps * residence_time_s; const mdcr_surveyor_cpm = params.dp * Math.sqrt(B_i) * (60 / residence_time_s);
        const scan_mda = mdcr_surveyor_cpm / (Math.sqrt(params.p) * E_total * (total_area_cm2 / 100.0));
        const background_activity = params.b_cpm / (E_total * (total_area_cm2 / 100.0));
        const newResult = { type: 'scan', obs_interval: residence_time_s.toPrecision(3), bg_counts_in_interval: B_i.toPrecision(3), mdcr: mdcr_surveyor_cpm.toPrecision(3), scan_mda: scan_mda.toPrecision(3), background_activity: background_activity.toPrecision(3) };
        setResult(newResult);
        // REMOVED addHistory CALL
    };
    
    // ADDED a dedicated function for saving to history
    const handleSaveToHistory = () => {
        if (!result) return;
        if (mdaMode === MDA_MODE_STATIC) {
            addHistory({
                id: Date.now(),
                type: 'Static MDA',
                icon: ICONS.search,
                inputs: `Bkg: ${backgroundCounts} counts, Sample Time: ${grossTime} min`,
                result: `${result.MDA} ${result.unit}`,
                view: VIEWS.MDA
            });
        } else { // MDA_MODE_SCAN
            addHistory({
                id: Date.now(),
                type: 'Scan MDC',
                icon: ICONS.search,
                inputs: `Bkg: ${scanBackground} cpm, Speed: ${scanSpeed} cm/s`,
                result: `${result.scan_mda} dpm/100cm²`,
                view: VIEWS.MDA
            });
        }
        addToast("Calculation saved to history!");
    };
    
    React.useEffect(() => {
    try {
       setError('');
       setResult(null);
       if (mdaMode === MDA_MODE_STATIC) {
           handleStaticCalculate();
       } else {
           handleScanCalculate();
       }
    } catch (e) {
       setError(e.message);
       setResult(null);
    }
    }, [ mdaMode, backgroundCounts, backgroundTime, grossTime, confidence, outputUnit, sampleVolume, sampleMass, scanBackground, scanSpeed, dprime, surveyorEff, probeArea, instrumentEff, surfaceEff, probeShape, probeWidth, probeLength, probeDiameter, hotspotDiameter ]);
    
    const handleClearInputs = () => {
    setMdaMode(MDA_MODE_STATIC);
    setBackgroundCounts('1000');
    setBackgroundTime('10');
    setGrossTime('1');
    setConfidence('1.645');
    setOutputUnit('dpm');
    setSampleVolume('1');
    setSampleMass('100');
    setScanBackground('300');
    setScanSpeed('12.6');
    setHotspotDiameter('15');
    setDprime('1.38');
    setSurveyorEff('0.5');
    setProbeShape('rectangle');
    setProbeWidth('10');
    setProbeLength('12.6');
    setProbeDiameter('4.5');
    setProbeArea('126');
    setInstrumentEff('22');
    setSurfaceEff('50');
    setResult(null);
    setError('');
    };
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Detection Limit Calculator</h2>
               <ClearButton onClick={handleClearInputs} />
           </div>
           <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
               <button onClick={() => { setMdaMode(MDA_MODE_STATIC); setResult(null); setError(''); }} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${mdaMode === MDA_MODE_STATIC ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Static Count MDA</button>
               <button onClick={() => { setMdaMode(MDA_MODE_SCAN); setResult(null); setError(''); }} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${mdaMode === MDA_MODE_SCAN ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Scan Survey MDC</button>
           </div>
           {mdaMode === MDA_MODE_STATIC ? (
               <div className="space-y-4 animate-fade-in">
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <div><label className="block text-sm font-medium">Background Counts</label><input type="number" value={backgroundCounts} onChange={e => setBackgroundCounts(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div><label className="block text-sm font-medium">Bkg. Count Time (min)</label><input type="number" value={backgroundTime} onChange={e => setBackgroundTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div><label className="block text-sm font-medium">Sample Count Time (min)</label><input type="number" value={grossTime} onChange={e => setGrossTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div className="md:col-span-2"><label className="block text-sm font-medium">Desired Output Unit</label><select value={outputUnit} onChange={e => setOutputUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><optgroup label="Counts"><option value="counts">{MDA_UNIT_CONFIG['counts'].label}</option></optgroup><optgroup label="Rate"><option value="cpm">{MDA_UNIT_CONFIG['cpm'].label}</option></optgroup><optgroup label="Activity">{Object.keys(MDA_UNIT_CONFIG).filter(k => MDA_UNIT_CONFIG[k].category === 'Activity').map(u => <option key={u} value={u}>{MDA_UNIT_CONFIG[u].label}</option>)}</optgroup><optgroup label="Concentration">{Object.keys(MDA_UNIT_CONFIG).filter(k => MDA_UNIT_CONFIG[k].category === 'Concentration').map(u => <option key={u} value={u}>{MDA_UNIT_CONFIG[u].label}</option>)}</optgroup></select></div>
                       {MDA_UNIT_CONFIG[outputUnit].requires.includes('efficiency') && ( <><div className="animate-fade-in"><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div><div className="animate-fade-in"><label className="block text-sm font-medium">Source/Surface Efficiency (%)</label><input type="number" value={surfaceEff} onChange={e => setSurfaceEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div></> )}
                       {MDA_UNIT_CONFIG[outputUnit].requires.includes('area') && ( <div className="animate-fade-in md:col-span-2"><label className="block text-sm font-medium">Probe Area (cm²)</label><input type="number" value={probeArea} onChange={e => setProbeArea(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div> )}
                       {MDA_UNIT_CONFIG[outputUnit].requires.includes('volume') && ( <div className="animate-fade-in md:col-span-2"><label className="block text-sm font-medium">Sample Volume (L)</label><input type="number" value={sampleVolume} onChange={e => setSampleVolume(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div> )}
                       {MDA_UNIT_CONFIG[outputUnit].requires.includes('mass') && ( <div className="animate-fade-in md:col-span-2"><label className="block text-sm font-medium">Sample Mass (g)</label><input type="number" value={sampleMass} onChange={e => setSampleMass(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div> )}
                   </div>
               </div>
           ) : (
               <div className="space-y-4 animate-fade-in">
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <div><label className="block text-sm font-medium">Background Rate (cpm)</label><input type="number" value={scanBackground} onChange={e => setScanBackground(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div><label className="block text-sm font-medium">Scan Speed (cm/s)</label><input type="number" value={scanSpeed} onChange={e => setScanSpeed(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div className="md:col-span-2"><label className="block text-sm font-medium">Probe Shape</label><div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mt-1"><button onClick={() => setProbeShape('rectangle')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${probeShape === 'rectangle' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Rectangle</button><button onClick={() => setProbeShape('circle')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${probeShape === 'circle' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Circle</button></div></div>
                       {probeShape === 'rectangle' ? ( <><div className="animate-fade-in"><Tooltip text="The probe dimension perpendicular to the direction of scan."><label className="block text-sm font-medium">Probe Width (cm)</label></Tooltip><input type="number" value={probeWidth} onChange={e => setProbeWidth(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div><div className="animate-fade-in"><label className="block text-sm font-medium">Probe Length (cm)</label><input type="number" value={probeLength} onChange={e => setProbeLength(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div></> ) : ( <div className="animate-fade-in md:col-span-2"><label className="block text-sm font-medium">Probe Diameter (cm)</label><input type="number" value={probeDiameter} onChange={e => setProbeDiameter(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div> )}
                       <div><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div><div><label className="block text-sm font-medium">Surface Efficiency (%)</label><input type="number" value={surfaceEff} onChange={e => setSurfaceEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div className="md:col-span-2"><label className="block text-sm font-medium">Hot Spot Diameter (cm)</label><input type="number" value={hotspotDiameter} onChange={e => setHotspotDiameter(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                   </div>
                   <details className="p-2 rounded-lg bg-slate-50 dark:bg-slate-900/50"><summary className="cursor-pointer text-sm font-semibold">Advanced Factors</summary><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700"><div><label className="block text-sm font-medium">Detectability Index (d')</label><Tooltip text="Guidance from MARSSIM 6.7.2.1. Relates the desired probability of detecting a hot spot."><select value={dprime} onChange={e => setDprime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{dprimeOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></Tooltip></div><div><label className="block text-sm font-medium">Surveyor Efficiency (p)</label><Tooltip text="Guidance from NUREG-1507, Sec. 6.6. Accounts for the human factor of the surveyor noticing an audible signal."><select value={surveyorEff} onChange={e => setSurveyorEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{surveyorEffOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></Tooltip></div></div></details>
               </div>
           )}
           {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
           {result && (
               <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 animate-fade-in">
                   {result.type === 'static' ? (
                       <>
                           <div className="flex justify-between items-center -mt-2 -mb-2">
                               <div></div> {/* Spacer */}
                               <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-left p-2">
                                   <span className="font-semibold text-slate-600 dark:text-slate-300">LLD:</span><span className="font-mono text-right">{result.LLD} net counts</span>
                                   {result.unit !== 'counts' && <span className="font-semibold text-slate-600 dark:text-slate-300">Bkg. Equiv:</span>}
                                   {result.unit !== 'counts' && <span className="font-mono text-right">{result.backgroundActivity} {result.unit}</span>}
                               </div>
                               {/* ADDED the save button */}
                               <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                                  <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                      <Icon path={ICONS.notepad} className="w-5 h-5" />
                                  </button>
                               </Tooltip>
                           </div>
                           <div className="text-center pt-2 border-t border-slate-300 dark:border-slate-600">
                               <p className="font-semibold text-sm text-slate-500 dark:text-slate-400">{ result.unit === 'counts' ? 'Lower Limit of Detection (LLD)' : result.unit === 'cpm' ? 'Minimum Detectable Count Rate (MDCR)' : 'Minimum Detectable Activity/Conc.' }</p>
                               <div className="flex items-center justify-center">
                                   <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.MDA}</p>
                                   <CopyButton textToCopy={result.MDA} />
                               </div>
                               <p className="text-md font-medium text-slate-600 dark:text-slate-300">{result.unit}</p>
                           </div>
                       </>
                   ) : (
                       <div className="space-y-3">
                           <div className="flex justify-between items-center -mt-2">
                               <h3 className="text-lg font-bold text-center mb-2">Scan Survey Results</h3>
                               {/* ADDED the save button */}
                               <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                                  <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                      <Icon path={ICONS.notepad} className="w-5 h-5" />
                                  </button>
                               </Tooltip>
                           </div>
                           <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-left p-2 border-b border-slate-300 dark:border-slate-600"><span className="font-semibold text-slate-600 dark:text-slate-300">Observation Interval:</span><span className="font-mono text-right">{result.obs_interval} s</span><span className="font-semibold text-slate-600 dark:text-slate-300">Bkg. Counts in Interval:</span><span className="font-mono text-right">{result.bg_counts_in_interval} counts</span><span className="font-semibold text-slate-600 dark:text-slate-300">MDCR (Surveyor):</span><span className="font-mono text-right">{result.mdcr} cpm</span><span className="font-semibold text-slate-600 dark:text-slate-300">Background Activity:</span><span className="font-mono text-right">{result.background_activity} dpm/100cm²</span></div>
                           <div className="text-center pt-2">
                               <p className="font-semibold text-sm text-slate-500 dark:text-slate-400">Scan MDC</p>
                               <div className="flex items-center justify-center">
                                   <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.scan_mda}</p>
                                   <CopyButton textToCopy={result.scan_mda} />
                               </div>
                               <p className="text-md font-medium text-slate-600 dark:text-slate-300">dpm/100 cm²</p>
                           </div>
                       </div>
                   )}
               </div>
           )}
       </div>
    </div>
    );
};
         
         /**
         * @description A calculator to determine the required number of statistical samples for a
         * survey unit based on the more precise MARSSIM Equation 5-2.
         */
           
const MARSSIM_SampleCalculator = () => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast(); // Added for the save confirmation toast

    const [alpha, setAlpha] = React.useState('0.05');
    const [beta, setBeta] = React.useState('0.05');
    const [sigma, setSigma] = React.useState('15');
    const [dcgl, setDcgl] = React.useState('100');
    const [lbgr, setLbgr] = React.useState('50');
    const [cv, setCv] = React.useState('0.3');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    const zScores = {
    '0.005': 2.576, '0.01': 2.326, '0.025': 1.960, '0.05': 1.645,
    '0.10': 1.282, '0.20': 0.841,
    };
    
    const prValues = {
    0.1: 0.528182, 0.2: 0.556223, 0.3: 0.583985, 0.4: 0.611335, 0.5: 0.638143,
    0.6: 0.66429, 0.7: 0.689665, 0.8: 0.714167, 0.9: 0.73771, 1: 0.760217,
    1.1: 0.781627, 1.2: 0.801892, 1.3: 0.820978, 1.4: 0.838864, 1.5: 0.855541,
    1.6: 0.871014, 1.7: 0.885299, 1.8: 0.89842, 1.9: 0.910413, 2: 0.921319,
    2.25: 0.944167, 2.5: 0.961428, 2.75: 0.974067, 3: 0.983039, 3.5: 0.993329,
    4: 0.997658
    };
    
    const handleClearInputs = () => {
    setAlpha('0.05');
    setBeta('0.05');
    setSigma('15');
    setDcgl('100');
    setLbgr('50');
    setCv('0.3');
    setResult(null);
    setError('');
    };
    
    React.useEffect(() => {
    handleClearInputs();
    }, []);
    
    React.useEffect(() => {
    localStorage.setItem('marssim_alpha', alpha);
    localStorage.setItem('marssim_beta', beta);
    localStorage.setItem('marssim_sigma', sigma);
    localStorage.setItem('marssim_dcgl', dcgl);
    localStorage.setItem('marssim_lbgr', lbgr);
    localStorage.setItem('marssim_cv', cv);
    }, [alpha, beta, sigma, dcgl, lbgr, cv]);
    
    const handleCalculateSigma = () => {
    const dcgl_val = parseFloat(dcgl);
    const cv_val = parseFloat(cv);
    if (!isNaN(dcgl_val) && !isNaN(cv_val)) {
      setSigma((dcgl_val * cv_val).toPrecision(3));
    }
    };
    
    const handleSetLbgr = () => {
    const dcgl_val = parseFloat(dcgl);
    if (!isNaN(dcgl_val)) {
      setLbgr((dcgl_val * 0.5).toPrecision(3));
    }
    };
    
    // This function now ONLY calculates the result, it does not save it.
    const handleCalculate = () => {
        const sigma_val = parseFloat(sigma);
        const dcgl_val = parseFloat(dcgl);
        const lbgr_val = parseFloat(lbgr);
        if (isNaN(sigma_val) || isNaN(dcgl_val) || isNaN(lbgr_val) || sigma_val <= 0) {
          setError('Please enter valid, positive numbers for all fields.');
          setResult(null); return;
        }
        if (dcgl_val <= lbgr_val) {
          setError('DCGL must be greater than the LBGR.');
          setResult(null); return;
        }
        setError('');
        const z1_alpha = zScores[alpha];
        const z1_beta = zScores[beta];
        const delta = dcgl_val - lbgr_val;
        const relativeShift = delta / sigma_val;
        const shiftKeys = Object.keys(prValues).map(parseFloat);
        let Pr;
        if (relativeShift >= 4) {
          Pr = 1;
        } else {
          const lowerKey = Math.max(...shiftKeys.filter(k => k <= relativeShift));
          const upperKey = Math.min(...shiftKeys.filter(k => k > relativeShift));
          if (isFinite(lowerKey) && isFinite(upperKey)) {
              const lowerP = prValues[lowerKey];
              const upperP = prValues[upperKey];
              const slope = (upperP - lowerP) / (upperKey - lowerKey);
              Pr = lowerP + slope * (relativeShift - lowerKey);
          } else {
               setError(`Relative shift (${relativeShift.toFixed(2)}) is outside the table's range.`);
               setResult(null); return;
          }
        }
        const N_base_raw = Math.pow(z1_alpha + z1_beta, 2) / (3 * Math.pow(Pr - 0.5, 2));
        const N_base = Math.ceil(N_base_raw);
        const N_with_overage = N_base * 1.2;
        const final_N = Math.ceil(N_with_overage);
        const samplesPerGroup = Math.ceil(final_N / 2);
        
        const newResult = { totalShift: delta, relativeShift: relativeShift.toFixed(2), Pr: Pr.toFixed(5), zAlpha: z1_alpha, zBeta: z1_beta, N_base: N_base, samplesPerGroup: samplesPerGroup, final_N: final_N };
        
        setResult(newResult);
        // REMOVED the addHistory call from here
    };

    // ADDED this new function to handle saving
    const handleSaveToHistory = () => {
        if (result) {
            addHistory({
              id: Date.now(),
              type: 'MARSSIM Samples',
              icon: ICONS.calculator,
              inputs: `Δ/σ: ${result.relativeShift}, α: ${alpha}, β: ${beta}`,
              result: `${result.final_N} samples`,
              view: VIEWS.MARSSIM_SAMPLES
            });
            addToast("Calculation saved to history!");
        }
    };

    // ADDED this useEffect to make the calculation happen automatically
    React.useEffect(() => {
        handleCalculate();
    }, [alpha, beta, sigma, dcgl, lbgr, cv]);
    
    return (
    <div className="p-4 animate-fade-in">
      <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
          <div className="flex justify-between items-center mb-1">
              <h2 className="text-xl font-bold text-slate-800 dark:text-white">MARSSIM Number of Samples Calculator</h2>
              <ClearButton onClick={handleClearInputs} />
          </div>
          <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Using the WRS Test and Table 5.2 Interpolation.</p>
          <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                  <div>
                      <label className="block text-sm font-medium">Type I Error (α)</label>
                      <select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                          {Object.keys(zScores).map(key => <option key={key} value={key}>{key}</option>)}
                      </select>
                  </div>
                  <div>
                      <label className="block text-sm font-medium">Type II Error (β)</label>
                      <select value={beta} onChange={e => setBeta(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                         {Object.keys(zScores).map(key => <option key={key} value={key}>{key}</option>)}
                      </select>
                  </div>
              </div>
              <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                   <div>
                      <label className="block text-sm font-medium">Estimated Standard Deviation (σ)</label>
                      <input type="number" value={sigma} onChange={e => setSigma(e.target.value)} placeholder="in units of DCGL" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                  </div>
                  <div>
                      <label className="block text-sm font-medium">DCGL</label>
                      <input type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} placeholder="Cleanup limit" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                  </div>
                   <div>
                      <label className="block text-sm font-medium">Lower Bound of Gray Region (LBGR)</label>
                      <input type="number" value={lbgr} onChange={e => setLbgr(e.target.value)} placeholder="Concentration that is 'clean'" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                  </div>
              </div>
              <details className="p-3 my-2 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                  <summary className="cursor-pointer text-sm font-semibold text-slate-600 dark:text-slate-300">
                      Scoping Data Helper
                  </summary>
                  <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 space-y-3">
                      <p className="text-xs text-slate-500 dark:text-slate-400">
                          Use these helpers to estimate input parameters based on the DCGL.
                      </p>
                      <div className="flex items-end gap-2">
                          <div className="flex-grow">
                              <label className="block text-xs font-medium">Coefficient of Variation (CV)</label>
                              <input type="number" value={cv} onChange={e => setCv(e.target.value)} step="0.05" className="w-full mt-1 p-2 rounded-md bg-white dark:bg-slate-700"/>
                          </div>
                          <button onClick={handleCalculateSigma} className="px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 rounded-md font-semibold hover:bg-slate-300 dark:hover:bg-slate-500">
                              Calculate σ
                          </button>
                      </div>
                      <button onClick={handleSetLbgr} className="w-full px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 rounded-md font-semibold hover:bg-slate-300 dark:hover:bg-slate-500">
                          Set LBGR to 50% of DCGL
                      </button>
                  </div>
              </details>
              {/* MODIFIED the button to save instead of calculate */}
              <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Save to Calculations</button>
              {error && <p className="text-red-500 text-sm text-center">{error}</p>}
              {result && (
                  <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 text-center animate-fade-in">
                       <div className="grid grid-cols-2 gap-2 text-sm">
                          <p className="font-semibold text-slate-500 dark:text-slate-400">Total Shift (Δ):</p><p className="font-mono">{result.totalShift}</p>
                          <p className="font-semibold text-slate-500 dark:text-slate-400">Relative Shift (Δ/σ):</p><p className="font-mono">{result.relativeShift}</p>
                          <p className="font-semibold text-slate-500 dark:text-slate-400">Probability (Pᵣ):</p><p className="font-mono">{result.Pr}</p>
                          <p className="font-semibold text-slate-500 dark:text-slate-400">Z₁₋ₐ:</p><p className="font-mono">{result.zAlpha}</p>
                          <p className="font-semibold text-slate-500 dark:text-slate-400">Z₁₋ᵦ:</p><p className="font-mono">{result.zBeta}</p>
                       </div>
                       <div>
                          <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Required Samples per Group (N/2)</p>
                          <p className="text-lg font-bold">{result.samplesPerGroup}</p>
                      </div>
                      <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                          <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Total Recommended Samples</p>
                          <div className="flex items-center justify-center">
                              <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.final_N}</p>
                              <CopyButton textToCopy={result.final_N} />
                          </div>
                          <p className="text-xs font-medium text-slate-600 dark:text-slate-300">({result.N_base} base samples + 20% overage)</p>
                      </div>
                  </div>
              )}
          </div>
      </div>
    </div>
    );
};

const NorthArrowControl = () => (
    <div className="absolute top-28 right-3 z-[1000] p-1.5 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-md shadow-md border border-slate-300 dark:border-slate-600 pointer-events-none">
        <Icon path={ICONS.northArrow} className="w-6 h-6 text-slate-700 dark:text-slate-200" />
    </div>
);


         /**
         * @description React component for a graphical survey unit drawing tool. This utility
         * allows users to visually plan and lay out radiation survey points on an interactive map.
         * The tool is designed to support the planning phase of a final status survey, particularly
         * for a **Multi-Agency Radiation Survey and Site Investigation Manual (MARSSIM)** project.
         *
         * Key features include:
         * - **Interactive Map:** A Leaflet-based map provides a visual canvas.
         * - **Drawing Controls:** Users can draw survey unit boundaries using **polygons** or
         * **rectangles**.
         * - **Sample Point Generation:** Automatically generates statistical sample points within
         * the drawn boundary using common MARSSIM patterns: **random**, **square grid**, or
         * **triangular grid**.
         * - **Manual Point Placement:** Allows for the placement of "biased" sample points in
         * areas of known or suspected contamination.
         * - **Area Calculation:** Automatically calculates the area of the drawn survey unit.
         * - **Data Export:** The final list of sample points, including coordinates and a unique
         * identifier, can be exported to a `.csv` file for use with GPS devices or for documentation.
         *
         * This component is an essential part of the MARSSIM suite, bridging the statistical
         * calculations with a practical, field-ready planning tool.
         *
         * @prop {boolean} isVisible - Boolean to trigger map redraw on component mount,
         * ensuring correct rendering within a tabbed interface.
         */
    
const DrawingTool = ({ isVisible }) => {
    const mapRef = React.useRef(null);
    const drawnItemsRef = React.useRef(null);
    const samplePointsLayerRef = React.useRef(null);
    const originMarkerRef = React.useRef(null);
    const fileInputRef = React.useRef(null);
    const osmLayerRef = React.useRef(null);
    const satelliteLayerRef = React.useRef(null);
    const { addToast } = useToast();

    // --- STATE MANAGEMENT ---
    const [surveyUnitLayer, setSurveyUnitLayer] = React.useState(null);
    const [surveyUnitArea, setSurveyUnitArea] = React.useState(0);
    const [plottedPoints, setPlottedPoints] = React.useState([]);
    const [locationInput, setLocationInput] = React.useState('');
    const [surveyUnitName, setSurveyUnitName] = React.useState('SU-1');
    const [surveyClass, setSurveyClass] = React.useState('Class 1');
    const [samplesToPlace, setSamplesToPlace] = React.useState(25);
    const [sampleCalcMode, setSampleCalcMode] = React.useState('byNumber');
    const [gridSpacing, setGridSpacing] = React.useState(10);

    const highlightStyle = { weight: 5, color: '#0ea5e9', dashArray: '', fillOpacity: 0.5 };
    const defaultStyle = { color: '#3388ff' };

    // --- HELPER FUNCTIONS ---
    // NEW: Replaced old numbering logic with a robust prefix-based ID generator
    const getNextIdForPrefix = (points, prefix) => {
        const existingNumbers = points
            .filter(p => p.id.startsWith(prefix + '-'))
            .map(p => parseInt(p.id.split('-')[1], 10))
            .sort((a, b) => a - b);
            
        let nextNum = 1;
        for (const num of existingNumbers) {
            if (num === nextNum) {
                nextNum++;
            } else {
                break; // Found a gap
            }
        }
        return `${prefix}-${nextNum}`;
    };

    const isPointInPolygon = (point, polygonLatLngs) => {
        const polyPoints = polygonLatLngs[0];
        const x = point.lat, y = point.lng;
        let inside = false;
        for (let i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
            const xi = polyPoints[i].lat, yi = polyPoints[i].lng;
            const xj = polyPoints[j].lat, yj = polyPoints[j].lng;
            const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    };

    const handleClearPoints = () => {
        const biasedOnly = plottedPoints.filter(p => p.type === 'Biased');
        setPlottedPoints(biasedOnly);
        samplePointsLayerRef.current.eachLayer(layer => {
            if (layer !== originMarkerRef.current) {
                samplePointsLayerRef.current.removeLayer(layer);
            }
        });
    };

    const handleClearAll = () => {
        if (drawnItemsRef.current) drawnItemsRef.current.clearLayers();
        if (samplePointsLayerRef.current) samplePointsLayerRef.current.clearLayers();
        setSurveyUnitLayer(null);
        setSurveyUnitArea(0);
        setPlottedPoints([]);
    };
    
    const onDrawDelete = (e) => {
        e.layers.eachLayer(layer => {
            if (layer instanceof L.CircleMarker && layer.myCustomId) {
                const deletedId = layer.myCustomId;
                setPlottedPoints(currentPoints =>
                    currentPoints.filter(p => p.id !== deletedId)
                );
            } else if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                handleClearAll();
            }
        });
        addToast("Item(s) removed from map.");
    };

    // --- CORE LOGIC ---
    const onDrawEditOrCreate = (e) => {
        if (e.type === 'draw:edited') {
            const statisticalPoints = plottedPoints.filter(p => p.type !== 'Biased');
            setPlottedPoints(() => {
                 const updatedBiasedPoints = [];
                 e.layers.eachLayer(layer => {
                     if (layer instanceof L.CircleMarker && layer.myCustomId) {
                         const latLng = layer.getLatLng();
                         // CHANGED: Preserves the ID on edit
                         updatedBiasedPoints.push({ id: layer.myCustomId, lat: latLng.lat, lng: latLng.lng, type: 'Biased' });
                     } else if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                         const area = calculatePolygonArea(layer.getLatLngs());
                         setSurveyUnitArea(area);
                         const popupContent = `<b>Survey Unit: ${surveyUnitName}</b><br>Class: ${surveyClass}<br>Area: ${area.toFixed(1)} m²`;
                         layer.setPopupContent(popupContent);
                     }
                 });
                 return [...updatedBiasedPoints, ...statisticalPoints];
            });
            addToast("Item(s) updated.");
            return;
        }

        const layer = e.layer;
        if (!layer) return;

        if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
            drawnItemsRef.current.eachLayer(l => {
                if (l instanceof L.Polygon || l instanceof L.Rectangle) { drawnItemsRef.current.removeLayer(l); }
            });
            handleClearPoints();
            drawnItemsRef.current.addLayer(layer);
            setSurveyUnitLayer(layer);
            const area = calculatePolygonArea(layer.getLatLngs());
            setSurveyUnitArea(area);
            const popupContent = `<b>Survey Unit: ${surveyUnitName}</b><br>Class: ${surveyClass}<br>Area: ${area.toFixed(1)} m²`;
            layer.bindPopup(popupContent).openPopup();
            layer.on({
                mouseover: (e) => e.target.setStyle(highlightStyle),
                mouseout: (e) => e.target.setStyle(defaultStyle)
            });
        } else if (layer instanceof L.Marker) {
            const latLng = layer.getLatLng();
            setPlottedPoints(currentPoints => {
                // CHANGED: Now uses the prefix-based ID generator
                const newId = getNextIdForPrefix(currentPoints, 'B');
                const newPoint = { id: newId, lat: latLng.lat, lng: latLng.lng, type: 'Biased' };
                const popupContent = `<b>Bias Sample Point #${newId}</b><br>Type: Biased<br>Lat: ${latLng.lat.toFixed(6)}<br>Lng: ${latLng.lng.toFixed(6)}`;
                const newMarker = L.circleMarker(latLng, { radius: 4, className: 'biased-sample-marker' }).bindPopup(popupContent);
                newMarker.myCustomId = newId;
                drawnItemsRef.current.addLayer(newMarker);
                return [...currentPoints, newPoint];
            });
        }
    };
    
const handleGenerateSamples = (pattern) => {
    if (!surveyUnitLayer) { addToast("Please draw a survey unit boundary first."); return; }
    handleClearPoints();
    const existingBiasedPoints = plottedPoints.filter(p => p.type === 'Biased');
    let numSamples = samplesToPlace;
    let spacingMeters = gridSpacing;

    if (sampleCalcMode === 'bySpacing' && pattern !== 'random') {
        if (gridSpacing <= 0) { addToast("Grid spacing must be greater than zero."); return; }
        numSamples = Math.ceil(surveyUnitArea / (spacingMeters * spacingMeters));
        setSamplesToPlace(numSamples); // ADD THIS LINE to sync the UI state
    } else if (sampleCalcMode === 'byNumber' && pattern !== 'random') {
        if (samplesToPlace <= 0) { addToast("Number of samples must be greater than zero."); return; }
        const multiplier = pattern === 'triangular' ? 0.866 : 1;
        spacingMeters = Math.sqrt(surveyUnitArea / (multiplier * numSamples));
        setGridSpacing(Math.round(spacingMeters)); // ADD THIS LINE to sync the UI state
    }
        const newPoints = [];
        const latLngs = surveyUnitLayer.getLatLngs();
        const bounds = surveyUnitLayer.getBounds();
        if (pattern === 'random') {
            for (let i = 0; i < numSamples; i++) {
                let pointFound = false;
                while (!pointFound) {
                    const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                    const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                    if (isPointInPolygon({ lat, lng }, latLngs)) { newPoints.push({ lat, lng }); pointFound = true; }
                }
            }
        } else {
           const spacingLat = spacingMeters / 111320;
           const centerLat = (bounds.getSouth() + bounds.getNorth()) / 2;
           const spacingLng = spacingMeters / (111320 * Math.cos(centerLat * Math.PI / 180));
           const randomLatOffset = Math.random() * spacingLat;
           const randomLngOffset = Math.random() * spacingLng;
           let row = 0;
           for (let lat = bounds.getSouth() - randomLatOffset; lat < bounds.getNorth() + spacingLat; lat += spacingLat * (pattern === 'triangular' ? 0.866 : 1)) {
               const triangularLngOffset = (pattern === 'triangular' && row % 2 !== 0) ? spacingLng / 2 : 0;
               for (let lng = bounds.getWest() - randomLngOffset + triangularLngOffset; lng < bounds.getEast() + spacingLng; lng += spacingLng) {
                   if (isPointInPolygon({ lat, lng }, latLngs)) { newPoints.push({ lat, lng }); }
               }
               row++;
           }
        }
        
        const pointsWithTypes = newPoints.map((p, index) => ({ ...p, id: `S-${index + 1}`, type: pattern.charAt(0).toUpperCase() + pattern.slice(1) }));
        setPlottedPoints([...existingBiasedPoints, ...pointsWithTypes]);
        pointsWithTypes.forEach(point => {
           const marker = L.circleMarker([point.lat, point.lng], { radius: 4, className: 'grid-sample-marker' });
           const popupContent = `<b>Sample Point #${point.id}</b><br>Type: ${point.type}<br>Lat: ${point.lat.toFixed(6)}<br>Lng: ${point.lng.toFixed(6)}`;
           marker.bindPopup(popupContent).addTo(samplePointsLayerRef.current);
        });
    };

    const handleZoomToSurveyUnit = () => { if (surveyUnitLayer && mapRef.current) { mapRef.current.fitBounds(surveyUnitLayer.getBounds()); } };

                const handleSavePlan = () => {
                 if (!surveyUnitLayer) {
                     addToast("Please draw a survey unit to save.");
                     return;
                 }
                 const planData = {
                     surveyUnit: surveyUnitLayer.toGeoJSON(),
                     points: plottedPoints,
                     surveyClass: surveyClass,
                     samplesToPlace: samplesToPlace,
                 };
                 const blob = new Blob([JSON.stringify(planData, null, 2)], { type: 'application/json' });
                 const link = document.createElement("a");
                 link.href = URL.createObjectURL(blob);
                 link.download = "survey-plan.json";
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
             };

                 const handleLoadPlan = (event) => {
                 const file = event.target.files[0];
                 if (!file) return;
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const parsedData = JSON.parse(e.target.result);
                         if (!parsedData.surveyUnit || !parsedData.points) { throw new Error("Invalid plan file format."); }
                         
                         handleClearAll();
                         
                         const newSurveyUnit = L.geoJSON(parsedData.surveyUnit, { style: defaultStyle });
                         const layer = newSurveyUnit.getLayers()[0];
                         if (layer) {
                             drawnItemsRef.current.addLayer(layer);
                             setSurveyUnitLayer(layer);
                             const area = calculatePolygonArea(layer.getLatLngs());
                             setSurveyUnitArea(area);
                             mapRef.current.fitBounds(layer.getBounds());
         
                             const popupContent = `<b>Survey Unit</b><br>Class: ${parsedData.surveyClass || 'Class 1'}<br>Area: ${area.toFixed(1)} m²`;
                             layer.bindPopup(popupContent);
                             layer.on({
                                 mouseover: (e) => e.target.setStyle(highlightStyle),
                                 mouseout: (e) => e.target.setStyle(defaultStyle)
                             });
                         }
         
                         const loadedPoints = parsedData.points || [];
                         setPlottedPoints(loadedPoints);
                         setSurveyClass(parsedData.surveyClass || 'Class 1');
                         setSamplesToPlace(parsedData.samplesToPlace || 25);
                         
                         loadedPoints.forEach((point, index) => {
                             const marker = L.circleMarker([point.lat, point.lng], {
                                 radius: 4,
                                 className: point.type === 'Biased' ? 'biased-sample-marker' : 'grid-sample-marker'
                             });
                             const popupContent = `<b>Sample Point #${index + 1}</b><br>Type: ${point.type}<br>Lat: ${point.lat.toFixed(6)}<br>Lng: ${point.lng.toFixed(6)}`;
                             marker.bindPopup(popupContent);
                             marker.addTo(samplePointsLayerRef.current);
                         });
         
                     } catch (error) { alert(`Error loading plan: ${error.message}`); }
                 };
                 reader.readAsText(file);
                 event.target.value = null;
             };
    const handleExport = () => {
        if (plottedPoints.length === 0 || !surveyUnitLayer) {
            addToast("Please draw a survey unit and place sample points before exporting."); return;
        }
        const origin = surveyUnitLayer ? { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng } : null;
        const dataForExport = plottedPoints.map((point) => {
            const yDistance = calculateDistance(origin, { lat: point.lat, lng: origin.lng });
            const xDistance = calculateDistance(origin, { lat: origin.lat, lng: point.lng });
            return { sampleNumber: point.id, type: point.type, latitude: point.lat.toFixed(6), longitude: point.lng.toFixed(6), xDistance: xDistance.toFixed(2), yDistance: yDistance.toFixed(2) };
        });
        const headers = ["Sample #", "Type", "Latitude", "Longitude", "X Distance from Origin (m)", "Y Distance from Origin (m)"];
        const csvRows = [headers.join(',')];
        dataForExport.forEach(row => { csvRows.push(Object.values(row).join(',')); });
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "survey_sample_points.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

             const handleGoToLocation = async () => {
                 if (!locationInput.trim()) return;
                 const coordRegex = /^-?[\d.]+\s*,\s*-?[\d.]+$/;
                 if (coordRegex.test(locationInput)) {
                     const [lat, lng] = locationInput.split(',').map(Number);
                     if (!isNaN(lat) && !isNaN(lng)) { mapRef.current.setView([lat, lng], 16); return; }
                 }
                 try {
                     const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput)}`);
                     const data = await response.json();
                     if (data && data.length > 0) {
                         const { lat, lon } = data[0];
                         mapRef.current.setView([parseFloat(lat), parseFloat(lon)], 16);
                     } else { addToast("Location not found."); }
                 } catch (error) { addToast("Could not connect to the location service."); }
             };
         
         
         
         
const handlePrintMap = () => {
             if (!mapRef.current || !surveyUnitLayer) {
                 addToast("Please draw a survey unit on the map before generating a report.");
                 return;
             }
             const center = mapRef.current.getCenter();
             const zoom = mapRef.current.getZoom();
             const surveyUnitGeoJSON = surveyUnitLayer.toGeoJSON();
             const pointsData = plottedPoints;
             const leafletCss = document.querySelector('link[href*="leaflet.css"]').outerHTML;
             const leafletDrawCss = document.querySelector('link[href*="leaflet.draw.css"]').outerHTML;
             let customMarkerStyles = '';
             for (const sheet of document.styleSheets) {
                 try {
                     for (const rule of sheet.cssRules) {
                         // ADDED: .origin-sample-marker to ensure the origin point is styled correctly
                         if (rule.selectorText === '.grid-sample-marker' || rule.selectorText === '.biased-sample-marker' || rule.selectorText === '.origin-sample-marker') {
                             customMarkerStyles += rule.cssText;
                         }
                     }
                 } catch (e) { console.warn("Could not read CSS rules from a stylesheet:", e); }
             }

             // --- START: Added logic to match main display ---
             const origin = { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng };
             
             let tableHtml = `<table class="data-table"><thead><tr><th>#</th><th>Type</th><th>Latitude</th><th>Longitude</th><th>X (m)</th><th>Y (m)</th></tr></thead><tbody>`;
             
             const sortedPoints = [...pointsData].sort((a, b) => {
                const aPrefix = a.id.charAt(0);
                const bPrefix = b.id.charAt(0);
                const aNum = parseInt(a.id.substring(2));
                const bNum = parseInt(b.id.substring(2));
                if (aPrefix < bPrefix) return 1;
                if (aPrefix > bPrefix) return -1;
                return aNum - bNum;
             });

             sortedPoints.forEach((point) => {
                 const yDistance = calculateDistance(origin, { lat: point.lat, lng: origin.lng });
                 const xDistance = calculateDistance(origin, { lat: origin.lat, lng: point.lng });
                 tableHtml += `<tr><td>${point.id}</td><td>${point.type}</td><td>${point.lat.toFixed(6)}</td><td>${point.lng.toFixed(6)}</td><td>${xDistance.toFixed(2)}</td><td>${yDistance.toFixed(2)}</td></tr>`;
             });
             tableHtml += `</tbody><tfoot><tr class="origin-row"><td colspan="2">Origin (SW Corner)</td><td>${origin.lat.toFixed(6)}</td><td>${origin.lng.toFixed(6)}</td><td>0.00</td><td>0.00</td></tr></tfoot></table>`;
             // --- END: Added logic ---

             let activeLayerName = "Street Map";
             if (mapRef.current.hasLayer(satelliteLayerRef.current)) {
                 activeLayerName = "Satellite";
             }
             
             const reportWindow = window.open('', '_blank', 'height=800,width=1000');
             reportWindow.document.write(`
                 <html>
                     <head>
                         <title>Survey Unit Report</title>
                         ${leafletCss} ${leafletDrawCss}
                         <style>
                             body { font-family: "Inter", sans-serif; margin: 0; padding: 20px; background-color: #f8fafc; color: #1e293b; }
                             .report-container { max-width: 1200px; margin: auto; }
                             h1, h2 { text-align: center; }
                             #print-map { height: 50vh; border: 1px solid #cbd5e1; border-radius: 8px; margin: 20px 0; }
                             .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 20px; }
                             .data-table th, .data-table td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: center; }
                             .data-table th { background-color: #f1f5f9; font-weight: 600; }
                             .data-table .origin-row { background-color: #f1f5f9; font-weight: bold; border-top: 2px solid #cbd5e1; } /* CHANGED: Added style for origin row */
                             .print-button { display: block; width: 200px; margin: 0 auto 30px auto; padding: 12px 15px; background-color: #0284c7; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
                             .print-button:hover { background-color: #0369a1; }
                             .summary-container { text-align: center; padding: 15px; background-color: #f1f5f9; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; border: 1px solid #e2e8f0; } /* CHANGED: Added flex-wrap */
                             .summary-container div { font-size: 1.1em; color: #334155; padding: 5px 10px; } /* CHANGED: Added padding */
                             @media print { .print-button { display: none; } body { padding: 0; } }
                             ${customMarkerStyles}
                         </style>
                     </head>
                     <body>
                         <button class="print-button" onclick="window.print()">Print Report</button>
                         <div class="report-container">
                             <h1>Survey Unit Report</h1>
                             <div class="summary-container">
                                 <div><strong>Survey Unit Name:</strong> ${surveyUnitName}</div> <div><strong>Unit Class:</strong> ${surveyClass}</div>
                                 <div><strong>Area:</strong> ${surveyUnitArea.toFixed(1)} m²</div>
                                 <div><strong>Samples Plotted:</strong> ${pointsData.length}</div>
                             </div>
                             <div id="print-map"></div>
                             <h2>Sample Locations</h2>
                             ${tableHtml}
                         </div>
                         <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
                         <script>
                             setTimeout(() => {
                                 const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxNativeZoom: 19, maxZoom: 21, attribution: '&copy; OpenStreetMap' });
                                 const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxNativeZoom: 19, maxZoom: 21, attribution: 'Tiles &copy; Esri' });
                                 const baseMaps = { "Street Map": osmLayer, "Satellite": satelliteLayer };
                                 const defaultLayer = baseMaps['${activeLayerName}'];
                                 const map = L.map('print-map', { layers: [defaultLayer] }).setView([${center.lat}, ${center.lng}], ${zoom});
                                 const NorthArrow = L.Control.extend({
                                     options: { position: 'topright' },
                                     onAdd: function (map) {
                                         const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                                         container.style.backgroundColor = 'white'; container.style.width = '30px'; container.style.height = '30px'; container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.justifyContent = 'center'; container.style.cursor = 'default';
                                         container.innerHTML = \`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 1.25rem; height: 1.25rem; color: #374151;"><path d="${ICONS.northArrow}" /></svg>\`;
                                         return container;
                                     }
                                 });
                                 map.addControl(new NorthArrow());
                                 L.control.layers(baseMaps).addTo(map);
                                 L.control.scale({ imperial: true, metric: true }).addTo(map);
                                 const surveyUnitGeoJSON = ${JSON.stringify(surveyUnitGeoJSON)};
                                 L.geoJSON(surveyUnitGeoJSON, { style: { color: '#3388ff' } }).addTo(map);
                                 const points = ${JSON.stringify(pointsData)};
                                 points.forEach(point => {
                                     L.circleMarker([point.lat, point.lng], { radius: 4, className: point.type === 'Biased' ? 'biased-sample-marker' : 'grid-sample-marker' }).addTo(map);
                                 });

                                 // --- ADDED: Draw the origin point on the map ---
                                 const originLatLng = L.geoJSON(surveyUnitGeoJSON).getBounds().getSouthWest();
                                 L.circleMarker(originLatLng, { radius: 6, className: 'origin-sample-marker' }).bindPopup('<b>Survey Origin (SW Corner)</b>').addTo(map);
                                 // ---------------------------------------------
                                 
                             }, 100);
                         <\/script>
                     </body>
                 </html>
             `);
             reportWindow.document.close();
         };


    // --- MAP INITIALIZATION ---
    React.useEffect(() => {
        if (mapRef.current) return;
        
        L.drawLocal.draw.toolbar.buttons.marker = 'Place a bias sample';
        L.drawLocal.draw.handlers.marker.tooltip.start = 'Click map to place bias sample.';

        // ADDED: Define the custom icon for the drawing cursor
        const biasMarkerIcon = new L.DivIcon({ className: 'leaflet-draw-biased-marker-icon', iconSize: new L.Point(12, 12), iconAnchor: new L.Point(8, 8) });

        osmLayerRef.current = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxNativeZoom: 19, maxZoom: 21 });
        satelliteLayerRef.current = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri', maxNativeZoom: 19, maxZoom: 21 });
        const baseMaps = { "Street Map": osmLayerRef.current, "Satellite": satelliteLayerRef.current };
    
        mapRef.current = L.map('marssim-map', { layers: [osmLayerRef.current] }).setView([37.207, -76.51], 13);
        
        drawnItemsRef.current = new L.FeatureGroup();
        samplePointsLayerRef.current = new L.FeatureGroup();
        mapRef.current.addLayer(drawnItemsRef.current);
        mapRef.current.addLayer(samplePointsLayerRef.current);

        // CHANGED: Pass the custom icon to the marker options
        const drawControl = new L.Control.Draw({ 
            edit: { featureGroup: drawnItemsRef.current }, 
            draw: { 
                polyline: false, 
                polygon: { shapeOptions: { color: '#3388ff' } }, 
                rectangle: { shapeOptions: { color: '#3388ff' } }, 
                marker: { icon: biasMarkerIcon }, 
                circle: false, 
                circlemarker: false 
            } 
        });
        mapRef.current.addControl(drawControl);

        const NorthArrow = L.Control.extend({ options: { position: 'topright' }, onAdd: function (map) { const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control'); c.style.backgroundColor = 'white'; c.style.width = '30px'; c.style.height = '30px'; c.style.display = 'flex'; c.style.alignItems = 'center'; c.style.justifyContent = 'center'; c.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1.25rem;height:1.25rem;"><path d="${ICONS.northArrow}" /></svg>`; L.DomEvent.disableClickPropagation(c); return c; } });
        mapRef.current.addControl(new NorthArrow());
        
        L.control.layers(baseMaps).addTo(mapRef.current);
        L.control.scale({ imperial: true, metric: true }).addTo(mapRef.current);
        
        const mousePositionControl = L.control({ position: 'bottomleft' });
        mousePositionControl.onAdd = function (map) { this._div = L.DomUtil.create('div', 'leaflet-control-mouseposition'); this.update('Mouse over map'); return this._div; };
        mousePositionControl.update = function (text) { this._div.innerHTML = text; };
        mousePositionControl.addTo(mapRef.current);

        mapRef.current.on('mousemove', (e) => { mousePositionControl.update(`Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`); });
        mapRef.current.on('mouseout', () => { mousePositionControl.update('Mouse over map'); });
        
        mapRef.current.on(L.Draw.Event.CREATED, onDrawEditOrCreate);
        mapRef.current.on(L.Draw.Event.EDITED, onDrawEditOrCreate);
        mapRef.current.on(L.Draw.Event.DELETED, onDrawDelete);
    
        return () => { if (mapRef.current) { mapRef.current.remove(); mapRef.current = null; } };
    }, []);

    React.useEffect(() => { if (isVisible && mapRef.current) { setTimeout(() => mapRef.current.invalidateSize(), 100); } }, [isVisible]);
    React.useEffect(() => {
        if (originMarkerRef.current) { originMarkerRef.current.remove(); originMarkerRef.current = null; }
        if (surveyUnitLayer && samplePointsLayerRef.current) {
            const originLatLng = surveyUnitLayer.getBounds().getSouthWest();
            const originMarker = L.circleMarker(originLatLng, { radius: 6, className: 'origin-sample-marker' }).bindPopup(`<b>Survey Origin (SW Corner)</b><br>Lat: ${originLatLng.lat.toFixed(6)}<br>Lng: ${originLatLng.lng.toFixed(6)}`);
            originMarker.addTo(samplePointsLayerRef.current);
            originMarkerRef.current = originMarker;
        }
    }, [surveyUnitLayer]);

    return (
        <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
            {/* ... rest of the JSX is unchanged ... */}
             <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h3 className="text-lg font-bold">Survey Unit Drawing Tool</h3>
                <div className="flex items-center gap-2">
                    {surveyUnitLayer && ( <button onClick={handleZoomToSurveyUnit} className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Zoom to Unit</button> )}
                    <input type="file" ref={fileInputRef} onChange={handleLoadPlan} accept=".json" style={{ display: 'none' }} />
                    <button onClick={() => fileInputRef.current.click()} className="px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Load Plan</button>
                    <button onClick={handleSavePlan} className="px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Save Plan</button>
                </div>
            </div>
            <div className="flex gap-2 items-center mb-4">
                <input type="text" value={locationInput} onChange={(e) => setLocationInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleGoToLocation(); }} placeholder="Enter an address or lat,lng coordinates" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"/>
                <button onClick={handleGoToLocation} className="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Go</button>
            </div>
            <div id="marssim-map" className="w-full h-[60vh] my-4 rounded-lg bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600"></div>
            <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="md:col-span-2 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                    <h4 className="font-bold text-lg mb-3">Survey Unit Dashboard</h4>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <label className="font-semibold text-slate-500 dark:text-slate-400">Unit Name</label>
                            <input type="text" value={surveyUnitName} onChange={e => setSurveyUnitName(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600"/>
                        </div>
                        <div>
                            <label className="font-semibold text-slate-500 dark:text-slate-400">Unit Class</label>
                            <select value={surveyClass} onChange={e => setSurveyClass(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Un-Impacted</option><option>Other</option>
                            </select>
                        </div>
                        <div className="pt-2">
                            <p className="font-semibold text-slate-500 dark:text-slate-400">Area</p>
                            <p className="text-xl font-bold text-sky-600 dark:text-sky-400">{surveyUnitArea.toFixed(1)} m²</p>
                        </div>
                         <div className="pt-2">
                            <p className="font-semibold text-slate-500 dark:text-slate-400">Plotted Samples</p>
                            <p className="text-xl font-bold text-sky-600 dark:text-sky-400">{plottedPoints.length}</p>
                        </div>
                    </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg h-full flex flex-col justify-between">
                    <div>
                        <h4 className="font-bold text-lg mb-3">Statistical Samples</h4>
                        <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-3">
                            <button onClick={() => setSampleCalcMode('byNumber')} className={`w-1/2 p-1 rounded-md text-xs font-semibold ${sampleCalcMode === 'byNumber' ? 'bg-white dark:bg-slate-800' : ''}`}>By Number</button>
                            <button onClick={() => setSampleCalcMode('bySpacing')} className={`w-1/2 p-1 rounded-md text-xs font-semibold ${sampleCalcMode === 'bySpacing' ? 'bg-white dark:bg-slate-800' : ''}`}>By Spacing</button>
                        </div>
                        {sampleCalcMode === 'byNumber' ? (
                             <div className="text-center">
                                <label className="font-semibold text-sm text-slate-500 dark:text-slate-400 mb-2">Desired Number of Samples</label>
                                <input type="number" value={samplesToPlace} onChange={(e) => setSamplesToPlace(parseInt(e.target.value, 10) || 0)} className="persistent-spinner w-24 text-center text-2xl font-bold text-sky-600 dark:text-sky-400 p-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:outline-none" />
                             </div>
                        ) : (
                            <div className="text-center">
                                <label className="font-semibold text-sm text-slate-500 dark:text-slate-400 mb-2">Grid Spacing (meters)</label>
                                <input type="number" value={gridSpacing} onChange={(e) => setGridSpacing(parseInt(e.target.value, 10) || 0)} className="persistent-spinner w-24 text-center text-2xl font-bold text-sky-600 dark:text-sky-400 p-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:outline-none" />
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-3 gap-2 mt-2">
                        <button onClick={() => handleGenerateSamples('square')} className="p-2 text-xs md:text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-md hover:bg-sky-200 dark:hover:bg-sky-800">Square Grid</button>
                        <button onClick={() => handleGenerateSamples('triangular')} className="p-2 text-[12px] leading-tight bg-slate-200 dark:bg-slate-600 font-semibold rounded-md hover:bg-sky-200 dark:hover:bg-sky-800">Triangular Grid</button>
                        <button onClick={() => handleGenerateSamples('random')} className="p-2 text-xs md:text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-md hover:bg-sky-200 dark:hover:bg-sky-800">Random</button>
                    </div>
                </div>
            </div>
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <div className="flex justify-between items-center">
                    <h3 className="text-lg font-bold">Plotted Sample Coordinates ({plottedPoints.length})</h3>
                    <div className="flex items-center gap-4">
                        <button onClick={handleClearPoints} className="text-xs text-slate-500 hover:underline font-semibold flex items-center gap-1"><Icon path={ICONS.clear} className="w-3 h-3"/> Clear Grid Points</button>
                        <button onClick={handleClearAll} className="text-xs text-slate-500 hover:underline font-semibold flex items-center gap-1"><Icon path={ICONS.clear} className="w-3 h-3"/> Clear All</button>
                        <button onClick={handlePrintMap} className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2">Print / Save as PDF</button>
                    </div>
                </div>
                <div className="max-h-60 overflow-y-auto mt-2 pr-2">
                    {plottedPoints.length > 0 || surveyUnitLayer ? (
	<div className="overflow-x-auto">
                        <table className="w-full text-sm text-center">
                            <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0">
                               <tr>
                                  <th className="p-2 text-center">#</th>
                                   <th className="p-2 text-center">Type</th>
                                   <th className="p-2 text-center">Latitude</th>
                                   <th className="p-2 text-center">Longitude</th>
                                   <th className="p-2 text-center">X (m)</th>
                                   <th className="p-2 text-center">Y (m)</th>
                               </tr>
                            </thead>
                            <tbody>
                                {(() => {
                                    const origin = surveyUnitLayer ? { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng } : null;
                                    const sortedPoints = [...plottedPoints].sort((a, b) => {
                                        const aPrefix = a.id.charAt(0);
                                        const bPrefix = b.id.charAt(0);
                                        const aNum = parseInt(a.id.substring(2));
                                        const bNum = parseInt(b.id.substring(2));
                                        if (aPrefix < bPrefix) return 1; // B comes before S
                                        if (aPrefix > bPrefix) return -1;
                                        return aNum - bNum;
                                    });
                                    return sortedPoints.map((point) => {
                                        let xDist = 'N/A', yDist = 'N/A';
                                        if (origin) {
                                            yDist = calculateDistance(origin, { lat: point.lat, lng: origin.lng }).toFixed(2);
                                            xDist = calculateDistance(origin, { lat: origin.lat, lng: point.lng }).toFixed(2);
                                        }
                                        return (
                                            <tr key={point.id} className="border-b border-slate-200 dark:border-slate-700">
                                                <td className="p-2 font-medium">{point.id}</td>
                                                <td className="p-2">{point.type}</td>
                                                <td className="p-2 font-mono">{point.lat.toFixed(6)}</td>
                                                <td className="p-2 font-mono">{point.lng.toFixed(6)}</td>
                                                <td className="p-2 font-mono">{xDist}</td>
                                                <td className="p-2 font-mono">{yDist}</td>
                                            </tr>
                                        );
                                    });
                                })()}
                            </tbody>
                            <tfoot>
                                {(() => {
                                    const origin = surveyUnitLayer ? { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng } : null;
                                    if (!origin) return null;
                                    return ( <tr className="bg-slate-200 dark:bg-slate-700 font-semibold border-t-2 border-slate-300 dark:border-slate-600"><td colSpan="2" className="p-2 text-left">Origin (SW Corner)</td><td className="p-2 font-mono">{origin.lat.toFixed(6)}</td><td className="p-2 font-mono">{origin.lng.toFixed(6)}</td><td className="p-2 font-mono">0.00</td><td className="p-2 font-mono">0.00</td></tr> );
                                })()}
                            </tfoot>
                        </table>
</div>
                    ) : ( <p className="text-center text-slate-500 dark:text-slate-400 py-4">No sample points have been placed.</p> )}
                </div>
            </div>
        </div>
    );
};

         /**
         * @description React component for the MARSSIM Sample Design Suite.
         * This component acts as a container for two main functionalities:
         * 1.  **Sample Size Calculator:** Calculates the number of samples required based on MARSSIM methodology.
         * 2.  **Survey Unit Drawing Tool:** Provides a user interface for drawing survey units and sample locations.
         *
         * It manages the active module state ('calculator' or 'drawing') and conditionally renders the corresponding
         * sub-component (`MARSSIM_SampleCalculator` or `DrawingTool`) based on user selection.
         */
         
         const MARSSIM_SampleDesign = () => {
         const [activeModule, setActiveModule] = React.useState('calculator');
         
         return (
         <div className="p-4 animate-fade-in">
             <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white">MARSSIM Sample Design Suite</h2>
                <div className="flex w-full p-1 my-4 bg-slate-200 dark:bg-slate-700 rounded-lg">
                    <button 
                        onClick={() => setActiveModule('calculator')}
                        className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${
                            activeModule === 'calculator' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'
                        }`}
                    >
                        1. Calculate Number of Samples
                    </button>
                    <button 
                        onClick={() => setActiveModule('drawing')}
                        className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${
                            activeModule === 'drawing' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'
                        }`}
                    >
                        2. Draw Survey Unit
                    </button>
                </div>
                <div>
                    {activeModule === 'calculator' && <MARSSIM_SampleCalculator />}
                    {activeModule === 'drawing' && <DrawingTool isVisible={activeModule === 'drawing'} />}
                </div>
             </div>
         </div>
         );
         };
         
         /**
         * @file ChiSquaredCalculator.jsx
         * @description React component for a Chi-Squared (χ²) Test calculator.
         * This tool is used in health physics and other fields to check the stability
         * of a counting system by comparing the variance of repeated measurements
         * to the expected variance of a Poisson distribution.
         *
         * It calculates the χ² value, compares it against critical values for a
         * given significance level (α), and determines if the system 'PASSES' or
         * 'FAILS' the test for stability.
         *
         * @prop {string} chiSquaredData - String of raw, separated count data.
         * @prop {function} setChiSquaredData - State setter for the count data.
         * @prop {string} alpha - The significance level (e.g., '0.05').
         * @prop {function} setAlpha - State setter for the significance level.
         * @prop {object} result - Object containing the test result and details.
         * @prop {function} setResult - State setter for the test result.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         
const ChiSquaredCalculator = ({ chiSquaredData, setChiSquaredData, alpha, setAlpha, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const CHI_SQUARED_CRITICAL_VALUES = { '0.10': { lowerP: 0.05, upperP: 0.95, 1: 0.004, 2: 0.103, 3: 0.352, 4: 0.711, 5: 1.145, 6: 1.635, 7: 2.167, 8: 2.733, 9: 3.325, 10: 3.940, 11: 4.575, 12: 5.226, 13: 5.892, 14: 6.571, 15: 7.261, 16: 7.962, 17: 8.672, 18: 9.390, 19: 10.117, 20: 10.851, 21: 11.591, 22: 12.338, 23: 13.091, 24: 13.848, 25: 14.611, 26: 15.379, 27: 16.151, 28: 16.928, 29: 17.708, 30: 18.493, 40: 26.509 }, '0.05': { lowerP: 0.025, upperP: 0.975, 1: 0.001, 2: 0.051, 3: 0.216, 4: 0.484, 5: 0.831, 6: 1.237, 7: 1.690, 8: 2.180, 9: 2.700, 10: 3.247, 11: 3.816, 12: 4.404, 13: 5.009, 14: 5.629, 15: 6.262, 16: 6.908, 17: 7.564, 18: 8.231, 19: 8.907, 20: 9.591, 21: 10.283, 22: 10.982, 23: 11.689, 24: 12.401, 25: 13.120, 26: 13.844, 27: 14.573, 28: 15.308, 29: 16.047, 30: 16.791, 40: 24.433 }, '0.01': { lowerP: 0.005, upperP: 0.995, 1: 0.000, 2: 0.010, 3: 0.072, 4: 0.207, 5: 0.412, 6: 0.676, 7: 0.989, 8: 1.344, 9: 1.735, 10: 2.156, 11: 2.603, 12: 3.074, 13: 3.565, 14: 4.075, 15: 4.601, 16: 5.142, 17: 5.697, 18: 6.265, 19: 6.844, 20: 7.434, 21: 8.034, 22: 8.643, 23: 9.260, 24: 9.886, 25: 10.520, 26: 11.160, 27: 11.808, 28: 12.461, 29: 13.121, 30: 13.787, 40: 20.707 } };
    const UPPER_BOUNDS = { '0.10': { 1: 3.841, 2: 5.991, 3: 7.815, 4: 9.488, 5: 11.070, 6: 12.592, 7: 14.067, 8: 15.507, 9: 16.919, 10: 18.307, 11: 19.675, 12: 21.026, 13: 22.362, 14: 23.685, 15: 24.996, 16: 26.296, 17: 27.587, 18: 28.869, 19: 30.144, 20: 31.410, 21: 32.671, 22: 33.924, 23: 35.172, 24: 36.415, 25: 37.652, 26: 38.885, 27: 40.113, 28: 41.337, 29: 42.557, 30: 43.773, 40: 55.758 }, '0.05': { 1: 5.024, 2: 7.378, 3: 9.348, 4: 11.143, 5: 12.833, 6: 14.449, 7: 16.013, 8: 17.535, 9: 19.023, 10: 20.483, 11: 21.920, 12: 23.337, 13: 24.736, 14: 26.119, 15: 27.488, 16: 28.845, 17: 30.191, 18: 31.526, 19: 32.852, 20: 34.170, 21: 35.479, 22: 36.781, 23: 38.076, 24: 39.364, 25: 40.646, 26: 41.923, 27: 43.195, 28: 44.461, 29: 45.722, 30: 46.979, 40: 59.342 }, '0.01': { 1: 7.879, 2: 10.597, 3: 12.838, 4: 14.860, 5: 16.750, 6: 18.548, 7: 20.278, 8: 21.955, 9: 23.589, 10: 25.188, 11: 26.757, 12: 28.300, 13: 29.819, 14: 31.319, 15: 32.801, 16: 34.267, 17: 35.718, 18: 37.156, 19: 38.582, 20: 39.997, 21: 41.401, 22: 42.796, 23: 44.181, 24: 45.559, 25: 46.928, 26: 48.290, 27: 49.645, 28: 50.993, 29: 52.336, 30: 53.672, 40: 66.766 } };
    const resultStyles = { PASS: { container: 'bg-green-100 dark:bg-green-900/50', title: 'text-green-600 dark:text-green-400', text: 'text-green-800 dark:text-green-200' }, FAIL: { container: 'bg-red-100 dark:bg-red-900/50', title: 'text-red-600 dark:text-red-400', text: 'text-red-800 dark:text-red-200' } };
    
    const parseData = (dataString) => dataString.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
    
    const handleCalculate = () => {
    setResult(null); setError('');
    const data = parseData(chiSquaredData);
    if (data.length < 5) { setError('At least 5 data points are required for a meaningful test.'); return; }
    const n = data.length;
    const mean = data.reduce((sum, val) => sum + val, 0) / n;
    if (mean === 0) { setError('The mean of the counts cannot be zero.'); return; }
    const sumOfSquares = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0);
    const chiSquared = sumOfSquares / mean;
    const df = n - 1;
    const lowerBound = CHI_SQUARED_CRITICAL_VALUES[alpha][df];
    const upperBound = UPPER_BOUNDS[alpha][df];
    if (lowerBound === undefined || upperBound === undefined) { setError(`Critical values not available for N=${n} (df=${df}). Please use between 5 and 41 samples.`); return; }
    const pass = chiSquared > lowerBound && chiSquared < upperBound;
    const newResult = { conclusion: pass ? 'PASS' : 'FAIL', chiSquared: chiSquared.toFixed(3), df, mean: mean.toFixed(2), lowerBound: lowerBound.toFixed(3), upperBound: upperBound.toFixed(3), n };
    setResult(newResult);
    };

    React.useEffect(() => {
        handleCalculate();
    }, [chiSquaredData, alpha]);

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'χ² Test', icon: ICONS.labStats, inputs: `N=${result.n}, α=${alpha}`, result: `χ²=${result.chiSquared}, ${result.conclusion}`, view: VIEWS.LAB_STATS });
            addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <p className="text-sm text-slate-600 dark:text-slate-400">Checks if a counting system is statistically stable.</p>
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div>
               <div className="flex justify-between items-center"><label className="block text-sm font-medium">Repeated Count Data</label><button onClick={() => setChiSquaredData('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
               <textarea value={chiSquaredData} onChange={e => setChiSquaredData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated count values..."></textarea>
           </div>
           <div>
               <label className="block text-sm font-medium">Significance Level (α)</label>
               <select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="0.10">0.10</option><option value="0.05">0.05</option><option value="0.01">0.01</option></select>
           </div>
       </div>
       <button onClick={handleSaveToHistory} disabled={!result} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed">Save to Calculations</button>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
            <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.conclusion].container}`}>
               <p className={`text-3xl font-extrabold ${resultStyles[result.conclusion].title}`}>SYSTEM {result.conclusion}ES</p>
               <p className={`mt-2 text-sm ${resultStyles[result.conclusion].text}`}>The observed variance is {result.conclusion === 'PASS' ? 'consistent with' : 'not consistent with'} a random Poisson distribution.</p>
               <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 text-sm">
                   <p>Calculated χ² of <strong>{result.chiSquared}</strong> is {result.conclusion === 'PASS' ? 'within' : 'outside'} the acceptable range of <strong>{result.lowerBound}</strong> to <strong>{result.upperBound}</strong>.</p>
                   <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">(for N={result.n}, df={result.df}, α={alpha})</p>
               </div>
           </div>
       )}
    </div>
    );
};
         
         /**
         * @description React component for a Dead Time Correction calculator.
         * This tool calculates the true count rate of a radiation detector, accounting
         * for the "dead time"—the brief period after a count is registered during which
         * the detector cannot detect another particle.
         *
         * It uses the formula:
         * N = R / (1 - R * τ)
         * where:
         * N = true count rate
         * R = observed count rate
         * τ = detector dead time
         *
         * This component takes observed counts per minute (CPM) and dead time in microseconds (µs)
         * as inputs and provides the corrected CPM and the percentage of counts lost due to dead time.
         * The calculation is automatically updated whenever the input values change.
         *
         * @prop {string} observedCpm - Observed counts per minute.
         * @prop {function} setObservedCpm - State setter for observed CPM.
         * @prop {string} deadTime - Dead time in microseconds.
         * @prop {function} setDeadTime - State setter for dead time.
         * @prop {object} result - Object containing the corrected rate and lost percentage.
         * @prop {function} setResult - State setter for the result.
         * @prop {string} error - Any error message to display.
         * @prop {function} setError - State setter for error messages.
         */
         
const DeadTimeCorrector = ({ observedCpm, setObservedCpm, deadTime, setDeadTime, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    React.useEffect(() => {
    try {
       setError('');
       const R = parseFloat(observedCpm);
       const tau_us = parseFloat(deadTime);
       if (isNaN(R) || isNaN(tau_us) || R < 0 || tau_us < 0) {
           if(observedCpm || deadTime) setError("Inputs must be positive numbers.");
           setResult(null); return;
       }
       const R_cps = R / 60.0;
       const tau_s = tau_us / 1e6;
       const denominator = 1 - (R_cps * tau_s);
       if (denominator <= 0) { throw new Error("Count rate is too high for this dead time; detector is saturated."); }
       const N_cps = R_cps / denominator;
       const N_cpm = N_cps * 60;
       const lossPercent = (1 - (R / N_cpm)) * 100;
       setResult({ trueCpm: N_cpm, lossPercent });
    } catch(e) { setError(e.message); setResult(null); }
    }, [observedCpm, deadTime, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Dead Time Correction', icon: ICONS.stopwatch, inputs: `Obs: ${observedCpm} cpm, τ: ${deadTime} µs`, result: `True: ${Math.round(result.trueCpm)} cpm`, view: VIEWS.LAB_STATS });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <p className="text-sm text-slate-600 dark:text-slate-400">Corrects for counts missed at high rates.</p>
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label className="block text-sm font-medium">Observed Count Rate (CPM)</label><input type="number" value={observedCpm} onChange={e => setObservedCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Detector Dead Time (µs)</label><input type="number" value={deadTime} onChange={e => setDeadTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                <div className="flex justify-between items-center -mt-2 -mb-2">
                    <div></div> {/* Spacer */}
                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Corrected (True) Count Rate</p>
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
                </div>
               <div className="flex items-center justify-center">
                   <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{Math.round(result.trueCpm).toLocaleString()}</p>
                   <CopyButton textToCopy={Math.round(result.trueCpm)} />
               </div>
    
               <p className="text-md font-medium text-slate-600 dark:text-slate-300">CPM</p>
               <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600">
                   <p className={`font-semibold text-lg ${result.lossPercent > 20 ? 'text-red-500' : result.lossPercent > 10 ? 'text-amber-500' : 'text-slate-600 dark:text-slate-300'}`}>{result.lossPercent.toFixed(1)}% Counts Lost</p>
               </div>
           </div>
       )}
    </div>
    );
};
         
         
const RpdCalculator = ({ sample1, setSample1, sample2, setSample2, result, setResult }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    React.useEffect(() => {
    const s1 = parseFloat(sample1);
    const s2 = parseFloat(sample2);
    if (!isNaN(s1) && !isNaN(s2) && (s1 + s2 > 0)) {
       const rpd = Math.abs(s1 - s2) / ((s1 + s2) / 2) * 100;
       setResult({ rpd: rpd.toFixed(2), isGood: rpd <= 20 });
    } else { setResult(null); }
    }, [sample1, sample2, setResult]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'RPD', icon: ICONS.compare, inputs: `S1: ${sample1}, S2: ${sample2}`, result: `${result.rpd}%`, view: VIEWS.LAB_STATS });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <p className="text-sm text-slate-600 dark:text-slate-400">Compares duplicate samples for precision.</p>
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div><label className="block text-sm font-medium">Sample 1 Value</label><input type="number" value={sample1} onChange={e => setSample1(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Sample 2 (Duplicate) Value</label><input type="number" value={sample2} onChange={e => setSample2(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
       </div>
       {result && (
           <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                <div className="flex justify-between items-center -mt-2 -mb-2">
                    <div></div> {/* Spacer */}
                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Relative Percent Difference (RPD)</p>
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
                </div>
               <div className="flex items-center justify-center">
                   <p className={`text-3xl font-bold ${result.isGood ? 'text-sky-600 dark:text-sky-400' : 'text-amber-500'}`}>{result.rpd}%</p>
                   <CopyButton textToCopy={result.rpd} />
               </div>
      
               <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">(A difference of ≤ 20% is often acceptable)</p>
           </div>
       )}
    </div>
    );
};
         
const FwhmCalculator = ({ centroid, setCentroid, lower, setLower, upper, setUpper, result, setResult }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    React.useEffect(() => {
    const c = parseFloat(centroid); const l = parseFloat(lower); const u = parseFloat(upper);
    if (!isNaN(c) && !isNaN(l) && !isNaN(u) && c > 0 && u > l) {
       const fwhm = u - l; const resolution = (fwhm / c) * 100;
       setResult({ fwhm: fwhm.toFixed(2), resolution: resolution.toFixed(2) });
    } else { setResult(null); }
    }, [centroid, lower, upper, setResult]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'FWHM / Resolution', icon: ICONS.gammaSpec, inputs: `Centroid: ${centroid} keV`, result: `${result.resolution}% Resolution`, view: VIEWS.LAB_STATS });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <p className="text-sm text-slate-600 dark:text-slate-400">Calculates detector energy resolution.</p>
       <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div><label className="block text-sm font-medium">Peak Centroid (keV)</label><input type="number" value={centroid} onChange={e => setCentroid(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Lower Energy @ ½ Max (keV)</label><input type="number" value={lower} onChange={e => setLower(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Upper Energy @ ½ Max (keV)</label><input type="number" value={upper} onChange={e => setUpper(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
       </div>
       {result && (
           <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 animate-fade-in">
                <div className="flex justify-end -mt-2 -mr-2">
                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                       <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                           <Icon path={ICONS.notepad} className="w-5 h-5" />
                       </button>
                    </Tooltip>
                </div>
                <div className="grid grid-cols-2 gap-4 -mt-2">
                    <div className="text-center">
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">FWHM</p>
                        <div className="flex items-center justify-center">
                            <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.fwhm} <span className="text-xl opacity-75">keV</span></p>
                            <CopyButton textToCopy={result.fwhm} />
                        </div>
                    </div>
                    <div className="text-center">
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Resolution</p>
                        <div className="flex items-center justify-center">
                            <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.resolution}%</p>
                            <CopyButton textToCopy={result.resolution} />
                        </div>
                    </div>
                </div>
           </div>
       )}
    </div>
    );
};
         
         const LabStatistics = () => {
         const [activeCalculator, setActiveCalculator] = React.useState('chiSquared');
         
         // State for ChiSquaredCalculator (Lifted)
         const [chi_chiSquaredData, setChi_chiSquaredData] = React.useState('');
         const [chi_alpha, setChi_alpha] = React.useState('0.05');
         const [chi_result, setChi_result] = React.useState(null);
         const [chi_error, setChi_error] = React.useState('');
         
         // State for DeadTimeCorrector (Lifted)
         const [dt_observedCpm, setDt_observedCpm] = React.useState('50000');
         const [dt_deadTime, setDt_deadTime] = React.useState('100');
         const [dt_result, setDt_result] = React.useState(null);
         const [dt_error, setDt_error] = React.useState('');
         
         // State for RpdCalculator (Lifted)
         const [rpd_sample1, setRpd_sample1] = React.useState('1250');
         const [rpd_sample2, setRpd_sample2] = React.useState('1180');
         const [rpd_result, setRpd_result] = React.useState(null);
         
         // State for FwhmCalculator (Lifted)
         const [fwhm_centroid, setFwhm_centroid] = React.useState('661.7');
         const [fwhm_lower, setFwhm_lower] = React.useState('658.2');
         const [fwhm_upper, setFwhm_upper] = React.useState('665.2');
         const [fwhm_result, setFwhm_result] = React.useState(null);
         
         // Clear Logic (Lifted)
         const handleChiClear = () => {
         setChi_chiSquaredData(''); setChi_alpha('0.05');
         setChi_result(null); setChi_error('');
         };
         const handleDeadTimeClear = () => {
         setDt_observedCpm('50000'); setDt_deadTime('100');
         setDt_result(null); setDt_error('');
         };
         const handleRpdClear = () => {
         setRpd_sample1('1250'); setRpd_sample2('1180');
         setRpd_result(null);
         };
         const handleFwhmClear = () => {
         setFwhm_centroid('661.7'); setFwhm_lower('658.2'); setFwhm_upper('665.2');
         setFwhm_result(null);
         };
         
         const handleClearActiveCalculator = () => {
         switch (activeCalculator) {
            case 'chiSquared': handleChiClear(); break;
            case 'deadTime': handleDeadTimeClear(); break;
            case 'rpd': handleRpdClear(); break;
            case 'fwhm': handleFwhmClear(); break;
            default: break;
         }
         };
         
         const calculatorViews = {
         chiSquared: { 
            label: 'χ² Test', 
            component: <ChiSquaredCalculator 
                chiSquaredData={chi_chiSquaredData} setChiSquaredData={setChi_chiSquaredData}
                alpha={chi_alpha} setAlpha={setChi_alpha}
                result={chi_result} setResult={setChi_result}
                error={chi_error} setError={setChi_error}
            /> 
         },
         deadTime: { 
            label: 'Dead Time', 
            component: <DeadTimeCorrector 
                observedCpm={dt_observedCpm} setObservedCpm={setDt_observedCpm}
                deadTime={dt_deadTime} setDeadTime={setDt_deadTime}
                result={dt_result} setResult={setDt_result}
                error={dt_error} setError={setDt_error}
            /> 
         },
         rpd: { 
            label: 'RPD', 
            component: <RpdCalculator 
                sample1={rpd_sample1} setSample1={setRpd_sample1}
                sample2={rpd_sample2} setSample2={setRpd_sample2}
                result={rpd_result} setResult={setRpd_result}
            /> 
         },
         fwhm: { 
            label: 'FWHM', 
            component: <FwhmCalculator 
                centroid={fwhm_centroid} setCentroid={setFwhm_centroid}
                lower={fwhm_lower} setLower={setFwhm_lower}
                upper={fwhm_upper} setUpper={setFwhm_upper}
                result={fwhm_result} setResult={setFwhm_result}
            /> 
         },
         };
         
         return (
         <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Lab Statistics & QA/QC</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6 overflow-x-auto">
                    {Object.entries(calculatorViews).map(([key, { label }]) => (
                        <button
                            key={key}
                            onClick={() => setActiveCalculator(key)}
                            className={`flex-shrink-0 w-1/4 p-2 rounded-md text-sm font-semibold transition-colors ${ activeCalculator === key ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}
                        >
                            {label}
                        </button>
                    ))}
                </div>
                <div className="mt-4">
                    {calculatorViews[activeCalculator].component}
                </div>
            </div>
         </div>
         );
         };
         
         // This component provides a user interface for performing two statistical tests from the Multi-Agency Radiation Survey and Site Investigation Manual (MARSSIM): the Wilcoxon Rank Sum (WRS) test for survey units and the Elevated Measurement Comparison (EMC) Sign Test for localized areas.
         
         const MARSSIM_Statistical_Tests = () => {
         const TEST_WRS = 'wrs';
         const TEST_EMC = 'emc';
         const [activeTest, setActiveTest] = React.useState(TEST_WRS);
         
         const [wrs_dcgl, setWrs_dcgl] = React.useState(() => localStorage.getItem('wrs_dcgl') || '5');
         const [wrs_referenceData, setWrs_referenceData] = React.useState(() => localStorage.getItem('wrs_referenceData') || '1.6\n1.2\n1.4\n1.2\n0.5\n1.5\n0.8\n1.1\n1.9\n1.7\n1.8\n1.8\n1.7\n1.9\n2.1\n1.8\n2.1\n2.4\n2.2\n2.9\n2\n1.7\n2.3\n1.1\n2.3\n0.6\n1.1\n1.1\n1.4\n2.1');
         const [wrs_surveyData, setWrs_surveyData] = React.useState(() => localStorage.getItem('wrs_surveyData') || '2.928\n3.458\n3.31\n3.198\n2.218\n6.827\n2.269\n4.96\n2.766\n3.29\n10.833\n1.606\n1.856\n3.135\n1.808\n1.873\n3.373\n1.887\n1.457\n5.5\n1.973\n1.915\n2.205\n1.814\n3.7\n2.327\n1.919\n2.677\n3.253\n1.776\n5.201\n4.737\n2.585');
         const [wrs_alpha, setWrs_alpha] = React.useState(() => localStorage.getItem('wrs_alpha') || '0.05');
         const [wrs_result, setWrs_result] = React.useState(null);
         const [wrs_error, setWrs_error] = React.useState('');
         
         const [emc_dcglw, setEmc_dcglw] = React.useState(() => localStorage.getItem('emc_dcglw') || '100');
         const [emc_areaFactor, setEmc_areaFactor] = React.useState(() => localStorage.getItem('emc_areaFactor') || '3');
         const [emc_emcData, setEmc_emcData] = React.useState(() => localStorage.getItem('emc_emcData') || '120, 150, 95, 250, 180, 210, 190, 280');
         const [emc_alpha, setEmc_alpha] = React.useState(() => localStorage.getItem('emc_alpha') || '0.05');
         const [emc_result, setEmc_result] = React.useState(null);
         const [emc_error, setEmc_error] = React.useState('');
         
         const handleWrsClear = () => {
         setWrs_dcgl('5');
         setWrs_referenceData('1.6\n1.2\n1.4\n1.2\n0.5\n1.5\n0.8\n1.1\n1.9\n1.7\n1.8\n1.8\n1.7\n1.9\n2.1\n1.8\n2.1\n2.4\n2.2\n2.9\n2\n1.7\n2.3\n1.1\n2.3\n0.6\n1.1\n1.1\n1.4\n2.1');
         setWrs_surveyData('2.928\n3.458\n3.31\n3.198\n2.218\n6.827\n2.269\n4.96\n2.766\n3.29\n10.833\n1.606\n1.856\n3.135\n1.808\n1.873\n3.373\n1.887\n1.457\n5.5\n1.973\n1.915\n2.205\n1.814\n3.7\n2.327\n1.919\n2.677\n3.253\n1.776\n5.201\n4.737\n2.585');
         setWrs_alpha('0.05');
         setWrs_result(null);
         setWrs_error('');
         };
         
         const handleEmcClear = () => {
         setEmc_dcglw('100');
         setEmc_areaFactor('3');
         setEmc_emcData('120, 150, 95, 250, 180, 210, 190, 280');
         setEmc_alpha('0.05');
         setEmc_result(null);
         setEmc_error('');
         };
         
         const handleClearActiveCalculator = () => {
         if (activeTest === TEST_WRS) {
            handleWrsClear();
         } else {
            handleEmcClear();
         }
         };
         
         return (
         <div className="p-4 animate-fade-in">
            <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">MARSSIM Statistical Tests</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setActiveTest(TEST_WRS)} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${activeTest === TEST_WRS ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>WRS Test</button>
                    <button onClick={() => setActiveTest(TEST_EMC)} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${activeTest === TEST_EMC ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>EMC Sign Test</button>
                </div>
                {activeTest === TEST_WRS ? 
                    <WRS_Calculator 
                        dcgl={wrs_dcgl} setDcgl={setWrs_dcgl}
                        referenceData={wrs_referenceData} setReferenceData={setWrs_referenceData}
                        surveyData={wrs_surveyData} setSurveyData={setWrs_surveyData}
                        alpha={wrs_alpha} setAlpha={setWrs_alpha}
                        result={wrs_result} setResult={setWrs_result}
                        error={wrs_error} setError={setWrs_error}
                    /> : 
                    <EMC_Calculator 
                        dcglw={emc_dcglw} setDcglw={setEmc_dcglw}
                        areaFactor={emc_areaFactor} setAreaFactor={setEmc_areaFactor}
                        emcData={emc_emcData} setEmcData={setEmc_emcData}
                        alpha={emc_alpha} setAlpha={setEmc_alpha}
                        result={emc_result} setResult={setEmc_result}
                        error={emc_error} setError={setEmc_error}
                    />
                }
            </div>
         </div>
         );
         };
         
         const WRS_Calculator = ({ dcgl, setDcgl, referenceData, setReferenceData, surveyData, setSurveyData, alpha, setAlpha, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const criticalValueTable = { '0.05': { '5': { '5': 28, '6': 32, '7': 36, '8': 41, '9': 45, '10': 50 }, '6': { '5': 33, '6': 38, '7': 43, '8': 48, '9': 53, '10': 59 }, '7': { '5': 37, '6': 43, '7': 49, '8': 54, '9': 60, '10': 66 }, '8': { '5': 42, '6': 49, '7': 55, '8': 61, '9': 67, '10': 74 }, '9': { '5': 46, '6': 54, '7': 61, '8': 68, '9': 75, '10': 82 }, '10': { '5': 51, '6': 59, '7': 67, '8': 75, '9': 83, '10': 91 }, '11': { '11': 111, '12': 119, '13': 127, '14': 135, '15': 143 }, '12': { '12': 131, '13': 139, '14': 148, '15': 156, '16': 165 }, '13': { '13': 151, '14': 160, '15': 169, '16': 178, '17': 187 }, '14': { '14': 171, '15': 181, '16': 190, '17': 200, '18': 210 }, '15': { '15': 192, '16': 202, '17': 212, '18': 223, '19': 233 } } };
    const zScores = { '0.05': 1.645, '0.025': 1.960, '0.01': 2.326, '0.10': 1.282 };
    const resultStyles = { PASS: { container: 'bg-green-100 dark:bg-green-900/50', title: 'text-green-600 dark:text-green-400', text: 'text-green-800 dark:text-green-200', display: 'SURVEY UNIT PASSES' }, PASS_EMC: { container: 'bg-yellow-100 dark:bg-yellow-900/50', title: 'text-yellow-600 dark:text-yellow-400', text: 'text-yellow-800 dark:text-yellow-200', display: 'PASS (EMC Required)' }, FAIL: { container: 'bg-red-100 dark:bg-red-900/50', title: 'text-red-600 dark:text-red-400', text: 'text-red-800 dark:text-red-200', display: 'SURVEY UNIT FAILS' } };
    
    React.useEffect(() => {
    localStorage.setItem('wrs_dcgl', dcgl);
    localStorage.setItem('wrs_referenceData', referenceData);
    localStorage.setItem('wrs_surveyData', surveyData);
    localStorage.setItem('wrs_alpha', alpha);
    }, [dcgl, referenceData, surveyData, alpha]);
    
    const parseData = (dataString) => dataString.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
    
    const handleCalculate = () => {
    setResult(null); setError('');
    const refData = parseData(referenceData); const suData = parseData(surveyData); const dcgl_val = parseFloat(dcgl);
    if (isNaN(dcgl_val)) { setError('DCGL must be a valid number.'); return; }
    if (refData.length < 5 || suData.length < 5) { setError('At least 5 data points are required for each area.'); return; }
    const dcglExceeded = suData.some(val => val > dcgl_val);
    let combined = [...refData.map(v => ({ value: v + dcgl_val, group: 'ref' })), ...suData.map(v => ({ value: v, group: 'su' }))].sort((a, b) => a.value - b.value);
    for (let i = 0; i < combined.length; i++) {
       let ties = [i]; const epsilon = 1e-9;
       while (i + 1 < combined.length && Math.abs(combined[i].value - combined[i + 1].value) < epsilon) { i++; ties.push(i); }
       if (ties.length > 1) { const avgRank = (ties[0] + 1 + ties[ties.length - 1] + 1) / 2; ties.forEach(index => { combined[index].rank = avgRank; }); } else { combined[i].rank = i + 1; }
    }
    const W_rs = combined.filter(d => d.group === 'ref').reduce((sum, d) => sum + d.rank, 0);
    const n = refData.length; const m = suData.length; let C_w;
    const tableVal = criticalValueTable[alpha]?.[n]?.[m] || criticalValueTable[alpha]?.[m]?.[n];
    if (tableVal) { C_w = tableVal; } 
    else {
       const zAlpha = zScores[alpha]; const N = n + m; const mean_W = (n * (N + 1)) / 2; const tieGroups = {};
       combined.forEach(item => { tieGroups[item.value] = (tieGroups[item.value] || 0) + 1; });
       const tieCorrection = Object.values(tieGroups).filter(t => t > 1).reduce((sum, t) => sum + (Math.pow(t, 3) - t), 0);
       const variance_W = ((n * m * (N + 1)) / 12) - ((n * m * tieCorrection) / (12 * N * (N - 1)));
       const stdDev_W_corrected = Math.sqrt(variance_W); C_w = Math.round(mean_W + (zAlpha * stdDev_W_corrected) + 0.5);
    }
    const wrsTestPassed = W_rs >= C_w; let finalConclusion = 'FAIL'; let finalReason = `The rank sum (${W_rs}) is less than the critical value (${C_w}).`;
    if (wrsTestPassed) {
       if (dcglExceeded) { finalConclusion = 'PASS_EMC'; finalReason = `The WRS test passes, but an Elevated Measurement Comparison (EMC) is required because at least one measurement exceeds the DCGL.`; } 
       else { finalConclusion = 'PASS'; finalReason = `The rank sum (${W_rs}) is greater than or equal to the critical value (${C_w}), and no measurements exceed the DCGL.`; }
    }
    const newResult = { conclusion: finalConclusion, reason: finalReason, n, m, W_rs, C_w, rankedData: combined };
    setResult(newResult);
    };

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({
                id: Date.now(),
                type: 'WRS Test',
                icon: ICONS.labStats,
                inputs: `n=${result.n}, m=${result.m}`,
                result: resultStyles[result.conclusion].display,
                view: VIEWS.MARSSIM_TESTS
            });
            addToast("Calculation saved to history!");
        }
    };

    React.useEffect(() => {
        handleCalculate();
    }, [dcgl, referenceData, surveyData, alpha]);
    
    return (
    <div className="space-y-4">
       <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
               <div className="flex justify-between items-center"><label className="block text-sm font-medium">Reference Area Data</label><button onClick={() => setReferenceData('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
               <textarea value={referenceData} onChange={e => setReferenceData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
               <p className="text-right text-xs font-semibold text-slate-500 dark:text-slate-400 mt-1 pr-1">Samples (n): {parseData(referenceData).length}</p>
           </div>
           <div>
               <div className="flex justify-between items-center"><label className="block text-sm font-medium">Survey Unit Data</label><button onClick={() => setSurveyData('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
               <textarea value={surveyData} onChange={e => setSurveyData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
               <p className="text-right text-xs font-semibold text-slate-500 dark:text-slate-400 mt-1 pr-1">Samples (m): {parseData(surveyData).length}</p>
           </div>
       </div>
       <div className="grid grid-cols-2 gap-4">
           <div><label className="block text-sm font-medium">DCGL</label><input type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Significance Level (&alpha;)</label><select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="0.05">0.05</option><option value="0.025">0.025</option><option value="0.01">0.01</option><option value="0.10">0.10</option></select></div>
       </div>
       <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Save to Calculations</button>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.conclusion].container}`}>
               <p className={`text-3xl font-extrabold ${resultStyles[result.conclusion].title}`}>{resultStyles[result.conclusion].display}</p>
               <p className={`mt-2 text-sm ${resultStyles[result.conclusion].text}`}>{result.reason}</p>
               <details className="mt-4 text-left text-xs"><summary className="cursor-pointer font-semibold">Show Ranked Data Table</summary><div className="mt-2 max-h-48 overflow-y-auto bg-white dark:bg-slate-800 p-2 rounded"><table className="w-full"><thead><tr className="font-bold"><td className="p-1">Value</td><td className="p-1">Group</td><td className="p-1">Rank</td></tr></thead><tbody>{result.rankedData.map((item, i) => (<tr key={i} className={item.group === 'ref' ? 'text-sky-600 dark:text-sky-400' : ''}><td className="p-1 font-mono">{item.value.toFixed(3)}</td><td className="p-1">{item.group.toUpperCase()}</td><td className="p-1">{item.rank}</td></tr>))}</tbody></table></div></details>
               <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                   <p>Reference Samples (n): <span className="font-bold">{result.n}</span></p><p>Survey Samples (m): <span className="font-bold">{result.m}</span></p>
                   <p>Rank Sum (W&darr;rs): <span className="font-bold">{result.W_rs}</span></p><p>Critical Value (C&darr;w): <span className="font-bold">{result.C_w}</span></p>
               </div>
           </div>
       )}
       {!result && !error && (
           <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg mt-4">
               <p className="text-slate-500 dark:text-slate-400">Paste your reference and survey data above to perform the WRS test.</p>
           </div>
       )}
    </div>
    );
};

         const EMC_Calculator = ({ dcglw, setDcglw, areaFactor, setAreaFactor, emcData, setEmcData, alpha, setAlpha, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const signTestCriticalValues = { '0.05': { 5: 5, 6: 6, 7: 7, 8: 7, 9: 8, 10: 9, 11: 9, 12: 10, 13: 11, 14: 11, 15: 12, 16: 12, 17: 13, 18: 14, 19: 14, 20: 15, 21: 16, 22: 16, 23: 17, 24: 17, 25: 18, 26: 19, 27: 19, 28: 20, 29: 21, 30: 21 }, '0.025': { 5: 5, 6: 6, 7: 7, 8: 8, 9: 8, 10: 9, 11: 10, 12: 10, 13: 11, 14: 12, 15: 12, 16: 13, 17: 14, 18: 14, 19: 15, 20: 15, 21: 16, 22: 17, 23: 17, 24: 18, 25: 19, 26: 19, 27: 20, 28: 20, 29: 21, 30: 22 }, '0.01': { 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 9, 11: 10, 12: 11, 13: 11, 14: 12, 15: 13, 16: 13, 17: 14, 18: 15, 19: 15, 20: 16, 21: 17, 22: 17, 23: 18, 24: 18, 25: 19, 26: 20, 27: 20, 28: 21, 29: 22, 30: 22 }, '0.10': { 5: 4, 6: 5, 7: 6, 8: 6, 9: 7, 10: 8, 11: 8, 12: 9, 13: 10, 14: 10, 15: 11, 16: 11, 17: 12, 18: 13, 19: 13, 20: 14, 21: 15, 22: 15, 23: 16, 24: 16, 25: 17, 26: 18, 27: 18, 28: 19, 29: 20, 30: 20 } };
    const zScores = { '0.05': 1.645, '0.025': 1.960, '0.01': 2.326, '0.10': 1.282 };
    
    React.useEffect(() => {
    localStorage.setItem('emc_dcglw', dcglw);
    localStorage.setItem('emc_areaFactor', areaFactor);
    localStorage.setItem('emc_emcData', emcData);
    localStorage.setItem('emc_alpha', alpha);
    }, [dcglw, areaFactor, emcData, alpha]);
    
    const parseData = (dataString) => dataString.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
    
    const handleCalculate = () => {
    setResult(null); setError('');
    const initialData = parseData(emcData); const dcglw_val = parseFloat(dcglw); const af_val = parseFloat(areaFactor);
    if (isNaN(dcglw_val) || isNaN(af_val) || dcglw_val <= 0 || af_val <= 1) { setError('DCGL and Area Factor must be valid numbers (AF > 1).'); return; }
    if (initialData.length === 0) { setError('Please enter measurement data.'); return; }
    const dcgl_emc = dcglw_val * af_val; const epsilon = 1e-9;
    const data = initialData.filter(val => Math.abs(dcgl_emc - val) > epsilon); const n_adjusted = data.length; const ties = initialData.length - n_adjusted;
    if (n_adjusted === 0) { setError('All data points are equal to the DCGL_EMC; the test cannot be performed.'); return; }
    const S_plus = data.filter(val => (dcgl_emc - val) > 0).length;
    let Cs; let note = '';
    const tableValue = signTestCriticalValues[alpha]?.[n_adjusted];
    if (tableValue !== undefined) { Cs = tableValue; note = `Used MARSSIM Table I.3 for N=${n_adjusted}.`; } 
    else {
       const zAlpha = zScores[alpha];
       if (!zAlpha) { setError(`Z-score for alpha=${alpha} not available.`); return; }
       Cs = Math.ceil((n_adjusted / 2) - 0.5 - (zAlpha * Math.sqrt(n_adjusted) / 2));
       note = `Used Large Sample Approximation for N=${n_adjusted}.`;
    }
    const testPassed = S_plus >= Cs;
    const newResult = { conclusion: testPassed ? 'PASS' : 'FAIL', reason: `The number of positive differences (S+) is ${S_plus}, which is ${testPassed ? 'greater than or equal to' : 'less than'} the critical value (${Cs}).`, n: initialData.length, n_adjusted, ties, dcgl_emc: dcgl_emc.toPrecision(4), S_plus, Cs, note };
    setResult(newResult);
    };

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({
                id: Date.now(),
                type: 'EMC Sign Test',
                icon: ICONS.labStats,
                inputs: `N=${result.n}, DCGL_emc=${result.dcgl_emc}`,
                result: `EMC AREA ${result.conclusion}ES`,
                view: VIEWS.MARSSIM_TESTS
            });
            addToast("Calculation saved to history!");
        }
    };

    React.useEffect(() => {
        handleCalculate();
    }, [dcglw, areaFactor, emcData, alpha]);
    
    return (
    <div className="space-y-4">
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div><label htmlFor="emc-dcglw" className="block text-sm font-medium">Widespread DCGL (DCGLw)</label><input id="emc-dcglw" type="number" value={dcglw} onChange={e => setDcglw(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><label htmlFor="emc-af" className="block text-sm font-medium">Area Factor (AF)</label><input id="emc-af" type="number" value={areaFactor} onChange={e => setAreaFactor(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           </div>
           <div>
              <div className="flex justify-between items-center"><label htmlFor="emc-data" className="block text-sm font-medium">Elevated Area Measurements</label><button onClick={() => setEmcData('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
              <textarea id="emc-data" value={emcData} onChange={e => setEmcData(e.target.value)} rows="6" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
           </div>
           <div><label htmlFor="emc-alpha" className="block text-sm font-medium">Significance Level (&alpha;)</label><select id="emc-alpha" value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="0.05">0.05</option><option value="0.025">0.025</option><option value="0.01">0.01</option><option value="0.10">0.10</option></select></div>
       </div>
       <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Save to Calculations</button>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${result.conclusion === 'PASS' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
               <p className={`text-3xl font-extrabold ${result.conclusion === 'PASS' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>EMC AREA {result.conclusion}ES</p>
               <p className={`mt-2 text-sm ${result.conclusion === 'PASS' ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}`}>{result.reason}</p>
               <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                   <p>DCGL&darr;emc: <span className="font-bold">{result.dcgl_emc}</span></p><p>Initial Samples (N): <span className="font-bold">{result.n}</span></p>
                   <p>Ties Discarded: <span className="font-bold">{result.ties}</span></p><p>Adjusted N': <span className="font-bold">{result.n_adjusted}</span></p>
                   <p>Positive Ranks (S+): <span className="font-bold">{result.S_plus}</span></p><p>Critical Value (Cs): <span className="font-bold">{result.Cs}</span></p>
               </div>
                <p className="text-xs italic text-slate-500 dark:text-slate-400 mt-3">{result.note}</p>
           </div>
       )}
       {!result && !error && (
           <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg mt-4">
               <p className="text-slate-500 dark:text-slate-400">Enter elevated area data and parameters to perform the EMC Sign Test.</p>
           </div>
       )}
    </div>
    );
};  
         
         /**
         * @description A React component that renders a line chart for simple radioactive decay using Chart.js.
         * It can display the decay of a parent nuclide and the in-growth and decay of a single daughter nuclide.
         * @param {{chartData: object}} props - The data object for the chart, including labels and datasets for parent and optional daughter.
         */
                  
         const DecayChart = ({ chartData, useLogScale, theme }) => {
         const chartRef = React.useRef(null);
         const chartInstance = React.useRef(null);
         
         React.useEffect(() => {

             // Destroy the previous chart instance if it exists

             if (chartInstance.current) {
                chartInstance.current.destroy();
             }
         
             if (chartRef.current && chartData) {
                // Determine colors based on the theme prop
                const isDarkMode = theme === 'dark';
                const textColor = isDarkMode ? '#94a3b8' : '#475569';
                const gridColor = isDarkMode ? '#334155' : '#e2e8f0';
                const legendColor = isDarkMode ? '#cbd5e1' : '#334155';

                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: chartData.parentName,
                                data: chartData.parentData,
                                borderColor: '#0284c7', // Sky-600
                                backgroundColor: 'rgba(2, 132, 199, 0.1)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0
                            },
                            ...(chartData.daughterData ? [{
                                label: chartData.daughterName,
                                data: chartData.daughterData,
                                borderColor: '#e11d48', // Rose-600
                                backgroundColor: 'rgba(225, 29, 72, 0.1)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0
                            }] : [])
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: `Time (${chartData.timeUnit})` },
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                type: useLogScale ? 'logarithmic' : 'linear',
                                title: { display: true, text: `Activity (${useLogScale ? 'Log Scale' : 'Linear Scale'})` },
                                beginAtZero: !useLogScale,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: legendColor
                                }
                            }
                        }
                    }
                });
             }
         
             return () => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
             };
         }, [chartData, useLogScale, theme]); // Added theme to the dependency array
         
         const handleExport = () => {
         if (chartInstance.current) {
            const link = document.createElement('a');
            link.href = chartInstance.current.toBase64Image();
            link.download = 'decay-chart.png';
            link.click();
         }
         };
         
         return (
         <div className="mt-4">
            <div className="h-64">
                <canvas ref={chartRef}></canvas>
            </div>
            <div className="text-center mt-2">
                <button
                    onClick={handleExport}
                    className="px-3 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold"
                >
                    Export as PNG
                </button>
            </div>
         </div>
         );
         };
         
         // Final step: Render the main App component into the DOM.
         
         ReactDOM.createRoot(document.getElementById('root')).render(
         <SettingsProvider>
         <ToastProvider>
             <App />
         </ToastProvider>
         </SettingsProvider>
         );
         
         ReactDOM.createRoot(document.getElementById('back-to-top-root')).render(
         <BackToTopButton />
         );
         
         // After the app is rendered, find the loader and fade it out.
         
         const loader = document.getElementById('loader');
         if (loader) {
         
         // A small timeout ensures the app has painted before the loader disappears.
         
         setTimeout(() => {
         
         loader.classList.add('hidden');
         }, 100); // 100ms delay
         }
         
      </script>
</body>

</html>
