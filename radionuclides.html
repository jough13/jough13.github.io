<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Basic HTML Metadata -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Physics Toolbox</title>

    <!-- External Libraries & Frameworks -->

    <!-- Tailwind CSS for styling -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script>

        // Enables Tailwind's dark mode feature, allowing class-based theme switching (e.g., <body class="dark">)

        tailwind.config = { darkMode: 'class' }
    </script>
    
    <!-- React Libraries for building the user interface -->

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel to transpile JSX (React's syntax) into plain JavaScript in the browser -->

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for creating data visualizations -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts for a clean, modern typeface -->

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
 
  
    <!-- Custom Application Styles -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

<style>
    /* This is now the only style block needed for the fade-in.
      It hides the main content area by default to prevent any FOUC.
    */
    #root {
      visibility: hidden;  /* Hide it completely */
      opacity: 0;          /* Start fully transparent */
      transform: translateY(-10px); /* Start slightly moved up */
      /* Prepare for a smooth transition when the 'visible' class is added */
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    }

    /* This class will be added by our script to trigger the animation */
    #root.visible {
      visibility: visible; /* Make it visible */
      opacity: 1;          /* Fade it in */
      transform: translateY(0); /* Move it to its final position */
    }
</style>

<style>
    body { 
        font-family: 'Inter', sans-serif; 
    }


    /* Custom scrollbar styling for a consistent look across browsers */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Keyframe animation for new elements fading into view */

    .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
    }

    /* Keyframe animation for toast notifications sliding in from the bottom */
    @keyframes toast-in {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-toast-in {
        animation: toast-in 0.3s ease-out forwards;
    }
</style>

<script>
    // When the document is ready, add the 'visible' class to the #root element
    // to trigger our CSS transition.
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('root').classList.add('visible');
    });
</script>

</head>

<body class="bg-slate-100 dark:bg-slate-900 transition-colors duration-300">

    <!-- The root element where the React application will be mounted. -->

 	<div id="root"></div>

    <!-- 
      The primary dataset for all radionuclides.
      Keeping this in a separate script tag makes the main application logic cleaner and easier to manage.
      Each object conforms to a consistent structure for properties like name, symbol, halfLife, etc.
    -->

    <script>


const RADIONUCLIDE_DATA = [

    { name: 'Actinium-225', symbol: 'Ac-225', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.83 MeV (dominant)'], gamma: ['0.099 MeV', '0.150 MeV'], beta: [] }, daughterEmissions: { from: 'Fr-221', alpha: ['6.34 MeV'] }, halfLife: '10.0 days', decayConstant: '0.0693 day⁻¹', specificActivity: '7.8 x 10^13 Bq/g', parent: 'Thorium-229 (α)', daughter: 'Francium-221 (α)', commonUses: ['Targeted Alpha Therapy (TAT) for cancer, often called an "alpha-emitter generator" for its decay chain.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A promising but scarce alpha-emitter used in clinical trials for targeted cancer therapy.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.8, A2: 0.001, unit: 'TBq' } },
    { name: 'Actinium-227', symbol: 'Ac-227', emissionType: ['Beta-minus', 'Alpha'], emissionEnergies: { beta: ['0.045 MeV (max)'], alpha: ['4.95 MeV (1.38%)'], gamma: [] }, avgBetaEnergy: '0.015 MeV', daughterEmissions: { from: 'Th-227', alpha: ['6.038 MeV'], gamma: ['0.236 MeV'] }, halfLife: '21.77 years', decayConstant: '0.0318 year⁻¹', specificActivity: '9.7 x 10^11 Bq/g', parent: 'Protactinium-231', daughter: 'Thorium-227 (β) or Francium-223 (α)', commonUses: ['Actinium-225 generator (medical)', 'Research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used in limited research applications and as a source for Ac-225 generators.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.0001, unit: 'TBq' } },
    { name: 'Actinium-228', symbol: 'Ac-228', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['2.14 MeV (max)'], gamma: ['0.911 MeV', '0.969 MeV'], alpha: [] }, avgBetaEnergy: '0.713 MeV', halfLife: '6.15 hours', decayConstant: '0.113 hour⁻¹', specificActivity: '1.2 x 10^17 Bq/g', parent: 'Radium-228', daughter: 'Thorium-228 (β-)', commonUses: ['Intermediate in Thorium-232 decay chain'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'Frequently encountered as a short-lived daughter product in the Thorium-232 natural decay series.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.6, A2: 0.2, unit: 'TBq' }, gammaConstant: '0.844 R·m²/hr·Ci' },
    { name: 'Americium-241', symbol: 'Am-241', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.486 MeV'], gamma: ['0.0595 MeV'], beta: [] }, halfLife: '432.2 years', decayConstant: '0.00160 year⁻¹', specificActivity: '1.27 x 10^11 Bq/g', parent: 'Plutonium-241 (β-)', daughter: 'Neptunium-237', commonUses: ['Smoke detectors', 'Industrial gauges (thickness, density)', 'Neutron sources'], category: 'Industrial', commonality: 'Common', commonalityReason: 'Used in virtually all household ionization smoke detectors and in various industrial gauges.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' }, gammaConstant: '0.012 R·m²/hr·Ci' },
    { name: 'Antimony-124', symbol: 'Sb-124', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['2.35 MeV (max)'], gamma: ['0.603 MeV', '1.691 MeV'], alpha: [] }, avgBetaEnergy: '0.783 MeV', halfLife: '60.2 days', decayConstant: '0.0115 day⁻¹', specificActivity: '7.8 x 10^14 Bq/g', parent: 'Tin-124', daughter: 'Tellurium-124 (stable)', commonUses: ['Tracer in hydrology', 'Industrial applications', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'Used for specialized industrial tracer studies but not in widespread applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.6, A2: 0.6, unit: 'TBq' }, gammaConstant: '1.07 R·m²/hr·Ci' },
    { name: 'Antimony-125', symbol: 'Sb-125', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.767 MeV (max)'], gamma: ['0.428 MeV', '0.601 MeV'], alpha: [] }, avgBetaEnergy: '0.256 MeV', halfLife: '2.758 years', decayConstant: '0.251 year⁻¹', specificActivity: '1.6 x 10^13 Bq/g', parent: 'Tin-125', daughter: 'Tellurium-125m (IT) -> Tellurium-125 (stable)', commonUses: ['Environmental tracer (fission product)', 'Calibration source'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived fission product used occasionally as a calibration source or environmental tracer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 1, unit: 'TBq' } },
    { name: 'Arsenic-74', symbol: 'As-74', emissionType: ['Positron Emission', 'Beta-minus', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['1.35 MeV (max)'], gamma: ['0.596 MeV', '0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.450 MeV', halfLife: '17.77 days', decayConstant: '0.039 day⁻¹', specificActivity: '5.1 x 10^15 Bq/g', parent: 'Germanium-74', daughter: 'Selenium-74 (stable) or Germanium-74 (stable)', commonUses: ['PET imaging research', 'Tracer studies'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used only in specialized PET imaging research; not for routine clinical use.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Astatine-211', symbol: 'At-211', emissionType: ['Alpha', 'Electron Capture', 'X-ray'], emissionEnergies: { alpha: ['5.867 MeV'], beta: [], gamma: [] }, halfLife: '7.21 hours', decayConstant: '0.096 hour⁻¹', specificActivity: '7.8 x 10^16 Bq/g', parent: 'Bismuth-209 (α,2n)', daughter: 'Bismuth-207 (EC) or Polonium-211 (α)', commonUses: ['Targeted alpha therapy research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A promising research alpha-emitter that is difficult to produce and has a short half-life.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 20, A2: 0.005, unit: 'TBq' } },
    { name: 'Astatine-218', emissionType: ['Alpha', 'Beta-minus'], symbol: 'At-218', emissionEnergies: { alpha: ['6.757 MeV'], beta: ['2.88 MeV (max)'] }, avgBetaEnergy: '0.960 MeV', halfLife: '1.5 seconds', decayConstant: '0.462 s⁻¹', specificActivity: '4.8 x 10^19 Bq/g', parent: 'Polonium-218', daughter: 'Bismuth-214 (α) or Radon-218 (β-)', commonUses: ['Intermediate in U-238 decay chain'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain with no practical applications.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Barium-133', symbol: 'Ba-133', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.356 MeV', '0.081 MeV'], alpha: [] }, halfLife: '10.51 years', decayConstant: '0.0659 year⁻¹', gammaConstant: '0.30 R·m²/hr·Ci', specificActivity: '9.3 x 10^12 Bq/g', parent: 'Lanthanum-133', daughter: 'Cesium-133 (stable)', commonUses: ['Calibration sources', 'Density gauging'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A common, long-lived gamma source used for calibrating gamma spectroscopy systems.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 3, A2: 3, unit: 'TBq' } },
    { name: 'Barium-137', symbol: 'Ba-137', emissionType: ['Stable'], emissionEnergies: { alpha: [], beta: [], gamma: [] }, halfLife: 'Stable', decayConstant: '0', specificActivity: '0 Bq/g', parent: 'Barium-137m (IT)', daughter: 'Stable', commonUses: ['Final stable product of Cesium-137 decay', 'Stable isotope analysis'], category: 'Stable/Reference', commonality: 'Common', commonalityReason: 'The stable end-product of Cs-137 decay, one of the most common radioisotopes.', sourceRef: {} },
    { name: 'Barium-137m', symbol: 'Ba-137m', emissionType: ['Isomeric Transition', 'Gamma'], emissionEnergies: { alpha: [], beta: [], gamma: ['0.662 MeV'] }, halfLife: '2.55 minutes', decayConstant: '0.272 min⁻¹', specificActivity: '2.9 x 10^18 Bq/g', parent: 'Cesium-137 (β-)', daughter: 'Barium-137 (stable)', commonUses: ['Source of gamma rays from Cesium-137 calibration sources', 'Medical imaging (historical)'], category: 'Industrial', commonality: 'Common', commonalityReason: 'The immediate, gamma-emitting daughter of Cs-137, responsible for its characteristic 0.662 MeV gamma ray.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 0.6, unit: 'TBq' } },
    { name: 'Bismuth-207', symbol: 'Bi-207', emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.570 MeV', '1.063 MeV'], alpha: [] }, halfLife: '31.55 years', decayConstant: '0.0219 year⁻¹', specificActivity: '2.07 x 10^12 Bq/g', parent: 'Lead-207 (p,n)', daughter: 'Lead-207 (stable)', commonUses: ['Calibration sources', 'Environmental tracer'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived isotope used for specialized gamma calibration, but not in routine use.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Bismuth-209', symbol: 'Bi-209', emissionType: ['Alpha'], emissionEnergies: { alpha: ['3.137 MeV'], beta: [], gamma: [] }, halfLife: '2.01 x 10¹⁹ years', decayConstant: '3.45 x 10⁻²⁰ year⁻¹', specificActivity: '0.001 Bq/g', parent: 'Primordial', daughter: 'Thallium-205 (stable)', commonUses: ['Considered stable for most practical purposes', 'Recently discovered to be radioactive'], category: 'Natural', commonality: 'Common', commonalityReason: 'The most abundant isotope of bismuth, long considered stable, with an extremely long half-life.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Bismuth-210', emissionType: ['Beta-minus', 'Alpha'], symbol: 'Bi-210', emissionEnergies: { beta: ['1.16 MeV (max)'], alpha: ['5.03 MeV'], gamma: [] }, avgBetaEnergy: '0.387 MeV', halfLife: '5.012 days', decayConstant: '0.138 day⁻¹', specificActivity: '9.6 x 10^15 Bq/g', parent: 'Lead-210', daughter: 'Polonium-210 (β-) or Thallium-206 (α)', commonUses: ['Intermediate in U-238 decay chain', 'Used in disequilibrium studies with Pb-210'], category: 'Natural', decaySeriesId: 'U-238-series', commonality: 'Moderate', commonalityReason: 'A key intermediate in the U-238 decay series, the daughter of the common environmental nuclide Pb-210.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.2, unit: 'TBq' } },
    { name: 'Bismuth-211', emissionType: ['Alpha', 'Beta-minus', 'Gamma'], symbol: 'Bi-211', emissionEnergies: { alpha: ['6.623 MeV'], beta: ['0.579 MeV (max)'], gamma: ['0.351 MeV'] }, avgBetaEnergy: '0.193 MeV', halfLife: '2.14 minutes', decayConstant: '0.324 min⁻¹', specificActivity: '3.4 x 10^18 Bq/g', parent: 'Lead-211', daughter: 'Thallium-207 (α) or Polonium-211 (β-)', commonUses: ['Intermediate in Actinium-227 decay series'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A very short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Bismuth-212', emissionType: ['Beta-minus', 'Alpha', 'Gamma'], symbol: 'Bi-212', emissionEnergies: { beta: ['2.25 MeV (max)'], alpha: ['6.09 MeV'], gamma: ['0.727 MeV', '1.621 MeV'] }, avgBetaEnergy: '0.750 MeV', halfLife: '60.55 minutes', decayConstant: '0.0114 min⁻¹', specificActivity: '1.2 x 10^17 Bq/g', parent: 'Lead-212', daughter: 'Polonium-212 (β-) or Thallium-208 (α)', commonUses: ['Research in targeted alpha/beta therapy'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A short-lived nuclide in the Th-232 decay series, notable for its high-energy gamma daughter (Tl-208).', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Bismuth-213', emissionType: ['Beta-minus', 'Alpha', 'Gamma'], symbol: 'Bi-213', emissionEnergies: { beta: ['1.42 MeV (max)'], alpha: ['5.87 MeV'], gamma: ['0.440 MeV'] }, avgBetaEnergy: '0.473 MeV', halfLife: '45.6 minutes', decayConstant: '0.0152 min⁻¹', specificActivity: '1.09 x 10^17 Bq/g', parent: 'Actinium-225', daughter: 'Polonium-213 (β) or Thallium-209 (α)', commonUses: ['Targeted Alpha Therapy (TAT) for various cancers.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A short-lived daughter of Ac-225, used in targeted alpha therapy research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.8, A2: 0.6, unit: 'TBq' } },
    { name: 'Bismuth-214', emissionType: ['Beta-minus', 'Alpha', 'Gamma'], symbol: 'Bi-214', emissionEnergies: { beta: ['3.27 MeV (max)'], gamma: ['0.609 MeV', '1.120 MeV', '1.764 MeV'], alpha: ['5.62 MeV'] }, avgBetaEnergy: '1.090 MeV', halfLife: '19.9 minutes', decayConstant: '0.0348 min⁻¹', specificActivity: '3.6 x 10^17 Bq/g', parent: 'Lead-214', daughter: 'Polonium-214 (β-) / Thallium-210 (α)', commonUses: ['Source of natural background gamma radiation (from Radon decay products)'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A prominent gamma-emitter in the Radon-222 decay chain, contributing to natural background radiation.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.2, unit: 'TBq' } },
    { name: 'Bromine-77', symbol: 'Br-77', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.239 MeV', '0.297 MeV'], alpha: [] }, halfLife: '57.04 hours', decayConstant: '0.0121 hour⁻¹', specificActivity: '1.2 x 10^16 Bq/g', parent: 'Krypton-77', daughter: 'Selenium-77 (stable)', commonUses: ['PET imaging research', 'Antibody labeling'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used for specialized medical research applications like antibody labeling.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 3, A2: 3, unit: 'TBq' } },
    { name: 'Bromine-82', symbol: 'Br-82', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.444 MeV (max)'], gamma: ['0.777 MeV', '1.044 MeV'], alpha: [] }, avgBetaEnergy: '0.148 MeV', halfLife: '35.3 hours', decayConstant: '0.0196 hour⁻¹', specificActivity: '1.6 x 10^16 Bq/g', parent: 'Selenium-82', daughter: 'Krypton-82 (stable)', commonUses: ['Hydrological tracing', 'Flow measurements in pipelines', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A gamma-emitting tracer used for specialized industrial and hydrological studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.4, unit: 'TBq' } },
    { name: 'Cadmium-109', symbol: 'Cd-109', emissionType: ['Electron Capture', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.088 MeV (γ)'], alpha: [] }, halfLife: '461.4 days', decayConstant: '0.00150 day⁻¹', specificActivity: '1.2 x 10^14 Bq/g', parent: 'Indium-109', daughter: 'Silver-109 (stable)', commonUses: ['X-ray fluorescence', 'Calibration source'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A common source for X-ray fluorescence (XRF) analyzers and instrument calibration.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 2, unit: 'TBq' } },
    { name: 'Cadmium-115m', symbol: 'Cd-115m', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.62 MeV (max)'], gamma: ['0.934 MeV'], alpha: [] }, avgBetaEnergy: '0.540 MeV', halfLife: '44.6 days', decayConstant: '0.0155 day⁻¹', specificActivity: '1.3 x 10^15 Bq/g', parent: 'Silver-115', daughter: 'Indium-115', commonUses: ['Fission product', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fission product with limited use outside of specific research applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.7, A2: 0.5, unit: 'TBq' } },
    { name: 'Calcium-45', symbol: 'Ca-45', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.257 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.086 MeV', halfLife: '162.6 days', decayConstant: '0.00426 day⁻¹', specificActivity: '6.4 x 10^14 Bq/g', parent: 'Potassium-45', daughter: 'Scandium-45 (stable)', commonUses: ['Bone metabolism studies', 'Agricultural research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A pure beta-emitter used as a tracer in specialized biological and agricultural research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 1, unit: 'TBq' } },
    { name: 'Calcium-47', symbol: 'Ca-47', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.694 MeV (max)'], gamma: ['1.297 MeV'], alpha: [] }, avgBetaEnergy: '0.231 MeV', daughterEmissions: { from: 'Sc-47', beta: ['0.601 MeV (max)'], gamma: ['0.159 MeV'] }, halfLife: '4.536 days', decayConstant: '0.153 day⁻¹', specificActivity: '2.07 x 10^16 Bq/g', parent: 'Potassium-47', daughter: 'Scandium-47', commonUses: ['Bone metabolism research (historical)', 'Medical studies'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Largely replaced by other isotopes for medical studies, now used only in limited research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.3, unit: 'TBq' } },
    { name: 'Californium-252', symbol: 'Cf-252', emissionType: ['Alpha', 'Spontaneous Fission', 'Neutron', 'Gamma'], emissionEnergies: { alpha: ['6.118 MeV'], beta: [], gamma: ['~0.1-6 MeV (complex spectrum from fission)'] }, halfLife: '2.645 years', decayConstant: '0.262 year⁻¹', specificActivity: '2.0 x 10^13 Bq/g', parent: 'Curium-252', daughter: 'Curium-248 (α), Fission products', commonUses: ['Neutron source (neutron activation analysis)', 'Tumor treatment', 'Reactor startup', 'Well logging'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A powerful and widely used spontaneous fission neutron source for various industrial and medical applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.2, A2: 0.001, unit: 'TBq' } },
    { name: 'Carbon-11', symbol: 'C-11', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['0.960 MeV (max)'], gamma: ['0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.320 MeV', halfLife: '20.36 minutes', decayConstant: '0.0340 min⁻¹', specificActivity: '1.9 x 10^18 Bq/g', parent: 'Boron-11 (p,n)', daughter: 'Boron-11 (stable)', commonUses: ['PET imaging for various tracers (e.g., methionine for tumors)'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' } },
    { name: 'Carbon-14', symbol: 'C-14', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.156 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.052 MeV', halfLife: '5730 years', decayConstant: '1.21 x 10⁻⁴ year⁻¹', specificActivity: '1.65 x 10^11 Bq/g', parent: 'Nitrogen-14 (n,p)', daughter: 'Nitrogen-14 (stable)', commonUses: ['Radiometric dating (archeology, geology)', 'Tracers in biological and chemical research', 'Labeled compounds'], category: 'Industrial', commonality: 'Common', commonalityReason: 'Famously used for radiocarbon dating and as a tracer in countless biological and chemical research labs.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 3, unit: 'TBq' } },
    { name: 'Cerium-141', symbol: 'Ce-141', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.581 MeV (max)'], gamma: ['0.145 MeV'], alpha: [] }, avgBetaEnergy: '0.194 MeV', halfLife: '32.5 days', decayConstant: '0.0213 day⁻¹', specificActivity: '1.09 x 10^15 Bq/g', parent: 'Lanthanum-141', daughter: 'Praseodymium-141 (stable)', commonUses: ['Fission product', 'Medical research (historical)', 'Environmental tracer'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fission product with limited use outside of specialized research applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.7, unit: 'TBq' } },
    { name: 'Cerium-144', symbol: 'Ce-144', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.319 MeV (max)'], gamma: ['0.133 MeV'], alpha: [] }, avgBetaEnergy: '0.106 MeV', daughterEmissions: { from: 'Pr-144', beta: ['2.997 MeV (max)'] }, halfLife: '284.9 days', decayConstant: '0.00243 day⁻¹', specificActivity: '1.18 x 10^14 Bq/g', parent: 'Lanthanum-144', daughter: 'Praseodymium-144 (β-)', commonUses: ['Fission product', 'Environmental tracer'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fission product with limited use outside of specialized research applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Cesium-134', symbol: 'Cs-134', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.658 MeV (max)'], gamma: ['0.605 MeV', '0.796 MeV'], alpha: [] }, avgBetaEnergy: '0.219 MeV', halfLife: '2.065 years', decayConstant: '0.335 year⁻¹', specificActivity: '4.8 x 10^13 Bq/g', parent: 'Cesium-133 (n,γ)', daughter: 'Barium-134 (stable)', commonUses: ['Environmental tracer (fallout)', 'Calibration sources'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'An activation product often seen alongside Cs-137 after reactor incidents, used as a tracer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.7, A2: 0.6, unit: 'TBq' } },
    { name: 'Cesium-137', symbol: 'Cs-137', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.512 MeV (max)', '1.174 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.171 MeV', daughterEmissions: { from: 'Ba-137m', gamma: ['0.662 MeV'] }, halfLife: '30.08 years', decayConstant: '0.0230 year⁻¹', gammaConstant: '0.33 R·m²/hr·Ci', specificActivity: '3.21 x 10^12 Bq/g', parent: 'Uranium Fission', daughter: 'Barium-137m (IT) -> Barium-137 (stable)', commonUses: ['Calibration sources', 'Industrial gauges (density, level)', 'Blood irradiators', 'Radiotherapy (historical)'], category: 'Industrial', commonality: 'Common', commonalityReason: 'A major fission product and one of the most common gamma sources for industrial gauging and calibration.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 2, A2: 0.6, unit: 'TBq' } },
    { name: 'Cobalt-60', symbol: 'Co-60', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.318 MeV (max)'], gamma: ['1.173 MeV', '1.332 MeV'], alpha: [] }, avgBetaEnergy: '0.106 MeV', halfLife: '5.27 years', decayConstant: '0.131 year⁻¹', gammaConstant: '1.32 R·m²/hr·Ci', specificActivity: '4.18 x 10^13 Bq/g', parent: 'Cobalt-59 (n,γ)', daughter: 'Nickel-60 (stable)', commonUses: ['Industrial radiography', 'Sterilization of medical equipment and food', 'Radiotherapy (external beam)', 'Tracers'], category: 'Industrial', commonality: 'Common', commonalityReason: 'Widely used for industrial radiography, medical equipment sterilization, and cancer therapy.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 0.4, A2: 0.4, unit: 'TBq' } },
    { name: 'Copper-64', symbol: 'Cu-64', emissionType: ['Positron Emission', 'Beta-minus', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['0.653 MeV (β+ max)', '0.579 MeV (β- max)'], gamma: ['1.345 MeV', '0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.193 MeV (β-)', halfLife: '12.7 hours', decayConstant: '0.0546 hour⁻¹', specificActivity: '1.74 x 10^17 Bq/g', parent: 'Nickel-64 (p,n)', daughter: 'Nickel-64 (stable) or Zinc-64 (stable)', commonUses: ['PET imaging (various applications)', 'Targeted radionuclide therapy research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A versatile medical isotope for PET imaging and therapy research, but not as widespread as F-18.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 5, A2: 1, unit: 'TBq' } },
    { name: 'Copper-67', symbol: 'Cu-67', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.576 MeV (max)'], gamma: ['0.185 MeV'], alpha: [] }, avgBetaEnergy: '0.192 MeV', halfLife: '61.83 hours', decayConstant: '0.0112 hour⁻¹', specificActivity: '1.2 x 10^16 Bq/g', parent: 'Zinc-67 (n,p)', daughter: 'Zinc-67 (stable)', commonUses: ['Radioimmunotherapy, theranostic partner for Copper-64 PET imaging.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A research isotope for targeted therapy, valued as a "theranostic" partner to the PET isotope Cu-64.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.6, unit: 'TBq' } },
    { name: 'Curium-244', symbol: 'Cm-244', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.805 MeV'], gamma: ['0.043 MeV'], beta: [] }, halfLife: '18.1 years', decayConstant: '0.0383 year⁻¹', specificActivity: '3.0 x 10^12 Bq/g', parent: 'Americium-244 (β-)', daughter: 'Plutonium-240', commonUses: ['Alpha particle X-ray spectrometers (APXS) for space exploration', 'Neutron sources'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'Used in specialized applications like space exploration instruments due to its alpha emissions.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 0.002, unit: 'TBq' } },
    { name: 'Erbium-169', symbol: 'Er-169', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.341 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.114 MeV', halfLife: '9.4 days', decayConstant: '0.0737 day⁻¹', specificActivity: '5.2 x 10^14 Bq/g', parent: 'Erbium-168 (n,γ)', daughter: 'Thulium-169 (stable)', commonUses: ['Radiation synovectomy for arthritis treatment.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used for a specific medical therapy (radiation synovectomy) that is not widely performed.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 1, unit: 'TBq' } },
    { name: 'Europium-152', symbol: 'Eu-152', emissionType: ['Beta-minus', 'Electron Capture', 'Positron Emission', 'Gamma'], emissionEnergies: { beta: ['1.48 MeV (max)'], gamma: ['0.122 MeV', '1.408 MeV'], alpha: [] }, avgBetaEnergy: '0.493 MeV', halfLife: '13.54 years', decayConstant: '0.0512 year⁻¹', specificActivity: '6.4 x 10^12 Bq/g', parent: 'Samarium-152 (n,γ)', daughter: 'Samarium-152 (stable) or Gadolinium-152 (stable)', commonUses: ['Calibration sources for gamma spectroscopy', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived, multi-gamma emitting source excellent for calibration, but less common than Co-60 or Ba-133.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' }, gammaConstant: '0.744 R·m²/hr·Ci' },
    { name: 'Europium-154', symbol: 'Eu-154', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.85 MeV (max)'], gamma: ['1.274 MeV', '0.723 MeV'], alpha: [] }, avgBetaEnergy: '0.617 MeV', halfLife: '8.59 years', decayConstant: '0.0807 year⁻¹', specificActivity: '9.8 x 10^12 Bq/g', parent: 'Samarium-154 (n,γ)', daughter: 'Gadolinium-154 (stable)', commonUses: ['Environmental monitoring (fission product)', 'Calibration sources'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived fission product sometimes used for gamma calibration.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.9, A2: 0.6, unit: 'TBq' }, gammaConstant: '0.756 R·m²/hr·Ci' },
    { name: 'Fluorine-18', symbol: 'F-18', emissionType: ['Positron Emission'], emissionEnergies: { beta: ['0.6335 MeV (max)'], gamma: ['0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.211 MeV', halfLife: '109.7 minutes', decayConstant: '0.00632 min⁻¹', specificActivity: '3.5 x 10^18 Bq/g', parent: 'Oxygen-18 (p,n)', daughter: 'Oxygen-18 (stable)', commonUses: ['PET imaging (Positron Emission Tomography)', 'Most common PET radioisotope, particularly for FDG (Fluorodeoxyglucose) scans'], category: 'Medical', commonality: 'Common', commonalityReason: 'The most widely used radioisotope for PET scans, especially when labeled to FDG for cancer imaging.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' } },
    { name: 'Fluorine-19', symbol: 'F-19', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Stable', daughter: 'Stable', commonUses: ['NMR', 'Fluorinated compounds (not a radionuclide use)'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Gadolinium-153', symbol: 'Gd-153', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.097 MeV', '0.103 MeV'], alpha: [] }, halfLife: '240.4 days', decayConstant: '0.00288 day⁻¹', specificActivity: '1.3 x 10^14 Bq/g', parent: 'Europium-153 (n,γ)', daughter: 'Europium-153 (stable)', commonUses: ['Bone densitometry', 'X-ray absorption measurements', 'Calibration sources'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A key source used in dual-photon absorptiometry for bone density scanning.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 9, unit: 'TBq' }, gammaConstant: '0.11 R·m²/hr·Ci' },
    { name: 'Gadolinium-159', symbol: 'Gd-159', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.970 MeV (max)'], gamma: ['0.363 MeV'], alpha: [] }, avgBetaEnergy: '0.323 MeV', halfLife: '18.48 hours', decayConstant: '0.0375 hour⁻¹', specificActivity: '3.6 x 10^16 Bq/g', parent: 'Europium-159', daughter: 'Terbium-159 (stable)', commonUses: ['Boron Neutron Capture Therapy (BNCT) research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A short-lived isotope used in specialized medical therapy research (BNCT).', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.3, unit: 'TBq' } },
    { name: 'Gallium-67', symbol: 'Ga-67', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.093 MeV', '0.185 MeV', '0.300 MeV'], alpha: [] }, halfLife: '3.26 days', decayConstant: '0.213 day⁻¹', specificActivity: '3.8 x 10^15 Bq/g', parent: 'Zinc-67 (p,n)', daughter: 'Zinc-67 (stable)', commonUses: ['Tumor imaging (lymphomas, lung cancer)', 'Infection imaging', 'Inflammation imaging'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A standard SPECT imaging agent for detecting tumors and inflammation.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 7, A2: 3, unit: 'TBq' } },
    { name: 'Gallium-68', symbol: 'Ga-68', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['1.90 MeV (max)'], gamma: ['0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.633 MeV', halfLife: '67.71 minutes', decayConstant: '0.0102 min⁻¹', specificActivity: '1.45 x 10^17 Bq/g', parent: 'Germanium-68', daughter: 'Zinc-68 (stable)', commonUses: ['PET imaging, especially with DOTATATE/DOTATOC for neuroendocrine tumors'], category: 'Medical', commonality: 'Common', commonalityReason: 'A major PET imaging isotope, especially for neuroendocrine tumors, often produced from a Ge-68 generator.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.5, unit: 'TBq' } },
    { name: 'Germanium-68', symbol: 'Ge-68', emissionType: ['Electron Capture', 'X-ray'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, daughterEmissions: { from: 'Ga-68', beta: ['1.90 MeV (max)'], gamma: ['0.511 MeV (annihilation)'] }, halfLife: '270.95 days', decayConstant: '0.00256 day⁻¹', specificActivity: '2.8 x 10^14 Bq/g', parent: 'Arsenic-68', daughter: 'Gallium-68 (EC, β+)', commonUses: ['Generator for Ga-68 (PET imaging)'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'The long-lived parent used in generators to produce the short-lived PET isotope Ga-68.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Gold-195m', symbol: 'Au-195m', emissionType: ['Isomeric Transition', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.262 MeV'], alpha: [] }, halfLife: '30.5 seconds', decayConstant: '0.0227 s⁻¹', specificActivity: '1.5 x 10^18 Bq/g', parent: 'Mercury-195m', daughter: 'Gold-195', commonUses: ['Cardiac blood flow imaging (historical)'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used historically in medicine but has been replaced by other isotopes.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 10, unit: 'TBq' } },
    { name: 'Gold-198', symbol: 'Au-198', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.961 MeV (max)'], gamma: ['0.412 MeV'], alpha: [] }, avgBetaEnergy: '0.320 MeV', halfLife: '2.695 days', decayConstant: '0.257 day⁻¹', specificActivity: '9.3 x 10^15 Bq/g', parent: 'Gold-197 (n,γ)', daughter: 'Mercury-198 (stable)', commonUses: ['Radiotherapy (brachytherapy)', 'Tracers', 'Industrial applications'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'Used in specific brachytherapy applications and as an industrial tracer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' }, gammaConstant: '0.23 R·m²/hr·Ci' },
    { name: 'Holmium-166', symbol: 'Ho-166', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.854 MeV (max)'], gamma: ['0.080 MeV'], alpha: [] }, avgBetaEnergy: '0.618 MeV', halfLife: '26.8 hours', decayConstant: '0.0258 hour⁻¹', specificActivity: '2.5 x 10^16 Bq/g', parent: 'Holmium-165 (n,γ)', daughter: 'Erbium-166 (stable)', commonUses: ['Radiotherapy for liver tumors, bone pain palliation, radiosynovectomy.'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A therapeutic isotope used for treating liver tumors and for bone pain palliation.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.3, unit: 'TBq' } },
    { name: 'Indium-111', symbol: 'In-111', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.171 MeV', '0.245 MeV'], alpha: [] }, halfLife: '2.80 days', decayConstant: '0.247 day⁻¹', specificActivity: '2.6 x 10^16 Bq/g', parent: 'Cadmium-111 (p,n)', daughter: 'Cadmium-111 (stable)', commonUses: ['White blood cell labeling (infection imaging)', 'Tumor imaging', 'CSF flow studies'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A standard SPECT imaging agent, particularly for labeling white blood cells to find infections.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 3, A2: 3, unit: 'TBq' } },
    { name: 'Indium-113m', symbol: 'In-113m', emissionType: ['Isomeric Transition', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.392 MeV'], alpha: [] }, halfLife: '1.658 hours', decayConstant: '0.418 hour⁻¹', specificActivity: '4.1 x 10^17 Bq/g', parent: 'Tin-113', daughter: 'Indium-113 (stable)', commonUses: ['Medical diagnostic imaging (historical)'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used historically in medicine but has been replaced by other isotopes like Tc-99m.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 4, A2: 2, unit: 'TBq' } },
    { name: 'Indium-115', symbol: 'In-115', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.499 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.166 MeV', halfLife: '4.41 x 10¹⁴ years', decayConstant: '1.57 x 10⁻¹⁵ year⁻¹', specificActivity: '2.6 x 10^2 Bq/g', parent: 'Primordial', daughter: 'Tin-115 (stable)', commonUses: ['Neutrino mass experiments', 'Research (extremely weak activity)'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A primordial isotope with an extremely long half-life, used in fundamental physics research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 1, unit: 'TBq' } },
    { name: 'Iodine-123', symbol: 'I-123', emissionType: ['Electron Capture', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.159 MeV'], alpha: [] }, halfLife: '13.22 hours', decayConstant: '0.0524 hour⁻¹', specificActivity: '7.4 x 10^16 Bq/g', parent: 'Xenon-123', daughter: 'Tellurium-123 (stable)', commonUses: ['SPECT imaging for thyroid function and tumors', 'Cardiac and neurological imaging'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'An ideal isotope for thyroid imaging (SPECT) due to its short half-life and clean gamma emission.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 6, A2: 3, unit: 'TBq' } },
    { name: 'Iodine-125', symbol: 'I-125', emissionType: ['Electron Capture', 'X-ray', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.0355 MeV'], alpha: [] }, halfLife: '59.4 days', decayConstant: '0.0117 day⁻¹', specificActivity: '6.4 x 10^14 Bq/g', parent: 'Xenon-125', daughter: 'Tellurium-125 (stable)', commonUses: ['Brachytherapy (prostate cancer)', 'Radioimmunoassay', 'Bone mineral density (historical)'], category: 'Medical', commonality: 'Common', commonalityReason: 'Widely used in permanent brachytherapy seeds for prostate cancer and in laboratory radioimmunoassays.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 20, A2: 3, unit: 'TBq' }, gammaConstant: '0.07 R·m²/hr·Ci' },
    { name: 'Iodine-129', symbol: 'I-129', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.154 MeV (max)'], gamma: ['0.039 MeV'], alpha: [] }, avgBetaEnergy: '0.051 MeV', halfLife: '16.1 million years', decayConstant: '4.31 x 10⁻⁸ year⁻¹', specificActivity: '6.54 x 10^6 Bq/g', parent: 'Tellurium-129 (β-)', daughter: 'Xenon-129 (stable)', commonUses: ['Environmental tracer (long-lived fission product)', 'Geological dating'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'An extremely long-lived fission product used as a tracer in environmental and geological studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Iodine-131', symbol: 'I-131', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.606 MeV (max)'], gamma: ['0.364 MeV (dominant)'], alpha: [] }, avgBetaEnergy: '0.202 MeV', halfLife: '8.02 days', decayConstant: '0.0864 day⁻¹', gammaConstant: '0.22 R·m²/hr·Ci', specificActivity: '4.6 x 10^15 Bq/g', parent: 'Tellurium-131', daughter: 'Xenon-131 (stable)', commonUses: ['Diagnosis and treatment of thyroid cancer and hyperthyroidism', 'Medical imaging (diagnostic tracer)'], category: 'Medical', commonality: 'Common', commonalityReason: 'A key radioisotope for the diagnosis and, at higher activities, the treatment of thyroid conditions.', sourceRef: { halfLife: 'nndc', decayConstant: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 3, A2: 0.7, unit: 'TBq' } },
    { name: 'Iridium-192', symbol: 'Ir-192', emissionType: ['Beta-minus', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['0.672 MeV (max)'], gamma: ['0.317 MeV', '0.468 MeV'], alpha: [] }, avgBetaEnergy: '0.224 MeV', halfLife: '73.83 days', decayConstant: '0.00939 day⁻¹', gammaConstant: '0.48 R·m²/hr·Ci', specificActivity: '3.41 x 10^14 Bq/g', parent: 'Iridium-191 (n,γ)', daughter: 'Platinum-192 (stable) / Osmium-192 (stable)', commonUses: ['High-dose-rate (HDR) brachytherapy', 'Industrial gamma radiography'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A primary source for industrial radiography and high-dose-rate (HDR) brachytherapy cancer treatment.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 1, A2: 0.5, unit: 'TBq' } },
    { name: 'Iron-52', symbol: 'Fe-52', emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['0.804 MeV (max)'], gamma: ['0.169 MeV'], alpha: [] }, avgBetaEnergy: '0.268 MeV', halfLife: '8.275 hours', decayConstant: '0.0838 hour⁻¹', specificActivity: '1.2 x 10^17 Bq/g', parent: 'Manganese-52m', daughter: 'Manganese-52', commonUses: ['PET imaging research (bone marrow imaging, iron metabolism)'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A short-lived PET isotope used in specialized research to study iron metabolism and bone marrow.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.3, unit: 'TBq' } },
    { name: 'Iron-55', symbol: 'Fe-55', emissionType: ['Electron Capture', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.0059 MeV (X-ray)'], alpha: [] }, halfLife: '2.73 years', decayConstant: '0.254 year⁻¹', specificActivity: '8.4 x 10^13 Bq/g', parent: 'Manganese-55 (p,n)', daughter: 'Manganese-55 (stable)', commonUses: ['X-ray fluorescence sources', 'Electron capture detectors', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'Used as a low-energy X-ray source for analytical techniques like X-ray fluorescence.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Iron-59', symbol: 'Fe-59', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.475 MeV (max)'], gamma: ['1.099 MeV', '1.292 MeV'], alpha: [] }, avgBetaEnergy: '0.158 MeV', halfLife: '44.5 days', decayConstant: '0.0156 day⁻¹', specificActivity: '1.87 x 10^15 Bq/g', parent: 'Iron-58 (n,γ)', daughter: 'Cobalt-59 (stable)', commonUses: ['Red blood cell studies', 'Iron metabolism research', 'Industrial tracers'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A gamma-emitting tracer used in medical research to study iron metabolism and red blood cells.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.9, A2: 0.9, unit: 'TBq' } },
    { name: 'Krypton-79', symbol: 'Kr-79', emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['0.604 MeV (max)'], gamma: ['0.261 MeV', '0.398 MeV'], alpha: [] }, avgBetaEnergy: '0.201 MeV', halfLife: '35.04 hours', decayConstant: '0.0198 hour⁻¹', specificActivity: '1.7 x 10^16 Bq/g', parent: 'Bromine-79', daughter: 'Bromine-79 (stable)', commonUses: ['Lung ventilation studies (PET)', 'Research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used in medical research, particularly for PET-based lung ventilation studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 2, unit: 'TBq' } },
    { name: 'Krypton-81m', symbol: 'Kr-81m', emissionType: ['Gamma', 'Isomeric Transition'], emissionEnergies: { beta: [], gamma: ['0.190 MeV'], alpha: [] }, halfLife: '13.1 seconds', decayConstant: '0.0529 s⁻¹', specificActivity: '4.85 x 10^18 Bq/g', parent: 'Rubidium-81', daughter: 'Krypton-81', commonUses: ['Lung ventilation studies (very short half-life allows for repeated scans)'], category: 'Medical', commonality: 'Common', commonalityReason: 'A very short-lived gas used for lung ventilation scans, typically produced from a Rb-81 generator.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Krypton-85', symbol: 'Kr-85', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.687 MeV (max)'], gamma: ['0.514 MeV'], alpha: [] }, avgBetaEnergy: '0.229 MeV', halfLife: '10.76 years', decayConstant: '0.0644 year⁻¹', specificActivity: '1.45 x 10^13 Bq/g', parent: 'Uranium Fission', daughter: 'Rubidium-85 (stable)', commonUses: ['Atmospheric tracer', 'Industrial applications (leak detection, gauging)'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A fission product gas used in industrial applications like leak detection and thickness gauging.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 10, unit: 'TBq' } },
    { name: 'Lanthanum-140', symbol: 'La-140', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.68 MeV (max)'], gamma: ['1.596 MeV', '0.816 MeV', '0.487 MeV'], alpha: [] }, avgBetaEnergy: '0.560 MeV', halfLife: '1.678 days', decayConstant: '0.413 day⁻¹', specificActivity: '2.07 x 10^16 Bq/g', parent: 'Barium-140', daughter: 'Cerium-140 (stable)', commonUses: ['Fission product', 'Research tracer'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A short-lived fission product used as a tracer in research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.7, A2: 0.4, unit: 'TBq' } },
    { name: 'Lead-206', symbol: 'Pb-206', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Polonium-210', daughter: 'Stable', commonUses: ['Final stable product of U-238 decay series', 'Geological dating'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Lead-207', symbol: 'Pb-207', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Polonium-211', daughter: 'Stable', commonUses: ['Final stable product of U-235 decay series', 'Geological dating'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Lead-208', symbol: 'Pb-208', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Thallium-208', daughter: 'Stable', commonUses: ['Final stable product of Th-232 decay series', 'Geological dating'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Lead-210', symbol: 'Pb-210', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.063 MeV (max)'], gamma: ['0.0465 MeV'], alpha: [] }, avgBetaEnergy: '0.021 MeV', daughterEmissions: { from: 'Bi-210', beta: ['1.16 MeV (max)'] }, halfLife: '22.23 years', decayConstant: '0.0312 year⁻¹', specificActivity: '2.8 x 10^12 Bq/g', parent: 'Polonium-214 (α)', daughter: 'Bismuth-210 (β-)', commonUses: ['Environmental tracers', 'Dating sediments and ice cores', 'Bone dosimetry'], category: 'Natural', commonality: 'Common', commonalityReason: 'A naturally occurring radionuclide from the U-238 series, widely used for dating recent sediments and ice cores.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.05, unit: 'TBq' } },
    { name: 'Lead-211', symbol: 'Pb-211', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.36 MeV (max)'], gamma: ['0.405 MeV'], alpha: [] }, avgBetaEnergy: '0.453 MeV', halfLife: '36.1 minutes', decayConstant: '0.0192 min⁻¹', specificActivity: '2.0 x 10^17 Bq/g', parent: 'Polonium-215', daughter: 'Bismuth-211 (β-)', commonUses: ['Intermediate in Actinium-227 decay series'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A very short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Lead-212', symbol: 'Pb-212', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.570 MeV (max)'], gamma: ['0.238 MeV', '0.300 MeV'], alpha: [] }, avgBetaEnergy: '0.190 MeV', daughterEmissions: { from: 'Bi-212', beta: ['2.25 MeV (max)'], alpha: ['6.09 MeV'], gamma: ['0.727 MeV', '1.621 MeV'] }, halfLife: '10.64 hours', decayConstant: '0.0651 hour⁻¹', specificActivity: '6.9 x 10^16 Bq/g', parent: 'Polonium-216 (α)', daughter: 'Bismuth-212 (β-)', commonUses: ['Intermediate in Thorium-232 decay series', 'Research'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A key intermediate in the Th-232 decay chain with a relatively long half-life compared to its daughters.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Lead-214', symbol: 'Pb-214', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.02 MeV (max)'], gamma: ['0.295 MeV', '0.352 MeV'], alpha: [] }, avgBetaEnergy: '0.340 MeV', halfLife: '26.8 minutes', decayConstant: '0.0259 min⁻¹', specificActivity: '2.7 x 10^17 Bq/g', parent: 'Polonium-218 (α)', daughter: 'Bismuth-214 (β-)', commonUses: ['Intermediate in Radon-222 decay chain', 'Environmental monitoring'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A prominent gamma-emitter in the Radon-222 decay chain, contributing to natural background radiation.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Lutetium-176', symbol: 'Lu-176', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.593 MeV (max)'], gamma: ['0.202 MeV', '0.307 MeV'], alpha: [] }, avgBetaEnergy: '0.198 MeV', halfLife: '3.78 x 10¹⁰ years', decayConstant: '1.83 x 10⁻¹¹ year⁻¹', specificActivity: '2.0 x 10^6 Bq/g', parent: 'Primordial', daughter: 'Hafnium-176 (stable)', commonUses: ['Lutetium-Hafnium dating (geological)', 'Research'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A very long-lived primordial nuclide used for geological dating.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 0.7, unit: 'TBq' } },
    { name: 'Lutetium-177', symbol: 'Lu-177', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.498 MeV (max)'], gamma: ['0.113 MeV', '0.208 MeV'], alpha: [] }, avgBetaEnergy: '0.166 MeV', halfLife: '6.647 days', decayConstant: '0.104 day⁻¹', specificActivity: '3.9 x 10^14 Bq/g', parent: 'Ytterbium-176 (n,γ)', daughter: 'Hafnium-177 (stable)', commonUses: ['Peptide receptor radionuclide therapy (PRRT) for neuroendocrine tumors'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A highly effective and increasingly common therapeutic isotope for treating neuroendocrine tumors (PRRT).', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 30, A2: 0.5, unit: 'TBq' } },
    { name: 'Manganese-54', symbol: 'Mn-54', emissionType: ['Electron Capture', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.835 MeV'], alpha: [] }, halfLife: '312.1 days', decayConstant: '0.00222 day⁻¹', gammaConstant: '0.47 R·m²/hr·Ci', specificActivity: '2.56 x 10^14 Bq/g', parent: 'Iron-54 (d,2n)', daughter: 'Chromium-54 (stable)', commonUses: ['Calibration sources', 'Environmental tracer'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A common activation product used as a calibration source and environmental tracer.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' } },
    { name: 'Molybdenum-99', symbol: 'Mo-99', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.214 MeV (max)'], gamma: ['0.739 MeV', '0.181 MeV'], alpha: [] }, avgBetaEnergy: '0.405 MeV', daughterEmissions: { from: 'Tc-99m', gamma: ['0.1405 MeV'] }, halfLife: '65.94 hours', decayConstant: '0.0105 hour⁻¹', specificActivity: '1.77 x 10^16 Bq/g', parent: 'Uranium-235 Fission', daughter: 'Technetium-99m', commonUses: ['Generator for Technetium-99m, the most widely used medical radioisotope.'], category: 'Medical', commonality: 'Common', commonalityReason: 'The parent isotope used in generators to produce Tc-99m, making it essential to nuclear medicine.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' }, gammaConstant: '0.07 R·m²/hr·Ci' },
    { name: 'Neptunium-237', symbol: 'Np-237', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.788 MeV'], beta: [], gamma: ['0.029 MeV', '0.086 MeV'] }, halfLife: '2.144 million years', decayConstant: '3.23 x 10⁻⁷ year⁻¹', specificActivity: '2.6 x 10^7 Bq/g', parent: 'Americium-241 (α)', daughter: 'Protactinium-233 (α)', commonUses: ['Intermediate in Neptunium series decay', 'Nuclear waste studies'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived transuranic isotope that is a major consideration in nuclear waste management.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.002, unit: 'TBq' } },
    { name: 'Nickel-56', symbol: 'Ni-56', emissionType: ['Electron Capture', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.158 MeV', '0.812 MeV'], alpha: [] }, halfLife: '6.075 days', decayConstant: '0.114 day⁻¹', specificActivity: '1.38 x 10^16 Bq/g', parent: 'Zinc-56', daughter: 'Cobalt-56', commonUses: ['Supernova studies (astrophysics)', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A short-lived isotope primarily of interest in astrophysical research related to supernovae.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Nickel-59', symbol: 'Ni-59', emissionType: ['Electron Capture', 'X-ray'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: '76,000 years', decayConstant: '9.12 x 10⁻⁶ year⁻¹', specificActivity: '1.03 x 10^9 Bq/g', parent: 'Copper-59', daughter: 'Cobalt-59 (stable)', commonUses: ['Neutron activation product (long-lived)', 'Geological dating (historical)', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A very long-lived activation product relevant in nuclear reactor decommissioning.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Nickel-63', symbol: 'Ni-63', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.0669 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.022 MeV', halfLife: '100.1 years', decayConstant: '0.00692 year⁻¹', specificActivity: '2.14 x 10^12 Bq/g', parent: 'Nickel-62 (n,γ)', daughter: 'Copper-63 (stable)', commonUses: ['Electron capture detectors (gas chromatography)', 'Beta-voltaic batteries'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A long-lived, low-energy beta emitter used in electron capture detectors for gas chromatographs.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 30, unit: 'TBq' } },
    { name: 'Niobium-95', symbol: 'Nb-95', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.160 MeV (max)'], gamma: ['0.766 MeV'], alpha: [] }, avgBetaEnergy: '0.053 MeV', halfLife: '34.99 days', decayConstant: '0.0198 day⁻¹', specificActivity: '1.6 x 10^15 Bq/g', parent: 'Zirconium-95', daughter: 'Molybdenum-95 (stable)', commonUses: ['Fission product', 'Environmental tracer (daughter of Zr-95)'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fission product usually found in equilibrium with its parent, Zr-95.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Nitrogen-13', symbol: 'N-13', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['1.20 MeV (max)'], gamma: ['0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.400 MeV', halfLife: '9.97 minutes', decayConstant: '0.0695 min⁻¹', specificActivity: '3.7 x 10^18 Bq/g', parent: 'Carbon-13 (p,n)', daughter: 'Carbon-13 (stable)', commonUses: ['Cardiac PET imaging for myocardial perfusion and viability'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' } },
    { name: 'Nitrogen-14', symbol: 'N-14', emissionType: ['Stable'], emissionEnergies: { alpha: [], beta: [], gamma: [] }, halfLife: 'Stable', decayConstant: '0', specificActivity: '0 Bq/g', parent: 'Carbon-14 (β-)', daughter: 'Stable', commonUses: ['Most abundant stable isotope of nitrogen', 'NMR spectroscopy', 'Target material for producing Carbon-14'], category: 'Stable/Reference', commonality: 'Common', commonalityReason: 'The most abundant stable isotope of nitrogen and the stable daughter of Carbon-14.', sourceRef: {} },
    { name: 'Oxygen-15', symbol: 'O-15', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['1.73 MeV (max)'], gamma: ['0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.577 MeV', halfLife: '122.2 seconds', decayConstant: '0.00567 s⁻¹', specificActivity: '3.3 x 10^18 Bq/g', parent: 'Nitrogen-15 (p,n)', daughter: 'Nitrogen-15 (stable)', commonUses: ['Brain blood flow', 'Oxygen metabolism PET imaging'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' } },
    { name: 'Palladium-103', symbol: 'Pd-103', emissionType: ['Electron Capture', 'X-ray', 'Gamma'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: '16.99 days', decayConstant: '0.0408 day⁻¹', specificActivity: '3.5 x 10^15 Bq/g', parent: 'Rhodium-103 (p,n)', daughter: 'Rhodium-103 (stable)', commonUses: ['Brachytherapy (prostate cancer)'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A key isotope, along with I-125, used in permanent brachytherapy seeds for prostate cancer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Phosphorus-32', symbol: 'P-32', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['1.710 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.570 MeV', halfLife: '14.26 days', decayConstant: '0.0486 day⁻¹', specificActivity: '1.07 x 10^16 Bq/g', parent: 'Sulfur-32 (n,p)', daughter: 'Sulfur-32 (stable)', commonUses: ['Molecular biology (DNA/RNA labeling)', 'Radiotherapy for polycythemia vera', 'Agricultural research'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A high-energy pure beta-emitter widely used in molecular biology labs and for some therapies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.3, unit: 'TBq' } },
    { name: 'Plutonium-238', symbol: 'Pu-238', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.499 MeV'], gamma: ['0.043 MeV'], beta: [] }, halfLife: '87.7 years', decayConstant: '0.00790 year⁻¹', specificActivity: '6.34 x 10^11 Bq/g', parent: 'Neptunium-237 (n,γ) -> Np-238 (β-)', daughter: 'Uranium-234', commonUses: ['Radioisotope thermoelectric generators (RTGs) for spacecraft and pacemakers'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'The primary power source for RTGs used in deep space missions and other remote applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Plutonium-239', symbol: 'Pu-239', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.157 MeV (dominant)'], beta: [], gamma: ['0.0516 MeV'] }, halfLife: '24,110 years', decayConstant: '2.87 x 10⁻⁵ year⁻¹', specificActivity: '2.3 x 10^9 Bq/g', parent: 'Uranium-238 (n,γ) -> ... -> Np-239 (β-)', daughter: 'Uranium-235 (α)', commonUses: ['Nuclear weapons', 'Nuclear fuel (MOX fuel)'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A primary fissile material used in nuclear weapons and as a component of MOX fuel.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Polonium-208', symbol: 'Po-208', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.115 MeV'], beta: [], gamma: ['0.134 MeV'] }, halfLife: '2.898 years', decayConstant: '0.239 year⁻¹', specificActivity: '1.6 x 10^13 Bq/g', parent: 'Bismuth-209 (p,2n)', daughter: 'Lead-204 (stable)', commonUses: ['Alpha calibration', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A synthetic alpha-emitter used for specialized research and calibration.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.01, unit: 'TBq' } },
    { name: 'Polonium-210', symbol: 'Po-210', emissionType: ['Alpha'], emissionEnergies: { alpha: ['5.304 MeV'], beta: [], gamma: [] }, halfLife: '138.376 days', decayConstant: '0.00501 day⁻¹', specificActivity: '1.66 x 10^14 Bq/g', parent: 'Bismuth-210 (β-)', daughter: 'Lead-206 (stable)', commonUses: ['Antistatic devices', 'Neutron sources', 'Research (alpha spectroscopy)'], category: 'Natural', commonality: 'Common', commonalityReason: 'A naturally occurring alpha-emitter (from Radon decay) used commercially in antistatic devices.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 0.02, unit: 'TBq' } },
    { name: 'Polonium-211', symbol: 'Po-211', emissionType: ['Alpha'], emissionEnergies: { alpha: ['7.45 MeV'], beta: [], gamma: [] }, halfLife: '0.516 seconds', decayConstant: '1.34 s⁻¹', specificActivity: '1.4 x 10^20 Bq/g', parent: 'Bismuth-211', daughter: 'Lead-207 (stable)', commonUses: ['Fastest alpha emitter in natural series', 'Research'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Polonium-212', symbol: 'Po-212', emissionType: ['Alpha'], emissionEnergies: { alpha: ['8.785 MeV'], beta: [], gamma: [] }, halfLife: '0.299 microseconds', decayConstant: '2.32 x 10⁶ s⁻¹', specificActivity: '2.5 x 10^22 Bq/g', parent: 'Bismuth-212 (β-)', daughter: 'Lead-208 (stable)', commonUses: ['Fastest alpha emitter in natural series', 'Research'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Polonium-214', symbol: 'Po-214', emissionType: ['Alpha'], emissionEnergies: { alpha: ['7.687 MeV'], beta: [], gamma: [] }, halfLife: '164.3 microseconds', decayConstant: '4218 s⁻¹', specificActivity: '4.4 x 10^21 Bq/g', parent: 'Bismuth-214', daughter: 'Lead-210 (α)', commonUses: ['Very short-lived intermediate in U-238 decay chain'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Polonium-215', symbol: 'Po-215', emissionType: ['Alpha', 'Beta-minus'], emissionEnergies: { alpha: ['7.386 MeV'], beta: ['0.71 MeV (max)'], gamma: [] }, avgBetaEnergy: '0.237 MeV', halfLife: '1.781 milliseconds', decayConstant: '389 s⁻¹', specificActivity: '2.5 x 10^21 Bq/g', parent: 'Radon-219', daughter: 'Lead-211 (α) or Astatine-215 (β-)', commonUses: ['Very short-lived intermediate in U-235 decay chain'], category: 'Natural', decaySeriesId: 'U-235-series', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Polonium-216', symbol: 'Po-216', emissionType: ['Alpha'], emissionEnergies: { alpha: ['6.778 MeV'], beta: [], gamma: [] }, halfLife: '0.145 seconds', decayConstant: '4.78 s⁻¹', specificActivity: '1.6 x 10^20 Bq/g', parent: 'Radon-220', daughter: 'Lead-212 (α)', commonUses: ['Very short-lived intermediate in Th-232 chain'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Polonium-218', emissionType: ['Alpha', 'Beta-minus'], symbol: 'Po-218', emissionEnergies: { alpha: ['6.002 MeV'], beta: ['0.26 MeV (max)'] }, avgBetaEnergy: '0.087 MeV', halfLife: '3.10 minutes', decayConstant: '0.224 min⁻¹', specificActivity: '2.3 x 10^18 Bq/g', parent: 'Radon-222', daughter: 'Lead-214 (α) or Astatine-218 (β-)', commonUses: ['Intermediate in U-238 decay chain'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A very short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Potassium-40', symbol: 'K-40', emissionType: ['Beta-minus', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['1.311 MeV (max)'], gamma: ['1.461 MeV'], alpha: [] }, avgBetaEnergy: '0.437 MeV', halfLife: '1.251 billion years', decayConstant: '5.54 x 10⁻¹⁰ year⁻¹', specificActivity: '2.6 x 10^5 Bq/g', parent: 'Primordial', daughter: 'Calcium-40 (β-) or Argon-40 (EC)', commonUses: ['Potassium-argon dating', 'Internal human radiation dose', 'Environmental monitoring'], category: 'Natural', commonality: 'Common', commonalityReason: 'A naturally occurring isotope found in soil, food (like bananas), and is a primary source of natural internal radiation dose in humans.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.9, A2: 0.9, unit: 'TBq' } },
    { name: 'Praseodymium-144', symbol: 'Pr-144', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['2.997 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.999 MeV', halfLife: '17.28 minutes', decayConstant: '0.0401 min⁻¹', specificActivity: '1.96 x 10^17 Bq/g', parent: 'Cerium-144', daughter: 'Neodymium-144 (stable)', commonUses: ['High-energy beta source (daughter of Ce-144)'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A very short-lived daughter of Ce-144, notable for its high-energy beta emission.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Promethium-147', symbol: 'Pm-147', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.224 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.075 MeV', halfLife: '2.623 years', decayConstant: '0.264 year⁻¹', specificActivity: '3.4 x 10^13 Bq/g', parent: 'Neodymium-147 (β-)', daughter: 'Samarium-147', commonUses: ['Atomic batteries (historical)', 'Luminous paints', 'Thickness gauges'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fission product used in specialized applications like luminous paints and thickness gauges.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 2, unit: 'TBq' } },
    { name: 'Protactinium-231', symbol: 'Pa-231', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.059 MeV'], beta: [], gamma: ['0.302 MeV', '0.283 MeV'] }, halfLife: '32,760 years', decayConstant: '2.11 x 10⁻⁵ year⁻¹', specificActivity: '1.75 x 10^9 Bq/g', parent: 'Thorium-231 (β-)', daughter: 'Actinium-227 (α)', commonUses: ['Intermediate in Actinium-227 decay series', 'Geological research'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A long-lived member of the U-235 decay series, used in geological dating.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 4, A2: 0.001, unit: 'TBq' } },
    { name: 'Protactinium-233', symbol: 'Pa-233', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.571 MeV (max)'], gamma: ['0.312 MeV'], alpha: [] }, avgBetaEnergy: '0.190 MeV', halfLife: '27.0 days', decayConstant: '0.0257 day⁻¹', specificActivity: '7.5 x 10^14 Bq/g', parent: 'Thorium-233 (β)', daughter: 'Uranium-233', commonUses: ['Intermediate in Th-232 to U-233 fuel cycle', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'An important intermediate in the process of breeding U-233 fuel from Thorium-232.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 5, A2: 0.7, unit: 'TBq' } },
    { name: 'Protactinium-234m', symbol: 'Pa-234m', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['2.29 MeV (max)'], gamma: ['1.001 MeV', '0.766 MeV'], alpha: [] }, avgBetaEnergy: '0.763 MeV', halfLife: '1.17 minutes', decayConstant: '0.592 min⁻¹', specificActivity: '1.7 x 10^19 Bq/g', parent: 'Thorium-234', daughter: 'Uranium-234 (β-)', commonUses: ['Intermediate in U-238 decay chain'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A very short-lived but commonly present intermediate in the U-238 decay series.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.3, A2: 0.3, unit: 'TBq' } },
    { name: 'Radium-220', symbol: 'Ra-220', emissionType: ['Alpha'], emissionEnergies: { alpha: ['6.818 MeV'], beta: [], gamma: [] }, halfLife: '27.4 seconds', decayConstant: '0.0253 s⁻¹', specificActivity: '1.8 x 10^18 Bq/g', parent: 'Thorium-224', daughter: 'Radon-216 (α)', commonUses: ['Intermediate in Thorium-232 decay series'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Radium-223', symbol: 'Ra-223', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.71 MeV (dominant)'], beta: [], gamma: ['0.269 MeV'] }, halfLife: '11.43 days', decayConstant: '0.0606 day⁻¹', specificActivity: '1.9 x 10^15 Bq/g', parent: 'Thorium-227', daughter: 'Radon-219 (α)', commonUses: ['Alpha-emitter for targeted alpha therapy (e.g., Xofigo for prostate cancer)'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A clinically approved alpha-emitter for treating bone metastases from prostate cancer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.9, A2: 0.005, unit: 'TBq' } },
    { name: 'Radium-224', symbol: 'Ra-224', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.685 MeV'], beta: [], gamma: ['0.241 MeV'] }, daughterEmissions: { from: 'Rn-220', alpha: ['6.288 MeV'] }, halfLife: '3.66 days', decayConstant: '0.189 day⁻¹', specificActivity: '5.9 x 10^15 Bq/g', parent: 'Thorium-228', daughter: 'Radon-220 (α)', commonUses: ['Intermediate in Thorium-232 decay series'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A short-lived alpha-emitter in the Th-232 decay series.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.02, unit: 'TBq' } },
    { name: 'Radium-226', symbol: 'Ra-226', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.784 MeV'], beta: [], gamma: ['0.186 MeV'] }, daughterEmissions: { from: 'Rn-222', alpha: ['5.490 MeV'] }, halfLife: '1600 years', decayConstant: '4.33 x 10⁻⁴ year⁻¹', gammaConstant: '0.825 R·m²/hr·Ci', specificActivity: '3.7 x 10^10 Bq/g', parent: 'Thorium-230', daughter: 'Radon-222 (α)', commonUses: ['Historical medical brachytherapy', 'Neutron sources (Ra-Be)', 'Luminescent paint (historical)', 'Calibration sources'], category: 'Natural', decaySeriesId: 'U-238-series', commonality: 'Common', commonalityReason: 'Historically significant for its use in medicine and luminous paint; the direct parent of Radon-222 gas.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 0.3, A2: 0.002, unit: 'TBq' } },
    { name: 'Radium-228', symbol: 'Ra-228', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.039 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.013 MeV', daughterEmissions: { from: 'Ac-228', beta: ['2.14 MeV (max)'], gamma: ['0.911 MeV', '0.969 MeV'] }, halfLife: '5.75 years', decayConstant: '0.120 year⁻¹', specificActivity: '8.1 x 10^12 Bq/g', parent: 'Thorium-232', daughter: 'Actinium-228 (β-)', commonUses: ['Intermediate in Thorium-232 decay chain', 'Environmental monitoring'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'The first daughter of Th-232, often monitored in environmental samples.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.6, A2: 0.2, unit: 'TBq' } },
    { name: 'Radon-219', symbol: 'Rn-219', emissionType: ['Alpha'], emissionEnergies: { alpha: ['6.819 MeV'], beta: [], gamma: [] }, halfLife: '3.96 seconds', decayConstant: '0.175 s⁻¹', specificActivity: '1.14 x 10^19 Bq/g', parent: 'Radium-223', daughter: 'Polonium-215 (α)', commonUses: ['Intermediate in Actinium-227 decay series'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An extremely short-lived noble gas intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Radon-220', symbol: 'Rn-220', emissionType: ['Alpha'], emissionEnergies: { alpha: ['6.288 MeV'], beta: [], gamma: [] }, halfLife: '55.6 seconds', decayConstant: '0.0125 s⁻¹', specificActivity: '8.1 x 10^17 Bq/g', parent: 'Radium-224', daughter: 'Polonium-216 (α)', commonUses: ['Environmental monitoring (thoron gas)', 'Research'], category: 'Natural', commonality: 'Common', commonalityReason: 'A naturally occurring noble gas (also called Thoron) from the Th-232 decay series.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Radon-221', symbol: 'Rn-221', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.19 MeV (max)'], gamma: ['0.078 MeV'], alpha: [] }, avgBetaEnergy: '0.397 MeV', halfLife: '25 minutes', decayConstant: '0.0277 min⁻¹', specificActivity: '1.8 x 10^17 Bq/g', parent: 'Francium-221', daughter: 'Francium-221', commonUses: ['Research (intermediate in artificial decay series)'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A short-lived intermediate in an artificial decay series with no practical applications.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Radon-222', symbol: 'Rn-222', emissionType: ['Alpha'], emissionEnergies: { alpha: ['5.490 MeV'], beta: [], gamma: [] }, halfLife: '3.823 days', decayConstant: '0.181 day⁻¹', specificActivity: '5.73 x 10^15 Bq/g', parent: 'Radium-226', daughter: 'Polonium-218 (α)', commonUses: ['Indoor air quality concern', 'Geological tracer', 'Research'], category: 'Natural', decaySeriesId: 'U-238-series', commonality: 'Common', commonalityReason: 'A naturally occurring noble gas from the U-238 series, well-known as an indoor air quality concern.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: null, A2: 0.1, unit: 'TBq' } },
    { name: 'Rhenium-186', symbol: 'Re-186', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.07 MeV (max)'], gamma: ['0.137 MeV'], alpha: [] }, avgBetaEnergy: '0.357 MeV', halfLife: '3.718 days', decayConstant: '0.186 day⁻¹', gammaConstant: '0.08 R·m²/hr·Ci', parent: 'Tungsten-186 (n,γ)', daughter: 'Osmium-186 (stable)', commonUses: ['Radiotherapy for bone pain palliation'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A therapeutic isotope used for bone pain palliation in metastatic cancer.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 2, A2: 0.6, unit: 'TBq' } },
    { name: 'Rhenium-187', symbol: 'Re-187', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.0025 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.001 MeV', halfLife: '4.33 x 10¹⁰ years', decayConstant: '1.60 x 10⁻¹¹ year⁻¹', specificActivity: '1.03 x 10^6 Bq/g', parent: 'Primordial', daughter: 'Osmium-187 (stable)', commonUses: ['Rhenium-Osmium dating (geological)', 'Neutrino mass experiments'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A very long-lived primordial nuclide used for geological dating (Re-Os system).', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Rhenium-188', symbol: 'Re-188', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['2.12 MeV (max)'], gamma: ['0.155 MeV'], alpha: [] }, avgBetaEnergy: '0.707 MeV', halfLife: '17.0 hours', decayConstant: '0.0408 hour⁻¹', specificActivity: '3.7 x 10^16 Bq/g', parent: 'Tungsten-188', daughter: 'Osmium-188 (stable)', commonUses: ['Radiotherapy (bone pain palliation, synovectomy, arterial brachytherapy)'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A high-energy beta emitter produced from a W-188 generator for various therapeutic applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.3, unit: 'TBq' } },
    { name: 'Rhodium-105', symbol: 'Rh-105', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.567 MeV (max)'], gamma: ['0.306 MeV'], alpha: [] }, avgBetaEnergy: '0.189 MeV', halfLife: '35.36 hours', decayConstant: '0.0196 hour⁻¹', specificActivity: '1.27 x 10^16 Bq/g', parent: 'Ruthenium-105', daughter: 'Palladium-105 (stable)', commonUses: ['Targeted radiotherapy research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A short-lived isotope used in targeted radiotherapy research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 0.7, unit: 'TBq' } },
    { name: 'Rubidium-81', symbol: 'Rb-81', emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'], emissionEnergies: { beta: ['1.05 MeV (max)'], gamma: ['0.446 MeV'], alpha: [] }, avgBetaEnergy: '0.350 MeV', daughterEmissions: { from: 'Kr-81m', gamma: ['0.190 MeV'] }, halfLife: '4.57 hours', decayConstant: '0.152 hour⁻¹', specificActivity: '1.3 x 10^17 Bq/g', parent: 'Strontium-81', daughter: 'Krypton-81m (IT) -> Krypton-81 (stable)', commonUses: ['Generator for Kr-81m (lung ventilation PET imaging)'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'The parent isotope used in generators to produce the short-lived gas Kr-81m for lung scans.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 1, unit: 'TBq' } },
    { name: 'Rubidium-82', symbol: 'Rb-82', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['3.38 MeV (max)'], gamma: ['0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '1.127 MeV', halfLife: '76 seconds', decayConstant: '0.00912 s⁻¹', specificActivity: '8.3 x 10^17 Bq/g', parent: 'Strontium-82', daughter: 'Krypton-82 (stable)', commonUses: ['Cardiac PET imaging for myocardial perfusion'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'An extremely short-lived PET isotope produced from a Sr-82 generator for cardiac perfusion imaging.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.4, unit: 'TBq' } },
    { name: 'Rubidium-84', symbol: 'Rb-84', emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['1.65 MeV (max)'], gamma: ['0.882 MeV'], alpha: [] }, avgBetaEnergy: '0.550 MeV', halfLife: '32.8 days', decayConstant: '0.0211 day⁻¹', specificActivity: '1.74 x 10^15 Bq/g', parent: 'Krypton-84', daughter: 'Krypton-84 (stable)', commonUses: ['Cardiac blood flow research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A research isotope used in studies of cardiac blood flow.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Rubidium-86', symbol: 'Rb-86', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.77 MeV (max)'], gamma: ['1.077 MeV'], alpha: [] }, avgBetaEnergy: '0.590 MeV', halfLife: '18.66 days', decayConstant: '0.0371 day⁻¹', specificActivity: '4.2 x 10^15 Bq/g', parent: 'Krypton-86', daughter: 'Strontium-86 (stable)', commonUses: ['Cardiac blood flow research'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A research isotope used in studies of cardiac blood flow.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.3, unit: 'TBq' } },
    { name: 'Ruthenium-103', symbol: 'Ru-103', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.226 MeV (max)'], gamma: ['0.497 MeV'], alpha: [] }, avgBetaEnergy: '0.075 MeV', halfLife: '39.25 days', decayConstant: '0.0176 day⁻¹', specificActivity: '1.3 x 10^15 Bq/g', parent: 'Technetium-103', daughter: 'Rhodium-103 (stable)', commonUses: ['Fission product', 'Environmental tracer'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fission product with limited use outside of specialized research applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 0.7, unit: 'TBq' } },
    { name: 'Samarium-153', symbol: 'Sm-153', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.808 MeV (max)'], gamma: ['0.103 MeV'], alpha: [] }, avgBetaEnergy: '0.269 MeV', halfLife: '46.28 hours', decayConstant: '0.0150 hour⁻¹', specificActivity: '3.5 x 10^15 Bq/g', parent: 'Samarium-152 (n,γ)', daughter: 'Europium-153 (stable)', commonUses: ['Palliative bone pain therapy (metastatic cancer)'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A clinically used therapeutic isotope for palliative treatment of bone pain from cancer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 4, A2: 0.6, unit: 'TBq' } },
    { name: 'Scandium-44', symbol: 'Sc-44', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['1.47 MeV (max)'], gamma: ['1.157 MeV', '0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.490 MeV', halfLife: '3.97 hours', decayConstant: '0.174 hour⁻¹', parent: 'Titanium-44 (EC)', daughter: 'Calcium-44 (stable)', commonUses: ['PET imaging', 'Theranostic pair with Sc-47'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A research PET isotope, often explored as a "theranostic" partner to the therapeutic isotope Sc-47.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.6, A2: 0.5, unit: 'TBq' } },
    { name: 'Scandium-46', symbol: 'Sc-46', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.357 MeV (max)'], gamma: ['0.889 MeV', '1.121 MeV'], alpha: [] }, avgBetaEnergy: '0.119 MeV', halfLife: '83.79 days', decayConstant: '0.00827 day⁻¹', specificActivity: '1.24 x 10^15 Bq/g', parent: 'Calcium-46 (n,p)', daughter: 'Titanium-46 (stable)', commonUses: ['Tracer in hydrology and industrial processes', 'Calibration source'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived gamma-emitter used as a tracer in specialized industrial processes.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.5, unit: 'TBq' }, gammaConstant: '1.17 R·m²/hr·Ci' },
    { name: 'Scandium-47', symbol: 'Sc-47', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.601 MeV (max)'], gamma: ['0.159 MeV'], alpha: [] }, avgBetaEnergy: '0.200 MeV', halfLife: '3.35 days', decayConstant: '0.207 day⁻¹', specificActivity: '3.1 x 10^16 Bq/g', parent: 'Titanium-47 (n,p)', daughter: 'Titanium-47 (stable)', commonUses: ['Theranostics (pairs with Sc-44 for PET), targeted radiotherapy research.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A research therapeutic isotope, often explored as a "theranostic" partner to the PET isotope Sc-44.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 9, A2: 0.5, unit: 'TBq' } },
    { name: 'Selenium-76', symbol: 'Se-76', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Stable', daughter: 'Stable', commonUses: ['Reference for stable selenium', 'not a radionuclide use'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Selenium-79', symbol: 'Se-79', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.151 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.050 MeV', halfLife: '327,000 years', decayConstant: '2.12 x 10⁻⁶ year⁻¹', specificActivity: '9.2 x 10^8 Bq/g', parent: 'Bromine-79 (n,p)', daughter: 'Bromine-79 (stable)', commonUses: ['Environmental tracer (long-lived fission product)'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'An extremely long-lived fission product relevant in nuclear waste management and environmental studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 2, unit: 'TBq' } },
    { name: 'Silver-110m', symbol: 'Ag-110m', emissionType: ['Beta-minus', 'Isomeric Transition', 'Gamma'], emissionEnergies: { beta: ['0.529 MeV (max)'], gamma: ['0.885 MeV', '0.658 MeV', '1.505 MeV'], alpha: [] }, avgBetaEnergy: '0.176 MeV', halfLife: '249.8 days', decayConstant: '0.00277 day⁻¹', specificActivity: '1.93 x 10^14 Bq/g', parent: 'Cadmium-108', daughter: 'Cadmium-110 (stable) or Palladium-110 (stable)', commonUses: ['Environmental monitoring (fission product', 'activation product)'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'An activation product sometimes used as a gamma calibration source or environmental tracer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.6, A2: 0.4, unit: 'TBq' }, gammaConstant: '1.65 R·m²/hr·Ci' },
    { name: 'Sodium-22', symbol: 'Na-22', emissionType: ['Positron Emission', 'Gamma'], emissionEnergies: { beta: ['0.546 MeV (max)'], gamma: ['1.275 MeV', '0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.182 MeV', halfLife: '2.602 years', decayConstant: '0.266 year⁻¹', gammaConstant: '1.20 R·m²/hr·Ci', specificActivity: '6.45 x 10^13 Bq/g', parent: 'Magnesium-22 (EC)', daughter: 'Neon-22 (stable)', commonUses: ['Calibration sources for PET scanners', 'Tracers for biological studies'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A common long-lived positron emitter used to calibrate PET scanners and other detectors.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 0.5, A2: 0.5, unit: 'TBq' } },
    { name: 'Sodium-23', symbol: 'Na-23', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Stable', daughter: 'Stable', commonUses: ['Reference for stable sodium', 'not a radionuclide use'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Sodium-24', symbol: 'Na-24', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.39 MeV (max)'], gamma: ['1.369 MeV', '2.754 MeV'], alpha: [] }, avgBetaEnergy: '0.463 MeV', halfLife: '14.96 hours', decayConstant: '0.0463 hour⁻¹', specificActivity: '1.8 x 10^17 Bq/g', parent: 'Magnesium-24 (n,p)', daughter: 'Magnesium-24 (stable)', commonUses: ['Hydrological tracer', 'Flow studies', 'Research'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A short-lived, high-energy gamma emitter used as a tracer in industrial and environmental flow studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.4, unit: 'TBq' }, gammaConstant: '1.84 R·m²/hr·Ci' },
    { name: 'Strontium-82', symbol: 'Sr-82', emissionType: ['Electron Capture', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.776 MeV'], alpha: [] }, daughterEmissions: { from: 'Rb-82', beta: ['3.38 MeV (max)'], gamma: ['0.511 MeV (annihilation)'] }, halfLife: '25.36 days', decayConstant: '0.0273 day⁻¹', specificActivity: '2.4 x 10^15 Bq/g', parent: 'Yttrium-85', daughter: 'Rubidium-82', commonUses: ['Generator for Rubidium-82, used for cardiac PET imaging.'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'The long-lived parent used in generators to produce the very short-lived PET isotope Rb-82 for cardiac scans.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Strontium-89', symbol: 'Sr-89', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['1.49 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.497 MeV', halfLife: '50.5 days', decayConstant: '0.0137 day⁻¹', specificActivity: '1.09 x 10^15 Bq/g', parent: 'Uranium Fission', daughter: 'Yttrium-89 (stable)', commonUses: ['Palliative bone pain therapy (metastatic cancer)'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A clinically used high-energy beta-emitter for palliative treatment of bone pain from cancer.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.6, unit: 'TBq' } },
    { name: 'Strontium-90', symbol: 'Sr-90', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.546 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.196 MeV', daughterEmissions: { from: 'Y-90', beta: ['2.28 MeV (max)'] }, halfLife: '28.9 years', decayConstant: '0.0240 year⁻¹', specificActivity: '5.15 x 10^12 Bq/g', parent: 'Uranium Fission', daughter: 'Yttrium-90', commonUses: ['Radioisotope thermoelectric generators (RTGs)', 'Industrial gauges', 'Medical radiation therapy for bone cancer'], category: 'Industrial', commonality: 'Common', commonalityReason: 'A major fission product and long-lived, high-energy beta source (via its Y-90 daughter) for industrial and medical uses.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.3, unit: 'TBq' } },
    { name: 'Sulfur-34', symbol: 'S-34', emissionType: ['Stable'], emissionEnergies: { beta: [], gamma: [], alpha: [] }, halfLife: 'Stable', decayConstant: '0', parent: 'Stable', daughter: 'Stable', commonUses: ['Reference for stable sulfur', 'not a radionuclide use'], category: 'Stable/Reference', commonality: 'N/A', commonalityReason: 'This is a stable isotope and not radioactive.' },
    { name: 'Sulfur-35', symbol: 'S-35', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.167 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.056 MeV', halfLife: '87.51 days', decayConstant: '0.00792 day⁻¹', specificActivity: '1.57 x 10^15 Bq/g', parent: 'Chlorine-35 (n,p)', daughter: 'Chlorine-35 (stable)', commonUses: ['Molecular biology (protein labeling)', 'Metabolic studies'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A low-energy beta-emitter widely used in molecular biology labs for labeling proteins.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 3, unit: 'TBq' } },
    { name: 'Tantalum-182', symbol: 'Ta-182', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.526 MeV (max)'], gamma: ['1.121 MeV', '1.221 MeV'], alpha: [] }, avgBetaEnergy: '0.175 MeV', halfLife: '114.4 days', decayConstant: '0.00606 day⁻¹', specificActivity: '5.2 x 10^14 Bq/g', parent: 'Tantalum-181 (n,γ)', daughter: 'Tungsten-182 (stable)', commonUses: ['Radiography of heavy metals', 'Calibration sources'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'Used for specialized industrial radiography of dense materials.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.8, A2: 0.8, unit: 'TBq' } },
    { name: 'Technetium-99', symbol: 'Tc-99', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.294 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.098 MeV', halfLife: '211,100 years', decayConstant: '3.28 x 10⁻⁶ year⁻¹', specificActivity: '6.3 x 10^8 Bq/g', parent: 'Technetium-99m', daughter: 'Ruthenium-99 (stable)', commonUses: ['Daughter product of Tc-99m', 'Environmental tracer', 'Long-lived fission product in nuclear waste'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'The long-lived daughter of Tc-99m, relevant in nuclear waste management and environmental studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 0.9, unit: 'TBq' } },
    { name: 'Technetium-99m', symbol: 'Tc-99m', emissionType: ['Gamma', 'Isomeric Transition'], emissionEnergies: { beta: [], gamma: ['0.1405 MeV'], alpha: [] }, halfLife: '6.01 hours', decayConstant: '0.115 hour⁻¹', specificActivity: '1.95 x 10^17 Bq/g', parent: 'Molybdenum-99', daughter: 'Technetium-99', commonUses: ['Medical diagnostic imaging (most common medical isotope for various scans: bone, heart, kidney, brain, etc.)'], category: 'Medical', commonality: 'Common', commonalityReason: 'The most widely used medical radioisotope for diagnostic imaging procedures worldwide.', sourceRef: { halfLife: 'nndc', decayConstant: 'nndc' }, shipping: { A1: 8, A2: 0.7, unit: 'TBq' }, gammaConstant: '0.08 R·m²/hr·Ci' },
    { name: 'Tellurium-123m', symbol: 'Te-123m', emissionType: ['Isomeric Transition', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.159 MeV'], alpha: [] }, halfLife: '119.7 days', decayConstant: '0.00579 day⁻¹', specificActivity: '4.1 x 10^14 Bq/g', parent: 'Antimony-123', daughter: 'Tellurium-123 (stable)', commonUses: ['Medical imaging (historical)', 'Research tracer'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used historically in medicine but has been replaced by other isotopes.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 8, A2: 1, unit: 'TBq' } },
    { name: 'Tellurium-128', symbol: 'Te-128', emissionType: ['Double Beta-minus'], emissionEnergies: { beta: ['0.867 MeV (total)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.289 MeV', halfLife: '2.2 x 10²⁴ years', decayConstant: '3.15 x 10⁻²⁵ year⁻¹', specificActivity: '1.4 x 10^-8 Bq/g', parent: 'Primordial', daughter: 'Xenon-128 (stable)', commonUses: ['Longest measured half-life', 'Fundamental physics research'], category: 'Natural', commonality: 'Rare', commonalityReason: 'Notable for having one of the longest measured half-lives of any isotope.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Tellurium-130', symbol: 'Te-130', emissionType: ['Double Beta-minus'], emissionEnergies: { beta: ['2.528 MeV (total)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.843 MeV', halfLife: '2.5 x 10²¹ years', decayConstant: '2.77 x 10⁻²² year⁻¹', specificActivity: '1.6 x 10^-5 Bq/g', parent: 'Primordial', daughter: 'Xenon-130 (stable)', commonUses: ['Double beta decay research'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An isotope with an extremely long half-life used in fundamental physics research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 0.7, unit: 'TBq' } },
    { name: 'Terbium-161', symbol: 'Tb-161', emissionType: ['Beta-minus', 'Gamma', 'Auger electron'], emissionEnergies: { beta: ['0.593 MeV (max)'], gamma: ['0.049 MeV', '0.075 MeV'], alpha: [] }, avgBetaEnergy: '0.198 MeV', halfLife: '6.89 days', decayConstant: '0.101 day⁻¹', specificActivity: '4.4 x 10^14 Bq/g', commonUses: ['Theranostics (combined therapy and diagnostics), particularly for cancer treatment research.'], parent: 'Gadolinium-160 (n,γ)', daughter: 'Dysprosium-161 (stable)', category: 'Medical', commonality: 'Rare', commonalityReason: 'A promising research isotope for targeted radionuclide therapy due to its ideal decay properties.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 30, A2: 0.6, unit: 'TBq' } },
    { name: 'Thallium-201', symbol: 'Tl-201', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.167 MeV', '0.135 MeV'], alpha: [] }, halfLife: '73.1 hours', decayConstant: '0.00948 hour⁻¹', specificActivity: '1.74 x 10^15 Bq/g', parent: 'Lead-201', daughter: 'Mercury-201 (stable)', commonUses: ['Cardiac imaging (myocardial perfusion)', 'Parathyroid gland imaging'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A once-common SPECT agent for cardiac imaging, still used for certain applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 4, unit: 'TBq' } },
    { name: 'Thallium-204', symbol: 'Tl-204', emissionType: ['Beta-minus', 'Electron Capture'], emissionEnergies: { beta: ['0.763 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.254 MeV', halfLife: '3.78 years', decayConstant: '0.183 year⁻¹', specificActivity: '1.6 x 10^13 Bq/g', parent: 'Lead-204 (d,2n)', daughter: 'Lead-204 (stable) or Mercury-204 (stable)', commonUses: ['Calibration sources (beta)', 'Thickness gauging'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived pure beta-emitter used in specialized industrial gauges.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 4, A2: 1, unit: 'TBq' } },
    { name: 'Thallium-205', symbol: 'Tl-205', emissionType: ['Stable'], emissionEnergies: { alpha: [], beta: [], gamma: [] }, halfLife: 'Stable', decayConstant: '0', specificActivity: '0 Bq/g', parent: 'Bismuth-209 (α)', daughter: 'Stable', commonUses: ['Final stable product of Bismuth-209 decay', 'Nuclear Magnetic Resonance (NMR) research', 'Target material for isotope production'], category: 'Stable/Reference', commonality: 'Common', commonalityReason: 'The stable end-product of the extremely long-lived Bi-209.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Thallium-207', symbol: 'Tl-207', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['1.42 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.473 MeV', halfLife: '4.77 minutes', decayConstant: '0.145 min⁻¹', specificActivity: '1.5 x 10^18 Bq/g', parent: 'Bismuth-211', daughter: 'Lead-207 (stable)', commonUses: ['Intermediate in Actinium-227 decay series'], category: 'Natural', commonality: 'Rare', commonalityReason: 'A very short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.2, unit: 'TBq' } },
    { name: 'Thallium-208', symbol: 'Tl-208', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['1.80 MeV (max)'], gamma: ['2.614 MeV (dominant)', '0.583 MeV'], alpha: [] }, avgBetaEnergy: '0.600 MeV', halfLife: '3.053 minutes', decayConstant: '0.227 min⁻¹', specificActivity: '2.4 x 10^18 Bq/g', parent: 'Bismuth-212 (α)', daughter: 'Lead-208 (stable)', commonUses: ['High-energy gamma source in natural background'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A daughter in the Th-232 series, notable for emitting one of the highest-energy natural gamma rays (2.6 MeV).', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.3, unit: 'TBq' } },
    { name: 'Thorium-227', symbol: 'Th-227', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['6.038 MeV'], beta: [], gamma: ['0.236 MeV'] }, halfLife: '18.72 days', decayConstant: '0.037 day⁻¹', specificActivity: '1.2 x 10^15 Bq/g', parent: 'Actinium-227', daughter: 'Radium-223 (α)', commonUses: ['Intermediate in Actinium-227 decay series', 'Alpha therapy research'], category: 'Natural', commonality: 'Rare', commonalityReason: 'An alpha-emitter in the U-235 decay series, used in targeted alpha therapy research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Thorium-228', symbol: 'Th-228', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.423 MeV'], beta: [], gamma: ['0.084 MeV'] }, daughterEmissions: { from: 'Ra-224', alpha: ['5.685 MeV'], gamma: ['0.241 MeV'] }, halfLife: '1.91 years', decayConstant: '0.363 year⁻¹', specificActivity: '3.0 x 10^13 Bq/g', parent: 'Actinium-228', daughter: 'Radium-224 (α)', commonUses: ['Intermediate in Thorium-232 decay chain', 'Calibration sources'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A key alpha-emitting member of the Th-232 decay series.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.5, A2: 0.001, unit: 'TBq' } },
    { name: 'Thorium-229', symbol: 'Th-229', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.845 MeV'], beta: [], gamma: ['0.029 MeV', '0.194 MeV'] }, halfLife: '7,340 years', decayConstant: '9.44 x 10⁻⁵ year⁻¹', specificActivity: '7.9 x 10^9 Bq/g', parent: 'Uranium-233', daughter: 'Radium-225 (α)', commonUses: ['Parent for Actinium-225 generators', 'Research in nuclear clocks due to its low-energy isomeric state'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A long-lived alpha emitter used to produce Ac-225 generators and for advanced physics research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 5, A2: 0.001, unit: 'TBq' } },
    { name: 'Thorium-230', symbol: 'Th-230', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.688 MeV'], beta: [], gamma: ['0.067 MeV'] }, halfLife: '75,400 years', decayConstant: '9.19 x 10⁻⁶ year⁻¹', specificActivity: '7.6 x 10^8 Bq/g', parent: 'Uranium-234', daughter: 'Radium-226 (α)', commonUses: ['Dating of marine sediments', 'Component of natural decay series'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'A long-lived member of the U-238 decay series, used in geological dating.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Thorium-231', symbol: 'Th-231', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.39 MeV (max)'], gamma: ['0.084 MeV'], alpha: [] }, avgBetaEnergy: '0.130 MeV', halfLife: '25.52 hours', decayConstant: '0.0272 hour⁻¹', specificActivity: '2.6 x 10^16 Bq/g', parent: 'Uranium-235', daughter: 'Protactinium-231', commonUses: ['Intermediate in U-235 decay chain'], category: 'Natural', decaySeriesId: 'U-235-series', commonality: 'Rare', commonalityReason: 'A short-lived intermediate in a natural decay chain.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 0.7, unit: 'TBq' } },
    { name: 'Thorium-232', symbol: 'Th-232', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.012 MeV'], beta: [], gamma: ['0.059 MeV'] }, daughterEmissions: { from: 'Ra-228', beta: ['0.039 MeV (max)'] }, halfLife: '14.05 billion years', decayConstant: '4.93 x 10⁻¹¹ year⁻¹', specificActivity: '4,059 Bq/g', parent: 'Primordial', daughter: 'Radium-228 (α)', commonUses: ['Nuclear fuel cycle (fertile material)', 'Gas mantles (historical)', 'Welding electrodes', 'Thoriated optics', 'Catalysis'], category: 'Natural', decaySeriesId: 'Th-232-series', commonality: 'Common', commonalityReason: 'A primordial, naturally occurring fertile isotope that is the head of its own decay series.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: null, A2: null, unit: 'TBq' } },
    { name: 'Thorium-234', symbol: 'Th-234', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.193 MeV (max)'], gamma: ['0.063 MeV', '0.093 MeV'], alpha: [] }, avgBetaEnergy: '0.064 MeV', daughterEmissions: { from: 'Pa-234m', beta: ['2.29 MeV (max)'], gamma: ['1.001 MeV'] }, halfLife: '24.10 days', decayConstant: '0.0287 day⁻¹', specificActivity: '8.2 x 10^14 Bq/g', parent: 'Uranium-238', daughter: 'Protactinium-234m (β-)', commonUses: ['Intermediate in U-238 decay chain'], category: 'Natural', commonality: 'Moderate', commonalityReason: 'The first daughter of U-238, often found in equilibrium with its parent in natural samples.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.3, A2: 0.3, unit: 'TBq' } },
    { name: 'Thulium-170', symbol: 'Tm-170', emissionType: ['Beta-minus', 'Gamma', 'X-ray'], emissionEnergies: { beta: ['0.968 MeV (max)'], gamma: ['0.084 MeV'], alpha: [] }, avgBetaEnergy: '0.323 MeV', halfLife: '128.6 days', decayConstant: '0.00539 day⁻¹', specificActivity: '1.02 x 10^15 Bq/g', parent: 'Erbium-170', daughter: 'Ytterbium-170 (stable)', commonUses: ['Portable industrial radiography', 'Brachytherapy', 'Medical imaging (historical)'], category: 'Industrial', commonality: 'Moderate', commonalityReason: 'A versatile isotope used for portable radiography and some brachytherapy applications.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 4, A2: 0.5, unit: 'TBq' } },
    { name: 'Tin-117m', symbol: 'Sn-117m', emissionType: ['Isomeric Transition', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.159 MeV'], alpha: [] }, halfLife: '13.76 days', decayConstant: '0.0504 day⁻¹', specificActivity: '4.8 x 10^15 Bq/g', parent: 'Tin-116 (n,γ)', daughter: 'Tin-117 (stable)', commonUses: ['Bone pain palliation for metastatic cancer.', 'Radiosynovectomy.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A therapeutic isotope used for treating bone pain and in radiosynovectomy.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.7, unit: 'TBq' } },
    { name: 'Tin-126', symbol: 'Sn-126', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.380 MeV (max)'], gamma: ['0.087 MeV'], alpha: [] }, avgBetaEnergy: '0.127 MeV', halfLife: '230,000 years', decayConstant: '3.01 x 10⁻⁶ year⁻¹', specificActivity: '1.4 x 10^9 Bq/g', parent: 'Cadmium-126', daughter: 'Antimony-126 (β-)', commonUses: ['Long-lived fission product', 'Nuclear waste assessment'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'An extremely long-lived fission product relevant in nuclear waste management.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.4, A2: 0.3, unit: 'TBq' } },
    { name: 'Tritium', symbol: 'H-3', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['0.0186 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.006 MeV', halfLife: '12.32 years', decayConstant: '0.0563 year⁻¹', specificActivity: '3.59 x 10^14 Bq/g', parent: 'Lithium-6 (n,α)', daughter: 'Helium-3 (stable)', commonUses: ['Self-powered lighting (e.g., exit signs, watches)', 'Medical and biological tracer', 'Nuclear weapons component'], category: 'Industrial', commonality: 'Common', commonalityReason: 'Widely used in self-powered lighting (e.g., exit signs), as a biological tracer, and in nuclear weapons.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 40, A2: 40, unit: 'TBq' } },
    { name: 'Tungsten-188', symbol: 'W-188', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.349 MeV (max)'], gamma: ['0.227 MeV'], alpha: [] }, avgBetaEnergy: '0.116 MeV', daughterEmissions: { from: 'Re-188', beta: ['2.12 MeV (max)'], gamma: ['0.155 MeV'] }, halfLife: '69.4 days', decayConstant: '0.00999 day⁻¹', specificActivity: '3.6 x 10^14 Bq/g', parent: 'Tantalum-186', daughter: 'Rhenium-188', commonUses: ['Generator for Rhenium-188, used in therapeutic applications.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'The parent isotope used in generators to produce the therapeutic isotope Re-188.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.9, A2: 0.3, unit: 'TBq' } },
    { name: 'Uranium-230', symbol: 'U-230', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.888 MeV'], beta: [], gamma: ['0.053 MeV'] }, halfLife: '20.8 days', decayConstant: '0.0333 day⁻¹', specificActivity: '1.87 x 10^15 Bq/g', parent: 'Plutonium-234 (α)', daughter: 'Thorium-226', commonUses: ['Medical isotope production (e.g., Ra-223 from Th-226 generator)', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A research isotope sometimes used in generators to produce medical alpha-emitters.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Uranium-231', symbol: 'U-231', emissionType: ['Electron Capture', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.084 MeV', '0.143 MeV'], alpha: [] }, halfLife: '4.2 days', decayConstant: '0.165 day⁻¹', specificActivity: '1.27 x 10^16 Bq/g', parent: 'Neptunium-231 (EC)', daughter: 'Protactinium-231', commonUses: ['Intermediate in nuclear research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A short-lived isotope encountered only in specialized nuclear research.', sourceRef: { halfLife: 'nndc' } },
    { name: 'Uranium-232', symbol: 'U-232', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['5.320 MeV'], beta: [], gamma: ['0.058 MeV'] }, daughterEmissions: { from: 'Th-228', alpha: ['5.423 MeV'], gamma: ['0.084 MeV'] }, halfLife: '68.9 years', decayConstant: '0.0101 year⁻¹', specificActivity: '8.1 x 10^11 Bq/g', parent: 'Plutonium-236 (α)', daughter: 'Thorium-228 (α)', commonUses: ['Contaminant in U-233 from thorium fuel cycle', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'An isotope primarily known as a problematic contaminant in the thorium fuel cycle due to its high-energy gamma daughters.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.001, unit: 'TBq' } },
    { name: 'Uranium-233', symbol: 'U-233', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.824 MeV'], beta: [], gamma: ['0.042 MeV', '0.312 MeV'] }, halfLife: '159,200 years', decayConstant: '4.35 x 10⁻⁶ year⁻¹', specificActivity: '3.56 x 10^8 Bq/g', parent: 'Protactinium-233', daughter: 'Thorium-229 (α)', commonUses: ['Thorium fuel cycle (fissile material)', 'Research'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A fissile isotope that can be bred from Thorium-232, central to thorium fuel cycle research.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Uranium-234', symbol: 'U-234', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.776 MeV'], beta: [], gamma: ['0.053 MeV'] }, halfLife: '245,500 years', decayConstant: '2.82 x 10⁻⁶ year⁻¹', specificActivity: '2.3 x 10^8 Bq/g', parent: 'Protactinium-234m (β-)', daughter: 'Thorium-230', commonUses: ['Component of natural uranium', 'Geological dating (uranium-thorium dating)'], category: 'Natural', decaySeriesId: 'U-238-series', commonality: 'Moderate', commonalityReason: 'A member of the U-238 decay series present in all natural uranium.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Uranium-235', symbol: 'U-235', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.398 MeV'], beta: [], gamma: ['0.186 MeV', '0.144 MeV'] }, daughterEmissions: { from: 'Th-231', beta: ['0.39 MeV (max)'], gamma: ['0.084 MeV'] }, halfLife: '703.8 million years', decayConstant: '9.85 x 10⁻¹⁰ year⁻¹', specificActivity: '8.0 x 10^4 Bq/g', parent: 'Primordial', daughter: 'Thorium-231 (α)', commonUses: ['Nuclear fuel for reactors', 'Nuclear weapons'], category: 'Natural', decaySeriesId: 'U-235-series', commonality: 'Common', commonalityReason: 'The primary fissile isotope of uranium, used for nuclear power generation and weapons.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 10, A2: 0.001, unit: 'TBq' } },
    { name: 'Uranium-238', symbol: 'U-238', emissionType: ['Alpha', 'Gamma'], emissionEnergies: { alpha: ['4.197 MeV'], beta: [], gamma: ['0.0496 MeV'] }, daughterEmissions: { from: 'Th-234', beta: ['0.193 MeV (max)'], gamma: ['0.063 MeV', '0.093 MeV'] }, halfLife: '4.468 billion years', decayConstant: '1.55 x 10⁻¹⁰ year⁻¹', specificActivity: '1.24 x 10^4 Bq/g', parent: 'Primordial', daughter: 'Thorium-234 (α)', commonUses: ['Geological dating', 'Nuclear fuel cycle (raw material)', 'Shielding (depleted uranium)'], category: 'Natural', decaySeriesId: 'U-238-series', commonality: 'Common', commonalityReason: 'The most abundant isotope of natural uranium (>99%) and the head of a primary natural decay series.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: null, A2: null, unit: 'TBq' } },
    { name: 'Xenon-131', symbol: 'Xe-131', emissionType: ['Stable'], emissionEnergies: { alpha: [], beta: [], gamma: [] }, halfLife: 'Stable', decayConstant: '0', specificActivity: '0 Bq/g', parent: 'Iodine-131 (β-)', daughter: 'Stable', commonUses: ['Stable end-product of Iodine-131 decay.', 'Stable isotope analysis.'], category: 'Stable/Reference', commonality: 'Common', commonalityReason: 'The stable end-product of I-131 decay, a very common medical isotope.', sourceRef: {} },
    { name: 'Xenon-133', symbol: 'Xe-133', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.346 MeV (max)'], gamma: ['0.081 MeV'], alpha: [] }, avgBetaEnergy: '0.115 MeV', halfLife: '5.24 days', decayConstant: '0.132 day⁻¹', specificActivity: '6.4 x 10^15 Bq/g', parent: 'Uranium Fission', daughter: 'Cesium-133 (stable)', commonUses: ['Lung ventilation studies (medical imaging)', 'Blood flow measurements'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A radioactive noble gas widely used for lung ventilation studies in nuclear medicine.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 20, A2: 10, unit: 'TBq' } },
    { name: 'Ytterbium-169', symbol: 'Yb-169', emissionType: ['Electron Capture', 'Gamma', 'X-ray'], emissionEnergies: { beta: [], gamma: ['0.198 MeV', '0.261 MeV', '0.308 MeV'], alpha: [] }, halfLife: '32.02 days', decayConstant: '0.0216 day⁻¹', gammaConstant: '0.18 R·m²/hr·Ci', specificActivity: '1.9 x 10^14 Bq/g', parent: 'Lutetium-169', daughter: 'Thulium-169 (stable)', commonUses: ['Medical imaging (historical)', 'Brain and CSF studies', 'Industrial radiography'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'Used for specialized, small-format industrial radiography and historically in medicine.', sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' }, shipping: { A1: 10, A2: 1, unit: 'TBq' } },
    { name: 'Yttrium-90', symbol: 'Y-90', emissionType: ['Beta-minus'], emissionEnergies: { beta: ['2.28 MeV (max)'], gamma: [], alpha: [] }, avgBetaEnergy: '0.760 MeV', halfLife: '64.0 hours', decayConstant: '0.0108 hour⁻¹', specificActivity: '1.21 x 10^16 Bq/g', parent: 'Strontium-90', daughter: 'Zirconium-90 (stable)', commonUses: ['Radioembolization (liver cancer therapy)', 'Radioimmunotherapy', 'Brachytherapy'], category: 'Medical', commonality: 'Moderate', commonalityReason: 'A high-energy pure beta-emitter used for liver cancer therapy and other treatments.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 0.3, A2: 0.3, unit: 'TBq' } },
    { name: 'Zinc-69m', symbol: 'Zn-69m', emissionType: ['Isomeric Transition', 'Gamma'], emissionEnergies: { beta: [], gamma: ['0.439 MeV'], alpha: [] }, halfLife: '13.76 hours', decayConstant: '0.0504 hour⁻¹', specificActivity: '4.8 x 10^16 Bq/g', parent: 'Zinc-69', daughter: 'Zinc-69', commonUses: ['Zinc metabolism studies (historical)'], category: 'Medical', commonality: 'Rare', commonalityReason: 'Used historically as a tracer for zinc metabolism but has been replaced by other methods.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 2, A2: 2, unit: 'TBq' } },
    { name: 'Zirconium-89', symbol: 'Zr-89', emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'], emissionEnergies: { beta: ['0.902 MeV (max)'], gamma: ['0.909 MeV', '0.511 MeV (annihilation)'], alpha: [] }, avgBetaEnergy: '0.301 MeV', halfLife: '78.41 hours', decayConstant: '0.00884 hour⁻¹', specificActivity: '1.18 x 10^16 Bq/g', parent: 'Yttrium-89 (p,n)', daughter: 'Yttrium-89 (stable)', commonUses: ['PET imaging, particularly for antibody-based imaging (immuno-PET) due to its longer half-life.'], category: 'Medical', commonality: 'Rare', commonalityReason: 'A PET isotope with a relatively long half-life, making it ideal for antibody-based imaging (immuno-PET).', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 1, unit: 'TBq' } },
    { name: 'Zirconium-95', symbol: 'Zr-95', emissionType: ['Beta-minus', 'Gamma'], emissionEnergies: { beta: ['0.399 MeV (max)'], gamma: ['0.724 MeV', '0.757 MeV'], alpha: [] }, avgBetaEnergy: '0.133 MeV', daughterEmissions: { from: 'Nb-95', beta: ['0.160 MeV (max)'], gamma: ['0.766 MeV'] }, halfLife: '64.03 days', decayConstant: '0.0108 day⁻¹', specificActivity: '8.8 x 10^14 Bq/g', parent: 'Uranium Fission', daughter: 'Niobium-95', commonUses: ['Fission product', 'Environmental tracer'], category: 'Industrial', commonality: 'Rare', commonalityReason: 'A common fission product used as a tracer in environmental and fallout studies.', sourceRef: { halfLife: 'nndc' }, shipping: { A1: 1, A2: 0.8, unit: 'TBq' } }

];

    </script>

    <script type="text/babel">

        /**
         * Radionuclide Database Tool - Core Data and Utility Functions
         * -----------------------------------------------------------
         * This script contains the core data structures, constants, and utility
         * functions for the radionuclide database application. It includes
         * decay series data, SVG icon paths, and various parsers for handling
         * physical quantities like half-life and energy.
         */

        //==============================================================================
        // --- APPLICATION METADATA & CONSTANTS
        //==============================================================================

        const VERSION = '3.0.7';
        const LAST_UPDATED = 'August 23, 2025';

        /**
         * Data sources used in the application.
         * Each key is a short identifier, and the value is an object
         * containing the full name and URL of the source.
         */

        const sources = {
            nndc: { name: 'NNDC', url: 'https://www.nndc.bnl.gov/nudat3/' },
            wiki: { name: 'Wikipedia', url: 'https://en.wikipedia.org/' },
            hps: { name: 'Health Physics Society', url: 'https://hps.org/' },
            rse: { name: 'Radiation Safety Engineering, Inc.', url: 'https://www.radpro.com/sourcehvl.htm' } // <-- New source added
        };

        /**
         * Half-Value Layer (HVL) data in cm for common gamma emitters and materials.
         * Source: Approximate values from various health physics resources.
         */

const HVL_DATA = {
    'Am-241': { 'Lead': 0.02, 'Steel': 0.8, 'Concrete': 2.3, 'Aluminum': 1.5, 'Water': 4.2, sourceRef: 'rse' },
    'Au-198': { 'Lead': 0.33, 'Steel': 1.4, 'Concrete': 4.7, 'Aluminum': 2.5, 'Water': 6.8, sourceRef: 'rse' },
    'Ba-133': { 'Lead': 0.29, 'Steel': 1.2, 'Concrete': 4.1, 'Aluminum': 2.2, 'Water': 5.8, sourceRef: 'rse' },
    'Co-60':  { 'Lead': 1.2,  'Steel': 2.1, 'Concrete': 6.0, 'Aluminum': 4.8, 'Water': 11.0, sourceRef: 'rse' },
    'Cs-137': { 'Lead': 0.65, 'Steel': 1.6, 'Concrete': 4.8, 'Aluminum': 3.0, 'Water': 8.0, sourceRef: 'rse' },
    'Eu-152': { 'Lead': 1.0,  'Steel': 2.0, 'Concrete': 5.8, 'Aluminum': 4.5, 'Water': 10.5, sourceRef: 'rse' },
    'Ga-67':  { 'Lead': 0.07, 'Steel': 0.8, 'Concrete': 3.0, 'Aluminum': 1.5, 'Water': 4.8, sourceRef: 'rse' },
    'I-125':  { 'Lead': 0.002,'Steel': 0.1, 'Concrete': 1.9, 'Aluminum': 0.6, 'Water': 1.8, sourceRef: 'rse' },
    'I-131':  { 'Lead': 0.3,  'Steel': 1.2, 'Concrete': 4.0, 'Aluminum': 2.2, 'Water': 6.0, sourceRef: 'rse' },
    'Ir-192': { 'Lead': 0.33, 'Steel': 1.3, 'Concrete': 4.3, 'Aluminum': 2.1, 'Water': 6.1, sourceRef: 'rse' },
    'Mn-54':  { 'Lead': 0.8,  'Steel': 1.8, 'Concrete': 5.2, 'Aluminum': 3.6, 'Water': 9.0, sourceRef: 'rse' },
    'Mo-99':  { 'Lead': 0.7,  'Steel': 1.7, 'Concrete': 5.0, 'Aluminum': 3.1, 'Water': 8.2, sourceRef: 'rse' },
    'Na-22':  { 'Lead': 1.1,  'Steel': 2.0, 'Concrete': 5.8, 'Aluminum': 4.5, 'Water': 10.2, sourceRef: 'rse' },
    'Na-24':  { 'Lead': 1.5,  'Steel': 2.5, 'Concrete': 7.2, 'Aluminum': 6.1, 'Water': 14.5, sourceRef: 'rse' },
    'Sc-46':  { 'Lead': 1.0,  'Steel': 2.0, 'Concrete': 5.9, 'Aluminum': 4.2, 'Water': 10.0, sourceRef: 'rse' },
    'Tc-99m': { 'Lead': 0.03, 'Steel': 0.3, 'Concrete': 2.2, 'Aluminum': 0.8, 'Water': 4.6, sourceRef: 'rse' }
};

const SHIELDING_MATERIALS = {
    'Plastic': { Z: 6, density: 1.18 }, // Using Carbon for approximation
    'Aluminum': { Z: 13, density: 2.70 },
    'Steel': { Z: 26, density: 7.85 }, // Using Iron for approximation
    'Lead': { Z: 82, density: 11.34 },
    'Water': { Z: 8, density: 1.00 }, // Using Oxygen for approximation
    'Concrete': { Z: 11.3, density: 2.35 } // Weighted average of common elements
};

        //==============================================================================
        // --- CORE DATA
        //==============================================================================

        /**
         * Defines the primary natural decay chains. Each object represents a series
         * and contains an array of steps in its decay chain.
         */

        const decaySeriesData = [
            {
                id: 'U-238-series',
                name: 'Uranium-238 Decay Series (Uranium Series)',
                startNuclide: 'Uranium-238',
                chain: [
                    { nuclide: 'Uranium-238', decayType: 'Alpha', halfLife: '4.468 billion years', daughter: 'Thorium-234' },
                    { nuclide: 'Thorium-234', decayType: 'Beta-minus', halfLife: '24.10 days', daughter: 'Protactinium-234m' },
                    { nuclide: 'Protactinium-234m', decayType: 'Beta-minus', halfLife: '1.17 minutes', daughter: 'Uranium-234' },
                    { nuclide: 'Uranium-234', decayType: 'Alpha', halfLife: '245,500 years', daughter: 'Thorium-230' },
                    { nuclide: 'Thorium-230', decayType: 'Alpha', halfLife: '75,380 years', daughter: 'Radium-226' },
                    { nuclide: 'Radium-226', decayType: 'Alpha', halfLife: '1600 years', daughter: 'Radon-222' },
                    { nuclide: 'Radon-222', decayType: 'Alpha', halfLife: '3.82 days', daughter: 'Polonium-218' },
                    { nuclide: 'Polonium-218', decayType: 'Alpha', halfLife: '3.1 minutes', daughter: 'Lead-214' },
                    { nuclide: 'Lead-214', decayType: 'Beta-minus', halfLife: '26.8 minutes', daughter: 'Bismuth-214' },
                    { nuclide: 'Bismuth-214', decayType: 'Beta-minus', halfLife: '19.9 minutes', daughter: 'Polonium-214' },
                    { nuclide: 'Polonium-214', decayType: 'Alpha', halfLife: '164.3 microseconds', daughter: 'Lead-210' },
                    { nuclide: 'Lead-210', decayType: 'Beta-minus', halfLife: '22.2 years', daughter: 'Bismuth-210' },
                    { nuclide: 'Bismuth-210', decayType: 'Beta-minus', halfLife: '5.012 days', daughter: 'Polonium-210' },
                    { nuclide: 'Polonium-210', decayType: 'Alpha', halfLife: '138.376 days', daughter: 'Lead-206' },
                    { nuclide: 'Lead-206', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                ]
            },
		
	{
            id: 'Th-232-series',
            name: 'Thorium-232 Decay Series (Thorium Series)',
            startNuclide: 'Thorium-232',
            chain: [
                { nuclide: 'Thorium-232', decayType: 'Alpha', halfLife: '14.05 billion years', daughter: 'Radium-228' },
                { nuclide: 'Radium-228', decayType: 'Beta-minus', halfLife: '5.75 years', daughter: 'Actinium-228' },
                { nuclide: 'Actinium-228', decayType: 'Beta-minus', halfLife: '6.15 hours', daughter: 'Thorium-228' },
                { nuclide: 'Thorium-228', decayType: 'Alpha', halfLife: '1.913 years', daughter: 'Radium-224' },
                { nuclide: 'Radium-224', decayType: 'Alpha', halfLife: '3.63 days', daughter: 'Radon-220' },
                { nuclide: 'Radon-220', decayType: 'Alpha', halfLife: '55.6 seconds', daughter: 'Polonium-216' },
                { nuclide: 'Polonium-216', decayType: 'Alpha', halfLife: '0.145 seconds', daughter: 'Lead-212' },
                { nuclide: 'Lead-212', decayType: 'Beta-minus', halfLife: '10.64 hours', daughter: 'Bismuth-212' },
                { 
                    nuclide: 'Bismuth-212', 
                    decayType: 'Beta-minus (64.1%) / Alpha (35.9%)', 
                    halfLife: '60.55 minutes',
		    daughter: 'Polonium-212 / Thallium-208',
                    branches: [
                        [ // Path 1: Beta decay
                            { nuclide: 'Polonium-212', decayType: 'Alpha', halfLife: '0.299 microseconds', daughter: 'Lead-208' },
                            { nuclide: 'Lead-208', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                        ],
                        [ // Path 2: Alpha decay
                            { nuclide: 'Thallium-208', decayType: 'Beta-minus', halfLife: '3.053 minutes', daughter: 'Lead-208' },
                            { nuclide: 'Lead-208', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                        ]
                    ]
                }
            ]
        },
            {
                id: 'U-235-series',
                name: 'Uranium-235 Decay Series (Actinium Series)',
                startNuclide: 'Uranium-235',
                chain: [
                    { nuclide: 'Uranium-235', decayType: 'Alpha', halfLife: '703.8 million years', daughter: 'Thorium-231' },
                    { nuclide: 'Thorium-231', decayType: 'Beta-minus', halfLife: '25.5 hours', daughter: 'Protactinium-231' },
                    { nuclide: 'Protactinium-231', decayType: 'Alpha', halfLife: '32,760 years', daughter: 'Actinium-227' },
                    { nuclide: 'Actinium-227', decayType: 'Beta-minus', halfLife: '21.77 years', daughter: 'Thorium-227' },
                    { nuclide: 'Thorium-227', decayType: 'Alpha', halfLife: '18.72 days', daughter: 'Radium-223' },
                    { nuclide: 'Radium-223', decayType: 'Alpha', halfLife: '11.43 days', daughter: 'Radon-219' },
                    { nuclide: 'Radon-219', decayType: 'Alpha', halfLife: '3.96 seconds', daughter: 'Polonium-215' },
                    { nuclide: 'Polonium-215', decayType: 'Alpha', halfLife: '1.78 milliseconds', daughter: 'Lead-211' },
		    { nuclide: 'Lead-211', decayType: 'Beta-minus', halfLife: '36.1 minutes', daughter: 'Bismuth-211' },
		    { 
			    nuclide: 'Bismuth-211', 
			    decayType: 'Alpha (99.72%) / Beta-minus (0.28%)', 
			    halfLife: '2.14 minutes', 
			    daughter: 'Thallium-207 / Polonium-211',
			    branches: [
			        [ // Path 1: Alpha decay
			            { nuclide: 'Thallium-207', decayType: 'Beta-minus', halfLife: '4.77 minutes', daughter: 'Lead-207' },
			            { nuclide: 'Lead-207', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
			        ],
			        [ // Path 2: Beta decay
			            { nuclide: 'Polonium-211', decayType: 'Alpha', halfLife: '0.516 seconds', daughter: 'Lead-207' },
			            { nuclide: 'Lead-207', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
			        ]
			    ]
			}
                ]
            },
            {
                id: 'Ra-226-series',
                name: 'Radium-226 Decay Series',
                startNuclide: 'Radium-226',
                chain: [
                    { nuclide: 'Radium-226', decayType: 'Alpha', halfLife: '1600 years', daughter: 'Radon-222' },
                    { nuclide: 'Radon-222', decayType: 'Alpha', halfLife: '3.82 days', daughter: 'Polonium-218' },
                    { nuclide: 'Polonium-218', decayType: 'Alpha', halfLife: '3.1 minutes', daughter: 'Lead-214' },
                    { nuclide: 'Lead-214', decayType: 'Beta-minus', halfLife: '26.8 minutes', daughter: 'Bismuth-214' },
                    { nuclide: 'Bismuth-214', decayType: 'Beta-minus', halfLife: '19.9 minutes', daughter: 'Polonium-214' },
                    { nuclide: 'Polonium-214', decayType: 'Alpha', halfLife: '164.3 microseconds', daughter: 'Lead-210' },
                    { nuclide: 'Lead-210', decayType: 'Beta-minus', halfLife: '22.2 years', daughter: 'Bismuth-210' },
                    { nuclide: 'Bismuth-210', decayType: 'Beta-minus', halfLife: '5.012 days', daughter: 'Polonium-210' },
                    { nuclide: 'Polonium-210', decayType: 'Alpha', halfLife: '138.376 days', daughter: 'Lead-206' },
                    { nuclide: 'Lead-206', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                ]
            },
            {
                id: 'Np-237-series',
                name: 'Neptunium-237 Decay Series (Artificial)',
                startNuclide: 'Neptunium-237',
                chain: [
                    { nuclide: 'Neptunium-237', decayType: 'Alpha', halfLife: '2.14 million years', daughter: 'Protactinium-233' },
                    { nuclide: 'Protactinium-233', decayType: 'Beta-minus', halfLife: '27.0 days', daughter: 'Uranium-233' },
                    { nuclide: 'Uranium-233', decayType: 'Alpha', halfLife: '159,200 years', daughter: 'Thorium-229' },
                    { nuclide: 'Thorium-229', decayType: 'Alpha', halfLife: '7,340 years', daughter: 'Radium-225' },
                    { nuclide: 'Radium-225', decayType: 'Beta-minus', halfLife: '14.9 days', daughter: 'Actinium-225' },
                    { nuclide: 'Actinium-225', decayType: 'Alpha', halfLife: '9.92 days', daughter: 'Francium-221' },
                    { nuclide: 'Francium-221', decayType: 'Alpha', halfLife: '4.8 minutes', daughter: 'Astatine-217' },
                    { nuclide: 'Astatine-217', decayType: 'Alpha', halfLife: '32.3 milliseconds', daughter: 'Bismuth-213' },
                    { nuclide: 'Bismuth-213', decayType: 'Beta-minus', halfLife: '45.6 minutes', daughter: 'Polonium-213' },
                    { nuclide: 'Polonium-213', decayType: 'Alpha', halfLife: '4.2 microseconds', daughter: 'Lead-209' },
                    { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                    { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                    { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                ]
            },
            {
                id: 'Ac-225-series',
                name: 'Actinium-225 (Medical Alpha Generator)',
                startNuclide: 'Actinium-225',
                chain: [
                    { nuclide: 'Actinium-225', decayType: 'Alpha', halfLife: '9.92 days', daughter: 'Francium-221' },
                    { nuclide: 'Francium-221', decayType: 'Alpha', halfLife: '4.8 minutes', daughter: 'Astatine-217' },
                    { nuclide: 'Astatine-217', decayType: 'Alpha', halfLife: '32.3 milliseconds', daughter: 'Bismuth-213' },
                    { nuclide: 'Bismuth-213', decayType: 'Beta-minus', halfLife: '45.6 minutes', daughter: 'Polonium-213' },
                    { nuclide: 'Polonium-213', decayType: 'Alpha', halfLife: '4.2 microseconds', daughter: 'Lead-209' },
                    { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                    { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                    { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                ]
            }
        ];

        /**
         * A comprehensive list of radionuclides pulled from the initial table above.
         */

        const radionuclides = RADIONUCLIDE_DATA;

        //==============================================================================
        // --- UTILITY & PARSER FUNCTIONS
        //==============================================================================

        /**
         * Normalizes a string by converting it to lowercase and removing spaces and hyphens.
         * @param {string} str - The input string.
         * @returns {string} The normalized string.
         */

        const normalizeString = (str) => (typeof str === 'string' ? str.toLowerCase().replace(/[\s-]/g, '') : '');

        /**
         * @description Creates a formatted string of key info for a nuclide tooltip.
         * @param {object} nuclide - The nuclide object.
         * @returns {string} A formatted string with half-life and emission types.
         */

        const generateQuickInfoText = (nuclide) => {
            if (!nuclide) return '';
            const halfLife = `Half-life: ${formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)))}`;
            const emissions = `Emissions: ${(nuclide.emissionType || []).join(', ')}`;
            return `${halfLife} | ${emissions}`;
        };

	/**
         * Implements the Bateman equations for a full decay series, including branching decays.
         * It iteratively builds an analytical solution for each nuclide as a sum of exponential terms.
         * @param {Array<object>} chain - The array of nuclide objects in the decay series.
         * @param {number} A1_0 - The initial activity of the parent nuclide.
         * @param {number} t_seconds - The elapsed time in seconds.
         * @returns {Array<number>} An array of activities for each nuclide in the chain at time t.
         */
        const runBatemanWithBranching = (chain, A1_0, t_seconds) => {
            const nuclideMap = new Map();

            // 1. Pre-process the chain into a graph-like map for easy lookup.
            chain.forEach(step => {
                const lambda = parseHalfLifeToSeconds(step.halfLife) === Infinity ? 0 : Math.log(2) / parseHalfLifeToSeconds(step.halfLife);
                if (!nuclideMap.has(step.nuclide)) {
                    nuclideMap.set(step.nuclide, { name: step.nuclide, lambda, parents: [], solution: [] });
                } else {
                    nuclideMap.get(step.nuclide).lambda = lambda;
                }

                if (step.daughter !== 'N/A') {
                    const decayTypes = step.decayType.split(' / ').map(s => s.trim());
                    const daughters = step.daughter.split(' / ').map(s => s.trim());
                    daughters.forEach((daughterName, i) => {
                        // Extract branching ratio if present, e.g., "Beta-minus (64.1%)"
                        const match = decayTypes[i] ? decayTypes[i].match(/\(([\d.]+)%\)/) : null;
                        const br = match ? parseFloat(match[1]) / 100.0 : 1.0;

                        if (!nuclideMap.has(daughterName)) {
                            nuclideMap.set(daughterName, { name: daughterName, lambda: 0, parents: [], solution: [] });
                        }
                        nuclideMap.get(daughterName).parents.push({ name: step.nuclide, br: br });
                    });
                }
            });

            // 2. Iteratively build the analytical solution for each nuclide.
            for (const step of chain) {
                const nuclideName = step.nuclide;
                const nuclide = nuclideMap.get(nuclideName);
                
                if (nuclide.parents.length === 0) { // This is the root parent
                    if (nuclide.lambda === 0) continue;
                    const N0 = A1_0 / nuclide.lambda;
                    nuclide.solution.push({ coeff: N0, lambda: nuclide.lambda });
                } else {
                    const solutionMap = new Map(); // Used to consolidate terms
                    for (const parent of nuclide.parents) {
                        const parentNuclide = nuclideMap.get(parent.name);
                        for (const term of parentNuclide.solution) {
                            const C = parent.br * parentNuclide.lambda * term.coeff;
                            
                            // Handle the case where decay constants are identical (or very close)
                            if (Math.abs(nuclide.lambda - term.lambda) < 1e-20) {
                                // This case leads to a t*e^(-lambda*t) term, which complicates the solution structure.
                                // For simplicity and to avoid a full rewrite, we'll approximate by introducing a tiny difference.
                                // This is a common numerical stability trick.
                                term.lambda *= (1 + 1e-9);
                            }

                            const coeff = C / (nuclide.lambda - term.lambda);
                            // Add the two new terms to the solution map, consolidating as we go
                            solutionMap.set(term.lambda, (solutionMap.get(term.lambda) || 0) + coeff);
                            solutionMap.set(nuclide.lambda, (solutionMap.get(nuclide.lambda) || 0) - coeff);
                        }
                    }
                    // Convert the map back to the solution array format
                    nuclide.solution = Array.from(solutionMap, ([lambda, coeff]) => ({ lambda, coeff }));
                }
            }

            // 3. Calculate the final activities at the specified time.
            const finalActivities = [];
            for (const step of chain) {
                const nuclide = nuclideMap.get(step.nuclide);
                if (nuclide.lambda === 0) {
                    finalActivities.push(0);
                    continue;
                }
                let N_t = 0;
                for (const term of nuclide.solution) {
                    N_t += term.coeff * Math.exp(-term.lambda * t_seconds);
                }
                const A_t = N_t * nuclide.lambda;
                finalActivities.push(A_t > 0 ? A_t : 0); // Ensure no negative activities from floating point errors
            }
            return finalActivities;
        };


	/**
         * Flattens a potentially nested decay chain into a simple, unique list of nuclides
         * for the Bateman calculator.
         * @param {Array<object>} chain - The potentially nested chain data.
         * @returns {Array<object>} A flat array of unique nuclide steps.
         */
        const flattenChainForCalculator = (chain) => {
            const seen = new Set();
            const flatChain = [];

            function recurse(steps) {
                if (!steps) return;
                for (const step of steps) {
                    if (!seen.has(step.nuclide)) {
                        flatChain.push(step);
                        seen.add(step.nuclide);
                    }
                    if (step.branches) {
                        step.branches.forEach(branch => recurse(branch));
                    }
                }
            }

            recurse(chain);
            return flatChain;
        };



        /**
         * Parses a half-life string (e.g., "1600 years") into a total number of seconds.
         * Handles various units, scientific notation, and the "Stable" keyword.
         * @param {string} halfLifeStr - The half-life string to parse.
         * @returns {number} The half-life in seconds, or Infinity for "Stable".
         */

const parseHalfLifeToSeconds = (halfLifeStr) => {
    if (!halfLifeStr || halfLifeStr.toLowerCase() === 'stable') return Infinity;

    const match = halfLifeStr.trim().match(/^(.*?)\s*([a-zA-Zμµ]+.*)$/);
    let numericStr, unitStr;
    if (match) {
        numericStr = match[1].trim();
        unitStr = match[2].trim();
    } else {
        numericStr = halfLifeStr.trim();
        unitStr = ''; 
    }

    let value;
    const sciNotationRegex = /([\d.,]+)\s*x\s*10\^?([⁻⁺\-−\d⁰¹²³⁴⁵⁶⁷⁸⁹]+)/i;
    const sciMatch = numericStr.match(sciNotationRegex);

    if (sciMatch) {
        const mantissa = parseFloat(sciMatch[1].replace(/,/g, ''));
        const exponentStr = sciMatch[2];
        const superToRegularMap = { '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9', '⁺': '+', '⁻': '-', '−': '-' };
        const regularExponentStr = [...exponentStr].map(char => superToRegularMap[char] || char).join('');
        const exponent = parseInt(regularExponentStr);
        if (!isNaN(mantissa) && !isNaN(exponent)) {
            value = mantissa * Math.pow(10, exponent);
        }
    } else {
        value = parseFloat(numericStr.replace(/,/g, ''));
    }

    if (isNaN(value)) return 0;

    const unit = unitStr.toLowerCase();
    const unitMultipliers = {
        'billion years': 3.15576e16,
        'million years': 3.15576e13,
        'kiloyears': 3.15576e10, // Note: The data does not contain this unit, but the logic is ready for it.
        'years': 31557600,
        'year': 31557600,
        'days': 86400,
        'day': 86400,
        'hours': 3600,
        'hour': 3600,
        'minutes': 60,
        'minute': 60,
        'seconds': 1,
        'second': 1,
        's': 1,
        'milliseconds': 1e-3,
        'millisecond': 1e-3,
        'microseconds': 1e-6,
        'microsecond': 1e-6,
    };
    
    // Sort keys by length in descending order to match 'billion years' before 'years'
    const sortedKeys = Object.keys(unitMultipliers).sort((a, b) => b.length - a.length);

    for (const key of sortedKeys) {
        if (unit.startsWith(key)) {
            return value * unitMultipliers[key];
        }
    }
    return value; 
};

	const getHalfLifeCategory = (seconds) => {
            if (seconds === Infinity) return { label: 'Stable', color: 'text-slate-500 dark:text-slate-400' };
            if (seconds < 3600) return { label: 'Very Short', color: 'text-red-500' }; // < 1 Hour
            if (seconds < 86400 * 2) return { label: 'Short', color: 'text-amber-500' }; // < 2 Days
            if (seconds < 31557600 * 10) return { label: 'Medium', color: 'text-sky-500' }; // < 10 Years
            if (seconds < 31557600 * 1000000) return { label: 'Long', color: 'text-indigo-500' }; // < 1 Million Years
            return { label: 'Geological', color: 'text-purple-500' };
        };

        /**
         * Parses a string to standardize its numeric part into "e" notation if it's very large or small.
         * Handles multiple formats: "1.23 x 10^4", "1.23 x 10⁻⁴", "4,059", and "0.0123".
         * @param {string} str - The input string (e.g., "1.55 x 10⁻¹⁰ year⁻¹").
         * @returns {string} The formatted string with standardized notation.
         */

/*
 * Parses a string to standardize its numeric part into "e" notation if it's very large or small.
 * Handles multiple formats: "1.23 x 10^4", "1.23 x 10⁻⁴", "4,059", and "0.0123".
 * @param {string} str - The input string (e.g., "1.55 x 10⁻¹⁰ year⁻¹").
 * @returns {string} The formatted string with standardized notation.
 */
const standardizeScientificDisplay = (str) => {
    if (typeof str !== 'string' || !str) return str;

    // A map to convert unicode superscripts and minus signs to standard characters.
    const superToRegularMap = { '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9', '⁺': '+', '⁻': '-', '−': '-' };

    // Regex to capture the mantissa, exponent (in any format), and any trailing units.
    const sciNotationRegex = /([\d.,]+)\s*x\s*10\^?([⁻⁺\-−\d⁰¹²³⁴⁵⁶⁷⁸⁹]+)\s*(.*)/;
    const sciMatch = str.match(sciNotationRegex);

    if (sciMatch) {
        const mantissa = parseFloat(sciMatch[1].replace(/,/g, ''));
        const exponentStr = sciMatch[2];
        const units = sciMatch[3] || '';

        const regularExponentStr = [...exponentStr].map(char => superToRegularMap[char] || char).join('');
        const exponent = parseInt(regularExponentStr);

        if (isNaN(mantissa) || isNaN(exponent)) return str;
        
        const numericValue = mantissa * Math.pow(10, exponent);
        return `${numericValue.toExponential(2)} ${units}`.trim();
    }

    // If not in scientific notation, handle it as a plain number.
    const plainNumberRegex = /^([-\d.,]+)(.*)/;
    const plainMatch = str.match(plainNumberRegex);
    if (plainMatch) {
        const numberPart = plainMatch[1].replace(/,/g, '');
        const units = plainMatch[2] || '';
        const numericValue = parseFloat(numberPart);
        if (isNaN(numericValue)) return str;

        const absValue = Math.abs(numericValue);
        if (numericValue === 0) return `0 ${units}`.trim();

        // Use exponential notation for very large or very small numbers.
        if (absValue > 10000 || absValue < 0.001) {
            return `${numericValue.toExponential(2)} ${units}`.trim();
        }
        // For other numbers, use a fixed precision.
        return `${numericValue.toPrecision(3)} ${units}`.trim();
    }

    return str;
};

        /**
         * Determines the most appropriate human-readable unit for a given duration in seconds.
         * @param {number} seconds - The duration in seconds.
         * @returns {string} The most fitting unit ('years', 'days', 'hours', 'minutes', or 'seconds').
         */

        const getBestHalfLifeUnit = (seconds) => {
            if (seconds === Infinity) return 'years';

            const secondsInMinute = 60;
            const secondsInHour = 3600;
            const secondsInDay = 86400;
            const secondsInYear = 31557600; // 365.25 days

            if (seconds >= secondsInYear) return 'years';
            if (seconds >= secondsInDay) return 'days';
            if (seconds >= secondsInHour) return 'hours';
            if (seconds >= secondsInMinute) return 'minutes';
            return 'seconds';
        };

        /**
         * Formats a half-life string into a specified target unit with appropriate precision.
         * @param {string} halfLifeStr - The original half-life string (e.g., "1.25 billion years").
         * @param {string} targetUnit - The desired unit for the output (e.g., 'years', 'days').
         * @returns {string} The formatted half-life string (e.g., "1.25e+9 years").
         */

const formatHalfLife = (halfLifeStr, targetUnit) => {
    const seconds = parseHalfLifeToSeconds(halfLifeStr);

    if (seconds === Infinity) return 'Stable';
    if (seconds === 0 || !halfLifeStr) return 'N/A';

    const unitConversions = {
        'seconds': 1,
        'minutes': 60,
        'hours': 3600,
        'days': 86400,
        'years': 31557600,
        'kiloyears': 3.15576e10, // Use standardized scientific notation
        'megayears': 3.15576e13,
        'gigayears': 3.15576e16,
    };

    const value = seconds / unitConversions[targetUnit];
    
    // Use the existing standardization function to format the output
    const formattedValue = standardizeScientificDisplay(`${value} ${targetUnit}`);
    
    return formattedValue;
};

        /**
         * Parses an array of energy strings and returns the primary energy value in MeV.
         * Assumes the first entry in the array is the most significant.
         * @param {string[]} energyArray - An array of energy strings (e.g., ["5.3 MeV", "5.2 MeV"]).
         * @returns {number} The energy value in MeV. Returns 0 if input is invalid.
         */

        const parseEnergyToMeV = (energyArray) => {
            if (!energyArray || energyArray.length === 0) return 0;
            const energyStr = energyArray[0];
            const parts = energyStr.split(' ');
            let value = parseFloat(parts[0]);

            if (isNaN(value)) return 0;

            const unit = parts[1]?.toLowerCase();
            if (unit && unit.includes('kev')) return value / 1000; // Convert keV to MeV
            return value;
        };

        /**
         * Parses a specific activity string, handling scientific notation (e.g., "3.7 x 10^10 Bq/g").
         * @param {string} saStr - The specific activity string.
         * @returns {number} The parsed specific activity as a number. Returns 0 if input is invalid.
         */

        const parseSpecificActivity = (saStr) => {
            if (!saStr) return 0;
            const parts = saStr.toLowerCase().split(' ');

            // Check for the specific "x 10^" format.

            if (parts.length < 3 || parts[1] !== 'x' || !parts[2].includes('10^')) {
                return parseFloat(saStr.replace(/,/g, '')); // Fallback for simple numbers.
            }

            const value = parseFloat(parts[0]);
            const exponent = parseInt(parts[2].split('^')[1]);

            if (isNaN(value) || isNaN(exponent)) return 0;

            return value * Math.pow(10, exponent);
        };


        //==============================================================================
        // --- REACT COMPONENTS & ICONS
        //==============================================================================

        /**
         * A simple SVG icon component.
         * @param {{path: string, className?: string}} props - Component props.
         * @param {string} props.path - The SVG path data for the icon.
         * @param {string} [props.className="w-5 h-5"] - Optional CSS classes.
         * @returns {JSX.Element} A React component rendering an SVG icon.
         */

        const Icon = ({ path, className = "w-5 h-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path d={path} />
            </svg>
        );

        /**
         * A mapping of icon names to their corresponding SVG path data.
         */

        const ICONS = {
    copy: "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-2-.9-2-2-2zm0 16H8V7h11v14z",
    check: "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z",
    specificActivity: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 12.5l-4-4 1.41-1.41L10 12.67l4.59-4.59L16 9.5l-6 6z",
    search: "M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A8 8 0 1 0 10 18zm0-14a6 6 0 1 1-6 6 6 6 0 0 1 6-6z",
    database: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z",
    converter: "M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z",
    calculator: "M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-2-.9-2-2-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm4 8H10v-2h2v2zm0-4H10v-2h2v2zm0-4H10V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z",
    home: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z",
    hourglass: "M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2H6z",
    radioactive: "M12 2a9.97 9.97 0 0 0-5.49 1.76L12 15.35l5.49-11.59A9.97 9.97 0 0 0 12 2zm-9.24 9a10.016 10.016 0 0 0 14.48 0L12 17.65l-9.24-6.65zM4.93 16.24l-2.17-1.45A10.003 10.003 0 0 0 12 22a10.003 10.003 0 0 0 9.24-7.21l-2.17 1.45L12 19.35l-7.07-3.11z",
    help: "M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z",
    clear: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
    filter: "M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z",
    sun: "M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zm-9-8c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zm0 16c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zM5.64 6.36c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 3.54c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41L5.64 6.36zm12.72 12.72c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41zM4.22 18.36c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41zM18.36 4.22c-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0z",
    moon: "M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-3.26-1.46-5.41-4.56-5.41-8.19 0-3.63 2.15-6.73 5.41-8.19A8.96 8.96 0 0012 3z",
    compare: "M9.01 14H2v2h7.01v3L13 15l-3.99-4v3zm5.98-12H22v2h-7.01v3L11 3l3.99 4V4z",
    activity: "M12 6.5c2.49 0 4.5 2.01 4.5 4.5s-2.01 4.5-4.5 4.5S7.5 13.49 7.5 11 9.51 6.5 12 6.5M12 5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0-2c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8z",
    doseRate: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z",
    mass: "M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm10 16H4V8h16v12z",
    series: "M21 8H3V6h18v2zm0 4H3v2h18v-2zm0 6H3v2h18v-2z",
    settings: "M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-2 11h4v-3h2v-2h-2v-2h-4v2h-2v2h2v3zm-4-7c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm8 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-4 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z",
    stopwatch: "M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.98-1.41-1.41l-1.42 1.42A8.962 8.962 0 0012 4c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-1.68-.46-3.24-1.25-4.55l.22-.16zm-1.07-1.01A6.995 6.995 0 115.34 19.66 6.995 6.995 0 0117.96 6.38z",
    transport: "M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z",
    settings: "M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-2 11h4v-3h2v-2h-2v-2h-4v2h-2v2h2v3zm-4-7c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm8 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-4 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z" // <-- ADD THIS PATH
};

//==============================================================================
        // --- GLOBAL SETTINGS & CONTEXT
        //==============================================================================

const SettingsContext = React.createContext();

const defaultSettings = {
    activity: 'mCi',
    doseRate: 'mrem/hr',
    distance: 'm',
};

const SettingsProvider = ({ children }) => {
    const [settings, setSettings] = React.useState(() => {
        try {
            const saved = localStorage.getItem('rad_tool_settings');
            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
        } catch (e) {
            return defaultSettings;
        }
    });

    const updateSettings = (newSettings) => {
        setSettings(prev => {
            const updated = { ...prev, ...newSettings };
            localStorage.setItem('rad_tool_settings', JSON.stringify(updated));
            return updated;
        });
    };

    return (
        <SettingsContext.Provider value={{ settings, updateSettings }}>
            {children}
        </SettingsContext.Provider>
    );
};

const CATEGORY_DESCRIPTIONS = {
    'Medical': 'Used for diagnosis, therapy, or medical research.',
    'Industrial': 'Used in manufacturing, gauging, sterilization, or other industrial processes.',
    'Natural': 'Occurs naturally in the environment or as part of a decay series.',
    'Stable/Reference': 'A stable isotope, often used as a reference or target material.',
};

const CATEGORY_STYLES = {
    'Medical':    {
        border: 'border-l-sky-400 dark:border-l-sky-600',
        hoverBg: 'hover:bg-sky-50 dark:hover:bg-sky-900/50'
    },
    'Industrial': {
        border: 'border-l-amber-400 dark:border-l-amber-600',
        hoverBg: 'hover:bg-amber-50 dark:hover:bg-amber-900/50'
    },
    'Natural':    {
        border: 'border-l-green-400 dark:border-l-green-600',
        hoverBg: 'hover:bg-green-50 dark:hover:bg-green-900/50'
    },
    'Stable/Reference': {
        border: 'border-l-slate-400 dark:border-l-slate-500',
        hoverBg: 'hover:bg-slate-50 dark:hover:bg-slate-800/50'
    },
    // A default style for any other categories
    'default': {
        border: 'border-l-slate-300 dark:border-l-slate-600',
        hoverBg: 'hover:bg-slate-50 dark:hover:bg-slate-800/50'
    }
};


        //==============================================================================
        // --- TOAST NOTIFICATION SYSTEM
        // Provides pop-up messages for user feedback (e.g., "Copied to clipboard").
        //==============================================================================

        /**
         * @description React Context to provide toast notification functions to any component.
         */

        const ToastContext = React.createContext();

        /**
         * @description Provider component that manages the state of toast notifications.
         * It renders the toasts and provides a function to add new ones.
         * @param {{children: React.ReactNode}} props - The child components that will have access to the context.
         */

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = React.useState([]);

            /**
             * Adds a new toast message to the list.
             * @param {string} message - The message to display in the toast.
             */

            const addToast = (message) => {
                const id = Date.now();
                setToasts(prevToasts => [...prevToasts, { id, message }]);
                // Automatically remove the toast after 3 seconds.
                setTimeout(() => {
                    removeToast(id);
                }, 3000);
            };

            /**
             * Removes a toast from the list by its ID.
             * @param {number} id - The unique ID of the toast to remove.
             */

            const removeToast = (id) => {
                setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}

                    {/* Container for all visible toast notifications */}

                    <div className="fixed bottom-4 right-4 z-50 space-y-2">
                        {toasts.map(toast => (
                            <div key={toast.id} className="animate-toast-in bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-800 px-4 py-3 rounded-lg shadow-lg flex items-center">
                                <Icon path={ICONS.check} className="w-5 h-5 mr-3 text-green-400" />
                                <span>{toast.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        /**
         * @description Custom hook to easily access the toast context's `addToast` function.
         * @returns {{addToast: (message: string) => void}}
         */

        const useToast = () => React.useContext(ToastContext);

        //==============================================================================
        // --- REUSABLE UI COMPONENTS
        //==============================================================================


        /**
         * @description Displays a compact summary of a nuclide's key properties within a calculator.
         * @param {{nuclide: object}} props - The nuclide object to display context for.
         */

         /**
         * @description Displays a compact summary of a nuclide's key properties within a calculator.
         * @param {{nuclide: object}} props - The nuclide object to display context for.
         */

        const NuclideContextDisplay = ({ nuclide }) => {
            if (!nuclide) return null;

            const properties = [
                { 
                    label: 'Half-life', 
                    value: formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife))), 
                    condition: nuclide.halfLife && nuclide.halfLife !== 'Stable' 
                },
                { 
                    label: 'β Eₘₐₓ', 
                    value: (nuclide.emissionEnergies?.beta || [])[0]?.replace(' (max)', ''),
                    condition: nuclide.emissionEnergies?.beta?.length > 0
                },
                { 
                    label: 'β Eₐᵥ₉', 
                    value: nuclide.avgBetaEnergy, 
                    condition: nuclide.avgBetaEnergy
                },
                { 
                    label: 'Γ Constant', 
                    value: nuclide.gammaConstant, 
                    condition: nuclide.gammaConstant 
                },
                { 
                    label: 'Emissions', 
                    value: (nuclide.emissionType || []).join(', '), 
                    condition: nuclide.emissionType?.length > 0
                },
                { 
                    label: 'Specific Activity', 
                    value: nuclide.specificActivity, 
                    condition: nuclide.specificActivity 
                },
            ];

            const availableProperties = properties.filter(p => p.condition);

            if (availableProperties.length === 0) return null;

            return (
                <div className="p-3 my-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg animate-fade-in text-xs">
                    <div className={`grid grid-cols-2 gap-x-4 gap-y-1`}>
                        {availableProperties.map(prop => (
                            <div key={prop.label} className="truncate">
                                <span className="font-semibold text-slate-500 dark:text-slate-400">{prop.label}: </span>
                                <span className="text-slate-700 dark:text-slate-200" title={prop.value}>{prop.value}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

const Tooltip = ({ text, children, widthClass = 'w-96' }) => {
    // State to manage visibility and position
    const [show, setShow] = React.useState(false);
    const [coords, setCoords] = React.useState({ x: 0, y: 0 });
    // A ref to get the position of the element that triggers the tooltip
    const triggerRef = React.useRef(null);

    const handleMouseEnter = () => {
        if (triggerRef.current) {
            const rect = triggerRef.current.getBoundingClientRect();
            // Calculate position: center of the trigger, just below it
            // We use rect.bottom which is relative to the viewport
            setCoords({
                left: rect.left + rect.width / 2,
                top: rect.bottom, // The corrected line: use rect.bottom, not rect.bottom + window.scrollY
            });
            setShow(true);
        }
    };

    const handleMouseLeave = () => {
        setShow(false);
    };

    // This is the actual tooltip content that will be "teleported"
    const tooltipElement = show && (
        ReactDOM.createPortal(
            <div
                style={{ top: coords.top, left: coords.left }}
                // We use translate to center the tooltip and push it down slightly
                className={`fixed top-0 left-0 -translate-x-1/2 translate-y-2 p-2 text-xs text-white bg-slate-800 dark:bg-slate-900 rounded-md shadow-lg z-50 transition-opacity duration-300 pointer-events-none ${widthClass} ${show ? 'opacity-100' : 'opacity-0'}`}
            >
                {text}
            </div>,
            // Teleport destination: the main body of the document
            document.body
        )
    );

    return (
        <>
            {/* This adds our mouse events and ref to the child element (the button or span) */}
            {React.cloneElement(children, {
                ref: triggerRef,
                onMouseEnter: handleMouseEnter,
                onMouseLeave: handleMouseLeave,
            })}
            {tooltipElement}
        </>
    );
};





        /**
         * @description A button that copies a given text string to the clipboard and shows a confirmation.
         * @param {{textToCopy: string}} props - The text to be copied.
         */

        const CopyButton = ({ textToCopy }) => {
            const [copied, setCopied] = React.useState(false);
            const { addToast } = useToast();

            const handleCopy = () => {
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        addToast('Copied to clipboard!');
                        setCopied(true);
                        // Revert the icon back to the copy icon after 2 seconds.
                        setTimeout(() => setCopied(false), 2000);
                    });
                }
            };
            
            return (
                <button onClick={handleCopy} className="p-2 text-slate-400 hover:text-sky-500 transition-colors" title="Copy to clipboard">
                    <Icon path={copied ? ICONS.check : ICONS.copy} className="w-5 h-5" />
                </button>
            );
        };

        /**
         * @description The main header for the application.
         * @param {{onHelpClick: () => void, theme: string, toggleTheme: () => void}} props - Handlers and state for help and theme toggling.
         */

const Header = ({ onHelpClick, theme, toggleTheme, onNavClick }) => (
    <header className="relative text-center p-4 md:p-6 border-b border-slate-200 dark:border-slate-700">
        
        <div className="absolute top-4 left-4">
            <Tooltip text="Open User Manual" widthClass="w-auto">
                <button onClick={onHelpClick} className="p-2 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open User Manual">
                    <Icon path={ICONS.help} className="w-6 h-6" />
                </button>
            </Tooltip>
        </div>

        <h1 className="text-xl md:text-3xl font-bold text-center text-gray-800">Health Physics Toolbox</h1>

        <p className="text-sm text-slate-500 dark:text-slate-400 mt-2">
            Version: {VERSION} | Last Updated: {LAST_UPDATED}
        </p>

<div className="absolute top-4 left-4 flex items-center gap-2">
    <Tooltip text="Open User Manual" widthClass="w-auto">
        <button onClick={onHelpClick} className="p-2 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open User Manual">
            <Icon path={ICONS.help} className="w-6 h-6" />
        </button>
    </Tooltip>
    <Tooltip text="Toggle Theme" widthClass="w-auto">
        <button onClick={toggleTheme} className="p-2 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Toggle dark mode">
            <Icon path={theme === 'dark' ? ICONS.sun : ICONS.moon} className="w-6 h-6" />
        </button>
    </Tooltip>
</div>

<div className="absolute top-4 right-4 flex items-center gap-2">
    <a href="https://www.buymeacoffee.com/jough" target="_blank" className="hidden md:block">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} />
    </a>
    {/* The new settings button */}
    <Tooltip text="Settings" widthClass="w-auto">
        <button onClick={() => onNavClick('settings')} className="p-2 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open settings panel">
            <Icon path={ICONS.settings} className="w-6 h-6" />
        </button>
    </Tooltip>
</div>
    </header>
);

        /**
         * @description The primary search input with auto-suggestions.
         * @param {object} props - Contains all state and handlers for the search functionality.
         * @param {string} props.nuclideName - The current value of the search input.
         * @param {React.RefObject} props.inputRef - Ref for the input element.
         * @param {(e: React.ChangeEvent) => void} props.handleNuclideNameChange - Handler for input changes.
         * @param {(e: React.KeyboardEvent) => void} props.handleKeyDown - Handler for keyboard events (arrow keys, Enter).
         * @param {() => void} props.onClear - Handler to clear the search input.
         * @param {Array<object>} props.suggestions - The list of suggestion items.
         * @param {number} props.activeSuggestionIndex - The index of the currently highlighted suggestion.
         * @param {React.RefObject} props.suggestionsRef - Ref for the suggestions list container.
         * @param {(nuclide: object) => void} props.handleNuclideSelection - Handler for when a nuclide is selected.
         */

const SearchBar = ({ nuclideName, inputRef, handleNuclideNameChange, handleKeyDown, onClear, suggestions, activeSuggestionIndex, suggestionsRef, handleNuclideSelection, onNavClick }) => (
    <div className="relative p-4 flex items-center gap-2">
        {/* --- NEW Home Button --- */}
<button 
    onClick={() => onNavClick('home')} 
    className="hidden md:block p-3 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" 
    aria-label="Home"
>
    <Icon path={ICONS.home} className="w-5 h-5" />
</button>

        {/* --- Existing Search Input --- */}
        <div className="relative flex-grow">
            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Icon path={ICONS.search} className="w-5 h-5 text-slate-400" />
            </div>
            <input
                ref={inputRef}
                type="text"
                value={nuclideName}
                onChange={handleNuclideNameChange}
                onKeyDown={handleKeyDown}
                placeholder="Search by name or symbol (e.g., U-238)"
                className="w-full p-3 pl-10 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition"
            />
            {nuclideName && (             
	 	<button onClick={onClear} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-sky-500 focus:outline-none">
                    <Icon path={ICONS.clear} className="w-5 h-5" />
                </button>
            )}
        </div>
        {suggestions.length > 0 && (
            <ul ref={suggestionsRef} className="absolute z-20 top-full left-4 right-4 mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                {suggestions.map((s, i) => (
                    <li
                        key={s.symbol}
                        className={`p-3 cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-sky-100 dark:hover:bg-sky-900 ${i === activeSuggestionIndex ? 'bg-sky-100 dark:bg-sky-900' : ''}`}
                        onClick={() => handleNuclideSelection(s)}
                    >
                        {s.name} ({s.symbol}) <span className="text-xs text-slate-500 dark:text-slate-400">{s.commonality}</span>
                    </li>
                ))}
            </ul>
        )}
    </div>
);



        /**
         * @description The main navigation bar, which is responsive for mobile and desktop.
         * @param {{activeView: string, onNavClick: (view: string) => void}} props - The currently active view and the click handler.
         */

const MainNav = ({ activeView, onNavClick }) => {
    const navItems = [ 
        {id: 'home', label: 'Home', icon: ICONS.home },
        { id: 'database', label: 'Database', icon: ICONS.database }, 
        { id: 'compare', label: 'Compare', icon: ICONS.compare }, 
        { id: 'calculator', label: 'Decay', icon: ICONS.calculator }, 
        { id: 'mda', label: 'MDA', icon: ICONS.search },
		{ id: 'marssim', label: 'MARSSIM Samples', icon: ICONS.calculator },
        { id: 'wrs', label: 'WRS Test', icon: ICONS.database },
        { id: 'emc', label: 'EMC Sign Test', icon: ICONS.search },
        { id: 'seriesCalculator', label: 'Series Decay', icon: ICONS.series }, 
        { id: 'equilibrium', label: 'Equilibrium', icon: ICONS.activity },
        { id: 'massActivity', label: 'Mass ↔ Activity', icon: ICONS.mass }, 
        { id: 'specificActivity', label: 'Specific Activity', icon: ICONS.specificActivity },
        { id: 'doseRate', label: 'Dose Rate', icon: ICONS.doseRate }, 
        { id: 'shielding', label: 'Shielding', icon: ICONS.doseRate },
        { id: 'stayTime', label: 'Stay Time', icon: ICONS.stopwatch },
		{ id: 'transportation', label: 'Transportation', icon: ICONS.transport },
        { id: 'converter', label: 'Converter', icon: ICONS.converter }
    ];

    const NavButton = ({ item }) => (
        // The outer button is the full-width clickable area
        <button
            onClick={() => onNavClick(item.id)}
            className="flex-shrink-0 w-full"
        >
            {/* This inner span contains the visual styles */}
            <span
                 className={`mx-auto flex items-center justify-center gap-2 px-2 py-2 text-sm font-semibold rounded-md transition-all duration-200 ${
                    activeView === item.id 
                        ? 'bg-white dark:bg-slate-900 text-sky-600 dark:text-sky-400 shadow' 
                        : 'text-slate-600 dark:text-slate-300 hover:bg-sky-100 dark:hover:bg-sky-800 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md hover:-translate-y-1'
                }`}
            >
                <Icon path={item.icon} className="w-4 h-4" />
                <span className="truncate">{item.label}</span>
            </span>
        </button>
    );

    return (
        <div className="px-4 pb-2">

            {/* Mobile: Grid Menu. */}

<div className="md:hidden">
    <div className="grid grid-cols-2 gap-4">
        {navItems.map(item => (
            <button
                key={item.id}
                onClick={() => onNavClick(item.id)}
                // ADD THE HIGHLIGHTED PART TO THIS CLASSNAME
                className={`flex flex-col items-center justify-center p-4 rounded-lg text-center transition-colors ${
                    activeView === item.id
                        ? 'bg-sky-100 dark:bg-sky-900/50 text-sky-600 dark:text-sky-400'
                        : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-sky-100 dark:hover:bg-sky-900/50'
                } ${item.id === 'home' ? 'col-span-2' : ''}`}
            >
                <Icon path={item.icon} className="w-8 h-8 mb-2" />
                <span className="text-sm font-semibold">{item.label}</span>
            </button>
        ))}
    </div>
</div>

{/* Desktop: Grid */}
<div className="hidden md:grid grid-cols-4 gap-2">
    {navItems.filter(item => item.id !== 'home').map(item => <NavButton key={item.id} item={item} />)}
</div>
        </div>
    );
};

        //==============================================================================
        // --- VIEW COMPONENTS
        // These components represent the main content areas of the application.
        //==============================================================================





/**
 * @description The landing page view, showing suggestions, search history, favorites, or the main search result.
 * @param {object} props - Contains data and handlers for the home page.
 */

const HomePage = ({ errorMessage, randomSuggestions, searchHistory, handleNuclideSelection, handleClearHistory, favorites, radionuclides, handleClearFavorites }) => {
    
    // Find the full nuclide objects for our favorite symbols
    const favoriteNuclides = React.useMemo(() => 
        favorites.map(symbol => radionuclides.find(n => n.symbol === symbol)).filter(Boolean),
        [favorites, radionuclides]
    );

    // Find the full nuclide objects for our search history symbols
    const searchHistoryNuclides = React.useMemo(() => 
        searchHistory.map(symbol => radionuclides.find(n => n.symbol === symbol)).filter(Boolean),
        [searchHistory, radionuclides]
    );

    return (
        <div className="p-4 sm:p-6 space-y-6">
            {errorMessage && (
                <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                    <p className="font-bold">Error</p><p>{errorMessage}</p>
                </div>
            )}

            {/* --- Suggestions Card --- */}
            <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl">
                <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 text-left">Quick Suggestions</h4>
                <div className="flex flex-wrap justify-center gap-3">
                    {randomSuggestions.map(n => (
                        <button 
                            key={n.symbol} 
                            onClick={() => handleNuclideSelection(n)} 
                            className="px-4 py-2 bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200 text-sm font-semibold rounded-full hover:bg-sky-200 dark:hover:bg-sky-800 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md">
                            {n.name}
                        </button>
                    ))}
                </div>
            </div>

            {/* --- Favorites Card --- */}
            {favoriteNuclides.length > 0 && (
                <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Your Favorites</h4>
                        <button onClick={handleClearFavorites} className="text-xs text-sky-600 dark:text-sky-400 hover:underline focus:outline-none">
                            Clear Favorites
                        </button>
                    </div>
                    <div className="flex flex-wrap justify-center gap-3">
                        {favoriteNuclides.map(n => (
                            <button 
                                key={n.symbol} 
                                onClick={() => handleNuclideSelection(n)} 
                                className="px-4 py-2 bg-yellow-100 dark:bg-yellow-400/20 text-yellow-800 dark:text-yellow-200 text-sm font-semibold rounded-full hover:bg-yellow-200 dark:hover:bg-yellow-400/30 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md">
                                {n.name}
                            </button>
                        ))}
                    </div>
                </div>
            )}
        
            {/* --- Recent Searches Card --- */}
            {searchHistoryNuclides.length > 0 && (
                <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Recent Searches</h4>
                        <button onClick={handleClearHistory} className="text-xs text-sky-600 dark:text-sky-400 hover:underline focus:outline-none">
                            Clear History
                        </button>
                    </div>
                    <div className="flex flex-wrap justify-center gap-3">
                        {searchHistoryNuclides.map(n => (
                            <button 
                                key={n.symbol} 
                                onClick={() => handleNuclideSelection(n)} 
                                className="px-4 py-2 bg-white dark:bg-slate-700/80 text-slate-700 dark:text-slate-200 text-sm font-semibold rounded-full hover:bg-slate-200 dark:hover:bg-slate-600/80 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md">
                                {n.name}
                            </button>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

        /**
         * @description Displays information about a single radionuclide. Can be a full detailed card or a compact version for lists.
         * @param {object} props - Component props.
         * @param {object} props.nuclide - The nuclide data object.
         * @param {boolean} [props.isCompact=false] - If true, renders a smaller card.
         * @param {(nuclide: object) => void} [props.onNuclideClick] - Click handler for the compact card.
         * @param {(seriesId: string) => void} [props.onDecaySeriesClick] - Click handler for the 'View Decay Series' button.
         * @param {string} [props.displayHalfLifeUnit] - The unit to display the half-life in for the detailed card.
         */




const NuclideCard = ({ nuclide, radionuclides, isCompact = false, onNuclideClick, onDecaySeriesClick, displayHalfLifeUnit, favorites, toggleFavorite, onSendToCalculator, onAddToCompare, showBackButton, onBackClick }) => {

    const ClickableNuclide = ({ text }) => {
        if (!text || !onNuclideClick) return <span>{text}</span>;
        
        // Find the nuclide name, which is usually the first part of the string
        const nuclideName = text.split('(')[0].trim();
        const foundNuclide = radionuclides.find(n => n.name === nuclideName || n.symbol === nuclideName);

        if (foundNuclide) {
            return (
                <button 
                    onClick={() => onNuclideClick(foundNuclide)} 
                    className="text-sky-500 hover:underline font-semibold"
                >
                    {text}
                </button>
            );
        }
        return <span>{text}</span>; // Return plain text if not found
    };

    const getSourceLink = (sourceKey) => {
        const source = sources[sourceKey];
        return source ? <a href={source.url} target="_blank" rel="noopener noreferrer" className="text-sky-500 hover:underline" title={source.name}>[{Object.keys(sources).indexOf(sourceKey) + 1}]</a> : '';
    };

const DataPoint = ({ label, value, unit, sourceKey, iconPath, iconSymbol }) => {
        const displayValue = value && (typeof value === 'string' || typeof value === 'number' || React.isValidElement(value)) ? value : 'N/A';
        // CORRECTED LINE: Check if the displayValue is 'None' before deciding to append the unit
        const shouldAppendUnit = unit && typeof displayValue === 'string' && displayValue !== 'N/A' && displayValue.toLowerCase() !== 'none' && !displayValue.toLowerCase().includes(unit.toLowerCase());

        return (
            <div className="flex items-start">
                {iconPath && <Icon path={iconPath} className="w-5 h-5 text-sky-500 mr-3 flex-shrink-0 mt-1" />}
                {iconSymbol && <span className="text-2xl font-serif text-sky-500 mr-3 -mt-1 w-5 text-center">{iconSymbol}</span>}
                <div>
                    <p className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</p>

                    <p className="text-base font-semibold text-slate-800 dark:text-slate-100 flex items-center flex-wrap">
                        {(label === 'Parent' || label === 'Daughter') ? <ClickableNuclide text={displayValue} /> : displayValue}
                        {shouldAppendUnit ? <span className="ml-1">{unit}</span> : ''}
                        {sourceKey && <sup className="ml-1"> {getSourceLink(sourceKey)}</sup>}
                    </p>

                </div>
            </div>
        );
    };

    if (isCompact) {
        const styles = CATEGORY_STYLES[nuclide.category] || CATEGORY_STYLES['default'];
        const hlCategory = getHalfLifeCategory(parseHalfLifeToSeconds(nuclide.halfLife));
        
        const compactCardJSX = (
            <div 
                onClick={() => onNuclideClick(nuclide)} 
                className={`flex flex-col justify-between p-4 h-full bg-white dark:bg-slate-800 rounded-lg shadow-md hover:shadow-lg hover:ring-2 hover:ring-sky-500 cursor-pointer transition-all duration-200 border-l-4 ${styles.border} ${styles.hoverBg}`}
            >
                <div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-lg text-slate-800 dark:text-white">{nuclide.name} <span className="text-slate-500 font-normal">({nuclide.symbol})</span></h3>
                        <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${hlCategory.color} bg-opacity-10`}>{hlCategory.label}</span>
                    </div>
                    <div className="flex items-baseline text-sm mt-2"><Icon path={ICONS.hourglass} className="w-4 h-4 text-slate-400 mr-2"/><span className="font-medium text-slate-600 dark:text-slate-300">{formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)))}</span></div>
                    <div className="flex items-baseline text-sm mt-1"><Icon path={ICONS.radioactive} className="w-4 h-4 text-slate-400 mr-2"/><span className="text-slate-500 dark:text-slate-400">{(nuclide.emissionType || []).slice(0, 2).join(', ')}</span></div>
                </div>
                
                <div className="flex items-center gap-1 text-xs font-semibold text-slate-600 dark:text-slate-400 mt-3 pt-2 border-t border-slate-200 dark:border-slate-700">
                    <span>{nuclide.category} - {nuclide.commonality}</span>
                </div>
            </div>
        );

        return nuclide.commonalityReason ? (
            <Tooltip text={nuclide.commonalityReason} widthClass="w-96">
                {compactCardJSX}
            </Tooltip>
        ) : (
            compactCardJSX
        );
    }

    const isFavorite = favorites?.includes(nuclide.symbol);
    const hlCategory = getHalfLifeCategory(parseHalfLifeToSeconds(nuclide.halfLife));

    return (
        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 animate-fade-in">

            <div className="flex justify-between items-start">
                <div className="flex items-center gap-2">
                    <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
                        <a href={`https://en.wikipedia.org/wiki/${nuclide.name.replace(/ /g, '_')}`} target="_blank" rel="noopener noreferrer" className="hover:text-sky-500 hover:underline transition-colors">
                            {nuclide.name}
                        </a>
                        ({nuclide.symbol})
                    </h2>
                    <span className="text-sm font-medium text-sky-600 dark:text-sky-400 bg-sky-100 dark:bg-sky-900/50 px-3 py-1 rounded-full whitespace-nowrap">
                        {nuclide.category} - {nuclide.commonality}
                    </span>
                </div>
                
                <div className="flex items-center gap-2 mt-1">
                    {showBackButton && (
                        <button 
                            onClick={onBackClick} 
                            className="p-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition flex items-center gap-2 text-sm"
                        >
                            <Icon path={ICONS.database} className="w-4 h-4" />
                            Back
                        </button>
                    )}
                    {toggleFavorite && (
                        <button onClick={() => toggleFavorite(nuclide.symbol)} className={`p-2 rounded-full transition-colors ${isFavorite ? 'text-yellow-400 hover:text-yellow-500' : 'text-slate-300 dark:text-slate-600 hover:text-yellow-400'}`} title={isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-8 h-8">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                        </button>
                    )}
                </div>
            </div>
            <div className="grid md:grid-cols-2 gap-6 mt-4">
                <DataPoint 
                    label="Half-life"
                    value={<>
                        {formatHalfLife(nuclide.halfLife, displayHalfLifeUnit)}
                        <span className={`ml-2 text-xs font-bold px-2 py-0.5 rounded-full ${hlCategory.color} bg-opacity-10`}>{hlCategory.label}</span>
                    </>}
                    sourceKey={nuclide.sourceRef?.halfLife}
                    iconPath={ICONS.hourglass}
                />
                <DataPoint label="Decay Constant (λ)" value={standardizeScientificDisplay(nuclide.decayConstant)} sourceKey={nuclide.sourceRef?.decayConstant} iconSymbol="λ" />
                <DataPoint label="Specific Activity" value={standardizeScientificDisplay(nuclide.specificActivity)} sourceKey={nuclide.sourceRef?.specificActivity} iconPath={ICONS.activity} />
                <DataPoint label="Emission Type(s)" value={(nuclide.emissionType || []).join(', ')} sourceKey={nuclide.sourceRef?.emissionType} iconPath={ICONS.radioactive} />
                

                <DataPoint label="Parent" value={nuclide.parent} sourceKey={nuclide.sourceRef?.parent} onNuclideClick={onNuclideClick} radionuclides={radionuclides} />
                <DataPoint label="Daughter" value={nuclide.daughter} sourceKey={nuclide.sourceRef?.daughter} onNuclideClick={onNuclideClick} radionuclides={radionuclides} />

                {nuclide.gammaConstant && (
                    <DataPoint label="Gamma Constant" value={nuclide.gammaConstant} sourceKey={nuclide.sourceRef?.gammaConstant} />
                )}
            </div>
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Principal Emissions</h3>
                <div className="space-y-4">
                    <div>
                        <p className="text-sm font-medium text-slate-500 dark:text-slate-400">From Parent ({nuclide.symbol})</p>
                        <div className="grid md:grid-cols-3 gap-4 mt-1">
                            <DataPoint label="Alpha" value={(nuclide.emissionEnergies?.alpha || []).join(', ') || 'None'} unit="MeV" iconSymbol="α"/>
                            
                            <DataPoint label="Beta" value={`${(nuclide.emissionEnergies?.beta || []).join(', ') || 'None'}${nuclide.avgBetaEnergy ? ` (${nuclide.avgBetaEnergy} avg)` : ''}`} unit="MeV" iconSymbol="β"/>

                            <DataPoint label="Gamma" value={(nuclide.emissionEnergies?.gamma || []).join(', ') || 'None'} unit="MeV" iconSymbol="γ"/>
                        </div>
                    </div>

                    {nuclide.daughterEmissions && (
                         <div className="animate-fade-in">
                            <p className="text-sm font-medium text-slate-500 dark:text-slate-400">
                                From Daughter (
                                <button 
                                    onClick={() => {
                                        const daughter = radionuclides.find(n => n.symbol === nuclide.daughterEmissions.from);
                                        if (daughter && onNuclideClick) onNuclideClick(daughter);
                                    }}
                                    className="text-sky-500 hover:underline font-semibold disabled:text-slate-400 disabled:no-underline"
                                    disabled={!onNuclideClick}
                                >
                                    {nuclide.daughterEmissions.from}
                                </button>
                                )
                            </p>
                            <div className="grid md:grid-cols-3 gap-4 mt-1">
                                <DataPoint label="Alpha" value={(nuclide.daughterEmissions.alpha || []).join(', ') || 'None'} unit="MeV" iconSymbol="α"/>
                                <DataPoint label="Beta" value={(nuclide.daughterEmissions.beta || []).join(', ') || 'None'} unit="MeV" iconSymbol="β"/>
                                <DataPoint label="Gamma" value={(nuclide.daughterEmissions.gamma || []).join(', ') || 'None'} unit="MeV" iconSymbol="γ"/>
                            </div>
                        </div>
                    )}
                </div>
            </div>
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Common Uses</h3>
                <ul className="list-disc list-inside text-slate-600 dark:text-slate-300 space-y-1">
                    {(nuclide.commonUses || []).map((use, i) => <li key={i}>{use}</li>)}
                </ul>
            </div>
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Quick Actions</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                    <button onClick={() => onAddToCompare(nuclide.symbol)} className="p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition">Add to Compare</button>
                    <button onClick={() => onSendToCalculator('calculator', nuclide.symbol)} className="p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition">Decay Calc</button>
                    {nuclide.shipping && (
                         <button onClick={() => onSendToCalculator('transportation', nuclide.symbol)} className="p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition">Shipping</button>
                    )}
                </div>
            </div>
            {nuclide.decaySeriesId && (
                <div className="mt-6 text-center">
                    <button onClick={() => onDecaySeriesClick(nuclide.decaySeriesId)} className="px-4 py-2 bg-slate-700 text-white rounded-lg font-semibold hover:bg-slate-800 transition">View Full Decay Series</button>
                </div>
            )}
        </div>
    );
};

        /**
         * @description Displays a full decay series chain.
         * @param {{seriesId: string, onBack: () => void, onNuclideClick: (nuclide: object) => void}} props - The series ID and navigation handlers.
         */

	    const DecaySeriesViewer = ({ seriesId, onBack, onNuclideClick }) => {
            const series = decaySeriesData.find(s => s.id === seriesId);
            if (!series) return <p>Decay series not found.</p>;

            // Reusable internal components
            const NuclideNode = ({ step }) => (
                <div className="p-3 my-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-center shadow flex-shrink-0">
                    <span
                        className="font-bold text-sky-600 dark:text-sky-400 cursor-pointer hover:underline"
                        onClick={() => {
                            const found = radionuclides.find(n => normalizeString(n.name) === normalizeString(step.nuclide));
                            if (found) onNuclideClick(found);
                        }}
                    >
                        {step.nuclide}
                    </span>
                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">{step.halfLife}</div>
                </div>
            );

            const DecayArrow = ({ decayType }) => (
                <div className="flex-grow flex items-center justify-center relative mx-2 h-12">
                    <div className="absolute left-0 top-1/2 w-full h-0.5 bg-slate-300 dark:bg-slate-600"></div>
                    <div className="relative bg-white dark:bg-slate-800 px-2 text-center">
                        <span className="text-sm font-semibold text-slate-600 dark:text-slate-300">{decayType}</span>
                        <span className="text-slate-400 block -mt-1">&rarr;</span>
                    </div>
                </div>
            );
            
            // Recursive component to render a chain or sub-chain
            const RenderChain = ({ chain }) => (
                <>
                    {chain.map((step, index) => (
                        <div key={step.nuclide + index} className="flex flex-col items-center">
                            <NuclideNode step={step} />
                            
                            {/* If the step has branches, render them side-by-side */}
                            {step.branches && (
                                <div className="flex justify-around w-full border-l border-r border-slate-300 dark:border-slate-600 rounded-b-lg">
                                    {step.branches.map((branch, branchIndex) => (
                                        <div key={branchIndex} className="flex flex-col items-center p-2">
                                            {/* Extract decay type for this specific branch */}
                                            <DecayArrow decayType={step.decayType.split('/')[branchIndex]?.trim() || ''} />
                                            <RenderChain chain={branch} />
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {/* If it's a linear step, render the arrow to the next step */}
                            {!step.branches && index < chain.length - 1 && chain[index+1].nuclide !== step.nuclide && (
                                <DecayArrow decayType={step.decayType} />
                            )}
                        </div>
                    ))}
                </>
            );

            return (
                <div className="p-4 animate-fade-in">
                    <button onClick={onBack} className="mb-4 px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition">&larr; Back to Result</button>
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">{series.name}</h2>
                        <div className="overflow-x-auto pb-4">
                           <div className="inline-block min-w-full">
                                <RenderChain chain={series.chain} />
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * @description A sidebar for filtering and sorting the nuclide database. It is responsive.
         * @param {{filterProps: object, isFiltersVisible: boolean, setIsFiltersVisible: (isVisible: boolean) => void}} props
         */

const FilterSidebar = ({ filterProps, isFiltersVisible, setIsFiltersVisible, scrollPositionRef }) => {

    const {
        sortBy, setSortBy, sortOrder, setSortOrder,
        selectedCategory, setSelectedCategory, allCategories,
        selectedEmissionType, setSelectedEmissionType, allEmissionTypes,
        selectedCommonality, setSelectedCommonality, allCommonalityCategories,
        minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy,
        minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy,
        minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy,
        minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit,
        // New prop: a function to clear all filters
        clearFilters
    } = filterProps;

    const handleClose = () => {
        setIsFiltersVisible(false);
        setTimeout(() => {
            window.scrollTo({
                top: scrollPositionRef.current,
                behavior: 'smooth'
            });
        }, 300);
    };

    const handleClear = () => {
        clearFilters();
        // You can keep the sidebar open or close it after clearing. Closing might be better for mobile UX.
        // setIsFiltersVisible(false);
    };

    return (
        <>
            <div
                className={`fixed inset-0 bg-black/50 z-40 lg:hidden transition-opacity ${isFiltersVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                onClick={handleClose}
                aria-hidden="true">
            </div>

            <aside
                className={`fixed top-0 left-0 w-80 h-full bg-slate-50 dark:bg-slate-900 z-50 transform transition-transform duration-300 ease-in-out lg:relative lg:w-auto lg:h-auto lg:transform-none lg:col-span-1 ${
                    isFiltersVisible ? 'translate-x-0' : '-translate-x-full'
                }`}
            >
                <div className="p-4 space-y-4 h-full overflow-y-auto">
                    <div className="flex justify-between items-center border-b border-slate-300 dark:border-slate-600 pb-2">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white">Filters & Sorting</h3>
                        <div className="flex items-center gap-2">
                            <Tooltip text="Clear Filters" widthClass="w-auto">
                                <button onClick={handleClear} className="p-1 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700">
                                    <Icon path={ICONS.clear} className="w-6 h-6" />
                                </button>
                            </Tooltip>
                            <button onClick={handleClose} className="lg:hidden p-1 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700">
                                <Icon path={ICONS.clear} className="w-6 h-6" />
                            </button>
                        </div>
                    </div>

                    {/* Sorting controls */}
                    <div>
                        <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Sort by</label>
                        <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                            <option value="name">Name</option>
                            <option value="halfLife">Half-life</option>
                            <option value="alphaEnergy">Alpha Energy</option>
                            <option value="betaEnergy">Beta Energy</option>
                            <option value="gammaEnergy">Gamma Energy</option>
                        </select>
                        <select value={sortOrder} onChange={e => setSortOrder(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>

                    {/* Filtering controls */}
                    <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Category</label><select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                    <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Emission Type</label><select value={selectedEmissionType} onChange={e => setSelectedEmissionType(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allEmissionTypes.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                    <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Commonality</label><select value={selectedCommonality} onChange={e => setSelectedCommonality(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allCommonalityCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                    
                    {/* Half-life range filter */}
                    <div>
                        <h4 className="text-md font-semibold text-slate-700 dark:text-slate-300 mt-4">Half-life</h4>
                        <div className="flex gap-2 mt-2">
                            <input type="number" placeholder="Min" value={minHalfLife} onChange={e => setMinHalfLife(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                            <input type="number" placeholder="Max" value={maxHalfLife} onChange={e => setMaxHalfLife(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                        </div>
                        <select value={halfLifeFilterUnit} onChange={e => setHalfLifeFilterUnit(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                            <option value="seconds">Seconds</option>
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                            <option value="years">Years</option>
                        </select>
                    </div>

                    {/* Energy range filters */}
                    <div>
                        <h4 className="text-md font-semibold text-slate-700 dark:text-slate-300 mt-4">Energy (MeV)</h4>
                        <div className="space-y-2 mt-2">
                            <label className="text-sm">Alpha</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minAlphaEnergy} onChange={e => setMinAlphaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxAlphaEnergy} onChange={e => setMaxAlphaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                            <label className="text-sm">Beta</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minBetaEnergy} onChange={e => setMinBetaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxBetaEnergy} onChange={e => setMaxBetaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                            <label className="text-sm">Gamma</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minGammaEnergy} onChange={e => setMinGammaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxGammaEnergy} onChange={e => setMaxGammaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                        </div>
                    </div>
                </div>
            </aside>
        </>
    );
};
        
        /**
         * @description The main view for Browse the entire database with filters.
         * @param {object} props - Component props.
         * @param {Array<object>} props.filteredList - The list of nuclides after filtering and sorting.
         * @param {object} props.filterProps - All state and handlers related to filtering.
         * @param {(nuclide: object) => void} props.onNuclideClick - Handler for when a compact nuclide card is clicked.
         * @param {boolean} props.isFiltersVisible - State for mobile filter visibility.
         * @param {(isVisible: boolean) => void} props.setIsFiltersVisible - Handler to toggle mobile filter visibility.
         */

const DatabaseView = ({ filteredList, filterProps, onNuclideClick, isFiltersVisible, setIsFiltersVisible, scrollPositionRef, handleClearFilters }) => {

    const { selectedCategory, setSelectedCategory } = filterProps;

return (
        <div className="relative">
            <div className="px-4 pt-4 lg:hidden">
<button
    onClick={() => {
        scrollPositionRef.current = window.scrollY;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setIsFiltersVisible(true);
    }}
    className="w-full flex items-center justify-center gap-2 ...">
    <Icon path={ICONS.filter} className="w-5 h-5" /> Filters & Sorting
</button>
</div>

            <div className="grid lg:grid-cols-4 gap-4 p-4">
                
                {/* --- THIS IS THE CORRECTED LINE --- */}
<FilterSidebar
    filterProps={{
        ...filterProps,
        clearFilters: handleClearFilters // Pass the new function down
    }}
    isFiltersVisible={isFiltersVisible}
    setIsFiltersVisible={setIsFiltersVisible}
    scrollPositionRef={scrollPositionRef}
/>
                
                <div className="col-span-4 lg:col-span-3 bg-slate-100 dark:bg-slate-800/50 rounded-lg p-4 h-[calc(100vh-350px)] md:h-[calc(100vh-320px)] lg:h-auto overflow-y-auto">
                    
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <p className="text-sm text-slate-500 dark:text-slate-400 flex-shrink-0">
                            Showing {filteredList.length} of {radionuclides.length} nuclides.
                        </p>
                        
                        <div className="flex flex-wrap items-center gap-x-3 gap-y-2 text-xs">
                            {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                const bgColor = styles.border.replace('border-l-', 'bg-');
                                const isActive = selectedCategory === category;
                                return (
                                    <button 
                                        key={category}
                                        onClick={() => setSelectedCategory(prev => prev === category ? 'All' : category)}
                                        className={`flex items-center gap-1.5 px-2 py-1 rounded-full transition-all duration-200 ${isActive ? 'ring-2 ring-offset-2 ring-offset-slate-100 dark:ring-offset-slate-800 ring-sky-500 bg-white dark:bg-slate-700' : 'bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700'}`}
                                    >
                                        <div className={`w-3 h-3 rounded-full ${bgColor}`}></div>
                                        <span className="text-slate-600 dark:text-slate-300">{category.replace('/', '/ ')}</span>
                                    </button>
                                );
                            })}
                            
                            <button
                                onClick={() => setSelectedCategory('All')}
                                className={`px-2 py-1 rounded-full transition-all duration-200 text-slate-600 dark:text-slate-300 ${selectedCategory === 'All' ? 'ring-2 ring-offset-2 ring-offset-slate-100 dark:ring-offset-slate-800 ring-slate-500 bg-white dark:bg-slate-700' : 'bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700'}`}
                            >
                                Show All
                            </button>
                        </div>
                    </div>

                    <div className="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                        {filteredList.map(n => <NuclideCard key={n.symbol} nuclide={n} isCompact={true} onNuclideClick={onNuclideClick} />)}
                    </div>
                </div>
            </div>
        </div>
    );
};

        /**
         * @description A component that provides a user interface for converting between
         * various radiological and physical units, such as activity, dose, and energy.
         */

const UnitConverter = () => {

    // --- STATE MANAGEMENT ---

    const [value, setValue] = React.useState(''); // The input value to be converted
    const [fromUnit, setFromUnit] = React.useState('Gy'); // The unit to convert from
    const [toUnit, setToUnit] = React.useState('rad'); // The unit to convert to
    const [result, setResult] = React.useState(''); // The calculated result of the conversion
    const [error, setError] = React.useState(''); // Any error messages to display

    // --- DATA & CONFIGURATION ---

    /**
     * Defines the grouping of units for display in dropdown menus.
     */
    const units = {
        'Activity': ['Bq', 'kBq', 'MBq', 'GBq', 'Ci', 'mCi', 'µCi', 'dps', 'dpm'],
        'Radiation Dose': ['Gy', 'cGy', 'mGy', 'rad', 'Sv', 'cSv', 'mSv', 'rem', 'mrem', 'R'],
        'Dose Rate': ['Gy/s', 'Gy/hr', 'cGy/hr', 'rad/hr', 'Sv/s', 'Sv/hr', 'mSv/hr', 'µSv/hr', 'rem/hr', 'mrem/hr'],
        'Energy': ['J', 'eV', 'keV', 'MeV'],
        'Radioactive Concentration': ['Bq/L', 'µCi/mL', 'pCi/L', 'Bq/m³'],
        'Length': ['m', 'cm', 'mm', 'km', 'in', 'ft'],
        'Area': ['m²', 'cm²', 'in²', 'ft²'],
        'Mass': ['g', 'kg', 'mg', 'µg', 'lb', 'oz'],
    };

    /**
     * Defines the conversion factors for each unit relative to a base unit for its category.
     * The `base` property ensures that only units of the same type can be converted (e.g., activity to activity).
     */

    const factors = {

        // Radiation Dose (Base: Gray)
        'Gy':   { base: 'dose',     factor: 1 },
        'cGy':  { base: 'dose',     factor: 0.01 },
        'mGy':  { base: 'dose',     factor: 1e-3 },
        'rad':  { base: 'dose',     factor: 0.01 },
        'Sv':   { base: 'dose',     factor: 1 },
        'cSv':  { base: 'dose',     factor: 0.01 },
        'mSv':  { base: 'dose',     factor: 1e-3 },
        'rem':  { base: 'dose',     factor: 0.01 },
        'mrem': { base: 'dose',     factor: 1e-5 },
        'R':    { base: 'dose',     factor: 0.00877 },

        // Activity (Base: Becquerel)
        'Bq':   { base: 'activity', factor: 1 },
        'kBq':  { base: 'activity', factor: 1e3 },
        'MBq':  { base: 'activity', factor: 1e6 },
        'GBq':  { base: 'activity', factor: 1e9 },
        'Ci':   { base: 'activity', factor: 3.7e10 },
        'mCi':  { base: 'activity', factor: 3.7e7 },
        'µCi':  { base: 'activity', factor: 3.7e4 },
        'dps':  { base: 'activity', factor: 1 },
        'dpm':  { base: 'activity', factor: 1 / 60 },

        // Dose Rate (Base: Sievert/hour)
        'Gy/s':     { base: 'doseRate', factor: 3.6e3 },
        'Gy/hr':    { base: 'doseRate', factor: 1 },
        'cGy/hr':   { base: 'doseRate', factor: 0.01 },
        'rad/hr':   { base: 'doseRate', factor: 0.01 },
        'Sv/s':     { base: 'doseRate', factor: 3.6e3 },
        'Sv/hr':    { base: 'doseRate', factor: 1 },
        'mSv/hr':   { base: 'doseRate', factor: 1e-3 },
        'µSv/hr':   { base: 'doseRate', factor: 1e-6 },
        'rem/hr':   { base: 'doseRate', factor: 0.01 },
        'mrem/hr':  { base: 'doseRate', factor: 1e-5 },

        // Energy (Base: Joule)
        'J':    { base: 'energy',   factor: 1 },
        'eV':   { base: 'energy',   factor: 1.60218e-19 },
        'keV':  { base: 'energy',   factor: 1.60218e-16 },
        'MeV':  { base: 'energy',   factor: 1.60218e-13 },
        
        // --- NEW FACTORS ---
        // Radioactive Concentration (Base: Bq/L)
        'Bq/L':    { base: 'concentration', factor: 1 },
        'µCi/mL':  { base: 'concentration', factor: 3.7e7 },
        'pCi/L':   { base: 'concentration', factor: 0.037 },
        'Bq/m³':   { base: 'concentration', factor: 0.001 },

        // Length (Base: meter)
        'm':  { base: 'length', factor: 1 },
        'cm': { base: 'length', factor: 0.01 },
        'mm': { base: 'length', factor: 0.001 },
        'km': { base: 'length', factor: 1000 },
        'in': { base: 'length', factor: 0.0254 },
        'ft': { base: 'length', factor: 0.3048 },

        // Area (Base: square meter)
        'm²':  { base: 'area', factor: 1 },
        'cm²': { base: 'area', factor: 1e-4 },
        'in²': { base: 'area', factor: 0.00064516 },
        'ft²': { base: 'area', factor: 0.092903 },

        // Mass (Base: gram)
        'g':  { base: 'mass', factor: 1 },
        'kg': { base: 'mass', factor: 1000 },
        'mg': { base: 'mass', factor: 0.001 },
        'µg': { base: 'mass', factor: 1e-6 },
        'lb': { base: 'mass', factor: 453.592 },
        'oz': { base: 'mass', factor: 28.3495 },
    };

    // --- LOGIC & SIDE EFFECTS ---

    /**
     * This effect ensures that if a user changes the 'From' unit to a different
     * category, the 'To' unit automatically updates to a compatible unit.
     */

    React.useEffect(() => {
        const fromBase = factors[fromUnit]?.base;
        const toBase = factors[toUnit]?.base;

        // If 'from' and 'to' units are from different categories...

        if (fromBase && fromBase !== toBase) {

            // ...find the first unit that is compatible with the new 'from' category...

            const compatibleUnit = Object.keys(factors).find(u => factors[u]?.base === fromBase);

            // ...and set it as the new 'to' unit.

            if (compatibleUnit) {
                setToUnit(compatibleUnit);
            }
        }
    }, [fromUnit]); // Reruns whenever the 'from' unit changes.

    /**
     * Performs the unit conversion. Wrapped in `useCallback` for optimization.
     */

    const handleConvert = React.useCallback(() => {
        const val = parseFloat(value);
        if (isNaN(val)) {
            if (value) setError("Invalid input value."); // Show error only if there's text
            setResult('');
            return;
        }

        const from = factors[fromUnit];
        const to = factors[toUnit];

        // Check for incompatible unit types (e.g., converting Gy to Bq)

        if (!from || !to || from.base !== to.base) {
            setError("Cannot convert between these units.");
            setResult('');
            return;
        }

        // Core conversion formula: (value * from_factor) / to_factor

        const convertedVal = val * from.factor / to.factor;
        setError('');
        setResult(convertedVal.toPrecision(4));
    }, [value, fromUnit, toUnit]);

    /**
     * This effect automatically triggers the conversion whenever any of the
     * input values or units change.
     */

    React.useEffect(() => {
        handleConvert();
    }, [value, fromUnit, toUnit, handleConvert]);

    /**
     * Swaps the 'from' and 'to' units if they are compatible.
     */

    const handleSwap = () => {
        const from = factors[fromUnit];
        const to = factors[toUnit];
        if (from && to && from.base === to.base) {
            setFromUnit(toUnit);
            setToUnit(fromUnit);
        } else {
            setError("Cannot swap incompatible units.");
        }
    };

    // Dynamically create a list of units compatible with the current 'From' unit.
    // This is used to populate the 'To' unit dropdown.

    const currentBase = factors[fromUnit]?.base;
    const compatibleUnits = Object.fromEntries(
        Object.entries(units)
            .map(([group, unitList]) => {
                const filteredList = unitList.filter(u => factors[u]?.base === currentBase);
                return [group, filteredList];
            })
            .filter(([group, unitList]) => unitList.length > 0)
    );

    // --- JSX RENDERING ---

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Unit Converter</h2>
                <div className="space-y-4">
                    {/* Value Input */}
                    <div>
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Value</label>
                        <input type="number" value={value} onChange={e => setValue(e.target.value)} placeholder="Enter a value" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                    </div>
                    
                    {/* Unit Selectors and Swap Button */}
                    <div className="flex flex-col sm:flex-row gap-4 items-end">
                        <div className="w-full sm:flex-1">
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">From</label>
                            <select value={fromUnit} onChange={e => setFromUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                {Object.entries(units).map(([group, list]) => (
                                    <optgroup label={group} key={group}>
                                        {list.map(u => <option key={u} value={u}>{u}</option>)}
                                    </optgroup>
                                ))}
                            </select>
                        </div>
                        
                        <div className="flex-shrink-0 pb-1">
                            <button onClick={handleSwap} className="p-2 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-sky-200 dark:hover:bg-sky-700 transition" aria-label="Swap units">
                                {/* Swap Icon SVG */}
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-600 dark:text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                            </button>
                        </div>
                        
                        <div className="w-full sm:flex-1">
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">To</label>
                            <select value={toUnit} onChange={e => setToUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                {Object.entries(compatibleUnits).map(([group, list]) => (
                                    <optgroup label={group} key={group}>
                                        {list.map(u => <option key={u} value={u}>{u}</option>)}
                                    </optgroup>
                                ))}
                            </select>
                        </div>
                    </div>
                    
                    {/* Error and Result Display */}

                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    {result && !error && (
                        <div className="flex items-center justify-center p-3 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
                            <p className="text-lg font-bold text-center flex-grow">{value} {fromUnit} = {result} {toUnit}</p>
                            <CopyButton textToCopy={result} />
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

        /**
         * @description A comprehensive calculator for various radioactive decay scenarios,
         * including finding remaining/initial activity, time elapsed, and daughter product activity.
         * It also generates data for a visual decay chart.
         * @param {{radionuclides: Array<object>}} props - The full list of radionuclide data.
         */




const DecayCalculator = ({ radionuclides, preselectedNuclide }) => {

    // --- STATE & CONSTANTS ---
    const [selectedNuclide, setSelectedNuclide] = React.useState(null);
    const [calculationMode, setCalculationMode] = React.useState('findRemaining');
    const [initialActivity, setInitialActivity] = React.useState('100');
    const [initialDaughterActivity, setInitialDaughterActivity] = React.useState('0');
    const [remainingActivity, setRemainingActivity] = React.useState('');
    const [timeElapsed, setTimeElapsed] = React.useState('1');
    const [timeUnit, setTimeUnit] = React.useState('days');
    
    const [result, setResult] = React.useState(null);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');

    const timeUnits = ['seconds', 'minutes', 'hours', 'days', 'years'];

    const sortedRadionuclides = React.useMemo(() => {
        const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 };
        return [...radionuclides]
            .filter(r => r.halfLife !== 'Stable')
            .sort((a, b) => {
                const orderA = commonalityOrder[a.commonality] || 0;
                const orderB = commonalityOrder[b.commonality] || 0;
                if (orderA !== orderB) {
                    return orderB - orderA;
                }
                return a.name.localeCompare(b.name);
            });
    }, [radionuclides]);

    const handleNuclideSelect = React.useCallback((symbol) => {
        const nuclideToSet = sortedRadionuclides.find(n => n.symbol === symbol);
        if (nuclideToSet) {
            setSelectedNuclide(nuclideToSet);
            
            const hl_seconds = parseHalfLifeToSeconds(nuclideToSet.halfLife);
            if (hl_seconds !== Infinity) {
                const bestUnit = getBestHalfLifeUnit(hl_seconds);
                const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
                const hl_in_best_unit = hl_seconds / unitConversions[bestUnit];
                
                setTimeUnit(bestUnit);
                setTimeElapsed(parseFloat(hl_in_best_unit.toPrecision(2)).toString());
            }
        }
    }, [sortedRadionuclides]);

    // --- NEW: Hook to handle pre-selection from NuclideCard ---
    React.useEffect(() => {
        if (preselectedNuclide) {
            handleNuclideSelect(preselectedNuclide);
        }
    }, [preselectedNuclide, handleNuclideSelect]);

    const handleCalculate = () => {
        if (!selectedNuclide) {
            setError('Please select a radionuclide.');
            setResult(null);
            setChartData(null);
            return;
        }
        const T1_seconds = parseHalfLifeToSeconds(selectedNuclide.halfLife);
        if (T1_seconds === Infinity) {
            setError('Cannot calculate decay for a stable nuclide.');
            setResult(null);
            setChartData(null);
            return;
        }
        
        const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
        setError('');
        setResult(null);
        setChartData(null);

        try {
            const t_input = parseFloat(timeElapsed);
            if (isNaN(t_input) || t_input < 0) { throw new Error('Time elapsed must be a non-negative number.'); }
            const t_seconds = t_input * unitConversions[timeUnit];
            const lambda1 = Math.log(2) / T1_seconds;

            const generateSingleNuclideChart = (N0) => {
                const labels = [], parentData = [];
                const totalTime = t_input * 2 > 0 ? t_input * 2 : 1; // Ensure totalTime is positive
                const steps = 100;
                for (let i = 0; i <= steps; i++) {
                    const timePoint = (totalTime / steps) * i;
                    const timePoint_seconds = timePoint * unitConversions[timeUnit];
                    labels.push(timePoint.toFixed(2));
                    parentData.push(N0 * Math.exp(-lambda1 * timePoint_seconds));
                }
                setChartData({ labels, parentData, parentName: selectedNuclide.name, timeUnit });
            };

            switch (calculationMode) {
                case 'findRemaining': {
                    const N0 = parseFloat(initialActivity);
                    if (isNaN(N0) || N0 < 0) { throw new Error('Initial activity must be a non-negative number.'); }
                    const Nt = N0 * Math.pow(0.5, t_seconds / T1_seconds);
                    setRemainingActivity(Nt.toPrecision(4)); // <-- Set the specific state
                    setResult(null); // <-- Clear the separate result box state
                    generateSingleNuclideChart(N0);
                    break;
                }
                case 'findTime': {
                    const N0 = parseFloat(initialActivity);
                    const Nt = parseFloat(remainingActivity);
                    if (isNaN(N0) || isNaN(Nt) || N0 < 0 || Nt < 0) { throw new Error('Activities must be non-negative numbers.'); }
                    if (Nt > N0) { throw new Error('Remaining activity cannot be greater than initial activity.'); }
                    if (Nt === 0) {
                        setTimeElapsed('Infinite');
                        setResult(null);
                        break;
                    }
                    const t_seconds_calc = -T1_seconds * (Math.log(Nt / N0) / Math.log(2));
                    const t_final = t_seconds_calc / unitConversions[timeUnit];
                    setTimeElapsed(t_final.toPrecision(4)); // <-- Set the specific state
                    setResult(null); // <-- Clear the separate result box state
                    setChartData(null);
                    break;
                }
                case 'findInitial': {
                    const Nt = parseFloat(remainingActivity);
                    if (isNaN(Nt) || Nt < 0) { throw new Error('Remaining activity must be a non-negative number.'); }
                    const N0 = Nt / Math.pow(0.5, t_seconds / T1_seconds);
                    setInitialActivity(N0.toPrecision(4)); // <-- Set the specific state
                    setResult(null); // <-- Clear the separate result box state
                    generateSingleNuclideChart(N0);
                    break;
                }

                case 'findDaughterActivity': {
                    const N0_parent = parseFloat(initialActivity);
                    const N0_daughter = parseFloat(initialDaughterActivity);
                    if (isNaN(N0_parent) || N0_parent < 0 || isNaN(N0_daughter) || N0_daughter < 0) {
                        throw new Error('Initial activities must be non-negative numbers.');
                    }
                    
                    if (selectedNuclide.daughter.includes('/') || selectedNuclide.daughter.includes(' or ')) {
                        throw new Error(`Cannot calculate daughter activity for "${selectedNuclide.name}" due to branching decay. Please use the Series Decay calculator.`);
                    }

                    const daughterName = selectedNuclide.daughter.split('(')[0].trim();
                    const daughterNuclide = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
                    
                    if (!daughterNuclide && selectedNuclide.daughter.toLowerCase().includes('stable')) {
                        const Nt_parent_activity = N0_parent * Math.exp(-lambda1 * t_seconds);
                        const A_daughter = 0; 
                        setResult({
                            parent: { value: Nt_parent_activity.toPrecision(4), name: selectedNuclide.name },
                            daughter: { value: A_daughter.toFixed(4), name: daughterName, isStable: true }
                        });
                        const labels = [], parentData = [], daughterData = [];
                        const totalTime = t_input * 2 > 0 ? t_input * 2 : 1;
                        const steps = 100;
                        for (let i = 0; i <= steps; i++) {
                            const timePoint = (totalTime / steps) * i;
                            labels.push(timePoint.toFixed(2));
                            const timePoint_seconds = timePoint * unitConversions[timeUnit];
                            parentData.push(N0_parent * Math.exp(-lambda1 * timePoint_seconds));
                            daughterData.push(0);
                        }
                        setChartData({ labels, parentData, daughterData, parentName: selectedNuclide.name, daughterName, timeUnit });
                        return;
                    }

                    if (!daughterNuclide) { throw new Error(`Daughter nuclide "${daughterName}" not found in the database.`); }
                    
                    const T2_seconds = parseHalfLifeToSeconds(daughterNuclide.halfLife);
                    const Nt_parent_activity = N0_parent * Math.exp(-lambda1 * t_seconds);
                    let A_daughter;

                    if (T2_seconds === Infinity) {
                        A_daughter = 0;
                    } else {
                        const lambda2 = Math.log(2) / T2_seconds;
                        const initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * t_seconds);
                        let daughterIngrowth;
                        if (Math.abs(lambda1 - lambda2) < 1e-12) {
              daughterIngrowth = N0_parent * lambda1 * t_seconds * Math.exp(-lambda1 * t_seconds);
        } else {
          daughterIngrowth = (lambda2 / (lambda2 - lambda1)) * N0_parent* (Math.exp(-lambda1* t_seconds) - Math.exp(-lambda2 * t_seconds));
        }
                        A_daughter = initialDaughterDecay + daughterIngrowth;
                    }
                    
                    setResult({
                        parent: { value: Nt_parent_activity.toPrecision(4), name: selectedNuclide.name },
                        daughter: { value: A_daughter.toPrecision(4), name: daughterNuclide.name, isStable: T2_seconds === Infinity }
                    });
                    
                    const labels = [], parentData = [], daughterData = [];
                    const totalTime = t_input * 2 > 0 ? t_input * 2 : 1;
                    const steps = 100;
                    for (let i = 0; i <= steps; i++) {
                        const timePoint = (totalTime / steps) * i;
                        const timePoint_seconds = timePoint * unitConversions[timeUnit];
                        labels.push(timePoint.toFixed(2));
                        
                        parentData.push(N0_parent * Math.exp(-lambda1 * timePoint_seconds));

                        if (T2_seconds === Infinity) {
                            daughterData.push(0);
                        } else {
                            const lambda2 = Math.log(2) / T2_seconds;
                            const current_initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * timePoint_seconds);
                            let current_daughterIngrowth;
                            if (Math.abs(lambda1 - lambda2) < 1e-12) {
                                current_daughterIngrowth = N0_parent * lambda1 * timePoint_seconds * Math.exp(-lambda1 * timePoint_seconds);
                            } else {
                                current_daughterIngrowth = (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * timePoint_seconds) - Math.exp(-lambda2 * timePoint_seconds));
                            }
                            daughterData.push(current_initialDaughterDecay + current_daughterIngrowth);
                        }
                    }
                    setChartData({ labels, parentData, daughterData, parentName: selectedNuclide.name, daughterName: daughterNuclide.name, timeUnit });
                    break;
                }
                default:
                    throw new Error('Invalid calculation mode.');
            }
        } catch (e) {
            setError(e.message);
        }
    };
    
    const renderInputField = (label, value, setter, isEnabled, unitValue, unitSetter, unitOptions) => (
        <div>
            <label className={`block text-sm font-medium ${isEnabled ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 dark:text-slate-500'}`}>{label}</label>
            <div className="flex gap-2 mt-1">
                <input type="number" value={value} onChange={e => setter(e.target.value)} disabled={!isEnabled} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:cursor-not-allowed" />
                {unitOptions && (
                    <select value={unitValue} onChange={e => unitSetter(e.target.value)} disabled={!isEnabled} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:cursor-not-allowed">
                        {unitOptions.map(u => <option key={u} value={u}>{u}</option>)}
                    </select>
                )}
            </div>
        </div>
    );

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-lg mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Radioactive Decay Calculator</h2>
                <div className="space-y-4">
                    <div>
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label>
                        <div className="mt-1 min-h-[42px]">




                            {selectedNuclide ? (
                                <>
                                    <div className="flex items-center justify-between p-2 rounded-md bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200 animate-fade-in">
                                        <span className="font-bold">{selectedNuclide.name}</span>
                                        <button onClick={() => { setSelectedNuclide(null); setResult(null); setChartData(null); setError(''); }} className="ml-2 p-1 rounded-full text-sky-600 dark:text-sky-300 hover:bg-sky-200 dark:hover:bg-sky-800" title="Change nuclide">
                                            <Icon path={ICONS.clear} className="w-4 h-4" />
                                        </button>
                                    </div>
                                    <NuclideContextDisplay nuclide={selectedNuclide} />
                                </>
                            ) : (


                                <SearchableSelect options={sortedRadionuclides} onSelect={handleNuclideSelect} placeholder="Search for a radionuclide..."/>
                            )}
                        </div>
                    </div>
                    <div>
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Calculate</label>
                        <div className="grid grid-cols-2 gap-x-4 gap-y-2 mt-2">
                            {['findRemaining', 'findTime', 'findInitial', 'findDaughterActivity'].map(mode => (
                                <label key={mode} className="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="calcMode" value={mode} checked={calculationMode === mode} onChange={() => setCalculationMode(mode)} className="form-radio h-4 w-4 text-sky-600"/>
                                    <span className="text-sm">{
                                        { 'findRemaining': 'Remaining Activity', 'findTime': 'Time Elapsed', 'findInitial': 'Initial Activity', 'findDaughterActivity': 'Daughter Activity' }[mode]
                                    }</span>
                                </label>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                        {renderInputField("Initial Activity", initialActivity, setInitialActivity, calculationMode !== 'findInitial')}
                        {renderInputField("Remaining Activity", remainingActivity, setRemainingActivity, calculationMode === 'findTime' || calculationMode === 'findInitial')}
                        {calculationMode === 'findDaughterActivity' &&
                            renderInputField("Initial Daughter Activity", initialDaughterActivity, setInitialDaughterActivity, true)
                        }
                        {renderInputField("Time Elapsed", timeElapsed, setTimeElapsed, calculationMode !== 'findTime', timeUnit, setTimeUnit, timeUnits)}
                    </div>
                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate</button>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    {result && (
                        <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                            {result.label ? (
                                <div className="flex items-center justify-center">
                                    <div className="text-lg font-bold text-center flex-grow">
                                        <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.label}</span>
                                        <span>{result.value} {result.unit}</span>
                                    </div>
                                    <CopyButton textToCopy={result.value} />
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    <div className="flex items-center justify-between">
                                        <div className="text-lg font-bold text-left">
                                            <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Remaining {result.parent.name} Activity</span>
                                            <span>{result.parent.value}</span>
                                        </div>
                                        <CopyButton textToCopy={result.parent.value} />
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="text-lg font-bold text-left">
                                            <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.daughter.name} Activity {result.daughter.isStable ? "(Stable Daughter)" : ""}</span>
                                            <span>{result.daughter.value}</span>
                                        </div>
                                        <CopyButton textToCopy={result.daughter.value} />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {chartData && <DecayChart chartData={chartData} />}
                </div>
            </div>
        </div>
    );
};




/**
 * @description A calculator to determine radioactive material shipping classification (Excepted, Type A, Type B)
 * based on the nuclide, activity, and form, according to DOT/IAEA A1/A2 values.
 */
const TransportationCalculator = ({ radionuclides, preselectedNuclide }) => {
    // --- STATE MANAGEMENT ---
    const [selectedSymbol, setSelectedSymbol] = React.useState('');
    const [formType, setFormType] = React.useState('A2'); // Default to Normal Form (more conservative)
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState('Ci');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // Filter the main list for only nuclides that have shipping data.
    const transportNuclides = React.useMemo(() => 
        radionuclides.filter(n => n.shipping && n.shipping.A1 !== null && n.shipping.A2 !== null).sort((a,b) => a.name.localeCompare(b.name)),
        [radionuclides]
    );
    
    // Get the full nuclide object based on the selected symbol
    const selectedNuclide = React.useMemo(() => 
        transportNuclides.find(n => n.symbol === selectedSymbol),
        [selectedSymbol, transportNuclides]
    );

    // --- Hook to handle pre-selection from NuclideCard ---
    React.useEffect(() => {
        if (preselectedNuclide) {
            setSelectedSymbol(preselectedNuclide);
        }
    }, [preselectedNuclide]);

    const activityFactorsTBq = {
        'TBq': 1, 'GBq': 0.001, 'MBq': 1e-6, 'kBq': 1e-9, 'Bq': 1e-12,
        'Ci': 0.037, 'mCi': 3.7e-5, 'µCi': 3.7e-8
    };

    const handleCalculate = () => {
        if (!selectedNuclide) {
            setError('Please select a radionuclide.');
            setResult(null); return;
        }
        
        const activityValue = parseFloat(activity);
        if (isNaN(activityValue) || activityValue < 0) {
            setError('Please enter a valid, non-negative activity.');
            setResult(null); return;
        }
        setError('');

        const userActivityTBq = activityValue * activityFactorsTBq[activityUnit];
        const limitTBq = selectedNuclide.shipping[formType];
        const exceptedLimitTBq = 1e-4 * limitTBq;

        let classification = '';
        if (userActivityTBq <= exceptedLimitTBq) {
            classification = 'EXCEPTED';
        } else if (userActivityTBq <= limitTBq) {
            classification = 'TYPE_A';
        } else {
            classification = 'TYPE_B';
        }

        setResult({
            classification,
            userActivityTBq: userActivityTBq.toExponential(3),
            limitTBq,
            exceptedLimitTBq: exceptedLimitTBq.toExponential(3)
        });
    };
    
    // Helper object for styling the results box
    const resultStyles = {
        EXCEPTED: { container: 'bg-green-100 dark:bg-green-900/50', title: 'text-green-600 dark:text-green-400', display: 'Excepted Package' },
        TYPE_A: { container: 'bg-sky-100 dark:bg-sky-900/50', title: 'text-sky-600 dark:text-sky-400', display: 'Type A Package' },
        TYPE_B: { container: 'bg-red-100 dark:bg-red-900/50', title: 'text-red-600 dark:text-red-400', display: 'Type B Package' }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Shipping Calculator</h2>
                <div className="space-y-4">
                    <div>
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label>
                        <div className="mt-1 min-h-[42px]">
                            
                            {selectedNuclide ? (
                                <>
                                    <div className="flex items-center justify-between p-2 rounded-md bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200">
                                        <span className="font-bold">{selectedNuclide.name}</span>
                                        <button onClick={() => { setSelectedSymbol(''); setResult(null); setError(''); }} className="ml-2 p-1 rounded-full hover:bg-sky-200 dark:hover:bg-sky-800" title="Change nuclide">
                                            <Icon path={ICONS.clear} className="w-4 h-4" />
                                        </button>
                                    </div>
                                    <NuclideContextDisplay nuclide={selectedNuclide} />
                                </>
                            ) : (
                                <SearchableSelect
                                    options={transportNuclides}
                                    onSelect={(symbol) => { setSelectedSymbol(symbol); setResult(null); setError(''); }}
                                    placeholder="Search for a radionuclide..."
                                />
                            )}
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Material Form</label>
                        <div className="mt-2 grid grid-cols-2 gap-2">
                            <label className={`flex items-center justify-center p-3 rounded-lg cursor-pointer ${formType === 'A1' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}><input type="radio" name="formType" value="A1" checked={formType === 'A1'} onChange={e => setFormType(e.target.value)} className="hidden"/>Special Form (A1)</label>
                            <label className={`flex items-center justify-center p-3 rounded-lg cursor-pointer ${formType === 'A2' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}><input type="radio" name="formType" value="A2" checked={formType === 'A2'} onChange={e => setFormType(e.target.value)} className="hidden"/>Normal Form (A2)</label>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Source Activity</label>
                        <div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(activityFactorsTBq).map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                    </div>

                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate Package Type</button>
                    
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {result && (
                        <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.classification].container}`}>
                            <p className={`text-3xl font-extrabold ${resultStyles[result.classification].title}`}>{resultStyles[result.classification].display}</p>
                            <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                                <p>Your Activity:</p><p className="font-mono">{result.userActivityTBq} TBq</p>
                                <p>{formType} Limit:</p><p className="font-mono">{result.limitTBq} TBq</p>
                                <p>Excepted Limit:</p><p className="font-mono">≤ {result.exceptedLimitTBq} TBq</p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};




        /**
         * @description A calculator that uses the Bateman equations to model the activity of every
         * nuclide in a full decay series over time.
         * @param {{radionuclides: Array<object>, decaySeriesData: Array<object>}} props
         */

        const DecaySeriesCalculator = ({ radionuclides, decaySeriesData }) => {

            // --- STATE & CONFIGURATION ---

            const [selectedSeriesId, setSelectedSeriesId] = React.useState(decaySeriesData[0].id);
            const [initialActivity, setInitialActivity] = React.useState('100');
            const [timeElapsed, setTimeElapsed] = React.useState('1000');
            const [timeUnit, setTimeUnit] = React.useState('years');
            const [results, setResults] = React.useState([]); // For the results table
            const [chartData, setChartData] = React.useState(null); // For the chart component
            const [error, setError] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false); // To manage UI during long calculations

            const timeUnits = ['seconds', 'minutes', 'hours', 'days', 'years', 'kiloyears', 'megayears', 'gigayears'];
            const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600, 'kiloyears': 31557600 * 1e3, 'megayears': 31557600 * 1e6, 'gigayears': 31557600 * 1e9 };

            // --- CORE CALCULATION ENGINE ---

            /**
             * Implements the general Bateman equations to find the activity of each nuclide in a decay chain.
             * This function calculates the number of atoms for each nuclide at time t, then converts to activity.
             * @param {Array<object>} chain - The array of nuclide objects in the decay series.
             * @param {number} A1_0 - The initial activity of the parent nuclide (nuclide 1).
             * @param {number} t_seconds - The elapsed time in seconds.
             * @returns {Array<number>} An array of activities for each nuclide in the chain at time t.
             */

            const runBatemanCalculation = (chain, A1_0, t_seconds) => {
                // 1. Get decay constants (λ) for each nuclide in the chain. λ = ln(2) / T½.
                const lambdas = chain.map(step => {
                    const t_half = parseHalfLifeToSeconds(step.halfLife);
                    return t_half === Infinity ? 0 : Math.log(2) / t_half; // λ is 0 for stable nuclides
                });

                if (lambdas[0] === 0) return Array(chain.length).fill(0); // Parent is stable, no decay.

                // 2. Calculate the initial number of atoms of the parent from its activity (N = A/λ).

                const N1_0 = A1_0 / lambdas[0];
                const activities = [];

                // 3. Loop through each nuclide in the chain (i) to calculate its number of atoms, N_i(t).
                for (let i = 0; i < chain.length; i++) {

                    // For stable nuclides (λ=0), activity is always 0.

                    if (lambdas[i] === 0) {
                        activities.push(0);
                        continue;
                    }

                    // For the parent nuclide (i=0), use simple exponential decay: N(t) = N₀ * e^(-λt).

                    if (i === 0) {
                        const N1_t = N1_0 * Math.exp(-lambdas[0] * t_seconds);
                        activities.push(N1_t * lambdas[0]); // A = Nλ
                        continue;
                    }

                    // For all subsequent progeny (i > 0), use the full Bateman equation:
                    // Nᵢ(t) = N₁(0) * (Π_{k=1}^{i-1} λₖ) * (Σ_{j=1}^{i} (e^{-λⱼt} / Π_{k=1, k≠j}^{i} (λₖ - λⱼ)))
                    
                    // First part: Product of parent decay constants: Π_{k=1}^{i-1} λₖ

                    let lambda_product = 1;
                    for (let k = 0; k < i; k++) {
                        lambda_product *= lambdas[k];
                    }

                    // Second part: The summation term: Σ_{j=1}^{i} (...)

                    let sum_term = 0;
                    for (let j = 0; j <= i; j++) {

                        // The denominator inside the sum: Π_{k=1, k≠j}^{i} (λₖ - λⱼ)

                        let denominator_product = 1;
                        for (let k = 0; k <= i; k++) {
                            if (j !== k) {
                                let diff = lambdas[k] - lambdas[j];

                                // Handle the very rare case of identical lambdas to avoid division by zero.

                                denominator_product *= (Math.abs(diff) < 1e-30) ? 1e-30 : diff;
                            }
                        }
                        sum_term += Math.exp(-lambdas[j] * t_seconds) / denominator_product;
                    }

                    // Combine all parts to get the number of atoms for nuclide i at time t.

                    const Ni_t = N1_0 * lambda_product * sum_term;

                    // Convert number of atoms back to activity (A = Nλ).

                    const Ai_t = Ni_t * lambdas[i];
                    activities.push(Ai_t);
                }
                return activities;
            };

            // --- UI HANDLERS & ORCHESTRATION ---

            /**
             * Main handler to orchestrate the calculation process, including validation,
             * calling the Bateman engine, and generating data for the UI.
             */

            const handleCalculate = () => {
                const series = decaySeriesData.find(s => s.id === selectedSeriesId);
                if (!series) {
                    setError('Please select a decay series.');
                    return;
                }

                
                // Validate all numerical inputs

                const A0 = parseFloat(initialActivity);
                const t_input = parseFloat(timeElapsed);
                if (isNaN(A0) || A0 < 0 || isNaN(t_input) || t_input < 0) {
                    setError('Initial activity and time must be non-negative numbers.');
                    setResults([]);
                    setChartData(null);
                    return;
                }
                
                setError('');
                setIsLoading(true);

                // Use a short timeout to allow the UI to update to the 'loading' state
                // before starting the potentially blocking, intensive calculation.

                setTimeout(() => {
                    try {
                        const t_seconds = t_input * unitConversions[timeUnit];
                        
                        // 1. Run the calculation once for the final time point for the results table.

			const flatChain = flattenChainForCalculator(series.chain); 

 			const calculatedActivities = runBatemanWithBranching(flatChain, A0, t_seconds); 

                        const finalResults = flatChain.map((step, i) => ({
                            name: step.nuclide,
                            activity: calculatedActivities[i]
                        }));
                        setResults(finalResults);

                        // 2. Generate data for the activity-vs-time chart.

                        const chartLabels = [];
                        const datasets = flatChain.map((step, i) => ({
                            label: step.nuclide,
                            data: [],
                            borderColor: `hsl(${(i * 360 / Math.min(series.chain.length, 15)) % 360}, 70%, 50%)`,
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            hidden: i > 5 // Hide less significant progeny by default for chart clarity
                        }));
                        
                        const steps = 100; // Number of points on the chart
                        for (let i = 0; i <= steps; i++) {
                            const timePoint = (t_input / steps) * i;
                            chartLabels.push(timePoint.toPrecision(2));
                            const timePoint_seconds = timePoint * unitConversions[timeUnit];

                            // This is computationally intensive: must run the full Bateman calculation for each point.

                            const activitiesAtTimePoint = runBatemanWithBranching(flatChain, A0, timePoint_seconds);
                            activitiesAtTimePoint.forEach((act, j) => {
                                datasets[j].data.push(act);
                            });
                        }
                        setChartData({ labels: chartLabels, datasets, timeUnit });
                    } catch (e) {
                        setError('An error occurred. Inputs may be too large or small for a stable result.');
                        console.error(e);
                    } finally {
                        setIsLoading(false); // Ensure loading is turned off even if errors occur.
                    }
                }, 50);
            };

            // --- JSX RENDERING ---

            return (
                <div className="p-4 animate-fade-in">
                    <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Decay Series Calculator (Bateman)</h2>
                        
                        {/* Input Controls */}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Decay Series</label>
                                <select value={selectedSeriesId} onChange={e => setSelectedSeriesId(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                    {decaySeriesData.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Initial Parent Activity</label>
                                <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Time Elapsed</label>
                                <div className="flex gap-2 mt-1">
                                    <input type="number" value={timeElapsed} onChange={e => setTimeElapsed(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                                    <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                        {timeUnits.map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                            </div>
                            <button onClick={handleCalculate} disabled={isLoading} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition disabled:bg-sky-800 disabled:cursor-wait">
                                {isLoading ? 'Calculating...' : 'Calculate'}
                            </button>
                        </div>

                        {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
                        
                        {/* Results Display Area */}

                        <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Results Table */}
                            <div className="max-h-[400px] overflow-y-auto pr-2">
                                <h3 className="text-lg font-semibold mb-2">Results at {timeElapsed} {timeUnit}</h3>
                                {results.length > 0 ? (
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0">
                                            <tr>
                                                <th className="p-2">Nuclide</th>
                                                <th className="p-2">Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {results.map(r => (
                                                <tr key={r.name} className="border-b border-slate-200 dark:border-slate-700">
                                                    <td className="p-2 font-medium">{r.name}</td>
                                                    <td className="p-2">{r.activity.toPrecision(4)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : <p className="text-slate-500 text-center py-4">No results to display.</p>}
                            </div>

                            {/* Chart Area */}

                            <div className="min-h-[300px]">
                                {chartData ? <SeriesDecayChart chartData={chartData} /> : <div className="flex items-center justify-center h-full bg-slate-100 dark:bg-slate-800/50 rounded-lg"><p className="text-slate-500">Chart will be displayed here.</p></div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * @description A React component that renders a line chart for a decay series using Chart.js.
         * It's designed to display the activity of all nuclides in a chain over time.
         * @param {{chartData: object}} props - The data object for the chart, including labels and datasets.
         */

        const SeriesDecayChart = ({ chartData }) => {
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);

            React.useEffect(() => {

                // Destroy the previous chart instance before creating a new one to prevent memory leaks.

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                if (chartRef.current && chartData) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: { boxWidth: 20, font: { size: 10 } }
                                },
                                title: {
                                    display: true,
                                    text: 'Decay Series Activity Over Time'
                                },
                                tooltip: {
                                    mode: 'index', // Show tooltips for all datasets at a given x-index.
                                    intersect: false,
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: `Time (${chartData.timeUnit})` },
                                    ticks: { maxRotation: 0, autoSkip: true, autoSkipPadding: 20 }
                                },
                                y: {
                                    type: 'logarithmic', // Log scale is essential for viewing wide ranges of activity.
                                    title: { display: true, text: 'Activity (Log Scale)' },
                                    beginAtZero: true,

                                    // Set a very small minimum to prevent log(0) errors, but only if data exists.

                                    min: Math.max(...chartData.datasets.flatMap(d => d.data)) > 0 ? 1e-9 : 0,
                                }
                            }
                        }
                    });
                }

                // Cleanup function to destroy the chart when the component unmounts.

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [chartData]); // Re-render the chart whenever chartData changes.

            return <div className="relative h-full"><canvas ref={chartRef}></canvas></div>;
        };

        /**
         * @description A calculator for finding the specific activity of a nuclide from its atomic weight and half-life.
         */

        const SpecificActivityCalculator = () => {
            const [atomicWeight, setAtomicWeight] = React.useState('');
            const [halfLifeValue, setHalfLifeValue] = React.useState('');
            const [halfLifeUnit, setHalfLifeUnit] = React.useState('years');
            const [result, setResult] = React.useState(null);
            const [error, setError] = React.useState('');

            const timeUnits = ['seconds', 'minutes', 'hours', 'days', 'years', 'kiloyears', 'megayears', 'gigayears'];
            const unitMultipliers = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600, 'kiloyears': 31557600 * 1e3, 'megayears': 31557600 * 1e6, 'gigayears': 31557600 * 1e9 };

            const handleCalculate = () => {
                const A = parseFloat(atomicWeight);
                const T_val = parseFloat(halfLifeValue);

                if (isNaN(A) || A <= 0 || isNaN(T_val) || T_val <= 0) {
                    setError('Atomic weight and half-life must be positive numbers.');
                    setResult(null);
                    return;
                }
                setError('');
                
                // Convert half-life to seconds to get the decay constant (λ).

                const T_seconds = T_val * unitMultipliers[halfLifeUnit];
                const lambda = Math.log(2) / T_seconds;
                const Na = 6.02214076e23; // Avogadro's number

                // Formula: Specific Activity (Bq/g) = (λ * Nₐ) / Molar Mass (A)

                const sa_bq_per_g = (lambda * Na) / A;
                const sa_ci_per_g = sa_bq_per_g / 3.7e10; // Convert Bq/g to Ci/g

                setResult({
                    bq: sa_bq_per_g.toPrecision(4),
                    ci: sa_ci_per_g.toPrecision(4)
                });
            };

            return (
                <div className="p-4 animate-fade-in">
                    <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Specific Activity Calculator</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Atomic Weight (g/mol)</label>
                                <input type="number" value={atomicWeight} onChange={e => setAtomicWeight(e.target.value)} placeholder="e.g., 60 for Co-60" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Half-life</label>
                                <div className="flex gap-2 mt-1">
                                    <input type="number" value={halfLifeValue} onChange={e => setHalfLifeValue(e.target.value)} placeholder="e.g., 5.27" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                                    <select value={halfLifeUnit} onChange={e => setHalfLifeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                        {timeUnits.map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                            </div>
                            <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate</button>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            {result && (
                                <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
                                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Specific Activity</p>
                                    <p className="text-lg font-bold">{result.bq} Bq/g</p>
                                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">({result.ci} Ci/g)</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };




        /**
         * @description A calculator to convert between the mass of a radionuclide and its total activity.
         * @param {{radionuclides: Array<object>}} props
         */

const MassActivityCalculator = ({ radionuclides }) => {
    const [selectedNuclide, setSelectedNuclide] = React.useState(null);
    const [mass, setMass] = React.useState(''); const [massUnit, setMassUnit] = React.useState('g');
    const [activity, setActivity] = React.useState(''); const [activityUnit, setActivityUnit] = React.useState('Ci');
    const [error, setError] = React.useState('');
    
    const massUnits = { 'g': 1, 'mg': 1e-3, 'µg': 1e-6 };
    const activityUnits = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'Ci': 3.7e10, 'mCi': 3.7e7, 'µCi': 3.7e4 };

    // Memoized list of nuclides that have specific activity data.
    const nuclidesWithSA = React.useMemo(() => radionuclides.filter(r => r.specificActivity && r.halfLife !== 'Stable').sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    
    // A stable handler function for selecting a nuclide.
    const handleNuclideSelect = React.useCallback((symbol) => {
        const nuclideToSet = nuclidesWithSA.find(n => n.symbol === symbol);
        setSelectedNuclide(nuclideToSet);
    }, [nuclidesWithSA]); // This dependency array ensures the function is stable.

    /**
     * Handles the calculation in either direction (mass to activity, or activity to mass).
     * @param {'toActivity' | 'toMass'} direction - The direction of the conversion.
     */
    const handleCalculation = (direction) => {
        if (!selectedNuclide) { setError('Please select a radionuclide.'); return; }
        
        const saBqPerG = parseSpecificActivity(selectedNuclide.specificActivity);
        if (saBqPerG === 0) { setError('Specific activity data is missing or invalid for this nuclide.'); return; }
        
        if (direction === 'toActivity') {
            const massValue = parseFloat(mass);
            if(isNaN(massValue) || massValue < 0) { setError('Invalid mass value.'); return; }
            const massInG = massValue * massUnits[massUnit];
            const activityInBq = massInG * saBqPerG;
            const finalActivity = activityInBq / activityUnits[activityUnit];
            setActivity(finalActivity.toPrecision(4));
        } else { // 'toMass'
            const activityValue = parseFloat(activity);
            if(isNaN(activityValue) || activityValue < 0) { setError('Invalid activity value.'); return; }
            const activityInBq = activityValue * activityUnits[activityUnit];
            const massInG = activityInBq / saBqPerG;
            const finalMass = massInG / massUnits[massUnit];
            setMass(finalMass.toPrecision(4));
        }
        setError('');
    };
    
    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Mass ↔ Activity Calculator</h2>
                <div className="space-y-4">
                    


<div>
    <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label>
    <div className="mt-1 min-h-[42px]">
{selectedNuclide ? (
            <div className="flex items-center justify-between p-2 rounded-md bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200 animate-fade-in">
                <span className="font-bold">{selectedNuclide.name}</span>
                <button 
                    onClick={() => {
                        setSelectedNuclide(null);
                        setMass('');
                        setActivity('');
                        setError('');
                    }} 
                    className="ml-2 p-1 rounded-full text-sky-600 dark:text-sky-300 hover:bg-sky-200 dark:hover:bg-sky-800"
                    title="Change nuclide"
                >
                    <Icon path={ICONS.clear} className="w-4 h-4" />
                </button>
            </div>
        ) : (
            <SearchableSelect
                options={nuclidesWithSA}
                onSelect={handleNuclideSelect}
                placeholder="Search for a nuclide..."
            />
        )}
    </div>
</div>





                    {/* Mass to Activity Section */}
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                        <label className="text-md font-semibold">Mass</label>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                            <input type="number" placeholder="Enter Mass" value={mass} onChange={e => setMass(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                            <select value={massUnit} onChange={e => setMassUnit(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                {Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}
                            </select>
                        </div>
                        <div className="text-center mt-4">
                            <button onClick={() => handleCalculation('toActivity')} className="w-full sm:w-auto px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">↓ Calculate Activity ↓</button>
                        </div>
                    </div>
                    
                    {/* Activity to Mass Section */}
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                        <label className="text-md font-semibold">Activity</label>
                        <div className="text-center mt-4">
                            <button onClick={() => handleCalculation('toMass')} className="w-full sm:w-auto px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">↑ Calculate Mass ↑</button>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                            <input type="number" placeholder="Enter Activity" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                            <select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                {Object.keys(activityUnits).map(u => <option key={u} value={u}>{u}</option>)}
                            </select>
                        </div>
                    </div>
                    {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}
                </div>
            </div>
        </div>
    );
};

        /**
         * @description A modal dialog that displays the user manual and FAQ content.
         * @param {{isOpen: boolean, onClose: () => void}} props - Controls the visibility of the modal.
         */

const ManualContent = () => {
    return (
        <div className="prose prose-slate dark:prose-invert max-w-none p-6 text-slate-700 dark:text-slate-300">
            <h1 className="text-slate-900 dark:text-slate-100"><strong>User Manual & FAQ</strong></h1>
            <p>
                Welcome to the Radionuclide Lookup Tool! This application is designed for students, health physicists, and nuclear professionals who need quick access to radionuclide data and a powerful suite of radiological calculators. This guide will walk you through the various features to help you get the most out of the tool.
            </p>
            
            <hr className="my-4" />

            <h2 className="text-slate-900 dark:text-slate-100"><strong>Getting Started: Finding a Nuclide</strong></h2>
            <p>
                The primary function of the tool is to look up detailed information on a specific radionuclide. The search bar at the top of the page is your main entry point.
            </p>
            <h4 className="italic mt-4">Searching</h4>
            <p>
                You can search by either the nuclide's full name (e.g., <code>"Cesium-137"</code>) or its symbol (e.g., <code>"Cs-137"</code>). The search is flexible and ignores spaces or hyphens, so <code>"cs137"</code> will also work. As you type, a list of the top 10 suggestions will appear, prioritized by how common the nuclide is, to help you find what you're looking for faster.
            </p>
            <h4 className="italic mt-4">The Nuclide Card</h4>
            <p>
                Once you select a nuclide, its detailed information card is displayed. This card contains key data points including half-life, decay constant (λ), emission types, primary emission energies, and its parent and daughter products. You can also add a nuclide to your persistent <strong>Favorites</strong> list by clicking the star icon in the top right.
            </p>
            
            <hr className="my-4" />

            <h2 className="text-slate-900 dark:text-slate-100"><strong>Core Features</strong></h2>
            <p>The main navigation bar provides access to all the specialized tools and views within the application.</p>
            
            <h3 className="mt-6"><strong>Database</strong></h3>
            <p>
                The <strong>Database</strong> view is for discovery and exploration. It allows you to browse and sort the entire collection of radionuclides. The sidebar on the left provides a powerful set of filters to help you find nuclides with specific properties:
            </p>
            <ul>
                <li><strong>Category & Commonality:</strong> Find nuclides based on their typical use (e.g., Medical, Industrial) or how frequently they are encountered.</li>
                <li><strong>Emission Type:</strong> Isolate all nuclides that undergo a specific decay, such as Alpha Decay or Positron Emission.</li>
                <li><strong>Half-life & Energy Ranges:</strong> This is a powerful feature for finding the right tool for a job. For example, you can find a gamma emitter with a half-life between 30 and 90 days and a primary gamma energy above 0.5 MeV.</li>
            </ul>

            <h3 className="mt-6"><strong>Compare</strong></h3>
            <p>
                The <strong>Compare</strong> tool is designed for nuanced analysis, allowing you to view multiple nuclides in a side-by-side table. This is especially useful for comparing similar candidates for a task, such as different isotopes for brachytherapy or medical imaging. The table automatically highlights the minimum and maximum values in each numerical row and displays in-cell data bars to provide an immediate visual sense of magnitude. This view also includes an <strong>Export to CSV</strong> function, allowing you to save the comparison table as a text file that can be opened in a spreadsheet program like Excel for further analysis.
            </p>
            
            <h3 className="mt-6"><strong>Calculators</strong></h3>
            <p>The application includes a comprehensive suite of calculators for a wide range of radiological scenarios.</p>

            <h4 className="italic mt-4">Decay Calculators</h4>
            <ul>
                <li><strong>Decay:</strong> Based on the fundamental decay equation, this tool can solve for any one variable given the others. It's perfect for answering questions like "How much of my 100 mCi source will be left in 3 weeks?" or "How long will it take for this sample to decay to 1 mCi?". It also includes a Parent-Daughter mode to model the activity of a progeny nuclide over time, including its in-growth and decay.</li>
                <li><strong>Series Decay:</strong> This advanced tool uses the full Bateman equations to model the activity of <em>every</em> nuclide in a long decay chain (like the Uranium or Thorium series) over time. It provides both a final activity table and an interactive chart showing the in-growth and decay of each progeny.</li>
                <li><strong>Equilibrium:</strong> This calculator specifically analyzes a parent-daughter pair to determine their equilibrium relationship. It will automatically classify the relationship as <strong>Secular</strong> or <strong>Transient</strong> and calculate important metrics like the time to maximum daughter activity.</li>
            </ul>

            <h4 className="italic mt-4">Activity & Dose Calculators</h4>
            <ul>
                <li><strong>Mass ↔ Activity:</strong> Converts between a nuclide's mass and its activity using its half-life and atomic weight. It's useful for answering questions like "What is the activity of 5 micrograms of Plutonium-239?".</li>
                <li><strong>Specific Activity:</strong> Calculates a nuclide's specific activity (Bq/g) from its fundamental properties: atomic weight and half-life.</li>
                <li><strong>Dose Rate:</strong> Calculates the dose rate from a point source for gamma, beta, and bremsstrahlung radiation. It uses the nuclide's gamma constant (Γ) and the inverse square law for gammas, and specialized equations for beta and bremsstrahlung.</li>
                <li><strong>Shielding:</strong> This calculator models the attenuation of gamma radiation through a shield. It has three modes: <strong>From Source</strong> (calculates final dose rate from a known nuclide, activity, and shield thickness), <strong>Find Thickness</strong> (determines the thickness needed to reach a target dose rate), and <strong>Generic Rate</strong> (allows you to use a user-defined HVL for a custom material).</li>
                <li><strong>Stay Time:</strong> A practical tool for radiation safety that calculates the maximum time a person can stay in an area with a known dose rate before accumulating a specific dose limit. The dose rate can either be entered manually or calculated from a source.</li>
            </ul>
            
            <h4 className="italic mt-4">Transportation</h4>
            <p>This calculator determines the required shipping package type (Excepted, Type A, or Type B) for a given radionuclide and activity, based on its IAEA A<sub>1</sub> (Special Form) and A<sub>2</sub> (Normal Form) values. It's an essential tool for preparing radioactive material for transport.</p>

            <h3 className="mt-6"><strong>MARSSIM Tools</strong></h3>
            <p>This suite of calculators assists with the design and data assessment for a final status survey, following the guidance in the Multi-Agency Radiation Survey and Site Investigation Manual (MARSSIM).</p>
            <ul>
                <li><strong>MDA & Critical Level:</strong> Calculates key decision values for radiation counting. The <strong>Critical Level (L<sub>c</sub>)</strong> is the threshold for deciding if a signal is statistically significant. The <strong>Minimum Detectable Activity (MDA)</strong> is the smallest amount of activity you can reliably quantify. This tool includes modes for both static counts and scan surveys.</li>
                <li><strong>MARSSIM Samples:</strong> Helps determine the required number of statistical samples for a survey unit based on your desired error rates (α and β), the cleanup limit (DCGL), the expected background level (LBGR), and the variability of the contamination (σ).</li>
                <li><strong>WRS Test:</strong> Performs the Wilcoxon Rank Sum statistical test to compare a survey unit to a reference area. This is a non-parametric test used to determine if the survey unit passes. The result will indicate whether an Elevated Measurement Comparison (EMC) is also needed.</li>
                <li><strong>EMC Sign Test:</strong> Performs the Sign Test for an Elevated Measurement Comparison (EMC), used when individual measurements exceed the DCGL. This test helps determine if an isolated "hot spot" is acceptable.</li>
            </ul>

            <hr className="my-4" />
            
            <h2 className="text-slate-900 dark:text-slate-100"><strong>Settings & Customization</strong></h2>
            <p>The <strong>Settings</strong> panel, accessible from the gear icon in the top right, allows you to set default units for the main calculators. This can streamline your workflow by pre-populating inputs with your preferred units for **Activity**, **Dose Rate**, and **Distance**.</p>
            <ul>
                <li><strong>Activity:</strong> Set your preferred unit for activity (e.g., Ci, mCi, Bq). This will be the default for calculators like Dose Rate and Stay Time.</li>
                <li><strong>Dose Rate:</strong> Set your preferred dose rate unit (e.g., mrem/hr, µSv/hr). This will be the default for calculators like Dose Rate, Shielding, and Stay Time.</li>
                <li><strong>Distance:</strong> Set your preferred distance unit (e.g., m, cm, ft). This will be the default for calculators that require a distance from the source.</li>
            </ul>

            <hr className="my-4" />

            <h2 className="text-slate-900 dark:text-slate-100"><strong>Formulas & Equations Reference</strong></h2>
            <p>The following section provides the mathematical basis for the calculators used in this application.</p>

            <h3 className="mt-6">Decay & Activity Formulas</h3>
            <h4 className="italic mt-4">Radioactive Decay</h4>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>A(t) = A<sub>0</sub> * e<sup>-λt</sup></pre>
            </div>
            <ul>
                <li><code>A(t)</code> is the activity at time <code>t</code>.</li>
                <li><code>A<sub>0</sub></code> is the initial activity at <code>t=0</code>.</li>
                <li><code>λ</code> is the decay constant, calculated as <code>ln(2) / T<sub>1/2</sub></code>.</li>
            </ul>

            <h4 className="italic mt-4">Series (Bateman) Decay</h4>
            <p>For a decay chain <code>A → B → C</code>, the activity of the daughter <code>B</code> is given by:</p>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>A<sub>2</sub>(t) = [A<sub>1</sub>(0) * λ<sub>2</sub>/(λ<sub>2</sub>-λ<sub>1</sub>)] * [e<sup>-λ<sub>1</sub>t</sup> - e<sup>-λ<sub>2</sub>t</sup>] + A<sub>2</sub>(0)e<sup>-λ<sub>2</sub>t</sup></pre>
            </div>
            <p>The calculator solves the full system of Bateman equations for any chain length.</p>

            <h4 className="italic mt-4">Time to Maximum Daughter Activity</h4>
            <p>For a parent-daughter pair, the time at which the daughter's activity is at its peak is:</p>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>t<sub>max</sub> = ln(λ<sub>2</sub> / λ<sub>1</sub>) / (λ<sub>2</sub> - λ<sub>1</sub>)</pre>
            </div>

            <h4 className="italic mt-4">Specific Activity (SA) & Mass-Activity Conversion</h4>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>SA (Bq/g) = (N<sub>a</sub> * λ) / M<sub>a</sub> = (N<sub>a</sub> * ln(2)) / (T<sub>1/2</sub> * M<sub>a</sub>)</pre>
            </div>
            <ul>
                <li><code>N<sub>a</sub></code> is Avogadro's Number (6.022 x 10<sup>23</sup> atoms/mol).</li>
                <li><code>M<sub>a</sub></code> is the molar mass of the radionuclide (g/mol).</li>
                <li><code>T<sub>1/2</sub></code> is the half-life in seconds.</li>
            </ul>

            <h3 className="mt-6">Dose & Shielding Formulas</h3>
            <h4 className="italic mt-4">Dose Rate (Unshielded Point Source)</h4>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>Dose Rate = (Γ * A) / d²</pre>
            </div>
            <ul>
                <li><code>Ḋ</code> is the dose rate (e.g., mrem/hr).</li>
                <li><code>Γ</code> is the specific gamma-ray constant for the nuclide.</li>
                <li><code>A</code> is the source activity.</li>
                <li><code>d</code> is the distance from the source.</li>
            </ul>

            <h4 className="italic mt-4">Shielding</h4>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>D<sub>shielded</sub> = D<sub>unshielded</sub> * (0.5)<sup>(x / HVL)</sup></pre>
            </div>
            <ul>
                <li><code>D<sub>shielded</sub></code> is the shielded dose rate.</li>
                <li><code>x</code> is the shield thickness.</li>
                <li><code>HVL</code> is the half-value layer thickness for the shield material.</li>
            </ul>

            <h4 className="italic mt-4">Stay Time</h4>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>Stay Time = Dose Limit / Dose Rate</pre>
            </div>

            <h3 className="mt-6">MARSSIM Formulas</h3>
            <h4 className="italic mt-4">Critical Level (L<sub>c</sub>) & MDA</h4>
            <p>The decision level for detecting activity above background is calculated from the standard deviation of the background count:</p>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>L<sub>c</sub> (counts) = 1.645 * sqrt(Background_Counts * (1 + Gross_Time / Bkg_Time))</pre>
            </div>
            <p>The Minimum Detectable Activity (MDA) is then calculated from the <strong>Lower Limit of Detection (LLD)</strong>, which is derived from the L<sub>c</sub>:</p>
            <div className="my-2 p-3 text-center font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre className="text-sm">LLD (counts) = 2 * L<sub>c</sub> + 3</pre>
                <pre className="mt-2 text-sm">MDA (dpm/100cm²) = (LLD / Gross_Time) * (100 / Probe_Area) / Total<sub>Efficiency</sub></pre>
            </div>
            <ul>
                <li><code>L<sub>c</sub></code> is the <strong>Critical Level</strong>; a result above this is statistically significant.</li>
                <li><code>LLD</code> is the smallest net count that can be reliably quantified.</li>
                <li><code>Total<sub>Efficiency</sub></code> is the instrument efficiency multiplied by the surface efficiency.</li>
            </ul>

            <h4 className="italic mt-4">Number of Samples</h4>
            <p>The number of samples (N) is calculated based on the desired error rates and the "Relative Shift":</p>
            <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                <pre>Relative Shift = (DCGL - LBGR) / σ</pre>
            </div>
            <p>This value is looked up in a MARSSIM table or used in a formula to find the base number of samples required, which is then adjusted for statistical overage.</p>

            <h4 className="italic mt-4">WRS & Sign Tests</h4>
            <p>These are non-parametric statistical hypothesis tests. Rather than a simple formula, they are procedural:</p>
            <ul>
                <li><strong>WRS Test:</strong> All measurements from the survey unit and reference area are combined and ranked from lowest to highest. The sum of the ranks from the survey unit (W<sub>s</sub>) is calculated and compared to a critical value from a table to test the null hypothesis.</li>
                <li><strong>Sign Test:</strong> Each measurement in an elevated area is compared to the DCGL. The test counts how many measurements exceed the DCGL. This count is the test statistic (S+) which is compared to a critical value from the binomial distribution to test the null hypothesis.</li>
            </ul>
            
            <hr className="my-4" />

            <h2 className="text-slate-900 dark:text-slate-100"><strong>Frequently Asked Questions (FAQ)</strong></h2>
            
            <h4 className="italic mt-4">Where does the data come from?</h4>
            <p>The core nuclear data (half-life, decay modes, emission energies, etc.) is sourced from the National Nuclear Data Center's (NNDC) NuDat 3 database, a widely recognized authority. Gamma constants and Half-Value Layer (HVL) data are standard, commonly-cited values from health physics texts and publications from organizations like the Health Physics Society (HPS).</p>

            <h4 className="italic mt-4">Why doesn't a specific nuclide appear in a calculator?</h4>
            <p>Calculators are populated only with nuclides that have the necessary data. For example, the <strong>Dose Rate</strong>, <strong>Shielding</strong>, and <strong>Stay Time</strong> calculators all require a nuclide to have a defined "Gamma Constant" (Γ). Therefore, pure beta emitters (like Tritium or Strontium-90) or pure alpha emitters will not be available in those specific tools. Additionally, certain calculations (like the parent-daughter equilibrium) only feature nuclides with known progeny that are themselves radioactive.</p>
            
            <h4 className="italic mt-4">What is the disclaimer?</h4>
            <p><strong>This tool is for informational and educational purposes only.</strong> The data and calculations have not been independently validated for accuracy and may contain errors. It should not be used for radiation protection, safety-critical applications, or for demonstrating regulatory compliance. All use of this tool is at your own risk.</p>
        </div>
    );
};

        const ManualModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            // Internal component for the static content of the manual to keep JSX clean.

            return (

                // The modal backdrop, which closes the modal when clicked.

		<div className="fixed inset-0 bg-black/60 z-50 flex justify-center items-start p-4" onClick={onClose}>

                    {/* The modal panel itself. e.stopPropagation() prevents a click inside from closing it. */}

                    <div className="bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <h2 className="text-xl font-bold">User Manual & FAQ</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                                <Icon path={ICONS.clear} className="w-6 h-6" />
                            </button>
                        </div>
                        <div className="overflow-y-auto">
                            <ManualContent />
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * @description The root component of the entire application.
         * It manages all primary state, handles routing between views, and orchestrates all user interactions.
         */


const App = () => {
            // --- STATE MANAGEMENT ---
            const [activeView, setActiveView] = React.useState('home');
	        const [previousView, setPreviousView] = React.useState(null);
            const [result, setResult] = React.useState(null);
            const [errorMessage, setErrorMessage] = React.useState('');
            const [preselectedNuclide, setPreselectedNuclide] = React.useState(null);
            const [comparisonList, setComparisonList] = React.useState([]);
            const [nuclideName, setNuclideName] = React.useState('');
            const [suggestions, setSuggestions] = React.useState([]);
            const [activeSuggestionIndex, setActiveSuggestionIndex] = React.useState(-1);
            const [isManualOpen, setIsManualOpen] = React.useState(false);
            const [isFiltersVisible, setIsFiltersVisible] = React.useState(false);
            const [displayHalfLifeUnit, setDisplayHalfLifeUnit] = React.useState('years');
            const [currentDecaySeriesId, setCurrentDecaySeriesId] = React.useState(null);
            const [theme, setTheme] = React.useState(() => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            const [searchHistory, setSearchHistory] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideSearchHistory') || '[]'); } catch (e) { return []; } });
            const [favorites, setFavorites] = React.useState(() => { try { return JSON.parse(localStorage.getItem('favoriteNuclides') || '[]'); } catch (e) { return []; } });
            const [randomSuggestions, setRandomSuggestions] = React.useState([]);
            
    const [sortBy, setSortBy] = React.useState(() => localStorage.getItem('filterSortBy') || 'name');
    const [sortOrder, setSortOrder] = React.useState(() => localStorage.getItem('filterSortOrder') || 'asc');
    const [selectedCategory, setSelectedCategory] = React.useState(() => localStorage.getItem('filterCategory') || 'All');
    const [selectedEmissionType, setSelectedEmissionType] = React.useState(() => localStorage.getItem('filterEmissionType') || 'All');
    const [selectedCommonality, setSelectedCommonality] = React.useState(() => localStorage.getItem('filterCommonality') || 'All');
    const [minAlphaEnergy, setMinAlphaEnergy] = React.useState(() => localStorage.getItem('filterMinAlphaEnergy') || '');
    const [maxAlphaEnergy, setMaxAlphaEnergy] = React.useState(() => localStorage.getItem('filterMaxAlphaEnergy') || '');
    const [minBetaEnergy, setMinBetaEnergy] = React.useState(() => localStorage.getItem('filterMinBetaEnergy') || '');
    const [maxBetaEnergy, setMaxBetaEnergy] = React.useState(() => localStorage.getItem('filterMaxBetaEnergy') || '');
    const [minGammaEnergy, setMinGammaEnergy] = React.useState(() => localStorage.getItem('filterMinGammaEnergy') || '');
    const [maxGammaEnergy, setMaxGammaEnergy] = React.useState(() => localStorage.getItem('filterMaxGammaEnergy') || '');
    const [minHalfLife, setMinHalfLife] = React.useState(() => localStorage.getItem('filterMinHalfLife') || '');
    const [maxHalfLife, setMaxHalfLife] = React.useState(() => localStorage.getItem('filterMaxHalfLife') || '');
    const [halfLifeFilterUnit, setHalfLifeFilterUnit] = React.useState(() => localStorage.getItem('filterHalfLifeUnit') || 'years');

            const mainContentRef = React.useRef(null);

             const scrollPositionRef = React.useRef(0);

            const inputRef = React.useRef(null);
            const suggestionsRef = React.useRef(null);
            const { addToast } = useToast();

const scrollToMainContent = () => {
    // Check if the screen is in mobile mode (less than 768px)
    const isMobile = window.innerWidth < 768;

    if (isMobile && mainContentRef.current) {
        mainContentRef.current.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
        });
    }
};

const handleNavClick = (view) => {


                setPreselectedNuclide(null);
                setActiveView(view);
                setCurrentDecaySeriesId(null);
                setIsFiltersVisible(false);
                if (view === 'home') {
                    setResult(null);
                    setNuclideName('');
                    setSuggestions([]);
                    setErrorMessage('');
                    
                }
                scrollToMainContent();
            };

            const handleSendToCalculator = (viewId, nuclideSymbol) => {
                setPreselectedNuclide(nuclideSymbol);
                setActiveView(viewId);
            };

            const handleAddToCompare = (nuclideSymbol) => {
                const nuclideToAdd = radionuclides.find(n => n.symbol === nuclideSymbol);
                if (nuclideToAdd && !comparisonList.find(n => n.symbol === nuclideSymbol)) {
                    setComparisonList(prevList => [...prevList, nuclideToAdd]);
                    addToast(`${nuclideToAdd.name} added to comparison.`);
                } else if (nuclideToAdd) {
                    addToast(`${nuclideToAdd.name} is already in the comparison.`);
                }
                setActiveView('compare');
            };

            const handleRemoveFromCompare = (nuclideSymbol) => {
                setComparisonList(prevList => prevList.filter(n => n.symbol !== nuclideSymbol));
            };

React.useEffect(() => {
    localStorage.setItem('filterSortBy', sortBy);
    localStorage.setItem('filterSortOrder', sortOrder);
    localStorage.setItem('filterCategory', selectedCategory);
    localStorage.setItem('filterEmissionType', selectedEmissionType);
    localStorage.setItem('filterCommonality', selectedCommonality);
    localStorage.setItem('filterMinAlphaEnergy', minAlphaEnergy);
    localStorage.setItem('filterMaxAlphaEnergy', maxAlphaEnergy);
    localStorage.setItem('filterMinBetaEnergy', minBetaEnergy);
    localStorage.setItem('filterMaxBetaEnergy', maxBetaEnergy);
    localStorage.setItem('filterMinGammaEnergy', minGammaEnergy);
    localStorage.setItem('filterMaxGammaEnergy', maxGammaEnergy);
    localStorage.setItem('filterMinHalfLife', minHalfLife);
    localStorage.setItem('filterMaxHalfLife', maxHalfLife);
    localStorage.setItem('filterHalfLifeUnit', halfLifeFilterUnit);
}, [sortBy, sortOrder, selectedCategory, selectedEmissionType, selectedCommonality, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit]);

            React.useEffect(() => {
                const root = window.document.documentElement;
                root.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('theme', theme);
            }, [theme]);

            React.useEffect(() => {
                const handleClickOutside = (e) => {
                    if (suggestionsRef.current && !suggestionsRef.current.contains(e.target) && inputRef.current && !inputRef.current.contains(e.target)) {
                        setSuggestions([]);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            React.useEffect(() => {
                const common = radionuclides.filter(n => n.commonality === 'Common');
                setRandomSuggestions([...common].sort(() => 0.5 - Math.random()).slice(0, 5));
            }, []);

            const allCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.category))].sort()], []);
            const allEmissionTypes = React.useMemo(() => ['All', ...[...new Set(radionuclides.flatMap(n => n.emissionType || []))].sort()], []);
            const allCommonalityCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.commonality).filter(Boolean))].sort()], []);

            const getFilteredAndSortedRadionuclides = React.useCallback(() => {
                let filtered = [...radionuclides];
                if (selectedCategory !== 'All') { filtered = filtered.filter(n => n.category === selectedCategory); }
                if (selectedEmissionType !== 'All') { filtered = filtered.filter(n => n.emissionType?.includes(selectedEmissionType)); }
                if (selectedCommonality !== 'All') { filtered = filtered.filter(n => n.commonality === selectedCommonality); }
                const filterByEnergyRange = (nuclide, type, min, max) => {
                    const energy = parseEnergyToMeV(nuclide.emissionEnergies?.[type]);
                    if (energy === 0 && (min || max)) return false;
                    const minVal = parseFloat(min); const maxVal = parseFloat(max);
                    if (!isNaN(minVal) && !isNaN(maxVal)) return energy >= minVal && energy <= maxVal;
                    if (!isNaN(minVal)) return energy >= minVal;
                    if (!isNaN(maxVal)) return energy <= maxVal;
                    return true;
                };
                if (minAlphaEnergy || maxAlphaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'alpha', minAlphaEnergy, maxAlphaEnergy));
                if (minBetaEnergy || maxBetaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'beta', minBetaEnergy, maxBetaEnergy));
                if (minGammaEnergy || maxGammaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'gamma', minGammaEnergy, maxGammaEnergy));
                if (minHalfLife || maxHalfLife) {
                    const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
                    const minSeconds = minHalfLife ? parseFloat(minHalfLife) * unitConversions[halfLifeFilterUnit] : null;
                    const maxSeconds = maxHalfLife ? parseFloat(maxHalfLife) * unitConversions[halfLifeFilterUnit] : null;
                    filtered = filtered.filter(n => {
                        const nuclideSeconds = parseHalfLifeToSeconds(n.halfLife);
                        if (nuclideSeconds === Infinity && (minSeconds || maxSeconds)) return false;
                        const checkMin = minSeconds ? nuclideSeconds >= minSeconds : true;
                        const checkMax = maxSeconds ? nuclideSeconds <= maxSeconds : true;
                        return checkMin && checkMax;
                    });
                }
                filtered.sort((a, b) => {
                    let compare = 0;
                    if (sortBy === 'name') compare = a.name.localeCompare(b.name);
                    else if (sortBy === 'halfLife') compare = parseHalfLifeToSeconds(a.halfLife) - parseHalfLifeToSeconds(b.halfLife);
                    else if (sortBy === 'alphaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.alpha) - parseEnergyToMeV(b.emissionEnergies?.alpha);
                    else if (sortBy === 'betaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.beta) - parseEnergyToMeV(b.emissionEnergies?.gamma);
                    else if (sortBy === 'gammaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.gamma) - parseEnergyToMeV(b.emissionEnergies?.gamma);
                    return sortOrder === 'asc' ? compare : -compare;
                });
                return filtered;
            }, [selectedCategory, selectedEmissionType, selectedCommonality, sortBy, sortOrder, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit]);

            const filteredList = getFilteredAndSortedRadionuclides();
            const toggleTheme = () => setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            const handleClearHistory = () => { setSearchHistory([]); localStorage.removeItem('radionuclideSearchHistory'); };
            const handleDecaySeriesClick = (seriesId) => { setCurrentDecaySeriesId(seriesId); setActiveView('decaySeries'); };
            const toggleFavorite = (symbol) => {
                const nuclide = radionuclides.find(n => n.symbol === symbol);
                const isCurrentlyFavorite = favorites.includes(symbol);
                const newFavorites = isCurrentlyFavorite ? favorites.filter(s => s !== symbol) : [...favorites, symbol];
                setFavorites(newFavorites);
                localStorage.setItem('favoriteNuclides', JSON.stringify(newFavorites));
                if (isCurrentlyFavorite) { addToast(`${nuclide ? nuclide.name : symbol} removed from favorites.`); } 
                else { addToast(`${nuclide ? nuclide.name : symbol} added to favorites!`); }
            };
            const handleClearFavorites = () => {
                setFavorites([]);
                localStorage.removeItem('favoriteNuclides');
            };
            const updateSearchHistory = (nuclide) => {
                setSearchHistory(prev => {
                    const newHistory = [nuclide.symbol, ...prev.filter(symbol => symbol !== nuclide.symbol)];
                    const limitedHistory = newHistory.slice(0, 5);
                    localStorage.setItem('radionuclideSearchHistory', JSON.stringify(limitedHistory));
                    return limitedHistory;
                });
            }
            const handleNuclideSelection = (nuclide) => {
                setNuclideName(nuclide.name);
                setResult(nuclide);
                setSuggestions([]);
                setErrorMessage('');
                setPreviousView(activeView); // <-- ADD THIS LINE to remember where we came from
                setActiveView('home');
                setCurrentDecaySeriesId(null);
                setDisplayHalfLifeUnit(getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)));
                updateSearchHistory(nuclide);
		        setPreviousView(activeView);

            };
            const handleNuclideNameChange = (e) => {
                const value = e.target.value;
                setNuclideName(value);
                if (value.length > 0) {
                    const normVal = normalizeString(value);
                    const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1, 'N/A': 0, undefined: 0 };
                    const filtered = radionuclides.filter(n => normalizeString(n.name).includes(normVal) || normalizeString(n.symbol).includes(normVal)).sort((a, b) => {
                        const aStartsWith = normalizeString(a.name).startsWith(normVal) || normalizeString(a.symbol).startsWith(normVal);
                        const bStartsWith = normalizeString(b.name).startsWith(normVal) || normalizeString(b.symbol).startsWith(normVal);
                        if (aStartsWith !== bStartsWith) return aStartsWith ? -1 : 1;
                        const orderA = commonalityOrder[a.commonality] || 0;
                        const orderB = commonalityOrder[b.commonality] || 0;
                        if (orderB !== orderA) return orderB - orderA;
                        return a.name.localeCompare(b.name);
                    }).slice(0, 10);
                    setSuggestions(filtered);
                } else {
                    setSuggestions([]);
                    setResult(null);
                }
            };
            const handleClearFilters = () => {
    setSortBy('name');
    setSortOrder('asc');
    setSelectedCategory('All');
    setSelectedEmissionType('All');
    setSelectedCommonality('All');
    setMinAlphaEnergy('');
    setMaxAlphaEnergy('');
    setMinBetaEnergy('');
    setMaxBetaEnergy('');
    setMinGammaEnergy('');
    setMaxGammaEnergy('');
    setMinHalfLife('');
    setMaxHalfLife('');
    setHalfLifeFilterUnit('years');
};
            const handleLookup = () => {
                setSuggestions([]);
                const normInput = normalizeString(nuclideName);
                const found = radionuclides.find(n => normalizeString(n.name) === normInput || normalizeString(n.symbol) === normInput);
                if (found) {
                    handleNuclideSelection(found);
                } else {
                    setResult(null);
                    setErrorMessage(`Nuclide "${nuclideName}" not found.`);
                    setActiveView('home');
                }
            };
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (activeSuggestionIndex !== -1 && suggestions.length > 0) {
                        handleNuclideSelection(suggestions[activeSuggestionIndex]);
                    } else {
                        handleLookup();
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setActiveSuggestionIndex(prev => (prev < suggestions.length - 1 ? prev + 1 : 0));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setActiveSuggestionIndex(prev => (prev > 0 ? prev - 1 : suggestions.length - 1));
                } else if (e.key === 'Escape') {
                    setSuggestions([]);
                }
            };

const renderActiveView = () => {
    const filterProps = { sortBy, setSortBy, sortOrder, setSortOrder, selectedCategory, setSelectedCategory, allCategories, selectedEmissionType, setSelectedEmissionType, allEmissionTypes, selectedCommonality, setSelectedCommonality, allCommonalityCategories, minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy, minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy, minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy, minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit };

    switch (activeView) {
        case 'database': 
            return <DatabaseView 
                filteredList={filteredList} 
                onNuclideClick={handleNuclideSelection} 
                filterProps={filterProps} 
                isFiltersVisible={isFiltersVisible} 
                setIsFiltersVisible={setIsFiltersVisible} 
                scrollPositionRef={scrollPositionRef} 
                handleClearFilters={handleClearFilters} // <-- This is the crucial line
            />;
        case 'calculator': return <DecayCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
        case 'mda': return <MDACalculator />;
        case 'marssim': return <MARSSIM_SampleCalculator />;
        case 'wrs': return <WRS_Calculator />;
        case 'emc': return <EMC_Calculator />;
        case 'seriesCalculator': return <DecaySeriesCalculator radionuclides={radionuclides} decaySeriesData={decaySeriesData} />;
        case 'equilibrium': return <EquilibriumCalculator radionuclides={radionuclides} />;
        case 'compare': return <ComparisonView radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} comparisonList={comparisonList} onAddToCompare={handleAddToCompare} onRemoveFromCompare={handleRemoveFromCompare} />;
        case 'massActivity': return <MassActivityCalculator radionuclides={radionuclides} />;
        case 'specificActivity': return <SpecificActivityCalculator />;
        case 'doseRate': return <DoseRateCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
        case 'shielding': return <ShieldingCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
        case 'stayTime': return <StayTimeCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
        case 'transportation': return <TransportationCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
        case 'converter': return <UnitConverter />;
        case 'settings': return <SettingsPanel />;
        case 'decaySeries': return <DecaySeriesViewer seriesId={currentDecaySeriesId} onBack={() => setActiveView('home')} onNuclideClick={handleNuclideSelection} />;
        case 'home':
        default:
if (result) {
                return <div className="p-4">
                    <NuclideCard
                        nuclide={result}
                        radionuclides={radionuclides}
                        onDecaySeriesClick={handleDecaySeriesClick}
                        displayHalfLifeUnit={displayHalfLifeUnit}
                        favorites={favorites}
                        toggleFavorite={toggleFavorite}
                        onSendToCalculator={handleSendToCalculator}
                        onAddToCompare={handleAddToCompare}
                        onNuclideClick={handleNuclideSelection}
                        showBackButton={previousView === 'database'}
                        onBackClick={() => {
                            setActiveView('database');
                            setResult(null);
                            setPreviousView(null);
                        }}
                    />
                </div>;
            }
            return <HomePage
                errorMessage={errorMessage}
                randomSuggestions={randomSuggestions}
                searchHistory={searchHistory}
                handleNuclideSelection={handleNuclideSelection}
                handleClearHistory={handleClearHistory}
                favorites={favorites}
                radionuclides={radionuclides}
                handleClearFavorites={handleClearFavorites}
            />;
    }
};

return (
    <div className="min-h-screen p-0 sm:p-2 md:p-4 text-slate-800 dark:text-slate-200">
        <div className="max-w-7xl mx-auto bg-white dark:bg-slate-900/70 rounded-none sm:rounded-2xl shadow-2xl backdrop-blur-lg border-slate-200 dark:border-slate-800">
            
            <Header onHelpClick={() => setIsManualOpen(true)} theme={theme} toggleTheme={toggleTheme} onNavClick={handleNavClick} />

                <SearchBar nuclideName={nuclideName} inputRef={inputRef} handleNuclideNameChange={handleNuclideNameChange} handleKeyDown={handleKeyDown} onClear={() => { setNuclideName(''); setSuggestions([]); setResult(null); }} suggestions={suggestions} activeSuggestionIndex={activeSuggestionIndex} suggestionsRef={suggestionsRef} handleNuclideSelection={handleNuclideSelection} onNavClick={handleNavClick} />
            
                <MainNav activeView={activeView} onNavClick={handleNavClick} />
            
            <main ref={mainContentRef} className="min-h-[400px]">
                {renderActiveView()}
            </main>
<footer className="text-center p-6 mt-4 border-t border-slate-200 dark:border-slate-700">
    <p className="text-xs text-slate-500 dark:text-slate-400">
        <strong>Disclaimer:</strong> This tool is for informational and educational purposes only. The data and calculations have not been validated and may contain errors. Use of this tool is at your own risk.
    </p>
    {/* This is the donation button for mobile, hidden on larger screens */}
    <div className="mt-4 flex justify-center md:hidden">
        <a href="https://www.buymeacoffee.com/jough" target="_blank">
            <img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} />
        </a>
    </div>
</footer>
            <ManualModal isOpen={isManualOpen} onClose={() => setIsManualOpen(false)} />
        </div>
    </div>
);
        };


     


	/**
	 * @description A searchable dropdown component for selecting items from a large list, with tooltips.
	 */
	const SearchableSelect = ({ options, onSelect, placeholder }) => {
	    const [inputValue, setInputValue] = React.useState('');
	    const [isOpen, setIsOpen] = React.useState(false);
	    const [activeIndex, setActiveIndex] = React.useState(-1);
	    const containerRef = React.useRef(null);
	    const listRef = React.useRef(null);

	    const filteredOptions = React.useMemo(() => {
	        if (!inputValue) return [];
	        const normInput = normalizeString(inputValue);
	        const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 };
	    
	        return options
	            .filter(opt => normalizeString(opt.name).includes(normInput) || normalizeString(opt.symbol).includes(normInput))
	            .sort((a, b) => {
	                const aStartsWith = normalizeString(a.name).startsWith(normInput) || normalizeString(a.symbol).startsWith(normInput);
	                const bStartsWith = normalizeString(b.name).startsWith(normInput) || normalizeString(b.symbol).startsWith(normInput);
	                if (aStartsWith !== bStartsWith) return aStartsWith ? -1 : 1;
	                const orderA = commonalityOrder[a.commonality] || 0;
	                const orderB = commonalityOrder[b.commonality] || 0;
	                if (orderB !== orderA) return orderB - orderA;
	                return a.name.localeCompare(b.name);
	            })
	            .slice(0, 10);
	    }, [inputValue, options]);
	    
	    React.useEffect(() => {
	        const handleClickOutside = (event) => {
	            if (containerRef.current && !containerRef.current.contains(event.target)) {
	                setIsOpen(false);
	            }
	        };
	        document.addEventListener('mousedown', handleClickOutside);
	        return () => document.removeEventListener('mousedown', handleClickOutside);
	    }, []);
    
	    const handleKeyDown = (e) => {
	        if (filteredOptions.length === 0) return;
	        if (e.key === 'ArrowDown') {
	            e.preventDefault();
	            setActiveIndex(prev => (prev < filteredOptions.length - 1 ? prev + 1 : 0));
	        } else if (e.key === 'ArrowUp') {
	            e.preventDefault();
	            setActiveIndex(prev => (prev > 0 ? prev - 1 : filteredOptions.length - 1));
	        } else if (e.key === 'Enter') {
	            if (activeIndex > -1 && filteredOptions[activeIndex]) {
	                handleSelect(filteredOptions[activeIndex]);
	            } else if (filteredOptions.length > 0) {
	                handleSelect(filteredOptions[0]);
	            }
	        } else if (e.key === 'Escape') {
	            setIsOpen(false);
	        }
	    };
    
	    React.useEffect(() => {
	        if (activeIndex !== -1 && listRef.current?.children[activeIndex]) {
	            listRef.current.children[activeIndex].scrollIntoView({ block: 'nearest' });
	        }
	    }, [activeIndex]);

	    const handleSelect = (option) => {
	        onSelect(option.symbol);
	        setInputValue('');
	        setIsOpen(false);
	        setActiveIndex(-1);
	    };

	    return (
	        <div className="relative w-full" ref={containerRef}>
	            <div className="relative">
	                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
	                     <Icon path={ICONS.search} className="w-5 h-5 text-slate-400" />
	                </div>
	                <input
	                    type="text"
	                    value={inputValue}
	                    onChange={(e) => {
	                        setInputValue(e.target.value);
	                        setIsOpen(true);
	                        setActiveIndex(-1);
	                    }}
	                    onKeyDown={handleKeyDown}
	                    onFocus={() => { if(inputValue) setIsOpen(true); }}
	                    placeholder={placeholder}
	                    className="w-full p-2 pl-10 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"
	                    autoComplete="off"
	                />
	            </div>
	            {isOpen && filteredOptions.length > 0 && (
	                <ul ref={listRef} className="absolute z-30 w-full mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-60 overflow-y-auto">
        	            {filteredOptions.map((option, index) => (
                            <Tooltip key={option.symbol} text={generateQuickInfoText(option)}>
                                <li
	                                onClick={() => handleSelect(option)}
	                                onMouseEnter={() => setActiveIndex(index)}
	                                className={`w-full p-3 cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-sky-100 dark:hover:bg-sky-900 ${
	                                    index === activeIndex ? 'bg-sky-100 dark:bg-sky-900' : ''
	                                }`}
	                            >
	                                {option.name} ({option.symbol})
	                            </li>
                            </Tooltip>
	                    ))}
	                </ul>
	            )}
	        </div>
	    );
	};

/**
 * @description An advanced view for comparing multiple radionuclides side-by-side.
 * Features dynamic highlighting, in-cell data bars, and an integrated
 * percentage difference tag when comparing two nuclides.
 */
const ComparisonView = ({ radionuclides, onNuclideClick, comparisonList, onAddToCompare, onRemoveFromCompare }) => {
    
    const sortedNuclides = React.useMemo(() =>
        [...radionuclides].sort((a, b) => a.name.localeCompare(b.name)),
        [radionuclides]
    );

    const handleAddNuclide = (symbol) => {
        onAddToCompare(symbol);
    };
    
    const propertiesToCompare = [
        { label: 'Half-life (seconds)', key: 'halfLife', type: 'numeric', format: (val) => parseHalfLifeToSeconds(val) },
        { label: 'Emission Type(s)', key: 'emissionType', type: 'categorical', format: (val) => val?.join(', ') || 'N/A' },
        { label: 'Alpha Energy (MeV)', key: 'emissionEnergies', type: 'numeric', format: (val) => parseEnergyToMeV(val?.alpha) },
        { label: 'Beta Energy (MeV)', key: 'emissionEnergies', type: 'numeric', format: (val) => parseEnergyToMeV(val?.beta) },
        { label: 'Gamma Energy (MeV)', key: 'emissionEnergies', type: 'numeric', format: (val) => parseEnergyToMeV(val?.gamma) },
        { label: 'Specific Activity (Bq/g)', key: 'specificActivity', type: 'numeric', format: (val) => parseSpecificActivity(val) },
        { label: 'Gamma Constant', key: 'gammaConstant', type: 'numeric', format: (val) => parseFloat(val) },
        { label: 'Parent', key: 'parent', type: 'categorical' },
        { label: 'Daughter', key: 'daughter', type: 'categorical' },
    ];

    const handleExportToCSV = (properties, nuclides) => {
        const headers = ['Property', ...nuclides.map(n => n.name)];
        
        const rows = properties.map(prop => {
            const rowData = [prop.label];
            nuclides.forEach(nuclide => {
                const rawValue = prop.key === 'emissionEnergies' ? nuclide.emissionEnergies : nuclide[prop.key];
                const formattedValue = prop.format ? prop.format(rawValue) : (rawValue || 'N/A');
                
                if (typeof formattedValue === 'number' && !isNaN(formattedValue) && formattedValue !== Infinity) {
                    rowData.push(formattedValue.toExponential(3));
                } else {
                    // Enclose strings with commas in quotes to prevent CSV errors
                    const cleanString = String(formattedValue).includes(',') ? `"${formattedValue}"` : formattedValue;
                    rowData.push(cleanString);
                }
            });
            return rowData.join(',');
        });

        const csvContent = [headers.join(','), ...rows].join('\n');
        
        // Create a blob and trigger a download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "radionuclide_comparison.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-7xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Compare Radionuclides</h2>
                    {comparisonList.length > 0 && (
                        <button 
                            onClick={() => handleExportToCSV(propertiesToCompare, comparisonList)}
                            className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2"
                        >
                            <Icon path={ICONS.database} className="w-4 h-4" />
                            Export to CSV
                        </button>
                    )}
                </div>
                
                <div className="flex items-center gap-2 mb-6 p-4 bg-slate-100 dark:bg-slate-800/50 rounded-lg">
                    <SearchableSelect
                        options={sortedNuclides.filter(n => !comparisonList.find(c => c.symbol === n.symbol))}
                        onSelect={handleAddNuclide}
                        placeholder="Search to add a nuclide..."/>
                </div>

                {comparisonList.length === 0 ? (
                    <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg">
                        <h3 className="text-lg font-semibold">The Comparison Table is Empty</h3>
                        <p className="text-slate-500 dark:text-slate-400 mt-2">Use the search box or a nuclide's detail card to add to the comparison.</p>
                    </div>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[600px] text-left border-collapse">
                            <thead>
                                <tr>
                                    <th className="sticky left-0 bg-slate-50 dark:bg-slate-700 p-3 text-sm font-semibold z-10 border-b border-r border-slate-200 dark:border-slate-600">Property</th>
                                    {comparisonList.map(nuclide => (
                                        <th key={nuclide.symbol} className="p-3 text-sm font-semibold border-b border-slate-200 dark:border-slate-600">
                                            <div className="flex justify-between items-center">
                                                <span className="cursor-pointer hover:text-sky-500" onClick={() => onNuclideClick(nuclide)}>{nuclide.name}</span>
                                                <button onClick={() => onRemoveFromCompare(nuclide.symbol)} className="ml-2 text-red-400 hover:text-red-600 font-bold">✕</button>
                                            </div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {propertiesToCompare.map(prop => {
                                    let values = [], maxVal = -Infinity, minVal = Infinity;
                                    if (prop.type === 'numeric') {
                                        values = comparisonList.map(nuclide => {
                                            const rawValue = prop.key === 'emissionEnergies' ? nuclide.emissionEnergies : nuclide[prop.key];
                                            const formattedVal = prop.format(rawValue);
                                            return isNaN(formattedVal) || formattedVal === Infinity ? null : formattedVal;
                                        }).filter(v => v !== null);
                                        
                                        if (values.length > 1) {
                                            maxVal = Math.max(...values);
                                            minVal = Math.min(...values);
                                        }
                                    }

                                    return (
                                        <tr key={prop.label} className="group hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                            <td className="sticky left-0 bg-white dark:bg-slate-800 group-hover:bg-slate-50 dark:group-hover:bg-slate-800/50 p-3 font-medium text-slate-500 dark:text-slate-400 border-b border-r border-slate-200 dark:border-slate-600 z-10">{prop.label}</td>
                                            
                                            {comparisonList.map((nuclide, nuclideIndex) => {
                                                const rawValue = prop.key === 'emissionEnergies' ? nuclide.emissionEnergies : nuclide[prop.key];
                                                const formattedValue = prop.format ? prop.format(rawValue) : (rawValue || 'N/A');
                                                let cellClass = 'border-b border-slate-200 dark:border-slate-600';
                                                let displayValue = formattedValue;
                                                
                                                if(prop.type === 'numeric') {
                                                    const numericVal = parseFloat(formattedValue);
                                                    displayValue = isNaN(numericVal) || numericVal === Infinity ? 'N/A' : numericVal.toExponential(2);
                                                    if (values.length > 1 && numericVal === maxVal && maxVal !== minVal) cellClass += ' bg-sky-100 dark:bg-sky-900/50 font-bold text-sky-800 dark:text-sky-200';
                                                    if (values.length > 1 && numericVal === minVal && maxVal !== minVal) cellClass += ' bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200';
                                                }
                                                const barWidth = (prop.type === 'numeric' && maxVal > 0) ? (formattedValue / maxVal) * 100 : 0;

                                                let differenceTag = null;
                                                if (comparisonList.length === 2 && nuclideIndex === 1 && prop.type === 'numeric') {
                                                    const val1 = values[0];
                                                    const val2 = values[1];
                                                    if (val1 !== null && val2 !== null && !isNaN(val1) && !isNaN(val2) && val1 !== 0) {
                                                        const diff = ((val2 - val1) / val1) * 100;
                                                        const diffColor = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                                        const sign = diff >= 0 ? '+' : '';
                                                        differenceTag = <span className={`block text-xs font-semibold mt-1 ${diffColor}`}>{`${sign}${diff.toFixed(1)}% vs. ${comparisonList[0].symbol}`}</span>;
                                                    }
                                                }

                                                return (
                                                    <td key={nuclide.symbol} className={`${cellClass} p-3 relative`}>
                                                        {prop.type === 'numeric' && barWidth > 0 && <div className="absolute left-0 top-0 h-full bg-slate-200 dark:bg-slate-700/50 opacity-50" style={{ width: `${barWidth}%` }}></div>}
                                                        <div className="relative">
                                                            <span>{displayValue}</span>
                                                            {differenceTag}
                                                        </div>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
};

/**
     * @description A unified calculator for dose rate from various source types and geometries.
     * - Gamma Mode: Calculates dose from Point, Line, or Area sources.
     * - Beta Mode: Calculates skin dose from a beta point source, accounting for range in air.
     * - Bremsstrahlung Mode: Calculates dose from X-rays produced by a beta source.
     */

const DoseRateCalculator = ({ radionuclides, preselectedNuclide }) => {
    // --- STATE MANAGEMENT ---
    
    const { settings } = React.useContext(SettingsContext); // <-- Add this line to get settings

    const [calcMode, setCalcMode] = React.useState('gamma');
    const [geometryMode, setGeometryMode] = React.useState('point');
    const [nuclideSymbol, setNuclideSymbol] = React.useState('');
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState(settings.activity); // <-- Use global setting
    const [distance, setDistance] = React.useState('1');
    const [distanceUnit, setDistanceUnit] = React.useState(settings.distance); // <-- Use global setting
    const [lineLength, setLineLength] = React.useState('1');
    const [lineLengthUnit, setLineLengthUnit] = React.useState('m');
    const [diskRadius, setDiskRadius] = React.useState('10');
    const [diskRadiusUnit, setDiskRadiusUnit] = React.useState('cm');
    const [shieldMaterial, setShieldMaterial] = React.useState('Plastic');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // --- Memoized Data Lists ---
    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const betaNuclides = React.useMemo(() => radionuclides.filter(n => n.emissionEnergies?.beta?.length > 0).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => radionuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, radionuclides]);

    // --- Handle Pre-selection ---
    React.useEffect(() => {
        if (preselectedNuclide) {
            const isGamma = gammaNuclides.some(n => n.symbol === preselectedNuclide);
            const isBeta = betaNuclides.some(n => n.symbol === preselectedNuclide);
            if (isGamma) {
                setNuclideSymbol(preselectedNuclide);
                setCalcMode('gamma');
                setGeometryMode('point');
            } else if (isBeta) {
                setNuclideSymbol(preselectedNuclide);
                setCalcMode('beta');
            }
        }
    }, [preselectedNuclide, gammaNuclides, betaNuclides]);

    // --- Data Constants ---
    const activityFactorsCi = { 'Ci': 1, 'mCi': 1e-3, 'µCi': 1e-6, 'GBq': 1 / 37, 'MBq': 1 / 37000, 'Bq': 1 / 3.7e10 };
    const activityFactors_uCi = { 'Ci': 1e6, 'mCi': 1000, 'µCi': 1, 'GBq': 27027, 'MBq': 27.027, 'Bq': 2.7e-5 };
    const distanceFactorsM = { 'm': 1, 'cm': 0.01, 'ft': 0.3048, 'in': 0.0254 };

    const handleCalculate = () => {
        setResult(null);
        setError('');
        if (!selectedNuclide) { setError('Please select a radionuclide.'); return; }
        const activityValue = parseFloat(activity);
        const distanceValue = parseFloat(distance);
        if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0) {
            setError('Please enter valid, positive numbers for activity and distance.'); return;
        }
        try {
            if (calcMode === 'gamma') {
                if (!selectedNuclide.gammaConstant) { throw new Error('This nuclide is not a significant gamma emitter for this calculation.'); }
                const gammaConstant = parseFloat(selectedNuclide.gammaConstant);
                const activityInCi = activityValue * activityFactorsCi[activityUnit];
                const distanceInM = distanceValue * distanceFactorsM[distanceUnit];
                let doseRateR_hr = 0;
                if (geometryMode === 'point') {
                    doseRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2);
                } else if (geometryMode === 'line') {
                    const length_m = parseFloat(lineLength) * distanceFactorsM[lineLengthUnit];
                    if (isNaN(length_m) || length_m <= 0) { throw new Error("Line length must be a positive number."); }
                    const linearActivity = activityInCi / length_m;
                    doseRateR_hr = ((gammaConstant * linearActivity) / distanceInM) * (Math.atan(length_m / (2 * distanceInM)));
                } else { // area
                    const radius_m = parseFloat(diskRadius) * distanceFactorsM[diskRadiusUnit];
                    if (isNaN(radius_m) || radius_m <= 0) { throw new Error("Disk radius must be a positive number."); }
                    const area_m2 = Math.PI * Math.pow(radius_m, 2);
                    const areaActivity = activityInCi / area_m2;
                    doseRateR_hr = Math.PI * gammaConstant * areaActivity * Math.log((Math.pow(radius_m, 2) + Math.pow(distanceInM, 2)) / Math.pow(distanceInM, 2));
                }
                setResult({ type: 'gamma', mrem_hr: (doseRateR_hr * 1000).toPrecision(3), uSv_hr: (doseRateR_hr * 10000).toPrecision(3) });

            } else if (calcMode === 'beta') {
                // 1. Get Maximum & Average Beta Energy from nuclide data.
                const E_max = parseEnergyToMeV(selectedNuclide.emissionEnergies.beta);
                if (!E_max || E_max === 0) { throw new Error("This nuclide is not a significant beta emitter."); }
    
                // 2. Calculate the maximum range of the beta particle in air. This logic is correct and remains.
                const distanceInCm = distanceValue * distanceFactorsM[distanceUnit] * 100;
                const densityOfAir = 0.001225; // g/cm^3
                const range_g_cm2 = (E_max >= 0.8) ? (0.542 * E_max - 0.133) : (0.407 * Math.pow(E_max, 1.38));
                const maxRange_cm = range_g_cm2 / densityOfAir;
    
                let doseRate_mrem_hr = 0;
    
                // 3. Only calculate a dose if the distance is within the beta's maximum range.
                if (distanceInCm < maxRange_cm) {
                    // 4. Convert user's input activity to microcuries (µCi) using our new constant object.
                    const activityIn_uCi = activityValue * activityFactors_uCi[activityUnit];
        
                    // 5. Use the precise average energy if available, otherwise approximate it.
                    const E_avg = selectedNuclide.avgBetaEnergy ? parseFloat(selectedNuclide.avgBetaEnergy) : E_max / 3.0;
        
                    // 6. Apply the new, energy-dependent formula for dose rate.
                    doseRate_mrem_hr = ((2130 * activityIn_uCi * E_avg) / Math.pow(distanceInCm, 2)) * 1000;
                }
    
                // 7. Update the result state with the calculated values.
                setResult({ type: 'beta', mrem_hr: doseRate_mrem_hr.toPrecision(3), max_range_cm: maxRange_cm.toPrecision(3) });
            } else { // Bremsstrahlung
                const E_max = parseEnergyToMeV(selectedNuclide.emissionEnergies.beta);
                if (!E_max || E_max === 0) { throw new Error("This nuclide is not a significant beta emitter."); }
                const Z = SHIELDING_MATERIALS[shieldMaterial].Z;
                const activityInCi = activityValue * activityFactorsCi[activityUnit];
                const distanceInM = distanceValue * distanceFactorsM[distanceUnit];
                const doseRate_rad_hr_at_1m = 0.57 * activityInCi * Z * Math.pow(E_max, 2);
                const doseRate_rad_hr = doseRate_rad_hr_at_1m / Math.pow(distanceInM, 2);
                const doseRate_mrem_hr = doseRate_rad_hr * 1000;
                const f = 3.5e-4 * Z * E_max;
                setResult({ type: 'bremsstrahlung', doseRate: doseRate_mrem_hr.toPrecision(3), bremsstrahlungFraction: (f * 100).toPrecision(2) });
            }
        } catch (e) {
            setError(e.message);
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Dose Rate Calculator</h2>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => {setCalcMode('gamma'); setResult(null); setError('');}} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'gamma' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Gamma</button>
                    <button onClick={() => {setCalcMode('beta'); setResult(null); setError('');}} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'beta' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Beta</button>
                    <button onClick={() => {setCalcMode('bremsstrahlung'); setResult(null); setError('');}} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'bremsstrahlung' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Bremsstrahlung</button>
                </div>
                <div className="space-y-3">
                    <SearchableSelect
                        options={
                            calcMode === 'gamma' ? gammaNuclides :
                            calcMode === 'beta' ? betaNuclides :
                            betaNuclides
                        }
                        onSelect={(symbol) => { setNuclideSymbol(symbol); setResult(null); setError(''); }}
                        placeholder={`Search for a ${calcMode} emitter...`}
                    />
                    {selectedNuclide && (<div className="p-2 rounded-md bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200 text-center font-bold">{selectedNuclide.name}</div>)}
                    <NuclideContextDisplay nuclide={selectedNuclide} />
                    <div><label className="block text-sm font-medium">Total Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(activityFactorsCi).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                    
                    {calcMode === 'gamma' && (
                        <div className="animate-fade-in space-y-3">
                            <div><label className="block text-sm font-medium">Source Geometry</label><select value={geometryMode} onChange={e => setGeometryMode(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="point">Point</option><option value="line">Line</option><option value="area">Area (Disk)</option></select></div>
                            {geometryMode === 'line' && (<div><label className="block text-sm font-medium">Line Length</label><div className="flex"><input type="number" value={lineLength} onChange={e => setLineLength(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={lineLengthUnit} onChange={e => setLineLengthUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(distanceFactorsM).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}
                            {geometryMode === 'area' && (<div><label className="block text-sm font-medium">Disk Radius</label><div className="flex"><input type="number" value={diskRadius} onChange={e => setDiskRadius(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={diskRadiusUnit} onChange={e => setDiskRadiusUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(distanceFactorsM).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>)}
                        </div>
                    )}
                    {calcMode === 'bremsstrahlung' && (
                        <div className="animate-fade-in"><label className="block text-sm font-medium">Shield Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(SHIELDING_MATERIALS).map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                    )}
                    
                    <div><label className="block text-sm font-medium">Perpendicular Distance to Source</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(distanceFactorsM).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate</button>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {result && result.type === 'gamma' && (
                        <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
                            <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Gamma Dose Rate</p>
                            <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.mrem_hr} mrem/hr</p>
                            <p className="text-md font-medium text-slate-600 dark:text-slate-300">({result.uSv_hr} µSv/hr)</p>
                        </div>
                    )}
                    
                    {result && result.type === 'beta' && (
                        <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
                            <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Beta Dose Rate (Skin)</p>
                            <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.mrem_hr} mrem/hr</p>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-2 border-t border-slate-300 dark:border-slate-600 pt-2">
                                Max Beta Range in Air: <strong>{result.max_range_cm} cm</strong>. Beyond this distance, the dose rate is zero.
                            </p>
                        </div>
                    )}
                    
                    {result && result.type === 'bremsstrahlung' && (
                        <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4">
                            <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Bremsstrahlung Dose Rate</p>
                            <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.doseRate} mrem/hr</p>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">~{result.bremsstrahlungFraction}% of beta energy converted to X-rays.</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

/**
 * @description An advanced calculator to analyze and model parent-daughter equilibrium.
 * It automatically determines the type of equilibrium and calculates key metrics.
 * @param {{radionuclides: Array<object>}} props
 */
const EquilibriumCalculator = ({ radionuclides }) => {
    // --- STATE MANAGEMENT ---
    const [parentNuclide, setParentNuclide] = React.useState(null);
    const [daughterNuclide, setDaughterNuclide] = React.useState(null);
    const [initialActivity, setInitialActivity] = React.useState('100');
    const [initialDaughterActivity, setInitialDaughterActivity] = React.useState('0'); // <-- New State
    const [timeElapsed, setTimeElapsed] = React.useState('10');
    const [timeUnit, setTimeUnit] = React.useState('days');
    const [result, setResult] = React.useState(null);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');
    const [analysis, setAnalysis] = React.useState(null);
    const [useLogScale, setUseLogScale] = React.useState(false);

    const timeUnits = ['seconds', 'minutes', 'hours', 'days', 'years'];
    
    // (This parentNuclides list logic is unchanged)
    const parentNuclides = React.useMemo(() => {
        return radionuclides.filter(parent => {
            if (!parent.daughter || parent.halfLife === 'Stable' || parent.daughter.includes('/')) return false;
            const daughterName = parent.daughter.split('(')[0].trim();
            const daughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
            return daughter && daughter.halfLife !== 'Stable';
        }).sort((a, b) => a.name.localeCompare(b.name));
    }, [radionuclides]);
    
    // (This analysis useEffect is unchanged)
    React.useEffect(() => {
        if (!parentNuclide) {
            setAnalysis(null);
            setDaughterNuclide(null);
            return;
        }
        const daughterName = parentNuclide.daughter.split('(')[0].trim();
        const foundDaughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
      





        if (!foundDaughter) {
            if (parentNuclide.daughter.toLowerCase().includes('stable')) {
                // Create a temporary "dummy" daughter object so the rest of the logic works
                setDaughterNuclide({ name: daughterName, halfLife: 'Stable' });
                setAnalysis({ type: 'Stable Daughter', message: 'The daughter nuclide is stable; no radioactive equilibrium is established.' });
            } else {
                // This is a real error for a missing radioactive daughter
                setAnalysis({ type: 'Analysis Error', message: 'Daughter nuclide data not found.' });
                setDaughterNuclide(null);
            }
            return; // Exit the hook
        }
        
	setDaughterNuclide(foundDaughter);
        if (foundDaughter.halfLife === 'Stable') {
            setAnalysis({ type: 'Stable Daughter', message: 'The daughter nuclide is stable; no radioactive equilibrium is established.' });
            return;
        }
        const T1_seconds = parseHalfLifeToSeconds(parentNuclide.halfLife);
        const T2_seconds = parseHalfLifeToSeconds(foundDaughter.halfLife);
        let type, message, ratio = null, timeToEq = null, timeToMax = null;
        if (T1_seconds < T2_seconds) {
            type = 'No Equilibrium';
            message = `The parent half-life (${parentNuclide.halfLife}) is shorter than the daughter half-life (${foundDaughter.halfLife}). The daughter will never reach equilibrium.`;
        } else if (T1_seconds > 100 * T2_seconds) {
            type = 'Secular Equilibrium';
            ratio = 1;
            timeToEq = (7 * T2_seconds);
            message = `The parent half-life is much longer than the daughter's. The daughter activity will rise to become equal to the parent's activity.`;
        } else {
            type = 'Transient Equilibrium';
            const lambda1 = Math.log(2) / T1_seconds;
            const lambda2 = Math.log(2) / T2_seconds;
            ratio = lambda2 / (lambda2 - lambda1);
            timeToEq = (7 * T2_seconds);
            timeToMax = Math.log(lambda2 / lambda1) / (lambda2 - lambda1);
            message = `The parent decays at a rate comparable to the daughter. The daughter's activity will rise, exceed the parent's, and then decay with the parent's apparent half-life.`;
        }
        setAnalysis({ type, message, ratio, timeToEq, timeToMax });
        const bestUnit = getBestHalfLifeUnit(timeToEq);
        setTimeUnit(bestUnit);
        if (bestUnit === 'years') setTimeElapsed(Math.ceil(timeToEq / 31557600).toString());
        else if (bestUnit === 'days') setTimeElapsed(Math.ceil(timeToEq / 86400).toString());
        else if (bestUnit === 'hours') setTimeElapsed(Math.ceil(timeToEq / 3600).toString());
        else if (bestUnit === 'minutes') setTimeElapsed(Math.ceil(timeToEq / 60).toString());
        else setTimeElapsed(Math.ceil(timeToEq).toString());
    }, [parentNuclide, radionuclides]);


    const handleCalculate = () => {
        if (!parentNuclide || !daughterNuclide) {
            setError('Please select a valid parent nuclide.'); return;
        }
        
        const N0_parent = parseFloat(initialActivity);
        const N0_daughter = parseFloat(initialDaughterActivity); // <-- Get initial daughter activity
        const t_input = parseFloat(timeElapsed);
        
        if (isNaN(N0_parent) || N0_parent < 0 || isNaN(t_input) || t_input < 0 || isNaN(N0_daughter) || N0_daughter < 0) {
            setError('All activity and time inputs must be non-negative numbers.'); return;
        }
        setError('');

        const T1_seconds = parseHalfLifeToSeconds(parentNuclide.halfLife);
        const T2_seconds = parseHalfLifeToSeconds(daughterNuclide.halfLife);
        const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
        const t_seconds = t_input * unitConversions[timeUnit];
        const lambda1 = Math.log(2) / T1_seconds;
        const lambda2 = Math.log(2) / T2_seconds;

        const A_parent = N0_parent * Math.exp(-lambda1 * t_seconds);

        // --- UPDATED BATEMAN EQUATION ---
        // A₂(t) = A₂(0)e^(-λ₂t) + [A₁(0) * λ₂/(λ₂-λ₁)] * (e^(-λ₁t) - e^(-λ₂t))
        const initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * t_seconds);
        let daughterIngrowth;
        if (Math.abs(lambda1 - lambda2) < 1e-12) {
             daughterIngrowth = N0_parent * lambda1 * t_seconds * Math.exp(-lambda1 * t_seconds);
        } else {
             daughterIngrowth = (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * t_seconds) - Math.exp(-lambda2 * t_seconds));
        }
        const A_daughter = initialDaughterDecay + daughterIngrowth;

        setResult({
            parent: { name: parentNuclide.name, activity: A_parent.toPrecision(4) },
            daughter: { name: daughterNuclide.name, activity: A_daughter.toPrecision(4) }
        });

        // --- UPDATE CHART GENERATION ---
        const labels = [], parentData = [], daughterData = [], ratioData = [];
        const totalTime = t_input;
        const steps = 100;
        for (let i = 0; i <= steps; i++) {
            const timePoint = (totalTime / steps) * i;
            const timePoint_seconds = timePoint * unitConversions[timeUnit];
            labels.push(timePoint.toFixed(2));
            const current_A_parent = N0_parent * Math.exp(-lambda1 * timePoint_seconds);
            parentData.push(current_A_parent);
            
            const current_initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * timePoint_seconds);
            let current_daughterIngrowth;
            if (Math.abs(lambda1 - lambda2) < 1e-12) {
                current_daughterIngrowth = N0_parent * lambda1 * timePoint_seconds * Math.exp(-lambda1 * timePoint_seconds);
            } else {
                current_daughterIngrowth = (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * timePoint_seconds) - Math.exp(-lambda2 * timePoint_seconds));
            }
            const d_activity = current_initialDaughterDecay + current_daughterIngrowth;
            daughterData.push(d_activity);
            ratioData.push(current_A_parent > 1e-9 ? d_activity / current_A_parent : 0);
        }
        setChartData({ labels, parentData, daughterData, ratioData, parentName: parentNuclide.name, daughterName: daughterNuclide.name, timeUnit });
    };

    const handleParentChange = (symbol) => {
        const parent = parentNuclides.find(p => p.symbol === symbol);
        setResult(null);
        setChartData(null);
        setError('');
        setParentNuclide(parent || null);
    };

    return (
        <div className="p-4 animate-fade-in">
            {/* ... JSX structure ... */}
            <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Parent-Daughter Equilibrium Analyzer</h2>
                <div className="space-y-4">
                    {/* Parent Selector (Unchanged) */}
                    <div>
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Parent Nuclide</label>
                        <div className="mt-1 min-h-[42px]">
                            {parentNuclide ? (
                            <>
                                <div className="flex items-center justify-between p-2 rounded-md bg-sky-100 dark:bg-sky-900/50">
                                    <span className="font-bold">{parentNuclide.name}</span>
                                    <button onClick={() => handleParentChange(null)} className="ml-2 p-1 rounded-full" title="Change nuclide">
                                        <Icon path={ICONS.clear} className="w-4 h-4" />
                                    </button>
                                </div>
                                <NuclideContextDisplay nuclide={parentNuclide} />
                            </>
                        ) : (
                                <SearchableSelect options={parentNuclides} onSelect={handleParentChange} placeholder="Search for a parent nuclide..."/>
                            )}
                        </div>
                    </div>

                    {/* Analysis Display (Unchanged from previous step, but now including tooltips we'll add next) */}
                    {analysis && (
                        <div className="p-4 bg-slate-100 dark:bg-slate-700/80 rounded-lg animate-fade-in border border-slate-200 dark:border-slate-600">
                             <h3 className="text-lg font-bold text-sky-600 dark:text-sky-400 mb-2">{analysis.type}</h3>
                            <p className="text-sm text-slate-600 dark:text-slate-300 mb-3">{analysis.message}</p>
                            {analysis.ratio && (
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm border-t border-slate-300 dark:border-slate-600 pt-3">
                                    <div><p className="font-semibold">Equilibrium Ratio (A₂/A₁):</p><p>{analysis.ratio.toFixed(4)}</p></div>
                                    <div><p className="font-semibold">Time to ~Equilibrium:</p><p>≈ {formatHalfLife(analysis.timeToEq.toString() + ' seconds', getBestHalfLifeUnit(analysis.timeToEq))}</p></div>
                                    {analysis.timeToMax && (
                                        <div className="col-span-1 sm:col-span-2"><p className="font-semibold">Time to Max Daughter Activity:</p><p>{formatHalfLife(analysis.timeToMax.toString() + ' seconds', getBestHalfLifeUnit(analysis.timeToMax))}</p></div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* --- UPDATED Calculation Inputs --- */}
                    {parentNuclide && (
                        <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium">Initial Parent Activity</label>
                                    <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full p-2 mt-1 rounded-md bg-slate-100 dark:bg-slate-700" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium">Initial Daughter Activity</label>
                                    <input type="number" value={initialDaughterActivity} onChange={e => setInitialDaughterActivity(e.target.value)} className="w-full p-2 mt-1 rounded-md bg-slate-100 dark:bg-slate-700" />
                                </div>
                            </div>
                             <div>
                                <label className="block text-sm font-medium">Time Elapsed</label>
                                <div className="flex gap-2 mt-1">
                                    <input type="number" value={timeElapsed} onChange={e => setTimeElapsed(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                                    <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                        {timeUnits.map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>
                    )}

                    {parentNuclide && <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate & Update Chart</button>}
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}

                    {result && (
                        <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg space-y-2">
                            <p className="font-semibold text-center text-sm">Activity at {timeElapsed} {timeUnit}</p>
                            <div className="flex justify-between items-center"><p>{result.parent.name}:</p> <p className="font-bold">{result.parent.activity}</p></div>
                            <div className="flex justify-between items-center"><p>{result.daughter.name}:</p> <p className="font-bold">{result.daughter.activity}</p></div>
                        </div>
                    )}
                    
                    {chartData && (
                        <>
                            <div className="flex justify-end mt-4">
                                <label className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" />
                                    Use Logarithmic Scale
                                </label>
                            </div>
                            <DecayChart chartData={chartData} useLogScale={useLogScale} />
                        </>
                    )}
                </div>
            </div>
        </div>
    );
};


/**
 * @description A calculator for photon shielding with three modes:
 * 1. (From Source) Calculates final dose rate from a specific radionuclide.
 * 2. (Find Thickness) Calculates required shielding thickness for a specific radionuclide.
 * 3. (Generic Rate) Calculates final OR initial dose rate from a user-inputted HVL.
 */

const ShieldingCalculator = ({ radionuclides, preselectedNuclide }) => {

    // --- State to toggle between the three calculator modes ---
    const { settings } = React.useContext(SettingsContext); // <-- Get global settings

    const [calcMode, setCalcMode] = React.useState('fromSource');
    const [genericMode, setGenericMode] = React.useState('findFinal');

    const [nuclideSymbol, setNuclideSymbol] = React.useState('');
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState(settings.activity); // <-- Use global setting
    const [distance, setDistance] = React.useState('1');
    const [distanceUnit, setDistanceUnit] = React.useState(settings.distance); // <-- Use global setting
    
    const [knownDoseRate, setKnownDoseRate] = React.useState('100');
    const [knownDoseRateUnit, setKnownDoseRateUnit] = React.useState(settings.doseRate); // <-- Use global setting
    const [manualHVL, setManualHVL] = React.useState('0.27');

    const [shieldMaterial, setShieldMaterial] = React.useState('Lead');
    const [shieldThickness, setShieldThickness] = React.useState('1');
    const [thicknessUnit, setThicknessUnit] = React.useState('cm');
    const [targetDoseRate, setTargetDoseRate] = React.useState('2');
    const [targetDoseRateUnit, setTargetDoseRateUnit] = React.useState(settings.doseRate); // <-- Use global setting
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    const shieldingNuclides = React.useMemo(() =>
        radionuclides.filter(n => n.gammaConstant && HVL_DATA[n.symbol]).sort((a,b) => a.name.localeCompare(b.name)),
        [radionuclides]
    );

    React.useEffect(() => {
        if (preselectedNuclide) {
            if (shieldingNuclides.find(n => n.symbol === preselectedNuclide)) {
                setNuclideSymbol(preselectedNuclide);
                setCalcMode('fromSource');
            }
        }
    }, [preselectedNuclide, shieldingNuclides]);

    const materials = ['Lead', 'Concrete', 'Steel', 'Other'];
    const activityFactors = { 'Ci': 1, 'mCi': 1e-3, 'µCi': 1e-6, 'GBq': 1 / 37, 'MBq': 1 / 37000, 'Bq': 1 / 3.7e10 };
    const distanceFactors = { 'm': 1, 'cm': 0.01, 'ft': 0.3048 };
    const thicknessFactors = { 'cm': 1, 'mm': 0.1, 'in': 2.54 };
    const doseRateFactors = { 'mrem/hr': 1, 'mR/hr': 1, 'µSv/hr': 0.1, 'R/hr': 1000 };

    const handleCalculate = () => {
        setResult(null);
        setError('');

        if (calcMode === 'genericRate') {
            const knownRateVal = parseFloat(knownDoseRate);
            const thicknessVal = parseFloat(shieldThickness);
            const hvlVal = parseFloat(manualHVL);

            if (isNaN(knownRateVal) || isNaN(thicknessVal) || isNaN(hvlVal) || knownRateVal < 0 || thicknessVal < 0 || hvlVal <= 0) {
                setError('Please enter valid, positive numbers for all fields.'); return;
            }
            const knownRate_mrem_hr = knownRateVal * doseRateFactors[knownDoseRateUnit];
            const thickness_cm = thicknessVal * thicknessFactors[thicknessUnit];

            if (genericMode === 'findFinal') {
                const finalRate_mrem_hr = knownRate_mrem_hr * Math.pow(0.5, thickness_cm / hvlVal);
                setResult({
                    type: 'genericRateFinal',
                    initial: knownRate_mrem_hr.toPrecision(3),
                    final: finalRate_mrem_hr.toPrecision(3)
                });
            } else { // findInitial
                const initialRate_mrem_hr = knownRate_mrem_hr / Math.pow(0.5, thickness_cm / hvlVal);
                setResult({
                    type: 'genericRateInitial',
                    initial: initialRate_mrem_hr.toPrecision(3),
                    final: knownRate_mrem_hr.toPrecision(3)
                });
            }
        } else {
            const nuclide = shieldingNuclides.find(n => n.symbol === nuclideSymbol);
            if (!nuclide) { setError('Please select a radionuclide.'); return; }
            
            const activityValue = parseFloat(activity);
            const distanceValue = parseFloat(distance);
            if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0) {
                setError('Please enter valid, positive numbers for activity and distance.'); return;
            }
            
            const gammaConstant = parseFloat(nuclide.gammaConstant);
            const activityInCi = activityValue * activityFactors[activityUnit];
            const distanceInM = distanceValue * distanceFactors[distanceUnit];
            const hvl_cm = HVL_DATA[nuclide.symbol][shieldMaterial];
            const unshieldedRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2);

            if (calcMode === 'fromSource') {
                const thicknessValue = parseFloat(shieldThickness);
                if (isNaN(thicknessValue) || thicknessValue < 0) { setError('Please enter a valid, non-negative thickness.'); return; }
                const thicknessInCm = thicknessValue * thicknessFactors[thicknessUnit];
                const shieldedRateR_hr = unshieldedRateR_hr * Math.pow(0.5, thicknessInCm / hvl_cm);
                setResult({ type: 'doseRate', unshielded: (unshieldedRateR_hr * 1000).toPrecision(3), shielded: (shieldedRateR_hr * 1000).toPrecision(3) });
            } else { // findThickness
                const targetRateValue = parseFloat(targetDoseRate);
                if (isNaN(targetRateValue) || targetRateValue <= 0) { setError('Please enter a valid, positive target dose rate.'); return; }
                const targetRateR_hr = (targetRateValue * doseRateFactors[targetDoseRateUnit]) / 1000;
                if (targetRateR_hr >= unshieldedRateR_hr) { setError('Target dose rate is higher than the unshielded dose rate. No shielding is required.'); return; }
                const requiredThickness_cm = hvl_cm * Math.log2(unshieldedRateR_hr / targetRateR_hr);
                setResult({ type: 'thickness', unshielded: (unshieldedRateR_hr * 1000).toPrecision(3), cm: requiredThickness_cm.toPrecision(3), mm: (requiredThickness_cm * 10).toPrecision(3), in: (requiredThickness_cm / 2.54).toPrecision(3) });
            }
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Shielding Calculator</h2>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setCalcMode('fromSource')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'fromSource' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>From Source</button>
                    <button onClick={() => setCalcMode('findThickness')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findThickness' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find Thickness</button>
                    <button onClick={() => setCalcMode('genericRate')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'genericRate' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Generic Rate</button>
                </div>

                <div className="space-y-4">
                    {calcMode === 'genericRate' ? (
                        <div className="animate-fade-in space-y-4">
                            <div className="flex justify-center gap-4 text-sm">
                                <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="genericMode" value="findFinal" checked={genericMode === 'findFinal'} onChange={e => setGenericMode(e.target.value)} className="form-radio h-4 w-4 text-sky-600"/>Calculate Final Dose</label>
                                <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="genericMode" value="findInitial" checked={genericMode === 'findInitial'} onChange={e => setGenericMode(e.target.value)} className="form-radio h-4 w-4 text-sky-600"/>Calculate Initial Dose</label>
                            </div>
                             <div><label className="block text-sm font-medium">{genericMode === 'findFinal' ? 'Initial Dose Rate' : 'Final (Shielded) Dose Rate'}</label><div className="flex"><input type="number" value={knownDoseRate} onChange={e => setKnownDoseRate(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={knownDoseRateUnit} onChange={e => setKnownDoseRateUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(doseRateFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                             <div><label className="block text-sm font-medium">Shield Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{materials.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                             <div><label className="block text-sm font-medium">Half-Value Layer (HVL)</label><Tooltip text="Enter the HVL in cm for your specific material and radiation energy."><div className="relative mt-1"><input type="number" value={manualHVL} onChange={e => setManualHVL(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700"/><div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-500">cm</div></div></Tooltip></div>
                             <div><label className="block text-sm font-medium">Shield Thickness</label><div className="flex"><input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(thicknessFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                        </div>
                    ) : (
                        <div className="animate-fade-in space-y-4">
                             <div className="grid grid-cols-1 gap-4">
                                <div>
                                    <label className="block text-sm font-medium">Radionuclide</label>
                                    <select value={nuclideSymbol} onChange={e => setNuclideSymbol(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="">Select source...</option>{shieldingNuclides.map(n => <option key={n.symbol} value={n.symbol}>{n.name}</option>)}</select>
                                    <NuclideContextDisplay nuclide={shieldingNuclides.find(n => n.symbol === nuclideSymbol)} />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(activityFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                                <div><label className="block text-sm font-medium">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(distanceFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                                <div><label className="block text-sm font-medium">Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{materials.filter(m => m !== 'Other').map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                            </div>
                            {calcMode === 'fromSource' ? (
                                <div><label className="block text-sm font-medium">Shield Thickness</label><div className="flex"><input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(thicknessFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                            ) : (
                                <div><label className="block text-sm font-medium">Target Dose Rate</label><div className="flex"><input type="number" value={targetDoseRate} onChange={e => setTargetDoseRate(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={targetDoseRateUnit} onChange={e => setTargetDoseRateUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(doseRateFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                            )}
                        </div>
                    )}
                    
                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate</button>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {result && (
                        <div className="text-center p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-2">
                           { (result.type === 'doseRate' || result.type === 'genericRateFinal') && <>
                                <div><p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Unshielded / Initial</p><p className="text-xl font-bold text-slate-600 dark:text-slate-300">{result.unshielded || result.initial} mrem/hr</p></div>
                                <div className="font-bold text-2xl">↓</div>
                                <div><p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Shielded / Final</p><p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.shielded || result.final} mrem/hr</p></div>
                           </>}
                           { result.type === 'thickness' && <>
                                <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">To reduce from {result.unshielded} mrem/hr to {targetDoseRate} {targetDoseRateUnit}, you need:</p>
                                <p className="text-2xl font-bold text-sky-600 dark:text-sky-400 mt-2">{result.cm} cm</p>
                                <p className="text-md font-medium text-slate-600 dark:text-slate-300">({result.mm} mm / {result.in} in) of {shieldMaterial}</p>
                           </>}
                           { result.type === 'genericRateInitial' && <>
                                <div><p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Initial Dose Rate</p><p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.initial} {knownDoseRateUnit}</p></div>
                                <div className="font-bold text-2xl">↓</div>
                                <div><p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Known Final Dose Rate</p><p className="text-xl font-bold text-slate-600 dark:text-slate-300">{result.final} {knownDoseRateUnit}</p></div>
                           </>}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

/**
 * @description A calculator for determining allowable stay time and total dose received.
 * The dose rate can be calculated from a specific source or entered manually.
 */

const StayTimeCalculator = ({ radionuclides, preselectedNuclide }) => {

    // --- NEW: State to toggle between input modes ---
    
    const { settings } = React.useContext(SettingsContext); // <-- Get global settings

    const [inputMode, setInputMode] = React.useState('fromSource');

    const [nuclideSymbol, setNuclideSymbol] = React.useState('');
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState(settings.activity); // <-- Use global setting
    const [distance, setDistance] = React.useState('1');
    const [distanceUnit, setDistanceUnit] = React.useState(settings.distance); // <-- Use global setting

    const [manualDoseRate, setManualDoseRate] = React.useState('10');
    const [manualDoseRateUnit, setManualDoseRateUnit] = React.useState(settings.doseRate); // <-- Use global setting
    
    // --- State for Planning ---
    const [doseLimit, setDoseLimit] = React.useState('2');
    const [plannedTime, setPlannedTime] = React.useState('10');
    const [plannedTimeUnit, setPlannedTimeUnit] = React.useState('minutes');

    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    const gammaNuclides = React.useMemo(() =>
        radionuclides.filter(n => n.gammaConstant).sort((a,b) => a.name.localeCompare(b.name)),
        [radionuclides]
    );

    React.useEffect(() => {
        if (preselectedNuclide) {
            if (gammaNuclides.find(n => n.symbol === preselectedNuclide)) {
                setNuclideSymbol(preselectedNuclide);
                setInputMode('fromSource'); // Switch to the correct mode
            }
        }
    }, [preselectedNuclide, gammaNuclides]);

    const activityFactors = { 'Ci': 1, 'mCi': 1e-3, 'µCi': 1e-6, 'GBq': 1 / 37, 'MBq': 1 / 37000, 'Bq': 1 / 3.7e10 };
    const distanceFactors = { 'm': 1, 'cm': 0.01, 'ft': 0.3048 };
    const timeFactors = { 'minutes': 1 / 60, 'hours': 1, 'days': 24 };
    const doseRateFactors = { 'mrem/hr': 1, 'mR/hr': 1, 'µSv/hr': 0.1, 'R/hr': 1000 };

    const handleCalculate = () => {
        setResult(null);
        setError('');

        let doseRate_mrem_hr = 0;

        // --- STEP 1: Determine the dose rate from the selected input mode ---
        if (inputMode === 'fromSource') {
            const nuclide = gammaNuclides.find(n => n.symbol === nuclideSymbol);
            if (!nuclide) { setError('Please select a radionuclide.'); return; }
            
            const activityValue = parseFloat(activity);
            const distanceValue = parseFloat(distance);
            if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0) {
                setError('Please enter valid, positive numbers for activity and distance.'); return;
            }

            const gammaConstant = parseFloat(nuclide.gammaConstant);
            const activityInCi = activityValue * activityFactors[activityUnit];
            const distanceInM = distanceValue * distanceFactors[distanceUnit];
            const doseRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2);
            doseRate_mrem_hr = doseRateR_hr * 1000;
        } else { // manualRate
            const manualRate = parseFloat(manualDoseRate);
            if (isNaN(manualRate) || manualRate < 0) {
                setError('Please enter a valid, non-negative dose rate.'); return;
            }
            doseRate_mrem_hr = manualRate * doseRateFactors[manualDoseRateUnit];
        }

        // --- STEP 2: Perform the planning calculations (this logic is now common to both modes) ---
        const limit = parseFloat(doseLimit);
        const plannedTimeValue = parseFloat(plannedTime);

        if (isNaN(limit) || isNaN(plannedTimeValue) || limit <= 0 || plannedTimeValue < 0) {
            setError('Please enter valid, positive numbers for dose limit and planned time.'); return;
        }

        if (doseRate_mrem_hr <= 0) {
            setError('Dose rate must be greater than zero to calculate stay time.'); return;
        }

        // Calculation 1: Max Stay Time
        const stayTimeHours = limit / doseRate_mrem_hr;
        const totalMinutes = stayTimeHours * 60;
        const minutes = Math.floor(totalMinutes);
        const seconds = Math.round((totalMinutes - minutes) * 60);

        // Calculation 2: Total Dose Received
        const plannedTimeInHours = plannedTimeValue * timeFactors[plannedTimeUnit];
        const totalDoseReceived = doseRate_mrem_hr * plannedTimeInHours;
        const isSafe = totalDoseReceived <= limit;

        setResult({
            doseRate: doseRate_mrem_hr.toPrecision(3),
            stayTime: `${minutes} min ${seconds} sec`,
            totalDoseReceived: totalDoseReceived.toPrecision(3),
            isSafe: isSafe
        });
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Stay Time & Dose Calculator</h2>
                
                {/* --- NEW: Input Mode Switcher --- */}
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setInputMode('fromSource')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === 'fromSource' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Calculate from Source</button>
                    <button onClick={() => setInputMode('manualRate')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${inputMode === 'manualRate' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Enter Dose Rate</button>
                </div>

                <div className="space-y-4">
                    {inputMode === 'fromSource' ? (
                        <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
                            <label className="block text-sm font-semibold">Source Information</label>
                            <select value={nuclideSymbol} onChange={e => setNuclideSymbol(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                <option value="">Select source...</option>
                                {gammaNuclides.map(n => <option key={n.symbol} value={n.symbol}>{n.name}</option>)}
                            </select>
                            <NuclideContextDisplay nuclide={gammaNuclides.find(n => n.symbol === nuclideSymbol)} />
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-medium">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{Object.keys(activityFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                                <div><label className="block text-xs font-medium">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{Object.keys(distanceFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                            </div>
                        </div>
                    ) : (
                        <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
                            <label className="block text-sm font-semibold">Known Dose Rate</label>
                            <div className="flex"><input type="number" value={manualDoseRate} onChange={e => setManualDoseRate(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={manualDoseRateUnit} onChange={e => setManualDoseRateUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(doseRateFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                        </div>
                    )}
                    
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                        <label className="block text-sm font-semibold">Planning</label>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-xs font-medium">Dose Limit (mrem)</label><input type="number" value={doseLimit} onChange={e => setDoseLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-xs font-medium">Planned Time</label><div className="flex"><input type="number" value={plannedTime} onChange={e => setPlannedTime(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={plannedTimeUnit} onChange={e => setPlannedTimeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{Object.keys(timeFactors).map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                        </div>
                    </div>

                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate</button>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {result && (
                        <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-4">
                            <div className="text-center">
                                <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Dose Rate in Area: <span className="font-bold text-slate-700 dark:text-slate-200">{result.doseRate} mrem/hr</span></p>
                            </div>
                            <div className="grid grid-cols-2 gap-4 text-center">
                                <div className="p-2 bg-white dark:bg-slate-800 rounded-lg">
                                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Max Stay Time</p>
                                    <p className="text-xl font-bold text-sky-600 dark:text-sky-400">{result.stayTime}</p>
                                    <p className="text-xs text-slate-400">(to reach {doseLimit} mrem)</p>
                                </div>
                                <div className={`p-2 rounded-lg ${result.isSafe ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                                    <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Total Dose Received</p>
                                    <p className={`text-xl font-bold ${result.isSafe ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.totalDoseReceived} mrem</p>
                                    <p className="text-xs text-slate-400">(in {plannedTime} {plannedTimeUnit})</p>
                                </div>
                            </div>
                             {!result.isSafe && <p className="text-center font-bold text-red-500 text-sm">WARNING: Exceeds dose limit!</p>}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

/**
 * @description A unified calculator for determining detection limits for both
 * MARSSIM-compliant static counts and scanning surveys.
 */

    const MDACalculator = () => {
    
        // --- State to toggle between the two calculator modes ---
    
        const [mdaMode, setMdaMode] = React.useState('static'); // 'static' or 'scan'

    
        // --- REVISED: State for detailed Static MDA ---
    
        const [backgroundCounts, setBackgroundCounts] = React.useState('1000');
    
        const [backgroundTime, setBackgroundTime] = React.useState('10');
    
        const [grossCounts, setGrossCounts] = React.useState('1100'); // Included for future use, not needed for MDA calc itself
    
        const [grossTime, setGrossTime] = React.useState('1');
    
        const [confidence, setConfidence] = React.useState('1.645'); // Corresponds to 95%
    
        const [probeArea, setProbeArea] = React.useState('126');
    
        const [instrumentEff, setInstrumentEff] = React.useState('22');
    
        const [surfaceEff, setSurfaceEff] = React.useState('50');

    // --- State for Scan MDC ---
    
    const [scanBackground, setScanBackground] = React.useState('300');
    const [scanSpeed, setScanSpeed] = React.useState('12.6');
    const [hotspotDiameter, setHotspotDiameter] = React.useState('15');
    const [dprime, setDprime] = React.useState('1.38');
    const [surveyorEff, setSurveyorEff] = React.useState('0.5');

    // --- Unified State for Results and Errors ---
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // --- Data for Selectable Options ---
    const confidenceOptions = [
        { value: '1.282', label: '90%' },
        { value: '1.645', label: '95%' },
        { value: '2.326', label: '99%' }
    ];
    const dprimeOptions = [
        { value: '1.04', label: '1.04 (85% detection prob.)' },
        { value: '1.28', label: '1.28 (90% detection prob.)' },
        { value: '1.38', label: '1.38 (95% detection prob.)' }
    ];
    const surveyorEffOptions = [
        { value: '0.5', label: '0.5 (Realistic default)' },
        { value: '0.75', label: '0.75 (Highly trained/attentive)' }
    ];

 // --- REVISED: Calculation Logic for detailed Static MDA ---
    const handleStaticCalculate = () => {
        const params = {
            Cb: parseFloat(backgroundCounts), tb: parseFloat(backgroundTime),
            Cg: parseFloat(grossCounts), tg: parseFloat(grossTime),
            k: parseFloat(confidence), A: parseFloat(probeArea),
            ei: parseFloat(instrumentEff), es: parseFloat(surfaceEff)
        };

        if (Object.values(params).some(isNaN) || params.tb <= 0 || params.tg <= 0 || params.A <= 0 || params.ei <= 0 || params.es <= 0 ) {
            setError('Please enter valid, positive numbers for all fields.');
            setResult(null); return;
        }
        setError('');

        const rb = params.Cb / params.tb; // Background RATE in cpm or cps
        
        // --- CORRECTED EFFICIENCY HANDLING ---
        // Efficiencies are now handled as decimals throughout, as required by the formula.
        const ei_dec = params.ei / 100.0;
        const es_dec = params.es / 100.0;
        const E_total = ei_dec * es_dec;

        const sigma = Math.sqrt(rb * params.tg * (1 + params.tg / params.tb));
        const Lc = params.k * sigma;
        const LLD = 2 * Lc + 3;
        
        // --- CORRECTED FORMULAS ---
        // Now implementing your formula exactly: Rate * (100/Area) / Efficiencies
        const net_rate_cpm = LLD / params.tg;
        const MDA = net_rate_cpm * (100 / params.A) / E_total;
        const backgroundActivity = rb * (100 / params.A) / E_total;
        
        setResult({
            type: 'static',
            Lc: Lc.toPrecision(3),
            LLD: LLD.toPrecision(3),
            MDA: MDA.toPrecision(3),
            backgroundActivity: backgroundActivity.toPrecision(3)
        });
    };
    
    // --- Calculation Logic for Scan MDC (Unchanged) ---
    const handleScanCalculate = () => {
        const params = {
            b_cpm: parseFloat(scanBackground), area_cm2: parseFloat(probeArea),
            eff_i: parseFloat(instrumentEff), eff_s: parseFloat(surfaceEff),
            hs_diam_cm: parseFloat(hotspotDiameter), speed_cms: parseFloat(scanSpeed),
            dp: parseFloat(dprime), p: parseFloat(surveyorEff)
        };
        if (Object.values(params).some(isNaN) || params.b_cpm < 0 || params.area_cm2 <= 0 || params.eff_i <= 0 || params.eff_s <= 0 || params.speed_cms <= 0) {
            setError('Please enter valid, positive numbers for all required fields.');
            setResult(null); return;
        }
        setError('');
        const b_cps = params.b_cpm / 60.0;
        const E_total = (params.eff_i / 100.0) * (params.eff_s / 100.0);
        const detector_width_cm = Math.sqrt(params.area_cm2);
        const t_i = detector_width_cm / params.speed_cms;
        const B_i = b_cps * t_i;
        const mdcr_surveyor_cpm = params.dp * Math.sqrt(B_i) * (60 / t_i);
        const scan_mda = mdcr_surveyor_cpm / (Math.sqrt(params.p) * E_total * (params.area_cm2 / 100.0));
        const background_activity = params.b_cpm / (E_total * (params.area_cm2 / 100.0));
        
        setResult({
            type: 'scan', obs_interval: t_i.toPrecision(3), bg_counts_in_interval: B_i.toPrecision(3),
            mdcr: mdcr_surveyor_cpm.toPrecision(3), scan_mda: scan_mda.toPrecision(3),
            background_activity: background_activity.toPrecision(3)
        });
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Detection Limit Calculator</h2>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => { setMdaMode('static'); setResult(null); setError(''); }} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${mdaMode === 'static' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Static Count MDA</button>
                    <button onClick={() => { setMdaMode('scan'); setResult(null); setError(''); }} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${mdaMode === 'scan' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Scan Survey MDC</button>
                </div>

                {mdaMode === 'static' ? (
                    // --- REVISED: Static MDA Form ---
                    <div className="space-y-4 animate-fade-in">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium">Background Counts</label><input type="number" value={backgroundCounts} onChange={e => setBackgroundCounts(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Bkg. Count Time (min)</label><input type="number" value={backgroundTime} onChange={e => setBackgroundTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Gross Counts</label><input type="number" value={grossCounts} onChange={e => setGrossCounts(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Gross Count Time (min)</label><input type="number" value={grossTime} onChange={e => setGrossTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div>
                                <label className="block text-sm font-medium">Confidence Interval</label>
                                <div className="flex items-center gap-2">
                                    <select value={confidence} onChange={e => setConfidence(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{confidenceOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select>
                                    <input type="text" value={confidence} readOnly className="w-24 mt-1 p-2 rounded-md bg-slate-200 dark:bg-slate-800 text-center font-mono" title="k-value / z-score"/>
                                </div>
                            </div>
                            <div><label className="block text-sm font-medium">Probe Area (cm²)</label><input type="number" value={probeArea} onChange={e => setProbeArea(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Surface Efficiency (%)</label><input type="number" value={surfaceEff} onChange={e => setSurfaceEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                        </div>
                        <button onClick={handleStaticCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate Static MDA</button>
                    </div>
                ) : (
                    // --- Scan MDC Form ---
                    <div className="space-y-4 animate-fade-in">
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium">Background Rate (cpm)</label><input type="number" value={scanBackground} onChange={e => setScanBackground(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Probe Area (cm²)</label><input type="number" value={probeArea} onChange={e => setProbeArea(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Surface Efficiency (%)</label><input type="number" value={surfaceEff} onChange={e => setSurfaceEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Hot Spot Diameter (cm)</label><input type="number" value={hotspotDiameter} onChange={e => setHotspotDiameter(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div><label className="block text-sm font-medium">Scan Speed (cm/s)</label><input type="number" value={scanSpeed} onChange={e => setScanSpeed(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                        </div>
                        <details className="p-2 rounded-lg bg-slate-50 dark:bg-slate-900/50"><summary className="cursor-pointer text-sm font-semibold">Advanced Factors</summary><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700"><div><label className="block text-sm font-medium">Detectability Index (d')</label><Tooltip text="Guidance from MARSSIM 6.7.2.1. Relates the desired probability of detecting a hot spot."><select value={dprime} onChange={e => setDprime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{dprimeOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></Tooltip></div><div><label className="block text-sm font-medium">Surveyor Efficiency (p)</label><Tooltip text="Guidance from NUREG-1507, Sec. 6.6. Accounts for the human factor of the surveyor noticing an audible signal."><select value={surveyorEff} onChange={e => setSurveyorEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{surveyorEffOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></Tooltip></div></div></details>
                        <button onClick={handleScanCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate Scan MDC</button>
                    </div>
                )}
                
                {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
                
                {/* --- Unified Results Display --- */}
                {result && (
                    <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 animate-fade-in">
                        {result.type === 'static' ? (
                            <div className="space-y-3">
                                <h3 className="text-lg font-bold text-center mb-2">Static Count Results</h3>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-left p-2 border-b border-slate-300 dark:border-slate-600">
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Critical Level (Lc):</span><span className="font-mono text-right">{result.Lc} net counts</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">LLD / Ld:</span><span className="font-mono text-right">{result.LLD} net counts</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Background Activity:</span><span className="font-mono text-right">{result.backgroundActivity} dpm/100cm²</span>
                                </div>
                                <div className="text-center pt-2">
                                    <p className="font-semibold text-sm text-slate-500 dark:text-slate-400">Minimum Detectable Activity (MDA)</p>
                                    <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.MDA}</p>
                                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">dpm/100 cm²</p>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                <h3 className="text-lg font-bold text-center mb-2">Scan Survey Results</h3>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-left p-2 border-b border-slate-300 dark:border-slate-600">
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Observation Interval:</span><span className="font-mono text-right">{result.obs_interval} s</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Bkg. Counts in Interval:</span><span className="font-mono text-right">{result.bg_counts_in_interval} counts</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">MDCR (Surveyor):</span><span className="font-mono text-right">{result.mdcr} cpm</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Background Activity:</span><span className="font-mono text-right">{result.background_activity} dpm/100cm²</span>
                                </div>
                                <div className="text-center pt-2">
                                    <p className="font-semibold text-sm text-slate-500 dark:text-slate-400">Scan MDC</p>
                                    <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.scan_mda}</p>
                                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">dpm/100 cm²</p>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};

/**
 * @description A calculator to determine the required number of statistical samples for a
 * survey unit based on the more precise MARSSIM Equation 5-2.
 */
const MARSSIM_SampleCalculator = () => {
    // --- STATE MANAGEMENT ---
    const [alpha, setAlpha] = React.useState('0.05'); // Type I Error Rate (False Positive)
    const [beta, setBeta] = React.useState('0.05');  // Type II Error Rate (False Negative)
    const [sigma, setSigma] = React.useState('15');  // Estimated Standard Deviation
    const [dcgl, setDcgl] = React.useState('100');   // Derived Concentration Guideline Level
    const [lbgr, setLbgr] = React.useState('50');    // Lower Bound of the Gray Region
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // Z-scores for common one-sided confidence levels (from MARSSIM Table 5.2 notes)
    const zScores = {
        '0.005': 2.576, '0.01': 2.326, '0.025': 1.960, '0.05': 1.645,
        '0.10': 1.282, '0.20': 0.841,
    };

    // Data from MARSSIM Table 5.2: Pr vs. Relative Shift
    const prValues = {
        0.1: 0.528182, 0.2: 0.556223, 0.3: 0.583985, 0.4: 0.611335, 0.5: 0.638143,
        0.6: 0.66429, 0.7: 0.689665, 0.8: 0.714167, 0.9: 0.73771, 1: 0.760217,
        1.1: 0.781627, 1.2: 0.801892, 1.3: 0.820978, 1.4: 0.838864, 1.5: 0.855541,
        1.6: 0.871014, 1.7: 0.885299, 1.8: 0.89842, 1.9: 0.910413, 2: 0.921319,
        2.25: 0.944167, 2.5: 0.961428, 2.75: 0.974067, 3: 0.983039, 3.5: 0.993329,
        4: 0.997658
    };

    const handleCalculate = () => {
        // --- Input Parsing and Validation ---
        const sigma_val = parseFloat(sigma);
        const dcgl_val = parseFloat(dcgl);
        const lbgr_val = parseFloat(lbgr);
        
        if (isNaN(sigma_val) || isNaN(dcgl_val) || isNaN(lbgr_val) || sigma_val <= 0) {
            setError('Please enter valid, positive numbers for all fields.');
            setResult(null); return;
        }
        if (dcgl_val <= lbgr_val) {
            setError('DCGL must be greater than the LBGR.');
            setResult(null); return;
        }
        setError('');

        // --- Perform Calculations ---
        const z1_alpha = zScores[alpha];
        const z1_beta = zScores[beta];
        const delta = dcgl_val - lbgr_val;
        const relativeShift = delta / sigma_val;

        // --- Linear Interpolation for Pr ---
        const shiftKeys = Object.keys(prValues).map(parseFloat);
        let Pr;
        if (relativeShift >= 4) {
            Pr = 1; // Per MARSSIM guidance for large relative shifts
        } else {
            const lowerKey = Math.max(...shiftKeys.filter(k => k <= relativeShift));
            const upperKey = Math.min(...shiftKeys.filter(k => k > relativeShift));
            
            if (isFinite(lowerKey) && isFinite(upperKey)) {
                const lowerP = prValues[lowerKey];
                const upperP = prValues[upperKey];
                const slope = (upperP - lowerP) / (upperKey - lowerKey);
                Pr = lowerP + slope * (relativeShift - lowerKey);
            } else {
                 setError(`Relative shift (${relativeShift.toFixed(2)}) is outside the table's range.`);
                 setResult(null); return;
            }
        }
        
        // --- MARSSIM Equation 5-2 ---
        const N_base_raw = Math.pow(z1_alpha + z1_beta, 2) / (3 * Math.pow(Pr - 0.5, 2));
        const N_base = Math.ceil(N_base_raw); 

        const N_with_overage = N_base * 1.2;
        const final_N = Math.ceil(N_with_overage);
        
        const samplesPerGroup = Math.ceil(final_N / 2);

        setResult({
            totalShift: delta,
            relativeShift: relativeShift.toFixed(2),
            Pr: Pr.toFixed(5),
            zAlpha: z1_alpha,
            zBeta: z1_beta,
            N_base: N_base,
            samplesPerGroup: samplesPerGroup,
            final_N: final_N
        });
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-1">MARSSIM Number of Samples Calculator</h2>
                <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Using the WRS Test and Table 5.2 Interpolation.</p>
                
                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium">Type I Error (&alpha;)</label>
                            <select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                {Object.keys(zScores).map(key => <option key={key} value={key}>{key}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Type II Error (&beta;)</label>
                            <select value={beta} onChange={e => setBeta(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                               {Object.keys(zScores).map(key => <option key={key} value={key}>{key}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                         <div>
                            <label className="block text-sm font-medium">Estimated Standard Deviation (&sigma;)</label>
                            <input type="number" value={sigma} onChange={e => setSigma(e.target.value)} placeholder="in units of DCGL" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium">DCGL</label>
                            <input type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} placeholder="Cleanup limit" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                        </div>
                         <div>
                            <label className="block text-sm font-medium">Lower Bound of Gray Region (LBGR)</label>
                            <input type="number" value={lbgr} onChange={e => setLbgr(e.target.value)} placeholder="Concentration that is 'clean'" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                        </div>
                    </div>
                    
                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Calculate Number of Samples</button>
                    
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {result && (
                        <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 text-center animate-fade-in">
                             <div className="grid grid-cols-2 gap-2 text-sm">
                                <p className="font-semibold text-slate-500 dark:text-slate-400">Total Shift (&Delta;):</p><p className="font-mono">{result.totalShift}</p>
                                <p className="font-semibold text-slate-500 dark:text-slate-400">Relative Shift (&Delta;/&sigma;):</p><p className="font-mono">{result.relativeShift}</p>
                                <p className="font-semibold text-slate-500 dark:text-slate-400">Probability (P&darr;r):</p><p className="font-mono">{result.Pr}</p>
                                <p className="font-semibold text-slate-500 dark:text-slate-400">Z&darr;1-&alpha;:</p><p className="font-mono">{result.zAlpha}</p>
                                <p className="font-semibold text-slate-500 dark:text-slate-400">Z&darr;1-&beta;:</p><p className="font-mono">{result.zBeta}</p>
                             </div>
                             <div>
                                <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Required Samples per Group (N/2)</p>
                                <p className="text-lg font-bold">{result.samplesPerGroup}</p>
                            </div>
                            <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                                <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Total Recommended Samples</p>
                                <p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.final_N}</p>
                                <p className="text-xs font-medium text-slate-600 dark:text-slate-300">({result.N_base} base samples + 20% overage)</p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};







/**
 * @description A calculator that performs the MARSSIM Wilcoxon Rank Sum (WRS) test
 * to compare a survey unit to a reference area, with large sample approximation and EMC logic.
 */
const WRS_Calculator = () => {
    // --- STATE MANAGEMENT ---
    const [dcgl, setDcgl] = React.useState('5');
    const [referenceData, setReferenceData] = React.useState('1.6\n1.2\n1.4\n1.2\n0.5\n1.5\n0.8\n1.1\n1.9\n1.7\n1.8\n1.8\n1.7\n1.9\n2.1\n1.8\n2.1\n2.4\n2.2\n2.9\n2\n1.7\n2.3\n1.1\n2.3\n0.6\n1.1\n1.1\n1.4\n2.1');
    const [surveyData, setSurveyData] = React.useState('2.928\n3.458\n3.31\n3.198\n2.218\n6.827\n2.269\n4.96\n2.766\n3.29\n10.833\n1.606\n1.856\n3.135\n1.808\n1.873\n3.373\n1.887\n1.457\n5.5\n1.973\n1.915\n2.205\n1.814\n3.7\n2.327\n1.919\n2.677\n3.253\n1.776\n5.201\n4.737\n2.585');
    const [alpha, setAlpha] = React.useState('0.05');
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // A subset of MARSSIM Table I.4: Critical Values for WRS Test (for α = 0.05)
    // Keyed as [n][m] where n=reference size, m=survey size
    const criticalValueTable = {
        '0.05': {
            '5': { '5': 28, '6': 32, '7': 36, '8': 41, '9': 45, '10': 50 },
            '6': { '5': 33, '6': 38, '7': 43, '8': 48, '9': 53, '10': 59 },
            '7': { '5': 37, '6': 43, '7': 49, '8': 54, '9': 60, '10': 66 },
            '8': { '5': 42, '6': 49, '7': 55, '8': 61, '9': 67, '10': 74 },
            '9': { '5': 46, '6': 54, '7': 61, '8': 68, '9': 75, '10': 82 },
            '10': { '5': 51, '6': 59, '7': 67, '8': 75, '9': 83, '10': 91 },
            '11': { '11': 111, '12': 119, '13': 127, '14': 135, '15': 143 },
            '12': { '12': 131, '13': 139, '14': 148, '15': 156, '16': 165 },
            '13': { '13': 151, '14': 160, '15': 169, '16': 178, '17': 187 },
            '14': { '14': 171, '15': 181, '16': 190, '17': 200, '18': 210 },
            '15': { '15': 192, '16': 202, '17': 212, '18': 223, '19': 233 },
        }
    };
    
    // Z-scores for common one-sided confidence levels
    const zScores = { '0.05': 1.645, '0.025': 1.960, '0.01': 2.326, '0.10': 1.282 };
    
    const parseData = (dataString) => {
        return dataString
            .split(/[\s,;\n]+/)
            .filter(d => d.trim() !== '' && !isNaN(d))
            .map(Number);
    };

    const handleCalculate = () => {
        setResult(null);
        setError('');
        const refData = parseData(referenceData);
        const suData = parseData(surveyData);
        const dcgl_val = parseFloat(dcgl);
        
        if (isNaN(dcgl_val)) { setError('DCGL must be a valid number.'); return; }
        if (refData.length < 5 || suData.length < 5) { setError('At least 5 data points are required for each area.'); return; }
        
        const dcglExceeded = suData.some(val => val > dcgl_val);
        
        let combined = [
            ...refData.map(v => ({ value: v + dcgl_val, group: 'ref' })),
            ...suData.map(v => ({ value: v, group: 'su' }))
        ].sort((a, b) => a.value - b.value);

        for (let i = 0; i < combined.length; i++) {
            let ties = [i];
            const epsilon = 1e-9;
            while (i + 1 < combined.length && Math.abs(combined[i].value - combined[i+1].value) < epsilon) { 
                i++; 
                ties.push(i); 
            }
            if (ties.length > 1) {
                const avgRank = (ties[0] + 1 + ties[ties.length-1] + 1) / 2;
                ties.forEach(index => { combined[index].rank = avgRank; });
            } else {
                combined[i].rank = i + 1;
            }
        }
        
        const W_rs = combined.filter(d => d.group === 'ref').reduce((sum, d) => sum + d.rank, 0);
        
        const n = refData.length;
        const m = suData.length;
        let C_w;

        const tableVal = criticalValueTable[alpha]?.[n]?.[m] || criticalValueTable[alpha]?.[m]?.[n];

        if (tableVal) {
            C_w = tableVal;
        } else {
            const zAlpha = zScores[alpha];
            const N = n + m;
            const mean_W = (n * (N + 1)) / 2;
            const stdDev_W = Math.sqrt((n * m * (N + 1)) / 12);
            C_w = Math.round(mean_W + (zAlpha * stdDev_W) + 0.5);
        }

        const wrsTestPassed = W_rs >= C_w;
        
        // --- NEW LOGIC: Determine a three-tiered conclusion ---
        let finalConclusion = 'FAIL'; // Default to FAIL
        let finalReason = `The rank sum (${W_rs}) is less than the critical value (${C_w}).`;

        if (wrsTestPassed) {
            if (dcglExceeded) {
                finalConclusion = 'PASS_EMC'; // Pass, but with a condition
                finalReason = `The WRS test passes, but an Elevated Measurement Comparison (EMC) is required because at least one measurement exceeds the DCGL.`;
            } else {
                finalConclusion = 'PASS'; // A clear pass
                finalReason = `The rank sum (${W_rs}) is greater than or equal to the critical value (${C_w}), and no measurements exceed the DCGL.`;
            }
        }
        
        setResult({
            conclusion: finalConclusion,
            reason: finalReason,
            n, m, W_rs, C_w
        });
    };

    // Helper object for styling the results box based on the conclusion
    const resultStyles = {
        PASS: {
            container: 'bg-green-100 dark:bg-green-900/50',
            title: 'text-green-600 dark:text-green-400',
            text: 'text-green-800 dark:text-green-200',
            display: 'SURVEY UNIT PASSES'
        },
        PASS_EMC: {
            container: 'bg-yellow-100 dark:bg-yellow-900/50',
            title: 'text-yellow-600 dark:text-yellow-400',
            text: 'text-yellow-800 dark:text-yellow-200',
            display: 'PASS (EMC Required)'
        },
        FAIL: {
            container: 'bg-red-100 dark:bg-red-900/50',
            title: 'text-red-600 dark:text-red-400',
            text: 'text-red-800 dark:text-red-200',
            display: 'SURVEY UNIT FAILS'
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">MARSSIM WRS Test Calculator</h2>
                <div className="space-y-4">
                    {/* ... (Input fields are unchanged) ... */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium">Reference Area Data</label>
                            <textarea value={referenceData} onChange={e => setReferenceData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Survey Unit Data</label>
                            <textarea value={surveyData} onChange={e => setSurveyData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium">DCGL</label>
                            <input type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Significance Level (&alpha;)</label>
                            <select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                <option value="0.05">0.05</option>
                                <option value="0.025">0.025</option>
                                <option value="0.01">0.01</option>
                                <option value="0.10">0.10</option>
                            </select>
                        </div>
                    </div>
                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Perform WRS Test</button>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {/* --- UPDATED Results Display with 3-Color Logic --- */}
                    {result && (
                        <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.conclusion].container}`}>
                            <p className={`text-3xl font-extrabold ${resultStyles[result.conclusion].title}`}>
                                {resultStyles[result.conclusion].display}
                            </p>
                            <p className={`mt-2 text-sm ${resultStyles[result.conclusion].text}`}>{result.reason}</p>
                            <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                                <p>Reference Samples (n): <span className="font-bold">{result.n}</span></p>
                                <p>Survey Samples (m): <span className="font-bold">{result.m}</span></p>
                                <p>Rank Sum (W&darr;rs): <span className="font-bold">{result.W_rs}</span></p>
                                <p>Critical Value (C&darr;w): <span className="font-bold">{result.C_w}</span></p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};


/**
 * @description A calculator that performs the MARSSIM Sign Test for an
 * Elevated Measurement Comparison (EMC) area.
 */

/**
* @description A calculator that performs the MARSSIM Sign Test for an
* Elevated Measurement Comparison (EMC) area.
*/
const EMC_Calculator = () => {
    // --- STATE MANAGEMENT ---
    const [dcglw, setDcglw] = React.useState('100');
    const [areaFactor, setAreaFactor] = React.useState('3');
    const [emcData, setEmcData] = React.useState('120, 150, 95, 250, 180, 210, 190, 280');
    const [alpha, setAlpha] = React.useState('0.05'); // Default alpha
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // MARSSIM Table I.3: Critical Values for the Sign Test
    // Keyed by alpha level, then by sample size N
    const signTestCriticalValues = {
        '0.05': {
            5: 5, 6: 6, 7: 7, 8: 7, 9: 8, 10: 9, 11: 9, 12: 10, 13: 11, 14: 11, 15: 12,
            16: 12, 17: 13, 18: 14, 19: 14, 20: 15, 21: 16, 22: 16, 23: 17, 24: 17,
            25: 18, 26: 19, 27: 19, 28: 20, 29: 21, 30: 21
        },
        '0.025': {
            5: 5, 6: 6, 7: 7, 8: 8, 9: 8, 10: 9, 11: 10, 12: 10, 13: 11, 14: 12, 15: 12,
            16: 13, 17: 14, 18: 14, 19: 15, 20: 15, 21: 16, 22: 17, 23: 17, 24: 18,
            25: 19, 26: 19, 27: 20, 28: 20, 29: 21, 30: 22
        },
        '0.01': {
            5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 9, 11: 10, 12: 11, 13: 11, 14: 12, 15: 13,
            16: 13, 17: 14, 18: 15, 19: 15, 20: 16, 21: 17, 22: 17, 23: 18, 24: 18,
            25: 19, 26: 20, 27: 20, 28: 21, 29: 22, 30: 22
        },
        '0.10': {
            5: 4, 6: 5, 7: 6, 8: 6, 9: 7, 10: 8, 11: 8, 12: 9, 13: 10, 14: 10, 15: 11,
            16: 11, 17: 12, 18: 13, 19: 13, 20: 14, 21: 15, 22: 15, 23: 16, 24: 16,
            25: 17, 26: 18, 27: 18, 28: 19, 29: 20, 30: 20
        }
    };

    const parseData = (dataString) => {
        return dataString.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
    };

    const handleCalculate = () => {
        setResult(null);
        setError('');

        const data = parseData(emcData);
        const dcglw_val = parseFloat(dcglw);
        const af_val = parseFloat(areaFactor);

        // --- Validation ---
        if (isNaN(dcglw_val) || isNaN(af_val) || dcglw_val <= 0 || af_val <= 1) {
            setError('DCGL and Area Factor must be valid numbers (AF > 1).');
            return;
        }
        if (data.length === 0) {
            setError('Please enter measurement data.');
            return;
        }

        // --- MARSSIM EMC Calculations ---
        const n = data.length;
        const dcgl_emc = dcglw_val * af_val;

        // Count the number of positive differences (DCGLEMC - measurement > 0)
        // Note: Sign Test is for non-parametric data, so we don't assume normality.
        // We compare each measurement to DCGL_EMC. If meas < DCGL_EMC, then (DCGL_EMC - meas) > 0.
        // MARSSIM convention for S+ is the number of values where the null hypothesis (contamination) is true,
        // so for EMC it's values *less than* the DCGL_EMC.
        const S_plus = data.filter(val => (dcgl_emc - val) > 0).length;

        // Look up the critical value from the table
        const Cs = signTestCriticalValues[alpha]?.[n];

        if (Cs === undefined) {
            setError(`A critical value is not available for a sample size of ${n} at alpha ${alpha}. Please use a sample size between 5 and 30.`);
            return;
        }

        // --- Make a decision ---
        const testPassed = S_plus >= Cs;

        setResult({
            conclusion: testPassed ? 'PASS' : 'FAIL',
            reason: `The number of positive differences (S+) is ${S_plus}, which is ${testPassed ? 'greater than or equal to' : 'less than'} the critical value (${Cs}).`,
            n,
            dcgl_emc: dcgl_emc.toPrecision(4),
            S_plus,
            Cs
        });
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">MARSSIM EMC Sign Test Calculator</h2>
                <div className="space-y-4">
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium">Widespread DCGL (DCGLw)</label>
                                <input type="number" value={dcglw} onChange={e => setDcglw(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Area Factor (AF)</label>
                                <input type="number" value={areaFactor} onChange={e => setAreaFactor(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                            </div>
                        </div>
                        <div>
                           <label className="block text-sm font-medium">Elevated Area Measurements</label>
                           <textarea value={emcData} onChange={e => setEmcData(e.target.value)} rows="6" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Significance Level (&alpha;)</label>
                            <select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                <option value="0.05">0.05</option>
                                <option value="0.025">0.025</option>
                                <option value="0.01">0.01</option>
                                <option value="0.10">0.10</option>
                            </select>
                        </div>
                    </div>
                    <button onClick={handleCalculate} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Run Sign Test</button>
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    {result && (
                        <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${result.conclusion === 'PASS' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                            <p className={`text-3xl font-extrabold ${result.conclusion === 'PASS' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                EMC AREA {result.conclusion}ES
                            </p>
                            <p className={`mt-2 text-sm ${result.conclusion === 'PASS' ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}`}>{result.reason}</p>
                            <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                                <p>DCGL&darr;emc: <span className="font-bold">{result.dcgl_emc}</span></p>
                                <p>Samples (N): <span className="font-bold">{result.n}</span></p>
                                <p>Positive Ranks (S+): <span className="font-bold">{result.S_plus}</span></p>
                                <p>Critical Value (Cs): <span className="font-bold">{result.Cs}</span></p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

     /**
      * @description A React component that renders a line chart for simple radioactive decay using Chart.js.
      * It can display the decay of a parent nuclide and the in-growth and decay of a single daughter nuclide.
      * @param {{chartData: object}} props - The data object for the chart, including labels and datasets for parent and optional daughter.
      */

        const DecayChart = ({ chartData }) => {
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);

            React.useEffect(() => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                if (chartRef.current && chartData) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [
                                {
                                    label: chartData.parentName,
                                    data: chartData.parentData,
                                    borderColor: '#0284c7', // sky-600
                                    tension: 0.1
                                },
                                ...(chartData.daughterData ? [{
                                    label: chartData.daughterName,
                                    data: chartData.daughterData,
                                    borderColor: '#e11d48', // rose-600
                                    tension: 0.1
                                }] : [])
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Activity' }
                                },
                                x: {
                                    title: { display: true, text: `Time (${chartData.timeUnit})` }
                                }
                            }
                        }
                    });
                }
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [chartData]);

            return <div className="mt-4 h-64"><canvas ref={chartRef}></canvas></div>;
        };

        // Final step: Render the main App component into the DOM.

ReactDOM.createRoot(document.getElementById('root')).render(
    <SettingsProvider>
        <ToastProvider>
            <App />
        </ToastProvider>
    </SettingsProvider>
);

const SettingsPanel = () => {
    const { settings, updateSettings } = React.useContext(SettingsContext);
    const { addToast } = useToast();

    // Updated data for the dropdown options
    const activityUnits = ['Bq', 'kBq', 'MBq', 'GBq', 'Ci', 'mCi', 'µCi', 'dps', 'dpm'];
    const doseRateUnits = ['Gy/s', 'Gy/hr', 'cGy/hr', 'rad/hr', 'Sv/s', 'Sv/hr', 'mSv/hr', 'µSv/hr', 'rem/hr', 'mrem/hr'];
    const distanceUnits = ['m', 'cm', 'mm', 'km', 'in', 'ft'];

    const handleSettingChange = (key, value) => {
        updateSettings({ [key]: value });
        addToast(`Default unit for ${key} set to ${value}.`);
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Default Settings</h2>
                <p className="text-sm text-slate-600 dark:text-slate-300 mb-6">
                    These are the default units used by the Dose Rate, Shielding, and Stay Time calculators.
                </p>
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium">Activity</label>
                        <select 
                            value={settings.activity} 
                            onChange={e => handleSettingChange('activity', e.target.value)} 
                            className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"
                        >
                            {activityUnits.map(unit => (
                                <option key={unit} value={unit}>{unit}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Dose Rate</label>
                        <select 
                            value={settings.doseRate} 
                            onChange={e => handleSettingChange('doseRate', e.target.value)} 
                            className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"
                        >
                            {doseRateUnits.map(unit => (
                                <option key={unit} value={unit}>{unit}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Distance</label>
                        <select 
                            value={settings.distance} 
                            onChange={e => handleSettingChange('distance', e.target.value)} 
                            className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"
                        >
                            {distanceUnits.map(unit => (
                                <option key={unit} value={unit}>{unit}</option>
                            ))}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    );
};

    </script>
</body>
</html>
