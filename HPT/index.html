<!DOCTYPE html>
<html lang="en">
   <head>
      <!--Basic HTML Metadata-->
      <meta charset="UTF-8" />
      <meta content="width=device-width, initial-scale=1.0" name="viewport" />
      <script>
         (function() {
         
           // Function to apply the dark theme
         
           const applyTheme = () => {
             document.documentElement.classList.add('dark');
           };
         
           // Check 1: See if a theme is explicitly saved in localStorage
         
           const savedTheme = localStorage.getItem('theme');
           if (savedTheme === 'dark') {
             applyTheme();
             return;
           }
         
           // Check 2: If no saved theme, check the user's OS/browser preference
         
           if (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
             applyTheme();
           }
         
         })();
      </script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
      <title>Health Physics Toolbox</title>
      <!--External Libraries & Frameworks-->
      <!--Tailwind CSS for styling-->
      <script src="https://cdn.tailwindcss.com"></script>
      <script>
         // Enables Tailwind's dark mode feature, allowing class-based theme switching (e.g., <body class="dark">)
         
         tailwind.config = {
           darkMode: 'class'
         }
      </script>
      <!--React Libraries for building the user interface-->
      <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script> 
      <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
      <!--Babel to transpile JSX (React's syntax) into plain JavaScript in the browser-->
      <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
      <!--Chart.js for creating data visualizations-->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <!--Google Fonts for a clean, modern typeface-->
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
      <!--Custom Application Styles-->
      <link href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" rel="stylesheet" />
      <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
      <script defer onload="renderMathInElement(document.body);" src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
      <style>
         /* --- Styles for the mouse coordinate display on the map --- */
         .leaflet-control-mouseposition {
         background-color: rgba(255, 255, 255, 0.8);
         box-shadow: 0 0 5px #bbb;
         padding: 3px 8px;
         margin: 0;
         color: #333;
         font: 12px/1.5 "Inter", sans-serif;
         border-radius: 4px;
         border: 1px solid #aaa;
         }
      </style>
      <style>
         /* --- STYLES FOR PERSISTENT NUMBER INPUT SPINNERS & CUSTOM DRAW CURSOR --- */
         .persistent-spinner::-webkit-inner-spin-button,
         .persistent-spinner::-webkit-outer-spin-button {
         opacity: 0.3;
         -webkit-appearance: inner-spin-button !important;
         cursor: pointer;
         transition: opacity 0.2s ease-in-out;
         }
         .persistent-spinner:hover::-webkit-inner-spin-button,
         .persistent-spinner:hover::-webkit-outer-spin-button,
         .persistent-spinner:focus::-webkit-inner-spin-button,
         .persistent-spinner:focus::-webkit-outer-spin-button {
         opacity: 1;
         }
         /* ADDED: This creates the yellow dot icon for the bias sample drawing tool */
         .leaflet-draw-biased-marker-icon {
         background-color: #facc15;
         /* amber-400 */
         border: 2px solid #ca8a04;
         /* amber-600 */
         border-radius: 50%;
         box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
         }
      </style>
      <style>
         /* This is now the only style block needed for the fade-in.
         It hides the main content area by default to prevent any FOUC.
         */
         #root {
         visibility: hidden;
         /* Hide it completely */
         opacity: 0;
         /* Start fully transparent */
         transform: translateY(-10px);
         /* Start slightly moved up */
         /* Prepare for a smooth transition when the 'visible' class is added */
         transition: opacity 0.4s ease-out, transform 0.4s ease-out;
         }
         /* This class will be added by our script to trigger the animation */
         #root.visible {
         visibility: visible;
         /* Make it visible */
         opacity: 1;
         /* Fade it in */
         transform: translateY(0);
         /* Move it to its final position */
         }
      </style>
      <style>
         /* --- LOADER STYLES (NOW THEME-AWARE) --- */
         /* Light Mode Defaults */
         #loader {
         position: fixed;
         inset: 0;
         z-index: 9999;
         background-color: #f1f5f9;
         /* slate-100 */
         display: flex;
         justify-content: center;
         align-items: center;
         flex-direction: column;
         transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
         }
         .spinner {
         width: 48px;
         height: 48px;
         border: 5px solid #cbd5e1;
         /* slate-300 */
         border-bottom-color: #38bdf8;
         /* sky-400 */
         border-radius: 50%;
         display: inline-block;
         box-sizing: border-box;
         animation: spin 1s linear infinite;
         }
         .loading-text {
         margin-top: 20px;
         font-size: 1rem;
         font-weight: 500;
         color: #64748b;
         /* slate-500 */
         animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
         }
         /* Dark Mode Overrides */
         .dark #loader {
         background-color: #0f172a;
         /* slate-900 */
         }
         .dark .spinner {
         border: 5px solid #334155;
         /* slate-700 */
         border-bottom-color: #38bdf8;
         /* sky-400 */
         }
         .dark .loading-text {
         color: #94a3b8;
         /* slate-400 */
         }
         /* General Loader Logic (Unchanged) */
         #loader.hidden {
         opacity: 0;
         visibility: hidden;
         }
         @keyframes spin {
         0% {
         transform: rotate(0deg);
         }
         100% {
         transform: rotate(360deg);
         }
         }
         @keyframes pulse {
         0%,
         100% {
         opacity: 1;
         }
         50% {
         opacity: 0.5;
         }
         }
      </style>
      <style>
         body {
         /* Sets the default background to your dark theme color */
         background-color: #0f172a;
         /* This is Tailwind's slate-900 */
         font-family: "Inter", sans-serif;
         }
         /* Custom scrollbar styling for a consistent look across browsers */
         ::-webkit-scrollbar {
         width: 8px;
         height: 8px;
         }
         ::-webkit-scrollbar-track {
         background: #f1f5f9;
         }
         .dark ::-webkit-scrollbar-track {
         background: #1e293b;
         }
         ::-webkit-scrollbar-thumb {
         background: #64748b;
         border-radius: 10px;
         }
         ::-webkit-scrollbar-thumb:hover {
         background: #475569;
         }
         /* Keyframe animation for new elements fading into view */
         .animate-fade-in {
         animation: fade-in 0.3s ease-out forwards;
         }
         /* Keyframe animation for toast notifications sliding in from the bottom */
         @keyframes toast-in {
         from {
         opacity: 0;
         transform: translateY(20px);
         }
         to {
         opacity: 1;
         transform: translateY(0);
         }
         }
         .animate-toast-in {
         animation: toast-in 0.3s ease-out forwards;
         }
         /* --- NEW, TARGETED STYLES FOR SAMPLE POINTS --- */
         .grid-sample-marker {
         stroke: #1E88E5;
         /* blue-600 */
         stroke-width: 1;
         fill: #1E88E5;
         fill-opacity: 1;
         }
         .origin-sample-marker {
         stroke: #9333ea;
         /* purple-600 */
         stroke-width: 2;
         fill: #c084fc;
         /* purple-400 */
         fill-opacity: 1;
         }
         .biased-sample-marker {
         stroke: #facc15;
         /* amber-400 */
         stroke-width: 1;
         fill: #facc15;
         fill-opacity: 1;
         }
      </style>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
      <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3/dist/geosearch.css" />
      <script src="https://unpkg.com/leaflet-geosearch@3/dist/geosearch.umd.js"></script>
      <script>

         // When the document is ready, add the 'visible' class to the #root element
         // to trigger our CSS transition.
         
         window.addEventListener('DOMContentLoaded', () => {
           document.getElementById('root').classList.add('visible');
         });
      </script>
   </head>
   <body class="bg-slate-100 dark:bg-slate-900 transition-colors duration-300">
      <div id="loader">
         <div class="spinner"></div>
         <p class="loading-text">Health Physics Toolbox loading...</p>
      </div>
      <!--The root element where the React application will be mounted.-->
      <div id="root"></div>
      <div id="back-to-top-root"></div>
      <div id="modal-root"></div>
      <div id="toast-root"></div>
      <!--The primary dataset for all radionuclides.
         Keeping this in a separate script tag makes the main application logic cleaner and easier to manage.
         Each object conforms to a consistent structure for properties like name, symbol, halfLife, etc.-->
      <script>
         // Radionuclide data updated to include dosimetry values from 10 CFR 20, Appendix B
         
const RADIONUCLIDE_DATA = [
  {
    name: 'Actinium-225',
    symbol: 'Ac-225',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.83 MeV (dominant)'],
      gamma: ['0.099 MeV', '0.150 MeV'],
      beta: []
    },
    daughterEmissions: {
      from: 'Fr-221',
      alpha: ['6.34 MeV']
    },
    halfLife: '9.92 days',
    decayConstant: '0.0693 day⁻¹',
    specificActivity: '2.16e15 Bq/g',
    parent: 'Thorium-229 (α)',
    daughter: 'Francium-221 (α)',
    commonUses: ['Targeted Alpha Therapy (TAT) for cancer', 'alpha-emitter generator'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A promising but scarce alpha-emitter used in clinical trials for targeted cancer therapy.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.06,
    shipping: { A1: 0.8, A2: 0.006, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 50,
        inhalation_W: 0.6,
        inhalation_Y: 0.6
      },
      DAC: {
        inhalation_W: 3e-10,
        inhalation_Y: 3e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.32E-6,
        inhalation_Y: 2.19e-6
      },
      sourceRef: '10CFR20'
    },
    gammaConstant: '0.191364 R·m²/hr·Ci',
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Actinium-227',
    symbol: 'Ac-227',
    emissionType: ['Beta-minus', 'Alpha'],
    emissionEnergies: {
      beta: ['0.045 MeV (max)'],
      alpha: ['4.95 MeV (1.38%)'],
      gamma: []
    },
    avgBetaEnergy: '0.015 MeV',
    daughterEmissions: {
      from: 'Th-227',
      alpha: ['6.038 MeV'],
      gamma: ['0.236 MeV']
    },
    halfLife: '21.77 years',
    decayConstant: '0.0318 year⁻¹',
    specificActivity: '2.68e12 Bq/g',
    parent: 'Protactinium-231',
    daughter: 'Thorium-227 (β) or Francium-223 (α)',
    commonUses: ['Actinium-225 generator (medical)', 'Research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used in limited research applications and as a source for Ac-225 generators.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 0.9, A2: 0.00009, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 0.2,
        inhalation_D: 0.0004,
        inhalation_W: 0.002,
        inhalation_Y: 0.004
      },
      DAC: {
        inhalation_D: 2e-13,
        inhalation_W: 7e-12,
        inhalation_Y: 2e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.81e-3,
        inhalation_W: 4.64e-4,
        inhalation_Y: 3.49e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Actinium-228',
    symbol: 'Ac-228',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['2.14 MeV (max)'],
      gamma: ['0.911 MeV', '0.969 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.713 MeV',
    halfLife: '6.15 hours',
    decayConstant: '0.113 hour⁻¹',
    specificActivity: '1.2 x 10^17 Bq/g',
    parent: 'Radium-228',
    daughter: 'Thorium-228 (β-)',
    commonUses: ['Intermediate in Thorium-232 decay chain'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'Frequently encountered as a short-lived daughter product in the Thorium-232 natural decay series.',
    shipping: { A1: 0.6, A2: 0.5, unit: 'TBq' },
    gammaConstant: '0.84397 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 9,
        inhalation_W: 40,
        inhalation_Y: 40
      },
      DAC: {
        inhalation_D: 4e-9,
        inhalation_W: 2e-8,
        inhalation_Y: 2e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.33e-8,
        inhalation_W: 2.46e-6,
        inhalation_Y: 3.39e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Americium-241',
    symbol: 'Am-241',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.486 MeV'],
      gamma: ['0.0595 MeV'],
      beta: []
    },
    halfLife: '432.2 years',
    decayConstant: '0.00160 year⁻¹',
    specificActivity: '1.27 x 10^11 Bq/g',
    parent: 'Plutonium-241 (β-)',
    daughter: 'Neptunium-237',
    commonUses: ['Smoke detectors', 'Industrial gauges (thickness, density)', 'Neutron sources'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'Used in virtually all household ionization smoke detectors and in various industrial gauges.',
    shipping: { A1: 10, A2: 0.001, unit: 'TBq' },
    gammaConstant: '0.013 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dValue: 0.06,
    dosimetry: {
      ALI: {
        ingestion: 0.8,
        inhalation_W: 0.006
      },
      DAC: {
        inhalation_W: 3e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.20e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
    {
    name: 'Antimony-124',
    symbol: 'Sb-124',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['2.35 MeV (max)'],
      gamma: ['0.603 MeV', '1.691 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.783 MeV',
    halfLife: '60.2 days',
    decayConstant: '0.0115 day⁻¹',
    specificActivity: '7.8 x 10^14 Bq/g',
    parent: 'Tin-124',
    daughter: 'Tellurium-124 (stable)',
    commonUses: ['Tracer in hydrology', 'Industrial applications', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'Used for specialized industrial tracer studies but not in widespread applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.06,
    shipping: { A1: 0.6, A2: 0.6, unit: 'TBq' },
    gammaConstant: '1.06671 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 500,
        inhalation_D: 900,
        inhalation_W: 200
      },
      DAC: {
        inhalation_D: 4e-7,
        inhalation_W: 1e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.5e-9,
        inhalation_W: 6.8e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Antimony-125',
    symbol: 'Sb-125',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.767 MeV (max)'],
      gamma: ['0.428 MeV', '0.601 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.256 MeV',
    halfLife: '2.758 years',
    decayConstant: '0.251 year⁻¹',
    specificActivity: '1.6 x 10^13 Bq/g',
    parent: 'Tin-125',
    daughter: 'Tellurium-125m (IT) -> Tellurium-125 (stable)',
    commonUses: ['Environmental tracer (fission product)', 'Calibration source'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived fission product used occasionally as a calibration source or environmental tracer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 2, A2: 1, unit: 'TBq' },
    dValue: 0.2,
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 2000,
        inhalation_W: 500
      },
      DAC: {
        inhalation_D: 1e-6,
        inhalation_W: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.75e-10,
        inhalation_W: 3.30e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
     {
    name: 'Arsenic-74',
    symbol: 'As-74',
    emissionType: ['Positron Emission', 'Beta-minus', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['1.35 MeV (max)'],
      gamma: ['0.596 MeV', '0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.450 MeV',
    halfLife: '17.77 days',
    decayConstant: '0.039 day⁻¹',
    specificActivity: '5.1 x 10^15 Bq/g',
    parent: 'Germanium-74',
    daughter: 'Selenium-74 (stable) or Germanium-74 (stable)',
    commonUses: ['PET imaging research', 'Tracer studies'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used only in specialized PET imaging research; not for routine clinical use.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 1, A2: 0.9, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 1000,
        inhalation_W: 800
      },
      DAC: {
        inhalation_W: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.15e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Astatine-211',
    symbol: 'At-211',
    emissionType: ['Alpha', 'Electron Capture', 'X-ray'],
    emissionEnergies: {
      alpha: ['5.867 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '7.21 hours',
    decayConstant: '0.096 hour⁻¹',
    specificActivity: '7.8 x 10^16 Bq/g',
    parent: 'Bismuth-209 (α,2n)',
    daughter: 'Bismuth-207 (EC) or Polonium-211 (α)',
    commonUses: ['Targeted alpha therapy research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A promising research alpha-emitter that is difficult to produce and has a short half-life.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 20, A2: 0.5, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 100,
        inhalation_D: 80,
        inhalation_W: 50
      },
      DAC: {
        inhalation_D: 3e-8,
        inhalation_W: 2e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.22e-8,
        inhalation_W: 2.76e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Astatine-218',
    emissionType: ['Alpha', 'Beta-minus'],
    symbol: 'At-218',
    emissionEnergies: {
      alpha: ['6.757 MeV'],
      beta: ['2.88 MeV (max)']
    },
    avgBetaEnergy: '0.960 MeV',
    halfLife: '1.5 seconds',
    decayConstant: '0.462 s⁻¹',
    specificActivity: '1.28 x 10^21 Bq/g',
    parent: 'Polonium-218',
    daughter: 'Bismuth-214 (α) or Radon-218 (β-)',
    commonUses: ['Intermediate in U-238 decay chain'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain with no practical applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dosimetry: {
      ALI: {
        ingestion: 0.1,
        inhalation: 0.002
      },
      DAC: {
        inhalation: 1e-13
      },
      sourceRef: '10CFR20 (Default Alpha)'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },  
    {
    name: 'Barium-133',
    symbol: 'Ba-133',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
  beta: [],
  gamma: ['0.356 MeV', '0.303 MeV', '0.276 MeV', '0.081 MeV'], // Added 0.303 and 0.276
  alpha: []
},
    halfLife: '10.51 years',
    decayConstant: '0.0659 year⁻¹',
    gammaConstant: '0.45547 R·m²/hr·Ci',
    dValue: 2,
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    specificActivity: '9.3 x 10^12 Bq/g',
    parent: 'Lanthanum-133',
    daughter: 'Cesium-133 (stable)',
    commonUses: ['Calibration sources', 'Density gauging'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A common, long-lived gamma source used for calibrating gamma spectroscopy systems.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: { A1: 3, A2: 3, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 700
      },
      DAC: {
        inhalation_D: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.11e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Barium-137',
    symbol: 'Ba-137',
    emissionType: ['Stable'],
    emissionEnergies: {
      alpha: [],
      beta: [],
      gamma: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    specificActivity: '0 Bq/g',
    parent: 'Barium-137m (IT)',
    daughter: 'Stable',
    commonUses: ['Final stable product of Cesium-137 decay', 'Stable isotope analysis'],
    category: 'Stable/Reference',
    commonality: 'Common',
    commonalityReason: 'The stable end-product of Cs-137 decay, one of the most common radioisotopes.',
    sourceRef: {},
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Barium-137m',
    symbol: 'Ba-137m',
    emissionType: ['Isomeric Transition', 'Gamma'],
    emissionEnergies: {
      alpha: [],
      beta: [],
      gamma: ['0.662 MeV']
    },
    halfLife: '2.55 minutes',
    decayConstant: '0.272 min⁻¹',
    specificActivity: '2.9 x 10^18 Bq/g',
    parent: 'Cesium-137 (β-)',
    daughter: 'Barium-137 (stable)',
    commonUses: ['Source of gamma rays from Cesium-137 calibration sources', 'Medical imaging (historical)'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'The immediate, gamma-emitting daughter of Cs-137, responsible for its characteristic 0.662 MeV gamma ray.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 2,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 100,
        inhalation_D: 200
      },
      DAC: {
        inhalation_D: 6e-8
      },
      // FGR 11 does not typically list separate inhalation DCFs for very short-lived Ba-137m; dose is usually attributed to Cs-137 parent
      sourceRef: '10CFR20 (Isomer)'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Bismuth-207',
    symbol: 'Bi-207',
    emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.570 MeV', '1.063 MeV'],
      alpha: []
    },
    halfLife: '31.55 years',
    decayConstant: '0.0219 year⁻¹',
    specificActivity: '2.07 x 10^12 Bq/g',
    parent: 'Lead-207 (p,n)',
    daughter: 'Lead-207 (stable)',
    commonUses: ['Calibration sources', 'Environmental tracer'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived isotope used for specialized gamma calibration, but not in routine use.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 0.7, A2: 0.7, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 1000,
        inhalation_D: 2000,
        inhalation_W: 400
      },
      DAC: {
        inhalation_D: 7e-7,
        inhalation_W: 1e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.73e-9,
        inhalation_W: 5.41e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Bismuth-209',
    symbol: 'Bi-209',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['3.137 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '20100000000000000000 years',
    decayConstant: '3.45 x 10⁻²⁰ year⁻¹',
    specificActivity: '0.0031 Bq/g',
    parent: 'Primordial',
    daughter: 'Thallium-205 (stable)',
    commonUses: ['Considered stable for most practical purposes', 'Recently discovered to be radioactive'],
    category: 'Natural',
    commonality: 'Common',
    commonalityReason: 'The most abundant isotope of bismuth, long considered stable, with an extremely long half-life.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Bismuth-210',
    emissionType: ['Beta-minus'],
    symbol: 'Bi-210',
    emissionEnergies: {
      beta: ['1.16 MeV (max)'],
      alpha: [],
      gamma: []
    },
    avgBetaEnergy: '0.387 MeV',
    halfLife: '5.012 days',
    decayConstant: '0.138 day⁻¹',
    specificActivity: '9.6 x 10^15 Bq/g',
    parent: 'Lead-210',
    daughter: 'Polonium-210 (β-) or Thallium-206 (α)',
    commonUses: ['Intermediate in U-238 decay chain', 'Used in disequilibrium studies with Pb-210'],
    category: 'Natural',
    decaySeriesId: 'U-238-series',
    commonality: 'Moderate',
    commonalityReason: 'A key intermediate in the U-238 decay series, the daughter of the common environmental nuclide Pb-210.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 1, A2: 0.6, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 800,
        inhalation_D: 200,
        inhalation_W: 30
      },
      DAC: {
        inhalation_D: 1e-7,
        inhalation_W: 1e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 4.18e-9,
        inhalation_W: 5.29e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Bismuth-211',
    emissionType: ['Alpha', 'Beta-minus', 'Gamma'],
    symbol: 'Bi-211',
    emissionEnergies: {
      alpha: ['6.623 MeV'],
      beta: ['0.579 MeV (max)'],
      gamma: ['0.351 MeV']
    },
    avgBetaEnergy: '0.193 MeV',
    halfLife: '2.14 minutes',
    decayConstant: '0.324 min⁻¹',
    specificActivity: '3.4 x 10^18 Bq/g',
    parent: 'Lead-211',
    daughter: 'Thallium-207 (α) or Polonium-211 (β-)',
    commonUses: ['Intermediate in Actinium-227 decay series'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Bismuth-212',
    emissionType: ['Beta-minus', 'Alpha', 'Gamma'],
    symbol: 'Bi-212',
    emissionEnergies: {
      beta: ['2.25 MeV (max)'],
      alpha: ['6.09 MeV'],
      gamma: ['0.727 MeV', '1.621 MeV']
    },
    avgBetaEnergy: '0.750 MeV',
    halfLife: '60.55 minutes',
    decayConstant: '0.0114 min⁻¹',
    specificActivity: '1.2 x 10^17 Bq/g',
    parent: 'Lead-212',
    daughter: 'Polonium-212 (β-) or Thallium-208 (α)',
    commonUses: ['Research in targeted alpha/beta therapy'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A short-lived nuclide in the Th-232 decay series, notable for its high-energy gamma daughter (Tl-208).',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.7,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 5000,
        inhalation_D: 200,
        inhalation_W: 300
      },
      DAC: {
        inhalation_D: 1e-7,
        inhalation_W: 1e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.83e-9,
        inhalation_W: 5.17e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Bismuth-213',
    emissionType: ['Beta-minus', 'Alpha', 'Gamma'],
    symbol: 'Bi-213',
    emissionEnergies: {
      beta: ['1.42 MeV (max)'],
      alpha: ['5.87 MeV'],
      gamma: ['0.440 MeV']
    },
    avgBetaEnergy: '0.473 MeV',
    halfLife: '45.6 minutes',
    decayConstant: '0.0152 min⁻¹',
    specificActivity: '1.09 x 10^17 Bq/g',
    parent: 'Actinium-225',
    daughter: 'Polonium-213 (β) or Thallium-209 (α)',
    commonUses: ['Targeted Alpha Therapy (TAT) for various cancers.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A short-lived daughter of Ac-225, used in targeted alpha therapy research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    dosimetry: {
      ALI: {
        ingestion: 7000,
        inhalation_D: 300,
        inhalation_W: 400
      },
      DAC: {
        inhalation_D: 1e-7,
        inhalation_W: 1e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 4.63e-9,
        inhalation_W: 4.16e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Bismuth-214',
    emissionType: ['Beta-minus', 'Alpha', 'Gamma'],
    symbol: 'Bi-214',
    emissionEnergies: {
      beta: ['3.27 MeV (max)'],
      gamma: ['0.609 MeV', '1.120 MeV', '1.764 MeV'],
      alpha: ['5.62 MeV']
    },
    avgBetaEnergy: '1.090 MeV',
    halfLife: '19.9 minutes',
    decayConstant: '0.0348 min⁻¹',
    specificActivity: '3.6 x 10^17 Bq/g',
    parent: 'Lead-214',
    daughter: 'Polonium-214 (β-) / Thallium-210 (α)',
    commonUses: ['Source of natural background gamma radiation (from Radon decay products)'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A prominent gamma-emitter in the Radon-222 decay chain, contributing to natural background radiation.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    dosimetry: {
      ALI: {
        ingestion: 20000,
        inhalation_D: 800,
        inhalation_W: 900
      },
      DAC: {
        inhalation_D: 3e-7,
        inhalation_W: 4e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.78e-9,
        inhalation_W: 1.68e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  

  {
    name: 'Bromine-77',
    symbol: 'Br-77',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.239 MeV', '0.297 MeV'],
      alpha: []
    },
    halfLife: '57.04 hours',
    decayConstant: '0.0121 hour⁻¹',
    specificActivity: '1.2 x 10^16 Bq/g',
    parent: 'Krypton-77',
    daughter: 'Selenium-77 (stable)',
    commonUses: ['PET imaging research', 'Antibody labeling'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used for specialized medical research applications like antibody labeling.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 3,
      A2: 3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 20000,
        inhalation_D: 20000,
        inhalation_W: 20000
      },
      DAC: {
        inhalation_D: 1e-5,
        inhalation_W: 8e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.75e-11,
        inhalation_W: 7.46e-11
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Bromine-82',
    symbol: 'Br-82',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.444 MeV (max)'],
      gamma: ['0.777 MeV', '1.044 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.148 MeV',
    halfLife: '35.3 hours',
    decayConstant: '0.0196 hour⁻¹',
    specificActivity: '1.6 x 10^16 Bq/g',
    parent: 'Selenium-82',
    daughter: 'Krypton-82 (stable)',
    commonUses: ['Hydrological tracing', 'Flow measurements in pipelines', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A gamma-emitting tracer used for specialized industrial and hydrological studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 0.4, A2: 0.4, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 3000,
        inhalation_D: 4000,
        inhalation_W: 4000
      },
      DAC: {
        inhalation_D: 2e-6,
        inhalation_W: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.31e-10,
        inhalation_W: 4.13e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  
  {
    name: 'Cadmium-109',
    symbol: 'Cd-109',
    emissionType: ['Electron Capture', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.088 MeV (γ)'],
      alpha: []
    },
    halfLife: '461.4 days',
    decayConstant: '0.00150 day⁻¹',
    specificActivity: '1.2 x 10^14 Bq/g',
    parent: 'Indium-109',
    daughter: 'Silver-109 (stable)',
    commonUses: ['X-ray fluorescence', 'Calibration source'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A common source for X-ray fluorescence (XRF) analyzers and instrument calibration.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: { A1: 30, A2: 2, unit: 'TBq' },
    dValue: 20,
    dosimetry: {
      ALI: {
        ingestion: 300,
        inhalation_D: 40,
        inhalation_W: 100,
        inhalation_Y: 100
      },
      DAC: {
        inhalation_D: 1e-8,
        inhalation_W: 5e-8,
        inhalation_Y: 5e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.09e-8,
        inhalation_W: 1.07e-8,
        inhalation_Y: 1.22e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Cadmium-115m',
    symbol: 'Cd-115m',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.62 MeV (max)'],
      gamma: ['0.934 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.540 MeV',
    halfLife: '44.6 days',
    decayConstant: '0.0155 day⁻¹',
    specificActivity: '1.3 x 10^15 Bq/g',
    parent: 'Silver-115',
    daughter: 'Indium-115',
    commonUses: ['Fission product', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fission product with limited use outside of specific research applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 300,
        inhalation_D: 50,
        inhalation_W: 100,
        inhalation_Y: 100
      },
      DAC: {
        inhalation_D: 2e-8,
        inhalation_W: 5e-8,
        inhalation_Y: 6e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.95e-8,
        inhalation_W: 1.11e-8,
        inhalation_Y: 1.16e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Calcium-45',
    symbol: 'Ca-45',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.257 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.086 MeV',
    halfLife: '162.6 days',
    decayConstant: '0.00426 day⁻¹',
    specificActivity: '6.4 x 10^14 Bq/g',
    parent: 'Potassium-45',
    daughter: 'Scandium-45 (stable)',
    commonUses: ['Bone metabolism studies', 'Agricultural research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A pure beta-emitter used as a tracer in specialized biological and agricultural research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 100,
    shipping: {
      A1: 40,
      A2: 1,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 800
      },
      DAC: {
        inhalation_W: 4e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.79e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Calcium-47',
    symbol: 'Ca-47',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.694 MeV (max)'],
      gamma: ['1.297 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.231 MeV',
    daughterEmissions: {
      from: 'Sc-47',
      beta: ['0.601 MeV (max)'],
      gamma: ['0.159 MeV']
    },
    halfLife: '4.536 days',
    decayConstant: '0.153 day⁻¹',
    specificActivity: '2.07 x 10^16 Bq/g',
    parent: 'Potassium-47',
    daughter: 'Scandium-47',
    commonUses: ['Bone metabolism research (historical)', 'Medical studies'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Largely replaced by other isotopes for medical studies, now used only in limited research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 3,
      A2: 0.3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 800,
        inhalation_W: 900
      },
      DAC: {
        inhalation_W: 4e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.77e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },

{
    name: 'Californium-252',
    symbol: 'Cf-252',
    emissionType: ['Alpha', 'Spontaneous Fission', 'Neutron', 'Gamma'],
    emissionEnergies: {
      alpha: ['6.118 MeV'],
      beta: [],
      gamma: ['~0.1-6 MeV (complex spectrum from fission)']
    },
    halfLife: '2.645 years',
    decayConstant: '0.262 year⁻¹',
    specificActivity: '2.0 x 10^13 Bq/g',
    parent: 'Curium-252',
    daughter: 'Curium-248 (α), Fission products',
    commonUses: ['Neutron source (neutron activation analysis)', 'Tumor treatment', 'Reactor startup', 'Well logging'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A powerful and widely used spontaneous fission neutron source for various industrial and medical applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.1,
      A2: 0.003,
      unit: 'TBq'
    },
    dValue: 0.02,
    dosimetry: {
      ALI: {
        ingestion: 2,
        inhalation_W: 0.02,
        inhalation_Y: 0.03
      },
      DAC: {
        inhalation_W: 8e-12,
        inhalation_Y: 1e-11
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 3.70e-5,
        inhalation_Y: 4.24e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Carbon-11',
    symbol: 'C-11',
    emissionType: ['Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['0.960 MeV (max)'],
      gamma: ['0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.320 MeV',
    halfLife: '20.36 minutes',
    decayConstant: '0.0340 min⁻¹',
    specificActivity: '1.9 x 10^18 Bq/g',
    parent: 'Boron-11 (p,n)',
    daughter: 'Boron-11 (stable)',
    commonUses: ['PET imaging for various tracers (e.g., methionine for tumors)'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 400000,
        inhalation_D: 400000
      },
      DAC: {
        inhalation_D: 2e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Carbon-14',
    symbol: 'C-14',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.156 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.052 MeV',
    halfLife: '5730 years',
    decayConstant: '1.21 x 10⁻⁴ year⁻¹',
    specificActivity: '1.65 x 10^11 Bq/g',
    parent: 'Nitrogen-14 (n,p)',
    daughter: 'Nitrogen-14 (stable)',
    commonUses: ['Radiometric dating (archeology, geology)', 'Tracers in biological and chemical research', 'Labeled compounds'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'Famously used for radiocarbon dating and as a tracer in countless biological and chemical research labs.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 3,
      unit: 'TBq'
    },
    dValue: 50,
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 2000, // Updated from generic 'inhalation' to 'W' (Compounds) for better matching
        inhalation_Vapor: 2000
      },
      DAC: {
        inhalation_W: 1e-6,
        inhalation_Vapor: 1e-6
      },
      DCF: {
        ingestion: 0, // Organic compounds
        inhalation_W: 7.83e-13, // Particulate
        inhalation_Vapor: 6.36e-12 // CO2
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_low_risk'
  },
   {
    name: 'Cerium-141',
    symbol: 'Ce-141',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.581 MeV (max)'],
      gamma: ['0.145 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.194 MeV',
    halfLife: '32.5 days',
    decayConstant: '0.0213 day⁻¹',
    specificActivity: '1.09 x 10^15 Bq/g',
    parent: 'Lanthanum-141',
    daughter: 'Praseodymium-141 (stable)',
    commonUses: ['Fission product', 'Medical research (historical)', 'Environmental tracer'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fission product with limited use outside of specialized research applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 20,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 700,
        inhalation_Y: 600
      },
      DAC: {
        inhalation_W: 3e-7,
        inhalation_Y: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.25e-9,
        inhalation_Y: 2.42e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Cerium-144',
    symbol: 'Ce-144',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.319 MeV (max)'],
      gamma: ['0.133 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.106 MeV',
    daughterEmissions: {
      from: 'Pr-144',
      beta: ['2.997 MeV (max)']
    },
    halfLife: '284.9 days',
    decayConstant: '0.00243 day⁻¹',
    specificActivity: '1.18 x 10^14 Bq/g',
    parent: 'Lanthanum-144',
    daughter: 'Praseodymium-144 (β-)',
    commonUses: ['Fission product', 'Environmental tracer'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fission product with limited use outside of specialized research applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.2,
      A2: 0.2,
      unit: 'TBq'
    },
     dValue: 0.4,
    dosimetry: {
      ALI: {
        ingestion: 200,
        inhalation_W: 30,
        inhalation_Y: 10
      },
      DAC: {
        inhalation_W: 1e-8,
        inhalation_Y: 6e-9
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 5.84e-8,
        inhalation_Y: 1.01e-7
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },

  {
    name: 'Cesium-134',
    symbol: 'Cs-134',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.658 MeV (max)'],
      gamma: ['0.605 MeV', '0.796 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.219 MeV',
    halfLife: '2.065 years',
    decayConstant: '0.335 year⁻¹',
    specificActivity: '4.8 x 10^13 Bq/g',
    parent: 'Cesium-133 (n,γ)',
    daughter: 'Barium-134 (stable)',
    commonUses: ['Environmental tracer (fallout)', 'Calibration sources'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'An activation product often seen alongside Cs-137 after reactor incidents, used as a tracer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.04,
    shipping: {
      A1: 0.7,
      A2: 0.7,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 70,
        inhalation_D: 100
      },
      DAC: {
        inhalation_D: 4e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.25e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Cesium-137',
    symbol: 'Cs-137',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.512 MeV (max, 94.6%)', '1.174 MeV (max, 5.4%)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.171 MeV',
    daughterEmissions: {
      from: 'Ba-137m',
      gamma: ['0.662 MeV']
    },
    halfLife: '30.08 years',
    decayConstant: '0.0230 year⁻¹',
    gammaConstant: '0.382 R·m²/hr·Ci',
    sourceRef: {
    halfLife: 'nndc',
    gammaConstant: 'plexus_nsd'
    },
    dValue: 0.1,
    specificActivity: '3.21 x 10^12 Bq/g',
    parent: 'Uranium Fission',
    daughter: 'Barium-137m (IT) -> Barium-137 (stable)',
    commonUses: ['Calibration sources', 'Industrial gauges (density, level)', 'Blood irradiators', 'Radiotherapy (historical)'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'A major fission product and one of the most common gamma sources for industrial gauging and calibration.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 2,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 100,
        inhalation_D: 200
      },
      DAC: {
        inhalation_D: 6e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.63e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Chlorine-36',
    symbol: 'Cl-36',
    emissionType: ['Beta-minus', 'Electron Capture'],
    emissionEnergies: {
      beta: ['0.709 MeV (max, 98%)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.251 MeV',
    halfLife: '301,000 years',
    decayConstant: '2.30 x 10⁻⁶ year⁻¹',
    specificActivity: '1.2 x 10^9 Bq/g',
    parent: 'Chlorine-35 (n,γ)',
    daughter: 'Argon-36 (stable) or Sulfur-36 (stable)',
    commonUses: ['Beta calibration standard', 'Geological dating'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'The standard long-lived reference source for calibrating beta detectors.',
    sourceRef: { halfLife: 'nndc' },
    shipping: { A1: 40, A2: 0.6, unit: 'TBq' },
    dValue: 20, // IAEA EPR-D-Values
    dosimetry: {
      ALI: { ingestion: 2000, inhalation_W: 200 },
      DAC: { inhalation_W: 1e-7 },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_low_risk'
  },
{
  name: 'Cobalt-57',
  symbol: 'Co-57',
  emissionType: ['Electron Capture', 'Gamma'],
  emissionEnergies: {
    beta: [],
    gamma: ['0.122 MeV', '0.136 MeV'],
    alpha: []
  },
  halfLife: '271.79 days',
  decayConstant: '0.00255 day⁻¹',
  specificActivity: '3.12e14 Bq/g',
  parent: 'Nickel-57',
  daughter: 'Iron-57 (stable)',
  commonUses: ['Check sources', 'Medical diagnostics (historical)'],
  category: 'Industrial',
  commonality: 'Common',
  sourceRef: { halfLife: 'nndc' },
  gammaConstant: '0.09 R·m²/hr·Ci' 
},
  {
    name: 'Cobalt-60',
    symbol: 'Co-60',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.318 MeV (max)'],
      gamma: ['1.173 MeV', '1.332 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.106 MeV',
    halfLife: '5.27 years',
    decayConstant: '0.131 year⁻¹',
    gammaConstant: '1.32 R·m²/hr·Ci',
    sourceRef: {
    halfLife: 'nndc',
    gammaConstant: 'plexus_nsd'
    },
    dValue: 0.03,
    specificActivity: '4.18 x 10^13 Bq/g',
    parent: 'Cobalt-59 (n,γ)',
    daughter: 'Nickel-60 (stable)',
    commonUses: ['Industrial radiography', 'Sterilization of medical equipment and food', 'Radiotherapy (external beam)', 'Tracers'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'Widely used for industrial radiography, medical equipment sterilization, and cancer therapy.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
shipping: { A1: 0.4, A2: 0.4, unit: 'TBq' },
    dosimetry: {
      ALI: {
        ingestion: 200,
        inhalation_W: 200,
        inhalation_Y: 30
      },
      DAC: {
        inhalation_W: 7e-8,
        inhalation_Y: 1e-8
      },
      DCF: {
        ingestion: 0, // Oxide
        inhalation_W: 8.94e-9,
        inhalation_Y: 5.91e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Copper-64',
    symbol: 'Cu-64',
    emissionType: ['Positron Emission', 'Beta-minus', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['0.653 MeV (β+ max)', '0.579 MeV (β- max)'],
      gamma: ['1.345 MeV', '0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.193 MeV (β-)',
    halfLife: '12.7 hours',
    decayConstant: '0.0546 hour⁻¹',
    specificActivity: '1.74 x 10^17 Bq/g',
    parent: 'Nickel-64 (p,n)',
    daughter: 'Nickel-64 (stable) or Zinc-64 (stable)',
    commonUses: ['PET imaging (various applications)', 'Targeted radionuclide therapy research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A versatile medical isotope for PET imaging and therapy research, but not as widespread as F-18.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 6,
      A2: 1,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 10000,
        inhalation_D: 30000,
        inhalation_W: 20000,
        inhalation_Y: 20000
      },
      DAC: {
        inhalation_D: 1e-5,
        inhalation_W: 1e-5,
        inhalation_Y: 9e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.29e-11,
        inhalation_W: 6.93e-11,
        inhalation_Y: 7.48e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Copper-67',
    symbol: 'Cu-67',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.576 MeV (max)'],
      gamma: ['0.185 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.192 MeV',
    halfLife: '61.83 hours',
    decayConstant: '0.0112 hour⁻¹',
    specificActivity: '1.2 x 10^16 Bq/g',
    parent: 'Zinc-67 (n,p)',
    daughter: 'Zinc-67 (stable)',
    commonUses: ['Radioimmunotherapy, theranostic partner for Copper-64 PET imaging.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A research isotope for targeted therapy, valued as a "theranostic" partner to the PET isotope Cu-64.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.7,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 5000,
        inhalation_D: 8000,
        inhalation_W: 5000,
        inhalation_Y: 5000
      },
      DAC: {
        inhalation_D: 3e-6,
        inhalation_W: 2e-6,
        inhalation_Y: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.83e-10,
        inhalation_W: 3.15e-10,
        inhalation_Y: 3.32e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Curium-244',
    symbol: 'Cm-244',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.805 MeV'],
      gamma: ['0.043 MeV'],
      beta: []
    },
    halfLife: '18.1 years',
    decayConstant: '0.0383 year⁻¹',
    specificActivity: '3.0 x 10^12 Bq/g',
    parent: 'Americium-244 (β-)',
    daughter: 'Plutonium-240',
    commonUses: ['Alpha particle X-ray spectrometers (APXS) for space exploration', 'Neutron sources'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'Used in specialized applications like space exploration instruments due to its alpha emissions.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.05,
    shipping: {
      A1: 20,
      A2: 0.002,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 1, // Bone Surface 2
        inhalation_W: 0.01
      },
      DAC: {
        inhalation_W: 5e-12
      },
      DCF: {
        ingestion: 1.20e-7,
        inhalation_W: 6.70e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Erbium-169',
    symbol: 'Er-169',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.341 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.114 MeV',
    halfLife: '9.4 days',
    decayConstant: '0.0737 day⁻¹',
    specificActivity: '5.2 x 10^14 Bq/g',
    parent: 'Erbium-168 (n,γ)',
    daughter: 'Thulium-169 (stable)',
    commonUses: ['Radiation synovectomy for arthritis treatment.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used for a specific medical therapy (radiation synovectomy) that is not widely performed.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 1,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 3000,
        inhalation_W: 3000
      },
      DAC: {
        inhalation_W: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 5.64e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Europium-152',
    symbol: 'Eu-152',
    emissionType: ['Beta-minus', 'Electron Capture', 'Positron Emission', 'Gamma'],
    emissionEnergies: {
  beta: ['1.48 MeV (max)'],
  gamma: ['0.122 MeV', '0.344 MeV', '0.779 MeV', '0.964 MeV', '1.112 MeV', '1.408 MeV'], // Added middle energies
  alpha: []
},
    avgBetaEnergy: '0.493 MeV',
    halfLife: '13.54 years',
    decayConstant: '0.0512 year⁻¹',
    specificActivity: '6.4 x 10^12 Bq/g',
    parent: 'Samarium-152 (n,γ)',
    daughter: 'Samarium-152 (stable) or Gadolinium-152 (stable)',
    commonUses: ['Calibration sources for gamma spectroscopy', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived, multi-gamma emitting source excellent for calibration, but less common than Co-60 or Ba-133.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 1,
      unit: 'TBq'
    },
     dValue: 0.06,
   gammaConstant: '0.74444 R·m²/hr·Ci',
    sourceRef: {
    halfLife: 'nndc',
    gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 800,
        inhalation_W: 20
      },
      DAC: {
        inhalation_W: 1e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 5.97e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Europium-154',
    symbol: 'Eu-154',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.85 MeV (max)'],
      gamma: ['1.274 MeV', '0.723 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.617 MeV',
    halfLife: '8.59 years',
    decayConstant: '0.0807 year⁻¹',
    specificActivity: '9.8 x 10^12 Bq/g',
    parent: 'Samarium-154 (n,γ)',
    daughter: 'Gadolinium-154 (stable)',
    commonUses: ['Environmental monitoring (fission product)', 'Calibration sources'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived fission product sometimes used for gamma calibration.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.9,
      A2: 0.6,
      unit: 'TBq'
    },
    dValue: 0.06,
    gammaConstant: '0.75554 R·m²/hr·Ci',
    sourceRef: {
    halfLife: 'nndc',
    gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 500,
        inhalation_W: 20
      },
      DAC: {
        inhalation_W: 8e-9
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 7.73e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Fluorine-18',
    symbol: 'F-18',
    emissionType: ['Positron Emission', 'Annihilation Photons'],
    emissionEnergies: {
      beta: ['0.634 MeV (max)'],
      gamma: ['0.511 MeV (200% yield)'], // Crucial detail
      alpha: []
    },
    avgBetaEnergy: '0.250 MeV',
    halfLife: '109.77 minutes',
    decayConstant: '0.006315 min⁻¹',
    specificActivity: '3.52 x 10^18 Bq/g',
    // Gamma Constant: ~5.7 R-cm2/mCi-hr  =>  0.57 R-m2/Ci-hr
    gammaConstant: '0.57 R·m²/hr·Ci', 
    parent: 'Oxygen-18 (p,n)',
    daughter: 'Oxygen-18 (stable)',
    commonUses: ['PET imaging (FDG)', 'Bone scans (NaF)'],
    category: 'Medical',
    commonality: 'Common',
    commonalityReason: 'The standard workhorse isotope for PET imaging.',
    sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' },
    shipping: { A1: 1, A2: 0.6, unit: 'TBq' },
    // 10 CFR 20 Appendix B values
    dosimetry: {
        ALI: { ingestion: 50000, inhalation_D: 70000, inhalation_W: 90000, inhalation_Y: 80000 },
        DAC: { inhalation_D: 3e-5, inhalation_W: 4e-5, inhalation_Y: 3e-5 },
        sourceRef: '10CFR20'
    }
},
  {
    name: 'Fluorine-19',
    symbol: 'F-19',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Stable',
    daughter: 'Stable',
    commonUses: ['NMR', 'Fluorinated compounds (not a radionuclide use)'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Gadolinium-153',
    symbol: 'Gd-153',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.097 MeV', '0.103 MeV'],
      alpha: []
    },
    halfLife: '240.4 days',
    decayConstant: '0.00288 day⁻¹',
    specificActivity: '1.3 x 10^14 Bq/g',
    parent: 'Europium-153 (n,γ)',
    daughter: 'Europium-153 (stable)',
    commonUses: ['Bone densitometry', 'X-ray absorption measurements', 'Calibration sources'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A key source used in dual-photon absorptiometry for bone density scanning.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 9,
      unit: 'TBq'
    },
    dValue: 1,
    gammaConstant: '0.172383 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 5000,
        inhalation_D: 100,
        inhalation_W: 600
      },
      DAC: {
        inhalation_D: 6e-8,
        inhalation_W: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.434e-9,
        inhalation_W: 2.56e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Gadolinium-159',
    symbol: 'Gd-159',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.970 MeV (max)'],
      gamma: ['0.363 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.323 MeV',
    halfLife: '18.48 hours',
    decayConstant: '0.0375 hour⁻¹',
    specificActivity: '3.6 x 10^16 Bq/g',
    parent: 'Europium-159',
    daughter: 'Terbium-159 (stable)',
    commonUses: ['Boron Neutron Capture Therapy (BNCT) research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A short-lived isotope used in specialized medical therapy research (BNCT).',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 3,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 3000,
        inhalation_D: 8000,
        inhalation_W: 6000
      },
      DAC: {
        inhalation_D: 3e-6,
        inhalation_W: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.81e-10,
        inhalation_W: 2.64e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Gallium-67',
    symbol: 'Ga-67',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.093 MeV', '0.185 MeV', '0.300 MeV'],
      alpha: []
    },
    halfLife: '3.26 days',
    decayConstant: '0.213 day⁻¹',
    specificActivity: '3.8 x 10^15 Bq/g',
    parent: 'Zinc-67 (p,n)',
    daughter: 'Zinc-67 (stable)',
    commonUses: ['Tumor imaging (lymphomas, lung cancer)', 'Infection imaging', 'Inflammation imaging'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A standard SPECT imaging agent for detecting tumors and inflammation.',
    sourceRef: {
      halfLife: 'nndc'
    },
    gammaConstant: '0.11 R·m²/hr·Ci',
    dValue: 0.3,
    shipping: {
      A1: 7,
      A2: 3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 7000,
        inhalation_D: 10000,
        inhalation_W: 10000
      },
      DAC: {
        inhalation_D: 6e-6,
        inhalation_W: 4e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 9.50e-11,
        inhalation_W: 1.1e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Gallium-68',
    symbol: 'Ga-68',
    emissionType: ['Positron Emission', 'Annihilation Photons'],
    emissionEnergies: {
      beta: ['1.90 MeV (max)'],
      gamma: ['0.511 MeV (178% yield)', '1.077 MeV (3%)'],
      alpha: []
    },
    avgBetaEnergy: '0.830 MeV',
    halfLife: '67.71 minutes',
    decayConstant: '0.0102 min⁻¹',
    specificActivity: '1.51 x 10^18 Bq/g',
    // Gamma Constant: ~5.4 R-cm2/mCi-hr => 0.54 R-m2/Ci-hr
    gammaConstant: '0.54 R·m²/hr·Ci',
    parent: 'Germanium-68',
    daughter: 'Zinc-68 (stable)',
    commonUses: ['PET imaging (Neuroendocrine tumors)', 'Prostate cancer imaging (PSMA)'],
    category: 'Medical',
    commonality: 'Common',
    sourceRef: { halfLife: 'nndc', gammaConstant: 'hps' },
    shipping: { A1: 0.5, A2: 0.5, unit: 'TBq' },
    dosimetry: {
        ALI: { ingestion: 20000, inhalation_D: 40000, inhalation_W: 50000 },
        DAC: { inhalation_D: 2e-5, inhalation_W: 2e-5 },
        sourceRef: '10CFR20'
    }
},
  {
    name: 'Germanium-68',
    symbol: 'Ge-68',
    emissionType: ['Electron Capture', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    daughterEmissions: {
      from: 'Ga-68',
      beta: ['1.90 MeV (max)'],
      gamma: ['0.511 MeV (annihilation)']
    },
    halfLife: '270.95 days',
    decayConstant: '0.00256 day⁻¹',
    specificActivity: '2.8 x 10^14 Bq/g',
    parent: 'Arsenic-68',
    daughter: 'Gallium-68 (EC, β+)',
    commonUses: ['Generator for Ga-68 (PET imaging)'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'The long-lived parent used in generators to produce the short-lived PET isotope Ga-68.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.007,
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 5000,
        inhalation_D: 4000,
        inhalation_W: 100
      },
      DAC: {
        inhalation_D: 2e-6,
        inhalation_W: 4e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 4.49e-10,
        inhalation_W: 1.40e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Gold-195m',
    symbol: 'Au-195m',
    emissionType: ['Isomeric Transition', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.262 MeV'],
      alpha: []
    },
    halfLife: '30.5 seconds',
    decayConstant: '0.0227 s⁻¹',
    specificActivity: '1.5 x 10^18 Bq/g',
    parent: 'Mercury-195m',
    daughter: 'Gold-195',
    commonUses: ['Cardiac blood flow imaging (historical)'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used historically in medicine but has been replaced by other isotopes.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: { ingestion: 50000, inhalation_D: 100000, inhalation_W: 1000, inhalation_Y: 400 },
      DAC: { inhalation_D: 5e-6, inhalation_W: 6e-7, inhalation_D: 2e-7 },
      sourceRef: 'Estimated'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Gold-198',
    symbol: 'Au-198',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.961 MeV (max)'],
      gamma: ['0.412 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.320 MeV',
    halfLife: '2.695 days',
    decayConstant: '0.257 day⁻¹',
    specificActivity: '9.3 x 10^15 Bq/g',
    parent: 'Gold-197 (n,γ)',
    daughter: 'Mercury-198 (stable)',
    commonUses: ['Radiotherapy (brachytherapy)', 'Tracers', 'Industrial applications'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'Used in specific brachytherapy applications and as an industrial tracer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 0.6,
      unit: 'TBq'
    },
    gammaConstant: '0.291634 R·m²/hr·Ci',
    dValue: 0.2,
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 1000,
        inhalation_D: 4000,
        inhalation_W: 2000,
        inhalation_Y: 2000
      },
      DAC: {
        inhalation_D: 2e-6,
        inhalation_W: 8e-7,
        inhalation_Y: 7e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.87e-10,
        inhalation_W: 8.20e-10,
        inhalation_Y: 8.87e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Holmium-166',
    symbol: 'Ho-166',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.854 MeV (max)'],
      gamma: ['0.080 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.618 MeV',
    halfLife: '26.8 hours',
    decayConstant: '0.0258 hour⁻¹',
    specificActivity: '2.5 x 10^16 Bq/g',
    parent: 'Holmium-165 (n,γ)',
    daughter: 'Erbium-166 (stable)',
    commonUses: ['Radiotherapy for liver tumors, bone pain palliation, radiosynovectomy.'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A therapeutic isotope used for treating liver tumors and for bone pain palliation.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.4,
      A2: 0.4,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 900,
        inhalation_W: 2000
      },
      DAC: {
        inhalation_W: 7e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 8.48e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Indium-111',
    symbol: 'In-111',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.171 MeV', '0.245 MeV'],
      alpha: []
    },
    gammaConstant: '0.33 R·m²/hr·Ci',
    dValue: 0.3,
    halfLife: '2.80 days',
    decayConstant: '0.247 day⁻¹',
    specificActivity: '2.6 x 10^16 Bq/g',
    parent: 'Cadmium-111 (p,n)',
    daughter: 'Cadmium-111 (stable)',
    commonUses: ['White blood cell labeling (infection imaging)', 'Tumor imaging', 'CSF flow studies'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A standard SPECT imaging agent, particularly for labeling white blood cells to find infections.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 3,
      A2: 3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_D: 6000,
        inhalation_W: 6000
      },
      DAC: {
        inhalation_D: 3e-6,
        inhalation_W: 3e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.92e-11,
        inhalation_W: 2.09e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Indium-113m',
    symbol: 'In-113m',
    emissionType: ['Isomeric Transition', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.392 MeV'],
      alpha: []
    },
    halfLife: '1.658 hours',
    decayConstant: '0.418 hour⁻¹',
    specificActivity: '4.1 x 10^17 Bq/g',
    parent: 'Tin-113',
    daughter: 'Indium-113 (stable)',
    commonUses: ['Medical diagnostic imaging (historical)'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used historically in medicine but has been replaced by other isotopes like Tc-99m.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 4,
      A2: 2,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 50000,
        inhalation_D: 100000,
        inhalation_W: 200000
      },
      DAC: {
        inhalation_D: 6e-5,
        inhalation_W: 8e-5
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.11e-11,
        inhalation_W: 9.04e-12
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Indium-115',
    symbol: 'In-115',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.499 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.166 MeV',
    halfLife: '441000000000000 years',
    decayConstant: '1.57 x 10⁻¹⁵ year⁻¹',
    specificActivity: '0.26 Bq/g',
    parent: 'Primordial',
    daughter: 'Tin-115 (stable)',
    commonUses: ['Neutrino mass experiments', 'Research (extremely weak activity)'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A primordial isotope with an extremely long half-life, used in fundamental physics research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    dosimetry: {
      ALI: { ingestion: 40, inhalation_D: 1, inhalation_W: 5 }, // Values for In-115m often used, but for stable/long-lived, usually treated as chemical toxicity or generic.
      DAC: { inhalation_D: 6e-10, inhalation_W: 2e-9 },
      DCF: {
          ingestion: 0,
          inhalation_D: 1.01e-6,
          inhalation_W: 2.76e-7
      },
      sourceRef: '10CFR20 (Conservative)'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Iodine-123',
    symbol: 'I-123',
    emissionType: ['Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.159 MeV'],
      alpha: []
    },
    halfLife: '13.22 hours',
    decayConstant: '0.0524 hour⁻¹',
    specificActivity: '7.4 x 10^16 Bq/g',
    parent: 'Xenon-123',
    daughter: 'Tellurium-123 (stable)',
    commonUses: ['SPECT imaging for thyroid function and tumors', 'Cardiac and neurological imaging'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'An ideal isotope for thyroid imaging (SPECT) due to its short half-life and clean gamma emission.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 6,
      A2: 3,
      unit: 'TBq'
    },
    gammaConstant: '0.16 R·m²/hr·Ci',
    dValue: 0.2,
    dosimetry: {
      ALI: {
        ingestion: 3000,
        inhalation_D: 6000
      },
      DAC: {
        inhalation_D: 3e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.01e-11
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Iodine-125',
    symbol: 'I-125',
    emissionType: ['Electron Capture', 'X-ray', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.0355 MeV'],
      alpha: []
    },
    halfLife: '59.4 days',
    decayConstant: '0.0117 day⁻¹',
    specificActivity: '6.4 x 10^14 Bq/g',
    parent: 'Xenon-125',
    daughter: 'Tellurium-125 (stable)',
    commonUses: ['Brachytherapy (prostate cancer)', 'Radioimmunoassay', 'Bone mineral density (historical)'],
    category: 'Medical',
    commonality: 'Common',
    commonalityReason: 'Widely used in permanent brachytherapy seeds for prostate cancer and in laboratory radioimmunoassays.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 20,
      A2: 3,
      unit: 'TBq'
    },
    dValue: 0.2,
    gammaConstant: '0.274984 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 40,
        inhalation_D: 60
      },
      DAC: {
        inhalation_D: 3e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.53e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Iodine-129',
    symbol: 'I-129',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.154 MeV (max)'],
      gamma: ['0.039 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.051 MeV',
    halfLife: '16.1 million years',
    decayConstant: '4.31 x 10⁻⁸ year⁻¹',
    specificActivity: '6.54 x 10^6 Bq/g',
    parent: 'Tellurium-129 (β-)',
    daughter: 'Xenon-129 (stable)',
    commonUses: ['Environmental tracer (long-lived fission product)', 'Geological dating'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'An extremely long-lived fission product used as a tracer in environmental and geological studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.0,
    shipping: {
      A1: 'unlimited',
      A2: 'unlimited',
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 5,
        inhalation_D: 9
      },
      DAC: {
        inhalation_D: 4e-9
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 4.69e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Iodine-131',
    symbol: 'I-131',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
  beta: ['0.606 MeV (max)'],
  gamma: ['0.364 MeV (dominant)', '0.637 MeV', '0.284 MeV'], // Added 637 and 284
  alpha: []
},
    avgBetaEnergy: '0.202 MeV',
    halfLife: '8.02 days',
    decayConstant: '0.0864 day⁻¹',
    gammaConstant: '0.22 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      decayConstant: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    specificActivity: '4.6 x 10^15 Bq/g',
    parent: 'Tellurium-131',
    daughter: 'Xenon-131 (stable)',
    commonUses: ['Diagnosis and treatment of thyroid cancer and hyperthyroidism', 'Medical imaging (diagnostic tracer)'],
    category: 'Medical',
    commonality: 'Common',
    commonalityReason: 'A key radioisotope for the diagnosis and, at higher activities, the treatment of thyroid conditions.',
    sourceRef: {
      halfLife: 'nndc',
      decayConstant: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 3,
      A2: 0.7,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 30,
        inhalation_D: 50
      },
      DAC: {
        inhalation_D: 2e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.89e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'sr_90',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Iridium-192',
    symbol: 'Ir-192',
    emissionType: ['Beta-minus', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['0.672 MeV (max)'],
      gamma: ['0.317 MeV', '0.468 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.224 MeV',
    halfLife: '73.83 days',
    decayConstant: '0.00939 day⁻¹',
    gammaConstant: '0.48 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dValue: 0.08,
    specificActivity: '3.41 x 10^14 Bq/g',
    parent: 'Iridium-191 (n,γ)',
    daughter: 'Platinum-192 (stable) / Osmium-192 (stable)',
    commonUses: ['High-dose-rate (HDR) brachytherapy', 'Industrial gamma radiography'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A primary source for industrial radiography and high-dose-rate (HDR) brachytherapy cancer treatment.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 1,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 900,
        inhalation_D: 300,
        inhalation_W: 400,
        inhalation_Y: 200
      },
      DAC: {
        inhalation_D: 1e-7,
        inhalation_W: 2e-7,
        inhalation_Y: 9e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.1e-9,
        inhalation_W: 4.88e-9,
        inhalation_Y: 7.61e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Iron-52',
    symbol: 'Fe-52',
    emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['0.804 MeV (max)'],
      gamma: ['0.169 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.268 MeV',
    halfLife: '8.275 hours',
    decayConstant: '0.0838 hour⁻¹',
    specificActivity: '1.2 x 10^17 Bq/g',
    parent: 'Manganese-52m',
    daughter: 'Manganese-52',
    commonUses: ['PET imaging research (bone marrow imaging, iron metabolism)'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A short-lived PET isotope used in specialized research to study iron metabolism and bone marrow.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.3,
      A2: 0.3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 900,
        inhalation_D: 3000,
        inhalation_W: 2000
      },
      DAC: {
        inhalation_D: 1e-6,
        inhalation_W: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.13e-10,
        inhalation_W: 5.92e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Iron-55',
    symbol: 'Fe-55',
    emissionType: ['Electron Capture', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.0059 MeV (X-ray)'],
      alpha: []
    },
    halfLife: '2.73 years',
    decayConstant: '0.254 year⁻¹',
    specificActivity: '8.4 x 10^13 Bq/g',
    parent: 'Manganese-55 (p,n)',
    daughter: 'Manganese-55 (stable)',
    commonUses: ['X-ray fluorescence sources', 'Electron capture detectors', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'Used as a low-energy X-ray source for analytical techniques like X-ray fluorescence.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 40,
      unit: 'TBq'
    },
    dValue: 800,
    dosimetry: {
      ALI: {
        ingestion: 9000,
        inhalation_D: 2000,
        inhalation_W: 4000
      },
      DAC: {
        inhalation_D: 8e-7,
        inhalation_W: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 7.26e-10,
        inhalation_W: 3.61e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Iron-59',
    symbol: 'Fe-59',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.475 MeV (max)'],
      gamma: ['1.099 MeV', '1.292 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.158 MeV',
    halfLife: '44.5 days',
    decayConstant: '0.0156 day⁻¹',
    specificActivity: '1.87 x 10^15 Bq/g',
    parent: 'Iron-58 (n,γ)',
    daughter: 'Cobalt-59 (stable)',
    commonUses: ['Red blood cell studies', 'Iron metabolism research', 'Industrial tracers'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A gamma-emitting tracer used in medical research to study iron metabolism and red blood cells.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.9,
      A2: 0.9,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 800,
        inhalation_D: 300,
        inhalation_W: 500
      },
      DAC: {
        inhalation_D: 1e-7,
        inhalation_W: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 4.00e-9,
        inhalation_W: 3.30e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Krypton-79',
    symbol: 'Kr-79',
    emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['0.604 MeV (max)'],
      gamma: ['0.261 MeV', '0.398 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.201 MeV',
    halfLife: '35.04 hours',
    decayConstant: '0.0198 hour⁻¹',
    specificActivity: '1.7 x 10^16 Bq/g',
    parent: 'Bromine-79',
    daughter: 'Bromine-79 (stable)',
    commonUses: ['Lung ventilation studies (PET)', 'Research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used in medical research, particularly for PET-based lung ventilation studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 4,
      A2: 2,
      unit: 'TBq'
    },
    dosimetry: {
      DAC: { inhalation: 2e-5 }, // Submersion
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Krypton-81m',
    symbol: 'Kr-81m',
    emissionType: ['Gamma', 'Isomeric Transition'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.190 MeV'],
      alpha: []
    },
    halfLife: '13.1 seconds',
    decayConstant: '0.0529 s⁻¹',
    specificActivity: '4.85 x 10^18 Bq/g',
    parent: 'Rubidium-81',
    daughter: 'Krypton-81',
    commonUses: ['Lung ventilation studies (very short half-life allows for repeated scans)'],
    category: 'Medical',
    commonality: 'Common',
    commonalityReason: 'A very short-lived gas used for lung ventilation scans, typically produced from a Rb-81 generator.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 40,
      unit: 'TBq'
    },
    dosimetry: {
      DAC: { inhalation: 7e-4 }, // Submersion
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Krypton-85',
    symbol: 'Kr-85',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.687 MeV (max)'],
      gamma: ['0.514 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.229 MeV',
    halfLife: '10.76 years',
    decayConstant: '0.0644 year⁻¹',
    specificActivity: '1.45 x 10^13 Bq/g',
    parent: 'Uranium Fission',
    daughter: 'Rubidium-85 (stable)',
    commonUses: ['Atmospheric tracer', 'Industrial applications (leak detection, gauging)'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A fission product gas used in industrial applications like leak detection and thickness gauging.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 10,
      unit: 'TBq'
    },
    dValue: 30,
    dosimetry: {
      DAC: { inhalation: 1e-4 }, // Submersion
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Lanthanum-140',
    symbol: 'La-140',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.68 MeV (max)'],
      gamma: ['1.596 MeV', '0.816 MeV', '0.487 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.560 MeV',
    halfLife: '1.678 days',
    decayConstant: '0.413 day⁻¹',
    specificActivity: '2.07 x 10^16 Bq/g',
    parent: 'Barium-140',
    daughter: 'Cerium-140 (stable)',
    commonUses: ['Fission product', 'Research tracer'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A short-lived fission product used as a tracer in research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.4,
      A2: 0.4,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 600,
        inhalation_D: 1000,
        inhalation_W: 1000
      },
      DAC: {
        inhalation_D: 6e-7,
        inhalation_W: 5e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 9.33e-10,
        inhalation_W: 1.31e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Lead-206',
    symbol: 'Pb-206',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Polonium-210',
    daughter: 'Stable',
    commonUses: ['Final stable product of U-238 decay series', 'Geological dating'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Lead-207',
    symbol: 'Pb-207',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Polonium-211',
    daughter: 'Stable',
    commonUses: ['Final stable product of U-235 decay series', 'Geological dating'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Lead-208',
    symbol: 'Pb-208',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Thallium-208',
    daughter: 'Stable',
    commonUses: ['Final stable product of Th-232 decay series', 'Geological dating'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Lead-210',
    symbol: 'Pb-210',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.063 MeV (max)'],
      gamma: ['0.0465 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.021 MeV',
    daughterEmissions: {
      from: 'Bi-210',
      beta: ['1.16 MeV (max)']
    },
    halfLife: '22.23 years',
    decayConstant: '0.0312 year⁻¹',
    specificActivity: '2.8 x 10^12 Bq/g',
    parent: 'Polonium-214 (α)',
    daughter: 'Bismuth-210 (β-)',
    commonUses: ['Environmental tracers', 'Dating sediments and ice cores', 'Bone dosimetry'],
    category: 'Natural',
    commonality: 'Common',
    commonalityReason: 'A naturally occurring radionuclide from the U-238 series, widely used for dating recent sediments and ice cores.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 0.05,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 0.6,
        inhalation_D: 0.2
      },
      DAC: {
        inhalation_D: 1e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.67e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Lead-211',
    emissionType: ['Beta-minus', 'Gamma'],
    symbol: 'Pb-211',
    emissionEnergies: {
      beta: ['1.36 MeV (max)'],
      gamma: ['0.405 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.453 MeV',
    halfLife: '36.1 minutes',
    decayConstant: '0.0192 min⁻¹',
    specificActivity: '2.0 x 10^17 Bq/g',
    parent: 'Polonium-215',
    daughter: 'Bismuth-211 (β-)',
    commonUses: ['Intermediate in Actinium-227 decay series'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    dosimetry: {
      ALI: {
        ingestion: 10000,
        inhalation_D: 600,
      },
      DAC: {
        inhalation_D: 3e-7,
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.35e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Lead-212',
    symbol: 'Pb-212',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.570 MeV (max)'],
      gamma: ['0.238 MeV', '0.300 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.190 MeV',
    daughterEmissions: {
      from: 'Bi-212',
      beta: ['2.25 MeV (max)'],
      alpha: ['6.09 MeV'],
      gamma: ['0.727 MeV', '1.621 MeV']
    },
    halfLife: '10.64 hours',
    decayConstant: '0.0651 hour⁻¹',
    specificActivity: '6.9 x 10^16 Bq/g',
    parent: 'Polonium-216 (α)',
    daughter: 'Bismuth-212 (β-)',
    commonUses: ['Intermediate in Thorium-232 decay series', 'Research'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A key intermediate in the Th-232 decay chain with a relatively long half-life compared to its daughters.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.7,
      A2: 0.2,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 80,
        inhalation_D: 30
      },
      DAC: {
        inhalation_D: 1e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 4.56e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Lead-214',
    symbol: 'Pb-214',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.02 MeV (max)'],
      gamma: ['0.295 MeV', '0.352 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.340 MeV',
    halfLife: '26.8 minutes',
    decayConstant: '0.0259 min⁻¹',
    specificActivity: '2.7 x 10^17 Bq/g',
    parent: 'Polonium-218 (α)',
    daughter: 'Bismuth-214 (β-)',
    commonUses: ['Intermediate in Radon-222 decay chain', 'Environmental monitoring'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A prominent gamma-emitter in the Radon-222 decay chain, contributing to natural background radiation.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    dosimetry: {
      ALI: {
        ingestion: 9000,
        inhalation_D: 800
        },
      DAC: {
        inhalation_D: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.11e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Lutetium-176',
    symbol: 'Lu-176',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.593 MeV (max)'],
      gamma: ['0.202 MeV', '0.307 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.198 MeV',
    halfLife: '37800000000 years',
    decayConstant: '1.83 x 10⁻¹¹ year⁻¹',
    specificActivity: '2.0 x 10^6 Bq/g',
    parent: 'Primordial',
    daughter: 'Hafnium-176 (stable)',
    commonUses: ['Lutetium-Hafnium dating (geological)', 'Research'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A very long-lived primordial nuclide used for geological dating.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    dosimetry: {
      ALI: { ingestion: 700, inhalation_W: 10, inhalation_Y: 8 },
      DAC: { inhalation_W: 2e-9, inhalation_Y: 3e-9 },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.36e-7,
        inhalation_Y: 1.79e-7
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Lutetium-177',
    symbol: 'Lu-177',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.498 MeV (max)'],
      gamma: ['0.113 MeV', '0.208 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.166 MeV',
    halfLife: '6.647 days',
    decayConstant: '0.104 day⁻¹',
    specificActivity: '3.9 x 10^14 Bq/g',
    parent: 'Ytterbium-176 (n,γ)',
    daughter: 'Hafnium-177 (stable)',
    commonUses: ['Peptide receptor radionuclide therapy (PRRT) for neuroendocrine tumors'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A highly effective and increasingly common therapeutic isotope for treating neuroendocrine tumors (PRRT).',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 30,
      A2: 0.7,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 2000,
        inhalation_Y: 2000
      },
      DAC: {
        inhalation_W: 9e-7,
        inhalation_Y: 9e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 6.63e-10,
        inhalation_Y: 6.63e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Manganese-54',
    symbol: 'Mn-54',
    emissionType: ['Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.835 MeV'],
      alpha: []
    },
    halfLife: '312.1 days',
    decayConstant: '0.00222 day⁻¹',
    gammaConstant: '0.51134 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    specificActivity: '2.56 x 10^14 Bq/g',
    parent: 'Iron-54 (d,2n)',
    daughter: 'Chromium-54 (stable)',
    commonUses: ['Calibration sources', 'Environmental tracer'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A common activation product used as a calibration source and environmental tracer.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 1,
      A2: 1,
      unit: 'TBq'
    },
    dValue: 1,
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 900,
        inhalation_W: 800
      },
      DAC: {
        inhalation_D: 4e-7,
        inhalation_W: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.42e-10,
        inhalation_W: 1.81e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Molybdenum-99',
    symbol: 'Mo-99',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.214 MeV (max)'],
      gamma: ['0.739 MeV', '0.181 MeV', '0.778 MeV'], // Added 778
      alpha: []
    },
    avgBetaEnergy: '0.405 MeV',
    daughterEmissions: {
      from: 'Tc-99m',
      gamma: ['0.1405 MeV']
    },
    halfLife: '65.94 hours',
    decayConstant: '0.0105 hour⁻¹',
    specificActivity: '1.77 x 10^16 Bq/g',
    parent: 'Uranium-235 Fission',
    daughter: 'Technetium-99m',
    commonUses: ['Generator for Technetium-99m, the most widely used medical radioisotope.'],
    category: 'Medical',
    commonality: 'Common',
    commonalityReason: 'The parent isotope used in generators to produce Tc-99m, making it essential to nuclear medicine.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 0.6,
      unit: 'TBq'
    },
    gammaConstant: '0.18 R·m²/hr·Ci', // CORRECTED from 0.11 (Source: Unger & Trubey)
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 3000,
        inhalation_Y: 1000
      },
      DAC: {
        inhalation_D: 1e-6,
        inhalation_Y: 6e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.42e-10,
        inhalation_Y: 1.07e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Neptunium-237',
    symbol: 'Np-237',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.788 MeV'],
      beta: [],
      gamma: ['0.029 MeV', '0.086 MeV']
    },
    halfLife: '2.144 million years',
    decayConstant: '3.23 x 10⁻⁷ year⁻¹',
    specificActivity: '2.6 x 10^7 Bq/g',
    parent: 'Americium-241 (α)',
    daughter: 'Protactinium-233 (α)',
    commonUses: ['Intermediate in Neptunium series decay', 'Nuclear waste studies'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived transuranic isotope that is a major consideration in nuclear waste management.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 20,
      A2: 0.002,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 0.5,
        inhalation_W: 0.004
      },
      DAC: {
        inhalation_W: 2e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.46e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
    {
    name: 'Nickel-56',
    symbol: 'Ni-56',
    emissionType: ['Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.158 MeV', '0.812 MeV'],
      alpha: []
    },
    halfLife: '6.075 days',
    decayConstant: '0.114 day⁻¹',
    specificActivity: '1.38 x 10^16 Bq/g',
    parent: 'Zinc-56',
    daughter: 'Cobalt-56',
    commonUses: ['Supernova studies (astrophysics)', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A short-lived isotope primarily of interest in astrophysical research related to supernovae.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
     },
    dosimetry: {
      ALI: {
        ingestion: 1000,
        inhalation_D: 2000,
        inhalation_W: 1000,
        inhalation_Vapor: 1000
      },
      DAC: {
        inhalation_D: 8e-7,
        inhalation_W: 5e-7,
        inhalation_Vapor: 5e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 7.11e-10,
        inhalation_W: 1.09e-10,
        inhalation_Vapor: 1.12e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Nickel-59',
    symbol: 'Ni-59',
    emissionType: ['Electron Capture', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: '76,000 years',
    decayConstant: '9.12 x 10⁻⁶ year⁻¹',
    specificActivity: '1.03 x 10^9 Bq/g',
    parent: 'Copper-59',
    daughter: 'Cobalt-59 (stable)',
    commonUses: ['Neutron activation product (long-lived)', 'Geological dating (historical)', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A very long-lived activation product relevant in nuclear reactor decommissioning.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 'unlimited',
      A2: 'unlimited',
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 20000,
        inhalation_D: 4000,
        inhalation_W: 7000,
        inhalation_Vapor: 2000
      },
      DAC: {
        inhalation_D: 2e-6,
        inhalation_W: 3e-6,
        inhalation_Vapor: 8e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.58e-10,
        inhalation_W: 2.48e-10,
        inhalation_Vapor: 7.31e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Nickel-63',
    symbol: 'Ni-63',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.0669 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.022 MeV',
    halfLife: '100.1 years',
    decayConstant: '0.00692 year⁻¹',
    specificActivity: '2.14 x 10^12 Bq/g',
    parent: 'Nickel-62 (n,γ)',
    daughter: 'Copper-63 (stable)',
    commonUses: ['Electron capture detectors (gas chromatography)', 'Beta-voltaic batteries'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A long-lived, low-energy beta emitter used in electron capture detectors for gas chromatographs.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 30,
      unit: 'TBq'
    },
    dValue: 60,
    dosimetry: {
      ALI: {
        ingestion: 9000,
        inhalation_D: 2000,
        inhalation_W: 3000,
        inhalation_Vapor: 800
      },
      DAC: {
        inhalation_D: 7e-7,
        inhalation_W: 1e-6,
        inhalation_Vapor: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.39e-10,
        inhalation_W: 6.22e-10,
        inhalation_Vapor: 1.70e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_low_risk'
  },
  {
    name: 'Niobium-95',
    symbol: 'Nb-95',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.160 MeV (max)'],
      gamma: ['0.766 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.053 MeV',
    halfLife: '34.99 days',
    decayConstant: '0.0198 day⁻¹',
    specificActivity: '1.6 x 10^15 Bq/g',
    parent: 'Zirconium-95',
    daughter: 'Molybdenum-95 (stable)',
    commonUses: ['Fission product', 'Environmental tracer (daughter of Zr-95)'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fission product usually found in equilibrium with its parent, Zr-95.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 1,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 1000,
        inhalation_Y: 1000
      },
      DAC: {
        inhalation_W: 5e-7,
        inhalation_Y: 5e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.29e-9,
        inhalation_Y: 1.57e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Nitrogen-13',
    symbol: 'N-13',
    emissionType: ['Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['1.20 MeV (max)'],
      gamma: ['0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.400 MeV',
    halfLife: '9.97 minutes',
    decayConstant: '0.0695 min⁻¹',
    specificActivity: '3.7 x 10^18 Bq/g',
    parent: 'Carbon-13 (p,n)',
    daughter: 'Carbon-13 (stable)',
    commonUses: ['Cardiac PET imaging for myocardial perfusion and viability'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.9,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      DAC: {
        inhalation: 4e-6 // Submersion
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Nitrogen-14',
    symbol: 'N-14',
    emissionType: ['Stable'],
    emissionEnergies: {
      alpha: [],
      beta: [],
      gamma: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    specificActivity: '0 Bq/g',
    parent: 'Carbon-14 (β-)',
    daughter: 'Stable',
    commonUses: ['Most abundant stable isotope of nitrogen', 'NMR spectroscopy', 'Target material for producing Carbon-14'],
    category: 'Stable/Reference',
    commonality: 'Common',
    commonalityReason: 'The most abundant stable isotope of nitrogen and the stable daughter of Carbon-14.',
    sourceRef: {},
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Oxygen-15',
    symbol: 'O-15',
    emissionType: ['Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['1.73 MeV (max)'],
      gamma: ['0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.577 MeV',
    halfLife: '122.2 seconds',
    decayConstant: '0.00567 s⁻¹',
    specificActivity: '3.3 x 10^18 Bq/g',
    parent: 'Nitrogen-15 (p,n)',
    daughter: 'Nitrogen-15 (stable)',
    commonUses: ['Brain blood flow', 'Oxygen metabolism PET imaging'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A PET isotope with a very short half-life, requiring an on-site cyclotron for production.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    dosimetry: {
      DAC: {
        inhalation: 4e-6 // Submersion
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Palladium-103',
    symbol: 'Pd-103',
    emissionType: ['Electron Capture', 'X-ray', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: '16.99 days',
    decayConstant: '0.0408 day⁻¹',
    specificActivity: '3.5 x 10^15 Bq/g',
    parent: 'Rhodium-103 (p,n)',
    daughter: 'Rhodium-103 (stable)',
    commonUses: ['Brachytherapy (prostate cancer)'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A key isotope, along with I-125, used in permanent brachytherapy seeds for prostate cancer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 40,
      unit: 'TBq'
    },
    dValue: 90,
    dosimetry: {
      ALI: {
        ingestion: 6000,
        inhalation_D: 6000,
        inhalation_W: 4000,
        inhalation_Y: 4000
      },
      DAC: {
        inhalation_D: 3e-6,
        inhalation_W: 2e-6,
        inhalation_Y: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.34e-10,
        inhalation_W: 3.76e-10,
        inhalation_Y: 4.24e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Phosphorus-32',
    symbol: 'P-32',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['1.710 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.570 MeV',
    halfLife: '14.26 days',
    decayConstant: '0.0486 day⁻¹',
    specificActivity: '1.07 x 10^16 Bq/g',
    parent: 'Sulfur-32 (n,p)',
    daughter: 'Sulfur-32 (stable)',
    commonUses: ['Molecular biology (DNA/RNA labeling)', 'Radiotherapy for polycythemia vera', 'Agricultural research'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A high-energy pure beta-emitter widely used in molecular biology labs and for some therapies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    dValue: 10,
    dosimetry: {
      ALI: {
        ingestion: 600,
        inhalation_D: 900,
        inhalation_W: 400
      },
      DAC: {
        inhalation_D: 4e-7,
        inhalation_W: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.64e-9,
        inhalation_W: 4.19e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Plutonium-238',
    symbol: 'Pu-238',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.499 MeV'],
      gamma: ['0.043 MeV'],
      beta: []
    },
    halfLife: '87.7 years',
    decayConstant: '0.00790 year⁻¹',
    specificActivity: '6.34 x 10^11 Bq/g',
    parent: 'Neptunium-237 (n,γ) -> Np-238 (β-)',
    daughter: 'Uranium-234',
    commonUses: ['Radioisotope thermoelectric generators (RTGs) for spacecraft and pacemakers'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'The primary power source for RTGs used in deep space missions and other remote applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.001,
      unit: 'TBq'
    },
    dValue: 0.06,
    dosimetry: {
      ALI: {
        ingestion: 0.9,
        inhalation_W: 0.007,
        inhalation_Y: 0.02
      },
      DAC: {
        inhalation_W: 3e-12,
        inhalation_Y: 8e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.06e-4,
        inhalation_Y: 7.79e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
{
    name: 'Plutonium-239',
    symbol: 'Pu-239',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.157 MeV (73.3%)', '5.144 MeV (15.1%)'],
      beta: [],
      gamma: ['0.0516 MeV']
    },
    halfLife: '24,110 years',
    decayConstant: '2.87 x 10⁻⁵ year⁻¹',
    specificActivity: '2.3 x 10^9 Bq/g',
    parent: 'Uranium-238 (n,γ) -> ... -> Np-239 (β-)',
    daughter: 'Uranium-235 (α)',
    commonUses: ['Nuclear weapons', 'Nuclear fuel (MOX fuel)'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A primary fissile material used in nuclear weapons and as a component of MOX fuel.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.001,
      unit: 'TBq'
    },
    dValue: 0.06,
    dosimetry: {
      ALI: {
        ingestion: 0.8,
        inhalation_W: 0.006,
        inhalation_Y: 0.02
      },
      DAC: {
        inhalation_W: 3e-12,
        inhalation_Y: 7e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.16e-4,
        inhalation_Y: 8.33e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  
  {
    name: 'Polonium-208',
    symbol: 'Po-208',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.115 MeV'],
      beta: [],
      gamma: ['0.134 MeV']
    },
    halfLife: '2.898 years',
    decayConstant: '0.239 year⁻¹',
    specificActivity: '1.6 x 10^13 Bq/g',
    parent: 'Bismuth-209 (p,2n)',
    daughter: 'Lead-204 (stable)',
    commonUses: ['Alpha calibration', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A synthetic alpha-emitter used for specialized research and calibration.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    dosimetry: {
      ALI: { ingestion: 3, inhalation_D: 0.6, inhalation_W: 0.6 },
      DAC: { inhalation_D: 3e-10, inhalation_W: 3e-10 },
      DCF: {
      },
      sourceRef: '10CFR20 (Po-210 Proxy)'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-210',
    symbol: 'Po-210',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['5.304 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '138.376 days',
    decayConstant: '0.00501 day⁻¹',
    specificActivity: '1.66 x 10^14 Bq/g',
    parent: 'Bismuth-210 (β-)',
    daughter: 'Lead-206 (stable)',
    commonUses: ['Antistatic devices', 'Neutron sources', 'Research (alpha spectroscopy)'],
    category: 'Natural',
    commonality: 'Common',
    commonalityReason: 'A naturally occurring alpha-emitter (from Radon decay) used commercially in antistatic devices.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 0.02,
      unit: 'TBq'
    },
    dValue: 0.06,
    dosimetry: {
      ALI: {
        ingestion: 3,
        inhalation_D: 0.6,
        inhalation_W: 0.6
      },
      DAC: {
        inhalation_D: 3e-10,
        inhalation_W: 3e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.54e-6,
        inhalation_W: 2.32e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-211',
    symbol: 'Po-211',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['7.45 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '0.516 seconds',
    decayConstant: '1.34 s⁻¹',
    specificActivity: '1.4 x 10^20 Bq/g',
    parent: 'Bismuth-211',
    daughter: 'Lead-207 (stable)',
    commonUses: ['Fastest alpha emitter in natural series', 'Research'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dosimetry: {
      ALI: { ingestion: 0.1, inhalation_W: 0.002 },
      DAC: { inhalation_W: 1e-13 },
      sourceRef: '10CFR20 (Default Alpha)'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-212',
    symbol: 'Po-212',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['8.785 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '0.299 microseconds',
    decayConstant: '2.32 x 10⁶ s⁻¹',
    specificActivity: '6.58 x 10^27 Bq/g',
    parent: 'Bismuth-212 (β-)',
    daughter: 'Lead-208 (stable)',
    commonUses: ['Fastest alpha emitter in natural series', 'Research'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-214',
    symbol: 'Po-214',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['7.687 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '164.3 microseconds',
    decayConstant: '4218 s⁻¹',
    specificActivity: '4.4 x 10^21 Bq/g',
    parent: 'Bismuth-214',
    daughter: 'Lead-210 (α)',
    commonUses: ['Very short-lived intermediate in U-238 decay chain'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-215',
    symbol: 'Po-215',
    emissionType: ['Alpha', 'Beta-minus'],
    emissionEnergies: {
      alpha: ['7.386 MeV'],
      beta: ['0.71 MeV (max)'],
      gamma: []
    },
    avgBetaEnergy: '0.237 MeV',
    halfLife: '1.781 milliseconds',
    decayConstant: '389 s⁻¹',
    specificActivity: '2.5 x 10^21 Bq/g',
    parent: 'Radon-219',
    daughter: 'Lead-211 (α) or Astatine-215 (β-)',
    commonUses: ['Very short-lived intermediate in U-235 decay chain'],
    category: 'Natural',
    decaySeriesId: 'U-235-series',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-216',
    symbol: 'Po-216',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['6.778 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '0.145 seconds',
    decayConstant: '4.78 s⁻¹',
    specificActivity: '1.6 x 10^20 Bq/g',
    parent: 'Radon-220',
    daughter: 'Lead-212 (α)',
    commonUses: ['Very short-lived intermediate in Th-232 chain'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Polonium-218',
    emissionType: ['Alpha'],
    symbol: 'Po-218',
    emissionEnergies: {
      alpha: ['6.002 MeV'],
      beta: []
    },
    avgBetaEnergy: '0.087 MeV',
    halfLife: '3.10 minutes',
    decayConstant: '0.224 min⁻¹',
    specificActivity: '2.3 x 10^18 Bq/g',
    parent: 'Radon-222',
    daughter: 'Lead-214 (α) or Astatine-218 (β-)',
    commonUses: ['Intermediate in U-238 decay chain'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Potassium-40',
    symbol: 'K-40',
    emissionType: ['Beta-minus', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['1.311 MeV (max)'],
      gamma: ['1.461 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.437 MeV',
    halfLife: '1.251 billion years',
    decayConstant: '5.54 x 10⁻¹⁰ year⁻¹',
    specificActivity: '2.6 x 10^5 Bq/g',
    parent: 'Primordial',
    daughter: 'Calcium-40 (β-) or Argon-40 (EC)',
    commonUses: ['Potassium-argon dating', 'Internal human radiation dose', 'Environmental monitoring'],
    category: 'Natural',
    commonality: 'Common',
    commonalityReason: 'A naturally occurring isotope found in soil, food (like bananas), and is a primary source of natural internal radiation dose in humans.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.9,
      A2: 0.9,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 300,
        inhalation_D: 400
      },
      DAC: {
        inhalation_D: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.34e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Praseodymium-144',
    symbol: 'Pr-144',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['2.997 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.999 MeV',
    halfLife: '17.28 minutes',
    decayConstant: '0.0401 min⁻¹',
    specificActivity: '1.96 x 10^17 Bq/g',
    parent: 'Cerium-144',
    daughter: 'Neodymium-144 (stable)',
    commonUses: ['High-energy beta source (daughter of Ce-144)'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A very short-lived daughter of Ce-144, notable for its high-energy beta emission.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    dosimetry: {
      ALI: {
        ingestion: 30000,
        inhalation_W: 100000,
        inhalation_Y: 100000
      },
      DAC: {
        inhalation_W: 5e-5,
        inhalation_Y: 5e-5
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.10e-11,
        inhalation_Y: 1.17e-11
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Promethium-147',
    symbol: 'Pm-147',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.224 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.075 MeV',
    halfLife: '2.623 years',
    decayConstant: '0.264 year⁻¹',
    specificActivity: '3.4 x 10^13 Bq/g',
    parent: 'Neodymium-147 (β-)',
    daughter: 'Samarium-147',
    commonUses: ['Atomic batteries (historical)', 'Luminous paints', 'Thickness gauges'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fission product used in specialized applications like luminous paints and thickness gauges.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 2,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_W: 100,
        inhalation_Y: 100
      },
      DAC: {
        inhalation_W: 5e-8,
        inhalation_Y: 6e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 6.97e-9,
        inhalation_Y: 1.06e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Protactinium-231',
    symbol: 'Pa-231',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.059 MeV'],
      beta: [],
      gamma: ['0.302 MeV', '0.283 MeV']
    },
    halfLife: '32,760 years',
    decayConstant: '2.11 x 10⁻⁵ year⁻¹',
    specificActivity: '1.75 x 10^9 Bq/g',
    parent: 'Thorium-231 (β-)',
    daughter: 'Actinium-227 (α)',
    commonUses: ['Intermediate in Actinium-227 decay series', 'Geological research'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A long-lived member of the U-235 decay series, used in geological dating.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 4,
      A2: 0.0004,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 0.2,
        inhalation_W: 0.002, // Bone surface
        inhalation_Y: 0.004
      },
      DAC: {
        inhalation_W: 6e-13,
        inhalation_Y: 2e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 3.47e-4,
        inhalation_Y: 2.32e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Protactinium-233',
    symbol: 'Pa-233',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.571 MeV (max)'],
      gamma: ['0.312 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.190 MeV',
    halfLife: '27.0 days',
    decayConstant: '0.0257 day⁻¹',
    specificActivity: '7.5 x 10^14 Bq/g',
    parent: 'Thorium-233 (β)',
    daughter: 'Uranium-233',
    commonUses: ['Intermediate in Th-232 to U-233 fuel cycle', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'An important intermediate in the process of breeding U-233 fuel from Thorium-232.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 5,
      A2: 0.7,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 1000,
        inhalation_W: 700,
        inhalation_Y: 600
      },
      DAC: {
        inhalation_W: 3e-7,
        inhalation_Y: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.24e-9,
        inhalation_Y: 2.58e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Protactinium-234m',
    symbol: 'Pa-234m',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['2.29 MeV (max)'],
      gamma: ['1.001 MeV', '0.766 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.763 MeV',
    halfLife: '1.17 minutes',
    decayConstant: '0.592 min⁻¹',
    specificActivity: '1.7 x 10^19 Bq/g',
    parent: 'Thorium-234',
    daughter: 'Uranium-234 (β-)',
    commonUses: ['Intermediate in U-238 decay chain'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A very short-lived but commonly present intermediate in the U-238 decay series.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 8000,
        inhalation_Y: 7000
      },
      DAC: {
        inhalation_W: 3e-6,
        inhalation_Y: 3e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Radium-220',
    symbol: 'Ra-220',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['6.818 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '27.4 seconds',
    decayConstant: '0.0253 s⁻¹',
    specificActivity: '1.8 x 10^18 Bq/g',
    parent: 'Thorium-224',
    daughter: 'Radon-216 (α)',
    commonUses: ['Intermediate in Thorium-232 decay series'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
    {
    name: 'Radium-223',
    symbol: 'Ra-223',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.71 MeV (dominant)'],
      beta: [],
      gamma: ['0.269 MeV']
    },
    halfLife: '11.43 days',
    decayConstant: '0.0606 day⁻¹',
    specificActivity: '1.9 x 10^15 Bq/g',
    parent: 'Thorium-227',
    daughter: 'Radon-219 (α)',
    commonUses: ['Alpha-emitter for targeted alpha therapy (e.g., Xofigo for prostate cancer)'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A clinically approved alpha-emitter for treating bone metastases from prostate cancer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.07,
    shipping: {
      A1: 0.4,
      A2: 0.007,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 5, // Bone 9
        inhalation_W: 0.7
      },
      DAC: {
        inhalation_W: 3e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.12e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'sr_90',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Radium-224',
    symbol: 'Ra-224',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.685 MeV'],
      beta: [],
      gamma: ['0.241 MeV']
    },
    daughterEmissions: {
      from: 'Rn-220',
      alpha: ['6.288 MeV']
    },
    halfLife: '3.66 days',
    decayConstant: '0.189 day⁻¹',
    specificActivity: '5.9 x 10^15 Bq/g',
    parent: 'Thorium-228',
    daughter: 'Radon-220 (α)',
    commonUses: ['Intermediate in Thorium-232 decay series'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A short-lived alpha-emitter in the Th-232 decay series.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.4,
      A2: 0.02,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 8,
        inhalation_W: 2
      },
      DAC: {
        inhalation_W: 7e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 8.53e-7
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'sr_90',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Radium-226 in Equilibrium',
    symbol: 'Ra-226 eq',
    emissionType: ['Alpha', 'Beta-minus', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.784 MeV (Ra-226)'],
      beta: ['3.27 MeV (Bi-214 max)'],
      gamma: ['0.186 MeV (Ra-226)', '0.609 MeV (Bi-214)', '1.764 MeV (Bi-214)']
    },
    halfLife: '1600 years',
    decayConstant: '4.33 x 10⁻⁴ year⁻¹',
    gammaConstant: '0.825 R·m²/hr·Ci',
    specificActivity: '3.7 x 10^10 Bq/g',
    parent: 'Thorium-230',
    daughter: 'Radon-222 (α)',
    commonUses: ['Sealed brachytherapy sources', 'Calibration sources (aged >30 days)', 'Industrial radiography (historical)'],
    category: 'Natural',
    decaySeriesId: 'U-238-series',
    commonality: 'Common',
    commonalityReason: 'Represents an aged Ra-226 source where gamma-emitting daughters contribute significantly to the dose rate.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 0.2,
      A2: 0.003,
      unit: 'TBq'
    },
    dValue: 0.04,
    dosimetry: {
      ALI: {
        inhalation_W: 0.6,
        ingestion: 2 // Bone surface 5
      },
      DAC: {
        inhalation_W: 3e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.32e-6 // Note: Values for pure Ra-226; equilibrium dose depends on daughter retention
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Radium-226',
    symbol: 'Ra-226',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.784 MeV'],
      beta: [],
      gamma: ['0.186 MeV']
    },
    daughterEmissions: {
      from: 'Rn-222',
      alpha: ['5.490 MeV']
    },
    halfLife: '1600 years',
    decayConstant: '4.33 x 10⁻⁴ year⁻¹',
    gammaConstant: '0.0121138 R·m²/hr·Ci',
    specificActivity: '3.7 x 10^10 Bq/g',
    parent: 'Thorium-230',
    daughter: 'Radon-222 (α)',
    commonUses: ['Freshly separated sources', 'Neutron sources (Ra-Be)', 'Luminescent paint (historical)'],
    category: 'Natural',
    decaySeriesId: 'U-238-series',
    commonality: 'Common',
    commonalityReason: 'Historically significant nuclide. This entry represents the nuclide without its gamma-emitting progeny.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    shipping: {
      A1: 0.2,
      A2: 0.003,
      unit: 'TBq'
    },
    dValue: 0.04,
    dosimetry: {
      ALI: {
        inhalation_W: 0.6,
        ingestion: 2 // Bone surface 
      },
      DAC: {
        inhalation_W: 3e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.32e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Radium-228',
    symbol: 'Ra-228',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.039 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.013 MeV',
    daughterEmissions: {
      from: 'Ac-228',
      beta: ['2.14 MeV (max)'],
      gamma: ['0.911 MeV', '0.969 MeV']
    },
    halfLife: '5.75 years',
    decayConstant: '0.120 year⁻¹',
    specificActivity: '8.1 x 10^12 Bq/g',
    parent: 'Thorium-232',
    daughter: 'Actinium-228 (β-)',
    commonUses: ['Intermediate in Thorium-232 decay chain', 'Environmental monitoring'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'The first daughter of Th-232, often monitored in environmental samples.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.6,
      A2: 0.02,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2, // Bone surface 4
        inhalation_W: 1 // Bone surface 2
      },
      DAC: {
        inhalation_W: 5e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.29e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Radon-219',
    symbol: 'Rn-219',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['6.819 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '3.96 seconds',
    decayConstant: '0.175 s⁻¹',
    specificActivity: '1.14 x 10^19 Bq/g',
    parent: 'Radium-223',
    daughter: 'Polonium-215 (α)',
    commonUses: ['Intermediate in Actinium-227 decay series'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An extremely short-lived noble gas intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Radon-220',
    symbol: 'Rn-220',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['6.288 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '55.6 seconds',
    decayConstant: '0.0125 s⁻¹',
    specificActivity: '8.1 x 10^17 Bq/g',
    parent: 'Radium-224',
    daughter: 'Polonium-216 (α)',
    commonUses: ['Environmental monitoring (thoron gas)', 'Research'],
    category: 'Natural',
    commonality: 'Common',
    commonalityReason: 'A naturally occurring noble gas (also called Thoron) from the Th-232 decay series.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dosimetry: {
      DAC: { inhalation: 7e-6 }, // With daughters removed
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Radon-221',
    symbol: 'Rn-221',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.19 MeV (max)'],
      gamma: ['0.078 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.397 MeV',
    halfLife: '25 minutes',
    decayConstant: '0.0277 min⁻¹',
    specificActivity: '1.8 x 10^17 Bq/g',
    parent: 'Radium-225',
    daughter: 'Francium-221',
    commonUses: ['Research (intermediate in artificial decay series)'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A short-lived intermediate in an artificial decay series with no practical applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Radon-222',
    symbol: 'Rn-222',
    emissionType: ['Alpha'],
    emissionEnergies: {
      alpha: ['5.490 MeV'],
      beta: [],
      gamma: []
    },
    halfLife: '3.823 days',
    decayConstant: '0.181 day⁻¹',
    specificActivity: '5.73 x 10^15 Bq/g',
    parent: 'Radium-226',
    daughter: 'Polonium-218 (α)',
    commonUses: ['Indoor air quality concern', 'Geological tracer', 'Research'],
    category: 'Natural',
    decaySeriesId: 'U-238-series',
    commonality: 'Common',
    commonalityReason: 'A naturally occurring noble gas from the U-238 series, well-known as an indoor air quality concern.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.3,
      A2: 0.004,
      unit: 'TBq'
    },
    dosimetry: {
      DAC: {
        inhalation: 3e-8 // With daughters present. Or 4e-6 (0.33 WL) with daughters removed.
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  
  {
    name: 'Rhenium-186',
    symbol: 'Re-186',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.07 MeV (max)'],
      gamma: ['0.137 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.357 MeV',
    halfLife: '3.718 days',
    decayConstant: '0.186 day⁻¹',
    gammaConstant: '0.0181633 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    parent: 'Tungsten-186 (n,γ)',
    daughter: 'Osmium-186 (stable)',
    commonUses: ['Radiotherapy for bone pain palliation'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A therapeutic isotope used for bone pain palliation in metastatic cancer.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 2,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        inhalation_W: 2000,
        ingestion: 2000,
        inhalation_D: 3000
      },
      DAC: {
        inhalation_W: 7e-7,
        inhalation_D: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.28e-10,
        inhalation_W: 8.64e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Rhenium-187',
    symbol: 'Re-187',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.0025 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.001 MeV',
    halfLife: '43300000000 years',
    decayConstant: '1.60 x 10⁻¹¹ year⁻¹',
    specificActivity: '1.63 x 10^6 Bq/g',
    parent: 'Primordial',
    daughter: 'Osmium-187 (stable)',
    commonUses: ['Rhenium-Osmium dating (geological)', 'Neutrino mass experiments'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A very long-lived primordial nuclide used for geological dating (Re-Os system).',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 'unlimited',
      A2: 'unlimited',
      unit: 'TBq'
    },
    dosimetry: {
      ALI: { ingestion: 600000, inhalation_D: 800000, inhalation_W: 100000 },
      DAC: { inhalation_D: 4e-4, inhalation_W: 4e-5 },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.80e-12,
        inhalation_W: 1.47e-12
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_low_risk'
  },
  {
    name: 'Rhenium-188',
    symbol: 'Re-188',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['2.12 MeV (max)'],
      gamma: ['0.155 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.707 MeV',
    halfLife: '17.0 hours',
    decayConstant: '0.0408 hour⁻¹',
    specificActivity: '3.7 x 10^16 Bq/g',
    parent: 'Tungsten-188',
    daughter: 'Osmium-188 (stable)',
    commonUses: ['Radiotherapy (bone pain palliation, synovectomy, arterial brachytherapy)'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A high-energy beta emitter produced from a W-188 generator for various therapeutic applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.4,
      A2: 0.4,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        inhalation_W: 3000,
        ingestion: 2000,
        inhalation_D: 3000
      },
      DAC: {
        inhalation_D: 1e-6,
        inhalation_W: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 5.25e-10,
        inhalation_W: 5.44e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Rhodium-105',
    symbol: 'Rh-105',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.567 MeV (max)'],
      gamma: ['0.306 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.189 MeV',
    halfLife: '35.36 hours',
    decayConstant: '0.0196 hour⁻¹',
    specificActivity: '1.27 x 10^16 Bq/g',
    parent: 'Ruthenium-105',
    daughter: 'Palladium-105 (stable)',
    commonUses: ['Targeted radiotherapy research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A short-lived isotope used in targeted radiotherapy research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.8,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        inhalation_Y: 6000,
        ingestion: 4000,
        inhalation_D: 10000,
        inhalation_W: 6000
      },
      DAC: {
        inhalation_D: 5e-6,
        inhalation_W: 3e-6,
        inhalation_Y: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.28e-10,
        inhalation_W: 2.37e-10,
        inhalation_Y: 2.58e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Rubidium-81',
    symbol: 'Rb-81',
    emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['1.05 MeV (max)'],
      gamma: ['0.446 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.350 MeV',
    daughterEmissions: {
      from: 'Kr-81m',
      gamma: ['0.190 MeV']
    },
    halfLife: '4.57 hours',
    decayConstant: '0.152 hour⁻¹',
    specificActivity: '1.3 x 10^17 Bq/g',
    parent: 'Strontium-81',
    daughter: 'Krypton-81m (IT) -> Krypton-81 (stable)',
    commonUses: ['Generator for Kr-81m (lung ventilation PET imaging)'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'The parent isotope used in generators to produce the short-lived gas Kr-81m for lung scans.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 2,
      A2: 0.8,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 40000,
        inhalation_D: 50000
      },
      DAC: {
        inhalation_D: 2e-5
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.51e-11
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Rubidium-82',
    symbol: 'Rb-82',
    emissionType: ['Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['3.38 MeV (max)'],
      gamma: ['0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '1.127 MeV',
    halfLife: '76 seconds',
    decayConstant: '0.00912 s⁻¹',
    specificActivity: '8.3 x 10^17 Bq/g',
    parent: 'Strontium-82',
    daughter: 'Krypton-82 (stable)',
    commonUses: ['Cardiac PET imaging for myocardial perfusion'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'An extremely short-lived PET isotope produced from a Sr-82 generator for cardiac perfusion imaging.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 0.4,
      unit: 'TBq'
    },
    dosimetry: {
      // FGR 11 does not list Committed Dose DCFs for Rb-82 (submersion only).
      DAC: {
        inhalation_D: 1e-4 // Submersion approximation
      },
      sourceRef: '10CFR20 (Submersion/Default)'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Rubidium-84',
    symbol: 'Rb-84',
    emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['1.65 MeV (max)'],
      gamma: ['0.882 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.550 MeV',
    halfLife: '32.8 days',
    decayConstant: '0.0211 day⁻¹',
    specificActivity: '1.74 x 10^15 Bq/g',
    parent: 'Krypton-84',
    daughter: 'Krypton-84 (stable)',
    commonUses: ['Cardiac blood flow research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A research isotope used in studies of cardiac blood flow.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 1,
      A2: 1,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 500,
        inhalation_D: 800
      },
      DAC: {
        inhalation_D: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.76e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Rubidium-86',
    symbol: 'Rb-86',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.77 MeV (max)'],
      gamma: ['1.077 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.590 MeV',
    halfLife: '18.66 days',
    decayConstant: '0.0371 day⁻¹',
    specificActivity: '4.2 x 10^15 Bq/g',
    parent: 'Krypton-86',
    daughter: 'Strontium-86 (stable)',
    commonUses: ['Cardiac blood flow research'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A research isotope used in studies of cardiac blood flow.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 500,
        inhalation_D: 800
      },
      DAC: {
        inhalation_D: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.79e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Ruthenium-103',
    symbol: 'Ru-103',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.226 MeV (max)'],
      gamma: ['0.497 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.075 MeV',
    halfLife: '39.25 days',
    decayConstant: '0.0176 day⁻¹',
    specificActivity: '1.3 x 10^15 Bq/g',
    parent: 'Technetium-103',
    daughter: 'Rhodium-103 (stable)',
    commonUses: ['Fission product', 'Environmental tracer'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fission product with limited use outside of specialized research applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 2,
      A2: 2,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 2000,
        inhalation_W: 1000,
        inhalation_Y: 600
      },
      DAC: {
        inhalation_D: 7e-7,
        inhalation_W: 4e-7,
        inhalation_Y: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.24e-10,
        inhalation_W: 1.75e-9,
        inhalation_Y: 2.42e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Samarium-153',
    symbol: 'Sm-153',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.808 MeV (max)'],
      gamma: ['0.103 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.269 MeV',
    halfLife: '46.28 hours',
    decayConstant: '0.0150 hour⁻¹',
    specificActivity: '3.5 x 10^15 Bq/g',
    parent: 'Samarium-152 (n,γ)',
    daughter: 'Europium-153 (stable)',
    commonUses: ['Palliative bone pain therapy (metastatic cancer)'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A clinically used therapeutic isotope for palliative treatment of bone pain from cancer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 9,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 3000
      },
      DAC: {
        inhalation_W: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 5.31e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Scandium-44',
    symbol: 'Sc-44',
    emissionType: ['Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['1.47 MeV (max)'],
      gamma: ['1.157 MeV', '0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.490 MeV',
    halfLife: '3.97 hours',
    decayConstant: '0.174 hour⁻¹',
    parent: 'Titanium-44 (EC)',
    daughter: 'Calcium-44 (stable)',
    commonUses: ['PET imaging', 'Theranostic pair with Sc-47'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A research PET isotope, often explored as a "theranostic" partner to the therapeutic isotope Sc-47.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_Y: 10000
      },
      DAC: {
        inhalation_Y: 5e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_Y: 1.33e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Scandium-46',
    symbol: 'Sc-46',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.357 MeV (max)'],
      gamma: ['0.889 MeV', '1.121 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.119 MeV',
    halfLife: '83.79 days',
    decayConstant: '0.00827 day⁻¹',
    specificActivity: '1.24 x 10^15 Bq/g',
    parent: 'Calcium-46 (n,p)',
    daughter: 'Titanium-46 (stable)',
    commonUses: ['Tracer in hydrology and industrial processes', 'Calibration source'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived gamma-emitter used as a tracer in specialized industrial processes.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    gammaConstant: '1.16735 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 900,
        inhalation_Y: 200
      },
      DAC: {
        inhalation_Y: 1e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_Y: 8.01e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Scandium-47',
    symbol: 'Sc-47',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.601 MeV (max)'],
      gamma: ['0.159 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.200 MeV',
    halfLife: '3.35 days',
    decayConstant: '0.207 day⁻¹',
    specificActivity: '3.1 x 10^16 Bq/g',
    parent: 'Titanium-47 (n,p)',
    daughter: 'Titanium-47 (stable)',
    commonUses: ['Theranostics (pairs with Sc-44 for PET), targeted radiotherapy research.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A research therapeutic isotope, often explored as a "theranostic" partner to the PET isotope Sc-44.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.7,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_Y: 3000
      },
      DAC: {
        inhalation_Y: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_Y: 4.98e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Selenium-75',
    symbol: 'Se-75',
    emissionType: ['Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.136 MeV', '0.265 MeV', '0.401 MeV'], // Main imaging lines
      alpha: []
    },
    halfLife: '119.8 days',
    decayConstant: '0.00578 day⁻¹',
    specificActivity: '5.4 x 10^14 Bq/g',
    parent: 'Germanium-74 (n,γ) -> Ge-75 -> As-75', // Simplified production
    daughter: 'Arsenic-75 (stable)',
    commonUses: ['Industrial radiography (small bore pipes)', 'NDT'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A popular radiography source for thinner steel sections where Ir-192 is too energetic.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    shipping: { A1: 3, A2: 3, unit: 'TBq' },
    dValue: 0.2, // IAEA EPR-D-Values
    gammaConstant: '0.85951 R·m²/hr·Ci',
    dosimetry: {
      ALI: { ingestion: 500, inhalation_W: 700 },
      DAC: { inhalation_W: 3e-7 },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Selenium-76',
    symbol: 'Se-76',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Stable',
    daughter: 'Stable',
    commonUses: ['Reference for stable selenium', 'not a radionuclide use'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Selenium-79',
    symbol: 'Se-79',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.151 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.050 MeV',
    halfLife: '327,000 years',
    decayConstant: '2.12 x 10⁻⁶ year⁻¹',
    specificActivity: '9.2 x 10^8 Bq/g',
    parent: 'Bromine-79 (n,p)',
    daughter: 'Bromine-79 (stable)',
    commonUses: ['Environmental tracer (long-lived fission product)'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'An extremely long-lived fission product relevant in nuclear waste management and environmental studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 2,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 600,
        inhalation_D: 800,
        inhalation_W: 600
      },
      DAC: {
        inhalation_D: 3e-7,
        inhalation_W: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.77e-9,
        inhalation_W: 2.66e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Silver-110m',
    symbol: 'Ag-110m',
    emissionType: ['Beta-minus', 'Isomeric Transition', 'Gamma'],
    emissionEnergies: {
      beta: ['0.529 MeV (max)'],
      gamma: ['0.885 MeV', '0.658 MeV', '1.505 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.176 MeV',
    halfLife: '249.8 days',
    decayConstant: '0.00277 day⁻¹',
    specificActivity: '1.93 x 10^14 Bq/g',
    parent: 'Cadmium-108',
    daughter: 'Cadmium-110 (stable) or Palladium-110 (stable)',
    commonUses: ['Environmental monitoring (fission product', 'activation product)'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'An activation product sometimes used as a gamma calibration source or environmental tracer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.4,
      A2: 0.4,
      unit: 'TBq'
    },
    gammaConstant: '1.65242 R·m²/hr·Ci',
    dValue: 0.02,
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 500,
        inhalation_D: 100,
        inhalation_W: 200,
        inhalation_Y: 90
      },
      DAC: {
        inhalation_D: 5e-8,
        inhalation_W: 8e-8,
        inhalation_Y: 4e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.07e-8,
        inhalation_W: 8.34e-9,
        inhalation_Y: 2.17e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Sodium-22',
    symbol: 'Na-22',
    emissionType: ['Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['0.546 MeV (max)'],
      gamma: ['1.275 MeV', '0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.182 MeV',
    halfLife: '2.602 years',
    decayConstant: '0.266 year⁻¹',
    gammaConstant: '1.3394 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    specificActivity: '6.45 x 10^13 Bq/g',
    parent: 'Magnesium-22 (EC)',
    daughter: 'Neon-22 (stable)',
    commonUses: ['Calibration sources for PET scanners', 'Tracers for biological studies'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A common long-lived positron emitter used to calibrate PET scanners and other detectors.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 0.5,
      A2: 0.5,
      unit: 'TBq'
    },
    dValue: 0.03,
    dosimetry: {
      ALI: {
        ingestion: 400,
        inhalation_D: 600
      },
      DAC: {
        inhalation_D: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.07e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Sodium-23',
    symbol: 'Na-23',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Stable',
    daughter: 'Stable',
    commonUses: ['Reference for stable sodium', 'not a radionuclide use'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Sodium-24',
    symbol: 'Na-24',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.39 MeV (max)'],
      gamma: ['1.369 MeV', '2.754 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.463 MeV',
    halfLife: '14.96 hours',
    decayConstant: '0.0463 hour⁻¹',
    specificActivity: '1.8 x 10^17 Bq/g',
    parent: 'Magnesium-24 (n,p)',
    daughter: 'Magnesium-24 (stable)',
    commonUses: ['Hydrological tracer', 'Flow studies', 'Research'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A short-lived, high-energy gamma emitter used as a tracer in industrial and environmental flow studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 0.02,
    shipping: {
      A1: 0.2,
      A2: 0.2,
      unit: 'TBq'
    },
    gammaConstant: '1.93769 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_D: 5000
      },
      DAC: {
        inhalation_D: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.27e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Strontium-82',
    symbol: 'Sr-82',
    emissionType: ['Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.776 MeV'],
      alpha: []
    },
    daughterEmissions: {
      from: 'Rb-82',
      beta: ['3.38 MeV (max)'],
      gamma: ['0.511 MeV (annihilation)']
    },
    halfLife: '25.36 days',
    decayConstant: '0.0273 day⁻¹',
    specificActivity: '2.4 x 10^15 Bq/g',
    parent: 'Yttrium-85',
    daughter: 'Rubidium-82',
    commonUses: ['Generator for Rubidium-82, used for cardiac PET imaging.'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'The long-lived parent used in generators to produce the very short-lived PET isotope Rb-82 for cardiac scans.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.2,
      A2: 0.2,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 300,
        inhalation_D: 400,
        inhalation_Y: 90
      },
      DAC: {
        inhalation_D: 2e-7,
        inhalation_Y: 4e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.62e-9,
        inhalation_Y: 1.66e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Strontium-89',
    symbol: 'Sr-89',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['1.49 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.497 MeV',
    halfLife: '50.5 days',
    decayConstant: '0.0137 day⁻¹',
    specificActivity: '1.09 x 10^15 Bq/g',
    parent: 'Uranium Fission',
    daughter: 'Yttrium-89 (stable)',
    commonUses: ['Palliative bone pain therapy (metastatic cancer)'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A clinically used high-energy beta-emitter for palliative treatment of bone pain from cancer.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 20,
    shipping: {
      A1: 0.6,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 600,
        inhalation_D: 800,
        inhalation_Y: 100
      },
      DAC: {
        inhalation_D: 4e-7,
        inhalation_Y: 6e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.76e-9,
        inhalation_Y: 1.12e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Strontium-90',
    symbol: 'Sr-90',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.546 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.196 MeV',
    daughterEmissions: {
      from: 'Y-90',
      beta: ['2.28 MeV (max)']
    },
    halfLife: '28.9 years',
    decayConstant: '0.0240 year⁻¹',
    specificActivity: '5.15 x 10^12 Bq/g',
    parent: 'Uranium Fission',
    daughter: 'Yttrium-90',
    commonUses: ['Radioisotope thermoelectric generators (RTGs)', 'Industrial gauges', 'Medical radiation therapy for bone cancer'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'A major fission product and long-lived, high-energy beta source (via its Y-90 daughter) for industrial and medical uses.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.3,
      A2: 0.3,
      unit: 'TBq'
    },
    dValue: 1,
    dosimetry: {
      ALI: {
        ingestion: 30, // Bone surface
        inhalation_D: 20,
        inhalation_Y: 4
      },
      DAC: {
        inhalation_D: 8e-9,
        inhalation_Y: 2e-9
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.47e-8,
        inhalation_Y: 3.51e-7
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'sr_90',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Sulfur-34',
    symbol: 'S-34',
    emissionType: ['Stable'],
    emissionEnergies: {
      beta: [],
      gamma: [],
      alpha: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    parent: 'Stable',
    daughter: 'Stable',
    commonUses: ['Reference for stable sulfur', 'not a radionuclide use'],
    category: 'Stable/Reference',
    commonality: 'N/A',
    commonalityReason: 'This is a stable isotope and not radioactive.',
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Sulfur-35',
    symbol: 'S-35',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.167 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.056 MeV',
    halfLife: '87.51 days',
    decayConstant: '0.00792 day⁻¹',
    specificActivity: '1.57 x 10^15 Bq/g',
    parent: 'Chlorine-35 (n,p)',
    daughter: 'Chlorine-35 (stable)',
    commonUses: ['Molecular biology (protein labeling)', 'Metabolic studies'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A low-energy beta-emitter widely used in molecular biology labs for labeling proteins.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 60,
    shipping: {
      A1: 40,
      A2: 3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 600, // W, elemental sulfur
        inhalation_D: 20000, // Vapor
        inhalation_W: 2000
      },
      DAC: {
        inhalation_D: 7e-6,
        inhalation_W: 9e-7
      },
      DCF: {
        ingestion: 0, // Organic
        inhalation_D: 8.15e-11, // Vapor
        inhalation_W: 6.69e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_low_risk'
  },
    {
    name: 'Tantalum-182',
    symbol: 'Ta-182',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.526 MeV (max)'],
      gamma: ['1.121 MeV', '1.221 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.175 MeV',
    halfLife: '114.4 days',
    decayConstant: '0.00606 day⁻¹',
    specificActivity: '5.2 x 10^14 Bq/g',
    parent: 'Tantalum-181 (n,γ)',
    daughter: 'Tungsten-182 (stable)',
    commonUses: ['Radiography of heavy metals', 'Calibration sources'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'Used for specialized industrial radiography of dense materials.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.9,
      A2: 0.5,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 800,
        inhalation_W: 300,
        inhalation_Y: 100
      },
      DAC: {
        inhalation_W: 1e-7,
        inhalation_Y: 6e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 5.88e-9,
        inhalation_Y: 1.21e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Technetium-99',
    symbol: 'Tc-99',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.294 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.098 MeV',
    halfLife: '211,100 years',
    decayConstant: '3.28 x 10⁻⁶ year⁻¹',
    specificActivity: '6.3 x 10^8 Bq/g',
    parent: 'Technetium-99m',
    daughter: 'Ruthenium-99 (stable)',
    commonUses: ['Daughter product of Tc-99m', 'Environmental tracer', 'Long-lived fission product in nuclear waste'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'The long-lived daughter of Tc-99m, relevant in nuclear waste management and environmental studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 0.9,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_D: 5000,
        inhalation_W: 700
      },
      DAC: {
        inhalation_D: 2e-6,
        inhalation_W: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.77e-10,
        inhalation_W: 2.25e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Technetium-99m',
    symbol: 'Tc-99m',
    emissionType: ['Gamma', 'Isomeric Transition'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.1405 MeV'],
      alpha: []
    },
    halfLife: '6.01 hours',
    decayConstant: '0.115 hour⁻¹',
    specificActivity: '1.95 x 10^17 Bq/g',
    parent: 'Molybdenum-99',
    daughter: 'Technetium-99',
    commonUses: ['Medical diagnostic imaging (most common medical isotope for various scans: bone, heart, kidney, brain, etc.)'],
    category: 'Medical',
    commonality: 'Common',
    commonalityReason: 'The most widely used medical radioisotope for diagnostic imaging procedures worldwide.',
    sourceRef: {
      halfLife: 'nndc',
      decayConstant: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 4,
      unit: 'TBq'
    },
    gammaConstant: '0.1227 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      decayConstant: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    dosimetry: {
      ALI: {
        ingestion: 80000,
        inhalation_D: 200000,
        inhalation_W: 200000
      },
      DAC: {
        inhalation_D: 6e-5,
        inhalation_W: 1e-4
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 8.80e-12,
        inhalation_W: 7.21e-12
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Tellurium-123m',
    symbol: 'Te-123m',
    emissionType: ['Isomeric Transition', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.159 MeV'],
      alpha: []
    },
    halfLife: '119.7 days',
    decayConstant: '0.00579 day⁻¹',
    specificActivity: '4.1 x 10^14 Bq/g',
    parent: 'Antimony-123',
    daughter: 'Tellurium-123 (stable)',
    commonUses: ['Medical imaging (historical)', 'Research tracer'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used historically in medicine but has been replaced by other isotopes.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 8,
      A2: 1,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 600,
        inhalation_D: 200,
        inhalation_W: 500
      },
      DAC: {
        inhalation_D: 9e-8,
        inhalation_W: 2e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.86e-9,
        inhalation_W: 2.86e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Tellurium-128',
    symbol: 'Te-128',
    emissionType: ['Double Beta-minus'],
    emissionEnergies: {
      beta: ['0.867 MeV (total)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.289 MeV',
    halfLife: '2200000000000000000000000 years',
    decayConstant: '3.15 x 10⁻²⁵ year⁻¹',
    specificActivity: '1.25 x 10^-7 Bq/g',
    parent: 'Primordial',
    daughter: 'Xenon-128 (stable)',
    commonUses: ['Longest measured half-life', 'Fundamental physics research'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'Notable for having one of the longest measured half-lives of any isotope.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Tellurium-130',
    symbol: 'Te-130',
    emissionType: ['Double Beta-minus'],
    emissionEnergies: {
      beta: ['2.528 MeV (total)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.843 MeV',
    halfLife: '2500000000000000000000 years',
    decayConstant: '2.77 x 10⁻²² year⁻¹',
    specificActivity: '1.6 x 10^-5 Bq/g',
    parent: 'Primordial',
    daughter: 'Xenon-130 (stable)',
    commonUses: ['Double beta decay research'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An isotope with an extremely long half-life used in fundamental physics research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Terbium-161',
    symbol: 'Tb-161',
    emissionType: ['Beta-minus', 'Gamma', 'Auger electron'],
    emissionEnergies: {
      beta: ['0.593 MeV (max)'],
      gamma: ['0.049 MeV', '0.075 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.198 MeV',
    halfLife: '6.89 days',
    decayConstant: '0.101 day⁻¹',
    specificActivity: '4.4 x 10^14 Bq/g',
    commonUses: ['Theranostics (combined therapy and diagnostics), particularly for cancer treatment research.'],
    parent: 'Gadolinium-160 (n,γ)',
    daughter: 'Dysprosium-161 (stable)',
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A promising research isotope for targeted radionuclide therapy due to its ideal decay properties.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 2000
      },
      DAC: {
        inhalation_W: 7e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 9.20e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  
  {
    name: 'Thallium-201',
    symbol: 'Tl-201',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.167 MeV', '0.135 MeV'],
      alpha: []
    },
    halfLife: '73.1 hours',
    decayConstant: '0.00948 hour⁻¹',
    specificActivity: '1.74 x 10^15 Bq/g',
    parent: 'Lead-201',
    daughter: 'Mercury-201 (stable)',
    commonUses: ['Cardiac imaging (myocardial perfusion)', 'Parathyroid gland imaging'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A once-common SPECT agent for cardiac imaging, still used for certain applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    gammaConstant: '0.045 R·m²/hr·Ci', // (Mostly X-rays)
    dValue: 1,
    shipping: {
      A1: 10,
      A2: 4,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 20000,
        inhalation_D: 20000
      },
      DAC: {
        inhalation_D: 9e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.34e-11
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Thallium-204',
    symbol: 'Tl-204',
    emissionType: ['Beta-minus', 'Electron Capture'],
    emissionEnergies: {
      beta: ['0.763 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.254 MeV',
    halfLife: '3.78 years',
    decayConstant: '0.183 year⁻¹',
    specificActivity: '1.6 x 10^13 Bq/g',
    parent: 'Lead-204 (d,2n)',
    daughter: 'Lead-204 (stable) or Mercury-204 (stable)',
    commonUses: ['Calibration sources (beta)', 'Thickness gauging'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived pure beta-emitter used in specialized industrial gauges.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.7,
      unit: 'TBq'
    },
     dValue: 20,
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 2000
      },
      DAC: {
        inhalation_D: 9e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.5e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Thallium-205',
    symbol: 'Tl-205',
    emissionType: ['Stable'],
    emissionEnergies: {
      alpha: [],
      beta: [],
      gamma: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    specificActivity: '0 Bq/g',
    parent: 'Bismuth-209 (α)',
    daughter: 'Stable',
    commonUses: ['Final stable product of Bismuth-209 decay', 'Nuclear Magnetic Resonance (NMR) research', 'Target material for isotope production'],
    category: 'Stable/Reference',
    commonality: 'Common',
    commonalityReason: 'The stable end-product of the extremely long-lived Bi-209.',
    sourceRef: {
      halfLife: 'nndc'
    },
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Thallium-207',
    symbol: 'Tl-207',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['1.42 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.473 MeV',
    halfLife: '4.77 minutes',
    decayConstant: '0.145 min⁻¹',
    specificActivity: '1.5 x 10^18 Bq/g',
    parent: 'Bismuth-211',
    daughter: 'Lead-207 (stable)',
    commonUses: ['Intermediate in Actinium-227 decay series'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'A very short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Thallium-208',
    symbol: 'Tl-208',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['1.80 MeV (max)'],
      gamma: ['2.614 MeV (dominant)', '0.583 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.600 MeV',
    halfLife: '3.053 minutes',
    decayConstant: '0.227 min⁻¹',
    specificActivity: '2.4 x 10^18 Bq/g',
    parent: 'Bismuth-212 (α)',
    daughter: 'Lead-208 (stable)',
    commonUses: ['High-energy gamma source in natural background'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A daughter in the Th-232 series, notable for emitting one of the highest-energy natural gamma rays (2.6 MeV).',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Thorium-227',
    symbol: 'Th-227',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['6.038 MeV'],
      beta: [],
      gamma: ['0.236 MeV']
    },
    halfLife: '18.72 days',
    decayConstant: '0.037 day⁻¹',
    specificActivity: '1.2 x 10^15 Bq/g',
    parent: 'Actinium-227',
    daughter: 'Radium-223 (α)',
    commonUses: ['Intermediate in Actinium-227 decay series', 'Alpha therapy research'],
    category: 'Natural',
    commonality: 'Rare',
    commonalityReason: 'An alpha-emitter in the U-235 decay series, used in targeted alpha therapy research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.005,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 100,
        inhalation_W: 0.3,
        inhalation_Y: 0.3
      },
      DAC: {
        inhalation_W: 1e-10,
        inhalation_Y: 1e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 4.12e-6,
        inhalation_Y: 4.37e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Thorium-228',
    symbol: 'Th-228',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.423 MeV'],
      beta: [],
      gamma: ['0.084 MeV']
    },
    daughterEmissions: {
      from: 'Ra-224',
      alpha: ['5.685 MeV'],
      gamma: ['0.241 MeV']
    },
    halfLife: '1.91 years',
    decayConstant: '0.363 year⁻¹',
    specificActivity: '3.0 x 10^13 Bq/g',
    parent: 'Actinium-228',
    daughter: 'Radium-224 (α)',
    commonUses: ['Intermediate in Thorium-232 decay chain', 'Calibration sources'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A key alpha-emitting member of the Th-232 decay series.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.5,
      A2: 0.001,
      unit: 'TBq'
    },
    dValue: 0.4,
    dosimetry: {
      ALI: {
        ingestion: 6, // Bone Surface 10
        inhalation_W: 0.01,
        inhalation_Y: 0.02
      },
      DAC: {
        inhalation_W: 4e-12,
        inhalation_Y: 7e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 6.75e-5,
        inhalation_Y: 9.23e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Thorium-229',
    symbol: 'Th-229',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.845 MeV'],
      beta: [],
      gamma: ['0.029 MeV', '0.194 MeV']
    },
    halfLife: '7,340 years',
    decayConstant: '9.44 x 10⁻⁵ year⁻¹',
    specificActivity: '7.9 x 10^9 Bq/g',
    parent: 'Uranium-233',
    daughter: 'Radium-225 (α)',
    commonUses: ['Parent for Actinium-225 generators', 'Research in nuclear clocks due to its low-energy isomeric state'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A long-lived alpha emitter used to produce Ac-225 generators and for advanced physics research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 5,
      A2: 0.0005,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 0.6, // Bone surface 1
        inhalation_W: 9e-4,
        inhalation_Y: 2e-3
      },
      DAC: {
        inhalation_W: 4e-13,
        inhalation_Y: 1e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 5.80e-4,
        inhalation_Y: 4.67e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_very_high'
  },
  {
    name: 'Thorium-230',
    symbol: 'Th-230',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.688 MeV'],
      beta: [],
      gamma: ['0.067 MeV']
    },
    halfLife: '75,400 years',
    decayConstant: '9.19 x 10⁻⁶ year⁻¹',
    specificActivity: '7.6 x 10^8 Bq/g',
    parent: 'Uranium-234',
    daughter: 'Radium-226 (α)',
    commonUses: ['Dating of marine sediments', 'Component of natural decay series'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'A long-lived member of the U-238 decay series, used in geological dating.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.001,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4, // Bone surface 9
        inhalation_W: 0.006,
        inhalation_Y: 0.02
      },
      DAC: {
        inhalation_W: 3e-12,
        inhalation_Y: 6e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 8.80e-5,
        inhalation_Y: 7.07e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'transuranics',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Thorium-231',
    symbol: 'Th-231',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.39 MeV (max)'],
      gamma: ['0.084 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.130 MeV',
    halfLife: '25.52 hours',
    decayConstant: '0.0272 hour⁻¹',
    specificActivity: '2.6 x 10^16 Bq/g',
    parent: 'Uranium-235',
    daughter: 'Protactinium-231',
    commonUses: ['Intermediate in U-235 decay chain'],
    category: 'Natural',
    decaySeriesId: 'U-235-series',
    commonality: 'Rare',
    commonalityReason: 'A short-lived intermediate in a natural decay chain.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 0.02,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_W: 6000,
        inhalation_Y: 6000
      },
      DAC: {
        inhalation_W: 3e-6,
        inhalation_Y: 3e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.33e-10,
        inhalation_Y: 2.37e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Thorium-232',
    symbol: 'Th-232',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.012 MeV'],
      beta: [],
      gamma: ['0.059 MeV']
    },
    daughterEmissions: {
      from: 'Ra-228',
      beta: ['0.039 MeV (max)']
    },
    halfLife: '14.05 billion years',
    decayConstant: '4.93 x 10⁻¹¹ year⁻¹',
    specificActivity: '4,059 Bq/g',
    parent: 'Primordial',
    daughter: 'Radium-228 (α)',
    commonUses: ['Nuclear fuel cycle (fertile material)', 'Gas mantles (historical)', 'Welding electrodes', 'Thoriated optics', 'Catalysis'],
    category: 'Natural',
    decaySeriesId: 'Th-232-series',
    commonality: 'Common',
    commonalityReason: 'A primordial, naturally occurring fertile isotope that is the head of its own decay series.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 'unlimited',
      A2: 'unlimited',
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 0.7, // Bone Surface 2
        inhalation_W: 0.001,
        inhalation_Y: 0.003
      },
      DAC: {
        inhalation_W: 5e-13,
        inhalation_Y: 1e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 4.43e-4,
        inhalation_Y: 3.11e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'sr_90',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Thorium-234',
    symbol: 'Th-234',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.193 MeV (max)'],
      gamma: ['0.063 MeV', '0.093 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.064 MeV',
    daughterEmissions: {
      from: 'Pa-234m',
      beta: ['2.29 MeV (max)'],
      gamma: ['1.001 MeV']
    },
    halfLife: '24.10 days',
    decayConstant: '0.0287 day⁻¹',
    specificActivity: '8.2 x 10^14 Bq/g',
    parent: 'Uranium-238',
    daughter: 'Protactinium-234m (β-)',
    commonUses: ['Intermediate in U-238 decay chain'],
    category: 'Natural',
    commonality: 'Moderate',
    commonalityReason: 'The first daughter of U-238, often found in equilibrium with its parent in natural samples.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.3,
      A2: 0.3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 300, // Y
        inhalation_W: 200,
        inhalation_Y: 200
      },
      DAC: {
        inhalation_W: 8e-8,
        inhalation_Y: 6e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 8.04e-9,
        inhalation_Y: 9.47e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Thulium-170',
    symbol: 'Tm-170',
    emissionType: ['Beta-minus', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: ['0.968 MeV (max)'],
      gamma: ['0.084 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.323 MeV',
    halfLife: '128.6 days',
    decayConstant: '0.00539 day⁻¹',
    specificActivity: '1.02 x 10^15 Bq/g',
    parent: 'Erbium-170',
    daughter: 'Ytterbium-170 (stable)',
    commonUses: ['Portable industrial radiography', 'Brachytherapy', 'Medical imaging (historical)'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A versatile isotope used for portable radiography and some brachytherapy applications.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 3,
      A2: 0.6,
      unit: 'TBq'
    },
    dValue: 20,
    dosimetry: {
      ALI: {
        ingestion: 800,
        inhalation_W: 200
      },
      DAC: {
        inhalation_W: 9e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 7.11e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
 
  {
    name: 'Tin-117m',
    symbol: 'Sn-117m',
    emissionType: ['Isomeric Transition', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.159 MeV'],
      alpha: []
    },
    halfLife: '13.76 days',
    decayConstant: '0.0504 day⁻¹',
    specificActivity: '4.8 x 10^15 Bq/g',
    parent: 'Tin-116 (n,γ)',
    daughter: 'Tin-117 (stable)',
    commonUses: ['Bone pain palliation for metastatic cancer.', 'Radiosynovectomy.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A therapeutic isotope used for treating bone pain and in radiosynovectomy.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 7,
      A2: 0.4,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 1000,
        inhalation_W: 1000
      },
      DAC: {
        inhalation_D: 5e-7,
        inhalation_W: 6e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.96e-10,
        inhalation_W: 1.17e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Tin-126',
    symbol: 'Sn-126',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.380 MeV (max)'],
      gamma: ['0.087 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.127 MeV',
    halfLife: '230,000 years',
    decayConstant: '3.01 x 10⁻⁶ year⁻¹',
    specificActivity: '1.4 x 10^9 Bq/g',
    parent: 'Cadmium-126',
    daughter: 'Antimony-126 (β-)',
    commonUses: ['Long-lived fission product', 'Nuclear waste assessment'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'An extremely long-lived fission product relevant in nuclear waste management.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.6,
      A2: 0.4,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 300,
        inhalation_D: 60,
        inhalation_W: 70
      },
      DAC: {
        inhalation_D: 2e-8,
        inhalation_W: 3e-8
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.36e-8,
        inhalation_W: 2.69e-8
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Tritium',
    symbol: 'H-3',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['0.0186 MeV (max)'],
      gamma: [],
      alpha: []
    },
    avgBetaEnergy: '0.006 MeV',
    halfLife: '12.32 years',
    decayConstant: '0.0563 year⁻¹',
    specificActivity: '3.59 x 10^14 Bq/g',
    parent: 'Lithium-6 (n,α)',
    daughter: 'Helium-3 (stable)',
    commonUses: ['Self-powered lighting (e.g., exit signs, watches)', 'Medical and biological tracer', 'Nuclear weapons component'],
    category: 'Industrial',
    commonality: 'Common',
    commonalityReason: 'Widely used in self-powered lighting (e.g., exit signs), as a biological tracer, and in nuclear weapons.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 40,
      unit: 'TBq'
    },
    dValue: 2000,
    dosimetry: {
      ALI: {
        ingestion: 80000,
        inhalation_D: 80000 // HTO
      },
      DAC: {
        inhalation_D: 2e-5
      },
      DCF: {
        ingestion: 1.73e-11,
        inhalation_D: 1.73e-11 // Water vapor
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_low_risk'
  },
    {
    name: 'Tungsten-188',
    symbol: 'W-188',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.349 MeV (max)'],
      gamma: ['0.227 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.116 MeV',
    daughterEmissions: {
      from: 'Re-188',
      beta: ['2.12 MeV (max)'],
      gamma: ['0.155 MeV']
    },
    halfLife: '69.4 days',
    decayConstant: '0.00999 day⁻¹',
    specificActivity: '3.6 x 10^14 Bq/g',
    parent: 'Tantalum-186',
    daughter: 'Rhenium-188',
    commonUses: ['Generator for Rhenium-188, used in therapeutic applications.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'The parent isotope used in generators to produce the therapeutic isotope Re-188.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.4,
      A2: 0.3,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 400,
        inhalation_D: 1000
      },
      DAC: {
        inhalation_D: 5e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.11e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Uranium-230',
    symbol: 'U-230',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.888 MeV'],
      beta: [],
      gamma: ['0.053 MeV']
    },
    halfLife: '20.8 days',
    decayConstant: '0.0333 day⁻¹',
    specificActivity: '1.87 x 10^15 Bq/g',
    parent: 'Plutonium-234 (α)',
    daughter: 'Thorium-226',
    commonUses: ['Medical isotope production (e.g., Ra-223 from Th-226 generator)', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A research isotope sometimes used in generators to produce medical alpha-emitters.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 30,
      A2: 0.003,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4,
        inhalation_D: 0.4,
        inhalation_W: 0.4,
        inhalation_Y: 0.3
      },
      DAC: {
        inhalation_D: 2e-10,
        inhalation_W: 1e-10,
        inhalation_Y: 1e-10
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 2.32e-6,
        inhalation_W: 4.36e-6,
        inhalation_Y: 5.26e-6
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Uranium-231',
    symbol: 'U-231',
    emissionType: ['Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.084 MeV', '0.143 MeV'],
      alpha: []
    },
    halfLife: '4.2 days',
    decayConstant: '0.165 day⁻¹',
    specificActivity: '1.27 x 10^16 Bq/g',
    parent: 'Neptunium-231 (EC)',
    daughter: 'Protactinium-231',
    commonUses: ['Intermediate in nuclear research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A short-lived isotope encountered only in specialized nuclear research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dosimetry: {
      ALI: {
        ingestion: 5000,
        inhalation_D: 8000,
        inhalation_W: 6000,
        inhalation_Y: 5000
      },
      DAC: {
        inhalation_D: 3e-6,
        inhalation_W: 2e-6,
        inhalation_Y: 2e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 1.79e-10,
        inhalation_W: 2.78e-10,
        inhalation_Y: 3.22e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Uranium-232',
    symbol: 'U-232',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['5.320 MeV'],
      beta: [],
      gamma: ['0.058 MeV']
    },
    daughterEmissions: {
      from: 'Th-228',
      alpha: ['5.423 MeV'],
      gamma: ['0.084 MeV']
    },
    halfLife: '68.9 years',
    decayConstant: '0.0101 year⁻¹',
    specificActivity: '8.1 x 10^11 Bq/g',
    parent: 'Plutonium-236 (α)',
    daughter: 'Thorium-228 (α)',
    commonUses: ['Contaminant in U-233 from thorium fuel cycle', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'An isotope primarily known as a problematic contaminant in the thorium fuel cycle due to its high-energy gamma daughters.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 10,
      A2: 0.001,
      unit: 'TBq'
    },
    dValue: 0.3,
    dosimetry: {
      ALI: {
        ingestion: 2,
        inhalation_D: 0.2,
        inhalation_W: 0.4,
        inhalation_Y: 0.008
      },
      DAC: {
        inhalation_D: 9e-11,
        inhalation_W: 2e-10,
        inhalation_Y: 3e-12
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.43e-6,
        inhalation_W: 4.02e-6,
        inhalation_Y: 1.78e-4
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Uranium-233',
    symbol: 'U-233',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.824 MeV'],
      beta: [],
      gamma: ['0.042 MeV', '0.312 MeV']
    },
    halfLife: '159,200 years',
    decayConstant: '4.35 x 10⁻⁶ year⁻¹',
    specificActivity: '3.56 x 10^8 Bq/g',
    parent: 'Protactinium-233',
    daughter: 'Thorium-229 (α)',
    commonUses: ['Thorium fuel cycle (fissile material)', 'Research'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A fissile isotope that can be bred from Thorium-232, central to thorium fuel cycle research.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 0.006,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 10,
        inhalation_D: 1,
        inhalation_W: 0.7,
        inhalation_Y: 0.04
      },
      DAC: {
        inhalation_D: 5e-10,
        inhalation_W: 3e-10,
        inhalation_Y: 2e-11
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 7.53e-7,
        inhalation_W: 2.16e-6,
        inhalation_Y: 3.66e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Uranium-234',
    symbol: 'U-234',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.776 MeV'],
      beta: [],
      gamma: ['0.053 MeV']
    },
    halfLife: '245,500 years',
    decayConstant: '2.82 x 10⁻⁶ year⁻¹',
    specificActivity: '2.3 x 10^8 Bq/g',
    parent: 'Protactinium-234m (β-)',
    daughter: 'Thorium-230',
    commonUses: ['Component of natural uranium', 'Geological dating (uranium-thorium dating)'],
    category: 'Natural',
    decaySeriesId: 'U-238-series',
    commonality: 'Moderate',
    commonalityReason: 'A member of the U-238 decay series present in all natural uranium.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 40,
      A2: 0.006,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 10,
        inhalation_D: 1,
        inhalation_W: 0.7,
        inhalation_Y: 0.04
      },
      DAC: {
        inhalation_D: 5e-10,
        inhalation_W: 3e-10,
        inhalation_Y: 2e-11
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 7.37e-7,
        inhalation_W: 2.13e-6,
        inhalation_Y: 3.58e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Uranium-235',
    symbol: 'U-235',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.398 MeV'],
      beta: [],
      gamma: ['0.186 MeV', '0.144 MeV']
    },
    daughterEmissions: {
      from: 'Th-231',
      beta: ['0.39 MeV (max)'],
      gamma: ['0.084 MeV']
    },
    halfLife: '703.8 million years',
    decayConstant: '9.85 x 10⁻¹⁰ year⁻¹',
    specificActivity: '8.0 x 10^4 Bq/g',
    parent: 'Primordial',
    daughter: 'Thorium-231 (α)',
    commonUses: ['Nuclear fuel for reactors', 'Nuclear weapons'],
    category: 'Natural',
    decaySeriesId: 'U-235-series',
    commonality: 'Common',
    commonalityReason: 'The primary fissile isotope of uranium, used for nuclear power generation and weapons.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 'unlimited',
      A2: 'unlimited',
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 10,
        inhalation_D: 1,
        inhalation_W: 0.8,
        inhalation_Y: 0.04
      },
      DAC: {
        inhalation_D: 6e-10,
        inhalation_W: 3e-10,
        inhalation_Y: 2e-11
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.85e-7,
        inhalation_W: 1.97e-6,
        inhalation_Y: 3.32e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Uranium-238',
    symbol: 'U-238',
    emissionType: ['Alpha', 'Gamma'],
    emissionEnergies: {
      alpha: ['4.197 MeV'],
      beta: [],
      gamma: ['0.0496 MeV']
    },
    daughterEmissions: {
      from: 'Th-234',
      beta: ['0.193 MeV (max)'],
      gamma: ['0.063 MeV', '0.093 MeV']
    },
    halfLife: '4.468 billion years',
    decayConstant: '1.55 x 10⁻¹⁰ year⁻¹',
    specificActivity: '1.24 x 10^4 Bq/g',
    parent: 'Primordial',
    daughter: 'Thorium-234 (α)',
    commonUses: ['Geological dating', 'Nuclear fuel cycle (raw material)', 'Shielding (depleted uranium)'],
    category: 'Natural',
    decaySeriesId: 'U-238-series',
    commonality: 'Common',
    commonalityReason: 'The most abundant isotope of natural uranium (>99%) and the head of a primary natural decay series.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 'unlimited',
      A2: 'unlimited',
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 10,
        inhalation_D: 1,
        inhalation_W: 0.8,
        inhalation_Y: 0.04
      },
      DAC: {
        inhalation_D: 6e-10,
        inhalation_W: 3e-10,
        inhalation_Y: 2e-11
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.62e-7,
        inhalation_W: 1.90e-6,
        inhalation_Y: 3.20e-5
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'u_nat',
    ansiCategory: 'alpha_high'
  },
  {
    name: 'Xenon-131',
    symbol: 'Xe-131',
    emissionType: ['Stable'],
    emissionEnergies: {
      alpha: [],
      beta: [],
      gamma: []
    },
    halfLife: 'Stable',
    decayConstant: '0',
    specificActivity: '0 Bq/g',
    parent: 'Iodine-131 (β-)',
    daughter: 'Stable',
    commonUses: ['Stable end-product of Iodine-131 decay.', 'Stable isotope analysis.'],
    category: 'Stable/Reference',
    commonality: 'Common',
    commonalityReason: 'The stable end-product of I-131 decay, a very common medical isotope.',
    sourceRef: {},
    regGuideCategory: null,
    ansiCategory: null
  },
  {
    name: 'Xenon-133',
    symbol: 'Xe-133',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.346 MeV (max)'],
      gamma: ['0.081 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.115 MeV',
    halfLife: '5.24 days',
    decayConstant: '0.132 day⁻¹',
    specificActivity: '6.4 x 10^15 Bq/g',
    parent: 'Uranium Fission',
    daughter: 'Cesium-133 (stable)',
    commonUses: ['Lung ventilation studies (medical imaging)', 'Blood flow measurements'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A radioactive noble gas widely used for lung ventilation studies in nuclear medicine.',
    sourceRef: {
      halfLife: 'nndc'
    },
    dValue: 200,
    shipping: {
      A1: 20,
      A2: 10,
      unit: 'TBq'
    },
    dosimetry: {
      DAC: {
        inhalation: 1e-4 // Submersion
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
   {
    name: 'Ytterbium-169',
    symbol: 'Yb-169',
    emissionType: ['Electron Capture', 'Gamma', 'X-ray'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.198 MeV', '0.261 MeV', '0.308 MeV'],
      alpha: []
    },
    halfLife: '32.02 days',
    decayConstant: '0.0216 day⁻¹',
    gammaConstant: '0.326969 R·m²/hr·Ci',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    specificActivity: '1.9 x 10^14 Bq/g',
    parent: 'Lutetium-169',
    daughter: 'Thulium-169 (stable)',
    commonUses: ['Medical imaging (historical)', 'Brain and CSF studies', 'Industrial radiography'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'Used for specialized, small-format industrial radiography and historically in medicine.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'hps'
    },
    shipping: {
      A1: 4,
      A2: 1,
      unit: 'TBq'
    },
    dValue: 0.3,
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_W: 800,
        inhalation_Y: 700
      },
      DAC: {
        inhalation_W: 4e-7,
        inhalation_Y: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 1.89e-9,
        inhalation_Y: 2.18e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
    {
    name: 'Yttrium-90',
    symbol: 'Y-90',
    emissionType: ['Beta-minus'],
    emissionEnergies: {
      beta: ['2.28 MeV (max)'],
      gamma: [],
      alpha: []
    },
     avgBetaEnergy: '0.934 MeV',
    halfLife: '64.0 hours',
    decayConstant: '0.0108 hour⁻¹',
    specificActivity: '1.21 x 10^16 Bq/g',
    parent: 'Strontium-90',
    daughter: 'Zirconium-90 (stable)',
    commonUses: ['Radioembolization (liver cancer therapy)', 'Radioimmunotherapy', 'Brachytherapy'],
    category: 'Medical',
    commonality: 'Moderate',
    commonalityReason: 'A high-energy pure beta-emitter used for liver cancer therapy and other treatments.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 0.3,
      A2: 0.3,
      unit: 'TBq'
    },
    dValue: 1,
    dosimetry: {
      ALI: {
        ingestion: 400,
        inhalation_W: 700,
        inhalation_Y: 600
      },
      DAC: {
        inhalation_W: 3e-7,
        inhalation_Y: 3e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_W: 2.13e-9,
        inhalation_Y: 2.28e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
{
    name: 'Zinc-65',
    symbol: 'Zn-65',
    emissionType: ['Electron Capture', 'Positron Emission', 'Gamma'],
    emissionEnergies: {
      beta: ['0.329 MeV (Positron max, 1.4%)'],
      gamma: ['1.115 MeV (50%)'],
      alpha: []
    },
    halfLife: '244.3 days',
    decayConstant: '0.00284 day⁻¹',
    specificActivity: '3.0 x 10^14 Bq/g',
    parent: 'Zinc-64 (n,γ)',
    daughter: 'Copper-65 (stable)',
    commonUses: ['Activation product', 'Tracer', 'Environmental monitor'],
    category: 'Industrial',
    commonality: 'Moderate',
    commonalityReason: 'A common neutron activation product found in reactor components.',
    sourceRef: {
      halfLife: 'nndc',
      gammaConstant: 'plexus_nsd'
    },
    shipping: { A1: 2, A2: 2, unit: 'TBq' },
    dValue: 0.2, // IAEA EPR-D-Values
    gammaConstant: '0.330188 R·m²/hr·Ci',
    dosimetry: {
      ALI: { ingestion: 400, inhalation_Y: 300 },
      DAC: { inhalation_Y: 1e-7 },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Zinc-69m',
    symbol: 'Zn-69m',
    emissionType: ['Isomeric Transition', 'Gamma'],
    emissionEnergies: {
      beta: [],
      gamma: ['0.439 MeV'],
      alpha: []
    },
    halfLife: '13.76 hours',
    decayConstant: '0.0504 hour⁻¹',
    specificActivity: '4.8 x 10^16 Bq/g',
    parent: 'Zinc-69',
    daughter: 'Zinc-69',
    commonUses: ['Zinc metabolism studies (historical)'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'Used historically as a tracer for zinc metabolism but has been replaced by other methods.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 3,
      A2: 0.6,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 4000,
        inhalation_Y: 7000
      },
      DAC: {
        inhalation_Y: 3e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_Y: 2.20e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Zirconium-89',
    symbol: 'Zr-89',
    emissionType: ['Positron Emission', 'Electron Capture', 'Gamma'],
    emissionEnergies: {
      beta: ['0.902 MeV (max)'],
      gamma: ['0.909 MeV', '0.511 MeV (annihilation)'],
      alpha: []
    },
    avgBetaEnergy: '0.301 MeV',
    halfLife: '78.41 hours',
    decayConstant: '0.00884 hour⁻¹',
    specificActivity: '1.18 x 10^16 Bq/g',
    parent: 'Yttrium-89 (p,n)',
    daughter: 'Yttrium-89 (stable)',
    commonUses: ['PET imaging, particularly for antibody-based imaging (immuno-PET) due to its longer half-life.'],
    category: 'Medical',
    commonality: 'Rare',
    commonalityReason: 'A PET isotope with a relatively long half-life, making it ideal for antibody-based imaging (immuno-PET).',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {

    },
    dosimetry: {
      ALI: {
        ingestion: 2000,
        inhalation_D: 4000,
        inhalation_W: 2000,
        inhalation_Y: 2000
      },
      DAC: {
        inhalation_D: 1e-6,
        inhalation_W: 1e-6,
        inhalation_Y: 1e-6
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 3.88e-10,
        inhalation_W: 6.06e-10,
        inhalation_Y: 6.41e-10
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  },
  {
    name: 'Zirconium-95',
    symbol: 'Zr-95',
    emissionType: ['Beta-minus', 'Gamma'],
    emissionEnergies: {
      beta: ['0.399 MeV (max)'],
      gamma: ['0.724 MeV', '0.757 MeV'],
      alpha: []
    },
    avgBetaEnergy: '0.133 MeV',
    daughterEmissions: {
      from: 'Nb-95',
      beta: ['0.160 MeV (max)'],
      gamma: ['0.766 MeV']
    },
    halfLife: '64.03 days',
    decayConstant: '0.0108 day⁻¹',
    specificActivity: '8.8 x 10^14 Bq/g',
    parent: 'Uranium Fission',
    daughter: 'Niobium-95',
    commonUses: ['Fission product', 'Environmental tracer'],
    category: 'Industrial',
    commonality: 'Rare',
    commonalityReason: 'A common fission product used as a tracer in environmental and fallout studies.',
    sourceRef: {
      halfLife: 'nndc'
    },
    shipping: {
      A1: 2,
      A2: 0.8,
      unit: 'TBq'
    },
    dosimetry: {
      ALI: {
        ingestion: 1000,
        inhalation_D: 100,
        inhalation_W: 400,
        inhalation_Y: 300
      },
      DAC: {
        inhalation_D: 5e-8,
        inhalation_W: 2e-7,
        inhalation_Y: 1e-7
      },
      DCF: {
        ingestion: 0,
        inhalation_D: 6.39e-9,
        inhalation_W: 4.29e-9,
        inhalation_Y: 6.31e-9
      },
      sourceRef: '10CFR20'
    },
    regGuideCategory: 'beta_gamma',
    ansiCategory: 'beta_gamma'
  }
];
      </script>
      <script type="text/babel">
         /**
               * Radionuclide Database Tool - Core Data and Utility Functions
               * -----------------------------------------------------------
               * This script contains the core data structures, constants, and utility
               * functions for the radionuclide database application. It includes
               * decay series data, SVG icon paths, and various parsers for handling
               * physical quantities like half-life and energy.
               */
              
              //==============================================================================
              // --- APPLICATION METADATA & CONSTANTS
              //==============================================================================
              
              const VERSION = '3.8.2';
              const LAST_UPDATED = 'December 17th, 2025';
              
              // NEW: A global constant for all navigation views
              
              const VIEWS = {
              HOME: 'home',
              DATABASE: 'database',
              COMPARE: 'compare',
              CALCULATOR: 'calculator',
              MDA: 'mda',
              MARSSIM_SAMPLES: 'marssim',
              MARSSIM_TESTS: 'marssimTests',
              WRS_TEST: 'wrs',
              EMC_TEST: 'emc',
              SERIES_CALCULATOR: 'seriesCalculator',
              EQUILIBRIUM: 'equilibrium',
              RADON: 'radon',
              ACTIVITY_MASS: 'activityMassTools',
              DOSE_RATE: 'doseRate',
              SHIELDING: 'shielding',
              STAY_TIME: 'stayTime',
              NEUTRON: 'neutron',
              OPERATIONAL_HP: 'operationalHp',
              TRANSPORTATION: 'transportation',
              CONVERTER: 'converter',
              SETTINGS: 'settings',
              DECAY_SERIES: 'decaySeries',
         DETAIL: 'detail', 
              MEDICAL: 'medical',
              PEAK_ID: 'peakId',
              LAB_STATS: 'labStats',
              SCRATCHPAD: 'scratchpad',
              SCIENTIFIC_CALCULATOR: 'scientificCalculator',
              
              REFERENCES: 'references'
              };
              
              /**
               * Data sources used in the application.
               * Each key is a short identifier, and the value is an object
               * containing the full name and URL of the source.
               */
              
              const sources = {
    nndc: { name: 'NNDC NuDat 3', url: 'https://www.nndc.bnl.gov/nudat3/' },
    wiki: { name: 'Wikipedia', url: 'https://en.wikipedia.org/' },
    hps: { name: 'Health Physics Society', url: 'https://hps.org/' },
    plexus_nsd: { name: 'Plexus-NSD Gamma Constants', url: 'http://www.iem-inc.com/information/tools/gamma-ray-dose-constants' },
    rse: { name: 'Rad. Safety Engineering', url: 'https://www.radpro.com/sourcehvl.htm' },
    '10CFR20': { name: '10 CFR 20 Appendix B', url: 'https://www.nrc.gov/reading-rm/doc-collections/cfr/part020/part020-appb.html' },
    'FGR11': { name: 'EPA Federal Guidance Report No. 11', url: 'https://www.epa.gov/radiation/federal-guidance-report-no-11-limiting-values-radionuclide-intake-and-air-concentration' }
};
              
              /**
              * Configuration for smart unit selection.
              * For each type, it lists units from smallest to largest.
              * - threshold: The value above which the *next* unit in the list is considered.
              * - factor: How many of the current unit are in one base unit (e.g., 1000 mrem in 1 rem).
              */
              
             const SENSIBLE_UNIT_CONFIG = {
             // Conventional Units
             doseRate: {
                 baseUnit: 'mrem/hr',
                 units: [
                     { unit: 'µrem/hr', threshold: 1, factor: 0.001 },
                     { unit: 'mrem/hr', threshold: 1000, factor: 1 },
                     { unit: 'rem/hr',  threshold: Infinity, factor: 1000 }
                 ]
             },
             dose: {
                 baseUnit: 'mrem',
                 units: [
                     { unit: 'µrem', threshold: 1, factor: 0.001 },
                     { unit: 'mrem', threshold: 1000, factor: 1 },
                     { unit: 'rem',  threshold: Infinity, factor: 1000 }
                 ]
             },
             // --- ADDED: SI Unit Configurations ---
             doseRate_si: {
                 baseUnit: 'mSv/hr',
                 units: [
                     { unit: 'µSv/hr', threshold: 1, factor: 0.001 },
                     { unit: 'mSv/hr', threshold: 1000, factor: 1 },
                     { unit: 'Sv/hr',  threshold: Infinity, factor: 1000 }
                 ]
             },
             dose_si: {
                 baseUnit: 'mSv',
                 units: [
                     { unit: 'µSv', threshold: 1, factor: 0.001 },
                     { unit: 'mSv', threshold: 1000, factor: 1 },
                     { unit: 'Sv',  threshold: Infinity, factor: 1000 }
                 ]
             },
             // --- Distance units remain the same ---
             distance: {
                 baseUnit: 'cm',
                 units: [
                     { unit: 'mm', threshold: 1, factor: 0.1 },
                     { unit: 'cm', threshold: 100, factor: 1 },
                     { unit: 'm',  threshold: Infinity, factor: 100 }
                 ]
             },
                          activity_conventional: {
                 baseUnit: 'Ci',
                 units: [
                     { unit: 'µCi', threshold: 1e-3, factor: 1e-6 },
                     { unit: 'mCi', threshold: 1, factor: 1e-3 },
                     { unit: 'Ci', threshold: Infinity, factor: 1 }
                 ]
             },
             activity_si: {
                 baseUnit: 'Bq',
                 units: [
                     { unit: 'Bq', threshold: 1e3, factor: 1 },
                     { unit: 'kBq', threshold: 1e6, factor: 1e3 },
                     { unit: 'MBq', threshold: 1e9, factor: 1e6 },
                     { unit: 'GBq', threshold: 1e12, factor: 1e9 },
                     { unit: 'TBq', threshold: Infinity, factor: 1e12 }
                 ]
             }
         };
              
              // --- MASTER LIST of Smart-Sorted Unit Arrays ---
              
              // For Activity
              
              const activityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'µCi', 'mCi', 'Ci', 'dps', 'dpm'];
              
              // For Dose & Dose Rate
              
              const doseRateUnits_ordered = ['µrem/hr', 'mrem/hr', 'rem/hr', 'R/hr', 'µSv/hr', 'mSv/hr', 'Sv/hr'];
              const doseUnits_ordered = ['µrem', 'mrem', 'rem', 'R', 'µSv', 'mSv', 'Sv'];
              
              // For Distance & Dimensions
              
              const distanceUnits_ordered = ['mm', 'cm', 'm', 'in', 'ft', 'km'];
              const areaUnits_ordered = ['cm²', 'm²', 'in²', 'ft²', 'barn'];
              
              // For Time
              
              const timeUnits_ordered = ['seconds', 'minutes', 'hours', 'days', 'years'];
              const longTimeUnits_ordered = ['seconds', 'minutes', 'hours', 'days', 'years', 'kiloyears', 'megayears', 'gigayears'];
              
              // For Mass
              
              const massUnits_ordered = ['µg', 'mg', 'g', 'kg'];

              // For Shipping (TBq based)
              
              const shippingActivityUnits_ordered = ['Bq', 'kBq', 'MBq', 'GBq', 'TBq', 'µCi', 'mCi', 'Ci'];

              // For Radioactive Concentration

              const concentrationUnits_ordered = ['Bq/L', 'pCi/L', 'Bq/m³', 'µCi/mL'];

              /**
              * Takes a raw value in a base unit and formats it into the most "sensible"
              * larger or smaller unit for display.
              * @param {number} value - The raw numerical value.
              * @param {string} unitType - The type of unit (e.g., 'doseRate', 'distance').
              * @param {number} [precision=3] - The number of significant figures to use.
              * @returns {{value: string, unit: string}} An object with the formatted value and the chosen unit.
              */
              
              const formatSensibleUnit = (value, unitType, precision = 3) => {
              const config = SENSIBLE_UNIT_CONFIG[unitType];
              if (!config) {
              return { value: value.toPrecision(precision), unit: '' };
              }
              
              for (const unitInfo of config.units) {
              if (Math.abs(value) < unitInfo.threshold) {
                  const displayValue = value / unitInfo.factor;
                  return {
                      value: displayValue.toPrecision(precision),
                      unit: unitInfo.unit
                  };
              }
              }
              
              const largestUnit = config.units[config.units.length - 1];
              return {
              value: (value / largestUnit.factor).toPrecision(precision),
              unit: largestUnit.unit
              };
              };
              
              const THERAPY_NUCLIDES = ['I-131', 'Lu-177', 'Sm-153', 'Ra-223', 'Ho-166', 'Re-186', 'Au-198', 'I-125', 'Cs-137'];
              
              /**
              * Calculates the area of a polygon given its geographical coordinates.
              * @param {L.LatLng[]} latLngs - An array of Leaflet LatLng objects.
              * @returns {number} The area in square meters.
              */
              const calculatePolygonArea = (latLngs) => {
              if (!latLngs || latLngs.length === 0 || latLngs[0].length < 3) return 0;
              
              const points = latLngs[0];
              const earthRadius = 6378137; // Earth's radius in meters
              let area = 0;
              
              for (let i = 0; i < points.length; i++) {
              const j = (i + 1) % points.length;
              const xi = points[i].lng * Math.PI / 180;
              const yi = points[i].lat * Math.PI / 180;
              const xj = points[j].lng * Math.PI / 180;
              const yj = points[j].lat * Math.PI / 180;
              
              area += (xj - xi) * (2 + Math.sin(yi) + Math.sin(yj));
              }
              return Math.abs(area * earthRadius * earthRadius / 2.0);
              }; 
              
              /**
              * Calculates the distance between two lat lng points in meters using the Haversine formula.
              * @param {{lat: number, lng: number}} p1 - The first point.
              * @param {{lat: number, lng: number}} p2 - The second point.
              * @returns {number} The distance in meters.
              */
              
              const calculateDistance = (p1, p2) => {
              const R = 6371e3; // Earth's radius in meters
              const phi1 = p1.lat * Math.PI / 180;
              const phi2 = p2.lat * Math.PI / 180;
              const deltaPhi = (p2.lat - p1.lat) * Math.PI / 180;
              const deltaLambda = (p2.lng - p1.lng) * Math.PI / 180;
              
              const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                   Math.cos(phi1) * Math.cos(phi2) *
                   Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
              const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
              
              return R * c;
              };
              
         const REG_GUIDE_1_86_LIMITS = {
    'transuranics': { removable: 20, total: 100, label: 'Transuranics, I-125, I-129, Ra-226, Ac-227' },
    'sr_90': { removable: 200, total: 1000, label: 'Th-nat, Sr-90, I-131, Ra-223, Ra-224, U-232' }, // <--- NEW CATEGORY
    'u_nat': { removable: 1000, total: 5000, label: 'U-nat, U-235, U-238, and associated decay products' },
    'beta_gamma': { removable: 1000, total: 5000, label: 'Beta-gamma emitters (nuclides with decay modes other than alpha)' }
};
              
              const ANSI_13_12_LIMITS = {
              'alpha_very_high': { removable: 20, total: 100, label: 'Alpha Emitters (Very High Hazard - e.g., Pu-238, Am-241)' },
              'alpha_high': { removable: 200, total: 1000, label: 'Alpha Emitters (High Hazard - e.g., U-233, U-234)' },
              'beta_low_risk': { removable: 20000, total: 100000, label: 'Low-Hazard Beta Emitters (e.g., H-3, C-14)' },
              'beta_gamma': { removable: 2000, total: 10000, label: 'Other Beta-Gamma Emitters' }
              };
              
              /**
               * Half-Value Layer (HVL) data in cm for common gamma emitters and materials.
               * Source: Approximate values from various health physics resources.
               */
              
const HVL_DATA = {
    'Am-241': { 'Lead': 0.02, 'Steel': 0.8, 'Concrete': 2.3, 'Aluminum': 1.5, 'Water': 4.2, sourceRef: 'rse' },
    'Au-198': { 'Lead': 0.33, 'Steel': 1.4, 'Concrete': 4.7, 'Aluminum': 2.5, 'Water': 6.8, sourceRef: 'rse' },
    'Ba-133': { 'Lead': 0.29, 'Steel': 1.2, 'Concrete': 4.1, 'Aluminum': 2.2, 'Water': 5.8, sourceRef: 'rse' },
    
    'C-11':   { 'Lead': 0.40, 'Steel': 1.1, 'Concrete': 3.4, 'Aluminum': 3.0, 'Water': 7.1, sourceRef: 'rse' },
    
    'Co-60':  { 'Lead': 1.2, 'Tungsten': 0.7, 'Steel': 2.1, 'Concrete': 6.0, 'Aluminum': 4.8, 'Water': 11.0, sourceRef: 'rse' },
    'Cs-137': { 'Lead': 0.65, 'Steel': 1.6, 'Concrete': 4.8, 'Aluminum': 3.0, 'Water': 8.0, sourceRef: 'rse' },
    'Eu-152': { 'Lead': 1.0,  'Steel': 2.0, 'Concrete': 5.8, 'Aluminum': 4.5, 'Water': 10.5, sourceRef: 'rse' },
    
    'F-18':   { 'Lead': 0.40, 'Steel': 1.1, 'Concrete': 3.4, 'Aluminum': 3.0, 'Water': 7.1, sourceRef: 'rse' },
    
    'Ga-67':  { 'Lead': 0.07, 'Steel': 0.8, 'Concrete': 3.0, 'Aluminum': 1.5, 'Water': 4.8, sourceRef: 'rse' },
    
    'Ga-68':  { 'Lead': 0.41, 'Steel': 1.2, 'Concrete': 3.6, 'Aluminum': 3.2, 'Water': 7.5, sourceRef: 'rse' },
    
    'I-125':  { 'Lead': 0.002,'Steel': 0.1, 'Concrete': 1.9, 'Aluminum': 0.6, 'Water': 1.8, sourceRef: 'rse' },
    'I-131':  { 'Lead': 0.3,  'Steel': 1.2, 'Concrete': 4.0, 'Aluminum': 2.2, 'Water': 6.0, sourceRef: 'rse' },
    'Ir-192': { 'Lead': 0.33, 'Steel': 1.3, 'Concrete': 4.3, 'Aluminum': 2.1, 'Water': 6.1, sourceRef: 'rse' },
    'Mn-54':  { 'Lead': 0.8,  'Steel': 1.8, 'Concrete': 5.2, 'Aluminum': 3.6, 'Water': 9.0, sourceRef: 'rse' },
    'Mo-99':  { 'Lead': 0.7,  'Steel': 1.7, 'Concrete': 5.0, 'Aluminum': 3.1, 'Water': 8.2, sourceRef: 'rse' },
    
    'N-13':   { 'Lead': 0.40, 'Steel': 1.1, 'Concrete': 3.4, 'Aluminum': 3.0, 'Water': 7.1, sourceRef: 'rse' },
    
    'Na-22':  { 'Lead': 1.1,  'Steel': 2.0, 'Concrete': 5.8, 'Aluminum': 4.5, 'Water': 10.2, sourceRef: 'rse' },
    'Na-24':  { 'Lead': 1.5,  'Steel': 2.5, 'Concrete': 7.2, 'Aluminum': 6.1, 'Water': 14.5, sourceRef: 'rse' },
    'Ra-226': { 'Lead': 1.4, 'Steel': 2.3, 'Concrete': 6.9, 'Aluminum': 5.5, 'Water': 13.0, sourceRef: 'rse' },
    'Sc-46':  { 'Lead': 1.0,  'Steel': 2.0, 'Concrete': 5.9, 'Aluminum': 4.2, 'Water': 10.0, sourceRef: 'rse' },
    'Tc-99m': { 'Lead': 0.03, 'Steel': 0.3, 'Concrete': 2.2, 'Aluminum': 0.8, 'Water': 4.6, sourceRef: 'rse' }
};
              
              // New constant for Buildup Factor approximations
              
              const BUILDUP_K_FACTORS = {
              'Water': 0.40,
              'Concrete': 0.35,
              'Aluminum': 0.30,
              'Steel': 0.25,
              'Tungsten': 0.15,
              'Lead': 0.10,
              };
              
              const SHIELDING_MATERIALS = {
              'Plastic': { Z: 6, density: 1.18 }, // Using Carbon for approximation
              'Aluminum': { Z: 13, density: 2.70 },
              'Steel': { Z: 26, density: 7.85 }, // Using Iron for approximation
              'Lead': { Z: 82, density: 11.34 },
              'Water': { Z: 8, density: 1.00 }, // Using Oxygen for approximation
              'Concrete': { Z: 11.3, density: 2.35 } // Weighted average of common elements
              };
              
              //==============================================================================
              // --- CORE DATA
              //==============================================================================
              
              /**
               * Defines the primary natural decay chains. Each object represents a series
               * and contains an array of steps in its decay chain.
               */
              
              const decaySeriesData = [
                  {
                      id: 'U-238-series',
                      name: 'Uranium-238 Decay Series (Uranium Series)',
                      startNuclide: 'Uranium-238',
                      chain: [
                          { nuclide: 'Uranium-238', decayType: 'Alpha', halfLife: '4.468 billion years', daughter: 'Thorium-234' },
                          { nuclide: 'Thorium-234', decayType: 'Beta-minus', halfLife: '24.10 days', daughter: 'Protactinium-234m' },
                          { nuclide: 'Protactinium-234m', decayType: 'Beta-minus', halfLife: '1.17 minutes', daughter: 'Uranium-234' },
                          { nuclide: 'Uranium-234', decayType: 'Alpha', halfLife: '245,500 years', daughter: 'Thorium-230' },
                          { nuclide: 'Thorium-230', decayType: 'Alpha', halfLife: '75,400 years', daughter: 'Radium-226' },
                          { nuclide: 'Radium-226', decayType: 'Alpha', halfLife: '1600 years', daughter: 'Radon-222' },
                          { nuclide: 'Radon-222', decayType: 'Alpha', halfLife: '3.82 days', daughter: 'Polonium-218' },
                          { nuclide: 'Polonium-218', decayType: 'Alpha', halfLife: '3.1 minutes', daughter: 'Lead-214' },
                          { nuclide: 'Lead-214', decayType: 'Beta-minus', halfLife: '26.8 minutes', daughter: 'Bismuth-214' },
                          { nuclide: 'Bismuth-214', decayType: 'Beta-minus', halfLife: '19.9 minutes', daughter: 'Polonium-214' },
                          { nuclide: 'Polonium-214', decayType: 'Alpha', halfLife: '164.3 microseconds', daughter: 'Lead-210' },
                          { nuclide: 'Lead-210', decayType: 'Beta-minus', halfLife: '22.2 years', daughter: 'Bismuth-210' },
                          { nuclide: 'Bismuth-210', decayType: 'Beta-minus', halfLife: '5.012 days', daughter: 'Polonium-210' },
                          { nuclide: 'Polonium-210', decayType: 'Alpha', halfLife: '138.376 days', daughter: 'Lead-206' },
                          { nuclide: 'Lead-206', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                      ]
                  },
              
              {
                  id: 'Th-232-series',
                  name: 'Thorium-232 Decay Series (Thorium Series)',
                  startNuclide: 'Thorium-232',
                  chain: [
                      { nuclide: 'Thorium-232', decayType: 'Alpha', halfLife: '14.05 billion years', daughter: 'Radium-228' },
                      { nuclide: 'Radium-228', decayType: 'Beta-minus', halfLife: '5.75 years', daughter: 'Actinium-228' },
                      { nuclide: 'Actinium-228', decayType: 'Beta-minus', halfLife: '6.15 hours', daughter: 'Thorium-228' },
                      { nuclide: 'Thorium-228', decayType: 'Alpha', halfLife: '1.913 years', daughter: 'Radium-224' },
                      { nuclide: 'Radium-224', decayType: 'Alpha', halfLife: '3.63 days', daughter: 'Radon-220' },
                      { nuclide: 'Radon-220', decayType: 'Alpha', halfLife: '55.6 seconds', daughter: 'Polonium-216' },
                      { nuclide: 'Polonium-216', decayType: 'Alpha', halfLife: '0.145 seconds', daughter: 'Lead-212' },
                      { nuclide: 'Lead-212', decayType: 'Beta-minus', halfLife: '10.64 hours', daughter: 'Bismuth-212' },
                      {
                          nuclide: 'Bismuth-212',
                          decayType: 'Beta-minus (64.1%) / Alpha (35.9%)',
                          halfLife: '60.55 minutes',
              daughter: 'Polonium-212 / Thallium-208',
                          branches: [
                              [ // Path 1: Beta decay
                                  { nuclide: 'Polonium-212', decayType: 'Alpha', halfLife: '0.299 microseconds', daughter: 'Lead-208' },
                                  { nuclide: 'Lead-208', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                              ],
                              [ // Path 2: Alpha decay
                                  { nuclide: 'Thallium-208', decayType: 'Beta-minus', halfLife: '3.053 minutes', daughter: 'Lead-208' },
                                  { nuclide: 'Lead-208', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                              ]
                          ]
                      }
                  ]
              },
                  {
                      id: 'U-235-series',
                      name: 'Uranium-235 Decay Series (Actinium Series)',
                      startNuclide: 'Uranium-235',
                      chain: [
                          { nuclide: 'Uranium-235', decayType: 'Alpha', halfLife: '703.8 million years', daughter: 'Thorium-231' },
                          { nuclide: 'Thorium-231', decayType: 'Beta-minus', halfLife: '25.5 hours', daughter: 'Protactinium-231' },
                          { nuclide: 'Protactinium-231', decayType: 'Alpha', halfLife: '32,760 years', daughter: 'Actinium-227' },
                          { nuclide: 'Actinium-227', decayType: 'Beta-minus', halfLife: '21.77 years', daughter: 'Thorium-227' },
                          { nuclide: 'Thorium-227', decayType: 'Alpha', halfLife: '18.72 days', daughter: 'Radium-223' },
                          { nuclide: 'Radium-223', decayType: 'Alpha', halfLife: '11.43 days', daughter: 'Radon-219' },
                          { nuclide: 'Radon-219', decayType: 'Alpha', halfLife: '3.96 seconds', daughter: 'Polonium-215' },
                          { nuclide: 'Polonium-215', decayType: 'Alpha', halfLife: '1.78 milliseconds', daughter: 'Lead-211' },
              { nuclide: 'Lead-211', decayType: 'Beta-minus', halfLife: '36.1 minutes', daughter: 'Bismuth-211' },
              {
              nuclide: 'Bismuth-211',
              decayType: 'Alpha (99.72%) / Beta-minus (0.28%)',
              halfLife: '2.14 minutes',
              daughter: 'Thallium-207 / Polonium-211',
              branches: [
                 [ // Path 1: Alpha decay
                     { nuclide: 'Thallium-207', decayType: 'Beta-minus', halfLife: '4.77 minutes', daughter: 'Lead-207' },
                     { nuclide: 'Lead-207', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                 ],
                 [ // Path 2: Beta decay
                     { nuclide: 'Polonium-211', decayType: 'Alpha', halfLife: '0.516 seconds', daughter: 'Lead-207' },
                     { nuclide: 'Lead-207', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                 ]
              ]
              }
                      ]
                  },
                  {
                      id: 'Ra-226-series',
                      name: 'Radium-226 Decay Series',
                      startNuclide: 'Radium-226',
                      chain: [
                          { nuclide: 'Radium-226', decayType: 'Alpha', halfLife: '1600 years', daughter: 'Radon-222' },
                          { nuclide: 'Radon-222', decayType: 'Alpha', halfLife: '3.82 days', daughter: 'Polonium-218' },
                          { nuclide: 'Polonium-218', decayType: 'Alpha', halfLife: '3.1 minutes', daughter: 'Lead-214' },
                          { nuclide: 'Lead-214', decayType: 'Beta-minus', halfLife: '26.8 minutes', daughter: 'Bismuth-214' },
                          { nuclide: 'Bismuth-214', decayType: 'Beta-minus', halfLife: '19.9 minutes', daughter: 'Polonium-214' },
                          { nuclide: 'Polonium-214', decayType: 'Alpha', halfLife: '164.3 microseconds', daughter: 'Lead-210' },
                          { nuclide: 'Lead-210', decayType: 'Beta-minus', halfLife: '22.2 years', daughter: 'Bismuth-210' },
                          { nuclide: 'Bismuth-210', decayType: 'Beta-minus', halfLife: '5.012 days', daughter: 'Polonium-210' },
                          { nuclide: 'Polonium-210', decayType: 'Alpha', halfLife: '138.376 days', daughter: 'Lead-206' },
                          { nuclide: 'Lead-206', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                      ]
                  },
                  {
        id: 'Np-237-series',
        name: 'Neptunium-237 Decay Series (Artificial)',
        startNuclide: 'Neptunium-237',
        chain: [
            { nuclide: 'Neptunium-237', decayType: 'Alpha', halfLife: '2.14 million years', daughter: 'Protactinium-233' },
            { nuclide: 'Protactinium-233', decayType: 'Beta-minus', halfLife: '27.0 days', daughter: 'Uranium-233' },
            { nuclide: 'Uranium-233', decayType: 'Alpha', halfLife: '159,200 years', daughter: 'Thorium-229' },
            { nuclide: 'Thorium-229', decayType: 'Alpha', halfLife: '7,340 years', daughter: 'Radium-225' },
            { nuclide: 'Radium-225', decayType: 'Beta-minus', halfLife: '14.9 days', daughter: 'Actinium-225' },
            { nuclide: 'Actinium-225', decayType: 'Alpha', halfLife: '9.92 days', daughter: 'Francium-221' },
            { nuclide: 'Francium-221', decayType: 'Alpha', halfLife: '4.8 minutes', daughter: 'Astatine-217' },
            { nuclide: 'Astatine-217', decayType: 'Alpha', halfLife: '32.3 milliseconds', daughter: 'Bismuth-213' },
            {
                nuclide: 'Bismuth-213',
                decayType: 'Beta-minus (97.9%) / Alpha (2.1%)',
                halfLife: '45.6 minutes',
                daughter: 'Polonium-213 / Thallium-209',
                branches: [
                    [ // Path 1: Beta to Po-213
                        { nuclide: 'Polonium-213', decayType: 'Alpha', halfLife: '4.2 microseconds', daughter: 'Lead-209' },
                        { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                        { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                        { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                    ],
                    [ // Path 2: Alpha to Tl-209
                        { nuclide: 'Thallium-209', decayType: 'Beta-minus', halfLife: '2.16 minutes', daughter: 'Lead-209' },
                        // Lead-209 merges back into the main chain, but Bateman solver handles linear trees. 
                        // We duplicate the tail here for the solver's graph logic.
                        { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                        { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                        { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                    ]
                ]
            }
        ]
    },
{
        id: 'Ac-225-series',
        name: 'Actinium-225 (Medical Alpha Generator)',
        startNuclide: 'Actinium-225',
        chain: [
            { nuclide: 'Actinium-225', decayType: 'Alpha', halfLife: '9.92 days', daughter: 'Francium-221' },
            { nuclide: 'Francium-221', decayType: 'Alpha', halfLife: '4.8 minutes', daughter: 'Astatine-217' },
            { nuclide: 'Astatine-217', decayType: 'Alpha', halfLife: '32.3 milliseconds', daughter: 'Bismuth-213' },
            {
                nuclide: 'Bismuth-213',
                decayType: 'Beta-minus (97.9%) / Alpha (2.1%)',
                halfLife: '45.6 minutes',
                daughter: 'Polonium-213 / Thallium-209',
                branches: [
                    [ // Path 1: Beta
                        { nuclide: 'Polonium-213', decayType: 'Alpha', halfLife: '4.2 microseconds', daughter: 'Lead-209' },
                        { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                        { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                        { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                    ],
                    [ // Path 2: Alpha
                        { nuclide: 'Thallium-209', decayType: 'Beta-minus', halfLife: '2.16 minutes', daughter: 'Lead-209' },
                        { nuclide: 'Lead-209', decayType: 'Beta-minus', halfLife: '3.25 hours', daughter: 'Bismuth-209' },
                        { nuclide: 'Bismuth-209', decayType: 'Effectively Stable', halfLife: '2.01 x 10¹⁹ years', daughter: 'Thallium-205' },
                        { nuclide: 'Thallium-205', decayType: 'Stable', halfLife: 'Stable', daughter: 'N/A' }
                    ]
                ]
            }
        ]
    }
];
              
              /**
               * A comprehensive list of radionuclides pulled from the initial table above.
               */
              
              const radionuclides = RADIONUCLIDE_DATA;
              
              //==============================================================================
              // --- UTILITY & PARSER FUNCTIONS
              //==============================================================================
              
              /**
               * Normalizes a string by converting it to lowercase and removing spaces and hyphens.
               * @param {string} str - The input string.
               * @returns {string} The normalized string.
               */
              
              const normalizeString = (str) => (typeof str === 'string' ? str.toLowerCase().replace(/[^a-z0-9]/g, '') : '');
              
              /**
               * @description Creates a formatted string of key info for a nuclide tooltip.
               * @param {object} nuclide - The nuclide object.
               * @returns {string} A formatted string with half-life and emission types.
               */
              
              const generateQuickInfoText = (nuclide) => {
                  if (!nuclide) return '';
                  const halfLife = `Half-life: ${formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)))}`;
                  const emissions = `Emissions: ${(nuclide.emissionType || []).join(', ')}`;
                  return `${halfLife} | ${emissions}`;
              };
              
              /**
               * Implements the Bateman equations for a full decay series, including branching decays.
               * It iteratively builds an analytical solution for each nuclide as a sum of exponential terms.
               * @param {Array<object>} chain - The array of nuclide objects in the decay series.
               * @param {number} A1_0 - The initial activity of the parent nuclide.
               * @param {number} t_seconds - The elapsed time in seconds.
               * @returns {Array<number>} An array of activities for each nuclide in the chain at time t.
               */
              
              const runBatemanWithBranching = (chain, A1_0, t_seconds) => {
                  const nuclideMap = new Map();
              
                  // 1. Pre-process the chain into a graph-like map for easy lookup.
              
                  chain.forEach(step => {
                      const lambda = parseHalfLifeToSeconds(step.halfLife) === Infinity ? 0 : Math.log(2) / parseHalfLifeToSeconds(step.halfLife);
                      if (!nuclideMap.has(step.nuclide)) {
                          nuclideMap.set(step.nuclide, { name: step.nuclide, lambda, parents: [], solution: [] });
                      } else {
                          nuclideMap.get(step.nuclide).lambda = lambda;
                      }
              
                      if (step.daughter !== 'N/A') {
                          const decayTypes = step.decayType.split(' / ').map(s => s.trim());
                          const daughters = step.daughter.split(' / ').map(s => s.trim());
                          daughters.forEach((daughterName, i) => {
                              // Extract branching ratio if present, e.g., "Beta-minus (64.1%)"
                              const match = decayTypes[i] ? decayTypes[i].match(/\(([\d.]+)%\)/) : null;
                              const br = match ? parseFloat(match[1]) / 100.0 : 1.0;
              
                              if (!nuclideMap.has(daughterName)) {
                                  nuclideMap.set(daughterName, { name: daughterName, lambda: 0, parents: [], solution: [] });
                              }
                              nuclideMap.get(daughterName).parents.push({ name: step.nuclide, br: br });
                          });
                      }
                  });
              
                  // 2. Iteratively build the analytical solution for each nuclide.
              
                  for (const step of chain) {
                      const nuclideName = step.nuclide;
                      const nuclide = nuclideMap.get(nuclideName);
              
                      if (nuclide.parents.length === 0) { // This is the root parent
                          if (nuclide.lambda === 0) continue;
                          const N0 = A1_0 / nuclide.lambda;
                          nuclide.solution.push({ coeff: N0, lambda: nuclide.lambda });
                      } else {
                          const solutionMap = new Map(); // Used to consolidate terms
                          for (const parent of nuclide.parents) {
                              const parentNuclide = nuclideMap.get(parent.name);
                              for (const term of parentNuclide.solution) {
                                  const C = parent.br * parentNuclide.lambda * term.coeff;
              
                                  // Handle the case where decay constants are identical (or very close)
              
                                  if (Math.abs(nuclide.lambda - term.lambda) < 1e-20) {
              
                                      // This case leads to a t*e^(-lambda*t) term, which complicates the solution structure.
                                      // For simplicity and to avoid a full rewrite, we'll approximate by introducing a tiny difference.
                                      // This is a common numerical stability trick.
              
                                      term.lambda *= (1 + 1e-10);
                                  }
              
                                  const coeff = C / (nuclide.lambda - term.lambda);
                                  // Add the two new terms to the solution map, consolidating as we go
                                  solutionMap.set(term.lambda, (solutionMap.get(term.lambda) || 0) + coeff);
                                  solutionMap.set(nuclide.lambda, (solutionMap.get(nuclide.lambda) || 0) - coeff);
                              }
                          }
                          // Convert the map back to the solution array format
                          nuclide.solution = Array.from(solutionMap, ([lambda, coeff]) => ({ lambda, coeff }));
                      }
                  }
              
                  // 3. Calculate the final activities at the specified time.
              
                  const finalActivities = [];
                  for (const step of chain) {
                      const nuclide = nuclideMap.get(step.nuclide);
                      if (nuclide.lambda === 0) {
                          finalActivities.push(0);
                          continue;
                      }
                      let N_t = 0;
                      for (const term of nuclide.solution) {
                          N_t += term.coeff * Math.exp(-term.lambda * t_seconds);
                      }
                      const A_t = N_t * nuclide.lambda;
                      finalActivities.push(A_t > 0 ? A_t : 0); // Ensure no negative activities from floating point errors
                  }
                  return finalActivities;
              };
              
              /**
               * Flattens a potentially nested decay chain into a simple, unique list of nuclides
               * for the Bateman calculator.
               * @param {Array<object>} chain - The potentially nested chain data.
               * @returns {Array<object>} A flat array of unique nuclide steps.
               */
              
              const flattenChainForCalculator = (chain) => {
                  const seen = new Set();
                  const flatChain = [];
              
                  function recurse(steps) {
                      if (!steps) return;
                      for (const step of steps) {
                          if (!seen.has(step.nuclide)) {
                              flatChain.push(step);
                              seen.add(step.nuclide);
                          }
                          if (step.branches) {
                              step.branches.forEach(branch => recurse(branch));
                          }
                      }
                  }
              
                  recurse(chain);
                  return flatChain;
              };
              
              /**
              * Formats a number for compact display on mobile screens.
              * Rounds to 3 significant figures and handles special cases.
              * @param {number} num - The number to format.
              * @returns {string} The compacted, formatted string.
              */
              
              const formatForMobile = (num) => {
              if (num === null || num === undefined || isNaN(num) || num === Infinity) return 'N/A';
              if (num === 0) return '0';
              return num.toPrecision(3);
              };
         
         /**
          * @description Formats a dose or dose rate value based on the global unit system.
          * @param {number} value_mrem - The numerical value in mrem or mrem/hr.
          * @param {string} type - The type of quantity ('dose' or 'doseRate').
          * @param {object} settings - The global settings object from SettingsContext.
          * @returns {{value: string, unit: string}} An object with the formatted value and unit.
          */
         const formatDoseValue = (value_mrem, type, settings) => {
             const { unitSystem } = settings;
             
             if (unitSystem === 'si') {
                 // Convert mrem to mSv (100 mrem = 1 mSv)
                 const value_mSv = value_mrem / 100;
                 return formatSensibleUnit(value_mSv, `${type}_si`);
             } else {
                 // Already in conventional, just format it
                 return formatSensibleUnit(value_mrem, type);
             }
         };
         
         /**
          * @description Calculates the ANSI/HPS N43.6 source category based on activity and D-value.
          * @param {number} activityInTbq - The activity of the source in TBq.
          * @param {number} dValueInTbq - The D-value for the nuclide in TBq.
          * @returns {object|null} An object with the category and description, or null if not applicable.
          */
         const calculateAnsiCategory = (activityInTbq, dValueInTbq) => {
             if (!dValueInTbq || dValueInTbq <= 0) return null;
             
             const ratio = activityInTbq / dValueInTbq;
             
             if (ratio >= 1000) {
                 return { category: 1, description: 'Category 1 Source (Extremely Dangerous)' };
             } else if (ratio >= 10) {
                 return { category: 2, description: 'Category 2 Source (Very Dangerous)' };
             } else if (ratio >= 1) {
                 return { category: 3, description: 'Category 3 Source (Dangerous)' };
             } else if (ratio >= 0.01) {
                 return { category: 4, description: 'Category 4 Source (Unlikely to be Dangerous)' };
             } else {
                 return { category: 5, description: 'Category 5 Source (Very Unlikely to be Dangerous)' };
             }
         };
         
         /**
          * @description Formats a value based on the global unit system preference.
          * @param {number} value - The numerical value in its base unit.
          * @param {string} type - The type of quantity (e.g., 'activity', 'dose', 'gammaConstant').
          * @param {object} settings - The global settings object from SettingsContext.
          * @returns {{value: string, unit: string}} An object with the formatted value and unit.
          */
         const formatWithUnitSystem = (value, type, settings) => {
             const { unitSystem } = settings;
             
             if (value === null || value === undefined || isNaN(value)) {
                 return { value: 'N/A', unit: '' };
             }
         
             const formatNumber = (num) => {
                 if (num === 0) return '0';
                 const absVal = Math.abs(num);
                 if (absVal > 1e4 || absVal < 1e-3) {
                     return num.toExponential(2);
                 }
                 return num.toPrecision(3);
             };
         
             switch (type) {
                 case 'activity': // Base unit is Bq/g
                     if (unitSystem === 'si') {
                         return { value: formatNumber(value), unit: 'Bq/g' };
                     } else {
                         const value_Ci_g = value / 3.7e10;
                         return { value: formatNumber(value_Ci_g), unit: 'Ci/g' };
                     }
         
                 case 'ali': // Base unit is µCi
                     if (unitSystem === 'si') {
                         const value_Bq = value * 37000;
                         return { value: formatNumber(value_Bq), unit: 'Bq' };
                     } else {
                         return { value: formatNumber(value), unit: 'µCi' };
                     }
         
                 case 'dac': // Base unit is µCi/mL
                     if (unitSystem === 'si') {
                         const value_Bq_m3 = value * 3.7e10;
                         return { value: formatNumber(value_Bq_m3), unit: 'Bq/m³' };
                     } else {
                         return { value: formatNumber(value), unit: 'µCi/mL' };
                     }
         
                 case 'gammaConstant': // Base unit is R·m²/hr·Ci
                     if (unitSystem === 'si') {
                         // Conversion: R -> Gy (0.01), Ci -> Bq (3.7e10) -> (Gy·m²/hr·Bq)
                         // For dose equivalent, use Sv, assuming QF=1 for photons
                         const value_Sv_m2_hr_Bq = (value * 0.01) / 3.7e10;
                         return { value: formatNumber(value_Sv_m2_hr_Bq), unit: 'Sv·m²/hr·Bq' };
                     } else {
                         return { value: value.toString(), unit: 'R·m²/hr·Ci' };
                     }
         
                 default:
                     return { value: value.toString(), unit: '' };
             }
         };
         
              /**
               * Parses a half-life string (e.g., "1600 years") into a total number of seconds.
               * Handles various units, scientific notation, and the "Stable" keyword.
               * @param {string} halfLifeStr - The half-life string to parse.
               * @returns {number} The half-life in seconds, or Infinity for "Stable".
               */
              
              const parseHalfLifeToSeconds = (halfLifeStr) => {
              if (!halfLifeStr || halfLifeStr.toLowerCase() === 'stable') return Infinity;
              
              const match = halfLifeStr.trim().match(/^(.*?)\s*([a-zA-Zμµ]+.*)$/);
              let numericStr, unitStr;
              if (match) {
              numericStr = match[1].trim();
              unitStr = match[2].trim();
              } else {
              numericStr = halfLifeStr.trim();
              unitStr = '';
              }
              
              let value;
              const sciNotationRegex = /([\d.,]+)\s*x\s*10\^?([⁻⁺\-−\d⁰¹²³⁴⁵⁶⁷⁸⁹]+)/i;
              const sciMatch = numericStr.match(sciNotationRegex);
              
              if (sciMatch) {
              const mantissa = parseFloat(sciMatch[1].replace(/,/g, ''));
              const exponentStr = sciMatch[2];
              const superToRegularMap = { '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9', '⁺': '+', '⁻': '-', '−': '-' };
              const regularExponentStr = [...exponentStr].map(char => superToRegularMap[char] || char).join('');
              const exponent = parseInt(regularExponentStr);
              if (!isNaN(mantissa) && !isNaN(exponent)) {
                  value = mantissa * Math.pow(10, exponent);
              }
              } else {
              value = parseFloat(numericStr.replace(/,/g, ''));
              }
              
              if (isNaN(value)) return 0;
              
              const unit = unitStr.toLowerCase();
              const unitMultipliers = {
              'billion years': 3.15576e16,
              'million years': 3.15576e13,
              'kiloyears': 3.15576e10, // Note: The data does not contain this unit, but the logic is ready for it.
              'years': 31557600,
              'year': 31557600,
              'days': 86400,
              'day': 86400,
              'hours': 3600,
              'hour': 3600,
              'minutes': 60,
              'minute': 60,
              'seconds': 1,
              'second': 1,
              's': 1,
              'milliseconds': 1e-3,
              'millisecond': 1e-3,
              'microseconds': 1e-6,
              'microsecond': 1e-6,
              };
              
              // Sort keys by length in descending order to match 'billion years' before 'years'
              
              const sortedKeys = Object.keys(unitMultipliers).sort((a, b) => b.length - a.length);
              
              for (const key of sortedKeys) {
              if (unit.startsWith(key)) {
                  return value * unitMultipliers[key];
              }
              }
              return value;
              };
              
              const getHalfLifeCategory = (seconds) => {
                  if (seconds === Infinity) return { label: 'Stable', color: 'text-slate-500 dark:text-slate-400' };
                  if (seconds < 3600) return { label: 'Very Short', color: 'text-red-500' }; // < 1 Hour
                  if (seconds < 86400 * 2) return { label: 'Short', color: 'text-amber-500' }; // < 2 Days
                  if (seconds < 31557600 * 10) return { label: 'Medium', color: 'text-sky-500' }; // < 10 Years
                  if (seconds < 31557600 * 1000000) return { label: 'Long', color: 'text-indigo-500' }; // < 1 Million Years
                  return { label: 'Geological', color: 'text-purple-500' };
              };
              
              /*
              * Parses a string to standardize its numeric part into "e" notation if it's very large or small.
              * Handles multiple formats: "1.23 x 10^4", "1.23 x 10⁻⁴", "4,059", and "0.0123".
              * @param {string} str - The input string (e.g., "1.55 x 10⁻¹⁰ year⁻¹").
              * @returns {string} The formatted string with standardized notation.
              */
              
              const standardizeScientificDisplay = (str) => {
              if (typeof str !== 'string' || !str) return str;
              
              // A map to convert unicode superscripts and minus signs to standard characters.
              
              const superToRegularMap = { '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9', '⁺': '+', '⁻': '-', '−': '-' };
              
              // Regex to capture the mantissa, exponent (in any format), and any trailing units.
              
              const sciNotationRegex = /([\d.,]+)\s*x\s*10\^?([⁻⁺\-−\d⁰¹²³⁴⁵⁶⁷⁸⁹]+)\s*(.*)/;
              const sciMatch = str.match(sciNotationRegex);
              
              if (sciMatch) {
              const mantissa = parseFloat(sciMatch[1].replace(/,/g, ''));
              const exponentStr = sciMatch[2];
              const units = sciMatch[3] || '';
              
              const regularExponentStr = [...exponentStr].map(char => superToRegularMap[char] || char).join('');
              const exponent = parseInt(regularExponentStr);
              
              if (isNaN(mantissa) || isNaN(exponent)) return str;
              
              const numericValue = mantissa * Math.pow(10, exponent);
              return `${numericValue.toExponential(2)} ${units}`.trim();
              }
              
              // If not in scientific notation, handle it as a plain number.
              
              const plainNumberRegex = /^([-\d.,]+)(.*)/;
              const plainMatch = str.match(plainNumberRegex);
              if (plainMatch) {
              const numberPart = plainMatch[1].replace(/,/g, '');
              const units = plainMatch[2] || '';
              const numericValue = parseFloat(numberPart);
              if (isNaN(numericValue)) return str;
              
              const absValue = Math.abs(numericValue);
              if (numericValue === 0) return `0 ${units}`.trim();
              
              // Use exponential notation for very large or very small numbers.
              
              if (absValue > 10000 || absValue < 0.001) {
                  return `${numericValue.toExponential(2)} ${units}`.trim();
              }
              // For other numbers, use a fixed precision.
              
              return `${numericValue.toPrecision(3)} ${units}`.trim();
              }
              
              return str;
              };
              
              /**
               * Determines the most appropriate human-readable unit for a given duration in seconds.
               * @param {number} seconds - The duration in seconds.
               * @returns {string} The most fitting unit ('years', 'days', 'hours', 'minutes', or 'seconds').
               */
              
              	const getBestHalfLifeUnit = (seconds) => {
                  	if (seconds === Infinity) return 'years';
              
                  const secondsInMinute = 60;
                  const secondsInHour = 3600;
                  const secondsInDay = 86400;
                  const secondsInYear = 31557600; // 365.25 days
              
                  if (seconds >= secondsInYear) return 'years';
                  if (seconds >= secondsInDay) return 'days';
                  if (seconds >= secondsInHour) return 'hours';
                  if (seconds >= secondsInMinute) return 'minutes';
                  return 'seconds';
              };
              
              /**
               * Formats a half-life string into a specified target unit with appropriate precision.
               * @param {string} halfLifeStr - The original half-life string (e.g., "1.25 billion years").
               * @param {string} targetUnit - The desired unit for the output (e.g., 'years', 'days').
               * @returns {string} The formatted half-life string (e.g., "1.25e+9 years").
               */
              
              const formatHalfLife = (halfLifeStr, targetUnit) => {
              const seconds = parseHalfLifeToSeconds(halfLifeStr);
              
              if (seconds === Infinity) return 'Stable';
              if (seconds === 0 || !halfLifeStr) return 'N/A';
              
              const unitConversions = {
              'seconds': 1,
              'minutes': 60,
              'hours': 3600,
              'days': 86400,
              'years': 31557600,
              'kiloyears': 3.15576e10, // Use standardized scientific notation
              'megayears': 3.15576e13,
              'gigayears': 3.15576e16,
              };
              
              const value = seconds / unitConversions[targetUnit];
              
              // Use the existing standardization function to format the output
              
              const formattedValue = standardizeScientificDisplay(`${value} ${targetUnit}`);
              
              return formattedValue;
              };
              
              /**
               * Parses an array of energy strings and returns the primary energy value in MeV.
               * Assumes the first entry in the array is the most significant.
               * @param {string[]} energyArray - An array of energy strings (e.g., ["5.3 MeV", "5.2 MeV"]).
               * @returns {number} The energy value in MeV. Returns 0 if input is invalid.
               */
              
              const parseEnergyToMeV = (energyArray) => {
                  if (!energyArray || energyArray.length === 0) return 0;
                  const energyStr = energyArray[0];
                  const parts = energyStr.split(' ');
                  let value = parseFloat(parts[0]);
              
                  if (isNaN(value)) return 0;
              
                  const unit = parts[1]?.toLowerCase();
                  if (unit && unit.includes('kev')) return value / 1000; // Convert keV to MeV
                  return value;
              };
              
              /**
               * Parses a specific activity string, handling scientific notation (e.g., "3.7 x 10^10 Bq/g").
               * @param {string} saStr - The specific activity string.
               * @returns {number} The parsed specific activity as a number. Returns 0 if input is invalid.
               */
              
              const parseSpecificActivity = (saStr) => {
                  if (!saStr) return 0;
                  const parts = saStr.toLowerCase().split(' ');
              
                  // Check for the specific "x 10^" format.
              
                  if (parts.length < 3 || parts[1] !== 'x' || !parts[2].includes('10^')) {
                      return parseFloat(saStr.replace(/,/g, '')); // Fallback for simple numbers.
                  }
              
                  const value = parseFloat(parts[0]);
                  const exponent = parseInt(parts[2].split('^')[1]);
              
                  if (isNaN(value) || isNaN(exponent)) return 0;
              
                  return value * Math.pow(10, exponent);
              };
              
              
              //==============================================================================
              // --- REACT COMPONENTS & ICONS
              //==============================================================================
              
              /**
               * A simple SVG icon component.
               * @param {{path: string, className?: string}} props - Component props.
               * @param {string} props.path - The SVG path data for the icon.
               * @param {string} [props.className="w-5 h-5"] - Optional CSS classes.
               * @returns {JSX.Element} A React component rendering an SVG icon.
               */
              
              const Icon = ({ path, className = "w-5 h-5" }) => (
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                      <path d={path} />
                  </svg>
              );
              
              /**
               * A mapping of icon names to their corresponding SVG path data.
               */
              
              const ICONS = {
              
              // Standard UI Icons
              
              copy: "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-2-.9-2-2-2zm0 16H8V7h11v14z",
              check: "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z",
              search: "M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A8 8 0 1 0 10 18zm0-14a6 6 0 1 1-6 6 6 6 0 0 1 6-6z",
              help: "M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z",
              clear: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
              filter: "M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z",
              settings: "M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-2 11h4v-3h2v-2h-2v-2h-4v2h-2v2h2v3zm-4-7c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm8 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-4 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z",
              popOut: "M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z",    
         
              northArrow: "M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z",    
         
         
              // Theme Icons
              
              sun: "M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zm-9-8c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zm0 16c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 .55.45 1 1 1zM5.64 6.36c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L5.64 3.54c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41L5.64 6.36zm12.72 12.72c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41zM4.22 18.36c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41zM18.36 4.22c-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0z",
              moon: "M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.64-.11 2.41-.31-3.26-1.46-5.41-4.56-5.41-8.19 0-3.63 2.15-6.73 5.41-8.19A8.96 8.96 0 0012 3z",
              
              // Thematic Tool Icons
              
              home: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z",
              database: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z",
              compare: "M9.01 14H2v2h7.01v3L13 15l-3.99-4v3zm5.98-12H22v2h-7.01v3L11 3l3.99 4V4z",
              calculator: "M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-2-.9-2-2-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm4 8H10v-2h2v2zm0-4H10v-2h2v2zm0-4H10V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z",
              converter: "M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z",
              hourglass: "M6 2v6h.01L6 8.01 10 12l-4 4 .01.01H6V22h12v-5.99h-.01L18 16l-4-4 4-3.99-.01-.01H18V2H6z", // Half-life
              radioactive: "M12 2a9.97 9.97 0 0 0-5.49 1.76L12 15.35l5.49-11.59A9.97 9.97 0 0 0 12 2zm-9.24 9a10.016 10.016 0 0 0 14.48 0L12 17.65l-9.24-6.65zM4.93 16.24l-2.17-1.45A10.003 10.003 0 0 0 12 22a10.003 10.003 0 0 0 9.24-7.21l-2.17 1.45L12 19.35l-7.07-3.11z",
              activity: "M12 2a9.97 9.97 0 0 0-5.49 1.76L12 15.35l5.49-11.59A9.97 9.97 0 0 0 12 2zm-9.24 9a10.016 10.016 0 0 0 14.48 0L12 17.65l-9.24-6.65zM4.93 16.24l-2.17-1.45A10.003 10.003 0 0 0 12 22a10.003 10.003 0 0 0 9.24-7.21l-2.17 1.45L12 19.35l-7.07-3.11z", // Using trefoil for activity
              specificActivity: "M10 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 2c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm4-5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H4V7h16v10z", // Icon representing branching paths/emissions
              radon: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4H9V8h4V4h2v4h4v4h-4v4zm-1-8V4h-2v4h-2v2h2v4h2v-4h2v-2h-4z",
              doseRate: "M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H12v-2l-4 4 4 4v-2h9.5c.28 0 .5-.22.5-.5.01-2.09-1.26-3.87-3.15-4.96z", // Gauge icon
              shield: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z", // Renamed from doseRate
              mass: "M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm10 16H4V8h16v12z",
              series: "M21 8H3V6h18v2zm0 4H3v2h18v-2zm0 6H3v2h18v-2z",
              stopwatch: "M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.98-1.41-1.41l-1.42 1.42A8.962 8.962 0 0012 4c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-1.68-.46-3.24-1.25-4.55l.22-.16zm-1.07-1.01A6.995 6.995 0 115.34 19.66 6.995 6.995 0 0117.96 6.38z",
              transport: "M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z",
              internalDose: "M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z",
	      map: "M20.5 3l-6 2-6-2-5.5 1.83c-.29.1-.5.37-.5.67v15c0 .36.2.68.54.79l5.46 1.82 6-2 6 2 5.5-1.83c.29-.1.5-.37.5-.67v-15c0-.36-.2-.68-.54-.79l-5.46-1.82zM15 19l-6-2V5l6 2v12z",
              neutron: "M21 10.78V8c0-1.65-1.35-3-3-3h-1V3c0-.55-.45-1-1-1s-1 .45-1 1v2h-4V3c0-.55-.45-1-1-1s-1 .45-1 1v2H8c-1.65 0-3 1.35-3 3v2.78c-.61.55-1 1.34-1 2.22v6c0 1.65 1.35 3 3 3h10c1.65 0 3-1.35 3-3v-6c0-.88-.39-1.67-1-2.22zM9 19H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm2-7h-2v-2h2v2z",
              medical: "M18 10.5V6H6v4.5c-1.1 0-2 .9-2 2v3c0 1.1.9 2 2 2h1v3h2v-3h8v3h2v-3h1c1.1 0 2-.9 2-2v-3c0-1.1-.9-2-2-2zM8 8h8v2H8V8zm10 7.5H6v-3h12v3zM11 2h2v2h-2z",
              labStats: "M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z",
              gammaSpec: "M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z",
              notepad: "M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z",
              scientificCalculator: "M7 21a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2H7zm2-2h6v-2H9v2zm0-4h6v-2H9v2zm4-4h2v-2h-2v2zm-4 0h2v-2H9v2zM7 7h10V5H7v2z",
              references: "M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"
              };
              
              //==============================================================================
              // --- GLOBAL SETTINGS & CONTEXT
              //==============================================================================
              
              const SettingsContext = React.createContext();
              
         const SettingsProvider = ({ children }) => {
             // UPDATED: Added unitSystem to the default settings.
             const defaultSettings = {
                 theme: 'system', // 'light', 'dark', or 'system'
                 unitSystem: 'conventional', // 'conventional' (Ci, rem) or 'si' (Bq, Sv)
             };
         
             const [settings, setSettings] = React.useState(() => {
                 try {
                     const saved = localStorage.getItem('rad_tool_settings');
                     return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
                 } catch (e) {
                     return defaultSettings;
                 }
             });
         
             const updateSettings = (newSettings) => {
                 setSettings(prev => {
                     const updated = { ...prev, ...newSettings };
                     localStorage.setItem('rad_tool_settings', JSON.stringify(updated));
                     return updated;
                 });
             };
         
             React.useEffect(() => {
                 const root = window.document.documentElement;
                 if (settings.theme === 'dark') {
                     root.classList.add('dark');
                 } else if (settings.theme === 'light') {
                     root.classList.remove('dark');
                 } else { // System theme
                     const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                     const handleChange = () => {
                         if (mediaQuery.matches) { root.classList.add('dark'); } 
                         else { root.classList.remove('dark'); }
                     };
                     mediaQuery.addEventListener('change', handleChange);
                     handleChange(); // Initial check
                     return () => mediaQuery.removeEventListener('change', handleChange);
                 }
             }, [settings.theme]);
         
             return (
                 <SettingsContext.Provider value={{ settings, updateSettings }}>
                     {children}
                 </SettingsContext.Provider>
             );
         };
              
              const CATEGORY_DESCRIPTIONS = {
              'Medical': 'Used for diagnosis, therapy, or medical research.',
              'Industrial': 'Used in manufacturing, gauging, sterilization, or other industrial processes.',
              'Natural': 'Occurs naturally in the environment or as part of a decay series.',
              'Stable/Reference': 'A stable isotope, often used as a reference or target material.',
              };
              
              const CATEGORY_STYLES = {
              'Medical':    {
              border: 'border-l-sky-400 dark:border-l-sky-600',
              hoverBg: 'hover:bg-sky-50 dark:hover:bg-sky-900/50'
              },
              'Industrial': {
              border: 'border-l-amber-400 dark:border-l-amber-600',
              hoverBg: 'hover:bg-amber-50 dark:hover:bg-amber-900/50'
              },
              'Natural':    {
              border: 'border-l-green-400 dark:border-l-green-600',
              hoverBg: 'hover:bg-green-50 dark:hover:bg-green-900/50'
              },
              'Stable/Reference': {
              border: 'border-l-slate-400 dark:border-l-slate-500',
              hoverBg: 'hover:bg-slate-50 dark:hover:bg-slate-800/50'
              },
              
              // A default style for any other categories
              
              'default': {
              border: 'border-l-slate-300 dark:border-l-slate-600',
              hoverBg: 'hover:bg-slate-50 dark:hover:bg-slate-800/50'
              }
              };
              
              //==============================================================================
              // --- TOAST NOTIFICATION SYSTEM
              // Provides pop-up messages for user feedback (e.g., "Copied to clipboard").
              //==============================================================================
              
              /**
               * @description React Context to provide toast notification functions to any component.
               */
              
              const ToastContext = React.createContext();
              
              /**
               * @description Provider component that manages the state of toast notifications.
               * It renders the toasts and provides a function to add new ones.
               * @param {{children: React.ReactNode}} props - The child components that will have access to the context.
               */
              
         const ToastProvider = ({ children }) => {
         const [toasts, setToasts] = React.useState([]);
         
         const addToast = (message) => {
             const id = Date.now();
             setToasts(prevToasts => [...prevToasts, { id, message }]);
             setTimeout(() => {
                 removeToast(id);
             }, 3000);
         };
         
         const removeToast = (id) => {
             setToasts(prevToasts => prevToasts.filter(toast => toast.id !== id));
         };
         
         // ADDED: A variable to hold the toast container's JSX
         const toastContainer = (
             <div className="fixed bottom-4 right-4 z-50 space-y-2">
                 {toasts.map(toast => (
                     <div key={toast.id} className="animate-toast-in bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-800 px-4 py-3 rounded-lg shadow-lg flex items-center">
                         <Icon path={ICONS.check} className="w-5 h-5 mr-3 text-green-400" />
                         <span>{toast.message}</span>
                     </div>
                 ))}
             </div>
         );
         
         return (
             <ToastContext.Provider value={{ addToast }}>
                 {children}
                 
                 {/* CHANGED: Use ReactDOM.createPortal to render toasts outside this component's DOM hierarchy */}
                 {ReactDOM.createPortal(toastContainer, document.getElementById('toast-root'))}
                 
             </ToastContext.Provider>
         );
         };
             
         
         /**
         * @description Custom hook that delays updating a value until a specified time
         * has passed without that value changing. This is useful for preventing
         * expensive operations (like API calls or history updates) from running on
         * every keystroke.
         * @param {*} value The value to debounce.
         * @param {number} delay The delay in milliseconds.
         * @returns {*} The debounced value.
         */
         const useDebounce = (value, delay) => {
         // State to store the debounced value
         const [debouncedValue, setDebouncedValue] = React.useState(value);
         
         React.useEffect(() => {
             // Set up a timer to update the debounced value after the delay
             const handler = setTimeout(() => {
                 setDebouncedValue(value);
             }, delay);
         
             // This is the cleanup function that runs every time the dependency [value] changes.
             // It clears the previous timer, effectively resetting it. The timer will only
             // complete if the user stops changing the value for the duration of the delay.
             return () => {
                 clearTimeout(handler);
             };
         }, [value, delay]); // Only re-run the effect if value or delay changes
         
         return debouncedValue;
         };
         
         
         
              /**
               * @description Custom hook to easily access the toast context's `addToast` function.
               * @returns {{addToast: (message: string) => void}}
               */
              
              const useToast = () => React.useContext(ToastContext);
              
              /**
              * @description Custom hook to manage a list of recent calculations in localStorage.
              * @returns {{addHistory: (item: object) => void}}
              */
              
              const useCalculationHistory = () => {
              const addHistory = React.useCallback((item) => {
              try {
                 const history = JSON.parse(localStorage.getItem('rad_tool_calculation_history') || '[]');
                 const newHistory = [item, ...history];
                 // Keep only the 5 most recent calculations
                 const limitedHistory = newHistory.slice(0, 5);
                 localStorage.setItem('rad_tool_calculation_history', JSON.stringify(limitedHistory));
              } catch (e) {
                 console.error("Failed to update calculation history:", e);
              }
              }, []); // Empty dependency array makes this function stable
              return { addHistory };
              };
              
              //==============================================================================
              // --- REUSABLE UI COMPONENTS
              //==============================================================================
              
              
              /**
               * @description Displays a compact summary of a nuclide's key properties within a calculator.
               * @param {{nuclide: object}} props - The nuclide object to display context for.
               */
              
              const NuclideContextDisplay = ({ nuclide }) => {
                  if (!nuclide) return null;
              
                  const properties = [
                      {
                          label: 'Half-life',
                          value: formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife))),
                          condition: nuclide.halfLife && nuclide.halfLife !== 'Stable'
                      },
                      {
                          label: 'β Eₘₐₓ',
                          value: (nuclide.emissionEnergies?.beta || [])[0]?.replace(' (max)', ''),
                          condition: nuclide.emissionEnergies?.beta?.length > 0
                      },
              {
                          label: 'β Eₐᵥ₉',
                          value: `${nuclide.avgBetaEnergy} MeV`,
                          condition: nuclide.avgBetaEnergy
                      },
                      {
                          label: 'Γ Constant',
                          value: nuclide.gammaConstant,
                          condition: nuclide.gammaConstant
                      },
                      {
                          label: 'Emissions',
                          value: (nuclide.emissionType || []).join(', '),
                          condition: nuclide.emissionType?.length > 0
                      },
                      {
                          label: 'Specific Activity',
                          value: nuclide.specificActivity,
                          condition: nuclide.specificActivity
                      },
                  ];
              
                  const availableProperties = properties.filter(p => p.condition);
              
                  if (availableProperties.length === 0) return null;
              
                  return (
                      <div className="p-3 my-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg animate-fade-in text-xs">
                          <div className={`grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1`}>
                              {availableProperties.map(prop => (
                                  <div key={prop.label} className="truncate">
                                      <span className="font-semibold text-slate-500 dark:text-slate-400">{prop.label}: </span>
                                      <span className="text-slate-700 dark:text-slate-200" title={prop.value}>{prop.value}</span>
                                  </div>
                              ))}
                          </div>
                      </div>
                  );
              };
              
         
         /**
         * @description Displays a styled note for disclaimers or contextual info.
         * @param {{children: React.ReactNode, type: 'info' | 'warning'}} props
         */
         const ContextualNote = ({ children, type = 'info' }) => {
         const styles = {
             info: {
                 container: 'bg-slate-100 dark:bg-slate-800/50 border-slate-300 dark:border-slate-700',
                 iconColor: 'text-slate-500 dark:text-slate-400',
             },
             warning: {
                 container: 'bg-amber-50 dark:bg-amber-900/30 border-amber-300 dark:border-amber-700',
                 iconColor: 'text-amber-600 dark:text-amber-400',
             }
         };
         const selectedStyle = styles[type] || styles.info;
         
         return (
             <div className={`mt-4 p-3 border-l-4 rounded-r-lg text-xs ${selectedStyle.container}`}>
                 <div className="flex">
                     <div className="flex-shrink-0">
                         <Icon path={ICONS.help} className={`w-4 h-4 mr-2 ${selectedStyle.iconColor}`} />
                     </div>
                     <div className="flex-grow text-slate-600 dark:text-slate-300">
                         {children}
                     </div>
                 </div>
             </div>
         );
         };
         
         
         
              const Tooltip = ({ text, children, widthClass = 'w-96' }) => {
              
              // --- Modified state to hold a flexible style object ---
              
              const [tooltipState, setTooltipState] = React.useState({
              show: false,
              style: { opacity: 0, visibility: 'hidden' },
              position: 'bottom'
              });
              const triggerRef = React.useRef(null);
              const timeoutRef = React.useRef(null);
              
              // --- Rewrote handleMouseEnter with responsive logic ---
              
              const handleMouseEnter = () => {
              if (triggerRef.current) {
              const rect = triggerRef.current.getBoundingClientRect();
              const position = rect.top > window.innerHeight / 2 ? 'top' : 'bottom';
              const screenPadding = 8; // 8px padding from the viewport edge
              
              const newStyle = {
              top: position === 'bottom' ? rect.bottom : rect.top,
              visibility: 'visible',
              opacity: 1,
              };
              
              // Check if trigger is in the right half of the screen
              
              if (rect.left + rect.width / 2 > window.innerWidth / 2) {
              
              // Align tooltip's RIGHT edge with trigger's RIGHT edge
              
              newStyle.right = window.innerWidth - rect.right;
              newStyle.transformOrigin = 'right'; // Optional: for smoother animations
              } else {
              
              // Align tooltip's LEFT edge with trigger's LEFT edge
              
              newStyle.left = rect.left;
              newStyle.transformOrigin = 'left'; // Optional: for smoother animations
              }
              
              if (timeoutRef.current) clearTimeout(timeoutRef.current);
              
              setTooltipState({
              show: true,
              style: newStyle,
              position: position
              });
              
              timeoutRef.current = setTimeout(() => {
              setTooltipState(prev => ({ ...prev, show: false }));
              }, 4000);
              }
              };
              
              // --- Updated handleMouseLeave to correctly hide the tooltip ---
              const handleMouseLeave = () => {
              if (timeoutRef.current) clearTimeout(timeoutRef.current);
              
              // Hide by reverting style properties
              
              setTooltipState(prev => ({
              ...prev,
              show: false
              }));
              };
              
              React.useEffect(() => {
              return () => {
              if (timeoutRef.current) clearTimeout(timeoutRef.current);
              };
              }, []);
              
              const positionClasses = tooltipState.position === 'bottom'
              ? 'translate-y-2'
              : '-translate-y-full -translate-y-2';
              
              // --- Modified the rendered element to use the new style object ---
              // Note the removal of "-translate-x-1/2" from the className
              
              const tooltipElement = (
              ReactDOM.createPortal(
              <div
              style={{
              ...tooltipState.style,
              
              // Smoothly transition opacity for the fade effect
              
              transition: 'opacity 0.2s ease-out',
              
              // Conditionally set opacity based on the 'show' state
              
              opacity: tooltipState.show ? 1 : 0,
              }}
              className={`fixed top-0 p-2 text-xs text-white bg-slate-800 dark:bg-slate-900 rounded-md shadow-lg z-50 pointer-events-none ${widthClass} ${positionClasses}`}
              >
              {text}
              </div>,
              document.body
              )
              );
              
              return (
              <>
              {React.cloneElement(children, {
              ref: triggerRef,
              onMouseEnter: handleMouseEnter,
              onMouseLeave: handleMouseLeave,
              })}
              {tooltipElement}
              </>
              );
              };
              
              const renderInputField = (label, value, setter, isEnabled, unitValue, unitSetter, unitOptions) => (
               <div>
                   <label className={`block text-sm font-medium ${isEnabled ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 dark:text-slate-500'}`}>{label}</label>
                   <div className="flex gap-2 mt-1">
                       <input type="number" value={value} onChange={e => setter(e.target.value)} disabled={!isEnabled} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:cursor-not-allowed" />
                       {unitOptions && (
                           <select value={unitValue} onChange={e => unitSetter(e.target.value)} disabled={!isEnabled} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:cursor-not-allowed">
                               {unitOptions.map(u => <option key={u} value={u}>{u}</option>)}
                           </select>
                       )}
                   </div>
               </div>
              );
              
              /**
              * @description A reusable component that parses a string for nuclide names and turns them into clickable buttons.
              * @param {{text: string, radionuclides: Array<object>, onNuclideClick: (nuclide: object) => void}} props
              */
              
              const ClickableNuclide = ({ text, radionuclides, onNuclideClick }) => {
              if (!text || !onNuclideClick) return <span>{text}</span>;
              
              // This splits the string by delimiters like ' or ' or ' -> ' while keeping them
              
              const parts = text.split(/(\s+or\s+|\s*\/\s*|\s*->\s*)/);
              
              return (
              <>
                  {parts.map((part, index) => {
                      if (!part) return null;
                      const nuclideName = part.split('(')[0].trim();
                      const foundNuclide = radionuclides.find(n => n.name === nuclideName || n.symbol === nuclideName);
              
                      if (foundNuclide) {
                          return ( <button key={index} onClick={() => onNuclideClick(foundNuclide)} className="text-sky-500 hover:underline font-semibold">{part}</button> );
                      } else {
                          const isStable = text.toLowerCase().includes('stable') || radionuclides.find(n => n.name === nuclideName)?.halfLife === 'Stable';
                          return (
                              <span key={index}>
                                  {part}
                                  {isStable && <span className="text-xs font-medium text-slate-400 dark:text-slate-500 ml-1">(Stable)</span>}
                              </span>
                          );
                      }
                  })}
              </>
              );
              };
              
              /**
              * @description A reusable modal dialog for confirming user actions.
              * @param {{isOpen: boolean, onClose: () => void, onConfirm: () => void, title: string, children: React.ReactNode}} props
              */
              
              const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children }) => {
              if (!isOpen) return null;
              
              // The modal's JSX is now wrapped in ReactDOM.createPortal()
              
              return ReactDOM.createPortal(
              
              // Backdrop
              
              <div
                 className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4 animate-fade-in"
                 onClick={onClose} // Close modal if backdrop is clicked
              >
                 {/* Modal Panel */}
              
                 <div
                     className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl flex flex-col"
                     onClick={e => e.stopPropagation()} // Prevent click inside from closing modal
                 >
                     <div className="p-6">
                         <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">{title}</h3>
                         <div className="mt-2 text-sm text-slate-600 dark:text-slate-300">
                             {children}
                         </div>
                     </div>
              
                     {/* Action Buttons */}
              
                     <div className="bg-slate-50 dark:bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 rounded-b-2xl">
                         <button
                             onClick={onClose}
                             className="px-4 py-2 text-sm font-semibold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 rounded-md border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
                         >
                             Cancel
                         </button>
                         <button
                             onClick={onConfirm}
                             className="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors"
                         >
                             Confirm
                         </button>
                     </div>
                 </div>
              </div>,
              document.getElementById('modal-root') // This tells React where to render the modal
              );
              };
              
              const ClearButton = ({ onClick }) => (
              <button onClick={onClick} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1 ml-auto">
              <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
              </button>
              );
              
              /**
               * @description A button that copies a given text string to the clipboard and shows a confirmation.
               * @param {{textToCopy: string}} props - The text to be copied.
               */
              
              const CopyButton = ({ textToCopy }) => {
                  const [copied, setCopied] = React.useState(false);
                  const { addToast } = useToast();
              
                  const handleCopy = () => {
                      if (textToCopy) {
                          navigator.clipboard.writeText(textToCopy).then(() => {
                              addToast('Copied to clipboard!');
                              setCopied(true);
                              // Revert the icon back to the copy icon after 2 seconds.
                              setTimeout(() => setCopied(false), 2000);
                          });
                      }
                  };
              
                  return (
                      <button onClick={handleCopy} className="p-2 text-slate-400 hover:text-sky-500 transition-colors" title="Copy to clipboard" aria-label="Copy result to clipboard">
                          <Icon path={copied ? ICONS.check : ICONS.copy} className="w-5 h-5" />
                      </button>
                  );
              };
              
              /**
               * @description The main header for the application.
               * @param {{onHelpClick: () => void, theme: string, toggleTheme: () => void}} props - Handlers and state for help and theme toggling.
               */
              
              const Header = ({ onHelpClick, theme, toggleTheme, onNavClick }) => (
              
              <header className="flex items-center p-4 md:p-6 border-b border-slate-200 dark:border-slate-700">
              
              <div className="flex-1 flex justify-start">
                  <Tooltip text="Toggle Theme" widthClass="w-auto">
                      <button onClick={toggleTheme} className="p-2 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Toggle dark mode">
                          <Icon path={theme === 'dark' ? ICONS.sun : ICONS.moon} className="w-6 h-6" />
                      </button>
                  </Tooltip>
              </div>
              
              <div className="flex-1 text-center">
                  <h1 className="text-xl md:text-3xl font-bold text-gray-800 dark:text-slate-100">Health Physics Toolbox</h1>
                  <p className="text-sm text-slate-500 dark:text-slate-400 mt-2">
                      Version: {VERSION} | Last Updated: {LAST_UPDATED}
                  </p>
              </div>
              
              <div className="flex-1 flex justify-end items-center gap-2">
                  {/* MODIFIED: Added rel="noopener noreferrer" for security */}
                  <a href="https://www.buymeacoffee.com/jough" target="_blank" rel="noopener noreferrer" className="hidden md:block">
                      <img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} />
                  </a>
                  <div className="flex flex-col">
                    <Tooltip text="Settings" widthClass="w-auto">
              
                        <button onClick={() => onNavClick(VIEWS.SETTINGS)} className="p-1 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open settings panel">
                            <Icon path={ICONS.settings} className="w-5 h-5" />
                        </button>
                    </Tooltip>
                      <Tooltip text="Open User Manual" widthClass="w-auto">
                          <button onClick={onHelpClick} className="p-1 text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors" aria-label="Open User Manual">
                              <Icon path={ICONS.help} className="w-5 h-5" />
                          </button>
                      </Tooltip>
                  </div>
              </div>
              </header>
              );
              
              /**
               * @description The primary search input with auto-suggestions.
               * @param {object} props - Contains all state and handlers for the search functionality.
               * @param {string} props.nuclideName - The current value of the search input.
               * @param {React.RefObject} props.inputRef - Ref for the input element.
               * @param {(e: React.ChangeEvent) => void} props.handleNuclideNameChange - Handler for input changes.
               * @param {(e: React.KeyboardEvent) => void} props.handleKeyDown - Handler for keyboard events (arrow keys, Enter).
               * @param {() => void} props.onClear - Handler to clear the search input.
               * @param {Array<object>} props.suggestions - The list of suggestion items.
               * @param {number} props.activeSuggestionIndex - The index of the currently highlighted suggestion.
               * @param {React.RefObject} props.suggestionsRef - Ref for the suggestions list container.
               * @param {(nuclide: object) => void} props.handleNuclideSelection - Handler for when a nuclide is selected.
               */
              
         const SearchBar = ({ nuclideName, inputRef, handleNuclideNameChange, handleKeyDown, onClear, suggestions, activeSuggestionIndex, suggestionsRef, handleNuclideSelection, onNavClick, isFocused, onFocus, onBlur }) => (
         <div className="relative p-4 flex items-center gap-2">
             <div className="relative flex-grow">
                 <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <Icon path={ICONS.search} className="w-5 h-5 text-slate-400" />
                 </div>
                 <input
                     ref={inputRef}
                     type="text"
                     value={nuclideName}
                     onChange={handleNuclideNameChange}
                     onKeyDown={handleKeyDown}
                     onFocus={onFocus}
                     onBlur={onBlur}
                     placeholder="Search by name or symbol (e.g., U-238)"
                     className="w-full p-3 pl-10 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition"
                 />
                 {nuclideName && (
                     <button onClick={onClear} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-sky-500 focus:outline-none">
                         <Icon path={ICONS.clear} className="w-5 h-5" />
                     </button>
                 )}
             </div>
         
             <button
                  onClick={() => onNavClick('home')}
                  className="hidden md:flex items-center gap-2 p-3 md:px-4 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-500 hover:text-sky-500 dark:text-slate-400 dark:hover:text-sky-400 transition-colors border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"
                  aria-label="Home"
              >
                  <Icon path={ICONS.home} className="w-5 h-5" />
                  <span className="font-semibold">Home</span>
              </button>
             
             {isFocused && suggestions.length > 0 && (
                 <ul ref={suggestionsRef} className="absolute z-20 top-full left-4 right-4 mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg shadow-lg max-h-72 overflow-y-auto">
                     {suggestions.map((s, i) => {
                         const styles = CATEGORY_STYLES[s.category] || CATEGORY_STYLES['default'];
                         return (
                             <li
                                 key={s.symbol}
                                 className={`p-3 pl-4 cursor-pointer text-slate-700 dark:text-slate-200 border-l-2 ${styles.border} ${styles.hoverBg} ${i === activeSuggestionIndex ? 'bg-sky-100 dark:bg-sky-900/50' : ''}`}
                                 onClick={() => handleNuclideSelection(s)}
                             >
                                 {s.name} ({s.symbol}) <span className="text-xs text-slate-500 dark:text-slate-400">{s.commonality}</span>
                             </li>
                         );
                     })}
                     {suggestions.length > 4 && (
                         <div className="sticky bottom-0 bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm p-2 border-t border-slate-200 dark:border-slate-700">
                             <div className="flex flex-wrap justify-center gap-x-3 gap-y-1">
                                 {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                     const bgColor = styles.border.replace('border-l-', 'bg-');
                                     return (
                                         <div key={category} className="flex items-center gap-1.5">
                                             <div className={`w-2.5 h-2.5 rounded-full ${bgColor}`}></div>
                                             <span className="text-xs text-slate-500 dark:text-slate-400">{category.replace('/', '/ ')}</span>
                                         </div>
                                     );
                                 })}
                             </div>
                         </div>
                     )}
                 </ul>
             )}
         </div>
         );
              
              /**
              * @description A button that appears when the user scrolls down, allowing them to quickly return to the top of the page.
              */
              
              const BackToTopButton = () => {
              const [isVisible, setIsVisible] = React.useState(false);
              
              // This function is called whenever the user scrolls
              
              const toggleVisibility = () => {
              if (window.pageYOffset > 300) { // Show button if scrolled more than 300px
                  setIsVisible(true);
              } else {
                  setIsVisible(false);
              }
              };
              
              // This function scrolls the page to the top smoothly
              
              const scrollToTop = () => {
              window.scrollTo({
                  top: 0,
                  behavior: 'smooth'
              });
              };
              
              React.useEffect(() => {
              window.addEventListener('scroll', toggleVisibility);
              // Clean up the listener when the component is removed
              return () => {
                  window.removeEventListener('scroll', toggleVisibility);
              };
              }, []);
              
              return (
              <div className="fixed bottom-4 right-4 z-50">
                  {isVisible && (
                      <button
                          onClick={scrollToTop}
                          className="p-3 bg-sky-600 text-white rounded-full shadow-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-300 animate-fade-in"
                          aria-label="Go to top"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          </svg>
                      </button>
                  )}
              </div>
              );
              };
              
              /**
               * @description The main navigation bar, which is responsive for mobile and desktop.
               * @param {{activeView: string, onNavClick: (view: string) => void}} props - The currently active view and the click handler.
               */
              
              const MainNav = ({ activeView, onNavClick }) => {
              
              const navItems = [
              { id: VIEWS.HOME, label: 'Home', icon: ICONS.home },
              { id: VIEWS.DATABASE, label: 'Database', icon: ICONS.database },
              { id: VIEWS.COMPARE, label: 'Compare', icon: ICONS.compare },
              { id: VIEWS.CALCULATOR, label: 'Decay', icon: ICONS.calculator },
              { id: VIEWS.MDA, label: 'MDA', icon: ICONS.search },
              { id: VIEWS.MARSSIM_SAMPLES, label: 'MARSSIM Sample Design', icon: ICONS.calculator },
              { id: VIEWS.MARSSIM_TESTS, label: 'MARSSIM Tests', icon: ICONS.database },
              { id: VIEWS.SERIES_CALCULATOR, label: 'Series Decay', icon: ICONS.series },
              { id: VIEWS.EQUILIBRIUM, label: 'Equilibrium', icon: ICONS.activity },
              { id: VIEWS.RADON, label: 'Radon', icon: ICONS.radon },
              { id: VIEWS.ACTIVITY_MASS, label: 'Activity/Mass', icon: ICONS.mass },
              { id: VIEWS.DOSE_RATE, label: 'Dose & Dose Rate', icon: ICONS.doseRate },
              { id: VIEWS.SHIELDING, label: 'Shielding', icon: ICONS.shield },
              { id: VIEWS.STAY_TIME, label: 'Stay Time', icon: ICONS.stopwatch },
              { id: VIEWS.NEUTRON, label: 'Neutron Tools', icon: ICONS.neutron },
              { id: VIEWS.OPERATIONAL_HP, label: 'Operational HP', icon: ICONS.shield },
              { id: VIEWS.TRANSPORTATION, label: 'Transportation', icon: ICONS.transport },
              { id: VIEWS.CONVERTER, label: 'Converter', icon: ICONS.converter },
              { id: VIEWS.LAB_STATS, label: 'Lab Stats', icon: ICONS.labStats },
              { id: VIEWS.PEAK_ID, label: 'Peak ID', icon: ICONS.gammaSpec },
              { id: VIEWS.MEDICAL, label: 'Medical', icon: ICONS.medical },
              
              { id: VIEWS.SCRATCHPAD, label: 'Scratchpad', icon: ICONS.notepad },
         
         { id: VIEWS.SCIENTIFIC_CALCULATOR, label: 'Sci. Calculator', icon: ICONS.scientificCalculator },
         
              { id: VIEWS.REFERENCES, label: 'References', icon: ICONS.references }
              ];
              
              const NavButton = ({ item }) => (
              <button
                 onClick={() => onNavClick(item.id)}
                 className="flex-shrink-0 w-full"
              >
                 <span
                      className={`mx-auto flex items-center justify-center gap-2 px-2 py-2 text-sm font-semibold rounded-md transition-all duration-200 ${
                         activeView === item.id
                             ? 'bg-white dark:bg-slate-900 text-sky-600 dark:text-sky-400 shadow'
                             : 'text-slate-600 dark:text-slate-300 hover:bg-sky-100 dark:hover:bg-sky-800 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md hover:-translate-y-1'
                     }`}
                 >
                     <Icon path={item.icon} className="w-4 h-4" />
                     <span className="truncate">{item.label}</span>
                 </span>
              </button>
              );
              
              return (
              <div className="px-4 pb-2">
                 <div className="md:hidden">
                     <div className="grid grid-cols-2 gap-4">
                         {navItems.map(item => (
                             <button
                                 key={item.id}
                                 onClick={() => onNavClick(item.id)}
                                 // --- MODIFIED LINE: Removed the col-span-2 conditional ---
                                 className={`flex flex-col items-center justify-center p-4 rounded-lg text-center transition-all duration-150 ease-in-out ${
                                     activeView === item.id
                                         ? 'bg-sky-100 dark:bg-sky-900/50 text-sky-600 dark:text-sky-400'
                                         : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-sky-100 dark:hover:bg-sky-900/50 active:scale-95'
                                 }`}
                             >
                                 <Icon path={item.icon} className="w-8 h-8 mb-2" />
                                 <span className="text-sm font-semibold">{item.label}</span>
                             </button>
                         ))}
                     </div>
                 </div>
                 <div className="hidden md:grid grid-cols-4 lg:grid-cols-6 gap-2">
         
         {navItems.map(item => <NavButton key={item.id} item={item} />)}
         
                 </div>
              </div>
              );
              };
              
              //==============================================================================
              // --- VIEW COMPONENTS
              // These components represent the main content areas of the application.
              //==============================================================================
              
const CalculationHistoryPanel = ({ onNavClick }) => {
    const [history, setHistory] = React.useState([]);
    const [isClearModalOpen, setIsClearModalOpen] = React.useState(false);

    React.useEffect(() => {
        const savedHistory = localStorage.getItem('rad_tool_calculation_history');
        if (savedHistory) {
            setHistory(JSON.parse(savedHistory));
        }
    }, []);

    const handleClearHistory = () => {
        localStorage.removeItem('rad_tool_calculation_history');
        setHistory([]);
        setIsClearModalOpen(false);
    };

    const handleItemClick = (view) => {
        if (view && onNavClick) {
            onNavClick(view);
        }
    };

    // Helper to format the timestamp
    const formatTime = (timestamp) => {
        if (!timestamp) return '';
        return new Date(timestamp).toLocaleString('en-US', {
            month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
        });
    };

    if (history.length === 0) {
        return null;
    }

    return (
        <>
            <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                <div className="flex justify-between items-center mb-4">
                    <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Recent Calculations</h4>
                    <button onClick={() => setIsClearModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">
                        Clear History
                    </button>
                </div>
                <div className="space-y-3">
                    {history.map(item => (
                        <button
                            key={item.id}
                            onClick={() => handleItemClick(item.view)}
                            className="w-full text-left p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:ring-2 hover:ring-sky-500 transition-all duration-150 relative group"
                        >
                            {/* Timestamp Badge */}
                            <span className="absolute top-3 right-3 text-[10px] text-slate-400 font-mono bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                                {formatTime(item.id)}
                            </span>

                            <div className="flex items-start gap-4 pr-16"> {/* Added padding-right to avoid overlap with timestamp */}
                                {item.icon && <Icon path={item.icon} className="w-8 h-8 text-slate-400 dark:text-slate-500 mt-1 flex-shrink-0" />}
                                <div className="flex-grow">
                                    <p className="font-bold text-sky-600 dark:text-sky-400">{item.type}</p>
                                    <p className="text-sm text-slate-600 dark:text-slate-300">
                                        <span className="font-semibold">Inputs:</span> {item.inputs}
                                    </p>
                                    <p className="text-sm text-slate-800 dark:text-slate-100">
                                        <span className="font-semibold">Result:</span> {item.result}
                                    </p>
                                </div>
                            </div>
                        </button>
                    ))}
                </div>
            </div>

            <ConfirmationModal
                isOpen={isClearModalOpen}
                onClose={() => setIsClearModalOpen(false)}
                onConfirm={handleClearHistory}
                title="Clear Calculation History"
            >
                <p>Are you sure you want to clear your five most recent calculations?</p>
            </ConfirmationModal>
        </>
    );
};
              
              /**
              * @description The landing page view, showing suggestions, search history, favorites, or the main search result.
              * @param {object} props - Contains data and handlers for the home page.
              */
              
             const HomePage = ({ errorMessage, randomSuggestions, searchHistory, handleNuclideSelection, handleClearHistory, favorites, radionuclides, handleClearFavorites, onNavClick }) => {
    const [isFavoritesModalOpen, setIsFavoritesModalOpen] = React.useState(false);
    const [isHistoryModalOpen, setIsHistoryModalOpen] = React.useState(false);

    const favoriteNuclides = React.useMemo(() =>
        favorites.map(symbol => radionuclides.find(n => n.symbol === symbol)).filter(Boolean),
        [favorites, radionuclides]
    );

    const searchHistoryNuclides = React.useMemo(() =>
        searchHistory.map(symbol => radionuclides.find(n => n.symbol === symbol)).filter(Boolean),
        [searchHistory, radionuclides]
    );

    const confirmClearFavorites = () => {
        handleClearFavorites();
        setIsFavoritesModalOpen(false);
    };

    const confirmClearHistory = () => {
        handleClearHistory();
        setIsHistoryModalOpen(false);
    };

    const isNewUser = favoriteNuclides.length === 0 && searchHistoryNuclides.length === 0;

    return (
        <div className="p-4 sm:p-6 space-y-6">
            {errorMessage && (
                <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                    <p className="font-bold">Error</p><p>{errorMessage}</p>
                </div>
            )}

            {/* --- UPDATED: Educational Welcome Banner --- */}
            {isNewUser && (
                <div className="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700 border-l-8 border-l-sky-500 animate-fade-in">
                    <h2 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">Welcome to the Health Physics Toolbox</h2>
                    <p className="text-slate-600 dark:text-slate-300 mb-6 max-w-3xl">
                        This is a unified platform for radiological calculations. Data flows automatically from the database to the tools, saving you time and reducing manual entry errors.
                    </p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Feature 1: Database */}
                        <div className="flex flex-col gap-2">
                            <div className="flex items-center gap-2 text-sky-600 dark:text-sky-400">
                                <div className="p-2 bg-sky-50 dark:bg-sky-900/30 rounded-lg">
                                    <Icon path={ICONS.database} className="w-6 h-6" />
                                </div>
                                <h3 className="font-bold text-lg">Robust Database</h3>
                            </div>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                Access detailed decay properties, gamma constants, and regulatory limits (10 CFR 20, DOT) for over 100 radionuclides. Start by searching above.
                            </p>
                        </div>

                        {/* Feature 2: Smart Calculators */}
                        <div className="flex flex-col gap-2">
                            <div className="flex items-center gap-2 text-amber-600 dark:text-amber-400">
                                <div className="p-2 bg-amber-50 dark:bg-amber-900/30 rounded-lg">
                                    <Icon path={ICONS.calculator} className="w-6 h-6" />
                                </div>
                                <h3 className="font-bold text-lg">Integrated Math</h3>
                            </div>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                Select a nuclide to pre-fill standard values into shielding, decay, and dose rate calculators. No more looking up half-lives manually.
                            </p>
                        </div>

                        {/* Feature 3: Operational Tools */}
                        <div className="flex flex-col gap-2">
                            <div className="flex items-center gap-2 text-emerald-600 dark:text-emerald-400">
                                <div className="p-2 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg">
                                    <Icon path={ICONS.shield} className="w-6 h-6" />
                                </div>
                                <h3 className="font-bold text-lg">Field Ready</h3>
                            </div>
                            <p className="text-sm text-slate-600 dark:text-slate-400">
                                Plan MARSSIM surveys, determine shipping labels, or calculate patient release criteria with tools designed for operational health physics.
                            </p>
                        </div>
                    </div>
                </div>
            )}

            {/* --- 1. FAVORITES --- */}
            {favoriteNuclides.length > 0 && (
                <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Your Favorites</h4>
                        <button onClick={() => setIsFavoritesModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline focus:outline-none">
                            Clear Favorites
                        </button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {favoriteNuclides.map(n => (
                            <NuclideCard
                                key={n.symbol}
                                nuclide={n}
                                isCompact={true}
                                onNuclideClick={handleNuclideSelection}
                            />
                        ))}
                    </div>
                </div>
            )}

            {/* --- 2. RECENT SEARCHES --- */}
            {searchHistoryNuclides.length > 0 && (
                <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 text-left">Recent Searches</h4>
                        <button onClick={() => setIsHistoryModalOpen(true)} className="text-xs text-sky-600 dark:text-sky-400 hover:underline focus:outline-none">
                            Clear History
                        </button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {searchHistoryNuclides.map(n => (
                            <NuclideCard
                                key={n.symbol}
                                nuclide={n}
                                isCompact={true}
                                onNuclideClick={handleNuclideSelection}
                            />
                        ))}
                    </div>
                </div>
            )}

            {/* --- 3. RECENT CALCULATIONS --- */}
            <CalculationHistoryPanel onNavClick={onNavClick} />

            {/* --- 4. QUICK SUGGESTIONS --- */}
            <div className="bg-slate-100 dark:bg-slate-800/50 p-6 rounded-xl">
                <h4 className="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 text-left">Quick Suggestions</h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    {randomSuggestions.map(n => (
                        <NuclideCard
                            key={n.symbol}
                            nuclide={n}
                            isCompact={true}
                            onNuclideClick={handleNuclideSelection}
                        />
                    ))}
                </div>
            </div>

            <ConfirmationModal
                isOpen={isFavoritesModalOpen}
                onClose={() => setIsFavoritesModalOpen(false)}
                onConfirm={confirmClearFavorites}
                title="Clear All Favorites"
            >
                <p>Are you sure you want to clear your entire list of favorites? This action cannot be undone.</p>
            </ConfirmationModal>

            <ConfirmationModal
                isOpen={isHistoryModalOpen}
                onClose={() => setIsHistoryModalOpen(false)}
                onConfirm={confirmClearHistory}
                title="Clear Search History"
            >
                <p>Are you sure you want to clear your recent search history?</p>
            </ConfirmationModal>

        </div>
    );
};
              
/**
 * @description A robust note-taking component with Markdown preview support.
 * * @param {{notes: string, setNotes: (notes: string) => void}} props
 */
const Scratchpad = ({ notes, setNotes }) => {
    const [isClearModalOpen, setIsClearModalOpen] = React.useState(false);
    const [viewMode, setViewMode] = React.useState('edit'); // 'edit' or 'preview'
    const { addToast } = useToast();
    
    const handleCopyAll = () => {
        if (notes) {
            navigator.clipboard.writeText(notes);
            addToast('Notes copied to clipboard!');
        }
    };
    
    const handleExport = () => {
        const blob = new Blob([notes], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'radcalc-notes.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    const handleInsertTimestamp = () => {
        const timestamp = new Date().toLocaleString();
        setNotes(prev => prev + `\n**[${timestamp}]**\n`);
        addToast('Timestamp inserted!');
    };
    
    const handleConfirmClear = () => {
        setNotes('');
        setIsClearModalOpen(false);
        addToast('Scratchpad cleared.');
    };
    
    // Stats
    const characterCount = notes.replace(/\s/g, '').length; // Count non-whitespace chars
    const wordCount = notes.trim() === '' ? 0 : notes.trim().split(/\s+/).filter(Boolean).length;
    
    // Simple Markdown Parser (for Preview)
    const renderMarkdown = (text) => {
        if (!text) return <p className="text-slate-400 italic">Nothing to preview...</p>;
        
        return text.split('\n').map((line, i) => {
            // Headers
            if (line.startsWith('### ')) return <h3 key={i} className="text-lg font-bold mt-2 mb-1">{line.slice(4)}</h3>;
            if (line.startsWith('## ')) return <h2 key={i} className="text-xl font-bold mt-3 mb-2 border-b border-slate-200 dark:border-slate-700 pb-1">{line.slice(3)}</h2>;
            if (line.startsWith('# ')) return <h1 key={i} className="text-2xl font-extrabold mt-4 mb-2">{line.slice(2)}</h1>;
            
            // Lists
            if (line.startsWith('- ')) return <li key={i} className="ml-4 list-disc">{line.slice(2)}</li>;
            
            // Bold (Simple regex for **text**)
            const parts = line.split(/(\*\*.*?\*\*)/g);
            return (
                <p key={i} className="min-h-[1.2em] mb-1">
                    {parts.map((part, j) => {
                        if (part.startsWith('**') && part.endsWith('**')) {
                            return <strong key={j}>{part.slice(2, -2)}</strong>;
                        }
                        return part;
                    })}
                </p>
            );
        });
    };
    
    return (
        <>
            <div className="flex justify-between items-end mb-2">
                <p className="text-sm text-slate-500 dark:text-slate-400">
                    Auto-saved to local storage. Supports basic Markdown.
                </p>
                {/* View Toggle */}
                <div className="flex bg-slate-200 dark:bg-slate-700 rounded-lg p-1">
                    <button onClick={() => setViewMode('edit')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${viewMode === 'edit' ? 'bg-white dark:bg-slate-600 shadow text-sky-600' : 'text-slate-500'}`}>Edit</button>
                    <button onClick={() => setViewMode('preview')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${viewMode === 'preview' ? 'bg-white dark:bg-slate-600 shadow text-sky-600' : 'text-slate-500'}`}>Preview</button>
                </div>
            </div>
            
            <div className="bg-slate-100 dark:bg-slate-700/50 rounded-t-md border-b border-slate-200 dark:border-slate-700 p-2 flex flex-wrap items-center gap-2">
                <button onClick={handleInsertTimestamp} className="px-3 py-1.5 text-xs bg-white dark:bg-slate-600 border border-slate-300 dark:border-slate-500 rounded hover:bg-slate-50 dark:hover:bg-slate-500 transition font-medium flex items-center gap-1">
                    <Icon path={ICONS.stopwatch} className="w-3 h-3" /> Timestamp
                </button>
                <button onClick={handleCopyAll} className="px-3 py-1.5 text-xs bg-white dark:bg-slate-600 border border-slate-300 dark:border-slate-500 rounded hover:bg-slate-50 dark:hover:bg-slate-500 transition font-medium flex items-center gap-1">
                    <Icon path={ICONS.copy} className="w-3 h-3" /> Copy
                </button>
                <button onClick={handleExport} className="px-3 py-1.5 text-xs bg-white dark:bg-slate-600 border border-slate-300 dark:border-slate-500 rounded hover:bg-slate-50 dark:hover:bg-slate-500 transition font-medium flex items-center gap-1">
                    <Icon path={ICONS.database} className="w-3 h-3" /> Save .txt
                </button>
                <div className="flex-grow"></div>
                <button onClick={() => setIsClearModalOpen(true)} className="text-xs text-red-500 hover:text-red-700 font-bold flex items-center gap-1 px-2">
                    <Icon path={ICONS.clear} className="w-3 h-3"/> Clear
                </button>
            </div>

            {viewMode === 'edit' ? (
                <textarea
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    placeholder="# Project Notes\n- Alpha survey complete\n- Background: 50 cpm"
                    className="w-full h-96 p-4 rounded-b-md bg-white dark:bg-slate-900 font-mono text-sm border-x border-b border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-sky-500 focus:outline-none resize-none"
                />
            ) : (
                <div className="w-full h-96 p-6 rounded-b-md bg-white dark:bg-slate-900 overflow-y-auto border-x border-b border-slate-200 dark:border-slate-700 prose dark:prose-invert max-w-none text-sm">
                    {renderMarkdown(notes)}
                </div>
            )}
            
            <div className="flex justify-between items-center mt-2 px-1">
                <span className="text-[10px] text-slate-400">Markdown supported: # Header, **Bold**, - List</span>
                <div className="text-right text-xs text-slate-500 dark:text-slate-400 font-mono">
                    <span className="font-bold">{wordCount}</span> words <span className="mx-1 opacity-30">|</span> <span className="font-bold">{characterCount}</span> chars
                </div>
            </div>

            <ConfirmationModal
                isOpen={isClearModalOpen}
                onClose={() => setIsClearModalOpen(false)}
                onConfirm={handleConfirmClear}
                title="Clear Scratchpad?"
            >
                <p>Are you sure you want to delete all notes? This cannot be undone.</p>
            </ConfirmationModal>
        </>
    );
};

/**
 * @description A professional-grade scientific calculator component.
 */
const ScientificCalculator = ({ calcState, setCalcState }) => {
    const { addToast } = useToast();
    const calculatorRef = React.useRef(null);

    // --- State ---
    const [customConstants, setCustomConstants] = React.useState(() => {
        try { return JSON.parse(localStorage.getItem('user_calc_constants') || '[]'); }
        catch { return []; }
    });
    const [isAddMode, setIsAddMode] = React.useState(false);
    const [newConstName, setNewConstName] = React.useState('');
    const [newConstVal, setNewConstVal] = React.useState('');
    const [angleMode, setAngleMode] = React.useState('deg'); // Default to DEG (more common for techs)
    const [activeKey, setActiveKey] = React.useState(null);

    // Ensure state has new fields
    React.useEffect(() => {
        setCalcState(prev => ({
            ...prev,
            lastAnswer: prev.lastAnswer || 0,
            memory: prev.memory || 0,
            isError: false
        }));
    }, [setCalcState]);

    // Save constants
    React.useEffect(() => {
        localStorage.setItem('user_calc_constants', JSON.stringify(customConstants));
    }, [customConstants]);

    const { expression, result, history, memory, lastAnswer, isError } = calcState;

    // --- Helper: Format Display Number ---
    const formatNumber = (numStr) => {
        if (!numStr) return '';
        if (numStr.includes('e') || isError) return numStr;
        const num = parseFloat(numStr);
        if (isNaN(num)) return numStr;
        // Limit precision to fit screen, but keep decimals
        return num.toLocaleString('en-US', { maximumFractionDigits: 10, maximumSignificantDigits: 12 });
    };

    // --- Core Logic ---
    const safeEvaluate = (expr, currentMode, currentAns) => {
        try {
            // Clean up visual operators for mathjs
            let cleanExpr = expr.replace(/×/g, '*').replace(/÷/g, '/');
            
            const scope = {
                Ans: currentAns,
                ...math,
                // Trig overrides for DEG mode
                sin: (x) => currentMode === 'deg' ? math.sin(math.unit(x, 'deg')) : math.sin(x),
                cos: (x) => currentMode === 'deg' ? math.cos(math.unit(x, 'deg')) : math.cos(x),
                tan: (x) => currentMode === 'deg' ? math.tan(math.unit(x, 'deg')) : math.tan(x),
                asin: (x) => currentMode === 'deg' ? math.asin(x) * (180 / Math.PI) : math.asin(x),
                acos: (x) => currentMode === 'deg' ? math.acos(x) * (180 / Math.PI) : math.acos(x),
                atan: (x) => currentMode === 'deg' ? math.atan(x) * (180 / Math.PI) : math.atan(x),
            };
            
            const evalResult = math.evaluate(cleanExpr, scope);
            if (typeof evalResult === 'object' && evalResult.re) return evalResult.re; 
            return evalResult;
        } catch (e) {
            throw new Error('Invalid Syntax');
        }
    };

    const handleCalculate = React.useCallback(() => {
        setCalcState(currentState => {
            if (!currentState.expression) return currentState;
            try {
                const evalResult = safeEvaluate(currentState.expression, angleMode, currentState.lastAnswer);
                
                let resultStr;
                if (Math.abs(evalResult) < 1e-9 || Math.abs(evalResult) > 1e12) {
                    resultStr = evalResult.toExponential(6).replace('e+', 'e');
                } else {
                    resultStr = parseFloat(evalResult.toPrecision(12)).toString(); // Clean trailing zeros
                }
                
                // Add to history (Limit to 50 items)
                const newHistoryItem = { expr: currentState.expression, res: resultStr };
                const newHistory = [newHistoryItem, ...(currentState.history || [])].slice(0, 50);

                return {
                    ...currentState,
                    result: resultStr,
                    lastAnswer: evalResult,
                    history: newHistory,
                    expression: '', 
                    isError: false
                };
            } catch (e) {
                return { ...currentState, result: 'Error', isError: true };
            }
        });
    }, [setCalcState, angleMode]);

    const handleInput = React.useCallback((val) => {
        setCalcState(currentState => {
            if (currentState.isError) {
                const initExpr = val === '.' ? '0.' : val;
                return { ...currentState, expression: initExpr, result: '', isError: false };
            }
            
            let newExpression = currentState.expression;
            const isOperator = ['+', '-', '*', '/', '^', '%', '!', '^', '×', '÷'].includes(val);
            
            // Smart Decimal: Prefix "0." if empty or after operator
            if (val === '.') {
                const segments = newExpression.split(/[\+\-\*\/\^\%\(\)×÷]/);
                const currentSegment = segments[segments.length - 1];
                if (currentSegment.includes('.')) return currentState; // Prevent 1.2.3
                if (newExpression === '' || /[\+\-\*\/\^\%\(×÷]$/.test(newExpression)) {
                     return { ...currentState, expression: newExpression + '0.', result: '' };
                }
            }

            // Smart Start: If result exists and typing operator, use Ans
            if (newExpression === '' && currentState.result !== '') {
                if (isOperator) {
                    newExpression = 'Ans';
                } else if (val === 'e') { // EXP shortcut
                    return { ...currentState, expression: 'Ans*10^', result: '' };
                } else if (!isNaN(parseInt(val)) || val === '.') {
                    // Typing number overwrites result (implicit AC)
                    const startVal = val === '.' ? '0.' : val;
                    return { ...currentState, expression: startVal, result: '' };
                }
            }

            // Smart EXP key
            if (val === 'e' && newExpression.endsWith('Ans')) {
                return { ...currentState, expression: newExpression + '*10^', result: '' };
            }
            
            return { ...currentState, expression: newExpression + val, result: '' };
        });
        
        if (calculatorRef.current) calculatorRef.current.focus();

    }, [setCalcState]);

    const handleClear = () => setCalcState(s => ({ ...s, expression: '', result: '', isError: false }));
    const handleBackspace = () => setCalcState(s => ({ ...s, expression: s.expression.slice(0, -1) }));
    
    // Memory
    const memClear = () => { setCalcState(s => ({ ...s, memory: 0 })); addToast("Memory Cleared"); };
    const memRecall = () => { setCalcState(s => ({ ...s, expression: s.expression + s.memory })); };
    const memAdd = () => {
        try {
            const valToStore = calcState.expression ? safeEvaluate(calcState.expression, angleMode, lastAnswer) : (parseFloat(calcState.result) || 0);
            setCalcState(s => ({ ...s, memory: s.memory + valToStore }));
            addToast(`M+ (${(calcState.memory + valToStore).toPrecision(4)})`);
        } catch { addToast("Invalid value"); }
    };
    const memSub = () => {
        try {
            const valToStore = calcState.expression ? safeEvaluate(calcState.expression, angleMode, lastAnswer) : (parseFloat(calcState.result) || 0);
            setCalcState(s => ({ ...s, memory: s.memory - valToStore }));
            addToast(`M- (${(calcState.memory - valToStore).toPrecision(4)})`);
        } catch { addToast("Invalid value"); }
    };

    const handleHistoryClick = (histItem) => {
        handleInput(histItem.res); // Insert the result
        addToast("Value inserted from history");
    };

    const copyResult = () => {
        const textToCopy = result || expression;
        if (textToCopy) {
            navigator.clipboard.writeText(textToCopy);
            addToast("Copied to clipboard");
        }
    };

    const handleKeyDown = React.useCallback((event) => {
        const { key } = event;
        if (event.target.tagName === 'INPUT') return; 

        let mappedKey = key;
        if (key === 'Enter') mappedKey = '=';
        if (key === 'Escape') mappedKey = 'AC';
        if (key === 'Backspace' || key === 'Delete') mappedKey = 'DEL';
        
        setActiveKey(mappedKey);
        setTimeout(() => setActiveKey(null), 150);

        if (/[0-9+\-*/.^()%!]/.test(key)) { event.preventDefault(); handleInput(key); }
        else if (key === 'Enter' || key === '=') { event.preventDefault(); handleCalculate(); }
        else if (key === 'Backspace' || key === 'Delete') { event.preventDefault(); handleBackspace(); }
        else if (key === 'Escape') { event.preventDefault(); handleClear(); }
        else if (key === 'e' || key === 'E') { event.preventDefault(); handleInput('e'); }
    }, [handleInput, handleCalculate, handleBackspace, handleClear]);

    const insertConstant = (constVal, name) => {
        handleInput(constVal);
        addToast(`${name} inserted`);
    };

    const handleAddConstant = () => {
        if (!newConstName || !newConstVal) { addToast("Name and Value required"); return; }
        if (isNaN(parseFloat(newConstVal))) { addToast("Value must be a number"); return; }
        setCustomConstants(prev => [...prev, { name: newConstName, value: newConstVal }]);
        setNewConstName(''); setNewConstVal(''); setIsAddMode(false);
        addToast("Constant Saved");
    };

    const handleDeleteConstant = (index, name) => {
        setCustomConstants(prev => prev.filter((_, i) => i !== index));
        addToast(`Deleted ${name}`);
    };

    const btnClass = "p-3 text-sm font-bold rounded-lg transition-all shadow-sm border-b-2 active:border-b-0 active:translate-y-[2px] active:brightness-90 duration-75 select-none";
    const getBtnStyle = (baseStyle, keyVal) => {
        const isActive = activeKey === keyVal;
        return `${baseStyle} ${isActive ? 'brightness-90 border-b-0 translate-y-[2px]' : ''}`;
    };

    const styles = {
        num: `${btnClass} bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-900 hover:bg-slate-200 dark:hover:bg-slate-700`,
        op: `${btnClass} bg-slate-300 dark:bg-slate-600 text-slate-800 dark:text-slate-100 border-slate-400 dark:border-slate-900 hover:bg-slate-400 dark:hover:bg-slate-500`,
        func: `${btnClass} bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-xs border-slate-300 dark:border-slate-900 hover:bg-slate-300 dark:hover:bg-slate-600`,
        mem: `${btnClass} bg-amber-200 dark:bg-amber-700 text-amber-900 dark:text-amber-100 text-xs border-amber-300 dark:border-amber-900 hover:bg-amber-300 dark:hover:bg-amber-600`,
        action: `${btnClass} bg-sky-600 text-white border-sky-800 hover:bg-sky-500`,
        danger: `${btnClass} bg-red-500 text-white border-red-700 hover:bg-red-600`,
        del: `${btnClass} bg-red-200 dark:bg-red-900/50 text-red-800 dark:text-red-200 border-red-300 dark:border-red-900 hover:bg-red-300 dark:hover:bg-red-800`
    };

    return (
        <div 
            ref={calculatorRef}
            onKeyDown={handleKeyDown} 
            tabIndex="0" 
            className="focus:outline-none rounded-2xl p-6 shadow-xl bg-sky-50 dark:bg-slate-900 border-2 border-sky-600 dark:border-sky-700 transition-colors"
        >
            {/* LCD Screen */}
            <div className="bg-slate-100 dark:bg-black rounded-xl p-4 mb-4 border-4 border-slate-300 dark:border-slate-700 shadow-inner relative">
                
                {/* Header Row */}
                <div className="flex justify-between items-start mb-2 h-6">
                    <div className="flex gap-2">
                        <button 
                            onClick={() => setAngleMode(prev => prev === 'rad' ? 'deg' : 'rad')}
                            className="text-[10px] font-bold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded shadow-sm hover:bg-slate-300 transition"
                        >
                            {angleMode.toUpperCase()}
                        </button>
                        {memory !== 0 && (
                            <span className="text-[10px] font-bold bg-amber-200 dark:bg-amber-700 text-amber-900 dark:text-amber-100 px-1.5 py-0.5 rounded shadow-sm animate-pulse">M</span>
                        )}
                    </div>
                    <div className="flex gap-2">
                        {(result || expression) && (
                            <Tooltip text="Copy Result">
                                <button onClick={copyResult} className="text-slate-400 hover:text-sky-600 transition">
                                    <Icon path={ICONS.copy} className="w-3.5 h-3.5" />
                                </button>
                            </Tooltip>
                        )}
                        <Tooltip text="Shortcuts: 'e'=EXP, Backspace=DEL" position="left">
                            <span className="text-slate-400 cursor-help"><Icon path={ICONS.help} className="w-3.5 h-3.5" /></span>
                        </Tooltip>
                    </div>
                </div>

                {/* History (Paper Tape Style) */}
                <div className="h-24 overflow-y-auto flex flex-col-reverse pr-1 custom-scrollbar gap-1">
                    {history.map((h, i) => (
                        <div 
                            key={i} 
                            onClick={() => handleHistoryClick(h)}
                            className="flex justify-between items-center text-[10px] font-mono cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-800 px-1 rounded transition-colors group"
                            title="Click to insert value"
                        >
                            <span className="text-slate-400 dark:text-slate-500 truncate max-w-[60%]">{h.expr}</span>
                            <span className="text-slate-600 dark:text-slate-300 font-bold group-hover:text-sky-600 dark:group-hover:text-sky-400">= {h.res}</span>
                        </div>
                    ))}
                </div>

                {/* Current Expression */}
                <div className="text-right h-8 overflow-hidden flex items-end justify-end mt-1">
                    <span className="text-sm font-mono text-slate-500 dark:text-slate-400 whitespace-pre">
                        {expression || (result ? 'Ans' : '')}
                    </span>
                </div>

                {/* Main Result */}
                <div className="text-right">
                    <span className={`text-3xl font-mono font-bold tracking-tight break-all ${isError ? 'text-red-500' : 'text-slate-800 dark:text-slate-100'}`}>
                        {result ? formatNumber(result) : (expression || '0')}
                    </span>
                </div>
            </div>

            {/* Keypad */}
            <div className="grid grid-cols-5 gap-2">
                <button onClick={memClear} className={styles.mem}>MC</button>
                <button onClick={memRecall} className={styles.mem}>MR</button>
                <button onClick={memAdd} className={styles.mem}>M+</button>
                <button onClick={memSub} className={styles.mem}>M-</button>
                <button onClick={handleClear} className={getBtnStyle(styles.danger, 'AC')}>AC</button>

                <button onClick={() => handleInput('sin(')} className={styles.func}>sin</button>
                <button onClick={() => handleInput('cos(')} className={styles.func}>cos</button>
                <button onClick={() => handleInput('tan(')} className={styles.func}>tan</button>
                <button onClick={() => handleInput('log10(')} className={styles.func}>log</button>
                <button onClick={() => handleInput('ln(')} className={styles.func}>ln</button>

                <button onClick={() => handleInput('^2')} className={styles.func}>x²</button>
                <button onClick={() => handleInput('^')} className={styles.func}>xʸ</button>
                <button onClick={() => handleInput('sqrt(')} className={styles.func}>√</button>
                <button onClick={() => handleInput('1/')} className={styles.func}>1/x</button>
                <button onClick={() => handleInput('!')} className={styles.func}>n!</button>

                <button onClick={() => handleInput('(')} className={styles.func}>(</button>
                <button onClick={() => handleInput(')')} className={styles.func}>)</button>
                <button onClick={() => handleInput('7')} className={getBtnStyle(styles.num, '7')}>7</button>
                <button onClick={() => handleInput('8')} className={getBtnStyle(styles.num, '8')}>8</button>
                <button onClick={() => handleInput('9')} className={getBtnStyle(styles.num, '9')}>9</button>

                <button onClick={handleBackspace} className={getBtnStyle(styles.del, 'DEL')}>DEL</button>
                <button onClick={() => handleInput('/')} className={getBtnStyle(styles.op, '/')}>÷</button>
                <button onClick={() => handleInput('4')} className={getBtnStyle(styles.num, '4')}>4</button>
                <button onClick={() => handleInput('5')} className={getBtnStyle(styles.num, '5')}>5</button>
                <button onClick={() => handleInput('6')} className={getBtnStyle(styles.num, '6')}>6</button>

                <button onClick={() => handleInput('*')} className={getBtnStyle(styles.op, '*')}>×</button>
                <button onClick={() => handleInput('-')} className={getBtnStyle(styles.op, '-')}>-</button>
                <button onClick={() => handleInput('1')} className={getBtnStyle(styles.num, '1')}>1</button>
                <button onClick={() => handleInput('2')} className={getBtnStyle(styles.num, '2')}>2</button>
                <button onClick={() => handleInput('3')} className={getBtnStyle(styles.num, '3')}>3</button>

                <button onClick={() => handleInput('+')} className={getBtnStyle(styles.op, '+')}>+</button>
                <Tooltip text="Scientific Notation (e.g., 5e6)">
                    <button onClick={() => handleInput('e')} className={getBtnStyle(styles.func, 'e')}>EXP</button>
                </Tooltip>
                <button onClick={() => handleInput('0')} className={getBtnStyle(styles.num, '0')}>0</button>
                <button onClick={() => handleInput('.')} className={getBtnStyle(styles.num, '.')}>.</button>
                <Tooltip text="Insert previous answer">
                    <button onClick={() => handleInput('Ans')} className={`${styles.func} font-bold text-sky-700`}>Ans</button>
                </Tooltip>
            </div>
            
            <button onClick={handleCalculate} className={`${getBtnStyle(styles.action, '=')} w-full mt-2 text-xl shadow-lg`}>=</button>

            {/* Quick Constants */}
            <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600">
                <div className="flex justify-between items-center mb-2">
                    <p className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Physics Constants</p>
                    <button 
                        onClick={() => setIsAddMode(!isAddMode)} 
                        className="text-xs font-bold text-sky-600 hover:underline flex items-center gap-1"
                    >
                        {isAddMode ? 'Cancel' : '+ Add Custom'}
                    </button>
                </div>

                {isAddMode && (
                    <div className="mb-3 p-2 bg-white dark:bg-slate-800 rounded border border-sky-200 dark:border-sky-800 animate-fade-in flex gap-2 items-center">
                        <input type="text" placeholder="Name" className="w-1/3 p-1 text-sm border rounded dark:bg-slate-700 dark:border-slate-600" value={newConstName} onChange={(e) => setNewConstName(e.target.value)} />
                        <input type="text" placeholder="Value" className="w-1/3 p-1 text-sm border rounded dark:bg-slate-700 dark:border-slate-600" value={newConstVal} onChange={(e) => setNewConstVal(e.target.value)} />
                        <button onClick={handleAddConstant} className="flex-1 p-1 bg-sky-600 text-white text-xs font-bold rounded hover:bg-sky-700">Save</button>
                    </div>
                )}

                <div className="flex flex-wrap gap-2 justify-center">
                    <Tooltip text="Pi (approx. 3.14159)"><button onClick={() => insertConstant('3.14159265', 'π')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">π</button></Tooltip>
                    <Tooltip text="Euler's Number (approx. 2.71828)"><button onClick={() => insertConstant('2.71828182', 'e')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">e</button></Tooltip>
                    <Tooltip text="Curie (3.7e10 Bq)"><button onClick={() => insertConstant('3.7e10', 'Ci')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">Ci</button></Tooltip>
                    <Tooltip text="Avogadro's Number (6.022e23)"><button onClick={() => insertConstant('6.022e23', 'Na')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">Nₐ</button></Tooltip>
                    <Tooltip text="Elementary Charge (1.602e-19 C)"><button onClick={() => insertConstant('1.60217663e-19', 'e (charge)')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">qₑ</button></Tooltip>
                    <Tooltip text="Planck's Constant (6.626e-34 J⋅s)"><button onClick={() => insertConstant('6.62607015e-34', 'h')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">h</button></Tooltip>
                    <Tooltip text="Atomic Mass Unit (1.66e-27 kg)"><button onClick={() => insertConstant('1.66053906e-27', 'u')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">u</button></Tooltip>
                    <Tooltip text="Roentgen to C/kg (2.58e-4)"><button onClick={() => insertConstant('2.58e-4', 'R -> C/kg')} className="px-3 py-1.5 text-xs bg-slate-200 dark:bg-slate-700 font-mono rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">R</button></Tooltip>
                    
                    {customConstants.map((c, idx) => (
                        <Tooltip key={idx} text={`Value: ${c.value} (Right-click to delete)`}>
                            <button 
                                onClick={() => insertConstant(c.value, c.name)} 
                                onContextMenu={(e) => { e.preventDefault(); handleDeleteConstant(idx, c.name); }}
                                className="px-3 py-1.5 text-xs bg-sky-100 dark:bg-sky-900 font-mono font-bold text-sky-800 dark:text-sky-200 border border-sky-300 dark:border-sky-700 rounded hover:bg-sky-200 dark:hover:bg-sky-800 transition"
                            >
                                {c.name}
                            </button>
                        </Tooltip>
                    ))}
                </div>
            </div>
        </div>
    );
};

	     /**
              * @description React component that serves as a static page for external links and references.
              * This component provides a curated list of authoritative resources relevant to the application's
              * domain, such as health physics, radiation safety, and nuclear data.
              *
              * It is a pure presentation component that renders a pre-defined array of links,
              * categorized for easy navigation. The links are grouped into sections for:
              * 1.  **Regulatory & Guidance:** Official documents from government agencies like the NRC and DOT.
              * 2.  **Data & Tools:** Databases and software from sources like NNDC and EPA.
              * 3.  **Professional Organizations:** Websites for key professional societies and international bodies.
              *
              * This component is intended to provide users with quick access to the foundational
              * knowledge and external data sources that underpin the calculations and information in the app.
              */
              
         const ReferencesPage = () => {
         const referenceLinks = [
             {
                 category: 'Regulatory & Guidance',
                 items: [
                     { title: '10 CFR Part 20 - Standards for Protection Against Radiation', url: 'https://www.nrc.gov/reading-rm/doc-collections/cfr/part020/', description: 'The foundational NRC regulation for radiation protection in the United States.' },
                     { title: '49 CFR Part 173 - Shippers—General Requirements for Shipments', url: 'https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173', description: 'Department of Transportation regulations governing the transport of hazardous materials, including radioactive sources.' },
                     { title: 'NUREG-1556 Series - Consolidated Guidance About Materials Licenses', url: 'https://www.nrc.gov/reading-rm/doc-collections/nuregs/staff/sr1556/index.html', description: 'A collection of NRC guidance documents for various types of materials licenses.' },
                     { title: 'MARSSIM - Multi-Agency Radiation Survey and Site Investigation Manual', url: 'https://www.nrc.gov/reading-rm/doc-collections/nuregs/staff/sr1575/index.html', description: 'The primary guidance for performing final status surveys for decommissioning.' },
                 ]
             },
             {
                 category: 'Data & Tools',
                 items: [
                     { title: 'NNDC NuDat 3 - National Nuclear Data Center', url: 'https://www.nndc.bnl.gov/nudat3/', description: 'The primary source for the nuclear data in this toolbox. An authoritative database for nuclear structure and decay data.' },
                     // CHANGED: The title, URL, and description for the EPA link have been updated.
                     { title: 'EPA Radiation Protection', url: 'https://www.epa.gov/radiation', description: "The Environmental Protection Agency's main hub for radiation information and resources." },
                     { title: 'REMM - Radiation Emergency Medical Management', url: 'https://remm.hhs.gov/', description: 'Guidance for health care providers on diagnosis and treatment of radiation injuries during emergencies.' },
                 ]
             },
             {
                 category: 'Professional Organizations',
                 items: [
                     { title: 'Health Physics Society (HPS)', url: 'https://hps.org/', description: 'A scientific organization of professionals in radiation safety.' },
                     { title: 'American Association of Physicists in Medicine (AAPM)', url: 'https://www.aapm.org/', description: 'A scientific and professional organization for medical physicists.' },
                     { title: 'International Atomic Energy Agency (IAEA)', url: 'https://www.iaea.org/', description: "The world's central intergovernmental forum for scientific and technical co-operation in the nuclear field." },
                 ]
             }
         ];
         
         return (
             <div className="p-4 animate-fade-in">
                 <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                     <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Links & References</h2>
                     <div className="space-y-6">
                         {referenceLinks.map(section => (
                             <div key={section.category}>
                                 <h3 className="text-lg font-semibold text-sky-600 dark:text-sky-400 border-b border-slate-300 dark:border-slate-600 pb-2 mb-3">{section.category}</h3>
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     {section.items.map(item => (
                                         <a href={item.url} target="_blank" rel="noopener noreferrer" key={item.title} className="block p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg hover:ring-2 hover:ring-sky-500 transition-all">
                                             <p className="font-bold text-slate-800 dark:text-slate-100">{item.title}</p>
                                             <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">{item.description}</p>
                                         </a>
                                     ))}
                                 </div>
                             </div>
                         ))}
                     </div>
                 </div>
             </div>
         );
         };
              
              /**
               * @description Displays information about a single radionuclide. Can be a full detailed card or a compact version for lists.
               * @param {object} props - Component props.
               * @param {object} props.nuclide - The nuclide data object.
               * @param {boolean} [props.isCompact=false] - If true, renders a smaller card.
               * @param {(nuclide: object) => void} [props.onNuclideClick] - Click handler for the compact card.
               * @param {(seriesId: string) => void} [props.onDecaySeriesClick] - Click handler for the 'View Decay Series' button.
               * @param {string} [props.displayHalfLifeUnit] - The unit to display the half-life in for the detailed card.
               */
              
         
         const NuclideCard = ({ nuclide, radionuclides, isCompact = false, onNuclideClick, onDecaySeriesClick, displayHalfLifeUnit, favorites, toggleFavorite, onSendToCalculator, onAddToCompare, showBackButton, onBackClick }) => {
              
         // ADDED: Get the global settings context
         const { settings } = React.useContext(SettingsContext);
         
         const getSourceLink = (sourceKey) => {
         const source = sources[sourceKey];
         return source ? <a href={source.url} target="_blank" rel="noopener noreferrer" className="text-sky-500 hover:underline" title={source.name}>[{Object.keys(sources).indexOf(sourceKey) + 1}]</a> : '';
         };
         
         // UPDATED: This component is now aware of the unit system
         const DataPoint = ({ label, value, unit, sourceKey, iconPath, iconSymbol, conversionType }) => {
         let displayValue = value;
         let displayUnit = unit;
         
         if (conversionType && !isNaN(parseFloat(value))) {
            const formatted = formatWithUnitSystem(parseFloat(value), conversionType, settings);
            displayValue = formatted.value;
            displayUnit = formatted.unit;
         } else if (value === null || value === undefined || (typeof value === 'string' && value.trim() === '')) {
            displayValue = 'N/A';
         }
         
         const shouldAppendUnit = displayUnit && typeof displayValue === 'string' && displayValue !== 'N/A' && displayValue.toLowerCase() !== 'none' && !displayValue.toLowerCase().includes(displayUnit.toLowerCase());
         
         return (
            <div className="flex items-start py-2">
                {iconPath && <Icon path={iconPath} className="w-5 h-5 text-sky-500 mr-3 flex-shrink-0 mt-1" />}
                {iconSymbol && <span className="text-2xl font-serif text-sky-500 mr-3 -mt-1 w-5 text-center">{iconSymbol}</span>}
                {!iconPath && !iconSymbol && <div className="w-5 mr-3 flex-shrink-0"></div>}
                <div>
                    <p className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</p>
                    <p className="text-base font-semibold text-slate-800 dark:text-slate-100 flex items-center flex-wrap">
                        {displayValue}
                        {shouldAppendUnit ? <span className="ml-1">{displayUnit}</span> : <span className="ml-1">{displayUnit && React.isValidElement(displayValue) === false ? displayUnit.replace(value, '') : displayUnit}</span>}
                        {sourceKey && <sup className="ml-1"> {getSourceLink(sourceKey)}</sup>}
                    </p>
                </div>
            </div>
         );
         };
         
         if (isCompact) {
         const styles = CATEGORY_STYLES[nuclide.category] || CATEGORY_STYLES['default'];
         const hlCategory = getHalfLifeCategory(parseHalfLifeToSeconds(nuclide.halfLife));
         const compactCardJSX = (
            <div
                onClick={() => onNuclideClick(nuclide)}
                className={`flex flex-col justify-between p-4 h-full bg-white dark:bg-slate-800 rounded-lg shadow-md hover:shadow-lg hover:ring-2 hover:ring-sky-500 cursor-pointer transition-all duration-200 border-l-4 ${styles.border} ${styles.hoverBg}`}
            >
                <div>
                    <div className="flex justify-between items-start">
                        <h3 className="font-bold text-lg text-slate-800 dark:text-white">{nuclide.name} <span className="text-slate-500 font-normal">({nuclide.symbol})</span></h3>
                        <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${hlCategory.color} bg-opacity-10`}>{hlCategory.label}</span>
                    </div>
                    <div className="flex items-baseline text-sm mt-2"><Icon path={ICONS.hourglass} className="w-4 h-4 text-slate-400 mr-2"/><span className="font-medium text-slate-600 dark:text-slate-300">{formatHalfLife(nuclide.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(nuclide.halfLife)))}</span></div>
                    <div className="flex items-baseline text-sm mt-1"><Icon path={ICONS.radioactive} className="w-4 h-4 text-slate-400 mr-2"/><span className="text-slate-500 dark:text-slate-400">{(nuclide.emissionType || []).slice(0, 2).join(', ')}</span></div>

{nuclide.gammaConstant && (
    <div className="flex items-baseline text-sm mt-1">
        <span className="w-4 mr-2 text-center text-slate-400 font-serif">Γ</span>
        <span className="font-mono text-slate-600 dark:text-slate-300">
            {parseFloat(nuclide.gammaConstant).toFixed(2)}
        </span>
    </div>
)}
                </div>
                <div className="flex items-center gap-1 text-xs font-semibold text-slate-600 dark:text-slate-400 mt-3 pt-2 border-t border-slate-200 dark:border-slate-700">
                    <span>{nuclide.category} - {nuclide.commonality}</span>
                </div>
            </div>
         );
         return compactCardJSX;
         }
         
         const isFavorite = favorites?.includes(nuclide.symbol);
         const hlCategory = getHalfLifeCategory(parseHalfLifeToSeconds(nuclide.halfLife));
         
         return (
         <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 animate-fade-in">
            <div className="flex justify-between items-start">
                <div className="flex items-center gap-2">
         <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
         <a href={`https://en.wikipedia.org/wiki/${nuclide.name.replace(/ /g, '_')}`} target="_blank" rel="noopener noreferrer" className="hover:text-sky-500 hover:underline transition-colors">
         {nuclide.name}
         </a> ({nuclide.symbol})
         </h2>
                    {nuclide.commonalityReason ? (
                        <Tooltip text={nuclide.commonalityReason} widthClass="w-72">
                            <span className="flex items-center gap-1.5 text-sm font-medium text-sky-600 dark:text-sky-400 bg-sky-100 dark:bg-sky-900/50 px-3 py-1 rounded-full whitespace-nowrap cursor-help">
                                {nuclide.category} - {nuclide.commonality}
                                <Icon path={ICONS.help} className="w-4 h-4 opacity-75" />
                            </span>
                        </Tooltip>
                    ) : (
                        <span className="text-sm font-medium text-sky-600 dark:text-sky-400 bg-sky-100 dark:bg-sky-900/50 px-3 py-1 rounded-full whitespace-nowrap">
                            {nuclide.category} - {nuclide.commonality}
                        </span>
                    )}
                </div>
                <div className="flex items-center gap-2 mt-1">
                    {toggleFavorite && (
                        <button onClick={() => toggleFavorite(nuclide.symbol)} className={`p-2 rounded-full transition-colors ${isFavorite ? 'text-yellow-400 hover:text-yellow-500' : 'text-slate-300 dark:text-slate-600 hover:text-yellow-400'}`} title={isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-8 h-8"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </button>
                    )}
                </div>
            </div>
         
            <div className="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-x-6">
                <div className="divide-y divide-slate-200 dark:divide-slate-700">
                    <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Decay Properties</h3>
                    <DataPoint
                        label="Half-life"
                        value={<>{formatHalfLife(nuclide.halfLife, displayHalfLifeUnit)} <span className={`ml-2 text-xs font-bold px-2 py-0.5 rounded-full ${hlCategory.color} bg-opacity-10`}>{hlCategory.label}</span></>}
                        sourceKey={nuclide.sourceRef?.halfLife}
                        iconPath={ICONS.hourglass}
                    />
                    <DataPoint label="Decay Constant (λ)" value={standardizeScientificDisplay(nuclide.decayConstant)} sourceKey={nuclide.sourceRef?.decayConstant} iconSymbol="λ" />
                </div>
                <div className="divide-y divide-slate-200 dark:divide-slate-700">
                    <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Physical Properties</h3>
                    <DataPoint label="Specific Activity" value={parseSpecificActivity(nuclide.specificActivity)} sourceKey={nuclide.sourceRef?.specificActivity} iconPath={ICONS.activity} conversionType="activity" />
                    <DataPoint label="Emission Type(s)" value={(nuclide.emissionType || []).join(', ')} sourceKey={nuclide.sourceRef?.emissionType} iconPath={ICONS.radioactive} />
                    {nuclide.gammaConstant && (
                        <DataPoint label="Gamma Constant" value={parseFloat(nuclide.gammaConstant)} sourceKey={nuclide.sourceRef?.gammaConstant} conversionType="gammaConstant" />
                    )}
                </div>
                <div className="divide-y divide-slate-200 dark:divide-slate-700">
                    <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Genealogy</h3>
                    <DataPoint label="Parent" value={<ClickableNuclide text={nuclide.parent} radionuclides={radionuclides} onNuclideClick={onNuclideClick} />} sourceKey={nuclide.sourceRef?.parent} />
                    <DataPoint label="Daughter" value={<ClickableNuclide text={nuclide.daughter} radionuclides={radionuclides} onNuclideClick={onNuclideClick} />} sourceKey={nuclide.sourceRef?.daughter} />
                </div>
                {(nuclide.shipping || nuclide.dValue) && (
                    <div className="divide-y divide-slate-200 dark:divide-slate-700">
                        <h3 className="text-sm font-bold uppercase text-slate-400 dark:text-slate-500 tracking-wider pb-1">Transportation & Security</h3>
                        {nuclide.shipping && <DataPoint label="A₁ Limit" value={`${nuclide.shipping.A1 || 'N/A'}`} unit="TBq" iconPath={ICONS.transport} />}
                        {nuclide.shipping && <DataPoint label="A₂ Limit" value={`${nuclide.shipping.A2 || 'N/A'}`} unit="TBq" iconPath={ICONS.transport} />}
                        
                        {/* UPDATED: D-Value with Tooltip context */}
                        {nuclide.dValue && (
                            <DataPoint 
                                label={
                                    <Tooltip text="Dangerous Quantity threshold. Values for common nuclides from IAEA RS-G-1.9; others calculated from IAEA EPR-D-VALUES 2006." widthClass="w-64">
                                        <span className="cursor-help border-b border-dotted border-slate-400 hover:border-sky-500 transition-colors">D-Value</span>
                                    </Tooltip>
                                } 
                                value={`${nuclide.dValue}`} 
                                unit="TBq" 
                                iconPath={ICONS.transport} 
                            />
                        )}
                    </div>
                )}
            </div>
         
            {nuclide.dosimetry && (
                <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                    <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-2">Internal Dosimetry <sup className="ml-1">{getSourceLink('10CFR20')}</sup></h3>
                    <div className="grid md:grid-cols-2 gap-x-6">
                        <div className="flex items-start py-2">
                             <Icon path={ICONS.internalDose} className="w-5 h-5 text-sky-500 mr-3 flex-shrink-0 mt-1" />
                            <div>
                                <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Annual Limit on Intake (ALI)</p>
                                <ul className="text-base font-semibold text-slate-800 dark:text-slate-100 list-disc list-inside mt-1 space-y-1">
                                    {Object.entries(nuclide.dosimetry.ALI || {}).map(([key, value]) => {
                                        const formatted = formatWithUnitSystem(value, 'ali', settings);
                                        const keyDisplay = key.replace('inhalation_', 'Inh. ').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                        return <li key={key}>{`${keyDisplay}: ${formatted.value} ${formatted.unit}`}</li>;
                                    })}
                                </ul>
                            </div>
                        </div>
                        <div className="flex items-start py-2">
                            <div className="w-5 mr-3 flex-shrink-0"></div> {/* Spacer for alignment */}
                            <div>
                                 <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Derived Air Concentration (DAC)</p>
                                 <ul className="text-base font-semibold text-slate-800 dark:text-slate-100 list-disc list-inside mt-1 space-y-1">
                                    {Object.entries(nuclide.dosimetry.DAC || {}).map(([key, value]) => {
                                        const formatted = formatWithUnitSystem(value, 'dac', settings);
                                        const keyDisplay = key.replace('inhalation_', 'Inh. ').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                        return <li key={key}>{`${keyDisplay}: ${formatted.value} ${formatted.unit}`}</li>;
                                    })}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            )}
         
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Principal Emissions</h3>
                <div className="space-y-4">
                    <div>
                        <p className="text-sm font-medium text-slate-500 dark:text-slate-400">From Parent ({nuclide.symbol})</p>
                        <div className="grid md:grid-cols-3 gap-4 mt-1">
                           <DataPoint label="Alpha" value={(nuclide.emissionEnergies?.alpha || []).join(', ') || 'None'} iconSymbol="α"/>
                           <DataPoint label="Beta" value={`${(nuclide.emissionEnergies?.beta || []).join(', ') || 'None'}${nuclide.avgBetaEnergy ? ` | ${nuclide.avgBetaEnergy} (avg)` : ''}`} iconSymbol="β"/>
                           <DataPoint label="Gamma" value={(nuclide.emissionEnergies?.gamma || []).join(', ') || 'None'} iconSymbol="γ"/>
                        </div>
                    </div>
                    {nuclide.daughterEmissions && (
                         <div className="animate-fade-in">
                            <p className="text-sm font-medium text-slate-500 dark:text-slate-400">
                                From Daughter (<ClickableNuclide text={nuclide.daughterEmissions.from} radionuclides={radionuclides} onNuclideClick={onNuclideClick} />)
                            </p>
                            <div className="grid md:grid-cols-3 gap-4 mt-1">
                                <DataPoint label="Alpha" value={(nuclide.daughterEmissions.alpha || []).join(', ') || 'None'} iconSymbol="α"/>
                                <DataPoint label="Beta" value={(nuclide.daughterEmissions.beta || []).join(', ') || 'None'} iconSymbol="β"/>
                                <DataPoint label="Gamma" value={(nuclide.daughterEmissions.gamma || []).join(', ') || 'None'} iconSymbol="γ"/>
                            </div>
                        </div>
                    )}
                </div>
            </div>
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Common Uses</h3>
                <ul className="list-disc list-inside text-slate-600 dark:text-slate-300 space-y-1">
                    {(nuclide.commonUses || []).map((use, i) => <li key={i}><ClickableNuclide text={use} radionuclides={radionuclides} onNuclideClick={onNuclideClick} /></li>)}
                </ul>
            </div>
         
            {HVL_DATA[nuclide.symbol] && (
                <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                    <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Shielding Data (HVL in cm)</h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                        {Object.entries(HVL_DATA[nuclide.symbol]).map(([material, value]) => {
                            if (material === 'sourceRef') return null;
                            return (
                                <div key={material}>
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">{material}: </span>
                                    <span className="text-slate-700 dark:text-slate-200">{value} cm</span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}
         
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                    <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">Quick Actions</h3>
                    <div className="flex flex-wrap justify-center gap-2">
                        {showBackButton && (
                            <Tooltip text="Go back to the previous view" widthClass="w-auto">
                                <button
                                    onClick={onBackClick}
                                    className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center justify-center gap-2"
                                >
                                    <Icon path={ICONS.database} className="w-4 h-4" />
                                    Back
                                </button>
                            </Tooltip>
                        )}
                        <Tooltip text="Add this nuclide to the comparison table." widthClass="w-64">
                            <button onClick={() => onAddToCompare(nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                <Icon path={ICONS.compare} className="w-4 h-4" /> Add to Compare
                            </button>
                        </Tooltip>
                        <Tooltip text="Send this nuclide to the Decay Calculator." widthClass="w-64">
                            <button onClick={() => onSendToCalculator('calculator', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                <Icon path={ICONS.calculator} className="w-4 h-4" /> Decay Calc
                            </button>
                        </Tooltip>
                        {nuclide.gammaConstant && (
                            <Tooltip text="Send this nuclide to the Dose Rate Calculator." widthClass="w-64">
                                 <button onClick={() => onSendToCalculator('doseRate', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                    <Icon path={ICONS.doseRate} className="w-4 h-4" /> Dose Rate
                                </button>
                            </Tooltip>
                        )}
                        {nuclide.gammaConstant && (
                            <Tooltip text="Send this nuclide to the Shielding Calculator." widthClass="w-64">
                                 <button onClick={() => onSendToCalculator('shielding', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                    <Icon path={ICONS.shield} className="w-4 h-4" /> Shielding
                                </button>
                            </Tooltip>
                        )}
                        {nuclide.shipping && (
                            <Tooltip text="Send this nuclide to the Shipping Calculator." widthClass="w-64">
                                 <button onClick={() => onSendToCalculator('transportation', nuclide.symbol)} className="px-3 py-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition flex items-center gap-2">
                                    <Icon path={ICONS.transport} className="w-4 h-4" /> Shipping
                                </button>
                            </Tooltip>
                        )}
                    </div>
                </div>
         
            {nuclide.decaySeriesId && (
                <div className="mt-6 text-center">
                    <button onClick={() => onDecaySeriesClick(nuclide.decaySeriesId)} className="px-4 py-2 bg-slate-700 text-white rounded-lg font-semibold hover:bg-slate-800 transition">View Full Decay Series</button>
                </div>
            )}
         </div>
         );
         };
         
         
         
              /**
               * @description Displays a full decay series chain.
               * @param {{seriesId: string, onBack: () => void, onNuclideClick: (nuclide: object) => void}} props - The series ID and navigation handlers.
               */
              
              const DecaySeriesViewer = ({ seriesId, onBack, onNuclideClick }) => {
                  const series = decaySeriesData.find(s => s.id === seriesId);
                  if (!series) return <p>Decay series not found.</p>;
              
                  // --- INTERNAL COMPONENTS FOR THE DIAGRAM ---
              
                  // A single nuclide in the chain
              
                  const NuclideNode = ({ step }) => (
                      <div className="p-3 my-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-center shadow flex-shrink-0 border border-slate-200 dark:border-slate-600">
                          <span
                              className="font-bold text-lg text-sky-600 dark:text-sky-400 cursor-pointer hover:underline"
                              onClick={() => {
                                  const found = radionuclides.find(n => normalizeString(n.name) === normalizeString(step.nuclide));
                                  if (found) onNuclideClick(found);
                              }}
                          >
                              {step.nuclide}
                          </span>
                          <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">{step.halfLife}</div>
                      </div>
                  );
              
                  // An arrow representing a decay step
              
              const DecayArrow = ({ decayType }) => (
                      <div className="flex-shrink-0 flex items-center justify-center relative mx-2 min-w-[10rem] w-auto px-2 text-center">
              
              {/* The horizontal line of the arrow */}
              
              <div className="absolute left-0 w-full h-0.5 bg-slate-300 dark:bg-slate-600"></div>
              
              {/* Arrowhead */}
              
              <div className="absolute right-0 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[8px] border-l-slate-400 dark:border-l-slate-500"></div>
              
              {/* Text label floating above the line */}
              
                          <div className="relative bg-white dark:bg-slate-800 px-2">
                              <span className="text-xs font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap">{decayType}</span>
                          </div>
                      </div>
                  );
              
                  // Recursive component that renders a chain or a sub-chain horizontally
              
                  const RenderChain = ({ chain }) => (
                      <div className="flex items-center">
                          {chain.map((step, index) => (
                              <div key={step.nuclide + index} className="flex items-center">
                                  <NuclideNode step={step} />
              
                                  {/* If the step has branches, render them vertically stacked */}
              
                                  {step.branches && (
                                      <>
                                          <DecayArrow decayType="" />
                                          <div className="flex flex-col">
                                              {step.branches.map((branch, branchIndex) => (
                                                  <div key={branchIndex} className="flex items-center p-2">
                                                      <DecayArrow decayType={step.decayType.split('/')[branchIndex]?.trim() || ''} />
                                                      <RenderChain chain={branch} />
                                                  </div>
                                              ))}
                                          </div>
                                      </>
                                  )}
              
                                  {/* If it's a linear step, render the arrow to the next step */}
              
                                  {!step.branches && index < chain.length - 1 && chain[index+1].nuclide !== step.nuclide && (
                                      <DecayArrow decayType={step.decayType} />
                                  )}
                              </div>
                          ))}
                      </div>
                  );
              
                  // --- MAIN COMPONENT RENDER ---
              
                  return (
                      <div className="p-4 animate-fade-in">
                          <button onClick={onBack} className="mb-4 px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded-lg font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition">&larr; Back to Result</button>
                          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                              <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">{series.name}</h2>
                              {/* Container that allows horizontal scrolling for long chains */}
                              <div className="overflow-x-auto pb-4">
                                 <div className="inline-block min-w-full p-2">
                                      <RenderChain chain={series.chain} />
                                 </div>
                              </div>
                          </div>
                      </div>
                  );
              };
              
              /**
              * @description A sidebar for filtering and sorting the nuclide database. It is responsive.
              * @param {{filterProps: object, isFiltersVisible: boolean, setIsFiltersVisible: (isVisible: boolean) => void, handleClearFilters: () => void}} props
              */
              
              const FilterSidebar = ({ filterProps, isFiltersVisible, setIsFiltersVisible, scrollPositionRef, handleClearFilters }) => {
              
              const {
              sortBy, setSortBy, sortOrder, setSortOrder,
              selectedCategory, setSelectedCategory, allCategories,
              selectedEmissionType, setSelectedEmissionType, allEmissionTypes,
              selectedCommonality, setSelectedCommonality, allCommonalityCategories,
              minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy,
              minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy,
              minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy,
              minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit
              } = filterProps;
              
              const handleClose = () => {
              setIsFiltersVisible(false);
              setTimeout(() => {
                  window.scrollTo({
                      top: scrollPositionRef.current,
                      behavior: 'smooth'
                  });
              }, 300);
              };
              
              return (
              <>
                  <div
                      className={`fixed inset-0 bg-black/50 z-40 lg:hidden transition-opacity ${isFiltersVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                      onClick={handleClose}
                      aria-hidden="true">
                  </div>
              
                  <aside
                      className={`fixed top-0 left-0 w-80 h-full bg-slate-50 dark:bg-slate-900 z-50 transform transition-transform duration-300 ease-in-out lg:relative lg:w-auto lg:h-auto lg:transform-none lg:col-span-1 ${
                          isFiltersVisible ? 'translate-x-0' : '-translate-x-full'
                      }`}
                  >
                      <div className="p-4 space-y-4 h-full overflow-y-auto">
                          <div className="flex justify-between items-center border-b border-slate-300 dark:border-slate-600 pb-2">
                              <h3 className="text-lg font-bold text-slate-800 dark:text-white">Filters & Sorting</h3>
                              <div className="flex items-center gap-2">
              
                                  <button
                                      onClick={handleClearFilters}
                                      className="flex items-center gap-2 px-3 py-1 text-sm font-semibold text-sky-700 dark:text-sky-300 bg-slate-200 dark:bg-slate-700 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
                                  >
                                      <Icon path={ICONS.clear} className="w-4 h-4" />
                                      Clear All
                                  </button>
                                  <button onClick={handleClose} className="lg:hidden p-1 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700">
                                      <Icon path={ICONS.clear} className="w-6 h-6" />
                                  </button>
                              </div>
                          </div>
              
                          {/* Sorting controls */}
              
                          <div>
                              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Sort by</label>
                              <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                                  <option value="name">Name</option>
                                  <option value="halfLife">Half-life</option>
                                  <option value="alphaEnergy">Alpha Energy</option>
                                  <option value="betaEnergy">Beta Energy</option>
                                  <option value="gammaEnergy">Gamma Energy</option>
                              </select>
                              <select value={sortOrder} onChange={e => setSortOrder(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                                  <option value="asc">Ascending</option>
                                  <option value="desc">Descending</option>
                              </select>
                          </div>
              
                          {/* Filtering controls */}
              
                          <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Category</label><select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                          <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Emission Type</label><select value={selectedEmissionType} onChange={e => setSelectedEmissionType(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allEmissionTypes.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                          <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Commonality</label><select value={selectedCommonality} onChange={e => setSelectedCommonality(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">{allCommonalityCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
              
                          {/* Half-life range filter */}
              
                          <div>
                              <h4 className="text-md font-semibold text-slate-700 dark:text-slate-300 mt-4">Half-life</h4>
                              <div className="flex gap-2 mt-2">
                                  <input type="number" placeholder="Min" value={minHalfLife} onChange={e => setMinHalfLife(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                                  <input type="number" placeholder="Max" value={maxHalfLife} onChange={e => setMaxHalfLife(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" />
                              </div>
                              <select value={halfLifeFilterUnit} onChange={e => setHalfLifeFilterUnit(e.target.value)} className="mt-1 w-full p-2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md">
                                  <option value="seconds">Seconds</option>
                                  <option value="minutes">Minutes</option>
                                  <option value="hours">Hours</option>
                                  <option value="days">Days</option>
                                  <option value="years">Years</option>
                              </select>
                          </div>
              
                          {/* Energy range filters */}
              
                          <div>
                              <h4 className="text-md font-semibold text-slate-700 dark:text-slate-300 mt-4">Energy (MeV)</h4>
                              <div className="space-y-2 mt-2">
                                  <label className="text-sm">Alpha</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minAlphaEnergy} onChange={e => setMinAlphaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxAlphaEnergy} onChange={e => setMaxAlphaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                                  <label className="text-sm">Beta</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minBetaEnergy} onChange={e => setMinBetaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxBetaEnergy} onChange={e => setMaxBetaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                                  <label className="text-sm">Gamma</label><div className="flex gap-2"><input type="number" placeholder="Min" value={minGammaEnergy} onChange={e => setMinGammaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /><input type="number" placeholder="Max" value={maxGammaEnergy} onChange={e => setMaxGammaEnergy(e.target.value)} className="w-full p-1 rounded-md text-sm bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600" /></div>
                              </div>
                          </div>
                      </div>
                  </aside>
              </>
              );
              };
              
              /**
              * @description The main view for Browse the entire database with filters.
              * @param {object} props - Component props.
              */
              
const DatabaseView = ({ filteredList, filterProps, onNuclideClick, isFiltersVisible, setIsFiltersVisible, scrollPositionRef, handleClearFilters }) => {
    const { selectedCategory, setSelectedCategory } = filterProps;
    
    // NEW: Export Function
    const handleExport = () => {
        if (!filteredList || filteredList.length === 0) return;
        
        const headers = ['Name', 'Symbol', 'Category', 'Half-Life', 'Decay Constant', 'Specific Activity', 'Gamma Constant', 'Emissions'];
        const csvRows = [headers.join(',')];
        
        filteredList.forEach(n => {
            // sanitize text to prevent CSV breakages
            const name = `"${n.name}"`; 
            const emissions = `"${(n.emissionType || []).join('; ')}"`;
            const row = [
                name, 
                n.symbol, 
                n.category, 
                n.halfLife, 
                n.decayConstant, 
                n.specificActivity || 'N/A', 
                n.gammaConstant || 'N/A',
                emissions
            ];
            csvRows.push(row.join(','));
        });
        
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'nuclide_database_export.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="relative">
             <div className="px-4 pt-4 lg:hidden">
                 <button 
                     onClick={() => {
                         scrollPositionRef.current = window.scrollY;
                         window.scrollTo({ top: 0, behavior: 'smooth' });
                         setIsFiltersVisible(true);
                     }}
                     className="w-full flex items-center justify-center gap-2 p-3 text-sm font-semibold bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                 >
                     <Icon path={ICONS.filter} className="w-5 h-5" /> Filters & Sorting
                 </button>
             </div>

             <div className="grid lg:grid-cols-4 gap-4 p-4">
                 
                 <FilterSidebar 
                     filterProps={filterProps} 
                     isFiltersVisible={isFiltersVisible} 
                     setIsFiltersVisible={setIsFiltersVisible}
                     scrollPositionRef={scrollPositionRef}
                     handleClearFilters={handleClearFilters}
                 />

                 <div className="col-span-4 lg:col-span-3 bg-slate-100 dark:bg-slate-800/50 rounded-lg p-4 h-[calc(100vh-350px)] md:h-[calc(100vh-320px)] lg:h-auto overflow-y-auto">
                     
                     <div className="flex flex-wrap justify-between items-center gap-4 mb-4">
                         <div className="flex items-center gap-3">
                             <p className="text-sm font-bold text-slate-700 dark:text-slate-300 flex-shrink-0">
                                 {filteredList.length} Results
                             </p>
                             {filteredList.length > 0 && (
                                 <button onClick={handleExport} className="text-xs text-sky-600 dark:text-sky-400 hover:underline flex items-center gap-1">
                                     <Icon path={ICONS.database} className="w-3 h-3" /> Export CSV
                                 </button>
                             )}
                         </div>

                         <div className="flex flex-wrap items-center gap-x-3 gap-y-2 text-xs">
                             {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                 const bgColor = styles.border.replace('border-l-', 'bg-');
                                 const isActive = selectedCategory === category;
                                 return (
                                      <Tooltip key={category} text={CATEGORY_DESCRIPTIONS[category] || ''} widthClass="w-64">
                                         <button 
                                             onClick={() => setSelectedCategory(prev => prev === category ? 'All' : category)}
                                             className={`flex items-center gap-1.5 px-2 py-1 rounded-full transition-all duration-200 ${isActive ? 'ring-2 ring-offset-2 ring-offset-slate-100 dark:ring-offset-slate-800 ring-sky-500 bg-white dark:bg-slate-700' : 'bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700'}`}
                                         >
                                             <div className={`w-3 h-3 rounded-full ${bgColor}`}></div>
                                             <span className="text-slate-600 dark:text-slate-300">{category.replace('/', '/ ')}</span>
                                         </button>
                                      </Tooltip>
                                 );
                             })}
                             
                             <button 
                                 onClick={() => setSelectedCategory('All')}
                                 className={`px-2 py-1 rounded-full transition-all duration-200 text-slate-600 dark:text-slate-300 ${selectedCategory === 'All' ? 'ring-2 ring-offset-2 ring-offset-slate-100 dark:ring-offset-slate-800 ring-slate-500 bg-white dark:bg-slate-700' : 'bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700'}`}
                             >
                                 Show All
                             </button>
                         </div>
                     </div>

                     <div className="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                         {filteredList.length > 0 ? (
                             filteredList.map(n => <NuclideCard key={n.symbol} nuclide={n} isCompact={true} onNuclideClick={onNuclideClick} />)
                         ) : (
                             <div className="col-span-full text-center py-16 px-4">
                                 <Icon path={ICONS.search} className="w-12 h-12 text-slate-400 dark:text-slate-500 mx-auto" />
                                 <h3 className="mt-4 text-lg font-semibold text-slate-600 dark:text-slate-300">No Results Found</h3>
                                 <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">Try adjusting your filter criteria.</p>
                                 <button 
                                     onClick={handleClearFilters}
                                     className="mt-4 px-4 py-2 bg-sky-600 text-white text-sm font-semibold rounded-lg hover:bg-sky-700 transition"
                                 >
                                     Clear All Filters
                                 </button>
                             </div>
                         )}
                     </div>
                 </div>
             </div>
        </div>
    );
};
             
              /**
               * @description A component that provides a user interface for converting between
               * various radiological and physical units, such as activity, dose, and energy.
               */
             
const UnitConverter = () => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    // --- 1. DEFINITIONS (Unchanged) ---
    const CATEGORIES = {
        'Activity': { base: 'Bq', units: { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'TBq': 1e12, 'Ci': 3.7e10, 'mCi': 3.7e7, 'µCi': 37000, 'nCi': 37, 'pCi': 0.037, 'dpm': 1/60, 'dps': 1 } },
        'Dose Equivalent': { base: 'Sv', units: { 'Sv': 1, 'mSv': 1e-3, 'µSv': 1e-6, 'rem': 0.01, 'mrem': 1e-5, 'µrem': 1e-8 } },
        'Absorbed Dose': { base: 'Gy', units: { 'Gy': 1, 'mGy': 1e-3, 'µGy': 1e-6, 'rad': 0.01, 'mrad': 1e-5 } },
        'Exposure': { base: 'C/kg', units: { 'C/kg': 1, 'R': 2.58e-4, 'mR': 2.58e-7, 'µR': 2.58e-10 } },
        'Contamination': { base: 'Bq/cm²', units: { 'Bq/cm²': 1, 'kBq/m²': 0.1, 'dpm/100cm²': 1/6000, 'µCi/cm²': 37000, 'µCi/m²': 3.7, 'pCi/100cm²': 0.037/100 } },
        'Length': { base: 'm', units: { 'm': 1, 'cm': 0.01, 'mm': 0.001, 'µm': 1e-6, 'in': 0.0254, 'ft': 0.3048, 'yd': 0.9144, 'mi': 1609.34 } },
        'Mass': { base: 'g', units: { 'g': 1, 'kg': 1000, 'mg': 1e-3, 'µg': 1e-6, 'lb': 453.592, 'oz': 28.3495 } },
        'Time': { base: 's', units: { 's': 1, 'min': 60, 'hr': 3600, 'day': 86400, 'yr': 31536000 } }
    };

    // --- 2. STATE ---
    const [category, setCategory] = React.useState('Activity');
    const [fromVal, setFromVal] = React.useState('1');
    const [fromUnit, setFromUnit] = React.useState('Ci');
    const [toUnit, setToUnit] = React.useState('GBq');
    
    // Auto-update units when category changes
    React.useEffect(() => {
        const units = Object.keys(CATEGORIES[category].units);
        if (category === 'Activity') { setFromUnit('Ci'); setToUnit('GBq'); }
        else if (category === 'Dose Equivalent') { setFromUnit('mrem'); setToUnit('µSv'); }
        else if (category === 'Contamination') { setFromUnit('dpm/100cm²'); setToUnit('Bq/cm²'); }
        else { setFromUnit(units[0]); setToUnit(units[1] || units[0]); }
    }, [category]);

    // --- 3. CALCULATION ---
    const result = React.useMemo(() => {
        const val = parseFloat(fromVal);
        if (isNaN(val)) return '---';
        const catData = CATEGORIES[category];
        const baseFactorFrom = catData.units[fromUnit];
        const baseFactorTo = catData.units[toUnit];
        if (!baseFactorFrom || !baseFactorTo) return '---';
        const inBase = val * baseFactorFrom;
        const final = inBase / baseFactorTo;
        if (final === 0) return '0';
        if (Math.abs(final) < 1e-3 || Math.abs(final) > 1e6) return final.toExponential(4);
        return parseFloat(final.toPrecision(6)).toString();
    }, [category, fromVal, fromUnit, toUnit]);

    const factorDisplay = React.useMemo(() => {
        const catData = CATEGORIES[category];
        const baseFactorFrom = catData.units[fromUnit];
        const baseFactorTo = catData.units[toUnit];
        if (!baseFactorFrom || !baseFactorTo) return null;
        const factor = baseFactorFrom / baseFactorTo;
        return `1 ${fromUnit} ≈ ${factor < 1e-3 || factor > 1e4 ? factor.toExponential(3) : parseFloat(factor.toPrecision(4))} ${toUnit}`;
    }, [category, fromUnit, toUnit]);

    // --- 4. HANDLERS ---
    const handleSwap = () => {
        setFromUnit(toUnit);
        setToUnit(fromUnit);
    };

    const handleSave = () => {
        if (result !== '---') {
            addHistory({ id: Date.now(), type: 'Conversion', icon: ICONS.refresh, inputs: `${fromVal} ${fromUnit}`, result: `${result} ${toUnit}`, view: VIEWS.CONVERTER });
            addToast("Saved to history!");
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Unit Converter</h2>
                    <button onClick={() => { setFromVal('1'); }} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-3 h-3"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        Clear
                    </button>
                </div>

                {/* Category Grid (No Scrollbar) */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-8">
                    {Object.keys(CATEGORIES).map(cat => (
                        <button 
                            key={cat} 
                            onClick={() => setCategory(cat)}
                            className={`px-2 py-2 rounded-lg text-xs font-bold transition-all duration-200 border
                                ${category === cat 
                                    ? 'bg-sky-50 dark:bg-sky-900/30 border-sky-500 text-sky-700 dark:text-sky-300 shadow-sm ring-1 ring-sky-500' 
                                    : 'bg-slate-50 dark:bg-slate-700/50 border-transparent text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                                }`}
                        >
                            {cat}
                        </button>
                    ))}
                </div>

                {/* Converter Core */}
                <div className="space-y-2">
                    
                    {/* FROM Input Box */}
                    <div className="relative group bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-700 transition-all focus-within:ring-2 focus-within:ring-sky-500 focus-within:border-transparent">
                        <div className="px-4 pt-3 pb-1">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">From</label>
                            <div className="flex items-center">
                                <input 
                                    type="number" 
                                    value={fromVal} 
                                    onChange={e => setFromVal(e.target.value)} 
                                    className="flex-1 bg-transparent text-2xl font-bold text-slate-800 dark:text-white focus:outline-none placeholder-slate-300"
                                    placeholder="0"
                                />
                                <div className="ml-2 pl-2 border-l border-slate-200 dark:border-slate-600">
                                    <select 
                                        value={fromUnit} 
                                        onChange={e => setFromUnit(e.target.value)}
                                        className="bg-transparent font-bold text-sm text-slate-600 dark:text-slate-300 focus:outline-none cursor-pointer hover:text-sky-600"
                                    >
                                        {Object.keys(CATEGORIES[category].units).map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Swap Button (Floating Overlay) */}
                    <div className="h-4 relative z-10 flex justify-center">
                        <button 
                            onClick={handleSwap}
                            className="absolute -top-4 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sky-600 rounded-full p-1.5 shadow-sm hover:scale-110 hover:shadow-md transition-all duration-200"
                            title="Swap Units"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2.5} stroke="currentColor" className="w-4 h-4">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                            </svg>
                        </button>
                    </div>

                    {/* TO Input Box (Read Only Style) */}
                    <div className="relative group bg-sky-50 dark:bg-sky-900/10 rounded-xl border border-sky-100 dark:border-sky-800/50 transition-all">
                        <div className="px-4 pt-3 pb-1">
                            <div className="flex justify-between items-center">
                                <label className="text-[10px] font-bold text-sky-600/70 dark:text-sky-400/70 uppercase tracking-wider block">To</label>
                                <button onClick={handleSave} className="text-sky-400 hover:text-sky-600 transition-colors"><Icon path={ICONS.notepad} className="w-4 h-4"/></button>
                            </div>
                            <div className="flex items-center">
                                <div className="flex-1 text-2xl font-bold text-sky-700 dark:text-sky-400 truncate py-1">
                                    {result}
                                </div>
                                <div className="ml-2 pl-2 border-l border-sky-200 dark:border-sky-800">
                                    <select 
                                        value={toUnit} 
                                        onChange={e => setToUnit(e.target.value)}
                                        className="bg-transparent font-bold text-sm text-sky-700 dark:text-sky-300 focus:outline-none cursor-pointer hover:text-sky-900"
                                    >
                                        {Object.keys(CATEGORIES[category].units).map(u => <option key={u} value={u}>{u}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Factor Display */}
                    <div className="px-2 flex justify-between text-[10px] text-slate-400 font-medium">
                        <span>{factorDisplay}</span>
                        <CopyButton textToCopy={result} label="Copy Result" />
                    </div>

                </div>
            </div>
        </div>
    );
};              
              /**
              * @description A component that displays a prominent header for the selected nuclide
              * along with the detailed context display for use in calculators. It includes a clear button.
              * @param {{nuclide: object, onClear: () => void}} props - The nuclide object and the function to clear it.
              */
              
              const CalculatorNuclideInfo = ({ nuclide, onClear }) => {
              if (!nuclide) return null; // Don't render anything if no nuclide is selected
              
              return (
              <div className="my-2 animate-fade-in">
              
                  <div className="relative text-center p-3 bg-slate-50 dark:bg-slate-800/50 border-y border-slate-200 dark:border-slate-700">
                      <h3 className="text-2xl font-bold text-sky-600 dark:text-sky-400">{nuclide.name}</h3>
                      <p className="text-sm font-semibold text-slate-500 dark:text-slate-400">({nuclide.symbol})</p>
              
                      {/* The "Clear Nuclide" button */}
              
                      <button
         onClick={onClear}
         className="absolute top-1 right-1 p-2 rounded-full text-slate-400 hover:text-sky-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
         title="Change nuclide"
         aria-label="Clear selected nuclide"
         >
                          <Icon path={ICONS.clear} className="w-5 h-5" />
                      </button>
                  </div>
              
                  {/* The existing context display is now included here */}
              
                  <NuclideContextDisplay nuclide={nuclide} />
              </div>
              );
              };
              
              /**
               * @description A comprehensive calculator for various radioactive decay scenarios,
               * including finding remaining/initial activity, time elapsed, and daughter product activity.
               * It also generates data for a visual decay chart.
               * @param {{radionuclides: Array<object>}} props - The full list of radionuclide data.
               */
              
const DecayToLimitCalculator = ({ radionuclides, selectedNuclide, setSelectedNuclide, initialActivity, setInitialActivity, initialUnit, setInitialUnit, finalActivity, setFinalActivity, finalUnit, setFinalUnit, result, setResult, error, setError, activityUnits, theme }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    // Added state for chart data
    const [chartData, setChartData] = React.useState(null);
    const [useLogScale, setUseLogScale] = React.useState(false);

    const nuclidesWithHalfLife = React.useMemo(() => radionuclides.filter(r => r.halfLife !== 'Stable').sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const activityFactorsBq = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'TBq': 1e12, 'µCi': 3.7e4, 'mCi': 3.7e7, 'Ci': 3.7e10, 'dps': 1, 'dpm': 1/60 };

    React.useEffect(() => {
        try {
            setError('');
            setChartData(null); // Reset chart on input change
            
            if (!selectedNuclide) { setResult(null); return; }
            
            const A0 = parseFloat(initialActivity);
            const Af = parseFloat(finalActivity);
            
            if (isNaN(A0) || isNaN(Af) || A0 <= 0 || Af < 0) {
                if (initialActivity && finalActivity) setError("Activities must be positive numbers.");
                setResult(null); return;
            }
            
            const A0_Bq = A0 * activityFactorsBq[initialUnit];
            const Af_Bq = Af * activityFactorsBq[finalUnit];
            
            if (Af_Bq >= A0_Bq) {
                setError("Final activity must be less than initial activity.");
                setResult(null); return;
            }
            
            const T_half_seconds = parseHalfLifeToSeconds(selectedNuclide.halfLife);
            const lambda = Math.log(2) / T_half_seconds;
            
            const time_seconds = (-1 / lambda) * Math.log(Af_Bq / A0_Bq);
            const num_half_lives = time_seconds / T_half_seconds;
            
            const bestUnit = getBestHalfLifeUnit(time_seconds);
            const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
            const time_in_best_unit = time_seconds / unitConversions[bestUnit];
            
            setResult({
                time: time_in_best_unit.toPrecision(4),
                unit: bestUnit,
                halfLives: num_half_lives.toFixed(2)
            });

            // --- GENERATE CHART DATA ---
            const labels = [];
            const parentData = [];
            
            // Plot slightly past the target time (e.g., 1.2x) to show the limit crossing
            const totalTimePlot = time_in_best_unit * 1.2;
            const steps = 100;

            for (let i = 0; i <= steps; i++) {
                const t_plot = (totalTimePlot / steps) * i;
                const t_plot_seconds = t_plot * unitConversions[bestUnit];
                
                // Calculate activity in the User's Initial Unit for consistency
                const currentAct_Bq = A0_Bq * Math.exp(-lambda * t_plot_seconds);
                const currentAct_UserUnit = currentAct_Bq / activityFactorsBq[initialUnit];

                labels.push(t_plot.toFixed(2));
                parentData.push(currentAct_UserUnit);
            }
            
            setChartData({
                labels, 
                parentData, 
                daughterData: null, 
                timeUnit: bestUnit, 
                parentName: selectedNuclide.name 
            });
            // ---------------------------

        } catch (e) {
            setError(e.message || "Calculation failed.");
            setResult(null);
        }
    }, [selectedNuclide, initialActivity, initialUnit, finalActivity, finalUnit]);

    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            addHistory({ 
                id: Date.now(), 
                type: 'Decay to Limit', 
                icon: ICONS.stopwatch, 
                inputs: `${initialActivity} ${initialUnit} ${selectedNuclide.symbol} to ${finalActivity} ${finalUnit}`, 
                result: `${result.time} ${result.unit}`, 
                view: VIEWS.CALCULATOR 
            });
            addToast('Calculation saved to history!');
        }
    };

    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates time required to decay to a specified activity level.</p>
            <div>
                <label className="text-sm font-medium">Radionuclide</label>
                <div className="mt-1 min-h-[42px]">
                    {selectedNuclide ? 
                        <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setSelectedNuclide(null)} /> :
                        <SearchableSelect options={nuclidesWithHalfLife} onSelect={(symbol) => setSelectedNuclide(radionuclides.find(n => n.symbol === symbol))} placeholder="Search for a radionuclide..." />
                    }
                </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium">Initial Activity</label>
                    <div className="flex">
                        <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                        <select value={initialUnit} onChange={e => setInitialUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Final (Target) Activity</label>
                    <div className="flex">
                        <input type="number" value={finalActivity} onChange={e => setFinalActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                        <select value={finalUnit} onChange={e => setFinalUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                    <div className="flex justify-between items-center">
                        <div></div>
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Time to Decay</p>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    <div className="flex items-center justify-center">
                        <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.time}</p>
                        <CopyButton textToCopy={result.time} />
                    </div>
                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">{result.unit}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">({result.halfLives} half-lives)</p>
                </div>
            )}
            
            {/* NEW: Render Chart */}
            {chartData && (
                <>
                    <div className="flex justify-end mt-4">
                        <label className="flex items-center gap-2 text-sm cursor-pointer">
                            <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" /> Use Logarithmic Scale
                        </label>
                    </div>
                    <DecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} />
                </>
            )} 
        </div>
    );
};
         
         
         // REPLACE the existing getTodayString with this:
const getNowString = () => {
    const now = new Date();
    // Adjust to local timezone ISO string (YYYY-MM-DDTHH:mm)
    const offset = now.getTimezoneOffset() * 60000;
    const localIso = new Date(now - offset).toISOString().slice(0, 16);
    return localIso;
};
         
const DecayTools = ({ radionuclides, preselectedNuclide, theme }) => {
    const { settings } = React.useContext(SettingsContext);
    const [activeCalculator, setActiveCalculator] = React.useState(() => localStorage.getItem('decayTools_activeTab') || 'standard');
    
    const activityUnits = React.useMemo(() => 
        settings.unitSystem === 'si' 
            ? ['Bq', 'kBq', 'MBq', 'GBq', 'TBq', 'dps', 'dpm'] 
            : ['µCi', 'mCi', 'Ci', 'dps', 'dpm'], 
        [settings.unitSystem]
    );
    
    const [std_selectedNuclide, setStd_selectedNuclide] = React.useState(() => { const savedSymbol = localStorage.getItem('decayCalc_nuclideSymbol'); if (!savedSymbol) return null; return radionuclides.find(n => n.symbol === savedSymbol) || null; });
    const [std_calculationMode, setStd_calculationMode] = React.useState(() => localStorage.getItem('decayCalc_mode') || 'findRemaining');
    const [std_initialActivity, setStd_initialActivity] = React.useState(() => localStorage.getItem('decayCalc_initialActivity') || '100');
    const [std_initialDaughterActivity, setStd_initialDaughterActivity] = React.useState(() => localStorage.getItem('decayCalc_initialDaughterActivity') || '0');
    // NEW: Branching Fraction State
    const [std_branchingFraction, setStd_branchingFraction] = React.useState(() => localStorage.getItem('decayCalc_branchingFraction') || '1.0');
    
    const [std_remainingActivity, setStd_remainingActivity] = React.useState(() => localStorage.getItem('decayCalc_remainingActivity') || '');
    const [std_timeElapsed, setStd_timeElapsed] = React.useState(() => localStorage.getItem('decayCalc_timeElapsed') || '1');
    const [std_timeUnit, setStd_timeUnit] = React.useState(() => localStorage.getItem('decayCalc_timeUnit') || 'days');
    const [std_useLogScale, setStd_useLogScale] = React.useState(() => JSON.parse(localStorage.getItem('decayCalc_useLogScale')) || false);
    
    const [corr_nuclideSymbol, setCorr_nuclideSymbol] = React.useState(() => localStorage.getItem('corr_nuclideSymbol') || '');
    const [corr_originalActivity, setCorr_originalActivity] = React.useState(() => localStorage.getItem('corr_originalActivity') || '10');
    const [corr_originalActivityUnit, setCorr_originalActivityUnit] = React.useState(() => localStorage.getItem('corr_originalActivityUnit') || activityUnits[1]);
    const [corr_originalDate, setCorr_originalDate] = React.useState(() => localStorage.getItem('corr_originalDate') || getNowString());
    const [corr_targetDate, setCorr_targetDate] = React.useState(() => localStorage.getItem('corr_targetDate') || getNowString());
    
    const [dtl_selectedNuclide, setDtl_selectedNuclide] = React.useState(() => { const saved = localStorage.getItem('dtl_nuclideSymbol'); return saved ? radionuclides.find(n => n.symbol === saved) : null; });
    const [dtl_initialActivity, setDtl_initialActivity] = React.useState(() => localStorage.getItem('dtl_initialActivity') || '10');
    const [dtl_initialUnit, setDtl_initialUnit] = React.useState(() => localStorage.getItem('dtl_initialUnit') || activityUnits[1]);
    const [dtl_finalActivity, setDtl_finalActivity] = React.useState(() => localStorage.getItem('dtl_finalActivity') || '0.001');
    const [dtl_finalUnit, setDtl_finalUnit] = React.useState(() => localStorage.getItem('dtl_finalUnit') || activityUnits[1]);
    const [dtl_result, setDtl_result] = React.useState(null);
    const [dtl_error, setDtl_error] = React.useState('');
    
    React.useEffect(() => { if (!activityUnits.includes(corr_originalActivityUnit)) setCorr_originalActivityUnit(activityUnits[1]); }, [activityUnits, corr_originalActivityUnit]);
    React.useEffect(() => { if (!activityUnits.includes(dtl_initialUnit)) setDtl_initialUnit(activityUnits[1]); }, [activityUnits, dtl_initialUnit]);
    React.useEffect(() => { if (!activityUnits.includes(dtl_finalUnit)) setDtl_finalUnit(activityUnits[1]); }, [activityUnits, dtl_finalUnit]);
    
    React.useEffect(() => { localStorage.setItem('decayTools_activeTab', activeCalculator); }, [activeCalculator]);
    React.useEffect(() => { localStorage.setItem('corr_nuclideSymbol', corr_nuclideSymbol); localStorage.setItem('corr_originalActivity', corr_originalActivity); localStorage.setItem('corr_originalActivityUnit', corr_originalActivityUnit); localStorage.setItem('corr_originalDate', corr_originalDate); localStorage.setItem('corr_targetDate', corr_targetDate); }, [corr_nuclideSymbol, corr_originalActivity, corr_originalActivityUnit, corr_originalDate, corr_targetDate]);
    React.useEffect(() => { localStorage.setItem('dtl_nuclideSymbol', dtl_selectedNuclide ? dtl_selectedNuclide.symbol : ''); localStorage.setItem('dtl_initialActivity', dtl_initialActivity); localStorage.setItem('dtl_initialUnit', dtl_initialUnit); localStorage.setItem('dtl_finalActivity', dtl_finalActivity); localStorage.setItem('dtl_finalUnit', dtl_finalUnit); }, [dtl_selectedNuclide, dtl_initialActivity, dtl_initialUnit, dtl_finalActivity, dtl_finalUnit]);
    
    // Updated Persistence for Standard Calculator
    React.useEffect(() => { 
        localStorage.setItem('decayCalc_nuclideSymbol', std_selectedNuclide ? std_selectedNuclide.symbol : ''); 
        localStorage.setItem('decayCalc_mode', std_calculationMode); 
        localStorage.setItem('decayCalc_initialActivity', std_initialActivity); 
        localStorage.setItem('decayCalc_initialDaughterActivity', std_initialDaughterActivity); 
        localStorage.setItem('decayCalc_branchingFraction', std_branchingFraction); // Save BR
        localStorage.setItem('decayCalc_remainingActivity', std_remainingActivity); 
        localStorage.setItem('decayCalc_timeElapsed', std_timeElapsed); 
        localStorage.setItem('decayCalc_timeUnit', std_timeUnit); 
        localStorage.setItem('decayCalc_useLogScale', JSON.stringify(std_useLogScale)); 
    }, [std_selectedNuclide, std_calculationMode, std_initialActivity, std_initialDaughterActivity, std_branchingFraction, std_remainingActivity, std_timeElapsed, std_timeUnit, std_useLogScale]);

    const handleStandardClear = () => {
        setStd_selectedNuclide(null);
        setStd_calculationMode('findRemaining');
        setStd_initialActivity('100');
        setStd_initialDaughterActivity('0');
        setStd_branchingFraction('1.0');
        setStd_remainingActivity('');
        setStd_timeElapsed('1');
        setStd_timeUnit('days');
        setStd_useLogScale(false);
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('decayCalc_')) {
                localStorage.removeItem(key);
            }
        });
    };
    
    const handleCorrectionClear = () => {
        setCorr_nuclideSymbol('');
        setCorr_originalActivity('10');
        setCorr_originalActivityUnit(activityUnits[1]);
        setCorr_originalDate('2020-01-01');
        setCorr_targetDate(getNowString()); // Fixed function call
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('corr_')) {
                localStorage.removeItem(key);
            }
        });
    };
    
    const handleDecayToLimitClear = () => {
        setDtl_selectedNuclide(null);
        setDtl_initialActivity('10');
        setDtl_initialUnit(activityUnits[1]);
        setDtl_finalActivity('0.001');
        setDtl_finalUnit(activityUnits[1]);
        setDtl_result(null);
        setDtl_error('');
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('dtl_')) {
                localStorage.removeItem(key);
            }
        });
    };
    
    const handleClearActiveCalculator = () => {
        if (activeCalculator === 'standard') handleStandardClear();
        else if (activeCalculator === 'correction') handleCorrectionClear();
        else handleDecayToLimitClear();
    };
    
    return (
    <div className="p-4 animate-fade-in">
       <div className="max-w-lg mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Decay Tools</h2>
               <ClearButton onClick={handleClearActiveCalculator} />
           </div>
           <div className="grid grid-cols-3 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6">
               <button onClick={() => setActiveCalculator('standard')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'standard' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Standard</button>
               <button onClick={() => setActiveCalculator('correction')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'correction' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Correction</button>
               <button onClick={() => setActiveCalculator('toLimit')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'toLimit' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>To Limit</button>
           </div>
           
           {activeCalculator === 'standard' && 
                <StandardDecayCalculator 
                    radionuclides={radionuclides} 
                    preselectedNuclide={preselectedNuclide} 
                    selectedNuclide={std_selectedNuclide} 
                    setSelectedNuclide={setStd_selectedNuclide} 
                    calculationMode={std_calculationMode} 
                    setCalculationMode={setStd_calculationMode} 
                    initialActivity={std_initialActivity} 
                    setInitialActivity={setStd_initialActivity} 
                    initialDaughterActivity={std_initialDaughterActivity} 
                    setInitialDaughterActivity={setStd_initialDaughterActivity} 
                    branchingFraction={std_branchingFraction} // Pass down state
                    setBranchingFraction={setStd_branchingFraction} // Pass down setter
                    remainingActivity={std_remainingActivity} 
                    setRemainingActivity={setStd_remainingActivity} 
                    timeElapsed={std_timeElapsed} 
                    setTimeElapsed={setStd_timeElapsed} 
                    timeUnit={std_timeUnit} 
                    setTimeUnit={setStd_timeUnit} 
                    useLogScale={std_useLogScale} 
                    setUseLogScale={setStd_useLogScale} 
                    theme={theme} 
                />
           }
           {activeCalculator === 'correction' && <SourceCorrectionCalculator radionuclides={radionuclides} nuclideSymbol={corr_nuclideSymbol} setNuclideSymbol={setCorr_nuclideSymbol} originalActivity={corr_originalActivity} setOriginalActivity={setCorr_originalActivity} originalActivityUnit={corr_originalActivityUnit} setOriginalActivityUnit={setCorr_originalActivityUnit} originalDate={corr_originalDate} setOriginalDate={setCorr_originalDate} targetDate={corr_targetDate} setTargetDate={setCorr_targetDate} activityUnits={activityUnits} />}
           {activeCalculator === 'toLimit' && <DecayToLimitCalculator radionuclides={radionuclides} selectedNuclide={dtl_selectedNuclide} setSelectedNuclide={setDtl_selectedNuclide} initialActivity={dtl_initialActivity} setInitialActivity={setDtl_initialActivity} initialUnit={dtl_initialUnit} setInitialUnit={setDtl_initialUnit} finalActivity={dtl_finalActivity} setFinalActivity={setDtl_finalActivity} finalUnit={dtl_finalUnit} setFinalUnit={setDtl_finalUnit} result={dtl_result} setResult={setDtl_result} error={dtl_error} setError={setDtl_error} activityUnits={activityUnits} theme={theme}/>}
       </div>
    </div>
    );
};         
 
             // This component is a source correction calculator that computes the activity of a radioactive source on a future date by applying the principle of radioactive decay. It requires the original activity, the calibration date, and the radionuclide's half-life to perform the calculation.
              
         const SourceCorrectionCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, originalActivity, setOriginalActivity, originalActivityUnit, setOriginalActivityUnit, originalDate, setOriginalDate, targetDate, setTargetDate, activityUnits }) => {
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const activityFactorsBq = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'TBq': 1e12, 'µCi': 3.7e4, 'mCi': 3.7e7, 'Ci': 3.7e10, 'dps': 1, 'dpm': 1/60 };
    const nuclidesWithHalfLife = React.useMemo(() => radionuclides.filter(r => r.halfLife !== 'Stable').sort((a,b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => radionuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, radionuclides]);
    
    React.useEffect(() => {
        if (!selectedNuclide) { setResult(null); return; }
        try {
            setError('');
            const A0 = parseFloat(originalActivity);
            if (isNaN(A0) || A0 < 0) throw new Error("Original activity must be a positive number.");
            
            const start = new Date(originalDate);
            const end = new Date(targetDate);
            
            if (isNaN(start.getTime()) || isNaN(end.getTime())) throw new Error("Please enter valid dates and times.");
            if (end < start) throw new Error("Target time cannot be before the original time.");
            
            const timeElapsed_ms = end - start;
            // Allow calculation even for 0 time elapsed
            const timeElapsed_s = timeElapsed_ms / 1000;
            
            const T_half_s = parseHalfLifeToSeconds(selectedNuclide.halfLife);
            if (T_half_s === Infinity) throw new Error("Cannot calculate decay for a stable nuclide.");
            
            const activity_Bq_0 = A0 * activityFactorsBq[originalActivityUnit];
            const activity_Bq_t = activity_Bq_0 * Math.pow(0.5, timeElapsed_s / T_half_s);
            const finalActivity = activity_Bq_t / activityFactorsBq[originalActivityUnit];
            
            // Smart formatting for time elapsed label
            let timeLabel = `${(timeElapsed_s / 86400).toFixed(2)} days`;
            if (timeElapsed_s < 86400) {
                timeLabel = `${(timeElapsed_s / 3600).toFixed(2)} hours`;
            }

            setResult({ currentActivity: finalActivity.toPrecision(4), timeLabel: timeLabel });
        } catch(e) {
            setError(e.message);
            setResult(null);
        }
    }, [selectedNuclide, originalActivity, originalActivityUnit, originalDate, targetDate]);
    
    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            // Format dates for display
            const dateStr = new Date(targetDate).toLocaleString();
            addHistory({
                id: Date.now(),
                type: 'Source Correction',
                icon: ICONS.calculator,
                inputs: `${originalActivity} ${originalActivityUnit} ${selectedNuclide.symbol}`,
                result: `${result.currentActivity} ${originalActivityUnit} (${dateStr})`,
                view: VIEWS.CALCULATOR
            });
            addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates a source's activity at a specific date and time.</p>
            <div>
                <label className="text-sm font-medium">Radionuclide</label>
                <div className="mt-1 min-h-[42px]">
                    {selectedNuclide ? ( 
                        <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> 
                    ) : ( 
                        <SearchableSelect options={nuclidesWithHalfLife} onSelect={setNuclideSymbol} placeholder="Search for a radionuclide..."/> 
                    )}
                </div>
            </div>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium">Original Activity</label>
                        <div className="flex">
                            <input type="number" value={originalActivity} onChange={e => setOriginalActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                            <select value={originalActivityUnit} onChange={e => setOriginalActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Original Date & Time</label>
                        {/* CHANGED: type="datetime-local" */}
                        <input type="datetime-local" value={originalDate} onChange={e => setOriginalDate(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Target Date & Time</label>
                    {/* CHANGED: type="datetime-local" */}
                    <input type="datetime-local" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                </div>
            </div>
             {error && <p className="text-red-500 text-sm text-center">{error}</p>}
             {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                    <div className="flex justify-between items-center">
                        <div></div>
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Corrected Activity</p>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                    </div>
                    <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.currentActivity}</p>
                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">{originalActivityUnit}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">({result.timeLabel} elapsed)</p>
                </div>
             )}
        </div>
    );
};
         
              // This component is a versatile radioactive decay calculator that supports four different modes: calculating remaining activity, finding the time elapsed, determining the initial activity, or calculating the activity of a radioactive daughter product. It visualizes the decay curve and handles various time units and logarithmic scales.         
         
const StandardDecayCalculator = ({ radionuclides, preselectedNuclide, selectedNuclide, setSelectedNuclide, calculationMode, setCalculationMode, initialActivity, setInitialActivity, initialDaughterActivity, setInitialDaughterActivity, branchingFraction, setBranchingFraction, remainingActivity, setRemainingActivity, timeElapsed, setTimeElapsed, timeUnit, setTimeUnit, useLogScale, setUseLogScale, theme }) => {
    const [result, setResult] = React.useState(null);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const MODE_REMAINING = 'findRemaining'; 
    const MODE_TIME = 'findTime'; 
    const MODE_INITIAL = 'findInitial'; 
    const MODE_DAUGHTER = 'findDaughterActivity';
    
    const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
    
    const sortedRadionuclides = React.useMemo(() => { 
        const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 }; 
        return [...radionuclides].filter(r => r.halfLife !== 'Stable').sort((a, b) => { 
            const orderA = commonalityOrder[a.commonality] || 0; 
            const orderB = commonalityOrder[b.commonality] || 0; 
            if (orderA !== orderB) { return orderB - orderA; } 
            return a.name.localeCompare(b.name); 
        }); 
    }, [radionuclides]);
    
    // --- UPDATED: Smart Reset for Branching Fraction ---
    // Resets to 1.0 automatically when nuclide changes, unless it's a known special case.
    React.useEffect(() => {
        if (calculationMode === MODE_DAUGHTER) {
            if (selectedNuclide?.symbol === 'Mo-99') {
                setBranchingFraction('0.875'); // Special case: Mo-99 -> Tc-99m
            } else {
                setBranchingFraction('1.0'); // Default for everything else
            }
        }
    }, [selectedNuclide, calculationMode, setBranchingFraction]);

    const handleCalculate = React.useCallback(() => {
        if (!selectedNuclide) return;
        
        try {
            setError('');
            const T_half_seconds = parseHalfLifeToSeconds(selectedNuclide.halfLife);
            const lambda = Math.log(2) / T_half_seconds;
            const A0 = parseFloat(initialActivity);
            const At = parseFloat(remainingActivity);
            const t_input = parseFloat(timeElapsed);
            const t_seconds = t_input * unitConversions[timeUnit];
            const br = parseFloat(branchingFraction) || 1.0;

            let timeForChart_seconds = t_seconds;
            let displayLambda = lambda;
            let lambdaUnit = 's⁻¹';

            // Format Decay Constant (Lambda) for Display
            if (lambda < 1e-6) { displayLambda = lambda * 31557600; lambdaUnit = 'yr⁻¹'; }
            else if (lambda < 1e-4) { displayLambda = lambda * 86400; lambdaUnit = 'd⁻¹'; }
            else if (lambda < 0.1) { displayLambda = lambda * 3600; lambdaUnit = 'hr⁻¹'; }

            if (calculationMode === MODE_REMAINING) {
                if (isNaN(A0) || isNaN(t_seconds)) throw new Error('Initial activity and time must be valid numbers.');
                const finalActivity = A0 * Math.exp(-lambda * t_seconds);
                setResult({ 
                    label: 'Remaining Activity', 
                    value: finalActivity.toPrecision(4), 
                    unit: '', 
                    lambdaVal: displayLambda.toPrecision(4), 
                    lambdaUnit: lambdaUnit 
                });
            } else if (calculationMode === MODE_TIME) {
                if (isNaN(A0) || isNaN(At) || A0 <= 0 || At < 0 || At > A0) throw new Error('Initial and remaining activities must be valid numbers, with At <= A0.');
                const timeInSeconds = (-1 / lambda) * Math.log(At / A0);
                const bestUnit = getBestHalfLifeUnit(timeInSeconds);
                const timeInBestUnit = timeInSeconds / unitConversions[bestUnit];
                setResult({ 
                    label: 'Time Elapsed', 
                    value: timeInBestUnit.toPrecision(4), 
                    unit: bestUnit, 
                    lambdaVal: displayLambda.toPrecision(4), 
                    lambdaUnit: lambdaUnit 
                });
                timeForChart_seconds = timeInSeconds;
            } else if (calculationMode === MODE_INITIAL) {
                if (isNaN(At) || isNaN(t_seconds)) throw new Error('Remaining activity and time must be valid numbers.');
                const initial = At / Math.exp(-lambda * t_seconds);
                setResult({ 
                    label: 'Initial Activity', 
                    value: initial.toPrecision(4), 
                    unit: '', 
                    lambdaVal: displayLambda.toPrecision(4), 
                    lambdaUnit: lambdaUnit 
                });
            } else if (calculationMode === MODE_DAUGHTER) {
                if (selectedNuclide.daughter.includes('/')) { throw new Error('This calculator does not support complex branching decay. Please use the Series Decay calculator.'); }
                if (br < 0 || br > 1) throw new Error('Branching fraction must be between 0 and 1.');
                
                const daughterName = selectedNuclide.daughter.split('(')[0].trim();
                const daughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
                if (!daughter) throw new Error('Daughter nuclide data not found.');
                const T_half_daughter_seconds = parseHalfLifeToSeconds(daughter.halfLife);
                const lambda2 = T_half_daughter_seconds === Infinity ? 0 : Math.log(2) / T_half_daughter_seconds;
                const A0_daughter = parseFloat(initialDaughterActivity);
                if (isNaN(A0) || isNaN(t_seconds) || isNaN(A0_daughter)) throw new Error("All inputs must be valid numbers.");
                
                const finalParentActivity = A0 * Math.exp(-lambda * t_seconds);
                let finalDaughterActivity;
                
                // Bateman Equation with Branching Fraction (br)
                if (Math.abs(lambda - lambda2) < 1e-12 * lambda) {
                    finalDaughterActivity = (A0_daughter * Math.exp(-lambda2 * t_seconds)) + (br * A0 * lambda2 * t_seconds * Math.exp(-lambda2 * t_seconds));
                } else {
                    finalDaughterActivity = (A0_daughter * Math.exp(-lambda2 * t_seconds)) + (br * (lambda2 / (lambda2 - lambda)) * A0 * (Math.exp(-lambda * t_seconds) - Math.exp(-lambda2 * t_seconds)));
                }
                setResult({ 
                    parent: { name: selectedNuclide.name, value: finalParentActivity.toPrecision(4) }, 
                    daughter: { name: daughter.name, value: finalDaughterActivity.toPrecision(4), isStable: T_half_daughter_seconds === Infinity },
                    lambdaVal: displayLambda.toPrecision(4), 
                    lambdaUnit: lambdaUnit
                });
            }
            
            // Chart Generation
            const labels = [], parentData = [], daughterData = [];
            const totalTime = timeForChart_seconds / unitConversions[timeUnit];
            const steps = 100;
            
            for (let i = 0; i <= steps; i++) {
                const timePoint = (totalTime / steps) * i;
                const timePoint_seconds = timePoint * unitConversions[timeUnit];
                labels.push(timePoint.toFixed(2));
                parentData.push(A0 * Math.exp(-lambda * timePoint_seconds));
                
                if (calculationMode === MODE_DAUGHTER) {
                    const A0_daughter = parseFloat(initialDaughterActivity);
                    const daughterName = selectedNuclide.daughter.split('(')[0].trim();
                    const daughter = radionuclides.find(n => normalizeString(n.name) === normalizeString(daughterName));
                    const T_half_daughter_seconds = parseHalfLifeToSeconds(daughter.halfLife);
                    const lambda2 = T_half_daughter_seconds === Infinity ? 0 : Math.log(2) / T_half_daughter_seconds;
                    let d_activity;
                    
                    if (Math.abs(lambda - lambda2) < 1e-12 * lambda) {
                        d_activity = (A0_daughter * Math.exp(-lambda2 * timePoint_seconds)) + (br * A0 * lambda2 * timePoint_seconds * Math.exp(-lambda2 * timePoint_seconds));
                    } else {
                        d_activity = (A0_daughter * Math.exp(-lambda2 * timePoint_seconds)) + (br * (lambda2 / (lambda2 - lambda)) * A0 * (Math.exp(-lambda * timePoint_seconds) - Math.exp(-lambda2 * timePoint_seconds)));
                    }
                    daughterData.push(d_activity);
                }
            }
            
            setChartData({ 
                labels, 
                parentData, 
                daughterData: daughterData.length > 0 ? daughterData : null, 
                timeUnit: timeUnit, 
                parentName: selectedNuclide.name, 
                daughterName: calculationMode === MODE_DAUGHTER ? selectedNuclide.daughter.split('(')[0].trim() : null 
            });
        
        } catch (e) {
            setError(e.message);
            setResult(null);
            setChartData(null);
        }
    }, [selectedNuclide, calculationMode, initialActivity, remainingActivity, timeElapsed, timeUnit, initialDaughterActivity, branchingFraction, radionuclides]);
    
    React.useEffect(() => { 
        if (selectedNuclide) { handleCalculate(); } 
    }, [selectedNuclide, calculationMode, initialActivity, remainingActivity, timeElapsed, timeUnit, initialDaughterActivity, branchingFraction, handleCalculate]);
    
    // Complete Save to History Logic
    const handleSaveToHistory = () => {
         if (result && selectedNuclide) {
             let inputStr = '';
             let resultStr = '';
             
             if (calculationMode === MODE_REMAINING) {
                 inputStr = `${initialActivity} of ${selectedNuclide.symbol} for ${timeElapsed} ${timeUnit}`;
                 resultStr = `${result.value}`;
             } else if (calculationMode === MODE_TIME) {
                 inputStr = `${initialActivity} → ${remainingActivity} of ${selectedNuclide.symbol}`;
                 resultStr = `${result.value} ${result.unit}`;
             } else if (calculationMode === MODE_INITIAL) {
                 inputStr = `? → ${remainingActivity} of ${selectedNuclide.symbol} in ${timeElapsed} ${timeUnit}`;
                 resultStr = `${result.value}`;
             } else if (calculationMode === MODE_DAUGHTER) {
                 inputStr = `${initialActivity} of ${selectedNuclide.symbol} (BR=${branchingFraction})`;
                 resultStr = `Daughter: ${result.daughter.value}`;
             }

             addHistory({ 
                 id: Date.now(), 
                 type: 'Decay Calc', 
                 icon: ICONS.calculator, 
                 inputs: inputStr, 
                 result: resultStr, 
                 view: VIEWS.CALCULATOR 
             });
             addToast('Saved to history!');
         }
    };

    return (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-slate-400">Calculates remaining activity, time, or daughter products.</p>
            <div>
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label>
                <div className="mt-1 min-h-[42px]">
                    {selectedNuclide ? ( <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => { setSelectedNuclide(null); }} /> ) : ( <SearchableSelect options={sortedRadionuclides} onSelect={(symbol) => { const n = sortedRadionuclides.find(r => r.symbol === symbol); setSelectedNuclide(n); }} placeholder="Search for a radionuclide..."/> )}
                </div>
            </div>
            <div>
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Calculate</label>
                <div className="grid grid-cols-2 gap-x-4 gap-y-2 mt-2">
                    {[MODE_REMAINING, MODE_TIME, MODE_INITIAL, MODE_DAUGHTER].map(mode => ( 
                        <label key={mode} className="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="calcMode" value={mode} checked={calculationMode === mode} onChange={() => setCalculationMode(mode)} className="form-radio h-4 w-4 text-sky-600"/>
                            <span className="text-sm">{ { [MODE_REMAINING]: 'Remaining Activity', [MODE_TIME]: 'Time Elapsed', [MODE_INITIAL]: 'Initial Activity', [MODE_DAUGHTER]: 'Daughter Activity' }[mode] }</span>
                        </label>
                    ))}
                </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                {renderInputField("Initial Activity", initialActivity, setInitialActivity, calculationMode !== MODE_INITIAL)}
                {calculationMode !== MODE_DAUGHTER && renderInputField("Remaining Activity", remainingActivity, setRemainingActivity, calculationMode === MODE_TIME || calculationMode === MODE_INITIAL)}
                {calculationMode === MODE_DAUGHTER && renderInputField("Initial Daughter Activity", initialDaughterActivity, setInitialDaughterActivity, true)}
                
                {/* Branching Fraction Input - Only visible in Daughter Mode */}
                {calculationMode === MODE_DAUGHTER && (
                    <div>
                        <Tooltip text="The fraction of parent decays that turn into this daughter (0.0 - 1.0). e.g., Mo-99 -> Tc-99m is 0.875.">
                             <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 cursor-help underline decoration-dotted">Branching Fraction</label>
                        </Tooltip>
                        <div className="flex gap-2 mt-1">
                            <input type="number" value={branchingFraction} onChange={e => setBranchingFraction(e.target.value)} step="0.01" min="0" max="1" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                        </div>
                    </div>
                )}

                {renderInputField("Time Elapsed", timeElapsed, setTimeElapsed, calculationMode !== MODE_TIME, timeUnit, setTimeUnit, ['minutes', 'hours', 'days', 'years'])}
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    {/* Decay Constant Display */}
                    <div className="flex justify-between text-xs text-slate-500 dark:text-slate-400 mb-2 border-b border-slate-200 dark:border-slate-600 pb-1">
                         <span>Decay Constant (λ): {result.lambdaVal} {result.lambdaUnit}</span>
                    </div>

                    {result.label ? (
                        <div className="flex items-center justify-center">
                            <div className="text-lg font-bold text-center flex-grow">
                                <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.label}</span>
                                <span>{result.value} {result.unit}</span>
                            </div>
                            <CopyButton textToCopy={result.value} />
                        </div>
                    ) : (
                        <div className="space-y-2">
                             <div className="flex items-center justify-between">
                                <div className="text-lg font-bold text-left">
                                    <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Remaining {result.parent.name}</span>
                                    <span>{result.parent.value}</span>
                                </div>
                                <CopyButton textToCopy={result.parent.value} />
                            </div>
                            <div className="flex items-center justify-between border-t border-slate-200 dark:border-slate-600 pt-2">
                                <div className="text-lg font-bold text-left">
                                    <span className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{result.daughter.name} {result.daughter.isStable ? "(Stable)" : ""}</span>
                                    <span>{result.daughter.value}</span>
                                </div>
                                <CopyButton textToCopy={result.daughter.value} />
                            </div>
                        </div>
                    )}
                    
                    <div className="text-right mt-2">
                        <button onClick={handleSaveToHistory} className="text-xs text-sky-600 dark:text-sky-400 hover:underline">Save Result</button>
                    </div>
                </div>
            )}
            
            {chartData && (
                <>
                    <div className="flex justify-end mt-4">
                        <label className="flex items-center gap-2 text-sm cursor-pointer">
                            <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" /> Use Logarithmic Scale
                        </label>
                    </div>
                    <DecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} />
                </>
            )} 
        </div>
    );
};

              
              /**
              * @description React component for a static surface contamination survey calculator.
              * This tool allows health physics professionals to quickly analyze a set of static
              * survey data points against regulatory or self-imposed limits.
              *
              * It is commonly used for a **2-part check**, verifying both:
              * 1.  The **average** contamination level is below the acceptable limit.
              * 2.  The **maximum** single reading is below a separate, often more conservative, limit.
              *
              * The component can automatically populate standard limits based on a selected radionuclide
              * and provides real-time feedback on whether the survey "passes" or "fails" both checks.
              *
              * @prop {array} radionuclides - Array of available radionuclides with their properties.
              * @prop {string} nuclideSymbol - The symbol of the currently selected nuclide.
              * @prop {function} setNuclideSymbol - State setter for the nuclide symbol.
              * @prop {string} surveyData - The raw, unparsed string of survey data points.
              * @prop {function} setSurveyData - State setter for the survey data string.
              * @prop {string} avgLimit - The average contamination limit.
              * @prop {function} setAvgLimit - State setter for the average limit.
              * @prop {string} maxLimit - The maximum contamination limit.
              * @prop {function} setMaxLimit - State setter for the maximum limit.
              * @prop {string} unit - The unit of measurement for the data (e.g., dpm/100cm²).
              * @prop {function} setUnit - State setter for the units.
              * @prop {object} result - Object containing the analysis results (average, max, pass/fail status).
              * @prop {function} setResult - State setter for the result object.
              * @prop {string} error - Any error message to display.
              * @prop {function} setError - State setter for error messages.
              */
              
              const StaticSurveyCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, surveyData, setSurveyData, avgLimit, setAvgLimit, maxLimit, setMaxLimit, unit, setUnit, result, setResult, error, setError }) => {
              const surveyNuclides = React.useMemo(() => radionuclides.filter(n => n.regGuideCategory).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
              const selectedNuclide = React.useMemo(() => surveyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, surveyNuclides]);
              
              React.useEffect(() => {
              if (selectedNuclide) {
                 const limits = REG_GUIDE_1_86_LIMITS[selectedNuclide.regGuideCategory];
                 if (limits) {
                     setAvgLimit(limits.total);
                     setMaxLimit(limits.total * 3);
                     setUnit('dpm/100cm²');
                 }
              }
              }, [selectedNuclide, setAvgLimit, setMaxLimit, setUnit]);
              
              React.useEffect(() => {
              try {
                 setError('');
                 if (!surveyData.trim()) { setResult(null); return; }
                 const dataPoints = surveyData.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
                 if (dataPoints.length === 0) throw new Error("No valid numeric data found.");
                 const avg = dataPoints.reduce((sum, val) => sum + val, 0) / dataPoints.length;
                 const max = Math.max(...dataPoints);
                 const avgL = parseFloat(avgLimit);
                 const maxL = parseFloat(maxLimit);
                 if (isNaN(avgL) || isNaN(maxL)) { if (avgLimit && maxLimit) { throw new Error("Limits must be valid numbers."); } else { return; } }
                 setResult({ count: dataPoints.length, average: avg, max: max, avgPass: avg <= avgL, maxPass: max <= maxL });
              } catch (e) { setError(e.message); setResult(null); }
              }, [surveyData, avgLimit, maxLimit, setResult, setError]);
              
              return (
              <div className="space-y-4 max-w-md mx-auto">
                <div><label className="text-sm font-medium">Survey Nuclide</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={surveyNuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide to auto-fill limits..."/>}</div></div>
                <div>
                    <label className="block text-sm font-medium">Survey Data</label>
                    <textarea value={surveyData} onChange={e => setSurveyData(e.target.value)} rows="6" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium">Average Limit</label><input type="number" value={avgLimit} onChange={e => setAvgLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div>
                         <Tooltip text="This is a common rule of thumb for routine surveys where an occasional higher-than-average reading is acceptable. Always refer to your specific license conditions or survey procedures.">
                             <label className="block text-sm font-medium">Max Limit</label>
                         </Tooltip>
                         <input type="number" value={maxLimit} onChange={e => setMaxLimit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                     </div>
                </div>
                <div><label className="block text-sm font-medium">Units</label><input type="text" value={unit} onChange={e => setUnit(e.target.value)} placeholder="e.g., mrem/hr, dpm/100cm²" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                {result && (
                    <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Survey Analysis Results ({result.count} points)</p>
                        <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-4">
                            <div className={`p-2 rounded ${result.avgPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                              <p className="text-xs font-bold">Average</p>
                              <p className={`font-bold text-lg ${result.avgPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.avgPass ? 'PASS' : 'FAIL'}</p>
                              <div className="flex items-center justify-center">
                                 <p className="text-sm">{result.average.toPrecision(3)}</p>
                                 <CopyButton textToCopy={result.average.toPrecision(3)} />
                              </div>
                            </div>
                            <div className={`p-2 rounded ${result.maxPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                              <p className="text-xs font-bold">Maximum</p>
                              <p className={`font-bold text-lg ${result.maxPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.maxPass ? 'PASS' : 'FAIL'}</p>
                              <div className="flex items-center justify-center">
                                 <p className="text-sm">{result.max.toPrecision(3)}</p>
                                 <CopyButton textToCopy={result.max.toPrecision(3)} />
                              </div>
                            </div>
                        </div>
                    </div>
                )}
                 {!result && !error && (
                     <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg mt-4">
                         <p className="text-slate-500 dark:text-slate-400">Enter survey data and limits to analyze the results.</p>
                     </div>
                 )}
              </div>
              );
              };
              
              // This component calculates the level of removable surface contamination in dpm/100cm² from gross count rate, background, and instrument efficiencies, then compares the result against regulatory limits from NRC Regulatory Guide 1.86 and ANSI N13.12.
              
              const ContaminationSurveyCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, grossCpm, setGrossCpm, backgroundCpm, setBackgroundCpm, instrumentEff, setInstrumentEff, removableFraction, setRemovableFraction, result, setResult, error, setError }) => {
              const surveyNuclides = React.useMemo(() => radionuclides.filter(n => n.regGuideCategory && n.ansiCategory).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
              const selectedNuclide = React.useMemo(() => surveyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, surveyNuclides]);
              
              React.useEffect(() => {
              try {
                 setError('');
                 if (!selectedNuclide) { setResult(null); return; }
                 const gross = parseFloat(grossCpm); const bkg = parseFloat(backgroundCpm);
                 const eff = parseFloat(instrumentEff) / 100; const frac = parseFloat(removableFraction);
                 if ([gross, bkg, eff, frac].some(isNaN) || eff <= 0 || frac <= 0) throw new Error("All inputs must be valid, positive numbers.");
                 if (gross < bkg) throw new Error("Gross CPM cannot be less than background.");
                 const netCpm = gross - bkg;
                 const dpm = netCpm / eff;
                 const contamination = dpm / frac;
                 const rgLimit = REG_GUIDE_1_86_LIMITS[selectedNuclide.regGuideCategory].removable;
                 const ansiLimit = ANSI_13_12_LIMITS[selectedNuclide.ansiCategory].removable;
                 setResult({ contamination: contamination.toFixed(0), rgPass: contamination <= rgLimit, ansiPass: contamination <= ansiLimit, rgLimit, ansiLimit });
              } catch (e) { setError(e.message); setResult(null); }
              }, [selectedNuclide, grossCpm, backgroundCpm, instrumentEff, removableFraction, setResult, setError]);
              
              return (
              <div className="space-y-4 max-w-md mx-auto">
                <div><label className="text-sm font-medium">Contaminant of Concern</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={surveyNuclides} onSelect={setNuclideSymbol} placeholder="Select a nuclide to find limits..."/>}</div></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium">Gross CPM</label><input type="number" value={grossCpm} onChange={e => setGrossCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div><label className="block text-sm font-medium">Background CPM</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div><label className="block text-sm font-medium">Instrument Eff. (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div><Tooltip text="The fraction of removable contamination collected by the wipe, typically assumed to be 10% (0.1)."><label className="block text-sm font-medium">Smear Eff. (0.0-1.0)</label></Tooltip><input type="number" step="0.01" value={removableFraction} onChange={e => setRemovableFraction(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                </div>
                {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                {result && (
                    <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Removable Contamination</p>
                         <div className="flex items-center justify-center">
                             <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.contamination} <span className="text-2xl opacity-75">dpm/100cm²</span></p>
                             <CopyButton textToCopy={result.contamination} />
                         </div>
                        <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-4">
                            <div className={`p-2 rounded ${result.rgPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                              <p className="text-xs font-bold">Reg. Guide 1.86</p>
                              <p className={`font-bold text-lg ${result.rgPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.rgPass ? 'PASS' : 'FAIL'}</p>
                              <p className="text-xs">(Limit: {result.rgLimit})</p>
                            </div>
                            <div className={`p-2 rounded ${result.ansiPass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                              <p className="text-xs font-bold">ANSI N13.12</p>
                              <p className={`font-bold text-lg ${result.ansiPass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.ansiPass ? 'PASS' : 'FAIL'}</p>
                              <p className="text-xs">(Limit: {result.ansiLimit})</p>
                            </div>
                        </div>
                    </div>
                )}
              </div>
              );
              };
          
const AirborneCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, releaseActivity, setReleaseActivity, activityUnit, setActivityUnit, activityUnits, roomVolume, setRoomVolume, volumeUnit, setVolumeUnit, ventilationRate, setVentilationRate, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const dosimetryNuclides = React.useMemo(() => radionuclides.filter(n => n.dosimetry?.DAC).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => dosimetryNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, dosimetryNuclides]);

    // Multipliers to convert input unit to µCi (for ALI calculation logic)
    const toMicroCurie = { 'pCi': 1e-6, 'nCi': 1e-3, 'µCi': 1, 'mCi': 1e3, 'Ci': 1e6, 'Bq': 2.7e-5, 'kBq': 0.027, 'MBq': 27, 'GBq': 27000 };

    React.useEffect(() => {
        if (!selectedNuclide) { setResult(null); return; }
        try {
            setError('');
            const act = parseFloat(releaseActivity); const vol = parseFloat(roomVolume); const vent = parseFloat(ventilationRate);
            if ([act, vol, vent].some(isNaN) || act < 0 || vol <= 0 || vent < 0) throw new Error("Inputs must be valid numbers.");
            
            const act_uCi = act * toMicroCurie[activityUnit];
            const vol_mL = vol * ({ 'm³': 1e6, 'L': 1000, 'ft³': 28316.8 }[volumeUnit]);
            
            const dac_uCi_mL = selectedNuclide.dosimetry.DAC.inhalation_W || selectedNuclide.dosimetry.DAC.inhalation_D || selectedNuclide.dosimetry.DAC.inhalation_Y || selectedNuclide.dosimetry.DAC.inhalation;
            if (!dac_uCi_mL) throw new Error(`DAC value not found for ${selectedNuclide.name}.`);
            
            const initialConc_uCi_mL = act_uCi / vol_mL;
            const lambda_eff_per_hr = vent;
            const time_to_1_dac_hr = lambda_eff_per_hr > 0 ? (-1 / lambda_eff_per_hr) * Math.log(dac_uCi_mL / initialConc_uCi_mL) : Infinity;
            
            setResult({ 
                initialConc: initialConc_uCi_mL.toExponential(3), 
                dacValue: dac_uCi_mL.toExponential(2), 
                dacMultiple: (initialConc_uCi_mL / dac_uCi_mL).toPrecision(3), 
                time_to_1_dac_hr: time_to_1_dac_hr > 0 ? time_to_1_dac_hr.toPrecision(3) : 0 
            });
        } catch (e) { setError(e.message); setResult(null); }
    }, [selectedNuclide, releaseActivity, activityUnit, roomVolume, volumeUnit, ventilationRate, setResult, setError]);

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({
                id: Date.now(),
                type: 'Airborne Release',
                icon: ICONS.radon,
                inputs: `${releaseActivity} ${activityUnit} in ${roomVolume} ${volumeUnit}`,
                result: `${result.dacMultiple}x DAC`,
                view: VIEWS.OPERATIONAL_HP
            });
            addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="space-y-4 max-w-md mx-auto">
            <div><label className="text-sm font-medium">Radionuclide</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> : <SearchableSelect options={dosimetryNuclides} onSelect={setNuclideSymbol} placeholder="Select a nuclide with a DAC..." />}</div></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium">Released Activity</label><div className="flex"><input type="number" value={releaseActivity} onChange={e => setReleaseActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" /><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                <div><label className="block text-sm font-medium">Room Volume</label><div className="flex"><input type="number" value={roomVolume} onChange={e => setRoomVolume(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" /><select value={volumeUnit} onChange={e => setVolumeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600"><option>m³</option><option>L</option><option>ft³</option></select></div></div>
                <div className="md:col-span-2"><label className="block text-sm font-medium">Ventilation Rate (ACH)</label><input type="number" value={ventilationRate} onChange={e => setVentilationRate(e.target.value)} placeholder="Air Changes per Hour" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
            </div>
            
            <ContextualNote type="warning">
                <strong>Safety Assumption:</strong> This model assumes perfect, instantaneous mixing of the contaminant. Localized concentrations near the release point may be significantly higher than the calculated average.
            </ContextualNote>

            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 text-center animate-fade-in">
                    <div className="flex justify-end -mt-2 -mr-2">
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                            <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                <Icon path={ICONS.notepad} className="w-5 h-5" />
                            </button>
                        </Tooltip>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-sm -mt-4"><p>Initial Concentration:</p><p className="font-mono">{result.initialConc} µCi/mL</p><p>Nuclide DAC:</p><p className="font-mono">{result.dacValue} µCi/mL</p></div>
                    <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Initial Concentration</p>
                        <div className="flex items-center justify-center">
                            <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.dacMultiple}x DAC</p>
                            <CopyButton textToCopy={result.dacMultiple} />
                        </div>
                    </div>
                    <div className="border-t border-slate-300 dark:border-slate-600 pt-3">
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Time to reach 1 DAC</p>
                        <div className="flex items-center justify-center">
                            <p className="text-2xl font-bold">{result.time_to_1_dac_hr} hours</p>
                            <CopyButton textToCopy={result.time_to_1_dac_hr} />
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};
         
// 1. UPDATED: SurfaceContaminationCalculator (Added Probe Area)
const SurfaceContaminationCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, staticData, setStaticData, wipeGrossCpm, setWipeGrossCpm, wipeBackgroundCpm, setWipeBackgroundCpm, instrumentEff, setInstrumentEff, smearEff, setSmearEff, probeArea, setProbeArea, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const surveyNuclides = React.useMemo(() => radionuclides.filter(n => n.regGuideCategory && n.ansiCategory).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    const selectedNuclide = React.useMemo(() => surveyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, surveyNuclides]);
    
    React.useEffect(() => {
        try {
            setError('');
            if (!selectedNuclide) { setResult(null); return; }
 
            const staticPoints = staticData.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);
            const wipeGross = parseFloat(wipeGrossCpm);
            const wipeBkg = parseFloat(wipeBackgroundCpm);
            const instEff = parseFloat(instrumentEff) / 100.0;
            const smearFraction = parseFloat(smearEff);
            const area = parseFloat(probeArea);
 
            if (isNaN(instEff) || instEff <= 0) throw new Error("Instrument efficiency must be a positive number.");
            if (isNaN(area) || area <= 0) throw new Error("Probe physical area is required.");
 
            let removableDPM = null, totalDPM = null, maxDPM = null;
 
            // Calculate Removable (Wipe)
            // DPM/100cm2 = NetCPM / (Eff_inst * Eff_wipe)
            // Note: Standard assumes wipe covers 100cm2. If not, user adjusts efficiency or interpretation.
            if (!isNaN(wipeGross) && !isNaN(wipeBkg)) {
                if (wipeGross < wipeBkg) { 
                     // Technically valid (stats), but for safety we treat as < LLD or 0
                     removableDPM = 0; 
                } else {
                     if (isNaN(smearFraction) || smearFraction <= 0) throw new Error("Smear efficiency must be positive.");
                     const netWipeCpm = wipeGross - wipeBkg;
                     removableDPM = netWipeCpm / (instEff * smearFraction);
                }
            }
 
            // Calculate Total (Static)
            // DPM/100cm2 = (NetCPM / Eff_inst) * (100 / ProbeArea)
            if (staticPoints.length > 0) {
                const avgStaticCpm = staticPoints.reduce((sum, val) => sum + val, 0) / staticPoints.length;
                const maxStaticCpm = Math.max(...staticPoints);
                
                // Subtract Bkg? Static data usually entered as Gross. 
                // Let's assume Gross. We need a static background input?
                // For simplicity in this tool, we assume inputs are NET counts or user handled background.
                // *Improvement*: Let's treat them as Gross and use the Wipe Bkg as the Static Bkg proxy if available.
                const bkg = !isNaN(wipeBkg) ? wipeBkg : 0;
                
                const avgNet = Math.max(0, avgStaticCpm - bkg);
                const maxNet = Math.max(0, maxStaticCpm - bkg);
 
                totalDPM = (avgNet / instEff) * (100 / area);
                maxDPM = (maxNet / instEff) * (100 / area);
            }
 
            if (removableDPM === null && totalDPM === null) { setResult(null); return; }
 
            const rgLimits = REG_GUIDE_1_86_LIMITS[selectedNuclide.regGuideCategory];
            const ansiLimits = ANSI_13_12_LIMITS[selectedNuclide.ansiCategory];
 
            setResult({
                removable: removableDPM,
                total_avg: totalDPM,
                total_max: maxDPM,
                rg: {
                    removable_limit: rgLimits.removable,
                    total_limit: rgLimits.total,
                    removable_pass: removableDPM === null || removableDPM <= rgLimits.removable,
                    total_pass: totalDPM === null || totalDPM <= rgLimits.total,
                },
                ansi: {
                    removable_limit: ansiLimits.removable,
                    total_limit: ansiLimits.total,
                    removable_pass: removableDPM === null || removableDPM <= ansiLimits.removable,
                    total_pass: totalDPM === null || totalDPM <= ansiLimits.total,
                }
            });
        } catch (e) {
            setError(e.message);
            setResult(null);
        }
    }, [selectedNuclide, staticData, wipeGrossCpm, wipeBackgroundCpm, instrumentEff, smearEff, probeArea]);
    
    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            addHistory({ 
                id: Date.now(), 
                type: 'Surface Survey', 
                icon: ICONS.gammaSpec, 
                inputs: `${selectedNuclide.symbol}, Area=${probeArea}cm²`, 
                result: `Removable: ${result.removable?.toFixed(0) || 'N/A'} dpm`, 
                view: VIEWS.OPERATIONAL_HP 
            });
            addToast("Saved to history!");
        }
    };
    
    return (
        <div className="space-y-4">
            <div><label className="text-sm font-medium">Contaminant of Concern</label><div className="mt-1">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')}/> : <SearchableSelect options={surveyNuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide to find limits..."/>}</div></div>
 
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3">
                    <label className="block text-sm font-semibold text-slate-700 dark:text-slate-300">Total Contamination (Static)</label>
                    <textarea value={staticData} onChange={e => setStaticData(e.target.value)} rows="3" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste Gross CPM values..."></textarea>
                    
                    <div className="pt-2 border-t border-slate-200 dark:border-slate-700">
                        <label className="block text-xs font-bold text-slate-500 mb-1">Physical Probe Area (cm²)</label>
                        <div className="flex gap-2">
                             <input type="number" value={probeArea} onChange={e => setProbeArea(e.target.value)} className="w-full p-2 rounded-md bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-sm"/>
                             <select onChange={e => setProbeArea(e.target.value)} className="w-8 p-1 rounded-md bg-slate-200 dark:bg-slate-600 border-none text-xs text-center" value="">
                                <option value="" disabled>Presets</option>
                                <option value="15">15 (Pancake)</option>
                                <option value="100">100 (Alpha)</option>
                                <option value="584">584 (Floor)</option>
                             </select>
                        </div>
                    </div>
                </div>
                <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-3">
                    <label className="block text-sm font-semibold text-slate-700 dark:text-slate-300">Removable (Wipe)</label>
                    <div className="grid grid-cols-2 gap-2">
                        <div><label className="block text-xs font-medium">Gross CPM</label><input type="number" value={wipeGrossCpm} onChange={e => setWipeGrossCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                        <div><label className="block text-xs font-medium">Bkg CPM</label><input type="number" value={wipeBackgroundCpm} onChange={e => setWipeBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    </div>
                    <div><label className="block text-xs font-medium">Smear Eff. (0-1)</label><input type="number" step="0.01" value={smearEff} onChange={e => setSmearEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                </div>
            </div>
            
            <div><label className="block text-sm font-medium">Instrument Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" placeholder="e.g. 10 (4pi)"/></div>
 
            {error && <p className="text-red-500 text-sm text-center bg-red-50 dark:bg-red-900/20 p-2 rounded">{error}</p>}
            
            {result && (
                <div className="p-5 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in shadow-sm">
                     <div className="flex justify-between items-center -mt-2 mb-2">
                         <div></div>
                         <h3 className="font-bold text-sm text-slate-500 dark:text-slate-400 uppercase tracking-wide">Survey Results (dpm/100cm²)</h3>
                         <Tooltip text="Save to history"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-600 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip>
                     </div>
                     
                     <div className="flex flex-wrap justify-center gap-4">
                         {result.removable !== null && (
                             <div className="flex-1 min-w-[140px] p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border-l-4 border-sky-500">
                                 <p className="text-xs font-bold text-slate-500">Removable</p>
                                 <p className="text-2xl font-bold text-slate-800 dark:text-white my-1">{parseInt(result.removable).toLocaleString()}</p>
                                 <div className={`text-xs font-bold px-2 py-1 rounded ${result.rg.removable_pass ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                     Limit: {result.rg.removable_limit}
                                 </div>
                             </div>
                         )}
                         {result.total_avg !== null && (
                             <div className="flex-1 min-w-[140px] p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border-l-4 border-purple-500">
                                 <p className="text-xs font-bold text-slate-500">Total (Avg)</p>
                                 <p className="text-2xl font-bold text-slate-800 dark:text-white my-1">{parseInt(result.total_avg).toLocaleString()}</p>
                                 <div className={`text-xs font-bold px-2 py-1 rounded ${result.rg.total_pass ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                     Limit: {result.rg.total_limit.toLocaleString()}
                                 </div>
                             </div>
                         )}
                     </div>
                </div>
            )}
        </div>
    );
};

// 2. UPDATED: DetectorResponseCalculator (Dynamic Geometry)
const DetectorResponseCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, activity, setActivity, activityUnit, setActivityUnit, distance, setDistance, distanceUnit, setDistanceUnit, detectorType, setDetectorType, shieldMaterial, setShieldMaterial, shieldThickness, setShieldThickness, shieldThicknessUnit, setShieldThicknessUnit, surfaceEff, setSurfaceEff, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    // --- UPDATED CONFIG: Included radii ---
    const DETECTORS = {
        'nai_1x1': { label: '1" x 1" NaI(Tl)', type: 'gamma_only', refCpmPerMicroR: 175, radius_cm: 1.27 },
        'nai_2x2': { label: '2" x 2" NaI(Tl)', type: 'gamma_only', refCpmPerMicroR: 900, radius_cm: 2.54 },
        'gm_pancake': { label: 'Pancake GM (Ludlum 44-9)', type: 'mix', refBetaEff: 0.20, alphaEff: 0.15, gammaCpmPerMicroR: 3.3, radius_cm: 2.2 },
        'zns_alpha': { label: 'ZnS(Ag) Scintillator', type: 'alpha_only', alphaEff: 0.25, radius_cm: 2.5 }
    };

    const SHIELD_PROPS = {
        'None': { density: 0 },
        'Paper/Clothing': { density: 0.8 },
        'Plastic/Lucite': { density: 1.18, mapTo: 'Water' },
        'Wood': { density: 0.6, mapTo: 'Water' },
        'Aluminum': { density: 2.7, mapTo: 'Aluminum' },
        'Steel': { density: 7.8, mapTo: 'Steel' },
        'Lead': { density: 11.34, mapTo: 'Lead' }
    };

    const activityFactorsCi = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'TBq': 1 / 0.037, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1 };
    const distanceFactorsM = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };
    const thicknessFactorsCm = { 'mm': 0.1, 'cm': 1, 'in': 2.54 };

    const parseE = (str) => { if(!str) return 0; const parts = str.split(' '); let val = parseFloat(parts[0]); if(str.toLowerCase().includes('kev')) val /= 1000; return val; };

    const availableNuclides = React.useMemo(() => {
        const det = DETECTORS[detectorType];
        if (det.type === 'alpha_only') return radionuclides.filter(n => n.emissionEnergies?.alpha?.length > 0);
        if (det.type === 'gamma_only') return radionuclides.filter(n => n.gammaConstant);
        return radionuclides; 
    }, [radionuclides, detectorType]);

    const selectedNuclide = React.useMemo(() => radionuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, radionuclides]);

    React.useEffect(() => {
        try {
            setError('');
            if (!selectedNuclide) { setResult(null); return; }

            const A_val = parseFloat(activity);
            const d_val = parseFloat(distance);
            const t_val = shieldMaterial === 'None' ? 0 : parseFloat(shieldThickness);
            const eff_surf_pct = parseFloat(surfaceEff);

            if (isNaN(A_val) || isNaN(d_val) || A_val <= 0 || d_val <= 0) { if(activity && distance) setError("Inputs must be positive."); setResult(null); return; }

            const detInfo = DETECTORS[detectorType];
            const A_Ci = A_val * activityFactorsCi[activityUnit];
            const d_m = d_val * distanceFactorsM[distanceUnit];
            const t_cm = t_val * thicknessFactorsCm[shieldThicknessUnit];
            const shieldDensity = SHIELD_PROPS[shieldMaterial].density;
            const eff_surf = eff_surf_pct / 100.0; 

            let cpmGamma = 0, cpmBeta = 0, cpmAlpha = 0;
            let attenuationMsg = [];

            // 1. Gamma
            if (detInfo.type !== 'alpha_only' && selectedNuclide.gammaConstant) {
                const gamma = parseFloat(selectedNuclide.gammaConstant);
                if (gamma > 0) {
                    const doseRate_uR_hr = ((gamma * A_Ci) / Math.pow(d_m, 2)) * 1e6;
                    let transmission = 1;
                    // Simple attenuation (Linear) - Improve if using Shielding Calculator logic later
                    // Using approx 1 HVL for generic energy if needed, or Cs-137 proxy
                    // For brevity, we assume 1.0 or user checks shielding calc. 
                    // To handle basic shielding:
                    if (shieldMaterial !== 'None' && t_cm > 0) {
                         // Rough approx using Cs-137 HVL logic
                         const hvl = HVL_DATA[selectedNuclide.symbol]?.[SHIELD_PROPS[shieldMaterial].mapTo] || 0.6; // Default to ~Lead-ish
                         transmission = Math.pow(0.5, t_cm / hvl);
                    }
                    
                    const responseFactor = detInfo.refCpmPerMicroR || detInfo.gammaCpmPerMicroR;
                    cpmGamma = doseRate_uR_hr * transmission * responseFactor;
                }
            }

            // 2. Beta/Alpha Geometry
            if (detInfo.type === 'mix' || detInfo.type === 'alpha_only') {
                const r_det = detInfo.radius_cm; // USE DYNAMIC RADIUS
                const d_cm = d_m * 100;
                // Solid Angle Efficiency: 0.5 * (1 - d / sqrt(d^2 + r^2))
                const geoEff = 0.5 * (1 - (d_cm / Math.sqrt(Math.pow(d_cm, 2) + Math.pow(r_det, 2))));
                const A_dpm = A_Ci * 2.22e12;

                if (detInfo.type === 'mix' && selectedNuclide.emissionEnergies?.beta?.length > 0) {
                    const eMax = parseE(selectedNuclide.emissionEnergies.beta[0]);
                    let range_cm = (0.542 * eMax - 0.133) / shieldDensity; // Approx
                    if (shieldMaterial !== 'None' && t_cm > range_cm) { attenuationMsg.push("Betas blocked."); }
                    else {
                         // Simple distance attenuation in air
                         if (d_m > 1) { attenuationMsg.push("Betas ranged out in air."); }
                         else {
                             cpmBeta = A_dpm * geoEff * (detInfo.refBetaEff || 0.2) * eff_surf;
                         }
                    }
                }
                
                if (detInfo.alphaEff && selectedNuclide.emissionEnergies?.alpha?.length > 0) {
                     if (shieldMaterial !== 'None' || d_m > 0.05) { attenuationMsg.push("Alphas blocked."); }
                     else {
                         cpmAlpha = A_dpm * geoEff * detInfo.alphaEff * eff_surf;
                     }
                }
            }

            setResult({ 
                cpm: (cpmGamma + cpmBeta + cpmAlpha).toPrecision(4), 
                detLabel: detInfo.label, 
                breakdown: `γ:${cpmGamma.toFixed(0)} β:${cpmBeta.toFixed(0)} α:${cpmAlpha.toFixed(0)}`,
                notes: attenuationMsg
            });

        } catch (e) { setError(e.message); setResult(null); }
    }, [nuclideSymbol, activity, activityUnit, distance, detectorType, shieldMaterial, shieldThickness, surfaceEff]);

    const handleSave = () => {
        if(result) {
            addHistory({ id: Date.now(), type: 'Detector Response', icon: ICONS.doseRate, inputs: `${activity} ${activityUnit} ${nuclideSymbol}`, result: `${Math.round(result.cpm)} cpm`, view: VIEWS.OPERATIONAL_HP });
            addToast("Saved!");
        }
    }

    return (
        <div className="space-y-4">
            <ContextualNote type="info"><strong>Geometry:</strong> Calculates solid angle efficiency based on detector radius ({DETECTORS[detectorType].radius_cm} cm).</ContextualNote>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div><label className="block text-sm font-medium">Detector</label><select value={detectorType} onChange={e => setDetectorType(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.entries(DETECTORS).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}</select></div>
                <div className="min-h-[42px]">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> : <SearchableSelect options={availableNuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide..." />}</div>
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{Object.keys(activityFactorsCi).map(u=><option key={u}>{u}</option>)}</select></div></div>
                    <div><label className="block text-sm font-medium">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{Object.keys(distanceFactorsM).map(u=><option key={u}>{u}</option>)}</select></div></div>
                </div>
            </div>
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm">
                    <div className="flex justify-end -mt-2 -mr-2"><button onClick={handleSave}><Icon path={ICONS.notepad} className="w-5 h-5 text-slate-400 hover:text-sky-500"/></button></div>
                    <p className="text-sm font-bold text-slate-500 uppercase">Estimated Response</p>
                    <p className="text-3xl font-extrabold text-sky-600 dark:text-sky-400 my-2">{parseInt(result.cpm).toLocaleString()} <span className="text-xl text-slate-500">cpm</span></p>
                    <p className="text-xs text-slate-500">{result.breakdown}</p>
                    {result.notes.map((n,i) => <p key={i} className="text-xs text-amber-600 mt-1">{n}</p>)}
                </div>
            )}
        </div>
    );
};

// 3. UPDATED: LeakTestCalculator (Added Action Level)
const LeakTestCalculator = ({ grossCpm, setGrossCpm, backgroundCpm, setBackgroundCpm, instrumentEff, setInstrumentEff, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const LIMIT_UCI = 0.005;
    
    // Auto-calculate Action Level
    const actionLevelNetCpm = React.useMemo(() => {
        const eff = parseFloat(instrumentEff) / 100;
        if (eff > 0) return Math.ceil(LIMIT_UCI * 2.22e6 * eff);
        return 0;
    }, [instrumentEff]);

    React.useEffect(() => {
    try {
       setError('');
       const gross = parseFloat(grossCpm);
       const bkg = parseFloat(backgroundCpm);
       const eff = parseFloat(instrumentEff);

       if (isNaN(gross) || isNaN(bkg) || isNaN(eff)) { setResult(null); return; }
       if (gross < bkg) throw new Error("Gross < Background.");

       const netCpm = gross - bkg;
       const act_uCi = (netCpm / (eff/100)) / 2.22e6;
       const pass = act_uCi < LIMIT_UCI;

       setResult({ activity: act_uCi.toExponential(2), pass, netCpm: netCpm.toFixed(0) });
    } catch (e) { setError(e.message); setResult(null); }
    }, [grossCpm, backgroundCpm, instrumentEff, setResult, setError]);

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'Leak Test', icon: ICONS.check, inputs: `Gross: ${grossCpm}, Bkg: ${backgroundCpm}`, result: `${result.activity} µCi`, view: VIEWS.OPERATIONAL_HP });
            addToast("Saved!");
        }
    };

    return (
    <div className="space-y-4 max-w-md mx-auto">
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div className="grid grid-cols-2 gap-4">
               <div><label className="block text-sm font-medium">Gross CPM</label><input type="number" value={grossCpm} onChange={e => setGrossCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div><label className="block text-sm font-medium">Bkg CPM</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           </div>
           <div><label className="block text-sm font-medium">Efficiency (%)</label><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           
           {/* Visual Action Level Indicator */}
           <div className="p-2 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-100 dark:border-blue-800 text-center">
               <p className="text-xs text-blue-800 dark:text-blue-200">Action Level (0.005 µCi): <strong>{actionLevelNetCpm} Net CPM</strong></p>
           </div>
       </div>

       {result && (
           <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${result.pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
               <div className="flex justify-between items-center -mt-2">
                   <div></div>
                   <p className={`text-3xl font-extrabold ${result.pass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{result.pass ? 'PASS' : 'FAIL'}</p>
                   <button onClick={handleSaveToHistory}><Icon path={ICONS.notepad} className="w-5 h-5 text-slate-500"/></button>
               </div>
               <p className="text-xl font-bold">{result.activity} µCi</p>
               <p className="text-xs font-mono">Net: {result.netCpm} cpm</p>
           </div>
       )}
    </div>
    );
};

const OperationalHPCalculators = ({ radionuclides, initialTab }) => {
    const [activeCalculator, setActiveCalculator] = React.useState(initialTab || 'surfaceContam');
    const { settings } = React.useContext(SettingsContext);
    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq'] : ['pCi', 'nCi', 'µCi', 'mCi', 'Ci'], [settings.unitSystem]);

    // Lifted State for Surface Contam
    const [sc_nuclideSymbol, setSc_nuclideSymbol] = React.useState('');
    const [sc_staticData, setSc_staticData] = React.useState('');
    const [sc_wipeGrossCpm, setSc_wipeGrossCpm] = React.useState('150');
    const [sc_wipeBackgroundCpm, setSc_wipeBackgroundCpm] = React.useState('50');
    const [sc_instrumentEff, setSc_instrumentEff] = React.useState('25');
    const [sc_smearEff, setSc_smearEff] = React.useState('0.1');
    const [sc_probeArea, setSc_probeArea] = React.useState('15'); // Default to Pancake (15 cm2)
    const [sc_result, setSc_result] = React.useState(null);
    const [sc_error, setSc_error] = React.useState('');

    // State for Leak Test
    const [lt_grossCpm, setLt_grossCpm] = React.useState(() => localStorage.getItem('leakTest_grossCpm') || '150');
    const [lt_backgroundCpm, setLt_backgroundCpm] = React.useState(() => localStorage.getItem('leakTest_backgroundCpm') || '50');
    const [lt_instrumentEff, setLt_instrumentEff] = React.useState(() => localStorage.getItem('leakTest_instrumentEff') || '25');
    const [lt_result, setLt_result] = React.useState(null);
    const [lt_error, setLt_error] = React.useState('');

    // State for Airborne
    const [ac_nuclideSymbol, setAc_nuclideSymbol] = React.useState('');
    const [ac_releaseActivity, setAc_releaseActivity] = React.useState('1');
    const [ac_activityUnit, setAc_activityUnit] = React.useState(activityUnits[0]);
    const [ac_roomVolume, setAc_roomVolume] = React.useState('100');
    const [ac_volumeUnit, setAc_volumeUnit] = React.useState('m³');
    const [ac_ventilationRate, setAc_ventilationRate] = React.useState('2');
    const [ac_result, setAc_result] = React.useState(null);
    const [ac_error, setAc_error] = React.useState('');

    // State for Detector Response
    const [resp_nuclideSymbol, setResp_nuclideSymbol] = React.useState('');
    const [resp_activity, setResp_activity] = React.useState('1');
    const [resp_activityUnit, setResp_activityUnit] = React.useState('µCi');
    const [resp_distance, setResp_distance] = React.useState('30');
    const [resp_distanceUnit, setResp_distanceUnit] = React.useState('cm');
    const [resp_detectorType, setResp_detectorType] = React.useState('nai_2x2');
    const [resp_shieldMaterial, setResp_shieldMaterial] = React.useState('None');
    const [resp_shieldThickness, setResp_shieldThickness] = React.useState('1');
    const [resp_shieldThicknessUnit, setResp_shieldThicknessUnit] = React.useState('cm');
    const [resp_surfaceEff, setResp_surfaceEff] = React.useState('100'); 
    const [resp_result, setResp_result] = React.useState(null);
    const [resp_error, setResp_error] = React.useState('');

    // Full Clear Handler
    const handleClear = () => {
        if(activeCalculator === 'surfaceContam') { 
            setSc_nuclideSymbol(''); 
            setSc_staticData(''); 
            setSc_wipeGrossCpm('150');
            setSc_wipeBackgroundCpm('50');
            setSc_instrumentEff('25');
            setSc_smearEff('0.1');
            setSc_probeArea('15');
            setSc_result(null); 
            setSc_error('');
        }
        if(activeCalculator === 'leakTest') { 
            setLt_grossCpm('150'); 
            setLt_backgroundCpm('50'); 
            setLt_instrumentEff('25');
            setLt_result(null); 
            setLt_error('');
        }
        if(activeCalculator === 'airborne') {
            setAc_nuclideSymbol(''); 
            setAc_releaseActivity('1'); 
            setAc_roomVolume('100'); 
            setAc_ventilationRate('2');
            setAc_result(null); 
            setAc_error('');
        }
        if(activeCalculator === 'response') {
            setResp_nuclideSymbol(''); 
            setResp_activity('1'); 
            setResp_distance('30'); 
            setResp_shieldMaterial('None'); 
            setResp_surfaceEff('100');
            setResp_result(null); 
            setResp_error('');
        }
    }

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Operational HP Calculators</h2>
                    <ClearButton onClick={handleClear} />
                </div>
                
                <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6">
                    <button onClick={() => setActiveCalculator('surfaceContam')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'surfaceContam' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Surface Contam.</button>
                    <button onClick={() => setActiveCalculator('leakTest')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'leakTest' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Leak Test</button>
                    <button onClick={() => setActiveCalculator('airborne')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'airborne' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Airborne</button>
                    <button onClick={() => setActiveCalculator('response')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeCalculator === 'response' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Detector Resp.</button>
                </div>

                <div className="mt-4">
                    {activeCalculator === 'surfaceContam' && <SurfaceContaminationCalculator 
                        radionuclides={radionuclides}
                        nuclideSymbol={sc_nuclideSymbol} setNuclideSymbol={setSc_nuclideSymbol}
                        staticData={sc_staticData} setStaticData={setSc_staticData}
                        wipeGrossCpm={sc_wipeGrossCpm} setWipeGrossCpm={setSc_wipeGrossCpm}
                        wipeBackgroundCpm={sc_wipeBackgroundCpm} setWipeBackgroundCpm={setSc_wipeBackgroundCpm}
                        instrumentEff={sc_instrumentEff} setInstrumentEff={setSc_instrumentEff}
                        smearEff={sc_smearEff} setSmearEff={setSc_smearEff}
                        probeArea={sc_probeArea} setProbeArea={setSc_probeArea}
                        result={sc_result} setResult={setSc_result}
                        error={sc_error} setError={setSc_error}
                    />}
                    {activeCalculator === 'leakTest' && <LeakTestCalculator 
                        grossCpm={lt_grossCpm} setGrossCpm={setLt_grossCpm}
                        backgroundCpm={lt_backgroundCpm} setBackgroundCpm={setLt_backgroundCpm}
                        instrumentEff={lt_instrumentEff} setInstrumentEff={setLt_instrumentEff}
                        result={lt_result} setResult={setLt_result}
                        error={lt_error} setError={setLt_error}
                    />}
                    {activeCalculator === 'airborne' && <AirborneCalculator 
                        radionuclides={radionuclides}
                        nuclideSymbol={ac_nuclideSymbol} setNuclideSymbol={setAc_nuclideSymbol}
                        releaseActivity={ac_releaseActivity} setReleaseActivity={setAc_releaseActivity}
                        activityUnit={ac_activityUnit} setActivityUnit={setAc_activityUnit} activityUnits={activityUnits}
                        roomVolume={ac_roomVolume} setRoomVolume={setAc_roomVolume}
                        volumeUnit={ac_volumeUnit} setVolumeUnit={setAc_volumeUnit}
                        ventilationRate={ac_ventilationRate} setVentilationRate={setAc_ventilationRate}
                        result={ac_result} setResult={setAc_result}
                        error={ac_error} setError={setAc_error}
                    />}
                    {activeCalculator === 'response' && <DetectorResponseCalculator 
                        radionuclides={radionuclides}
                        nuclideSymbol={resp_nuclideSymbol} setNuclideSymbol={setResp_nuclideSymbol}
                        activity={resp_activity} setActivity={setResp_activity}
                        activityUnit={resp_activityUnit} setActivityUnit={setResp_activityUnit}
                        distance={resp_distance} setDistance={setResp_distance}
                        distanceUnit={resp_distanceUnit} setDistanceUnit={setResp_distanceUnit}
                        detectorType={resp_detectorType} setDetectorType={setResp_detectorType}
                        shieldMaterial={resp_shieldMaterial} setShieldMaterial={setResp_shieldMaterial}
                        shieldThickness={resp_shieldThickness} setShieldThickness={setResp_shieldThickness}
                        shieldThicknessUnit={resp_shieldThicknessUnit} setShieldThicknessUnit={setResp_shieldThicknessUnit}
                        surfaceEff={resp_surfaceEff} setSurfaceEff={setResp_surfaceEff}
                        result={resp_result} setResult={setResp_result}
                        error={resp_error} setError={setResp_error}
                    />}
                </div>
            </div>
        </div>
    );
};

             /**
              * @description A calculator to determine radioactive material shipping classification (Excepted, Type A, Type B)
              * based on the nuclide, activity, and form, according to DOT/IAEA A1/A2 values.
              */
       
const TransportationCalculator = ({ radionuclides, preselectedNuclide }) => {
    // --- 1. CONTEXT & DYNAMIC UNITS ---
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    const activityUnits = React.useMemo(() =>
        settings.unitSystem === 'si'
            ? ['Bq', 'kBq', 'MBq', 'GBq', 'TBq']
            : ['µCi', 'mCi', 'Ci'],
        [settings.unitSystem]
    );

    // --- 2. STATE MANAGEMENT ---
    const [selectedSymbol, setSelectedSymbol] = React.useState('');
    const [formType, setFormType] = React.useState('A2'); // A1 (Special) or A2 (Normal)
    const [physicalState, setPhysicalState] = React.useState('solid'); // NEW: solid, liquid, gas
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState(() => activityUnits[activityUnits.length - 1]); 
    
    // Label Estimation
    const [doseRateAt1m, setDoseRateAt1m] = React.useState('');
    const [doseRateUnit, setDoseRateUnit] = React.useState('mrem/hr');
    const [surfaceDoseRate, setSurfaceDoseRate] = React.useState('');
    const [surfaceDoseRateUnit, setSurfaceDoseRateUnit] = React.useState('mrem/hr');

    const [result, setResult] = React.useState(null);
    const [labelResult, setLabelResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // --- 3. useEffect HOOKS ---
    React.useEffect(() => {
        if (!activityUnits.includes(activityUnit)) {
            setActivityUnit(activityUnits[activityUnits.length - 1]);
        }
    }, [activityUnits, activityUnit]);

    const transportNuclides = React.useMemo(() =>
        radionuclides.filter(n => 
            n.shipping && 
            n.shipping.A1 !== undefined && n.shipping.A1 !== null &&
            n.shipping.A2 !== undefined && n.shipping.A2 !== null
        ).sort((a, b) => a.name.localeCompare(b.name)),
        [radionuclides]
    );

    const selectedNuclide = React.useMemo(() =>
        transportNuclides.find(n => n.symbol === selectedSymbol),
        [selectedSymbol, transportNuclides]
    );

    React.useEffect(() => {
        if (preselectedNuclide && transportNuclides.some(n => n.symbol === preselectedNuclide)) {
            setSelectedSymbol(preselectedNuclide);
        }
    }, [preselectedNuclide, transportNuclides]);

    // --- 4. DATA, FACTORS, & CALCULATION ---
    const activityFactorsTBq = {
        'TBq': 1, 'GBq': 0.001, 'MBq': 1e-6, 'kBq': 1e-9, 'Bq': 1e-12,
        'Ci': 0.037, 'mCi': 3.7e-5, 'µCi': 3.7e-8
    };

    const toMremHr = (val, unit) => {
        if (unit === 'mrem/hr') return val;
        if (unit === 'rem/hr') return val * 1000;
        if (unit === 'mSv/hr') return val * 100;
        if (unit === 'µSv/hr') return val * 0.1;
        return 0;
    };

    const resultStyles = {
        EXCEPTED: { container: 'bg-green-100 dark:bg-green-900/50', title: 'text-green-600 dark:text-green-400', display: 'Excepted Package' },
        TYPE_A: { container: 'bg-sky-100 dark:bg-sky-900/50', title: 'text-sky-600 dark:text-sky-400', display: 'Type A Package' },
        TYPE_B: { container: 'bg-amber-100 dark:bg-amber-900/50', title: 'text-amber-600 dark:text-amber-400', display: 'Type B Package' },
        HRCQ: { container: 'bg-red-100 dark:bg-red-900/50', title: 'text-red-600 dark:text-red-400', display: 'HRCQ (Type B)' }
    };

    // Main Effect for Package Type
    React.useEffect(() => {
        if (!selectedNuclide) { setResult(null); setError(''); return; }
        
        const activityValue = parseFloat(activity);
        if (isNaN(activityValue) || activityValue < 0) {
            setError('Please enter a valid, non-negative activity.');
            setResult(null); return;
        }
        setError('');
        
        const userActivityTBq = activityValue * activityFactorsTBq[activityUnit];
        let rawLimit = selectedNuclide.shipping[formType]; // A1 or A2
        let limitTBq = 0;
        let isUnlimited = false;

        if (typeof rawLimit === 'string' && rawLimit.toLowerCase().includes('unlimited')) {
            limitTBq = Infinity;
            isUnlimited = true;
        } else {
            limitTBq = parseFloat(rawLimit);
        }

        if (limitTBq === null || isNaN(limitTBq)) {
            setError(`An A-value for ${formType} is not defined for this nuclide.`);
            setResult(null);
            return;
        }

        // Determine Excepted Package Multiplier (49 CFR 173.425 Table 4)
        // Solid: 10^-3, Liquid: 10^-4, Gas: 10^-3 (Simplified, Tritium is 2e-2 but keeping generic)
        let exceptedMultiplier = 1e-3; 
        if (physicalState === 'liquid') exceptedMultiplier = 1e-4;
        
        const exceptedLimitTBq = limitTBq === Infinity ? Infinity : exceptedMultiplier * limitTBq;
        
        // HRCQ Threshold: > 3000 * A1/A2 OR > 1000 TBq (27,000 Ci), whichever is less.
        const hrcqActivityThreshold = Math.min(3000 * limitTBq, 1000); 

        let classification = '';
        if (userActivityTBq <= exceptedLimitTBq) {
            classification = 'EXCEPTED';
        } else if (userActivityTBq <= limitTBq) {
            classification = 'TYPE_A';
        } else {
            // Check for HRCQ
            if (userActivityTBq > hrcqActivityThreshold) {
                classification = 'HRCQ';
            } else {
                classification = 'TYPE_B';
            }
        }

        let ansiCategory = null;
        if (selectedNuclide.dValue) {
            ansiCategory = calculateAnsiCategory(userActivityTBq, selectedNuclide.dValue);
        }

        // Output Formatting
        const isSI = settings.unitSystem === 'si';
        const displayUnit = isSI ? 'TBq' : 'Ci';
        const conversionFactor = isSI ? 1 : (1 / 0.037); // approx 27.027 Ci/TBq

        let activityDisplay, limitDisplay, exceptedDisplay;

        if (isSI) {
            activityDisplay = `${userActivityTBq.toExponential(3)} TBq`;
        } else {
            const valCi = userActivityTBq * conversionFactor;
            activityDisplay = `${valCi.toExponential(3)} Ci`;
        }

        if (isUnlimited) {
            limitDisplay = 'Unlimited';
            exceptedDisplay = 'Unlimited';
        } else {
            const limitVal = limitTBq * conversionFactor;
            const exceptedVal = exceptedLimitTBq * conversionFactor;
            limitDisplay = `${limitVal.toPrecision(3)} ${displayUnit}`;
            exceptedDisplay = `${exceptedVal.toExponential(3)} ${displayUnit}`;
        }

        setResult({
            classification,
            ansiCategory,
            activityDisplay,
            limitDisplay,
            exceptedDisplay,
            displayUnit
        });
    }, [selectedNuclide, formType, physicalState, activity, activityUnit, settings.unitSystem]);

    // Secondary Effect for Label Estimation
    React.useEffect(() => {
        if (!doseRateAt1m && !surfaceDoseRate) {
            setLabelResult(null);
            return;
        }

        const rate1m = parseFloat(doseRateAt1m);
        const rateSurface = parseFloat(surfaceDoseRate);
        
        let TI = 0;
        if (!isNaN(rate1m) && rate1m > 0) {
            let mremAt1m = toMremHr(rate1m, doseRateUnit);
            // TI Rule: Round up to next tenth. If <= 0.05, TI = 0.
            if (mremAt1m <= 0.05) {
                TI = 0;
            } else {
                TI = Math.ceil(mremAt1m * 10) / 10;
            }
        }

        let labelCategory = "Unknown";
        const surfMrem = !isNaN(rateSurface) ? toMremHr(rateSurface, surfaceDoseRateUnit) : 0;

        // Label Logic (49 CFR 172.403)
        // White-I: Surface <= 0.5, TI = 0
        // Yellow-II: Surface <= 50, TI <= 1
        // Yellow-III: Surface <= 200, TI <= 10
        // Exclusive Use: Surface > 200 OR TI > 10 (Max 1000 surface)
        
        if (surfMrem <= 0.5 && TI === 0) {
            labelCategory = "White-I";
        } else if (surfMrem <= 50 && TI <= 1) {
            labelCategory = "Yellow-II";
        } else if (surfMrem <= 200 && TI <= 10) {
            labelCategory = "Yellow-III";
        } else if (surfMrem > 200 || TI > 10) {
            labelCategory = "Yellow-III (Exclusive Use)";
        } else {
            labelCategory = "Check Limits"; 
        }

        setLabelResult({ TI, labelCategory });

    }, [doseRateAt1m, doseRateUnit, surfaceDoseRate, surfaceDoseRateUnit]);

    const handleClearInputs = () => {
        setSelectedSymbol('');
        setFormType('A2');
        setPhysicalState('solid');
        setActivity('1');
        setActivityUnit(activityUnits[activityUnits.length - 1]);
        setDoseRateAt1m('');
        setSurfaceDoseRate('');
        setResult(null);
        setLabelResult(null);
        setError('');
    };

    const handleSaveToHistory = () => {
        if (result && selectedNuclide) {
            const labelInfo = labelResult ? ` | ${labelResult.labelCategory} (TI: ${labelResult.TI})` : '';
            addHistory({
                id: Date.now(),
                type: 'Transportation',
                icon: ICONS.transport,
                inputs: `${activity} ${activityUnit} of ${selectedNuclide.symbol}`,
                result: `${result.classification.replace('_', ' ')}${labelInfo}`,
                view: VIEWS.TRANSPORTATION
            });
            addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Shipping Calculator</h2>
                    <ClearButton onClick={handleClearInputs} />
                </div>
                <div className="space-y-4">
                    <div>
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Radionuclide</label>
                        <div className="mt-1 min-h-[42px]">
                            {selectedNuclide ? (
                                <CalculatorNuclideInfo
                                    nuclide={selectedNuclide}
                                    onClear={() => setSelectedSymbol('')}
                                />
                            ) : (
                                <SearchableSelect
                                    options={transportNuclides}
                                    onSelect={(symbol) => { setSelectedSymbol(symbol); }}
                                    placeholder="Search for a radionuclide..."
                                />
                            )}
                        </div>
                    </div>
                    
                    {/* Classification Inputs */}
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                        <h3 className="font-bold text-sm text-slate-500 dark:text-slate-400 uppercase">Package Classification</h3>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium">Material Form</label>
                                <div className="mt-1 flex flex-col gap-1">
                                    <Tooltip text="Special Form: Non-dispersible solid material or an encapsulated source. Uses A1 limit.">
                                        <label className={`flex items-center justify-center p-2 text-xs font-semibold rounded-lg cursor-pointer ${formType === 'A1' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}><input type="radio" name="formType" value="A1" checked={formType === 'A1'} onChange={e => setFormType(e.target.value)} className="hidden" />Special (A1)</label>
                                    </Tooltip>
                                    <Tooltip text="Normal Form: Dispersible material (liquids, powders). Uses A2 limit.">
                                        <label className={`flex items-center justify-center p-2 text-xs font-semibold rounded-lg cursor-pointer ${formType === 'A2' ? 'bg-sky-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}><input type="radio" name="formType" value="A2" checked={formType === 'A2'} onChange={e => setFormType(e.target.value)} className="hidden" />Normal (A2)</label>
                                    </Tooltip>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Physical State</label>
                                <select 
                                    value={physicalState} 
                                    onChange={e => setPhysicalState(e.target.value)} 
                                    className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm"
                                >
                                    <option value="solid">Solid</option>
                                    <option value="liquid">Liquid</option>
                                    <option value="gas">Gas</option>
                                </select>
                                <p className="text-[10px] text-slate-500 mt-1">Affects Excepted Limits</p>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium">Source Activity</label>
                            <div className="flex">
                                <input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                                <select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">
                                    {activityUnits.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* TI / Label Estimation Inputs */}
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                        <h3 className="font-bold text-sm text-slate-500 dark:text-slate-400 uppercase">Label Estimation (Optional)</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium">Max Dose Rate @ 1m</label>
                                <div className="flex">
                                    <input type="number" value={doseRateAt1m} onChange={e => setDoseRateAt1m(e.target.value)} placeholder="0" className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700 text-sm" />
                                    <select value={doseRateUnit} onChange={e => setDoseRateUnit(e.target.value)} className="mt-1 p-1 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">
                                        <option value="mrem/hr">mrem/h</option>
                                        <option value="mSv/hr">mSv/h</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-medium">Max Surface Dose Rate</label>
                                <div className="flex">
                                    <input type="number" value={surfaceDoseRate} onChange={e => setSurfaceDoseRate(e.target.value)} placeholder="0" className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700 text-sm" />
                                    <select value={surfaceDoseRateUnit} onChange={e => setSurfaceDoseRateUnit(e.target.value)} className="mt-1 p-1 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">
                                        <option value="mrem/hr">mrem/h</option>
                                        <option value="mSv/hr">mSv/h</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    {error && <p className="text-red-500 text-sm text-center pt-2">{error}</p>}

                    {result && (
                        <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.classification].container}`}>
                            <div className="flex justify-between items-center -mt-2 mb-2">
                                <div></div>
                                <p className={`text-2xl font-extrabold ${resultStyles[result.classification].title}`}>{resultStyles[result.classification].display}</p>
                                <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                                    <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                        <Icon path={ICONS.notepad} className="w-5 h-5" />
                                    </button>
                                </Tooltip>
                            </div>
                            
                            {/* TI & Label Result */}
                            {labelResult && (
                                <div className="mb-3 p-2 bg-white/50 dark:bg-black/20 rounded-lg">
                                    <div className="grid grid-cols-2 divide-x divide-slate-300 dark:divide-slate-600">
                                        <div>
                                            <p className="text-xs font-semibold text-slate-500 dark:text-slate-300">Transport Index (TI)</p>
                                            <p className="text-xl font-bold">{labelResult.TI.toFixed(1)}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-slate-500 dark:text-slate-300">Est. Label</p>
                                            <p className="text-xl font-bold">{labelResult.labelCategory}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="mt-2 pt-2 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-xs text-left">
                                <p>Activity:</p><p className="font-mono text-right">{result.activityDisplay}</p>
                                <p>{formType} Limit:</p><p className="font-mono text-right">{result.limitDisplay}</p>
                                <p>Excepted Limit:</p><p className="font-mono text-right">≤ {result.exceptedDisplay}</p>
                            </div>

                            {/* --- ANSI CATEGORY DISPLAY --- */}
                            {result.ansiCategory && (
                                <div className="mt-2 pt-2 border-t border-slate-300 dark:border-slate-600">
                                    <p className="font-semibold text-xs text-slate-500 dark:text-slate-400">ANSI/HPS N43.6 Category</p>
                                    <p className="text-lg font-bold text-slate-700 dark:text-slate-200">Category {result.ansiCategory.category}</p>
                                    <p className="text-[10px] text-slate-500 dark:text-slate-400">({result.ansiCategory.description})</p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};
         
              /**
              * @description React component acting as a container for various medical physics tools.
              * This component provides a tabbed interface to switch between different calculators
              * and utilities relevant to medical and hospital-based radiation safety.
              *
              * It manages the state for each sub-calculator independently and conditionally
              * renders the active tool based on the user's tab selection.
              *
              * The included tools are:
              * 1.  **X-Ray Shielding Calculator:** Used to determine the required shielding thickness for an X-ray room based on workload, distance, and other factors.
              * 2.  **Patient Release Calculator:** Assists in determining if a patient who has received a radiopharmaceutical can be released from the hospital under regulatory guidelines (e.g., 10 CFR 35).
              *
              * This component centralizes multiple specialized tools into a single, cohesive user interface.
              *
              * @prop {array} radionuclides - A comprehensive array of radionuclide data used by the patient release calculator.
              */
              
const MedicalCalculator = ({ radionuclides }) => {
    const [activeTab, setActiveTab] = React.useState('xrayShielding');
    const { settings } = React.useContext(SettingsContext);

    // --- SHARED STATE & DATA ---
    // FIX: Defined locally to prevent "undefined" crashes
    const COMMON_THERAPY_ISOTOPES = ['I-131', 'Lu-177', 'Y-90', 'In-111', 'Tc-99m', 'Ra-223', 'Sm-153'];

    // State for XRayShieldingCalculator
    const [xray_kvp, setXray_kvp] = React.useState('100');
    const [xray_workload, setXray_workload] = React.useState('200');
    const [xray_useFactor, setXray_useFactor] = React.useState('1');
    const [xray_occupancyFactor, setXray_occupancyFactor] = React.useState('1');
    const [xray_distance, setXray_distance] = React.useState('2.1');
    const [xray_doseLimit, setXray_doseLimit] = React.useState('0.02');
    const [xray_shieldMaterial, setXray_shieldMaterial] = React.useState('Lead');
    const [xray_result, setXray_result] = React.useState(null);
    const [xray_error, setXray_error] = React.useState('');

    // State for PatientReleaseCalculator
    const [pr_nuclideSymbol, setPr_nuclideSymbol] = React.useState('');
    const [pr_activity, setPr_activity] = React.useState('30');
    const [pr_activityUnit, setPr_activityUnit] = React.useState(settings.unitSystem === 'si' ? 'GBq' : 'mCi');
    const [pr_occupancyFactor, setPr_occupancyFactor] = React.useState('0.25');
    const [pr_distance, setPr_distance] = React.useState('1');
    const [pr_attenuation, setPr_attenuation] = React.useState('0.8'); 
    const [pr_effectiveHalfLife, setPr_effectiveHalfLife] = React.useState('');
    const [pr_effectiveHalfLifeUnit, setPr_effectiveHalfLifeUnit] = React.useState('hours');
    const [pr_result, setPr_result] = React.useState(null);
    const [pr_error, setPr_error] = React.useState('');

    // NEW: State for DecayInStorageCalculator
    const [dis_nuclideSymbol, setDis_nuclideSymbol] = React.useState('');
    const [dis_currentRate, setDis_currentRate] = React.useState('5.0'); // mR/hr
    const [dis_limit, setDis_limit] = React.useState('0.02'); // Background
    const [dis_result, setDis_result] = React.useState(null);

    // Dynamic Units
    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['MBq', 'GBq', 'TBq'] : ['µCi', 'mCi', 'Ci'], [settings.unitSystem]);

    React.useEffect(() => {
        if (!activityUnits.includes(pr_activityUnit)) setPr_activityUnit(activityUnits[1]);
    }, [settings.unitSystem]);

    // Auto-set Attenuation for I-131
    React.useEffect(() => {
        if (pr_nuclideSymbol === 'I-131') {
            setPr_attenuation('0.8'); 
        } else {
            setPr_attenuation('1.0'); 
        }
    }, [pr_nuclideSymbol]);

    const handleClearActiveCalculator = () => {
        if (activeTab === 'xrayShielding') {
            setXray_kvp('100'); setXray_workload('200'); setXray_useFactor('1');
            setXray_occupancyFactor('1'); setXray_distance('2.1'); setXray_doseLimit('0.02');
            setXray_shieldMaterial('Lead'); setXray_result(null); setXray_error('');
        } else if (activeTab === 'patientRelease') {
            setPr_nuclideSymbol(''); setPr_activity('30'); 
            setPr_occupancyFactor('0.25'); setPr_distance('1'); setPr_attenuation('0.8');
            setPr_effectiveHalfLife(''); setPr_result(null); setPr_error('');
        } else if (activeTab === 'decayStorage') {
            setDis_nuclideSymbol(''); setDis_currentRate('5.0'); setDis_result(null);
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Medical Physics Tools</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                
                {/* 3-Way Navigation Tab */}
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg my-4 gap-1">
                    {['xrayShielding', 'patientRelease', 'decayStorage'].map(tab => (
                        <button key={tab} onClick={() => setActiveTab(tab)} 
                            className={`flex-1 p-2 rounded-md text-xs font-bold transition-colors uppercase ${activeTab === tab ? 'bg-white dark:bg-slate-800 text-sky-600 shadow-sm' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600'}`}>
                            {tab === 'xrayShielding' ? 'X-Ray' : tab === 'patientRelease' ? 'Pt Release' : 'Waste'}
                        </button>
                    ))}
                </div>

                {activeTab === 'xrayShielding' && <XRayShieldingCalculator
                    kvp={xray_kvp} setKvp={setXray_kvp}
                    workload={xray_workload} setWorkload={setXray_workload}
                    useFactor={xray_useFactor} setUseFactor={setXray_useFactor}
                    occupancyFactor={xray_occupancyFactor} setOccupancyFactor={setXray_occupancyFactor}
                    distance={xray_distance} setDistance={setXray_distance}
                    doseLimit={xray_doseLimit} setDoseLimit={setXray_doseLimit}
                    shieldMaterial={xray_shieldMaterial} setShieldMaterial={setXray_shieldMaterial}
                    result={xray_result} setResult={setXray_result}
                    error={xray_error} setError={setXray_error}
                />}
                
                {activeTab === 'patientRelease' && <PatientReleaseCalculator
                    radionuclides={radionuclides} therapyList={COMMON_THERAPY_ISOTOPES}
                    nuclideSymbol={pr_nuclideSymbol} setNuclideSymbol={setPr_nuclideSymbol}
                    activity={pr_activity} setActivity={setPr_activity}
                    activityUnit={pr_activityUnit} setActivityUnit={setPr_activityUnit}
                    activityUnits={activityUnits}
                    occupancyFactor={pr_occupancyFactor} setOccupancyFactor={setPr_occupancyFactor}
                    distance={pr_distance} setDistance={setPr_distance}
                    attenuation={pr_attenuation} setAttenuation={setPr_attenuation}
                    effectiveHalfLife={pr_effectiveHalfLife} setEffectiveHalfLife={setPr_effectiveHalfLife}
                    effectiveHalfLifeUnit={pr_effectiveHalfLifeUnit} setEffectiveHalfLifeUnit={setPr_effectiveHalfLifeUnit}
                    result={pr_result} setResult={setPr_result}
                    error={pr_error} setError={setPr_error}
                    settings={settings}
                />}

                {activeTab === 'decayStorage' && <DecayInStorageCalculator 
                    radionuclides={radionuclides}
                    nuclideSymbol={dis_nuclideSymbol} setNuclideSymbol={setDis_nuclideSymbol}
                    currentRate={dis_currentRate} setCurrentRate={setDis_currentRate}
                    limit={dis_limit} setLimit={setDis_limit}
                    result={dis_result} setResult={setDis_result}
                />}
            </div>
        </div>
    );
};

const XRayShieldingCalculator = ({ kvp, setKvp, workload, setWorkload, useFactor, setUseFactor, occupancyFactor, setOccupancyFactor, distance, setDistance, doseLimit, setDoseLimit, shieldMaterial, setShieldMaterial, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const TVL_DATA = { 
        'Lead': { 50: { TVL1: 0.06, TVLe: 0.17 }, 70: { TVL1: 0.15, TVLe: 0.25 }, 100: { TVL1: 0.25, TVLe: 0.35 }, 125: { TVL1: 0.27, TVLe: 0.38 }, 150: { TVL1: 0.29, TVLe: 0.41 } }, 
        'Concrete': { 50: { TVL1: 4.3, TVLe: 4.3 }, 70: { TVL1: 5.4, TVLe: 5.4 }, 100: { TVL1: 6.0, TVLe: 6.0 }, 125: { TVL1: 6.6, TVLe: 6.6 }, 150: { TVL1: 7.0, TVLe: 7.0 } }, 
        'Drywall': { 50: { TVL1: 1.8, TVLe: 1.8 }, 70: { TVL1: 2.5, TVLe: 2.5 }, 100: { TVL1: 3.5, TVLe: 3.5 }, 125: { TVL1: 4.2, TVLe: 4.2 }, 150: { TVL1: 4.8, TVLe: 4.8 } } 
    };

    const K_FACTORS = { 50: 3.5, 70: 5.0, 100: 7.5, 125: 10.0, 150: 13.0 };
    
    React.useEffect(() => {
        try {
            setError('');
            const W = parseFloat(workload); const U = parseFloat(useFactor); const T = parseFloat(occupancyFactor);
            const d = parseFloat(distance); const P = parseFloat(doseLimit);
            if ([W, U, T, d, P].some(isNaN) || W <= 0 || d <= 0) { throw new Error("All inputs must be valid, positive numbers."); }
            
            const K_output = K_FACTORS[kvp] || 5.0; 
            const K_unshielded = (K_output * W * U * T) / Math.pow(d, 2);
            const B = P / K_unshielded;

            if (B >= 1) { setResult({ thickness: 0, tvls: 0, transmission: '>1' }); return; }
            
            const n_tvl = -Math.log10(B);
            const { TVL1, TVLe } = TVL_DATA[shieldMaterial][kvp];
            const thickness = TVL1 + (n_tvl - 1) * TVLe;
            
            setResult({ transmission: B.toExponential(2), tvls: n_tvl.toFixed(2), thickness: thickness.toFixed(2), });
        } catch (e) { setResult(null); setError(e.message); }
    }, [kvp, workload, useFactor, occupancyFactor, distance, doseLimit, shieldMaterial, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'X-Ray Shielding', icon: ICONS.medical, inputs: `${workload} mA-min/wk @ ${kvp} kVp`, result: `${result.thickness} ${shieldMaterial === 'Lead' ? 'mm' : 'cm'}`, view: VIEWS.MEDICAL });
            addToast("Saved!");
        }
    };
    
    const useFactorOptions = [ { value: 1, label: '1 (Floors, full-time)' }, { value: 0.25, label: '1/4 (Doors, walls)' }, { value: 0.0625, label: '1/16 (Ceilings)' } ];
    const occupancyOptions = [ { value: 1, label: '1 (Offices, labs)' }, { value: 0.2, label: '1/5 (Corridors)' }, { value: 0.05, label: '1/20 (Restrooms)' }, { value: 0.025, label: '1/40 (Outdoors)' } ];
    const doseLimitOptions = [ { value: 0.1, label: '0.1 mGy/wk (Controlled)' }, { value: 0.02, label: '0.02 mGy/wk (Uncontrolled)' } ];
    
    return (
        <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-xs font-bold mb-1">Tube Potential</label><select value={kvp} onChange={e => setKvp(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm">{Object.keys(K_FACTORS).map(k => <option key={k} value={k}>{k} kVp</option>)}</select></div>
                <div><label className="block text-xs font-bold mb-1">Workload (mA-min/wk)</label><input type="number" value={workload} onChange={e => setWorkload(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
                <div><label className="block text-xs font-bold mb-1">Use Factor (U)</label><select value={useFactor} onChange={e => setUseFactor(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm">{useFactorOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
                <div><label className="block text-xs font-bold mb-1">Occupancy (T)</label><select value={occupancyFactor} onChange={e => setOccupancyFactor(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm">{occupancyOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
                <div><label className="block text-xs font-bold mb-1">Distance (m)</label><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
                <div><label className="block text-xs font-bold mb-1">Limit (Air Kerma)</label><select value={doseLimit} onChange={e => setDoseLimit(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm">{doseLimitOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
                <div className="md:col-span-2"><label className="block text-xs font-bold mb-1">Shield Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"><option value="Lead">Lead (mm)</option><option value="Concrete">Concrete (cm)</option><option value="Drywall">Drywall (cm)</option></select></div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in relative">
                    <div className="absolute top-2 right-2"><button onClick={handleSaveToHistory}><Icon path={ICONS.notepad} className="w-5 h-5 text-slate-400 hover:text-sky-500"/></button></div>
                    <p className="text-sm text-slate-500 uppercase font-bold">Required Shielding</p>
                    <p className="text-4xl font-extrabold text-sky-600 dark:text-sky-400 my-2">{result.thickness} <span className="text-xl text-slate-500">{shieldMaterial === 'Lead' ? 'mm' : 'cm'}</span></p>
                    <p className="text-xs text-slate-400">TVLs needed: {result.tvls}</p>
                </div>
            )}
        </div>
    );
};

const PatientReleaseCalculator = ({ radionuclides, therapyList, nuclideSymbol, setNuclideSymbol, activity, setActivity, activityUnit, setActivityUnit, activityUnits, occupancyFactor, setOccupancyFactor, distance, setDistance, attenuation, setAttenuation, effectiveHalfLife, setEffectiveHalfLife, effectiveHalfLifeUnit, setEffectiveHalfLifeUnit, result, setResult, error, setError, settings }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    // Limits
    const TEDE_LIMIT_MREM = 500; 
    const I131_ACTIVITY_LIMIT_MCI = 33; 
    const actToMci = { 'µCi': 1e-3, 'mCi': 1, 'Ci': 1000, 'MBq': 1/37, 'GBq': 1000/37, 'TBq': 1e6/37 };

    // FIX: Use passed therapyList to filter safely
    const therapyNuclides = React.useMemo(() => radionuclides.filter(n => therapyList.includes(n.symbol) && n.gammaConstant).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides, therapyList]);
    const selectedNuclide = React.useMemo(() => therapyNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, therapyNuclides]);

    React.useEffect(() => {
        if (!selectedNuclide) { setResult(null); return; }
        try {
            setError('');
            const A0_mCi = parseFloat(activity) * actToMci[activityUnit];
            if (isNaN(A0_mCi) || A0_mCi <= 0) throw new Error("Invalid activity.");

            // 1. Tier 1 Check
            if (selectedNuclide.symbol.includes('I-131') && A0_mCi <= I131_ACTIVITY_LIMIT_MCI) {
                setResult({ title: 'PASS (Tier 1)', pass: true, details: [`Activity ≤ ${I131_ACTIVITY_LIMIT_MCI} mCi. Release permitted.`] });
                return;
            }

            // 2. Calc Effective Half Life
            let T_half_hours_eff;
            const T_half_hours_phys = parseHalfLifeToSeconds(selectedNuclide.halfLife) / 3600;
            const effHL = parseFloat(effectiveHalfLife);
            
            if (!isNaN(effHL) && effHL > 0) {
                const factors = { 'hours': 1, 'days': 24 };
                T_half_hours_eff = effHL * factors[effectiveHalfLifeUnit];
                if (T_half_hours_eff > T_half_hours_phys) throw new Error("Effective T½ > Physical T½");
            } else { T_half_hours_eff = T_half_hours_phys; }

            // 3. Dose Calc
            const gamma_app = parseFloat(selectedNuclide.gammaConstant); // R·m²/hr·Ci
            const gamma_nureg = gamma_app * 10; // Convert to R·cm²/hr·mCi
            const d_cm = parseFloat(distance) * 100;
            const E = parseFloat(occupancyFactor);
            const att = parseFloat(attenuation);

            if ([d_cm, E, att].some(isNaN) || d_cm <= 0) throw new Error("Invalid inputs.");

            const rate_R_hr = (gamma_nureg * A0_mCi * att) / Math.pow(d_cm, 2);
            const total_dose_R = (rate_R_hr * E) * (T_half_hours_eff * 1.443);
            const dose_mrem = total_dose_R * 1000;
            
            setResult({
                title: dose_mrem <= TEDE_LIMIT_MREM ? 'PASS (Tier 2)' : 'FAIL',
                pass: dose_mrem <= TEDE_LIMIT_MREM,
                details: [`Total Dose: ${formatDoseValue(dose_mrem, 'dose', settings).value} ${formatDoseValue(dose_mrem, 'dose', settings).unit}`, `(Limit: 500 mrem)`],
                rawDose: dose_mrem
            });

        } catch (e) { setResult(null); setError(e.message); }
    }, [selectedNuclide, activity, activityUnit, occupancyFactor, distance, attenuation, effectiveHalfLife, effectiveHalfLifeUnit, settings.unitSystem]);

    const handleSave = () => {
        if (result && selectedNuclide) {
            addHistory({ id: Date.now(), type: 'Patient Release', icon: ICONS.medical, inputs: `${activity} ${activityUnit} ${selectedNuclide.symbol}`, result: result.title, view: VIEWS.MEDICAL });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <div><label className="text-xs font-bold mb-1 block">Isotope</label>{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> : <SearchableSelect options={therapyNuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide..." />}</div>
            <div className="grid grid-cols-2 gap-4">
                <div><label className="text-xs font-bold mb-1 block">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700 text-sm"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                <div><label className="text-xs font-bold mb-1 block">Occupancy (E)</label><input type="number" value={occupancyFactor} onChange={e => setOccupancyFactor(e.target.value)} step="0.05" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
            </div>
            <div className="grid grid-cols-2 gap-4">
                <div><label className="text-xs font-bold mb-1 block">Distance (m)</label><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
                <div><label className="text-xs font-bold mb-1 block">Attenuation</label><input type="number" value={attenuation} onChange={e => setAttenuation(e.target.value)} step="0.1" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className={`p-4 rounded-lg text-center mt-4 relative ${result.pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                    <div className="absolute top-2 right-2"><button onClick={handleSave}><Icon path={ICONS.notepad} className="w-5 h-5 text-slate-500 hover:text-black"/></button></div>
                    <p className={`text-2xl font-extrabold ${result.pass ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}`}>{result.title}</p>
                    <div className="mt-2 text-sm font-medium text-slate-700 dark:text-slate-300">{result.details.map((d,i) => <p key={i}>{d}</p>)}</div>
                </div>
            )}
        </div>
    );
};

// NEW: Missing Tool Added
const DecayInStorageCalculator = ({ radionuclides, nuclideSymbol, setNuclideSymbol, currentRate, setCurrentRate, limit, setLimit, result, setResult }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    React.useEffect(() => {
        const n = radionuclides?.find(r => r.symbol === nuclideSymbol);
        const R_curr = parseFloat(currentRate);
        const R_lim = parseFloat(limit);

        if (!n || isNaN(R_curr) || isNaN(R_lim) || R_curr <= R_lim) { 
            setResult(null); 
            if (R_curr <= R_lim && R_curr > 0) setResult({ days: 0, date: 'Now' });
            return; 
        }

        const hlSeconds = parseHalfLifeToSeconds(n.halfLife);
        const hlDays = hlSeconds / 86400;
        if (hlDays === 0) return;

        // Formula: T = -ln(R_lim/R_curr) / lambda
        const lambda = Math.log(2) / hlDays;
        const timeDays = -Math.log(R_lim / R_curr) / lambda;
        
        const releaseDate = new Date();
        releaseDate.setDate(releaseDate.getDate() + Math.ceil(timeDays));

        setResult({ days: Math.ceil(timeDays), date: releaseDate.toLocaleDateString(), hl: hlDays });
    }, [nuclideSymbol, currentRate, limit, radionuclides]);

    const handleSave = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'Waste Storage', icon: ICONS.trash, inputs: `${nuclideSymbol} @ ${currentRate} mR/hr`, result: `Hold ${result.days} days`, view: VIEWS.MEDICAL });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <div><label className="text-xs font-bold mb-1 block">Waste Isotope</label>{nuclideSymbol ? <CalculatorNuclideInfo nuclide={radionuclides.find(n => n.symbol === nuclideSymbol)} onClear={() => setNuclideSymbol('')} /> : <SearchableSelect options={radionuclides} onSelect={setNuclideSymbol} placeholder="Select nuclide..." />}</div>
            <div className="grid grid-cols-2 gap-4">
                <div><label className="text-xs font-bold mb-1 block">Current Rate (mR/hr)</label><input type="number" value={currentRate} onChange={e => setCurrentRate(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
                <div><label className="text-xs font-bold mb-1 block">Release Limit</label><input type="number" value={limit} onChange={e => setLimit(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
            </div>
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in relative">
                    <div className="absolute top-2 right-2"><button onClick={handleSave}><Icon path={ICONS.notepad} className="w-5 h-5 text-slate-400 hover:text-sky-500"/></button></div>
                    <p className="text-xs uppercase font-bold text-slate-500">Hold For</p>
                    <p className="text-4xl font-extrabold text-sky-600 dark:text-sky-400 my-1">{result.days} <span className="text-xl text-slate-500">Days</span></p>
                    <div className="mt-2 border-t border-slate-300 dark:border-slate-600 pt-2">
                        <p className="text-sm font-bold text-slate-700 dark:text-slate-200">Release Date: {result.date}</p>
                        <p className="text-xs text-slate-400">({(result.days / result.hl).toFixed(1)} Half-Lives)</p>
                    </div>
                </div>
            )}
        </div>
    );
};

/**
 * @description A component to display sortable and filterable data tables of all radionuclide emissions.
 */
const PeakDataTables = ({ radionuclides, onNuclideClick }) => {
    const [activeTable, setActiveTable] = React.useState('gamma');
    const [sortConfig, setSortConfig] = React.useState({ key: 'energyMeV', direction: 'ascending' });
    const [filterText, setFilterText] = React.useState('');
    
    const parseEnergy = React.useCallback((energyStr) => {
        if (!energyStr) return null;
        const energyRegex = /([\d.]+)\s*(MeV|keV)/i;
        const energyMatch = energyStr.match(energyRegex);
        if (!energyMatch) return null;
        let energyMeV = parseFloat(energyMatch[1]);
        if (energyMatch[2].toLowerCase() === 'kev') energyMeV /= 1000;
        return { energyMeV, displayEnergy: energyStr };
    }, []);
    
    const flattenedData = React.useMemo(() => {
        const data = { gamma: [], alpha: [], beta: [] };
        radionuclides.forEach(nuclide => {
            Object.keys(data).forEach(type => {
                nuclide.emissionEnergies?.[type]?.forEach(energyStr => {
                    const parsed = parseEnergy(energyStr);
                    if (parsed) data[type].push({ nuclideSymbol: nuclide.symbol, nuclideName: nuclide.name, category: nuclide.category, ...parsed });
                });
            });
            if (nuclide.daughterEmissions) {
                const daughterNuclide = radionuclides.find(n => n.symbol === nuclide.daughterEmissions.from);
                const daughterCategory = daughterNuclide ? daughterNuclide.category : 'N/A';
                Object.keys(data).forEach(type => {
                    nuclide.daughterEmissions?.[type]?.forEach(energyStr => {
                        const parsed = parseEnergy(energyStr);
                        if (parsed) {
                            const daughterName = `${nuclide.daughterEmissions.from} (from ${nuclide.symbol})`;
                            data[type].push({ nuclideSymbol: nuclide.daughterEmissions.from, nuclideName: daughterName, category: daughterCategory, ...parsed });
                        }
                    });
                });
            }
        });
        return data;
    }, [radionuclides, parseEnergy]);
    
    const sortedAndFilteredData = React.useMemo(() => {
        let dataToProcess = [...flattenedData[activeTable]];
        if (filterText) {
            dataToProcess = dataToProcess.filter(item => item.nuclideName.toLowerCase().includes(filterText.toLowerCase()));
        }
        if (sortConfig.key !== null) {
            dataToProcess.sort((a, b) => {
                const valA = a[sortConfig.key] || '';
                const valB = b[sortConfig.key] || '';
                if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                return 0;
            });
        }
        return dataToProcess;
    }, [flattenedData, activeTable, sortConfig, filterText]);
    
    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') direction = 'descending';
        setSortConfig({ key, direction });
    };
    
    const getSortIndicator = (key) => (sortConfig.key !== key ? '↕' : sortConfig.direction === 'ascending' ? '▲' : '▼');
    
    const handleExportCSV = () => {
        if (sortedAndFilteredData.length === 0) return;
        const headers = ['Nuclide', 'Energy', 'Category'];
        const rows = sortedAndFilteredData.map(item => [`"${item.nuclideName}"`, item.displayEnergy, item.category].join(','));
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", `${activeTable}_emissions_data.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    return (
        <div className="animate-fade-in">
            <div className="flex w-full p-1 bg-slate-100 dark:bg-slate-900/50 rounded-lg mb-4 border border-slate-200 dark:border-slate-700">
                {['alpha', 'beta', 'gamma'].map(type => (
                    <button key={type} onClick={() => setActiveTable(type)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors capitalize ${activeTable === type ? 'bg-white dark:bg-slate-700 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>
                        {type === 'gamma' ? 'γ' : type === 'beta' ? 'β' : 'α'} {type}
                    </button>
                ))}
            </div>
            
            <div className="flex justify-between items-center mb-2 gap-4">
                <div className="relative flex-grow">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Icon path={ICONS.search} className="w-4 h-4 text-slate-400" /></div>
                    <input type="text" placeholder={`Filter by nuclide name...`} value={filterText} onChange={(e) => setFilterText(e.target.value)} className="w-full p-2 pl-9 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm" />
                </div>
                <button onClick={handleExportCSV} className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2 flex-shrink-0">
                    <Icon path={ICONS.database} className="w-4 h-4" /> Export CSV
                </button>
            </div>
    
            <div className="overflow-y-auto max-h-[55vh] border border-slate-200 dark:border-slate-700 rounded-lg">
                <table className="w-full text-sm text-left">
                    <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0">
                        <tr>
                            <th className="p-3 cursor-pointer whitespace-nowrap" onClick={() => requestSort('nuclideName')}>Nuclide {getSortIndicator('nuclideName')}</th>
                            <th className="p-3 cursor-pointer whitespace-nowrap" onClick={() => requestSort('energyMeV')}>Energy {getSortIndicator('energyMeV')}</th>
                            <th className="p-3 cursor-pointer whitespace-nowrap" onClick={() => requestSort('category')}>Category {getSortIndicator('category')}</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                        {sortedAndFilteredData.map((item, index) => {
                            const categoryStyle = CATEGORY_STYLES[item.category] || CATEGORY_STYLES['default'];
                            const bgColor = categoryStyle.border.replace('border-l-', 'bg-').replace('-400', '-100').replace('-600', '-900/50');
                            const textColor = categoryStyle.border.replace('border-l-', 'text-').replace('-400', '-700').replace('-600', '-300');
    
                            return (
                                <tr key={`${item.nuclideSymbol}-${item.displayEnergy}-${index}`} className="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                    <td className="p-3 font-medium">
                                        <button onClick={() => { const nuclideToFind = radionuclides.find(n => n.symbol === item.nuclideSymbol); if (nuclideToFind) onNuclideClick(nuclideToFind);}} className="text-sky-600 dark:text-sky-400 hover:underline">
                                            {item.nuclideName}
                                        </button>
                                    </td>
                                    <td className="p-3 font-mono">{item.displayEnergy}</td>
                                    <td className="p-3"><span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${bgColor} ${textColor}`}>{item.category || 'N/A'}</span></td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

/**
 * @description Integrated Peak Identifier module. Combines a smart search tool (with fingerprinting) and data tables.
 */
const PeakIdentifier = ({ radionuclides, onNuclideClick }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const [peakIdMode, setPeakIdMode] = React.useState('search'); 
    
    // Search Tool State
    const [searchEnergy, setSearchEnergy] = React.useState('');
    const [resolution, setResolution] = React.useState('low'); // 'high' (HPGe) or 'low' (NaI)
    const [minYield, setMinYield] = React.useState('1');
    const [matches, setMatches] = React.useState([]);
    const [analysis, setAnalysis] = React.useState(null);

    // --- LIBRARY GENERATION (Integrated) ---
    const PEAK_LIBRARY = React.useMemo(() => {
        const lib = [];
        // A. Ingest from DB
        if (radionuclides) {
            radionuclides.forEach(n => {
                if (n.gammaPeaks) {
                    n.gammaPeaks.forEach(p => {
                        lib.push({ symbol: n.symbol, name: n.name, energy: p.energy, yield: p.yield, confirm: null });
                    });
                }
            });
        }
        // B. Fallback/Enrichment
        const COMMON_ISOTOPES = [
            { symbol: 'Cs-137', name: 'Cesium-137', energy: 661.7, yield: 85.1, confirm: 'Single Peak' },
            { symbol: 'Co-60', name: 'Cobalt-60', energy: 1173.2, yield: 99.8, confirm: 'Look for 1332.5 keV' },
            { symbol: 'Co-60', name: 'Cobalt-60', energy: 1332.5, yield: 99.9, confirm: 'Look for 1173.2 keV' },
            { symbol: 'Am-241', name: 'Americium-241', energy: 59.5, yield: 35.9, confirm: 'Check for Alpha' },
            { symbol: 'I-131', name: 'Iodine-131', energy: 364.5, yield: 81.2, confirm: 'Look for 284, 637 keV' },
            { symbol: 'Tc-99m', name: 'Technetium-99m', energy: 140.5, yield: 89.0, confirm: 'Medical Short-lived' },
            { symbol: 'K-40', name: 'Potassium-40', energy: 1460.8, yield: 10.7, confirm: 'Background NORM' },
            { symbol: 'Ra-226', name: 'Radium-226', energy: 186.2, yield: 3.6, confirm: 'Check for 351, 609 keV' },
            { symbol: 'U-235', name: 'Uranium-235', energy: 185.7, yield: 57.2, confirm: 'Look for 143, 163, 205 keV' },
            { symbol: 'Ir-192', name: 'Iridium-192', energy: 316.5, yield: 82.7, confirm: 'Look for 468, 308 keV' },
            { symbol: 'Ir-192', name: 'Iridium-192', energy: 468.1, yield: 47.8, confirm: 'Look for 316, 308 keV' },
        ];
        
        COMMON_ISOTOPES.forEach(iso => {
            const exists = lib.some(l => l.symbol === iso.symbol && Math.abs(l.energy - iso.energy) < 1);
            if (!exists) lib.push(iso);
            else {
                const match = lib.find(l => l.symbol === iso.symbol && Math.abs(l.energy - iso.energy) < 1);
                if(match && !match.confirm) match.confirm = iso.confirm;
            }
        });
        return lib;
    }, [radionuclides]);

    const LEAD_XRAYS = [
        { name: 'Pb K-α2', energy: 72.80 },
        { name: 'Pb K-α1', energy: 74.97 },
        { name: 'Pb K-β3', energy: 84.45 },
        { name: 'Pb K-β1', energy: 84.94 },
        { name: 'Pb K-β2', energy: 87.36 },
    ];

    // --- SEARCH LOGIC ---
    React.useEffect(() => {
        const energyVal = parseFloat(searchEnergy);
        if (!searchEnergy || isNaN(energyVal)) { setMatches([]); setAnalysis(null); return; }

        let tolerance = resolution === 'high' ? Math.max(2.0, energyVal * 0.01) : Math.max(20.0, energyVal * 0.07);
        const yieldCutoff = parseFloat(minYield) || 0;

        const results = PEAK_LIBRARY.filter(iso => {
            const delta = Math.abs(iso.energy - energyVal);
            return delta <= tolerance && iso.yield >= yieldCutoff;
        });

        results.sort((a, b) => {
            if (Math.abs(b.yield - a.yield) > 20) return b.yield - a.yield; 
            return Math.abs(a.energy - energyVal) - Math.abs(b.energy - energyVal);
        });

        setMatches(results);

        // Analyze artifacts
        const targetMeV = energyVal / 1000;
        const mc2 = 0.511;
        const comptonEdge = targetMeV / (1 + (mc2 / (2 * targetMeV)));
        const singleEscape = targetMeV > 1.022 ? targetMeV - 0.511 : null;
        const doubleEscape = targetMeV > 1.022 ? targetMeV - 1.022 : null;
        const leadXrayMatch = LEAD_XRAYS.find(xray => Math.abs(xray.energy - energyVal) <= tolerance);

        setAnalysis({
            comptonEdge: (comptonEdge * 1000).toFixed(1), // Convert back to keV for display if preferred, or keep MeV
            singleEscape: singleEscape ? (singleEscape * 1000).toFixed(1) : null,
            doubleEscape: doubleEscape ? (doubleEscape * 1000).toFixed(1) : null,
            isLeadXray: leadXrayMatch ? leadXrayMatch.name : null,
        });

    }, [searchEnergy, resolution, minYield, PEAK_LIBRARY]);

    const handleSave = () => {
        if (matches.length > 0) {
            addHistory({ id: Date.now(), type: 'Peak ID', icon: ICONS.gammaSpec, inputs: `${searchEnergy} keV (${resolution})`, result: `Match: ${matches[0].symbol}`, view: VIEWS.GAMMA_SPEC });
            addToast("Saved!");
        }
    };

    const handleClearInputs = () => {
        setSearchEnergy(''); setResolution('low'); setMinYield('1'); setMatches([]); setAnalysis(null);
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Peak Identifier</h2>
                    <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                        <Icon path={ICONS.clear} className="w-3 h-3"/> Clear
                    </button>
                </div>
                
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setPeakIdMode('search')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${peakIdMode === 'search' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Search</button>
                    <button onClick={() => setPeakIdMode('tables')} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${peakIdMode === 'tables' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Data Tables</button>
                </div>

                {peakIdMode === 'search' ? (
                    <div className="animate-fade-in">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="block text-sm font-medium">Peak Energy (keV)</label><input type="number" value={searchEnergy} onChange={e => setSearchEnergy(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-bold text-lg" autoFocus/></div>
                            <div className="grid grid-cols-2 gap-2">
                                <div><label className="block text-sm font-medium">Min Yield %</label><input type="number" value={minYield} onChange={e => setMinYield(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                                <div><label className="block text-sm font-medium">Detector</label><select value={resolution} onChange={e => setResolution(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="low">NaI (Low)</option><option value="high">HPGe (High)</option></select></div>
                            </div>
                        </div>

                        {analysis && ( 
                            <div className="mb-6 p-4 bg-slate-100 dark:bg-slate-700/50 rounded-lg">
                                <h3 className="text-xs font-bold text-slate-500 uppercase mb-2">Artifact Analysis</h3>
                                <div className="grid grid-cols-3 gap-2 text-center text-sm">
                                    <div><p className="text-xs text-slate-400">Compton Edge</p><p className="font-mono">{analysis.comptonEdge} keV</p></div>
                                    {analysis.singleEscape && <div><p className="text-xs text-slate-400">Single Esc.</p><p className="font-mono">{analysis.singleEscape} keV</p></div>}
                                    {analysis.doubleEscape && <div><p className="text-xs text-slate-400">Double Esc.</p><p className="font-mono">{analysis.doubleEscape} keV</p></div>}
                                </div>
                                {analysis.isLeadXray && <p className="mt-2 text-xs font-bold text-amber-600 text-center">Consistent with {analysis.isLeadXray} X-ray (Shielding)</p>}
                            </div> 
                        )}

                        <div className="space-y-2 max-h-[300px] overflow-y-auto">
                            {matches.length > 0 ? (
                                matches.map((m, idx) => (
                                    <div key={idx} onClick={() => { if(m.symbol) { const n = radionuclides.find(r => r.symbol === m.symbol); if(n) onNuclideClick(n); } }} className="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg hover:bg-white dark:hover:bg-slate-800 border border-transparent hover:border-sky-200 cursor-pointer transition-all">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="font-bold text-sky-600 dark:text-sky-400">{m.name} ({m.symbol})</p>
                                                <div className="flex gap-2 text-xs mt-1">
                                                    <span className="font-mono font-semibold text-slate-700 dark:text-slate-200">{m.energy.toFixed(1)} keV</span>
                                                    <span className="bg-slate-200 dark:bg-slate-600 px-1 rounded text-slate-600 dark:text-slate-300">Y: {m.yield}%</span>
                                                </div>
                                                {m.confirm && <p className="text-xs text-amber-600 mt-1 italic"><Icon path={ICONS.gammaSpec} className="w-3 h-3 inline mr-1"/>{m.confirm}</p>}
                                            </div>
                                            <span className={`text-xs px-2 py-1 rounded-full font-bold ${Math.abs(m.energy - parseFloat(searchEnergy)) < 1 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>Δ {Math.abs(m.energy - parseFloat(searchEnergy)).toFixed(1)}</span>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <p className="text-center text-slate-400 py-4">{searchEnergy ? "No matches found." : "Enter energy to search."}</p>
                            )}
                        </div>
                        {matches.length > 0 && <div className="mt-4 flex justify-center"><button onClick={handleSave} className="text-sm font-bold text-sky-600 hover:text-sky-700 flex items-center gap-1"><Icon path={ICONS.notepad} className="w-4 h-4"/> Save Top Match</button></div>}
                    </div>
                ) : (
                    <PeakDataTables radionuclides={radionuclides} onNuclideClick={onNuclideClick} />
                )}
            </div>
        </div>
    );
};

              /**
               * @description A calculator that uses the Bateman equations to model the activity of every
               * nuclide in a full decay series over time.
               * @param {{radionuclides: Array<object>, decaySeriesData: Array<object>}} props
               */
              
const DecaySeriesCalculator = ({ radionuclides, decaySeriesData, theme, onNuclideClick }) => {
    const { settings } = React.useContext(SettingsContext);
    const [selectedSeriesId, setSelectedSeriesId] = React.useState(decaySeriesData[0].id);
    const [initialActivity, setInitialActivity] = React.useState('100');
    
    // Improved Defaults: Detect scale of series
    const [timeElapsed, setTimeElapsed] = React.useState('100'); 
    const [timeUnit, setTimeUnit] = React.useState('years'); 

    const [results, setResults] = React.useState([]);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');
    const [isLoading, setIsLoading] = React.useState(false);
    
    // Persist log scale preference
    const [useLogScale, setUseLogScale] = React.useState(() => {
        const saved = localStorage.getItem('series_useLogScale');
        return saved ? JSON.parse(saved) : (settings.chartScale === 'Logarithmic');
    });

    React.useEffect(() => {
        localStorage.setItem('series_useLogScale', JSON.stringify(useLogScale));
    }, [useLogScale]);

    // Smart Defaults when Series Changes
    React.useEffect(() => {
        const series = decaySeriesData.find(s => s.id === selectedSeriesId);
        if (series) {
            // Check the half-life of the parent to guess a good time scale
            const parent = radionuclides.find(r => r.name === series.startNuclide || r.symbol === series.startNuclide);
            if (parent) {
                const seconds = parseHalfLifeToSeconds(parent.halfLife);
                // If > 1 million years, set default to 1000 years (short term) or 1 billion (secular)?
                // Let's stick to a human-scale default but adjust units if it's very short.
                if (seconds < 86400) { setTimeElapsed('24'); setTimeUnit('hours'); }
                else if (seconds < 3.15e7) { setTimeElapsed('100'); setTimeUnit('days'); }
                else { setTimeElapsed('50'); setTimeUnit('years'); }
            }
        }
    }, [selectedSeriesId, radionuclides]);

    const timeUnits = longTimeUnits_ordered;
    const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600, 'kiloyears': 31557600 * 1e3, 'megayears': 31557600 * 1e6, 'gigayears': 31557600 * 1e9 };

    const handleRowClick = (nuclideName) => {
        const found = radionuclides.find(n => n.name === nuclideName || n.symbol === nuclideName);
        if (found && onNuclideClick) {
            onNuclideClick(found);
        }
    };

    const handleCalculate = () => {
        const series = decaySeriesData.find(s => s.id === selectedSeriesId);
        if (!series) { setError('Please select a decay series.'); return; }
        const A0 = parseFloat(initialActivity);
        const t_input = parseFloat(timeElapsed);
        
        if (isNaN(A0) || A0 < 0 || isNaN(t_input) || t_input < 0) {
            setError('Initial activity and time must be non-negative numbers.');
            setResults([]); setChartData(null); return;
        }
        setError(''); setIsLoading(true);
        
        setTimeout(() => {
            try {
               const t_seconds = t_input * unitConversions[timeUnit];
               const flatChain = flattenChainForCalculator(series.chain);
               
               // 1. Calculate Single Point Result
               const calculatedActivities = runBatemanWithBranching(flatChain, A0, t_seconds);
               const finalResults = flatChain.map((step, i) => ({ 
                   name: step.nuclide, 
                   activity: calculatedActivities[i],
                   // Pass the half-life for visibility logic later
                   halfLifeSeconds: parseHalfLifeToSeconds(step.halfLife) 
               }));
               
               const totalActivityNow = calculatedActivities.reduce((a, b) => a + b, 0);
               
               setResults({ items: finalResults, total: totalActivityNow });

               // 2. Calculate Chart Data
               const chartLabels = [];
               const datasets = flatChain.map((step, i) => {
                   // --- IMPROVEMENT: Smart Visibility Logic ---
                   // Show if: 
                   // 1. It's the Parent (i===0)
                   // 2. It's the very last daughter
                   // 3. It has a half-life > 1 day (filter out short-lived noise)
                   const hl = parseHalfLifeToSeconds(step.halfLife);
                   const isImportant = i === 0 || i === flatChain.length - 1 || hl > 86400;

                   return {
                       label: step.nuclide, 
                       data: [],
                       borderColor: `hsl(${(i * 360 / Math.min(series.chain.length, 15)) % 360}, 70%, 50%)`,
                       borderWidth: 2, 
                       pointRadius: 0, 
                       tension: 0.4, 
                       hidden: !isImportant // Hide noise by default
                   };
               });

               const totalData = [];
               const steps = 100;
               
               // Determine plot range (Logarithmic time spacing looks better for long chains, 
               // but Linear is standard. Let's stick to Linear for consistency with inputs).
               
               for (let i = 0; i <= steps; i++) {
                   const timePoint = (t_input / steps) * i;
                   
                   // Format label to avoid long decimals
                   if (t_input > 10) chartLabels.push(Math.round(timePoint).toString());
                   else chartLabels.push(timePoint.toPrecision(2));

                   const timePoint_seconds = timePoint * unitConversions[timeUnit];
                   
                   const activitiesAtTimePoint = runBatemanWithBranching(flatChain, A0, timePoint_seconds);
                   
                   let sum = 0;
                   activitiesAtTimePoint.forEach((act, j) => { 
                       datasets[j].data.push(act); 
                       sum += act;
                   });
                   totalData.push(sum);
               }

               datasets.unshift({
                   label: 'Total Activity',
                   data: totalData,
                   borderColor: theme === 'dark' ? '#ffffff' : '#000000',
                   borderWidth: 3,
                   borderDash: [5, 5],
                   pointRadius: 0,
                   tension: 0.4,
                   order: 0
               });

               setChartData({ labels: chartLabels, datasets, timeUnit });

            } catch (e) {
               setError('An error occurred. Inputs may be too large or small for a stable result.');
               console.error(e);
            } finally {
               setIsLoading(false);
            }
        }, 50);
    };
    
    React.useEffect(() => {
        if (selectedSeriesId) { handleCalculate(); }
    }, [selectedSeriesId, initialActivity, timeElapsed, timeUnit]);
    
    const handleClearInputs = () => {
        setSelectedSeriesId(decaySeriesData[0].id);
        setInitialActivity('100');
        setTimeElapsed('100');
        setTimeUnit('years');
        setResults([]);
        setChartData(null);
        setError('');
        setIsLoading(false);
    };
    
    return (
        <div className="p-4 animate-fade-in">
        <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100">Decay Series Calculator (Bateman)</h2>
               <button onClick={handleClearInputs} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                   <Icon path={ICONS.clear} className="w-3 h-3"/> Clear Inputs
               </button>
           </div>
           
           <div className="p-3 bg-sky-50 dark:bg-sky-900/20 border border-sky-200 dark:border-sky-800 rounded-lg mb-6 text-sm text-sky-800 dark:text-sky-200">
               <strong>Smart Chart:</strong> Short-lived intermediate daughters (T<sub>½</sub> &lt; 1 day) are hidden by default to reduce clutter. Click their names in the chart legend to reveal them.
           </div>

           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
               <div>
                   <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Decay Series</label>
                   <select value={selectedSeriesId} onChange={e => setSelectedSeriesId(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                       {decaySeriesData.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                   </select>
               </div>
               <div>
                   <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Initial Parent Activity</label>
                   <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
               </div>
               <div>
                   <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">Time Elapsed</label>
                   <div className="flex gap-2 mt-1">
                       <input type="number" value={timeElapsed} onChange={e => setTimeElapsed(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                       <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                           {timeUnits.map(u => <option key={u} value={u}>{u}</option>)}
                       </select>
                   </div>
               </div>
               <button onClick={handleCalculate} disabled={isLoading} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition disabled:bg-sky-800 disabled:cursor-wait">
                   {isLoading ? 'Calculating...' : 'Calculate'}
               </button>
           </div>
           
           {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
           
           <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
               {/* Chart Section */}
               <div className="min-h-[300px]">
                   {chartData ? (
                       <>
                          <div className="flex justify-end mb-2">
                               <label className="flex items-center gap-2 text-sm cursor-pointer">
                                   <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" />
                                   Use Logarithmic Scale
                               </label>
                           </div>
                          <SeriesDecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} />
                       </>
                   ) : (
                       <div className="flex items-center justify-center h-full bg-slate-100 dark:bg-slate-800/50 rounded-lg">
                           <p className="text-slate-500">Chart will be displayed here.</p>
                       </div>
                   )}
               </div>

               {/* Results Table Section */}
               <div className="max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                   <h3 className="text-lg font-semibold mb-2">Results at {timeElapsed} {timeUnit}</h3>
                   {results.items && results.items.length > 0 ? (
                       <table className="w-full text-sm text-left">
                           <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0 z-10">
                               <tr><th className="p-2">Nuclide</th><th className="p-2 text-right">Activity</th></tr>
                           </thead>
                           <tbody>
                               <tr className="bg-slate-50 dark:bg-slate-700/50 font-bold border-b border-slate-300 dark:border-slate-600">
                                   <td className="p-2">TOTAL ACTIVITY</td>
                                   <td className="p-2 text-right">{results.total.toPrecision(4)}</td>
                               </tr>
                               {results.items.map(r => (
                                   <tr key={r.name} className="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                       <td className="p-2 font-medium">
                                           <button 
                                               onClick={() => handleRowClick(r.name)} 
                                               className="text-sky-600 dark:text-sky-400 hover:underline text-left"
                                           >
                                               {r.name}
                                           </button>
                                       </td>
                                       <td className="p-2 text-right font-mono">{r.activity.toPrecision(4)}</td>
                                   </tr>
                               ))}
                           </tbody>
                       </table>
                   ) : <p className="text-slate-500 text-center py-4">No results to display.</p>}
               </div>
           </div>
       </div>
    </div>
    );
};

              /**
               * @description A React component that renders a line chart for a decay series using Chart.js.
               * It's designed to display the activity of all nuclides in a chain over time.
               * @param {{chartData: object}} props - The data object for the chart, including labels and datasets.
               */
              
              const SeriesDecayChart = ({ chartData, useLogScale, theme }) => { // <-- MODIFIED: Accepted 'theme' prop
              const chartRef = React.useRef(null);
              const chartInstance = React.useRef(null);
              
              React.useEffect(() => {
              if (chartInstance.current) {
                 chartInstance.current.destroy();
              }
              
              if (chartRef.current && chartData) {
              
                 // Determine colors based on the theme prop
              
                 const isDarkMode = theme === 'dark';
                 const textColor = isDarkMode ? '#cbd5e1' : '#334155';
                 const gridColor = isDarkMode ? '#334155' : '#e2e8f0';
              
                 const ctx = chartRef.current.getContext('2d');
                 chartInstance.current = new Chart(ctx, {
                     type: 'line',
                     data: chartData,
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 position: 'top',
                                 labels: { 
                                     boxWidth: 20, 
                                     font: { size: 10 },
                                     color: textColor 
                                 } 
                             },
                             title: {
                                 display: true,
                                 text: 'Decay Series Activity Over Time',
                                 color: textColor
                             },
                             tooltip: {
                                 mode: 'index',
                                 intersect: false,
                             }
                         },
                         scales: {
                             x: {
                                 title: { 
                                     display: true, 
                                     text: `Time (${chartData.timeUnit})`,
                                     color: textColor
                                 },
                                 ticks: { 
                                     maxRotation: 0, 
                                     autoSkip: true, 
                                     autoSkipPadding: 20,
                                     color: textColor
                                 },
                                 grid: {
                                     color: gridColor
                                 }
                             },
                             y: {
                                 type: useLogScale ? 'logarithmic' : 'linear',
                                 title: { 
                                     display: true, 
                                     text: `Activity (${useLogScale ? 'Log Scale' : 'Linear Scale'})`,
                                     color: textColor
                                 },
                                 beginAtZero: !useLogScale,
                                 min: useLogScale ? (Math.max(...chartData.datasets.flatMap(d => d.data)) > 0 ? 1e-9 : 0) : undefined,
                                 ticks: {
                                     color: textColor
                                 },
                                 grid: {
                                     color: gridColor
                                 }
                             }
                         }
                     }
                 });
              }
              
              return () => {
                 if (chartInstance.current) {
                     chartInstance.current.destroy();
                 }
              };
              }, [chartData, useLogScale, theme]);
              
              const handleExport = () => {
              if (chartInstance.current) {
                const link = document.createElement('a');
                link.href = chartInstance.current.toBase64Image();
                link.download = 'decay-chart.png';
                link.click();
              }
              };
              
              return (
              <div className="mt-4">
                <div className="h-64">
                    <canvas ref={chartRef}></canvas>
                </div>
                <div className="text-center mt-2">
                    <button
                        onClick={handleExport}
                        className="px-3 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold"
                    >
                        Export as PNG
                    </button>
                </div>
              </div>
              );
              };
              
              /**
              * @description A combined calculator for mass-to-activity conversions and for calculating
              * specific activity from first principles.
              * @param {{radionuclides: Array<object>}} props
              */
// 1. Updated MassActivityModule (Added Manual SA Override)
const MassActivityModule = ({ radionuclides, selectedNuclide, setSelectedNuclide, mass, setMass, massUnit, setMassUnit, activity, setActivity, activityUnit, setActivityUnit, error, setError, activityUnits }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const { settings } = React.useContext(SettingsContext);
    
    // State for Manual SA
    const [useManualSA, setUseManualSA] = React.useState(false);
    const [manualSA, setManualSA] = React.useState('');
    const [manualSAUnit, setManualSAUnit] = React.useState(settings.unitSystem === 'si' ? 'Bq/g' : 'Ci/g');

    const massUnits = { 'µg': 1e-6, 'mg': 1e-3, 'g': 1, 'kg': 1000, 'lb': 453.592 };
    const activityFactorsBq = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'TBq': 1e12, 'Ci': 3.7e10, 'mCi': 3.7e7, 'µCi': 3.7e4 };
    const saUnitFactors = { 'Bq/g': 1, 'kBq/g': 1e3, 'MBq/g': 1e6, 'GBq/g': 1e9, 'Ci/g': 3.7e10, 'mCi/g': 3.7e7, 'µCi/g': 37000 };
    
    // Helper to calculate SA on the fly if needed
    const getOrCalculateSA = (nuclide) => {
        // 1. Manual Override
        if (useManualSA) {
             const val = parseFloat(manualSA);
             if (isNaN(val) || val <= 0) return { value: 0, isCalculated: false };
             return { value: val * saUnitFactors[manualSAUnit], isCalculated: false };
        }

        // 2. Database Value
        if (!nuclide) return { value: 0, isCalculated: false };
        const parsedSA = parseSpecificActivity(nuclide.specificActivity);
        if (parsedSA > 0) return { value: parsedSA, isCalculated: false };

        // 3. Theoretical Calculation
        const seconds = parseHalfLifeToSeconds(nuclide.halfLife);
        if (seconds === 0 || seconds === Infinity) return { value: 0, isCalculated: false };
        const match = nuclide.symbol.match(/-(\d+)/);
        if (!match) return { value: 0, isCalculated: false };
        const atomicMass = parseInt(match[1], 10);
        const avogadro = 6.02214076e23;
        const calculatedSA = (Math.log(2) * avogadro) / (seconds * atomicMass);
        return { value: calculatedSA, isCalculated: true };
    };

    // Filter list
    const nuclidesWithSA = React.useMemo(() => radionuclides.filter(r => r.halfLife !== 'Stable').sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    
    const handleNuclideSelect = (symbol) => {
        const nuclideToSet = nuclidesWithSA.find(n => n.symbol === symbol);
        setSelectedNuclide(nuclideToSet);
        setMass(''); setActivity(''); setError('');
    };

    const [isSaCalculated, setIsSaCalculated] = React.useState(false);
    const [activeSA, setActiveSA] = React.useState(0);

    // Update active SA whenever dependencies change
    React.useEffect(() => {
        const { value, isCalculated } = getOrCalculateSA(selectedNuclide);
        setActiveSA(value);
        setIsSaCalculated(isCalculated);
        // Recalculate output if input exists
        if (mass) calculateActivity(parseFloat(mass), massUnit, activityUnit, value);
    }, [selectedNuclide, useManualSA, manualSA, manualSAUnit]);

    const calculateActivity = (massVal, mUnit, aUnit, saVal = activeSA) => {
        if (isNaN(massVal) || massVal < 0) { setActivity(''); return; }
        if (saVal > 0) {
           const massInG = massVal * massUnits[mUnit];
           const activityInBq = massInG * saVal;
           const finalActivity = activityInBq / activityFactorsBq[aUnit];
           setActivity(finalActivity.toPrecision(4));
        }
    };

    const calculateMass = (actVal, aUnit, mUnit, saVal = activeSA) => {
        if (isNaN(actVal) || actVal < 0) { setMass(''); return; }
        if (saVal > 0) {
           const activityInBq = actVal * activityFactorsBq[aUnit];
           const massInG = activityInBq / saVal;
           const finalMass = massInG / massUnits[mUnit];
           setMass(finalMass.toPrecision(4));
        }
    };
    
    return (
        <div className="space-y-4">
           {/* Header / Toggle */}
           <div className="flex justify-between items-center">
               <p className="text-sm text-slate-600 dark:text-slate-400">Convert between mass and activity.</p>
               <label className="flex items-center gap-2 text-xs font-semibold cursor-pointer text-sky-600 dark:text-sky-400">
                   <input type="checkbox" checked={useManualSA} onChange={() => setUseManualSA(!useManualSA)} className="form-checkbox h-3 w-3 rounded text-sky-600" />
                   Manual Specific Activity
               </label>
           </div>

           {/* Input Section */}
           {useManualSA ? (
               <div className="p-3 bg-slate-50 dark:bg-slate-800/50 rounded border border-slate-200 dark:border-slate-700 animate-fade-in">
                   <label className="block text-xs font-medium mb-1">Specific Activity</label>
                   <div className="flex">
                       <input type="number" value={manualSA} onChange={e => setManualSA(e.target.value)} className="w-full p-2 rounded-l-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm" placeholder="e.g. 3.6e10"/>
                       <select value={manualSAUnit} onChange={e => setManualSAUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-100 dark:bg-slate-600 border border-slate-300 dark:border-slate-600 text-xs">
                           {Object.keys(saUnitFactors).map(u => <option key={u} value={u}>{u}</option>)}
                       </select>
                   </div>
               </div>
           ) : (
               <div className="min-h-[42px] animate-fade-in">
                   {selectedNuclide ? ( <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setSelectedNuclide(null)} /> ) : ( <SearchableSelect options={nuclidesWithSA} onSelect={handleNuclideSelect} placeholder="Search for a radionuclide..."/> )}
               </div>
           )}
           
           {/* Info Bar (Only show if we have a valid SA) */}
           {!useManualSA && selectedNuclide && activeSA > 0 && (
              <div className="flex justify-between items-center text-xs text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 p-2 rounded border border-slate-200 dark:border-slate-700">
                  <span>Specific Activity: <strong>{formatWithUnitSystem(activeSA, 'activity', settings).value} {formatWithUnitSystem(activeSA, 'activity', settings).unit}</strong></span>
                  {isSaCalculated && <span className="italic">(Estimated)</span>}
              </div>
           )}

           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
               <div>
                   <label className="block text-sm font-semibold mb-1">Mass</label>
                   <div className="flex">
                       <input type="number" value={mass} onChange={(e) => { setMass(e.target.value); calculateActivity(parseFloat(e.target.value), massUnit, activityUnit); }} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                       <select value={massUnit} onChange={(e) => { setMassUnit(e.target.value); calculateActivity(parseFloat(mass), e.target.value, activityUnit); }} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
                   </div>
               </div>
               <div className="text-center text-xl text-slate-400">⇅</div>
               <div>
                   <label className="block text-sm font-semibold mb-1">Activity</label>
                   <div className="flex">
                       <input type="number" value={activity} onChange={(e) => { setActivity(e.target.value); calculateMass(parseFloat(e.target.value), activityUnit, massUnit); }} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                       <select value={activityUnit} onChange={(e) => { setActivityUnit(e.target.value); calculateMass(parseFloat(activity), e.target.value, massUnit); }} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                   </div>
               </div>
           </div>
           
           {/* Smart Result Display */}
           {activity && mass && (
               <div className="mt-2 text-center animate-fade-in">
                   <p className="text-sm text-slate-500">
                       {mass} {massUnit} ≈ <span className="font-bold text-sky-600 dark:text-sky-400">
                           {(() => {
                               const actBq = parseFloat(activity) * activityFactorsBq[activityUnit];
                               const fmt = formatSensibleUnit(settings.unitSystem === 'si' ? actBq : actBq / 3.7e10, settings.unitSystem === 'si' ? 'activity_si' : 'activity_conventional');
                               return `${fmt.value} ${fmt.unit}`;
                           })()}
                       </span>
                   </p>
               </div>
           )}
        </div>
    );
};

// 2. Updated ActivityFromDoseRate (Added Manual Gamma Constant)
const ActivityFromDoseRate = ({ radionuclides, nuclideSymbol, setNuclideSymbol, doseRate, setDoseRate, doseRateUnit, setDoseRateUnit, distance, setDistance, distanceUnit, setDistanceUnit, result, setResult, error, setError, doseRateUnits, distanceUnits }) => {
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    const [useManualGamma, setUseManualGamma] = React.useState(false);
    const [manualGamma, setManualGamma] = React.useState('');
    const [transmission, setTransmission] = React.useState('1.0');

    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    const selectedNuclide = React.useMemo(() => gammaNuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, gammaNuclides]);
    
    const doseRateFactors_mrem_hr = { 'µrem/hr': 0.001, 'mrem/hr': 1, 'rem/hr': 1000, 'µSv/hr': 0.1, 'mSv/hr': 100, 'Sv/hr': 100000 };
    const distanceFactors_m = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };
    
    React.useEffect(() => {
        try {
           setError('');
           
           // Validate Gamma Source
           let gammaConstant = 0;
           if (useManualGamma) {
               gammaConstant = parseFloat(manualGamma);
               if (isNaN(gammaConstant) || gammaConstant <= 0) {
                   setResult(null); return; 
               }
           } else {
               if (!selectedNuclide) { setResult(null); return; }
               gammaConstant = parseFloat(selectedNuclide.gammaConstant);
           }
           
           const doseRateVal = parseFloat(doseRate);
           const distanceVal = parseFloat(distance);
           const transVal = parseFloat(transmission);

           if (isNaN(doseRateVal) || isNaN(distanceVal) || isNaN(transVal) || doseRateVal <= 0 || distanceVal <= 0 || transVal <= 0 || transVal > 1) {
               if (doseRate && distance) setError("Inputs must be positive. Transmission must be 0-1.");
               setResult(null); return;
           }
        
           const doseRate_R_hr = (doseRateVal * doseRateFactors_mrem_hr[doseRateUnit]) / 1000;
           const distance_m = distanceVal * distanceFactors_m[distanceUnit];
        
           // Inverse Square Law: A = (D * d^2) / (Gamma * T)
           const activity_Ci = (doseRate_R_hr * Math.pow(distance_m, 2)) / (gammaConstant * transVal);
           
           setResult({ rawActivity_Ci: activity_Ci });
        } catch (e) { setError(e.message); setResult(null); }
    }, [selectedNuclide, useManualGamma, manualGamma, doseRate, doseRateUnit, distance, distanceUnit, transmission]);

    const handleSaveToHistory = () => {
        if (result) {
          const activityInBase = settings.unitSystem === 'si' ? result.rawActivity_Ci * 3.7e10 : result.rawActivity_Ci;
          const configKey = settings.unitSystem === 'si' ? 'activity_si' : 'activity_conventional';
          const formattedResult = formatSensibleUnit(activityInBase, configKey);
          const sourceName = useManualGamma ? `Γ=${manualGamma}` : selectedNuclide.symbol;
          addHistory({ id: Date.now(), type: 'Activity from Dose', icon: ICONS.activity, inputs: `${doseRate} ${doseRateUnit} @ ${distance} ${distanceUnit}`, result: `${formattedResult.value} ${formattedResult.unit} (${sourceName})`, view: VIEWS.ACTIVITY_MASS });
          addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="space-y-4">
           {/* Header / Toggle */}
           <div className="flex justify-between items-center">
               <p className="text-sm text-slate-600 dark:text-slate-400">Calculates activity from gamma dose rate.</p>
               <label className="flex items-center gap-2 text-xs font-semibold cursor-pointer text-sky-600 dark:text-sky-400">
                   <input type="checkbox" checked={useManualGamma} onChange={() => setUseManualGamma(!useManualGamma)} className="form-checkbox h-3 w-3 rounded text-sky-600" />
                   Manual Gamma Constant
               </label>
           </div>
           
           <div>
               {useManualGamma ? (
                   <div className="animate-fade-in p-3 bg-slate-50 dark:bg-slate-800/50 rounded border border-slate-200 dark:border-slate-700">
                       <label className="block text-xs font-medium mb-1">Gamma Constant (Γ)</label>
                       <div className="relative">
                           <input type="number" value={manualGamma} onChange={e => setManualGamma(e.target.value)} className="w-full p-2 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm" placeholder="e.g. 0.33" />
                           <span className="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">R·m²/hr·Ci</span>
                       </div>
                   </div>
               ) : (
                   <div className="mt-1 animate-fade-in">
                       {selectedNuclide ? 
                           <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> :
                           <SearchableSelect options={gammaNuclides} onSelect={setNuclideSymbol} placeholder="Select a gamma emitter..." />
                       }
                   </div>
               )}
           </div>
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
               <div>
                   <label className="block text-sm font-medium">Measured Dose Rate</label>
                   <div className="flex">
                       <input type="number" value={doseRate} onChange={e => setDoseRate(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                       <select value={doseRateUnit} onChange={e => setDoseRateUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{doseRateUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                   </div>
               </div>
               <div>
                   <label className="block text-sm font-medium">Distance from Source</label>
                   <div className="flex">
                       <input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                       <select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs">{distanceUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                   </div>
               </div>
               <div className="md:col-span-2">
                   <Tooltip text="Fraction of radiation passing through shielding (0.0 to 1.0). Use 1.0 for unshielded.">
                       <label className="block text-sm font-medium cursor-help underline decoration-dotted">Transmission Factor (0-1)</label>
                   </Tooltip>
                   <input type="number" step="0.1" min="0" max="1" value={transmission} onChange={e => setTransmission(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
               </div>
           </div>
           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           {result && (() => {
               const activityInBase = settings.unitSystem === 'si' ? result.rawActivity_Ci * 3.7e10 : result.rawActivity_Ci;
               const configKey = settings.unitSystem === 'si' ? 'activity_si' : 'activity_conventional';
               const formattedResult = formatSensibleUnit(activityInBase, configKey);
               return (
                   <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                       <div className="flex justify-between items-center -mb-2">
                           <div></div>
                           <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Source Activity</p>
                           <Tooltip text="Save to Recent Calculations" widthClass="w-auto"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5" /></button></Tooltip>
                       </div>
                       <div className="flex items-center justify-center">
                           <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{formattedResult.value}</p>
                           <CopyButton textToCopy={formattedResult.value} />
                       </div>
                       <p className="text-md font-medium text-slate-600 dark:text-slate-300">{formattedResult.unit}</p>
                   </div>
               );
           })()}
        </div>
    );
};

// 4. ActivityAndMassTools Container (Unchanged except re-passing props)
const ActivityAndMassTools = ({ radionuclides }) => {
    const { settings } = React.useContext(SettingsContext);
    const MODE_MASS_ACTIVITY = 'massActivity';
    const MODE_SPECIFIC_ACTIVITY = 'specificActivity';
    const MODE_ACTIVITY_FROM_DOSE = 'activityFromDose';
    
    const [calcMode, setCalcMode] = React.useState(MODE_MASS_ACTIVITY);

    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq', 'TBq'] : ['µCi', 'mCi', 'Ci'], [settings.unitSystem]);
    const distanceUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['mm', 'cm', 'm'] : ['in', 'ft', 'm'], [settings.unitSystem]);
    const doseRateUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['µSv/hr', 'mSv/hr', 'Sv/hr'] : ['µrem/hr', 'mrem/hr', 'rem/hr'], [settings.unitSystem]);
    
    const [mass_selectedNuclide, setMass_selectedNuclide] = React.useState(() => { const savedSymbol = localStorage.getItem('massActivity_symbol'); if (!savedSymbol) return null; return radionuclides.find(n => n.symbol === savedSymbol) || null; });
    const [mass_mass, setMass_mass] = React.useState(() => localStorage.getItem('massActivity_mass') || '');
    const [mass_massUnit, setMass_massUnit] = React.useState(() => localStorage.getItem('massActivity_massUnit') || 'g');
    const [mass_activity, setMass_activity] = React.useState(() => localStorage.getItem('massActivity_activity') || '');
    const [mass_activityUnit, setMass_activityUnit] = React.useState(() => localStorage.getItem('massActivity_activityUnit') || activityUnits[1]);
    const [mass_error, setMass_error] = React.useState('');
    
    const [spec_atomicWeight, setSpec_atomicWeight] = React.useState(() => localStorage.getItem('specActivity_atomicWeight') || '');
    const [spec_halfLifeValue, setSpec_halfLifeValue] = React.useState(() => localStorage.getItem('specActivity_halfLifeValue') || '');
    const [spec_halfLifeUnit, setSpec_halfLifeUnit] = React.useState(() => localStorage.getItem('specActivity_halfLifeUnit') || 'years');
    const [spec_result, setSpec_result] = React.useState(null);
    const [spec_error, setSpec_error] = React.useState('');
    
    const [afd_nuclideSymbol, setAfd_nuclideSymbol] = React.useState('');
    const [afd_doseRate, setAfd_doseRate] = React.useState('10');
    const [afd_doseRateUnit, setAfd_doseRateUnit] = React.useState(() => doseRateUnits[1]);
    const [afd_distance, setAfd_distance] = React.useState('1');
    const [afd_distanceUnit, setAfd_distanceUnit] = React.useState(() => distanceUnits[2]);
    const [afd_result, setAfd_result] = React.useState(null);
    const [afd_error, setAfd_error] = React.useState('');

    React.useEffect(() => { if (!activityUnits.includes(mass_activityUnit)) setMass_activityUnit(activityUnits[1]); }, [activityUnits, mass_activityUnit]);
    React.useEffect(() => { if (!doseRateUnits.includes(afd_doseRateUnit)) setAfd_doseRateUnit(doseRateUnits[1]); }, [doseRateUnits, afd_doseRateUnit]);
    
    const handleMassActivityClear = () => {
        setMass_selectedNuclide(null); setMass_mass(''); setMass_massUnit('g');
        setMass_activity(''); setMass_activityUnit(activityUnits[1]); setMass_error('');
        Object.keys(localStorage).forEach(key => { if (key.startsWith('massActivity_')) localStorage.removeItem(key); });
    };
    
    const handleSpecificActivityClear = () => {
        setSpec_atomicWeight(''); setSpec_halfLifeValue(''); setSpec_halfLifeUnit('years');
        setSpec_result(null); setSpec_error('');
        Object.keys(localStorage).forEach(key => { if (key.startsWith('specActivity_')) localStorage.removeItem(key); });
    };
    
    const handleActivityFromDoseClear = () => {
        setAfd_nuclideSymbol(''); setAfd_doseRate('10'); setAfd_doseRateUnit(doseRateUnits[1]);
        setAfd_distance('1'); setAfd_distanceUnit(distanceUnits[2]); setAfd_result(null); setAfd_error('');
    };
    
    const handleClearActiveCalculator = () => {
        if (calcMode === MODE_MASS_ACTIVITY) handleMassActivityClear();
        else if (calcMode === MODE_SPECIFIC_ACTIVITY) handleSpecificActivityClear();
        else handleActivityFromDoseClear();
    };
    
    return (
        <div className="p-4 animate-fade-in">
          <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
              <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-slate-800 dark:text-white">Activity & Mass Tools</h2>
                  <ClearButton onClick={handleClearActiveCalculator} />
              </div>
              <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                  <button onClick={() => setCalcMode(MODE_MASS_ACTIVITY)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_MASS_ACTIVITY ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Mass ↔ Activity</button>
                  <button onClick={() => setCalcMode(MODE_ACTIVITY_FROM_DOSE)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_ACTIVITY_FROM_DOSE ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Act. from Dose</button>
                  <button onClick={() => setCalcMode(MODE_SPECIFIC_ACTIVITY)} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === MODE_SPECIFIC_ACTIVITY ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Specific Activity</button>
              </div>
              {calcMode === MODE_MASS_ACTIVITY && <MassActivityModule radionuclides={radionuclides} selectedNuclide={mass_selectedNuclide} setSelectedNuclide={setMass_selectedNuclide} mass={mass_mass} setMass={setMass_mass} massUnit={mass_massUnit} setMassUnit={setMass_massUnit} activity={mass_activity} setActivity={setMass_activity} activityUnit={mass_activityUnit} setActivityUnit={setMass_activityUnit} error={mass_error} setError={setMass_error} activityUnits={activityUnits} /> }
              {calcMode === MODE_ACTIVITY_FROM_DOSE && <ActivityFromDoseRate radionuclides={radionuclides} nuclideSymbol={afd_nuclideSymbol} setNuclideSymbol={setAfd_nuclideSymbol} doseRate={afd_doseRate} setDoseRate={setAfd_doseRate} doseRateUnit={afd_doseRateUnit} setDoseRateUnit={setAfd_doseRateUnit} distance={afd_distance} setDistance={setAfd_distance} distanceUnit={afd_distanceUnit} setDistanceUnit={setAfd_distanceUnit} result={afd_result} setResult={setAfd_result} error={afd_error} setError={setAfd_error} doseRateUnits={doseRateUnits} distanceUnits={distanceUnits} /> }
              {calcMode === MODE_SPECIFIC_ACTIVITY && <SpecificActivityModule radionuclides={radionuclides} atomicWeight={spec_atomicWeight} setAtomicWeight={setSpec_atomicWeight} halfLifeValue={spec_halfLifeValue} setHalfLifeValue={setSpec_halfLifeValue} halfLifeUnit={spec_halfLifeUnit} setHalfLifeUnit={setSpec_halfLifeUnit} result={spec_result} setResult={setSpec_result} error={spec_error} setError={setSpec_error} /> }
          </div>
        </div>
    );
};              
              /**
              * @description A calculator to determine the activities of a parent-daughter pair over time,
              * and to analyze the type of equilibrium present based on their half-lives.
              * @param {{radionuclides: Array<object>}} props
              */
              
const EquilibriumCalculator = ({ radionuclides, theme }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const { settings } = React.useContext(SettingsContext);

    // --- STATE ---
    const [parentNuclide, setParentNuclide] = React.useState(() => {
        const savedSymbol = localStorage.getItem('equilibrium_parentSymbol');
        if (!savedSymbol) return null;
        return radionuclides.find(n => n.symbol === savedSymbol) || null;
    });
    
    // We derive the daughter from the parent automatically, but keep state for the specific object
    const [daughterNuclide, setDaughterNuclide] = React.useState(null);
    
    const [initialActivity, setInitialActivity] = React.useState(() => localStorage.getItem('equilibrium_initialActivity') || '100');
    const [initialDaughterActivity, setInitialDaughterActivity] = React.useState(() => localStorage.getItem('equilibrium_initialDaughterActivity') || '0');
    const [branchingFraction, setBranchingFraction] = React.useState(() => localStorage.getItem('equilibrium_branchingFraction') || '1.0');
    
    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['MBq', 'GBq', 'TBq', 'Bq'] : ['mCi', 'Ci', 'µCi'], [settings.unitSystem]);
    const [activityUnit, setActivityUnit] = React.useState(() => localStorage.getItem('equilibrium_activityUnit') || activityUnits[0]);

    const [timeElapsed, setTimeElapsed] = React.useState(() => localStorage.getItem('equilibrium_timeElapsed') || '10');
    const [timeUnit, setTimeUnit] = React.useState(() => localStorage.getItem('equilibrium_timeUnit') || 'days');
    
    const [result, setResult] = React.useState(null);
    const [chartData, setChartData] = React.useState(null);
    const [error, setError] = React.useState('');
    const [analysis, setAnalysis] = React.useState(null);
    const [useLogScale, setUseLogScale] = React.useState(() => JSON.parse(localStorage.getItem('equilibrium_useLogScale')) || false);

    const timeUnitsOrdered = ['hours', 'days', 'years', 'minutes'];

    // --- EFFECTS ---
    React.useEffect(() => {
        localStorage.setItem('equilibrium_parentSymbol', parentNuclide ? parentNuclide.symbol : '');
        localStorage.setItem('equilibrium_initialActivity', initialActivity);
        localStorage.setItem('equilibrium_initialDaughterActivity', initialDaughterActivity);
        localStorage.setItem('equilibrium_branchingFraction', branchingFraction);
        localStorage.setItem('equilibrium_activityUnit', activityUnit);
        localStorage.setItem('equilibrium_timeElapsed', timeElapsed);
        localStorage.setItem('equilibrium_timeUnit', timeUnit);
        localStorage.setItem('equilibrium_useLogScale', JSON.stringify(useLogScale));
    }, [parentNuclide, initialActivity, initialDaughterActivity, branchingFraction, activityUnit, timeElapsed, timeUnit, useLogScale]);

    // Update default unit if system changes
    React.useEffect(() => {
        if (!activityUnits.includes(activityUnit)) setActivityUnit(activityUnits[0]);
    }, [settings.unitSystem]);

    // Parent Filter: Must have a valid single daughter in the DB that isn't stable
    const parentNuclides = React.useMemo(() => {
        return radionuclides.filter(parent => {
            if (!parent.daughter || parent.halfLife === 'Stable') return false;
            // Clean up daughter string to find match
            const daughterName = parent.daughter.split('(')[0].split('/')[0].trim(); 
            const normDaughter = normalizeString(daughterName);
            const daughter = radionuclides.find(n => normalizeString(n.name) === normDaughter || normalizeString(n.symbol) === normDaughter);
            return daughter && daughter.halfLife !== 'Stable';
        }).sort((a, b) => a.name.localeCompare(b.name));
    }, [radionuclides]);

    // --- 1. IMPROVEMENT: Generator Presets ---
    const handlePresetSelect = (preset) => {
        const parent = radionuclides.find(n => n.symbol === preset.p);
        if (parent) {
            setParentNuclide(parent);
            setBranchingFraction(preset.br);
            setInitialActivity('100');
            setInitialDaughterActivity('0');
            // Smart time unit selection
            if (preset.p === 'Mo-99') { setTimeElapsed('10'); setTimeUnit('days'); }
            else if (preset.p === 'Sr-90') { setTimeElapsed('30'); setTimeUnit('days'); }
            else { setTimeElapsed('100'); setTimeUnit('years'); }
            addToast(`Loaded ${preset.p} generator settings.`);
        }
    };

    const GENERATOR_PRESETS = [
        { p: 'Mo-99', br: '0.875', label: 'Mo-99 / Tc-99m' },
        { p: 'Sr-90', br: '1.0', label: 'Sr-90 / Y-90' },
        { p: 'Cs-137', br: '0.946', label: 'Cs-137 / Ba-137m' }
    ];

    // Handle Parent Selection Logic
    React.useEffect(() => {
        if (!parentNuclide) {
           setAnalysis(null); setDaughterNuclide(null); return;
        }
        
        const daughterName = parentNuclide.daughter.split('(')[0].split('/')[0].trim();
        const normDaughter = normalizeString(daughterName);
        const foundDaughter = radionuclides.find(n => normalizeString(n.name) === normDaughter || normalizeString(n.symbol) === normDaughter);
        
        if (!foundDaughter) {
           setAnalysis({ type: 'Analysis Error', message: 'Daughter nuclide data not found in database.' }); 
           setDaughterNuclide(null); 
           return;
        }
        setDaughterNuclide(foundDaughter);
        
        const T1_seconds = parseHalfLifeToSeconds(parentNuclide.halfLife);
        const T2_seconds = parseHalfLifeToSeconds(foundDaughter.halfLife);
        
        let type, message, theoreticalRatio = null, timeToEq = null, timeToMax = null;
        
        if (T1_seconds < T2_seconds) {
           type = 'No Equilibrium';
           message = `The parent half-life (${parentNuclide.halfLife}) is shorter than the daughter half-life (${foundDaughter.halfLife}). The daughter will decay according to its own half-life once the parent is gone.`;
        } else if (T1_seconds > 100 * T2_seconds) {
           type = 'Secular Equilibrium';
           theoreticalRatio = 1.0;
           timeToEq = (7 * T2_seconds); // Roughly 7 half-lives
           message = `The parent half-life is much longer than the daughter's. The daughter activity will eventually equal the parent activity (multiplied by branching fraction).`;
        } else {
           type = 'Transient Equilibrium';
           const lambda1 = Math.log(2) / T1_seconds;
           const lambda2 = Math.log(2) / T2_seconds;
           theoreticalRatio = lambda2 / (lambda2 - lambda1);
           timeToEq = (10 * T2_seconds); // Takes longer to stabilize
           timeToMax = Math.log(lambda2 / lambda1) / (lambda2 - lambda1);
           message = `The parent and daughter half-lives are comparable. The daughter activity will rise, exceed the parent, and then decay with the parent's apparent half-life.`;
        }
        
        setAnalysis({ type, message, theoreticalRatio, timeToEq, timeToMax });

    }, [parentNuclide, radionuclides]);

    // --- CALCULATION ---
    const handleCalculate = () => {
        if (!parentNuclide || !daughterNuclide) return;
        
        const N0_parent = parseFloat(initialActivity);
        const N0_daughter = parseFloat(initialDaughterActivity);
        const br = parseFloat(branchingFraction);
        const t_input = parseFloat(timeElapsed);
        
        if ([N0_parent, N0_daughter, br, t_input].some(isNaN) || N0_parent < 0 || N0_daughter < 0 || br < 0 || br > 1 || t_input < 0) {
            setError('Please enter valid, non-negative numbers. Branching fraction must be 0-1.'); return;
        }
        setError('');

        const T1_seconds = parseHalfLifeToSeconds(parentNuclide.halfLife);
        const T2_seconds = parseHalfLifeToSeconds(daughterNuclide.halfLife);
        const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
        const t_seconds = t_input * unitConversions[timeUnit];
        const lambda1 = Math.log(2) / T1_seconds;
        const lambda2 = Math.log(2) / T2_seconds;

        // Bateman Calculation for Current Time (t)
        const A_parent = N0_parent * Math.exp(-lambda1 * t_seconds);
        const initialDaughterDecay = N0_daughter * Math.exp(-lambda2 * t_seconds);
        let daughterIngrowth;
        
        // Handle singularity if half-lives are identical (extremely rare)
        if (Math.abs(lambda1 - lambda2) < 1e-12) {
             daughterIngrowth = br * N0_parent * lambda1 * t_seconds * Math.exp(-lambda1 * t_seconds);
        } else {
             daughterIngrowth = br * (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * t_seconds) - Math.exp(-lambda2 * t_seconds));
        }
        
        const A_daughter = initialDaughterDecay + daughterIngrowth;
        
        // --- 1. FIX: Real-time Ratio ---
        const currentRatio = A_parent > 0 ? (A_daughter / A_parent) : 0;

        setResult({ 
            parent: { name: parentNuclide.name, activity: A_parent.toPrecision(4) }, 
            daughter: { name: daughterNuclide.name, activity: A_daughter.toPrecision(4) },
            currentRatio: currentRatio.toFixed(4)
        });

        // --- Chart Generation ---
        const labels = [], parentData = [], daughterData = [];
        
        // If T_max exists and is within a reasonable range of user input, make sure we capture it
        // If user entered 10 days, but max is at 23 hours, graph needs enough resolution
        const plotTime = t_seconds;
        const steps = 100;

        for (let i = 0; i <= steps; i++) {
           const timePoint = (plotTime / steps) * i;
           // Format time label based on magnitude
           const displayTimeVal = timePoint / unitConversions[timeUnit];
           labels.push(displayTimeVal < 10 ? displayTimeVal.toPrecision(2) : Math.round(displayTimeVal).toString());
           
           // Re-calculate for curve
           const curr_A_parent = N0_parent * Math.exp(-lambda1 * timePoint);
           parentData.push(curr_A_parent);
           
           const curr_initD_decay = N0_daughter * Math.exp(-lambda2 * timePoint);
           let curr_D_ingrowth;
           if (Math.abs(lambda1 - lambda2) < 1e-12) {
               curr_D_ingrowth = br * N0_parent * lambda1 * timePoint * Math.exp(-lambda1 * timePoint);
           } else {
               curr_D_ingrowth = br * (lambda2 / (lambda2 - lambda1)) * N0_parent * (Math.exp(-lambda1 * timePoint) - Math.exp(-lambda2 * timePoint));
           }
           daughterData.push(curr_initD_decay + curr_D_ingrowth);
        }
        
        // --- 2. FIX: Add T-Max Annotation Line ---
        // (Note: Chart.js annotation requires a plugin, but we can fake it with a vertical line dataset 
        // or just by adding a point. For simplicity without plugins, we will ensure T-max is highlighted in the text analysis)

        setChartData({ labels, parentData, daughterData, parentName: parentNuclide.name, daughterName: daughterNuclide.name, timeUnit });
    };

    // Auto-calculate
    React.useEffect(() => {
        if (parentNuclide && daughterNuclide) handleCalculate();
    }, [parentNuclide, daughterNuclide, initialActivity, initialDaughterActivity, branchingFraction, timeElapsed, timeUnit]);

    const handleParentChange = (symbol) => {
        const parent = parentNuclides.find(p => p.symbol === symbol);
        setResult(null); setChartData(null); setError(''); setParentNuclide(parent || null);
        // Reset branching to 1.0 when changing manually, user can adjust
        setBranchingFraction('1.0');
    };

    const handleSaveToHistory = () => {
        if (result && parentNuclide) {
            addHistory({ 
                id: Date.now(), 
                type: 'Equilibrium', 
                icon: ICONS.activity, 
                inputs: `${initialActivity} ${activityUnit} ${parentNuclide.symbol} (t=${timeElapsed} ${timeUnit})`, 
                result: `D: ${result.daughter.activity}, Ratio: ${result.currentRatio}`, 
                view: VIEWS.EQUILIBRIUM 
            });
            addToast("Calculation saved to history!");
        }
    };
    
    // Jump to T_max helper
    const setTimeToMax = () => {
        if (analysis?.timeToMax) {
            const unitConv = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
            const bestUnit = getBestHalfLifeUnit(analysis.timeToMax);
            setTimeUnit(bestUnit);
            setTimeElapsed((analysis.timeToMax / unitConv[bestUnit]).toPrecision(4));
        }
    };

    const handleClearInputs = () => {
        setParentNuclide(null); setDaughterNuclide(null);
        setInitialActivity('100'); setInitialDaughterActivity('0');
        setBranchingFraction('1.0');
        setTimeElapsed('10'); setTimeUnit('days');
        setResult(null); setChartData(null); setError(''); setAnalysis(null);
    };

    return (
        <div className="p-4 animate-fade-in">
           <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <div className="flex justify-between items-center mb-4">
                   <h2 className="text-xl font-bold text-slate-800 dark:text-white">Equilibrium Analyzer</h2>
                   <ClearButton onClick={handleClearInputs} />
               </div>
               
               {/* --- PRESETS BAR --- */}
               <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                   {GENERATOR_PRESETS.map(preset => (
                       <button 
                           key={preset.p} 
                           onClick={() => handlePresetSelect(preset)}
                           className="px-3 py-1 text-xs bg-sky-100 dark:bg-sky-900 text-sky-700 dark:text-sky-200 rounded-full font-semibold hover:bg-sky-200 dark:hover:bg-sky-800 transition whitespace-nowrap"
                       >
                           Load {preset.label}
                       </button>
                   ))}
               </div>
               
               <div className="space-y-4">
                   <div>
                       <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Parent Nuclide</label>
                       <div className="mt-1 min-h-[42px]">
                           {parentNuclide ? 
                              <CalculatorNuclideInfo nuclide={parentNuclide} onClear={() => setParentNuclide(null)} /> 
                           : <SearchableSelect options={parentNuclides} onSelect={handleParentChange} placeholder="Search for a parent nuclide..."/>}
                       </div>
                   </div>

                   {analysis && (
                       <div className="p-4 bg-sky-50 dark:bg-sky-900/20 rounded-lg animate-fade-in border border-sky-100 dark:border-sky-800">
                            <h3 className="text-lg font-bold text-sky-600 dark:text-sky-400 mb-2">{analysis.type}</h3>
                           <p className="text-sm text-slate-600 dark:text-slate-300 mb-3">{analysis.message}</p>
                           
                           {(analysis.theoreticalRatio || analysis.timeToMax) && (
                               <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm border-t border-sky-200 dark:border-sky-800 pt-3">
                                   {analysis.theoreticalRatio && (
                                       <div><p className="font-semibold text-slate-500 dark:text-slate-400">Max Ratio (A₂/A₁):</p><p className="font-mono">{(analysis.theoreticalRatio * parseFloat(branchingFraction)).toFixed(4)}</p></div>
                                   )}
                                   {analysis.timeToEq && (
                                       <div><p className="font-semibold text-slate-500 dark:text-slate-400">Time to ~Equilibrium:</p><p className="font-mono">≈ {formatHalfLife(analysis.timeToEq.toString() + ' seconds', getBestHalfLifeUnit(analysis.timeToEq))}</p></div>
                                   )}
                                   {analysis.timeToMax && ( 
                                       <div className="col-span-1 sm:col-span-2 flex items-center justify-between mt-2 bg-white dark:bg-slate-800 p-2 rounded shadow-sm">
                                            <div>
                                                <p className="font-semibold text-sky-600 dark:text-sky-400">Time to Peak Daughter Activity:</p>
                                                <p className="font-mono font-bold">{formatHalfLife(analysis.timeToMax.toString() + ' seconds', getBestHalfLifeUnit(analysis.timeToMax))}</p>
                                            </div>
                                            <button onClick={setTimeToMax} className="text-xs px-3 py-1.5 bg-sky-600 text-white font-bold rounded hover:bg-sky-700 transition">Jump to Peak</button>
                                       </div> 
                                   )}
                               </div>
                           )}
                       </div>
                   )}

                   {parentNuclide && (
                       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                               <div>
                                    <label className="block text-sm font-medium">Initial Parent Activity</label>
                                    <div className="flex">
                                        <input type="number" value={initialActivity} onChange={e => setInitialActivity(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                                        <select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                                    </div>
                               </div>
                               <div>
                                    <label className="block text-sm font-medium">Initial Daughter Activity</label>
                                    <div className="flex">
                                        <input type="number" value={initialDaughterActivity} onChange={e => setInitialDaughterActivity(e.target.value)} className="w-full p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                                        <div className="flex items-center justify-center px-3 bg-slate-200 dark:bg-slate-600 rounded-r-md text-sm text-slate-500 dark:text-slate-300">{activityUnit}</div>
                                    </div>
                               </div>
                           </div>
                           
                           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                   <label className="block text-sm font-medium">Time Elapsed</label>
                                   <div className="flex gap-2 mt-1">
                                       <input type="number" value={timeElapsed} onChange={e => setTimeElapsed(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600" />
                                       <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                           {timeUnitsOrdered.map(u => <option key={u} value={u}>{u}</option>)}
                                       </select>
                                   </div>
                               </div>
                               <div>
                                   <Tooltip text="The fraction of parent decays that result in this daughter. Example: Mo-99 -> Tc-99m is ~0.875.">
                                        <label className="block text-sm font-medium cursor-help underline decoration-dotted">Branching Fraction (0-1)</label>
                                   </Tooltip>
                                   <input type="number" value={branchingFraction} onChange={e => setBranchingFraction(e.target.value)} step="0.01" min="0" max="1" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                               </div>
                           </div>
                       </div>
                   )}

                   {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                   
                   {result && (
                       <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg space-y-2">
                           <div className="flex justify-between items-center mb-2">
                               <p className="font-semibold text-center text-sm flex-grow">Activity at {timeElapsed} {timeUnit}</p>
                               <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                                   <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors -mr-2">
                                       <Icon path={ICONS.notepad} className="w-5 h-5" />
                                   </button>
                               </Tooltip>
                           </div>
                           
                           {/* Result Cards */}
                           <div className="grid grid-cols-2 gap-4">
                               <div className="p-2 bg-white dark:bg-slate-800 rounded shadow-sm text-center">
                                   <p className="text-xs text-slate-500">Parent ({result.parent.name})</p>
                                   <p className="font-bold text-sky-600 dark:text-sky-400">{result.parent.activity}</p>
                               </div>
                               <div className="p-2 bg-white dark:bg-slate-800 rounded shadow-sm text-center border-b-2 border-rose-500">
                                   <p className="text-xs text-slate-500">Daughter ({result.daughter.name})</p>
                                   <p className="font-bold text-rose-600 dark:text-rose-400">{result.daughter.activity}</p>
                               </div>
                           </div>
                           
                           <div className="text-center pt-2">
                                <span className="text-sm font-medium text-slate-600 dark:text-slate-300">Current Ratio (A₂/A₁): <span className="font-bold font-mono">{result.currentRatio}</span></span>
                           </div>
                       </div>
                   )}
                   
                   {chartData && (
                       <>
                           <div className="flex justify-end mt-4">
                               <label className="flex items-center gap-2 text-sm cursor-pointer">
                                   <input type="checkbox" checked={useLogScale} onChange={() => setUseLogScale(!useLogScale)} className="form-checkbox h-4 w-4 rounded text-sky-600" />
                                   Use Logarithmic Scale
                               </label>
                           </div>
                           <DecayChart chartData={chartData} useLogScale={useLogScale} theme={theme} />
                       </>
                   )}
               </div>
           </div>
        </div>
    );
};      
              
             /**
              * @description React component for a radon concentration-to-dose calculator and interconversion tool.
              * This tool allows users to convert between various units of radon concentration and to estimate
              * the annual dose received from a given exposure.
              *
              * It provides four different calculation modes:
              * 1.  **Dose from Concentration:** Estimates the annual dose based on radon concentration, equilibrium factor, and occupancy factor.
              * 2.  **Find Working Level (WL):** Calculates the Working Level from a given radon concentration and equilibrium factor.
              * 3.  **Find Concentration:** Calculates the radon concentration needed to produce a given Working Level, for a specified equilibrium factor.
              * 4.  **Find Equilibrium Factor:** Calculates the equilibrium factor based on a known concentration and Working Level.
              *
              * The module handles conversions between common units like **picocuries per liter (pCi/L)** and **becquerels per cubic meter (Bq/m³)**,
              * as well as the conversion to **Potential Alpha Energy Concentration (PAEC)** and finally to **Working Level Months (WLM)** and dose.
              *
              * @prop {string} calcMode - The active calculation mode ('doseFromConc', 'findWL', 'findConc', 'findEF').
              * @prop {function} setCalcMode - State setter for the calculation mode.
              * @prop {string} concentration - The radon concentration value.
              * @prop {function} setConcentration - State setter for concentration.
              * @prop {string} unit - The unit of concentration ('pCi/L' or 'Bq/m³').
              * @prop {function} setUnit - State setter for the unit.
              * @prop {string} equilibriumFactor - The equilibrium factor (F).
              * @prop {function} setEquilibriumFactor - State setter for the equilibrium factor.
              * @prop {string} workingLevel - The Working Level (WL) value.
              * @prop {function} setWorkingLevel - State setter for Working Level.
              * @prop {string} occupancyFactor - The occupancy factor.
              * @prop {function} setOccupancyFactor - State setter for the occupancy factor.
              * @prop {object} result - Object containing all calculated results.
              * @prop {function} setResult - State setter for the result object.
              * @prop {string} error - Any error message to display.
              * @prop {function} setError - State setter for error messages.
              */
              
// 1. Updated ConcentrationDoseModule (Added Visual Context Bar)
const ConcentrationDoseModule = ({ calcMode, setCalcMode, concentration, setConcentration, unit, setUnit, equilibriumFactor, setEquilibriumFactor, workingLevel, setWorkingLevel, occupancyFactor, setOccupancyFactor, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const { settings } = React.useContext(SettingsContext);
    
    const Bq_per_m3_in_pCi_per_L = 37; 
    const PAEC_J_per_m3_in_WL = 2.08e-5; 
    const dose_conversion_mrem_per_WLM = 500; // 10 CFR 20 Occupational

    React.useEffect(() => {
        localStorage.setItem('radon_calcMode', calcMode);
        localStorage.setItem('radon_concentration', concentration);
        localStorage.setItem('radon_unit', unit);
        localStorage.setItem('radon_equilibriumFactor', equilibriumFactor);
        localStorage.setItem('radon_workingLevel', workingLevel);
        localStorage.setItem('radon_occupancyFactor', occupancyFactor);
    }, [calcMode, concentration, unit, equilibriumFactor, workingLevel, occupancyFactor]);

    React.useEffect(() => {
        try {
            setError('');
            const conc_val = parseFloat(concentration); 
            const ef_val = parseFloat(equilibriumFactor); 
            const wl_val = parseFloat(workingLevel); 
            const of_val = parseFloat(occupancyFactor);

            let final_pCi_L, final_Bq_m3, final_WL, final_EF;

            switch(calcMode) {
                case 'doseFromConc':
                    if (isNaN(conc_val) || isNaN(ef_val)) throw new Error('Concentration and Equilibrium Factor must be numbers.');
                    final_pCi_L = unit === 'pCi/L' ? conc_val : conc_val / Bq_per_m3_in_pCi_per_L; 
                    final_EF = ef_val;
                    final_WL = (final_pCi_L / 100) * final_EF; 
                    if (workingLevel !== final_WL.toPrecision(3)) setWorkingLevel(final_WL.toPrecision(3));
                    break;
                case 'findWL':
                    if (isNaN(conc_val) || isNaN(ef_val)) throw new Error('Concentration and Equilibrium Factor must be numbers.');
                    final_pCi_L = unit === 'pCi/L' ? conc_val : conc_val / Bq_per_m3_in_pCi_per_L; 
                    final_EF = ef_val;
                    final_WL = (final_pCi_L / 100) * final_EF; 
                    setWorkingLevel(final_WL.toPrecision(3)); 
                    break;
                case 'findConc':
                    if (isNaN(wl_val) || isNaN(ef_val)) throw new Error('Working Level and Equilibrium Factor must be numbers.');
                    if (ef_val <= 0) throw new Error('Equilibrium Factor must be greater than zero.');
                    final_WL = wl_val; 
                    final_EF = ef_val; 
                    final_pCi_L = (final_WL * 100) / final_EF;
                    const final_conc_display = unit === 'pCi/L' ? final_pCi_L : final_pCi_L * Bq_per_m3_in_pCi_per_L;
                    setConcentration(final_conc_display.toPrecision(3)); 
                    break;
                case 'findEF':
                     if (isNaN(wl_val) || isNaN(conc_val)) throw new Error('Working Level and Concentration must be numbers.');
                     final_pCi_L = unit === 'pCi/L' ? conc_val : conc_val / Bq_per_m3_in_pCi_per_L;
                     if (final_pCi_L <= 0) throw new Error('Concentration must be greater than zero.');
                     final_WL = wl_val; 
                     final_EF = (final_WL * 100) / final_pCi_L;
                     setEquilibriumFactor(final_EF.toPrecision(3)); 
                     break;
                default: break;
            }

            if (isNaN(of_val)) throw new Error('Occupancy Factor must be a number.');
            
            final_Bq_m3 = final_pCi_L * Bq_per_m3_in_pCi_per_L;
            const paec_J_m3 = final_WL * PAEC_J_per_m3_in_WL; 
            const wlm_per_year = final_WL * (8760 * of_val) / 170;
            const annualDose_mrem = wlm_per_year * dose_conversion_mrem_per_WLM;

            setResult({ 
                pCi_L: final_pCi_L.toPrecision(3), 
                Bq_m3: final_Bq_m3.toPrecision(3), 
                workingLevels: final_WL.toPrecision(3), 
                equilibriumFactor: final_EF.toPrecision(3), 
                paec_J_m3: paec_J_m3.toExponential(2), 
                wlm_year: wlm_per_year.toPrecision(3), 
                annualDose: formatDoseValue(annualDose_mrem, 'dose', settings)
            });

        } catch (e) { setError(e.message); setResult(null); }
    }, [concentration, unit, equilibriumFactor, workingLevel, occupancyFactor, calcMode, setConcentration, setEquilibriumFactor, setWorkingLevel, setResult, setError, settings]);

    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ 
               id: Date.now(), 
               type: 'Radon Dose', 
               icon: ICONS.radon, 
               inputs: `${result.pCi_L} pCi/L, F=${result.equilibriumFactor}`, 
               result: `${result.annualDose.value} ${result.annualDose.unit}/yr`, 
               view: VIEWS.RADON 
           });
           addToast("Calculation saved to history!");
        }
    };

    const getHeroMetric = () => {
        if (!result) return null;
        switch (calcMode) {
            case 'findWL': return { label: 'Calculated Working Level', value: result.workingLevels, unit: 'WL' };
            case 'findConc': return unit === 'pCi/L' ? { label: 'Calculated Concentration', value: result.pCi_L, unit: 'pCi/L' } : { label: 'Calculated Concentration', value: result.Bq_m3, unit: 'Bq/m³' };
            case 'findEF': return { label: 'Calculated Equilibrium Factor', value: result.equilibriumFactor, unit: 'F' };
            case 'doseFromConc': default: return { label: 'Occupational Annual Dose', value: result.annualDose.value, unit: result.annualDose.unit, subtext: `(${result.wlm_year} WLM/year)` };
        }
    };

    const hero = getHeroMetric();
    
    // --- VISUAL CONTEXT BAR ---
    const getSafetyContext = (pCiL) => {
        const val = parseFloat(pCiL);
        if (val < 2.0) return { color: 'bg-green-500', width: '25%', label: 'Low' };
        if (val < 4.0) return { color: 'bg-yellow-400', width: '50%', label: 'Warning (2-4)' };
        return { color: 'bg-red-500', width: '100%', label: 'Action Level (>4)' };
    };
    const safety = result ? getSafetyContext(result.pCi_L) : null;

    return (
        <div className="space-y-4">
           <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
               <button onClick={() => setCalcMode('doseFromConc')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'doseFromConc' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dose from Conc.</button>
               <button onClick={() => setCalcMode('findWL')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findWL' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find WL</button>
               <button onClick={() => setCalcMode('findConc')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findConc' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find Concentration</button>
               <button onClick={() => setCalcMode('findEF')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'findEF' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Find Equilibrium</button>
           </div>
           
           <div className="space-y-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
               <div>
                   <label className="block text-sm font-medium">Radon Concentration</label>
                   <div className="flex">
                       <input type="number" value={concentration} onChange={e => setConcentration(e.target.value)} disabled={calcMode === 'findConc'} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700 disabled:bg-slate-200 dark:disabled:bg-slate-800" />
                       <select value={unit} onChange={e => setUnit(e.target.value)} disabled={calcMode === 'findConc'} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 disabled:opacity-50"><option>pCi/L</option><option>Bq/m³</option></select>
                   </div>
               </div>
               <div>
                   <Tooltip text="The fraction of radon progeny in equilibrium with the parent radon gas. 0.4 is a standard assumption for homes.">
                       <label className="block text-sm font-medium cursor-help underline decoration-dotted">Equilibrium Factor (F)</label>
                   </Tooltip>
                   <input type="number" value={equilibriumFactor} onChange={e => setEquilibriumFactor(e.target.value)} step="0.05" min="0" max="1" disabled={calcMode === 'findEF'} placeholder="e.g., 0.4" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 disabled:bg-slate-200 dark:disabled:bg-slate-800" />
               </div>
               <div>
                   <label className="block text-sm font-medium">Working Level (WL)</label>
                   <input type="number" value={workingLevel} onChange={e => setWorkingLevel(e.target.value)} disabled={calcMode === 'findWL' || calcMode === 'doseFromConc'} placeholder="e.g., 0.02" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 disabled:bg-slate-200 dark:disabled:bg-slate-800" />
               </div>
           </div>

           {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
           
           {result && (
               <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 animate-fade-in">
                   <div className="text-center pb-4 mb-4 border-b border-slate-300 dark:border-slate-600">
                        <div className="flex justify-between items-center -mt-2 -mb-2">
                            <div></div>
                            <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">{hero.label}</p>
                            <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                               <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                   <Icon path={ICONS.notepad} className="w-5 h-5" />
                               </button>
                            </Tooltip>
                        </div>
                        <div className="flex items-center justify-center mt-2">
                            <p className="text-4xl font-bold text-sky-600 dark:text-sky-400">{hero.value} <span className="text-2xl opacity-75">{hero.unit}</span></p>
                            <CopyButton textToCopy={hero.value} />
                        </div>
                        {hero.subtext && <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{hero.subtext}</p>}
                   </div>

                   {/* VISUAL CONTEXT BAR */}
                   <div className="mb-4">
                       <p className="text-xs font-semibold mb-1 text-slate-500 dark:text-slate-400">EPA Action Level Context (4.0 pCi/L)</p>
                       <div className="h-4 w-full bg-slate-200 dark:bg-slate-600 rounded-full overflow-hidden relative">
                           <div className={`h-full ${safety.color} transition-all duration-500`} style={{ width: safety.width }}></div>
                           {/* Marker line at 4 pCi/L */}
                           <div className="absolute top-0 bottom-0 w-0.5 bg-black dark:bg-white" style={{ left: '50%' }}></div>
                       </div>
                       <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                           <span>0</span>
                           <span className="font-bold">4.0 pCi/L</span>
                           <span>8.0+</span>
                       </div>
                   </div>

                   <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Calculation Details</h3>
                   <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                       {calcMode !== 'findConc' && ( <><span className="font-semibold text-slate-500 dark:text-slate-400">Concentration:</span><p className="font-mono text-right">{result.pCi_L} pCi/L</p></> )}
                       {calcMode !== 'findEF' && ( <><span className="font-semibold text-slate-500 dark:text-slate-400">Equilibrium (F):</span><p className="font-mono text-right">{result.equilibriumFactor}</p></> )}
                       {calcMode !== 'findWL' && calcMode !== 'doseFromConc' && ( <><span className="font-semibold text-slate-500 dark:text-slate-400">Working Level:</span><p className="font-mono text-right">{result.workingLevels}</p></> )}
                       <span className="font-semibold text-slate-500 dark:text-slate-400">PAEC:</span><p className="font-mono text-right">{result.paec_J_m3} J/m³</p>
                   </div>
                   <div className="flex justify-end items-center mt-2 gap-2 pt-2 border-t border-slate-300 dark:border-slate-600">
                       <label className="text-xs text-slate-500 dark:text-slate-400">Occupancy Factor:</label>
                       <input type="number" value={occupancyFactor} onChange={e => setOccupancyFactor(e.target.value)} step="0.05" min="0" max="1" className="w-16 p-1 text-xs rounded bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600" />
                   </div>
               </div>
           )}
        </div>
    );
};

// 2. Updated RadonIngrowthCalculator (Added Leakage Note)
const RadonIngrowthCalculator = ({ result, setResult, error, setError, amount, setAmount, unit, setUnit, time, setTime, timeUnit, setTimeUnit }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const { settings } = React.useContext(SettingsContext);

    const RA226_SPECIFIC_ACTIVITY_BQ_PER_G = 3.66e10; 
    const RN222_HALFLIFE_SECONDS = 3.8235 * 24 * 3600;
    const RN222_LAMBDA_PER_SECOND = Math.log(2) / RN222_HALFLIFE_SECONDS;
    
    const massFactors_g = { 'ng': 1e-9, 'µg': 1e-6, 'mg': 1e-3, 'g': 1 };
    const activityFactors_Bq = { 'Bq': 1, 'kBq': 1e3, 'MBq': 1e6, 'GBq': 1e9, 'µCi': 37000, 'mCi': 3.7e7, 'Ci': 3.7e10 };
    const timeUnits = { 'minutes': 60, 'hours': 3600, 'days': 86400, 'weeks': 604800 };

    React.useEffect(() => {
        try {
            setError('');
            const val = parseFloat(amount);
            const t_val = parseFloat(time);

            if (isNaN(val) || val <= 0 || isNaN(t_val) || t_val < 0) {
                if(amount && time) setError("Inputs must be positive numbers.");
                setResult(null); return;
            }

            let ra226_activity_Bq = 0;
            const isMass = Object.keys(massFactors_g).includes(unit);

            if (isMass) {
                const mass_g = val * massFactors_g[unit];
                ra226_activity_Bq = mass_g * RA226_SPECIFIC_ACTIVITY_BQ_PER_G;
            } else {
                ra226_activity_Bq = val * (activityFactors_Bq[unit] || 0);
            }

            const time_s = t_val * (timeUnits[timeUnit] || 0);
            
            const rn222_activity_Bq = ra226_activity_Bq * (1 - Math.exp(-RN222_LAMBDA_PER_SECOND * time_s));
            const percentEquilibrium = (rn222_activity_Bq / ra226_activity_Bq) * 100;

            const configKey = settings.unitSystem === 'si' ? 'activity_si' : 'activity_conventional';
            
            const ra226_base = settings.unitSystem === 'si' ? ra226_activity_Bq : ra226_activity_Bq / 3.7e10;
            const rn222_base = settings.unitSystem === 'si' ? rn222_activity_Bq : rn222_activity_Bq / 3.7e10;

            setResult({
                ra226_activity: formatSensibleUnit(ra226_base, configKey),
                rn222_activity: formatSensibleUnit(rn222_base, configKey),
                percentEquilibrium: percentEquilibrium.toFixed(2)
            });

        } catch (e) { setError("Calculation failed."); setResult(null); }
    }, [amount, unit, time, timeUnit, settings.unitSystem]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Radon Ingrowth', icon: ICONS.radon, inputs: `${amount} ${unit} Ra-226, ${time} ${timeUnit}`, result: `${result.rn222_activity.value} ${result.rn222_activity.unit} Rn-222`, view: VIEWS.RADON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
        <div className="space-y-4">
            <ContextualNote type="info">
                <strong>Assumptions:</strong> Calculates theoretical max ingrowth in a hermetically sealed container. Actual levels will be lower if the container leaks Rn-222 gas.
            </ContextualNote>
            
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div>
                    <label className="block text-sm font-medium">Source Quantity</label>
                    <div className="flex">
                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                        <select value={unit} onChange={e => setUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">
                            <optgroup label="Mass">{Object.keys(massFactors_g).map(u => <option key={u} value={u}>{u}</option>)}</optgroup>
                            <optgroup label="Activity">{(settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq'] : ['µCi', 'mCi', 'Ci']).map(u => <option key={u} value={u}>{u}</option>)}</optgroup>
                        </select>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium">Ingrowth Time</label>
                    <div className="flex">
                        <input type="number" value={time} onChange={e => setTime(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                        <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(timeUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
                    </div>
                </div>
            </div>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
                <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 text-center animate-fade-in">
                      <div className="flex justify-between items-center -mt-2 -mb-2">
                        <div></div>
                        <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Resulting Rn-222 Activity</p>
                        <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                           <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                               <Icon path={ICONS.notepad} className="w-5 h-5" />
                           </button>
                        </Tooltip>
                      </div>
                    <div className="flex items-center justify-center mt-2">
                        <p className="text-4xl font-bold text-sky-600 dark:text-sky-400">{result.rn222_activity.value} <span className="text-2xl opacity-75">{result.rn222_activity.unit}</span></p>
                        <CopyButton textToCopy={result.rn222_activity.value} />
                    </div>
                    <p className="text-sm font-medium text-slate-600 dark:text-slate-300 mt-2">Parent Activity: {result.ra226_activity.value} {result.ra226_activity.unit}</p>
                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">({result.percentEquilibrium}% of secular equilibrium)</p>
                </div>
            )}
        </div>
    );
};

// 3. Updated KusnetzCalculator (Hard Validation)
const KusnetzCalculator = ({ flowRate, setFlowRate, sampleTime, setSampleTime, delayTime, setDelayTime, grossCounts, setGrossCounts, countDuration, setCountDuration, backgroundCpm, setBackgroundCpm, efficiency, setEfficiency, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const KUSNETZ_FACTORS = { 40: 150, 45: 138, 50: 128, 55: 119, 60: 112, 65: 105, 70: 100, 75: 95, 80: 90, 85: 86, 90: 82 };
    
    React.useEffect(() => {
        localStorage.setItem('kusnetz_flowRate', flowRate); localStorage.setItem('kusnetz_sampleTime', sampleTime); localStorage.setItem('kusnetz_delayTime', delayTime);
        localStorage.setItem('kusnetz_grossCounts', grossCounts); localStorage.setItem('kusnetz_countDuration', countDuration);
        localStorage.setItem('kusnetz_backgroundCpm', backgroundCpm); localStorage.setItem('kusnetz_efficiency', efficiency);
    }, [flowRate, sampleTime, delayTime, grossCounts, countDuration, backgroundCpm, efficiency]);
    
    const interpolate = (x, points) => {
        const keys = Object.keys(points).map(Number).sort((a, b) => a - b);
        if (x <= keys[0]) return points[keys[0]]; if (x >= keys[keys.length - 1]) return points[keys[keys.length - 1]];
        const x1 = Math.max(...keys.filter(k => k <= x)); const x2 = Math.min(...keys.filter(k => k > x));
        const y1 = points[x1]; const y2 = points[x2];
        return y1 + (y2 - y1) * (x - x1) / (x2 - x1);
    };
    
    React.useEffect(() => {
        try {
           setError('');
           const params = { V_flow: parseFloat(flowRate), T_sample: parseFloat(sampleTime), T_delay: parseFloat(delayTime), C_gross: parseFloat(grossCounts), T_count: parseFloat(countDuration), cpm_bkg: parseFloat(backgroundCpm), eff: parseFloat(efficiency) };
           
           if (Object.values(params).some(isNaN) || params.V_flow <= 0 || params.T_sample <= 0 || params.T_delay <= 0 || params.eff <= 0) {
               if (Object.values(params).every(p => p || p === 0)) setError("Please enter valid positive numbers.");
               setResult(null); return;
           }

           // --- VALIDATION: Hard Stop for Invalid Time ---
           if (params.T_delay < 40 || params.T_delay > 90) {
               setError("Delay time must be between 40 and 90 minutes for the Kusnetz Method.");
               setResult(null);
               return;
           }

           const totalVolume_L = params.V_flow * params.T_sample;
           const gross_cpm = params.C_gross / params.T_count;
           const net_cpm = gross_cpm - params.cpm_bkg;
           const k_factor = interpolate(params.T_delay, KUSNETZ_FACTORS);
           const workingLevel = net_cpm / (k_factor * (params.eff / 100) * totalVolume_L);
           
           setResult({ workingLevel: workingLevel.toPrecision(3), k_factor: k_factor.toFixed(1), totalVolume_L: totalVolume_L.toPrecision(3), net_cpm: net_cpm.toPrecision(3) });
        } catch (e) { setError("Calculation error."); setResult(null); }
    }, [flowRate, sampleTime, delayTime, grossCounts, countDuration, backgroundCpm, efficiency, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Kusnetz Method (WL)', icon: ICONS.radon, inputs: `Delay: ${delayTime} min, Vol: ${result.totalVolume_L} L`, result: `${result.workingLevel} WL`, view: VIEWS.RADON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
        <div className="space-y-4">
           <p className="text-sm text-slate-600 dark:text-slate-400">Determine the Working Level (WL) of radon progeny.</p>
           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
               <div className="grid grid-cols-2 gap-4">
                   <div><label className="block text-sm font-medium">Flow Rate (LPM)</label><input type="number" value={flowRate} onChange={e => setFlowRate(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                   <div><label className="block text-sm font-medium">Sample Time (min)</label><input type="number" value={sampleTime} onChange={e => setSampleTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                   <div><label className="block text-sm font-medium">Gross Counts</label><input type="number" value={grossCounts} onChange={e => setGrossCounts(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                   <div><label className="block text-sm font-medium">Count Duration (min)</label><input type="number" value={countDuration} onChange={e => setCountDuration(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                   <div><label className="block text-sm font-medium">Background (cpm)</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
                   <div><label className="block text-sm font-medium">Alpha Efficiency (%)</label><input type="number" value={efficiency} onChange={e => setEfficiency(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
               </div>
               <div><Tooltip text="Time between end-of-sampling and start-of-count. Standard method requires 40-90 mins."><label className="block text-sm font-medium">Delay Time (minutes)</label></Tooltip><input type="number" value={delayTime} onChange={e => setDelayTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" /></div>
           </div>
           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           {result && (
               <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in space-y-3">
                   <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                       <span className="font-semibold text-slate-600 dark:text-slate-300">Net Count Rate:</span><span className="font-mono text-right">{result.net_cpm} cpm</span>
                       <span className="font-semibold text-slate-600 dark:text-slate-300">Total Air Volume:</span><span className="font-mono text-right">{result.totalVolume_L} L</span>
                       <span className="font-semibold text-slate-600 dark:text-slate-300">Interpolated K Factor:</span><span className="font-mono text-right">{result.k_factor}</span>
                   </div>
                   <div className="text-center pt-3 border-t border-slate-300 dark:border-slate-600">
                       <div className="flex justify-between items-center -mt-2 -mb-2">
                           <div></div>
                           <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">Calculated Progeny Concentration</p>
                           <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                              <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                                  <Icon path={ICONS.notepad} className="w-5 h-5" />
                              </button>
                           </Tooltip>
                       </div>
                       <p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.workingLevel}</p>
                       <p className="text-md font-medium text-slate-600 dark:text-slate-300">Working Levels (WL)</p>
                   </div>
               </div>
           )}
        </div>
    );
};

/**
 * @description The main container for the Radon Tools suite.
 * It manages the shared state for the sub-calculators and handles tab navigation.
 */
const RadonCalculator = ({ onNavClick }) => {
    const { settings } = React.useContext(SettingsContext);
    const [activeTab, setActiveTab] = React.useState('concentration');
    
    const isSI = settings.unitSystem === 'si';
    
    // --- 1. Concentration Tab State ---
    const [conc_calcMode, setConc_calcMode] = React.useState(() => localStorage.getItem('radon_calcMode') || 'doseFromConc');
    const [conc_concentration, setConc_concentration] = React.useState(() => localStorage.getItem('radon_concentration') || '4');
    const [conc_unit, setConc_unit] = React.useState(() => {
        const saved = localStorage.getItem('radon_unit');
        return saved || (isSI ? 'Bq/m³' : 'pCi/L');
    });
    const [conc_equilibriumFactor, setConc_equilibriumFactor] = React.useState(() => localStorage.getItem('radon_equilibriumFactor') || '0.4');
    const [conc_workingLevel, setConc_workingLevel] = React.useState(() => localStorage.getItem('radon_workingLevel') || '0.02');
    const [conc_occupancyFactor, setConc_occupancyFactor] = React.useState(() => localStorage.getItem('radon_occupancyFactor') || '1');
    const [conc_result, setConc_result] = React.useState(null);
    const [conc_error, setConc_error] = React.useState('');
    
    // --- 2. Ingrowth Tab State ---
    const [ingrowth_amount, setIngrowth_amount] = React.useState('1');
    const [ingrowth_unit, setIngrowth_unit] = React.useState('µg'); 
    const [ingrowth_time, setIngrowth_time] = React.useState('30');
    const [ingrowth_timeUnit, setIngrowth_timeUnit] = React.useState('days');
    const [ingrowth_result, setIngrowth_result] = React.useState(null);
    const [ingrowth_error, setIngrowth_error] = React.useState('');
    
    // --- 3. Kusnetz Tab State ---
    const [kusnetz_flowRate, setKusnetz_flowRate] = React.useState(() => localStorage.getItem('kusnetz_flowRate') || '2');
    const [kusnetz_sampleTime, setKusnetz_sampleTime] = React.useState(() => localStorage.getItem('kusnetz_sampleTime') || '5');
    const [kusnetz_delayTime, setKusnetz_delayTime] = React.useState(() => localStorage.getItem('kusnetz_delayTime') || '40');
    const [kusnetz_grossCounts, setKusnetz_grossCounts] = React.useState(() => localStorage.getItem('kusnetz_grossCounts') || '100');
    const [kusnetz_countDuration, setKusnetz_countDuration] = React.useState(() => localStorage.getItem('kusnetz_countDuration') || '1');
    const [kusnetz_backgroundCpm, setKusnetz_backgroundCpm] = React.useState(() => localStorage.getItem('kusnetz_backgroundCpm') || '0');
    const [kusnetz_efficiency, setKusnetz_efficiency] = React.useState(() => localStorage.getItem('kusnetz_efficiency') || '30');
    const [kusnetz_result, setKusnetz_result] = React.useState(null);
    const [kusnetz_error, setKusnetz_error] = React.useState('');

    // Auto-switch units if system setting changes
    React.useEffect(() => {
        if (isSI) {
            if (conc_unit === 'pCi/L') setConc_unit('Bq/m³');
            if (['µCi', 'mCi', 'Ci'].includes(ingrowth_unit)) setIngrowth_unit('kBq');
        } else {
            if (conc_unit === 'Bq/m³') setConc_unit('pCi/L');
            if (['Bq', 'kBq', 'MBq', 'GBq'].includes(ingrowth_unit)) setIngrowth_unit('µCi');
        }
    }, [isSI]);

    const handleClearActiveCalculator = () => {
        if (activeTab === 'concentration') {
            setConc_concentration('4'); setConc_unit(isSI ? 'Bq/m³' : 'pCi/L'); 
            setConc_equilibriumFactor('0.4'); setConc_workingLevel('0.02'); 
            setConc_occupancyFactor('1'); setConc_result(null); setConc_error('');
        } else if (activeTab === 'ingrowth') {
            setIngrowth_amount('1'); setIngrowth_unit('µg'); setIngrowth_time('30');
            setIngrowth_result(null); setIngrowth_error('');
        } else {
            setKusnetz_flowRate('2'); setKusnetz_sampleTime('5'); setKusnetz_delayTime('40');
            setKusnetz_grossCounts('100'); setKusnetz_countDuration('1'); setKusnetz_backgroundCpm('0');
            setKusnetz_efficiency('30'); setKusnetz_result(null); setKusnetz_error('');
        }
    };

    return (
        <div className="p-4 animate-fade-in">
          <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
              <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold text-slate-800 dark:text-white">Radon Tools</h2>
                  <button onClick={handleClearActiveCalculator} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold flex items-center gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-3 h-3"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                      Clear Inputs
                  </button>
              </div>
              <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                  <button onClick={() => setActiveTab('concentration')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'concentration' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Concentration</button>
                  <button onClick={() => setActiveTab('ingrowth')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'ingrowth' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Ingrowth</button>
                  <button onClick={() => setActiveTab('kusnetz')} className={`w-1/3 p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'kusnetz' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Kusnetz (WL)</button>
              </div>
              
              {activeTab === 'concentration' && 
                  <ConcentrationDoseModule 
                      calcMode={conc_calcMode} setCalcMode={setConc_calcMode}
                      concentration={conc_concentration} setConcentration={setConc_concentration}
                      unit={conc_unit} setUnit={setConc_unit}
                      equilibriumFactor={conc_equilibriumFactor} setEquilibriumFactor={setConc_equilibriumFactor}
                      workingLevel={conc_workingLevel} setWorkingLevel={setConc_workingLevel}
                      occupancyFactor={conc_occupancyFactor} setOccupancyFactor={setConc_occupancyFactor}
                      result={conc_result} setResult={setConc_result}
                      error={conc_error} setError={setConc_error}
                  />
              }
              
              {activeTab === 'ingrowth' &&
                  <RadonIngrowthCalculator
                      amount={ingrowth_amount} setAmount={setIngrowth_amount}
                      unit={ingrowth_unit} setUnit={setIngrowth_unit}
                      time={ingrowth_time} setTime={setIngrowth_time}
                      timeUnit={ingrowth_timeUnit} setTimeUnit={setIngrowth_timeUnit}
                      result={ingrowth_result} setResult={setIngrowth_result}
                      error={ingrowth_error} setError={setIngrowth_error}
                  />
              }

              {activeTab === 'kusnetz' && 
                  <KusnetzCalculator 
                      flowRate={kusnetz_flowRate} setFlowRate={setKusnetz_flowRate}
                      sampleTime={kusnetz_sampleTime} setSampleTime={setKusnetz_sampleTime}
                      delayTime={kusnetz_delayTime} setDelayTime={setKusnetz_delayTime}
                      grossCounts={kusnetz_grossCounts} setGrossCounts={setKusnetz_grossCounts}
                      countDuration={kusnetz_countDuration} setCountDuration={setKusnetz_countDuration}
                      backgroundCpm={kusnetz_backgroundCpm} setBackgroundCpm={setKusnetz_backgroundCpm}
                      efficiency={kusnetz_efficiency} setEfficiency={setKusnetz_efficiency}
                      result={kusnetz_result} setResult={setKusnetz_result}
                      error={kusnetz_error} setError={setKusnetz_error}
                  />
              }
          </div>
        </div>
    );
};

             /**
              * @description React component for displaying the application's user manual, FAQ, and technical reference.
              * This component functions as a modal dialog that presents static, detailed information about the
              * "Health Physics Toolbox" application.
              *
              * The manual content is an in-depth guide covering:
              * - **Getting Started:** How to search for and view radionuclide data.
              * - **Core Features:** A comprehensive breakdown of each major section of the app (Database, Compare, Calculators).
              * - **Settings & Customization:** How to configure user preferences.
              * - **Formulas & Equations:** A reference section detailing the key mathematical formulas used in various calculators.
              * - **Contact & Copyright:** Information for user feedback and legal disclaimers.
              * - **FAQ:** Answers to common questions, such as the source of the data and why certain nuclides may not appear in specific calculators.
              *
              * This component is purely for display and serves as the primary source of documentation for the user.
              *
              * @prop {boolean} isOpen - Boolean to control the visibility of the modal.
              * @prop {function} onClose - A callback function to close the modal.
              */
              
const ManualModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;

    // Internal component for the static content of the manual
    const ManualContent = () => {
        return (
            <div className="prose prose-slate dark:prose-invert max-w-none p-6 text-slate-700 dark:text-slate-300">
                <h1 className="text-slate-900 dark:text-slate-100"><strong>User Manual & FAQ</strong></h1>
                <p>
                    Welcome to the Health Physics Toolbox! This application is designed to be a comprehensive, all-in-one resource for students, health physicists, and nuclear professionals. Our philosophy is to centralize the essential data and calculations you need, removing the reliance on scattered spreadsheets, outdated software, or manual lookups. This guide will walk you through the various features to help you get the most out of the tool.
                </p>

                <hr className="my-4" />

                <h2 className="text-slate-900 dark:text-slate-100"><strong>Getting Started: Finding a Nuclide</strong></h2>
                <p>
                    The primary function of the tool is to look up detailed information on a specific radionuclide. The search bar at the top of the page is your main entry point.
                </p>
                <h4 className="italic mt-4">Searching</h4>
                <p>
                    You can search by either the nuclide's full name (e.g., <code>"Cesium-137"</code>) or its symbol (e.g., <code>"Cs-137"</code>). The search is flexible and ignores spaces or hyphens, so <code>"cs137"</code> will also work. As you type, a list of the top 10 suggestions will appear, prioritized by how common the nuclide is, to help you find what you're looking for faster.
                </p>
                <h4 className="italic mt-4">The Nuclide Card</h4>
                <p>
                    Once you select a nuclide, its detailed information card is displayed. This card is a comprehensive summary, containing key data points grouped into logical sections like **Decay Properties**, **Physical Properties**, **Genealogy**, **Transportation Limits**, **Internal Dosimetry**, and **Principal Emissions**. You can add a nuclide to your persistent <strong>Favorites</strong> list by clicking the star icon in the top right, making it easily accessible from the home page.
                </p>

                <hr className="my-4" />

                <h2 className="text-slate-900 dark:text-slate-100"><strong>Core Features</strong></h2>
                <p>The main navigation bar provides access to all the specialized tools and views within the application.</p>

                <h3 className="mt-6"><strong>Database & Compare</strong></h3>
                <ul>
                    <li><strong>Database:</strong> This view is for discovery and exploration. It allows you to browse and sort the entire collection of radionuclides. The sidebar on the left provides a powerful set of filters to help you find nuclides with specific properties, such as category, emission type, half-life, and energy ranges. This is perfect for finding the right nuclide for a specific application.</li>
                    <li><strong>Compare:</strong> This tool is designed for nuanced analysis, allowing you to view multiple nuclides in a side-by-side table. This is especially useful for comparing similar candidates for a task, such as different isotopes for brachytherapy or medical imaging. The table automatically highlights the minimum and maximum values in each numerical row and displays in-cell data bars to provide an immediate visual sense of magnitude. This view also includes an <strong>Export to CSV</strong> function.</li>
                </ul>

                <h3 className="mt-6"><strong>Calculators</strong></h3>
                <p>The application includes a comprehensive suite of calculators for a wide range of radiological scenarios.</p>

                <h4 className="italic mt-4">Decay Calculators</h4>
                <p>This group of tools handles the physics of radioactive decay over time.</p>
                <ul>
                    <li><strong>Decay Tools:</strong> A multi-tool for fundamental decay calculations. The <strong>Standard</strong> tab solves the fundamental decay equation for any one variable (initial activity, remaining activity, or time). The <strong>Correction</strong> tab is a specialized tool for correcting a source's activity from its calibration date to a new date. The <strong>To Limit</strong> tab calculates the time required for a source to decay to a specific activity level, which is useful for waste management.</li>
                    <li><strong>Series Decay:</strong> This advanced tool uses the full Bateman equations to model the activity of <em>every</em> nuclide in a long decay chain (like the Uranium or Thorium series) over time. It provides both a final activity table and an interactive chart showing the in-growth and decay of each progeny, which is essential for understanding complex decay dynamics.</li>
                    <li><strong>Equilibrium:</strong> This calculator specifically analyzes a parent-daughter pair to determine their equilibrium relationship. It will automatically classify the relationship as <strong>Secular</strong> (parent half-life is much longer than daughter's) or <strong>Transient</strong> (parent half-life is longer, but not by a huge margin) and calculates important metrics like the time to maximum daughter activity.</li>
                </ul>
                
                <h4 className="italic mt-4">Dose & Shielding Calculators</h4>
                <p>These tools are for external dosimetry, helping to estimate radiation dose and the shielding required to reduce it.</p>
                <ul>
                    <li><strong>Dose & Dose Rate:</strong> A versatile tool with multiple modes. <strong>Gamma</strong> mode models dose from Point, Line, and Area (Disk) geometries. <strong>Beta</strong> mode includes two sub-calculators: Skin Dose from surface contamination and Dose in Air from a point source. <strong>Bremsstrahlung</strong> mode estimates the secondary X-ray dose produced when beta particles are stopped by shielding. <strong>Internal</strong> mode calculates the Committed Effective Dose Equivalent (CEDE) from an intake using 10 CFR 20 ALI values.</li>
                    <li><strong>Shielding:</strong> This calculator models the attenuation of radiation. The <strong>Gamma</strong> modes calculate the final dose rate after passing through a shield or the required shield thickness to reach a target dose rate. It includes an optional Buildup Factor correction for a more accurate result in broad beam geometries. The <strong>Beta Range</strong> mode calculates the thickness of low-Z material required to completely stop beta particles.</li>
                    <li><strong>Stay Time:</strong> A practical tool for ALARA planning. It calculates the maximum time a person can stay in an area with a known dose rate before accumulating a specific dose limit.</li>
                </ul>

                <h4 className="italic mt-4">Operational HP Tools</h4>
                <p>A suite of calculators designed for day-to-day radiation safety tasks and survey analysis.</p>
                <ul>
                   <li><strong>Surface Contamination:</strong> A comprehensive tool that calculates both removable contamination (from a wipe test) and total contamination (from a static probe survey). It automatically compares the results against the standard limits found in both NRC Regulatory Guide 1.86 and ANSI N13.12.</li>
                   <li><strong>Leak Test:</strong> A specialized version of the wipe survey calculator for evaluating sealed sources against the common 0.005 µCi regulatory limit for removable contamination.</li>
                   <li><strong>Airborne Release:</strong> This tool models a theoretical airborne release in a room to calculate the initial concentration in DAC (Derived Air Concentration) units. It also estimates the time required for the room's ventilation system (in Air Changes per Hour) to reduce the concentration back down to 1 DAC.</li>
                   <li><strong>Detector Response:</strong> Estimates the count rate (cpm) a detector would see from a source, accounting for geometry, efficiency, and shielding. Includes models for NaI(Tl) and GM probes.</li>
                </ul>

                {/* --- NEW SECTION: Medical Physics --- */}
                <h4 className="italic mt-4">Medical Physics Tools</h4>
                <p>Calculators tailored to scenarios commonly found in a medical or hospital environment.</p>
                <ul>
                   <li><strong>X-Ray Shielding:</strong> A screening tool to calculate the required thickness of lead, concrete, or drywall for diagnostic X-ray rooms. It is based on the NCRP Report No. 147 methodology, accounting for workload, use factor, occupancy, and distance.</li>
                   <li><strong>Patient Release:</strong> This tool helps determine if a patient administered with a radiopharmaceutical can be released from the hospital based on the criteria in 10 CFR 35.75. It checks against activity-based limits, dose-rate limits, or a full public dose calculation (TEDE) based on occupancy scenarios.</li>
                </ul>

                {/* --- NEW SECTION: Neutron Tools --- */}
                <h4 className="italic mt-4">Neutron Tools</h4>
                <p>A set of specialized calculators for dealing with neutron radiation, a common consideration in reactor and accelerator facilities.</p>
                <ul>
                   <li><strong>Fluence/Dose:</strong> Converts between neutron fluence (n/cm²) and dose equivalent (rem or Sv) for a given neutron energy. The conversion is performed using a log-log interpolation of the quality factors and fluence-per-rem data specified in 10 CFR 20.</li>
                   <li><strong>Activation:</strong> Calculates the activity of a product nuclide created by irradiating a specific target material in a known thermal neutron flux for a given amount of time. It includes both a database of common (n,γ) reactions and a manual input mode for custom scenarios.</li>
                   <li><strong>Composite Activation:</strong> Estimates the principal activation products from irradiating common composite materials like concrete or steel, which contain trace elements that can become significant activation products.</li>
                   <li><strong>Shielding:</strong> Estimates the attenuation of fast or thermal neutrons through various common shielding materials using approximate Half-Value Layer (HVL) data.</li>
                </ul>

                {/* --- NEW SECTION: MARSSIM --- */}
                <h4 className="italic mt-4">MARSSIM Tools</h4>
                <p>A suite of tools dedicated to planning and evaluating final status surveys according to the Multi-Agency Radiation Survey and Site Investigation Manual.</p>
                <ul>
                    <li><strong>MDA/MDC:</strong> Calculates key decision values for radiation counting instrumentation. It includes a mode for <strong>Static Count MDA</strong> (based on NUREG-1507) and <strong>Scan Survey MDC</strong> (based on MARSSIM formulas) to ensure your survey methods can detect contamination at the required levels.</li>
                    <li><strong>Sample Design:</strong> A two-part suite. The <strong>Calculator</strong> determines the required number of statistical samples for a survey unit using the Wilcoxon Rank Sum (WRS) test methodology. The <strong>Drawing Tool</strong> provides an interactive map to draw survey unit boundaries and automatically generate sample locations in a square grid, triangular grid, or random pattern.</li>
                    <li><strong>Statistical Tests:</strong> Performs the two primary MARSSIM statistical tests on a set of data. The <strong>WRS Test</strong> is used to compare a survey unit to a reference area to determine if it meets the release criteria. The <strong>EMC Sign Test</strong> is used for evaluating localized areas of elevated activity to ensure they are not a significant risk.</li>
                </ul>

                {/* --- NEW SECTION: Lab Stats --- */}
                <h4 className="italic mt-4">Lab Statistics & QA/QC</h4>
                <p>Tools for quality assurance and control of radiation counting equipment and laboratory processes.</p>
                <ul>
                   <li><strong>Chi-Squared (χ²) Test:</strong> This is a key performance test for a counting system. It performs a chi-squared test on a set of repeated counts of a stable source to check if the observed variance is consistent with a random Poisson distribution, ensuring the detector is functioning properly.</li>
                   <li><strong>Dead Time Correction:</strong> Corrects an observed count rate for counts that were missed due to detector dead time—the brief period after detecting a particle when the system is busy and cannot register another. This is crucial for accurate measurements at high count rates.</li>
                   <li><strong>RPD:</strong> Calculates the Relative Percent Difference between two duplicate samples to evaluate measurement precision and the reproducibility of your lab processes.</li>
                   <li><strong>FWHM / Resolution:</strong> Calculates a detector's Full Width at Half Maximum (FWHM) and energy resolution from a photopeak's properties (centroid and half-max energies). This is a fundamental measure of a gamma spectroscopy system's performance.</li>
                </ul>
                
                <h4 className="italic mt-4">Utility Tools</h4>
                <p>A collection of helpful tools to streamline your workflow.</p>
                <ul>
                    <li><strong>Peak Identifier:</strong> An essential tool for spectroscopy. The <strong>Search</strong> tab finds matching radionuclides for a given peak energy and tolerance. It also analyzes for common spectral artifacts like Compton Edges, escape peaks, and lead X-rays. The <strong>Data Tables</strong> tab provides a comprehensive, sortable, and filterable list of all alpha, beta, and gamma emissions in the database.</li>
                    <li><strong>Activity/Mass Tools:</strong> A three-in-one module. <strong>Mass ↔ Activity</strong> converts between a nuclide's mass and its activity using its specific activity. <strong>Activity from Dose</strong> calculates a source's activity based on a gamma dose rate measurement. <strong>Specific Activity</strong> is a first-principles calculator for determining a nuclide's SA (Bq/g) from its atomic weight and half-life.</li>
                    <li><strong>Radon Tools:</strong> A three-part suite for radon analysis. <strong>Concentration</strong> converts between radon concentration units (e.g., pCi/L and Bq/m³) and estimates annual dose. <strong>Ingrowth</strong> calculates the Rn-222 activity from a given mass of its parent, Ra-226. <strong>Kusnetz (WL)</strong> determines the Working Level of radon progeny from air sampling data.</li>
                    <li><strong>Transportation:</strong> Determines the required shipping package type (Excepted, Type A, or Type B) for a given radionuclide and activity, based on its IAEA A₁ (special form) and A₂ (normal form) values.</li>
                    <li><strong>Converter:</strong> A general-purpose unit converter for activity, dose, dose rate, energy, concentration, and other common physical units.</li>
                    <li><strong>Scratchpad:</strong> A persistent text area for jotting down notes or intermediate results. Notes are saved to your browser's local storage.</li>
                    <li><strong>Scientific Calculator:</strong> A professional-grade calculator with "Smart Start" (operators apply to previous answer), memory functions, scientific notation (`EXP`), and quick-insert buttons for physics constants.</li>
                </ul>

                <hr className="my-4" />

                <h2 className="text-slate-900 dark:text-slate-100"><strong>Formulas & Equations Reference</strong></h2>

                <h3 className="mt-6"><b>Decay & Activity Formulas</b></h3>
                <h4 className="italic mt-4">Radioactive Decay</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>A(t) = A₀ · e<sup>-λt</sup></pre>
                </div>
                <ul>
                    <li><code>A(t)</code> = Activity at time t</li>
                    <li><code>A₀</code> = Initial activity at t=0</li>
                    <li><code>λ</code> = Decay constant (ln(2) / T<sub>1/2</sub>)</li>
                    <li><code>t</code> = Elapsed time</li>
                </ul>

                <h4 className="italic mt-4">Series (Bateman) Decay for a 2-step chain (A → B)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>A₂(t) = [A₁(0)·λ₂/(λ₂-λ₁)]·[e<sup>-λ₁t</sup> - e<sup>-λ₂t</sup>] + A₂(0)e<sup>-λ₂t</sup></pre>
                </div>
                 <ul>
                    <li><code>A₂(t)</code> = Activity of the daughter at time t</li>
                    <li><code>A₁(0)</code> = Initial activity of the parent</li>
                    <li><code>A₂(0)</code> = Initial activity of the daughter</li>
                    <li><code>λ₁</code>, <code>λ₂</code> = Decay constants for parent and daughter, respectively</li>
                </ul>

                <h4 className="italic mt-4">Specific Activity (SA)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>SA (Bq/g) = (Nₐ · λ) / Mₐ</pre>
                </div>
                <ul>
                    <li><code>Nₐ</code> = Avogadro's Number (6.022 x 10²³ atoms/mol)</li>
                    <li><code>Mₐ</code> = Molar mass of the radionuclide (g/mol)</li>
                    <li><code>λ</code> = Decay constant in seconds⁻¹</li>
                </ul>

                <h3 className="mt-6"><b>Dose & Shielding Formulas</b></h3>
                <h4 className="italic mt-4">Gamma Dose Rate (Point Source)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Dose Rate = (Γ · A) / d²</pre>
                </div>
                <ul>
                    <li><code>Γ</code> = Specific gamma-ray constant (e.g., in R·m²/hr·Ci)</li>
                    <li><code>A</code> = Source activity (in Ci)</li>
                    <li><code>d</code> = Distance from the source (in m)</li>
                </ul>

                <h4 className="italic mt-4">Gamma Shielding</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>D(x) = D₀ · B · (0.5)<sup>(x / HVL)</sup></pre>
                </div>
                <ul>
                    <li><code>D(x)</code> = Dose rate after shielding</li>
                    <li><code>D₀</code> = Initial dose rate</li>
                    <li><code>B</code> = Buildup Factor, for scattered photons</li>
                    <li><code>x</code> = Shield thickness</li>
                    <li><code>HVL</code> = Half-Value Layer thickness for the material</li>
                </ul>

                {/* --- NEW FORMULA: Patient Release --- */}
                <h4 className="italic mt-4">Patient Release TEDE (10 CFR 35.75)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>TEDE (rem) ≈ 1.443 · Γ · A₀ · T<sub>eff</sub> · Σ(tᵢ / dᵢ²)</pre>
                </div>
                <ul>
                    <li><code>Γ</code> = Gamma constant (R·m²/hr·mCi)</li>
                    <li><code>A₀</code> = Initial activity (mCi)</li>
                    <li><code>T<sub>eff</sub></code> = Effective half-life (hours)</li>
                    <li><code>tᵢ</code> = Occupancy time fraction for scenario i (hours/24)</li>
                    <li><code>dᵢ</code> = Distance for scenario i (m)</li>
                </ul>
                
                <h3 className="mt-6"><b>Operational HP Formulas</b></h3>
                <h4 className="italic mt-4">Wipe / Leak Test Activity</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Activity (µCi) = (CPM<sub>net</sub>) / (ε<sub>inst</sub> · ε<sub>smear</sub> · 2.22x10⁶)</pre>
                </div>
                <ul>
                    <li><code>CPM<sub>net</sub></code> = Gross CPM - Background CPM</li>
                    <li><code>ε<sub>inst</sub></code> = Instrument efficiency (as a fraction)</li>
                    <li><code>ε<sub>smear</sub></code> = Smear/wipe efficiency (typically 0.1)</li>
                    <li><code>2.22x10⁶</code> = DPM per µCi</li>
                </ul>

                <h4 className="italic mt-4">Airborne Concentration</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>C(t) = (A / V) · e<sup>(-ACH · t)</sup></pre>
                </div>
                <ul>
                    <li><code>C(t)</code> = Concentration at time t</li>
                    <li><code>A</code> = Released activity</li>
                    <li><code>V</code> = Room volume</li>
                    <li><code>ACH</code> = Air Changes per Hour</li>
                    <li><code>t</code> = Time in hours</li>
                </ul>

                {/* --- Neutron Formulas --- */}
                <h3 className="mt-6"><b>Neutron Formulas</b></h3>
                <h4 className="italic mt-4">Thermal Neutron Activation</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>A(t) = N · σ · φ · (1 - e<sup>-λt</sup>)</pre>
                </div>
                <ul>
                    <li><code>A(t)</code> = Activity of product at time t (Bq)</li>
                    <li><code>N</code> = Number of target atoms</li>
                    <li><code>σ</code> = Thermal neutron cross-section (cm²)</li>
                    <li><code>φ</code> = Neutron flux (n/cm²·s)</li>
                    <li><code>λ</code> = Decay constant of the product nuclide</li>
                    <li><code>t</code> = Irradiation time (s)</li>
                </ul>
                
                {/* --- MARSSIM Formulas --- */}
                <h3 className="mt-6"><b>MARSSIM Formulas</b></h3>
                <h4 className="italic mt-4">Static Count MDA (NUREG-1507)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>LLD (counts) = 2.71 + 4.65 · √(R<sub>b</sub> · t<sub>s</sub>)</pre>
                </div>
                <ul>
                    <li><code>LLD</code> = Lower Limit of Detection (net counts)</li>
                    <li><code>R<sub>b</sub></code> = Background count rate (cpm)</li>
                    <li><code>t<sub>s</sub></code> = Sample count time (min)</li>
                </ul>

                <h4 className="italic mt-4">Scan MDC</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Scan MDC = MDCR / (√(p) · ε<sub>total</sub>)</pre>
                </div>
                <ul>
                    <li><code>MDCR</code> = Minimum Detectable Count Rate</li>
                    <li><code>p</code> = Surveyor efficiency</li>
                    <li><code>ε<sub>total</sub></code> = Total efficiency (instrument * surface)</li>
                </ul>

                <h4 className="italic mt-4">Number of Samples (WRS Test)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>N = (Z₁<sub>-α</sub> + Z₁<sub>-β</sub>)² / (3 · (Pᵣ - 0.5)²)</pre>
                </div>
                 <ul>
                    <li><code>Z₁<sub>-α</sub></code>, <code>Z₁<sub>-β</sub></code> = Z-scores for Type I/II error rates</li>
                    <li><code>Pᵣ</code> = Probability value from MARSSIM Table 5.2 based on Relative Shift</li>
                </ul>

                {/* --- NEW SECTION: Lab Stats Formulas --- */}
                <h3 className="mt-6"><b>Lab Statistics Formulas</b></h3>
                <h4 className="italic mt-4">Chi-Squared (χ²) Test</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>χ² = Σ((xᵢ - x̄)²) / x̄</pre>
                </div>
                 <ul>
                    <li><code>xᵢ</code> = Individual count value</li>
                    <li><code>x̄</code> = Mean of all count values</li>
                </ul>

                <h4 className="italic mt-4">Dead Time Correction</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>N = R / (1 - Rτ)</pre>
                </div>
                 <ul>
                    <li><code>N</code> = True count rate (cps)</li>
                    <li><code>R</code> = Observed count rate (cps)</li>
                    <li><code>τ</code> = Detector dead time (seconds)</li>
                </ul>

                <h4 className="italic mt-4">Relative Percent Difference (RPD)</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>RPD (%) = |S₁ - S₂| / ((S₁ + S₂) / 2) · 100</pre>
                </div>
                <ul>
                    <li><code>S₁</code>, <code>S₂</code> = Values for the two duplicate samples</li>
                </ul>

                <h4 className="italic mt-4">Energy Resolution</h4>
                <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                    <pre>Resolution (%) = (FWHM / E) · 100</pre>
                </div>
                 <ul>
                    <li><code>FWHM</code> = Full Width at Half Maximum of the peak (keV)</li>
                    <li><code>E</code> = Peak centroid energy (keV)</li>
                </ul>
        
                <hr className="my-4" />
        
                <h2 className="text-slate-900 dark:text-slate-100"><strong>Frequently Asked Questions (FAQ)</strong></h2>
                <h4 className="italic mt-4">Where does the data come from?</h4>
                <p>The data is aggregated from highly reliable, standard industry sources:</p>
                <ul>
                    <li><strong>Nuclear Data (Half-life, emissions, etc.):</strong> National Nuclear Data Center's (NNDC) NuDat 3 database.</li>
                    <li><strong>Dosimetry Data (ALI, DAC):</strong> U.S. Nuclear Regulatory Commission, 10 CFR 20, Appendix B.</li>
                    <li><strong>Gamma Constants & HVL Data:</strong> Standard, commonly-cited values from health physics texts (e.g. Radiological Health Handbook, Plexus-NSD).</li>
                    <li><strong>MARSSIM Formulas:</strong> NUREG-1575 (MARSSIM), NUREG-1507.</li>
                </ul>
        
                <h4 className="italic mt-4">Why doesn't a specific nuclide appear in a calculator?</h4>
                <p>Calculators are populated only with nuclides that have the necessary data for that specific calculation. For example, the <strong>Dose Rate</strong>, <strong>Shielding</strong>, and <strong>Stay Time</strong> calculators all require a nuclide to have a defined "Gamma Constant" (Γ). Therefore, pure beta emitters (like Tritium or Carbon-14) or pure alpha emitters will not be available in those specific tools. Similarly, the **Activation Calculator** only lists target nuclides known to produce common activation products.</p>

                {/* --- NEW CONTACT SECTION --- */}
                <hr className="my-4" />
                <h2 className="text-slate-900 dark:text-slate-100"><strong>Contact & Bug Reports</strong></h2>
                <div className="bg-slate-100 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                    <p className="mb-2"><strong>Found a bug or have a feature request?</strong></p>
                    <p className="text-sm">
                        This tool is actively maintained. Your feedback helps improve accuracy and usability.
                        Please include the <strong>Browser/OS version</strong> and a <strong>description</strong> of the issue.
                    </p>
                    <div className="mt-4">
                        <a 
                            href="mailto:jough.donakowski@gmail.com?subject=Health Physics Toolbox - Bug Report"
                            className="inline-flex items-center gap-2 px-4 py-2 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            Send Bug Report
                        </a>
                        <p className="text-xs text-slate-500 mt-2">
                            Or email directly: <strong>jough.donakowski@gmail.com</strong>
                        </p>
                    </div>
                </div>
        
                <h4 className="italic mt-4">Disclaimer</h4>
                <p><strong>This tool is for informational and educational purposes only.</strong> The data and calculations have not been independently peer-reviewed or validated and may contain errors. It should not be used for radiation protection, safety-critical applications, operational decision-making, or for demonstrating regulatory compliance. All use of this tool is at your own risk.</p>
            </div>
        );
    };

    return (
        <div className="fixed inset-0 bg-black/60 z-[5000] flex justify-center items-start p-4" onClick={onClose}>
            <div className="bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h2 className="text-xl font-bold">User Manual & FAQ</h2>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                        <Icon path={ICONS.clear} className="w-6 h-6" />
                    </button>
                </div>
                <div className="overflow-y-auto">
                    <ManualContent />
                </div>
            </div>
        </div>
    );
};
         
              /**
              * @description React component for managing user settings and preferences.
              * This panel provides a user interface to configure various default units and modes
              * for the application's calculators, tailoring the user experience to their specific
              * needs and regional standards.
              *
              * Key functionalities include:
              * - **Unit Selection:** Users can set their preferred default units for common
              * quantities like Activity, Dose Rate, and Distance.
              * - **Mode Selection:** Users can choose the default calculator mode for multi-mode tools,
              * such as the Dose Calculator.
              * - **Data Management:** A "Reset to Defaults" button allows users to clear all locally
              * saved data, including their custom settings, favorites list, and calculator inputs,
              * via a confirmation modal. This ensures a clean slate, if needed.
              *
              * This component utilizes a global `SettingsContext` to persist and retrieve user preferences
              * across the application's various tools.
              */
              
         const SettingsPanel = () => {
         const { settings, updateSettings } = React.useContext(SettingsContext);
         const [isResetModalOpen, setIsResetModalOpen] = React.useState(false);
         
         const handleSettingChange = (key, value) => {
             updateSettings({ [key]: value });
         };
         
         const handleResetDefaults = () => {
             localStorage.clear();
             sessionStorage.setItem('showResetToast', 'true');
             window.location.reload();
         };
         
         return (
             <>
                 <div className="p-4 animate-fade-in">
                     <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                         <h2 className="text-xl font-bold text-slate-800 dark:text-white">Settings</h2>
                         <p className="text-sm text-slate-600 dark:text-slate-300 mb-6">
                             Manage application theme and saved data.
                         </p>
         
                         {/* --- Theme Section --- */}
                         <div className="space-y-4">
                             <div>
                                 <label className="block text-sm font-medium mb-2">Theme</label>
                                 <div className="grid grid-cols-3 gap-2 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
                                      <button onClick={() => handleSettingChange('theme', 'light')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.theme === 'light' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Light</button>
                                      <button onClick={() => handleSettingChange('theme', 'dark')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.theme === 'dark' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dark</button>
                                      <button onClick={() => handleSettingChange('theme', 'system')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.theme === 'system' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>System</button>
                                 </div>
                             </div>
         
         <div>
                                     <label className="block text-sm font-medium mb-2">Unit System</label>
                                     <div className="grid grid-cols-2 gap-2 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
                                          <button onClick={() => handleSettingChange('unitSystem', 'conventional')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.unitSystem === 'conventional' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Conventional (Ci, rem)</button>
                                          <button onClick={() => handleSettingChange('unitSystem', 'si')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${settings.unitSystem === 'si' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>SI (Bq, Sv)</button>
                                     </div>
                                 </div>
         
                         </div>
         
                         {/* --- About Section --- */}
                         <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-2 text-center text-xs text-slate-500 dark:text-slate-400">
                              <p><strong>Health Physics Toolbox</strong> Version {VERSION}</p>
                              <p>Last Updated: {LAST_UPDATED}</p>
                              <p>Created by Jough Donakowski</p>
                         </div>
         
                         {/* --- Reset Section --- */}
                         <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                             <h3 className="text-lg font-semibold text-slate-700 dark:text-slate-200">Application Data</h3>
                              <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">This will clear all saved calculator inputs, favorites, search history, and settings.</p>
                             <button onClick={() => setIsResetModalOpen(true)} className="w-full py-2 bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 font-semibold rounded-lg hover:bg-red-200 dark:hover:bg-red-900 transition">Reset All Saved Data</button>
                         </div>
                     </div>
                 </div>
                 <ConfirmationModal isOpen={isResetModalOpen} onClose={() => setIsResetModalOpen(false)} onConfirm={handleResetDefaults} title="Reset All Settings & Saved Data?"><p>Are you sure? This will clear <strong>all</strong> saved calculator inputs, favorites, search history, and default settings. The application will reload with its original defaults. This action cannot be undone.</p></ConfirmationModal>
             </>
         );
         };
         
         
         const PopoutWindow = ({ children, title, onClose, width = 450, height = 750 }) => {
                  const [container, setContainer] = React.useState(null);
                  const newWindow = React.useRef(null);
              
                  React.useEffect(() => {
                      newWindow.current = window.open('', title, `width=${width},height=${height},resizable=yes`);
                      
                      // --- THIS LINE IS UPDATED to include text colors ---
                      newWindow.current.document.body.className = "bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200";
                      
                      const popoutRoot = newWindow.current.document.createElement('div');
                      newWindow.current.document.body.appendChild(popoutRoot);
         
             const reactScript = newWindow.current.document.createElement('script');
             reactScript.src = "https://unpkg.com/react@18/umd/react.development.js";
             reactScript.crossOrigin = true;
             newWindow.current.document.head.appendChild(reactScript);
         
             const reactDomScript = newWindow.current.document.createElement('script');
             reactDomScript.src = "https://unpkg.com/react-dom@18/umd/react-dom.development.js";
             reactDomScript.crossOrigin = true;
             newWindow.current.document.head.appendChild(reactDomScript);
         
             const babelScript = newWindow.current.document.createElement('script');
             babelScript.src = "https://unpkg.com/@babel/standalone/babel.min.js";
             newWindow.current.document.head.appendChild(babelScript);
                      
                      document.head.querySelectorAll('link[rel="stylesheet"], style').forEach(node => {
                          newWindow.current.document.head.appendChild(node.cloneNode(true));
                      });
         
                      const tailwindScript = newWindow.current.document.createElement('script');
                      tailwindScript.src = "https://cdn.tailwindcss.com";
                      newWindow.current.document.head.appendChild(tailwindScript);
                      const tailwindConfigScript = newWindow.current.document.createElement('script');
                      tailwindConfigScript.innerHTML = `tailwind.config = { darkMode: 'class' }`;
                      newWindow.current.document.head.appendChild(tailwindConfigScript);
                      
                      newWindow.current.document.documentElement.className = document.documentElement.className;
                      
                      setContainer(popoutRoot);
                      
                      const handleUnload = () => { onClose(); };
                      newWindow.current.addEventListener('beforeunload', handleUnload);
         
                      return () => {
                          newWindow.current.removeEventListener('beforeunload', handleUnload);
                          if (newWindow.current) {
                             newWindow.current.close();
                          }
                          setContainer(null);
                      };
                  }, []);
         
                  if (!container) return null;
         
                  return ReactDOM.createPortal(children, container);
              };
         
         /**
         * @description The root component of the entire application.
         * It manages all primary state, handles routing between views, and orchestrates all user interactions.
         */
                  
         const App = () => {
         const [activeView, setActiveView] = React.useState(VIEWS.HOME);

	 const [previousView, setPreviousView] = React.useState(VIEWS.HOME);

         const [showCalcPopout, setShowCalcPopout] = React.useState(false);
         const [showScratchpadPopout, setShowScratchpadPopout] = React.useState(false);
         const [detailedNuclide, setDetailedNuclide] = React.useState(null);
         const [errorMessage, setErrorMessage] = React.useState('');
         const [preselectedNuclide, setPreselectedNuclide] = React.useState(null);
         const [comparisonList, setComparisonList] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideComparisonList') || '[]'); } catch (e) { return []; } });
         const [nuclideName, setNuclideName] = React.useState('');
         const debouncedSearchTerm = useDebounce(nuclideName, 250);
         const [suggestions, setSuggestions] = React.useState([]);
         const [activeSuggestionIndex, setActiveSuggestionIndex] = React.useState(-1);
         const [isManualOpen, setIsManualOpen] = React.useState(false);
         const [isFiltersVisible, setIsFiltersVisible] = React.useState(false);
         const [displayHalfLifeUnit, setDisplayHalfLifeUnit] = React.useState('years');
         const [currentDecaySeriesId, setCurrentDecaySeriesId] = React.useState(null);
         const [theme, setTheme] = React.useState(() => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
         const [searchHistory, setSearchHistory] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideSearchHistory') || '[]'); } catch (e) { return []; } });
         const [favorites, setFavorites] = React.useState(() => { try { return JSON.parse(localStorage.getItem('favoriteNuclides') || '[]'); } catch (e) { return []; } });
         const [randomSuggestions, setRandomSuggestions] = React.useState([]);
         const [isSearchFocused, setIsSearchFocused] = React.useState(false);

	 const [opHpActiveTab, setOpHpActiveTab] = React.useState('surfaceContam');
         
         const [scientificCalculatorState, setScientificCalculatorState] = React.useState(() => {
         const savedState = localStorage.getItem('scientificCalculatorState');
         return savedState ? JSON.parse(savedState) : { expression: '', result: '', history: [], memory: 0 };
         });
         
         // Add this useEffect to save the state whenever it changes
         React.useEffect(() => {
         localStorage.setItem('scientificCalculatorState', JSON.stringify(scientificCalculatorState));
         }, [scientificCalculatorState]);
         
         const [scratchpadNotes, setScratchpadNotes] = React.useState(
         () => localStorage.getItem('user_scratchpad_notes') || ''
         );
         
         const [sortBy, setSortBy] = React.useState(() => localStorage.getItem('filterSortBy') || 'name');
         const [sortOrder, setSortOrder] = React.useState(() => localStorage.getItem('filterSortOrder') || 'asc');
         const [selectedCategory, setSelectedCategory] = React.useState(() => localStorage.getItem('filterCategory') || 'All');
         const [selectedEmissionType, setSelectedEmissionType] = React.useState(() => localStorage.getItem('filterEmissionType') || 'All');
         const [selectedCommonality, setSelectedCommonality] = React.useState(() => localStorage.getItem('filterCommonality') || 'All');
         const [minAlphaEnergy, setMinAlphaEnergy] = React.useState(() => localStorage.getItem('filterMinAlphaEnergy') || '');
         const [maxAlphaEnergy, setMaxAlphaEnergy] = React.useState(() => localStorage.getItem('filterMaxAlphaEnergy') || '');
         const [minBetaEnergy, setMinBetaEnergy] = React.useState(() => localStorage.getItem('filterMinBetaEnergy') || '');
         const [maxBetaEnergy, setMaxBetaEnergy] = React.useState(() => localStorage.getItem('filterMaxBetaEnergy') || '');
         const [minGammaEnergy, setMinGammaEnergy] = React.useState(() => localStorage.getItem('filterMinGammaEnergy') || '');
         const [maxGammaEnergy, setMaxGammaEnergy] = React.useState(() => localStorage.getItem('filterMaxGammaEnergy') || '');
         const [minHalfLife, setMinHalfLife] = React.useState(() => localStorage.getItem('filterMinHalfLife') || '');
         const [maxHalfLife, setMaxHalfLife] = React.useState(() => localStorage.getItem('filterMaxHalfLife') || '');
         const [halfLifeFilterUnit, setHalfLifeFilterUnit] = React.useState(() => localStorage.getItem('filterHalfLifeUnit') || 'years');
         
         const handleSearchFocus = () => setIsSearchFocused(true);
         const handleSearchBlur = () => {
         setTimeout(() => { setIsSearchFocused(false); }, 150);
         };

const handleGoToDetectorResponse = () => {
    //  Pass 'response' as the second argument so handleNavClick knows to set the tab
    handleNavClick(VIEWS.OPERATIONAL_HP, 'response');
};
         
         React.useEffect(() => {
         const handleHashChange = () => {
            const hash = window.location.hash.replace('#', '');
            const validViews = Object.values(VIEWS);
            let targetView = VIEWS.HOME;
            if (hash && validViews.includes(hash)) {
                targetView = hash;
            } else {
                history.replaceState(null, '', `#${VIEWS.HOME}`);
            }
            setActiveView(targetView);

            if (targetView === VIEWS.HOME) {
                setDetailedNuclide(null);
                setNuclideName(''); 
                setSuggestions([]); 
                setErrorMessage('');
            }
         };
         window.addEventListener('hashchange', handleHashChange);
         handleHashChange();
         return () => window.removeEventListener('hashchange', handleHashChange);
         }, []);
         
         const mainContentRef = React.useRef(null);
         const scrollPositionRef = React.useRef(null);
         const inputRef = React.useRef(null);
         const suggestionsRef = React.useRef(null);
         const { addToast } = useToast();
         
         React.useEffect(() => {
         const initialHash = window.location.hash.replace('#', '');
         if ((initialHash === VIEWS.HOME || initialHash === '') && window.innerWidth > 768) {
            inputRef.current?.focus();
         }
         }, []);
         
         React.useEffect(() => {
         if (sessionStorage.getItem('showResetToast') === 'true') {
            addToast('All settings and saved data have been reset.');
            sessionStorage.removeItem('showResetToast');
         }
         }, [addToast]);
         
const scrollToMainContent = () => {

if (mainContentRef.current) {
   mainContentRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
};
         
         const handleNavClick = (view, opHpTab = null) => {
    if (view !== VIEWS.DETAIL) {
       setDetailedNuclide(null);
    }

// If opHpTab is passed (deep link), it sets it. 
    // If undefined/null (normal nav), it clears it.
    setOpHpActiveTab(opHpTab);

         // When navigating manually, clear any pre-selections
         setPreselectedNuclide(null);
         setActiveView(view);
         window.location.hash = view;
         scrollToMainContent();
         if (view === VIEWS.HOME) { inputRef.current?.blur(); }
         };
         
         const handleClearSearch = () => {
         setNuclideName('');
         setSuggestions([]);
         setDetailedNuclide(null);
         handleNavClick(VIEWS.HOME);
         inputRef.current?.focus();
         };
         
         const handleSendToCalculator = (viewId, nuclideSymbol) => {
         setPreselectedNuclide(nuclideSymbol);
         window.location.hash = viewId;
         };
         
         const handleAddToCompare = (nuclideSymbol) => {
         const nuclideToAdd = radionuclides.find(n => n.symbol === nuclideSymbol);
         if (nuclideToAdd && !comparisonList.find(n => n.symbol === nuclideSymbol)) {
            setComparisonList(prevList => [...prevList, nuclideToAdd]);
            addToast(`${nuclideToAdd.name} added to comparison.`);
         } else if (nuclideToAdd) {
            addToast(`${nuclideToAdd.name} is already in the comparison.`);
         }
         window.location.hash = VIEWS.COMPARE;
         };
         
         const handleRemoveFromCompare = (nuclideSymbol) => { setComparisonList(prevList => prevList.filter(n => n.symbol !== nuclideSymbol)); };
         const handleClearCompare = () => { setComparisonList([]); addToast('Comparison list cleared.'); };
         
         React.useEffect(() => {
         localStorage.setItem('filterSortBy', sortBy);
         localStorage.setItem('filterSortOrder', sortOrder);
         localStorage.setItem('filterCategory', selectedCategory);
         localStorage.setItem('filterEmissionType', selectedEmissionType);
         localStorage.setItem('filterCommonality', selectedCommonality);
         localStorage.setItem('filterMinAlphaEnergy', minAlphaEnergy);
         localStorage.setItem('filterMaxAlphaEnergy', maxAlphaEnergy);
         localStorage.setItem('filterMinBetaEnergy', minBetaEnergy);
         localStorage.setItem('filterMaxBetaEnergy', maxBetaEnergy);
         localStorage.setItem('filterMinGammaEnergy', minGammaEnergy);
         localStorage.setItem('filterMaxGammaEnergy', maxGammaEnergy);
         localStorage.setItem('filterMinHalfLife', minHalfLife);
         localStorage.setItem('filterMaxHalfLife', maxHalfLife);
         localStorage.setItem('filterHalfLifeUnit', halfLifeFilterUnit);
         }, [sortBy, sortOrder, selectedCategory, selectedEmissionType, selectedCommonality, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit]);
         
         React.useEffect(() => {
         const root = window.document.documentElement;
         root.classList.toggle('dark', theme === 'dark');
         localStorage.setItem('theme', theme);
         }, [theme]);
         
         React.useEffect(() => {
         localStorage.setItem('radionuclideComparisonList', JSON.stringify(comparisonList));
         }, [comparisonList]);
         
         React.useEffect(() => {
         const handleClickOutside = (e) => {
            if (suggestionsRef.current && !suggestionsRef.current.contains(e.target) && inputRef.current && !inputRef.current.contains(e.target)) {
                setSuggestions([]);
            }
         };
         document.addEventListener('mousedown', handleClickOutside);
         return () => document.removeEventListener('mousedown', handleClickOutside);
         }, []);
         
         React.useEffect(() => {
         const common = radionuclides.filter(n => n.commonality === 'Common');
         setRandomSuggestions([...common].sort(() => 0.5 - Math.random()).slice(0, 5));
         }, [radionuclides]);
         
         const allCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.category))].sort()], [radionuclides]);
         const allEmissionTypes = React.useMemo(() => ['All', ...[...new Set(radionuclides.flatMap(n => n.emissionType || []))].sort()], [radionuclides]);
         const allCommonalityCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.commonality).filter(Boolean))].sort()], [radionuclides]);
         
         const getFilteredAndSortedRadionuclides = React.useCallback(() => {
         let filtered = [...radionuclides];
         if (selectedCategory !== 'All') { filtered = filtered.filter(n => n.category === selectedCategory); }
         if (selectedEmissionType !== 'All') { filtered = filtered.filter(n => n.emissionType?.includes(selectedEmissionType)); }
         if (selectedCommonality !== 'All') { filtered = filtered.filter(n => n.commonality === selectedCommonality); }
         const filterByEnergyRange = (nuclide, type, min, max) => {
            const energy = parseEnergyToMeV(nuclide.emissionEnergies?.[type]);
            if (energy === 0 && (min || max)) return false;
            const minVal = parseFloat(min); const maxVal = parseFloat(max);
            if (!isNaN(minVal) && !isNaN(maxVal)) return energy >= minVal && energy <= maxVal;
            if (!isNaN(minVal)) return energy >= minVal;
            if (!isNaN(maxVal)) return energy <= maxVal;
            return true;
         };
         if (minAlphaEnergy || maxAlphaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'alpha', minAlphaEnergy, maxAlphaEnergy));
         if (minBetaEnergy || maxBetaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'beta', minBetaEnergy, maxBetaEnergy));
         if (minGammaEnergy || maxGammaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'gamma', minGammaEnergy, maxGammaEnergy));
         if (minHalfLife || maxHalfLife) {
            const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
            const minSeconds = minHalfLife ? parseFloat(minHalfLife) * unitConversions[halfLifeFilterUnit] : null;
            const maxSeconds = maxHalfLife ? parseFloat(maxHalfLife) * unitConversions[halfLifeFilterUnit] : null;
            filtered = filtered.filter(n => {
                const nuclideSeconds = parseHalfLifeToSeconds(n.halfLife);
                if (nuclideSeconds === Infinity && (minSeconds || maxSeconds)) return false;
                const checkMin = minSeconds ? nuclideSeconds >= minSeconds : true;
                const checkMax = maxSeconds ? nuclideSeconds <= maxSeconds : true;
                return checkMin && checkMax;
            });
         }
         filtered.sort((a, b) => {
            let compare = 0;
            if (sortBy === 'name') compare = a.name.localeCompare(b.name);
            else if (sortBy === 'halfLife') compare = parseHalfLifeToSeconds(a.halfLife) - parseHalfLifeToSeconds(b.halfLife);
            else if (sortBy === 'alphaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.alpha) - parseEnergyToMeV(b.emissionEnergies?.alpha);
            else if (sortBy === 'betaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.beta) - parseEnergyToMeV(b.emissionEnergies?.beta);
            else if (sortBy === 'gammaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.gamma) - parseEnergyToMeV(b.emissionEnergies?.gamma);
            return sortOrder === 'asc' ? compare : -compare;
         });
         return filtered;
         }, [selectedCategory, selectedEmissionType, selectedCommonality, sortBy, sortOrder, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit, radionuclides]);
         
         const filteredList = getFilteredAndSortedRadionuclides();
         const toggleTheme = () => setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
         const handleClearHistory = () => { setSearchHistory([]); localStorage.removeItem('radionuclideSearchHistory'); addToast('Search history cleared.'); };
         const handleDecaySeriesClick = (seriesId) => { setCurrentDecaySeriesId(seriesId); window.location.hash = VIEWS.DECAY_SERIES; };
         const toggleFavorite = (symbol) => { const nuclide = radionuclides.find(n => n.symbol === symbol); const isCurrentlyFavorite = favorites.includes(symbol); const newFavorites = isCurrentlyFavorite ? favorites.filter(s => s !== symbol) : [...favorites, symbol]; setFavorites(newFavorites); localStorage.setItem('favoriteNuclides', JSON.stringify(newFavorites)); if (isCurrentlyFavorite) { addToast(`${nuclide ? nuclide.name : symbol} removed from favorites.`); } else { addToast(`${nuclide ? nuclide.name : symbol} added to favorites!`); } };
         const handleClearFavorites = () => { setFavorites([]); localStorage.removeItem('favoriteNuclides'); addToast('Favorites list cleared.'); };
         const updateSearchHistory = (nuclide) => { setSearchHistory(prev => { const newHistory = [nuclide.symbol, ...prev.filter(symbol => symbol !== nuclide.symbol)]; const limitedHistory = newHistory.slice(0, 5); localStorage.setItem('radionuclideSearchHistory', JSON.stringify(limitedHistory)); return limitedHistory; }); }
         
         const handleNuclideSelection = (nuclide) => {
    // Save the current view if we are not already in the detail view.
    // This allows browsing parent/daughter chains while keeping the original "Back" destination.
    if (activeView !== VIEWS.DETAIL) {
        setPreviousView(activeView);
    }

    setNuclideName(nuclide.name);
    updateSearchHistory(nuclide);
    setDetailedNuclide(nuclide);
    setSuggestions([]);
    setErrorMessage('');
    setCurrentDecaySeriesId(null);
    handleNavClick(VIEWS.DETAIL);
};
         
         
         React.useEffect(() => {
         
         if (debouncedSearchTerm.length > 0) {
         // Don't show suggestions if the search term already matches the displayed nuclide
         if (detailedNuclide && debouncedSearchTerm === detailedNuclide.name) {
            setSuggestions([]);
            return;
         }
         const normVal = normalizeString(debouncedSearchTerm);
         const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 };
         
         const filtered = radionuclides
            .filter(n => normalizeString(n.name).includes(normVal) || normalizeString(n.symbol).includes(normVal))
            .sort((a, b) => {
                const orderA = commonalityOrder[a.commonality] || 0;
                const orderB = commonalityOrder[b.commonality] || 0;
                if (orderB !== orderA) return orderB - orderA; // Sort by commonality first
                return a.name.localeCompare(b.name); // Then alphabetically
            })
            .slice(0, 10);
            
         setSuggestions(filtered);
         } else {
         // If the search term is empty, clear suggestions and the detailed result.
         setSuggestions([]);
         if (detailedNuclide) { // Only change state if there's something to clear
            setDetailedNuclide(null);
            handleNavClick(VIEWS.HOME);
         }
         }
         }, [debouncedSearchTerm, radionuclides]); // Simplified dependencies
         
         const handleNuclideNameChange = (e) => {
         setNuclideName(e.target.value);
if (e.target.value.length > 0) {
        setSelectedCategory('All');
        setSelectedEmissionType('All');
        setSelectedCommonality('All');
        setMinAlphaEnergy('');
        setMaxAlphaEnergy('');
        setMinBetaEnergy('');
        setMaxBetaEnergy('');
        setMinGammaEnergy('');
        setMaxGammaEnergy('');
        setMinHalfLife('');
        setMaxHalfLife('');
    }
         };
         
         const handleClearFilters = () => { setSortBy('name'); setSortOrder('asc'); setSelectedCategory('All'); setSelectedEmissionType('All'); setSelectedCommonality('All'); setMinAlphaEnergy(''); setMaxAlphaEnergy(''); setMinBetaEnergy(''); setMaxBetaEnergy(''); setMinGammaEnergy(''); setMaxGammaEnergy(''); setMinHalfLife(''); setMaxHalfLife(''); setHalfLifeFilterUnit('years'); };
         
         const handleLookup = () => { 
         setSuggestions([]); 
         const normInput = normalizeString(nuclideName); 
         const found = radionuclides.find(n => normalizeString(n.name) === normInput || normalizeString(n.symbol) === normInput); 
         if (found) { 
            handleNuclideSelection(found); 
         } else { 
            setDetailedNuclide(null);
            setErrorMessage(`Nuclide "${nuclideName}" not found.`); 
            setActiveView(VIEWS.HOME); 
         } 
         };
         
         const handleKeyDown = (e) => { 
         if (e.key === 'Enter') { 
            if (activeSuggestionIndex !== -1 && suggestions.length > 0) { 
                handleNuclideSelection(suggestions[activeSuggestionIndex]); 
            } else { 
                handleLookup(); 
            } 
         } else if (e.key === 'ArrowDown') { 
            e.preventDefault(); 
            setActiveSuggestionIndex(prev => (prev < suggestions.length - 1 ? prev + 1 : 0)); 
         } else if (e.key === 'ArrowUp') { 
            e.preventDefault(); 
            setActiveSuggestionIndex(prev => (prev > 0 ? prev - 1 : suggestions.length - 1)); 
         } else if (e.key === 'Escape') { 
            setSuggestions([]); 
         } 
         };
         
         const renderActiveView = () => {
         const filterProps = { sortBy, setSortBy, sortOrder, setSortOrder, selectedCategory, setSelectedCategory, allCategories, selectedEmissionType, setSelectedEmissionType, allEmissionTypes, selectedCommonality, setSelectedCommonality, allCommonalityCategories, minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy, minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy, minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy, minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit, clearFilters: handleClearFilters };
         switch (activeView) {
            case VIEWS.DATABASE: return <DatabaseView filteredList={filteredList} onNuclideClick={handleNuclideSelection} filterProps={filterProps} isFiltersVisible={isFiltersVisible} setIsFiltersVisible={setIsFiltersVisible} scrollPositionRef={scrollPositionRef} handleClearFilters={handleClearFilters} />;
            case VIEWS.CALCULATOR: return <DecayTools radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} theme={theme} />;
            case VIEWS.MDA: 
	                return <MDACalculator onNavClick={handleNavClick} onDeepLink={handleGoToDetectorResponse} />;
            case VIEWS.MARSSIM_SAMPLES: return <MARSSIM_SampleDesign />;
            case VIEWS.WRS_TEST: return <WRS_Calculator />;
            case VIEWS.EMC_TEST: return <EMC_Calculator />;

            case VIEWS.SERIES_CALCULATOR: 
    return <DecaySeriesCalculator 
        radionuclides={radionuclides} 
        decaySeriesData={decaySeriesData} 
        theme={theme} 
        onNuclideClick={handleNuclideSelection} 
    />;
            case VIEWS.EQUILIBRIUM: return <EquilibriumCalculator radionuclides={radionuclides} theme={theme} />;
            case VIEWS.RADON: return <RadonCalculator />;
            case VIEWS.COMPARE: return <ComparisonView radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} comparisonList={comparisonList} onAddToCompare={handleAddToCompare} onRemoveFromCompare={handleRemoveFromCompare} onClearCompare={handleClearCompare} />;
            case VIEWS.ACTIVITY_MASS: return <ActivityAndMassTools radionuclides={radionuclides} />;
            case VIEWS.DOSE_RATE: return <DoseRateCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.SHIELDING: return <ShieldingCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.STAY_TIME: return <StayTimeCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.NEUTRON: return <NeutronCalculator radionuclides={radionuclides} />;
            case VIEWS.OPERATIONAL_HP: return <OperationalHPCalculators radionuclides={radionuclides} initialTab={opHpActiveTab} />;
            case VIEWS.TRANSPORTATION: return <TransportationCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.CONVERTER: return <UnitConverter />;
            case VIEWS.LAB_STATS: return <LabStatistics />;
            case VIEWS.PEAK_ID: return <PeakIdentifier radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} />;
            case VIEWS.SETTINGS: return <SettingsPanel />;
            case VIEWS.MARSSIM_TESTS: return <MARSSIM_Statistical_Tests />;
            case VIEWS.DECAY_SERIES: return <DecaySeriesViewer seriesId={currentDecaySeriesId} onBack={() => { setDetailedNuclide(null); handleNavClick(VIEWS.HOME); }} onNuclideClick={handleNuclideSelection} />;
            case VIEWS.DETAIL:

    if (detailedNuclide) {
        return (
            <div className="p-4">
                <NuclideCard 
                    nuclide={detailedNuclide} 
                    radionuclides={radionuclides} 
                    onDecaySeriesClick={handleDecaySeriesClick} 
                    displayHalfLifeUnit={displayHalfLifeUnit} 
                    favorites={favorites} 
                    toggleFavorite={toggleFavorite} 
                    onSendToCalculator={handleSendToCalculator} 
                    onAddToCompare={handleAddToCompare} 
                    onNuclideClick={handleNuclideSelection} 
                    showBackButton={true} 
                    // Navigates to the stored previous view
                    onBackClick={() => handleNavClick(previousView)} 
                />
            </div>
        );
    }
                return <HomePage errorMessage={errorMessage} randomSuggestions={randomSuggestions} searchHistory={searchHistory} handleNuclideSelection={handleNuclideSelection} handleClearHistory={handleClearHistory} favorites={favorites} radionuclides={radionuclides} handleClearFavorites={handleClearFavorites} onNavClick={handleNavClick} />;
            case VIEWS.MEDICAL:return <MedicalCalculator radionuclides={radionuclides} />;
         
         case VIEWS.SCRATCHPAD:
         return (
         <div className="p-4 animate-fade-in">
         <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col">
           <div className="flex justify-between items-center mb-4">
               <h2 className="text-xl font-bold text-slate-800 dark:text-white">Scratchpad</h2>
               <Tooltip text="Open in New Window" widthClass="w-auto">
                   <button onClick={() => setShowScratchpadPopout(true)} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                       <Icon path={ICONS.popOut} className="w-5 h-5" />
                   </button>
               </Tooltip>
           </div>
           {/* Pass the centralized state down to the Scratchpad component */}
           <Scratchpad notes={scratchpadNotes} setNotes={setScratchpadNotes} />
         </div>
         </div>
         );
         
         case VIEWS.SCIENTIFIC_CALCULATOR: return ( <div className="p-4 animate-fade-in"><div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 dark:text-white">Scientific Calculator</h2><Tooltip text="Open in New Window" widthClass="w-auto"><button onClick={() => setShowCalcPopout(true)} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.popOut} className="w-5 h-5" /></button></Tooltip></div><ScientificCalculator calcState={scientificCalculatorState} setCalcState={setScientificCalculatorState} /></div></div> );
            case VIEWS.REFERENCES: return <ReferencesPage />;
            case VIEWS.HOME: 
            default: 
                return <HomePage errorMessage={errorMessage} randomSuggestions={randomSuggestions} searchHistory={searchHistory} handleNuclideSelection={handleNuclideSelection} handleClearHistory={handleClearHistory} favorites={favorites} radionuclides={radionuclides} handleClearFavorites={handleClearFavorites} onNavClick={handleNavClick} />;
         }
         };

         return (
         <div className="min-h-screen p-0 sm:p-2 md:p-4 text-slate-800 dark:text-slate-200">
            <div className="max-w-7xl mx-auto bg-white dark:bg-slate-900/70 rounded-none sm:rounded-2xl shadow-2xl backdrop-blur-lg border-slate-200 dark:border-slate-800">
                <Header onHelpClick={() => setIsManualOpen(true)} theme={theme} toggleTheme={toggleTheme} onNavClick={handleNavClick} />
                <SearchBar 
                    nuclideName={nuclideName} 
                    inputRef={inputRef} 
                    handleNuclideNameChange={handleNuclideNameChange} 
                    handleKeyDown={handleKeyDown} 
                    onClear={handleClearSearch} 
                    suggestions={suggestions} 
                    activeSuggestionIndex={activeSuggestionIndex} 
                    suggestionsRef={suggestionsRef} 
                    handleNuclideSelection={handleNuclideSelection} 
                    onNavClick={handleNavClick}
                    isFocused={isSearchFocused}
                    onFocus={handleSearchFocus}
                    onBlur={handleSearchBlur}
                />
                <MainNav activeView={activeView} onNavClick={handleNavClick} />
                <main ref={mainContentRef} className="min-h-[400px]">{renderActiveView()}</main>
                <footer className="text-center p-6 mt-4 border-t border-slate-200 dark:border-slate-700">
                    <p className="text-xs text-slate-500 dark:text-slate-400"><strong>Disclaimer:</strong> This tool is for informational and educational purposes only. The data and calculations have not been validated and may contain errors. Use of this tool is at your own risk.</p>
                    <div className="mt-4 flex justify-center md:hidden"><a href="https://www.buymeacoffee.com/jough" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} /></a></div>
                </footer>
                <ManualModal isOpen={isManualOpen} onClose={() => setIsManualOpen(false)} />
         
                {showCalcPopout && (
                    <PopoutWindow 
                        title="Scientific Calculator" 
                        onClose={() => setShowCalcPopout(false)}
                        height={850}
                    >
                        <div className={`${theme} bg-slate-100 dark:bg-slate-900 h-full p-4`}>
                            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Scientific Calculator</h2>
                                <ScientificCalculator calcState={scientificCalculatorState} setCalcState={setScientificCalculatorState} />
                            </div>
                        </div>
                    </PopoutWindow>
                )}
                
         {showScratchpadPopout && (
         <PopoutWindow 
         title="Scratchpad" 
         onClose={() => setShowScratchpadPopout(false)}
         width={800} 
         height={660}
         >
         <div className={`${theme} bg-slate-100 dark:bg-slate-900 h-full p-4`}>
         <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col h-full">
           <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Scratchpad</h2>
           <div className="flex-grow flex flex-col">
              {/* FIX: Pass the centralized state down to the pop-out component */}
              <Scratchpad notes={scratchpadNotes} setNotes={setScratchpadNotes} />
           </div>
         </div>
         </div>
         </PopoutWindow>
         )}
            </div>
         </div>
         );
         };
         
              /**
              * @description A searchable dropdown component for selecting items from a large list.
              */
              
              const SearchableSelect = ({ options, onSelect, placeholder }) => {
 
         const [inputValue, setInputValue] = React.useState('');
         const [isOpen, setIsOpen] = React.useState(false);
         const [activeIndex, setActiveIndex] = React.useState(-1);
         const containerRef = React.useRef(null);
         const listRef = React.useRef(null);
         const inputRef = React.useRef(null); // Added for auto-focus
         
         const handleClear = () => {
         setInputValue('');
         setIsOpen(false);
         setActiveIndex(-1);
         };
         
         const filteredOptions = React.useMemo(() => {
         if (!inputValue) return [];
         const normInput = normalizeString(inputValue);
         const commonalityOrder = {
         'Common': 3,
         'Moderate': 2,
         'Rare': 1
         };
         
         return options
         .filter(opt => normalizeString(opt.name).includes(normInput) || normalizeString(opt.symbol).includes(normInput))
         .sort((a, b) => {
         const aStartsWith = normalizeString(a.name).startsWith(normInput) || normalizeString(a.symbol).startsWith(normInput);
         const bStartsWith = normalizeString(b.name).startsWith(normInput) || normalizeString(b.symbol).startsWith(normInput);
         if (aStartsWith !== bStartsWith) return aStartsWith ? -1 : 1;
         const orderA = commonalityOrder[a.commonality] || 0;
         const orderB = commonalityOrder[b.commonality] || 0;
         if (orderB !== orderA) return orderB - orderA;
         return a.name.localeCompare(b.name);
         })
         .slice(0, 10);
         }, [inputValue, options]);
         
         React.useEffect(() => {
         const handleClickOutside = (event) => {
         if (containerRef.current && !containerRef.current.contains(event.target)) {
         setIsOpen(false);
         }
         };
         document.addEventListener('mousedown', handleClickOutside);
         return () => document.removeEventListener('mousedown', handleClickOutside);
         }, []);
         
         const handleKeyDown = (e) => {
         if (filteredOptions.length === 0) return;
         if (e.key === 'ArrowDown') {
         e.preventDefault();
         setActiveIndex(prev => (prev < filteredOptions.length - 1 ? prev + 1 : 0));
         } else if (e.key === 'ArrowUp') {
         e.preventDefault();
         setActiveIndex(prev => (prev > 0 ? prev - 1 : filteredOptions.length - 1));
         } else if (e.key === 'Enter') {
         if (activeIndex > -1 && filteredOptions[activeIndex]) {
         handleSelect(filteredOptions[activeIndex]);
         } else if (filteredOptions.length > 0) {
         handleSelect(filteredOptions[0]);
         }
         } else if (e.key === 'Escape') {
         setIsOpen(false);
         }
         };
         
         React.useEffect(() => {
         if (activeIndex !== -1 && listRef.current?.children[activeIndex]) {
         listRef.current.children[activeIndex].scrollIntoView({
         block: 'nearest'
         });
         }
         }, [activeIndex]);
         
         const handleSelect = (option) => {
         onSelect(option.symbol);
         setInputValue('');
         setIsOpen(false);
         setActiveIndex(-1);
         };
         
         return (
         <div className="relative w-full" ref={containerRef}>
         <div className="relative">
         <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <Icon path={ICONS.search} className="w-5 h-5 text-slate-400" />
         </div>
         <input
          ref={inputRef}
          type="text"
          value={inputValue}
          onChange={(e) => {
            setInputValue(e.target.value);
            setIsOpen(true);
            setActiveIndex(-1);
          }}
          onKeyDown={handleKeyDown}
          onFocus={() => { if(inputValue) setIsOpen(true); }}
          placeholder={placeholder}
          className="w-full p-2 pl-10 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"
          autoComplete="off"
         />
         
         {inputValue && (
          <button
            onClick={handleClear}
            className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-sky-500 focus:outline-none"
          >
            <Icon path={ICONS.clear} className="w-5 h-5" />
          </button>
         )}
         </div>
         {isOpen && filteredOptions.length > 0 && (
              <ul ref={listRef} className="absolute z-30 w-full mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg max-h-72 overflow-y-auto">
                  {filteredOptions.map((option, index) => {
                      const styles = CATEGORY_STYLES[option.category] || CATEGORY_STYLES['default'];
                      return (
                          <li
                              key={option.symbol}
                              onClick={() => handleSelect(option)}
                              onMouseEnter={() => setActiveIndex(index)}
                              className={`p-3 pl-4 cursor-pointer text-slate-700 dark:text-slate-200 border-l-2 ${styles.border} ${styles.hoverBg} ${
                                  index === activeIndex ? 'bg-sky-100 dark:bg-sky-900/50' : ''
                              }`}
                          >
                              {option.name} ({option.symbol})
                          </li>
                      )
                  })}
                  {filteredOptions.length > 4 && (
                      <div className="sticky bottom-0 bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm p-2 border-t border-slate-200 dark:border-slate-700">
                          <div className="flex flex-wrap justify-center gap-x-3 gap-y-1">
                              {Object.entries(CATEGORY_STYLES).filter(([key]) => key !== 'default').map(([category, styles]) => {
                                  const bgColor = styles.border.replace('border-l-', 'bg-');
                                  return (
                                      <div key={category} className="flex items-center gap-1.5">
                                          <div className={`w-2.5 h-2.5 rounded-full ${bgColor}`}></div>
                                          <span className="text-xs text-slate-500 dark:text-slate-400">{category.replace('/', '/ ')}</span>
                                      </div>
                                  );
                              })}
                          </div>
                      </div>
                  )}
              </ul>
          )}
         </div>
         );
         };
              
              /**
              * @description An advanced view for comparing multiple radionuclides side-by-side.
              * Features dynamic highlighting, in-cell data bars, and an integrated
              * percentage difference tag when comparing two nuclides.
              */
              
const ComparisonView = ({ radionuclides, onNuclideClick, comparisonList, onAddToCompare, onRemoveFromCompare, onClearCompare }) => {
    const [isModalOpen, setIsModalOpen] = React.useState(false);
    const { settings } = React.useContext(SettingsContext);

    // Helper for HVL lookup
    const getHVL = (nuclide, material) => {
        if (HVL_DATA[nuclide.symbol] && HVL_DATA[nuclide.symbol][material]) {
            return HVL_DATA[nuclide.symbol][material];
        }
        return null;
    };

    const formatGammaSI = (valR) => (valR ? (valR * 0.01) / 3.7e10 : 0);
    const formatTBqToCi = (valTBq) => (valTBq ? valTBq * 27.027 : 0);

    // --- REFACTORED CONFIGURATION with SEMANTIC HIGHLIGHTING ---
    // highlightMode: 'highGood' (Green Max), 'lowGood' (Green Min), or 'neutral' (Blue Max)
    // useLogScale: true triggers logarithmic data bars for huge ranges
    const propertiesToCompare = [
        { 
            label: 'Half-life', 
            key: 'halfLife', 
            type: 'numeric', 
            highlightMode: 'neutral',
            useLogScale: true,
            getValue: (n) => parseHalfLifeToSeconds(n.halfLife),
            getDisplay: (n) => formatHalfLife(n.halfLife, getBestHalfLifeUnit(parseHalfLifeToSeconds(n.halfLife)))
        },
        { 
            label: 'Specific Activity', 
            key: 'specificActivity', 
            type: 'numeric', 
            highlightMode: 'highGood', // Higher SA usually means smaller source (often desirable)
            useLogScale: true,
            getValue: (n) => parseSpecificActivity(n.specificActivity), 
            getDisplay: (n) => {
                const val = parseSpecificActivity(n.specificActivity);
                const fmt = formatWithUnitSystem(val, 'activity', settings);
                return `${fmt.value} ${fmt.unit}`;
            }
        },
        { 
            label: settings.unitSystem === 'si' ? 'Gamma Const. (Sv·m²/hr·Bq)' : 'Gamma Const. (R·m²/hr·Ci)', 
            key: 'gammaConstant', 
            type: 'numeric', 
            highlightMode: 'lowGood', // Lower dose per curie is generally safer/easier to shield
            getValue: (n) => {
                const val = parseFloat(n.gammaConstant);
                return settings.unitSystem === 'si' ? formatGammaSI(val) : val;
            },
            getDisplay: (n) => {
                const val = parseFloat(n.gammaConstant);
                if (!val) return 'N/A';
                if (settings.unitSystem === 'si') return formatGammaSI(val).toExponential(2);
                return val.toFixed(4);
            }
        },
        { 
            label: 'Lead HVL (cm)', 
            key: 'hvl', 
            type: 'numeric', 
            highlightMode: 'lowGood', // Lower HVL = Easier to shield
            getValue: (n) => getHVL(n, 'Lead'),
            getDisplay: (n) => getHVL(n, 'Lead') || 'N/A'
        },
        { 
            label: 'Primary Gamma (MeV)', 
            key: 'gammaE', 
            type: 'numeric', 
            highlightMode: 'neutral',
            getValue: (n) => parseEnergyToMeV(n.emissionEnergies?.gamma),
            getDisplay: (n) => n.emissionEnergies?.gamma?.[0] || 'None'
        },
        { 
            label: 'Max Beta (MeV)', 
            key: 'betaE', 
            type: 'numeric', 
            highlightMode: 'neutral',
            getValue: (n) => parseEnergyToMeV(n.emissionEnergies?.beta),
            getDisplay: (n) => n.emissionEnergies?.beta?.[0] || 'None'
        },
        { 
            label: 'Alpha Energy (MeV)', 
            key: 'alphaE', 
            type: 'numeric', 
            highlightMode: 'neutral',
            getValue: (n) => parseEnergyToMeV(n.emissionEnergies?.alpha),
            getDisplay: (n) => n.emissionEnergies?.alpha?.[0] || 'None'
        },
        { 
            label: settings.unitSystem === 'si' ? 'Ingestion ALI (Bq)' : 'Ingestion ALI (µCi)', 
            key: 'aliIngest', 
            type: 'numeric', 
            highlightMode: 'highGood', // Higher ALI = Less radiotoxic
            useLogScale: true,
            getValue: (n) => n.dosimetry?.ALI?.ingestion, 
            getDisplay: (n) => {
                const val = n.dosimetry?.ALI?.ingestion;
                if (!val) return 'N/A';
                const fmt = formatWithUnitSystem(val, 'ali', settings);
                return fmt.value; 
            }
        },
        { 
            label: settings.unitSystem === 'si' ? 'D-Value (TBq)' : 'D-Value (Ci)', 
            key: 'dValue', 
            type: 'numeric', 
            highlightMode: 'highGood', // Higher D-Value = Less dangerous for security
            useLogScale: true,
            getValue: (n) => settings.unitSystem === 'si' ? n.dValue : formatTBqToCi(n.dValue),
            getDisplay: (n) => {
                const val = n.dValue;
                if (!val) return 'N/A';
                if (settings.unitSystem === 'si') return val;
                return formatTBqToCi(val).toLocaleString(undefined, { maximumFractionDigits: 1 });
            }
        },
        { 
            label: settings.unitSystem === 'si' ? 'A₁ Limit (TBq)' : 'A₁ Limit (Ci)', 
            key: 'a1', 
            type: 'numeric', 
            highlightMode: 'highGood', // Higher limit = Easier shipping
            useLogScale: true,
            getValue: (n) => {
                const val = n.shipping?.A1;
                if (val === 'unlimited') return Infinity;
                return settings.unitSystem === 'si' ? val : formatTBqToCi(val);
            },
            getDisplay: (n) => {
                const val = n.shipping?.A1;
                if (!val) return 'N/A';
                if (val === 'unlimited') return 'Unlimited';
                const num = settings.unitSystem === 'si' ? val : formatTBqToCi(val);
                return typeof num === 'number' ? num.toLocaleString(undefined, { maximumFractionDigits: 3 }) : num;
            }
        },
        { 
            label: settings.unitSystem === 'si' ? 'A₂ Limit (TBq)' : 'A₂ Limit (Ci)', 
            key: 'a2', 
            type: 'numeric', 
            highlightMode: 'highGood', 
            useLogScale: true,
            getValue: (n) => {
                const val = n.shipping?.A2;
                if (val === 'unlimited') return Infinity;
                return settings.unitSystem === 'si' ? val : formatTBqToCi(val);
            },
            getDisplay: (n) => {
                const val = n.shipping?.A2;
                if (!val) return 'N/A';
                if (val === 'unlimited') return 'Unlimited';
                const num = settings.unitSystem === 'si' ? val : formatTBqToCi(val);
                return typeof num === 'number' ? num.toLocaleString(undefined, { maximumFractionDigits: 4 }) : num;
            }
        },
        { label: 'Parent', type: 'categorical', render: (n) => <ClickableNuclide text={n.parent} radionuclides={radionuclides} onNuclideClick={onNuclideClick} /> },
        { label: 'Daughter', type: 'categorical', render: (n) => <ClickableNuclide text={n.daughter} radionuclides={radionuclides} onNuclideClick={onNuclideClick} /> },
    ];

    const sortedNuclides = React.useMemo(() => [...radionuclides].sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    const handleAddNuclide = (symbol) => onAddToCompare(symbol);
    const handleExportToCSV = () => {
        const headers = ['Property', ...comparisonList.map(n => n.name)];
        const rows = propertiesToCompare.map(prop => {
            const rowData = [prop.label];
            comparisonList.forEach(nuclide => {
                let val = 'N/A';
                if (prop.getDisplay) val = prop.getDisplay(nuclide);
                else if (prop.getValue) val = prop.getValue(nuclide);
                else if (prop.render) val = nuclide[prop.key] || 'N/A'; // Fallback
                rowData.push(String(val).replace(/,/g, ' '));
            });
            return rowData.join(',');
        });
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "radionuclide_comparison.csv";
        link.click();
    };

    const handleConfirmClear = () => { onClearCompare(); setIsModalOpen(false); };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-7xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Compare Radionuclides</h2>
                    <div className="flex items-center gap-2">
                        {comparisonList.length > 0 && (
                            <>
                                <button onClick={() => setIsModalOpen(true)} className="px-3 py-2 text-sm bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition flex items-center gap-2">
                                    <Icon path={ICONS.clear} className="w-4 h-4" /> Clear
                                </button>
                                <button onClick={handleExportToCSV} className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2">
                                    <Icon path={ICONS.database} className="w-4 h-4" /> Export CSV
                                </button>
                            </>
                        )}
                    </div>
                </div>

                <div className="flex items-center gap-2 mb-6 p-4 bg-slate-100 dark:bg-slate-800/50 rounded-lg">
                    <SearchableSelect options={sortedNuclides.filter(n => !comparisonList.find(c => c.symbol === n.symbol))} onSelect={handleAddNuclide} placeholder="Search to add a nuclide..." />
                </div>

                {comparisonList.length === 0 ? (
                    <div className="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg">
                        <Icon path={ICONS.compare} className="w-12 h-12 text-slate-400 dark:text-slate-500 mx-auto" />
                        <h3 className="mt-4 text-lg font-semibold text-slate-600 dark:text-slate-300">The Comparison Table is Empty</h3>
                        <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">Add nuclides using the search box above.</p>
                    </div>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[600px] text-left border-collapse">
                            <thead>
                                <tr>
                                    {/* FIX: z-20 ensures this corner stays on top of both the scrolling row headers and col headers */}
                                    <th className="sticky left-0 top-0 z-20 bg-slate-50 dark:bg-slate-700 p-3 text-sm font-semibold border-b border-r border-slate-200 dark:border-slate-600">Property</th>
                                    {comparisonList.map(nuclide => (
                                        <th key={nuclide.symbol} className="sticky top-0 z-10 bg-slate-100 dark:bg-slate-800 p-3 text-sm font-semibold border-b border-slate-200 dark:border-slate-600 min-w-[140px]">
                                            <div className="flex justify-between items-center">
                                                <span className="cursor-pointer hover:text-sky-500" onClick={() => onNuclideClick(nuclide)}>{nuclide.name}</span>
                                                <button onClick={() => onRemoveFromCompare(nuclide.symbol)} className="ml-2 text-slate-400 hover:text-red-500"><Icon path={ICONS.clear} className="w-4 h-4"/></button>
                                            </div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {propertiesToCompare.map(prop => {
                                    let numericValues = [];
                                    let maxVal = -Infinity, minVal = Infinity;
                                    
                                    if (prop.type === 'numeric') {
                                        numericValues = comparisonList.map(n => {
                                            const v = prop.getValue ? prop.getValue(n) : null;
                                            return (typeof v === 'number' && !isNaN(v) && v !== Infinity) ? v : null;
                                        });
                                        const validValues = numericValues.filter(v => v !== null && v > 0);
                                        if (validValues.length > 0) {
                                            maxVal = Math.max(...validValues);
                                            minVal = Math.min(...validValues);
                                        }
                                    }

                                    return (
                                        <tr key={prop.label} className="group hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                            <td className="sticky left-0 z-10 bg-white dark:bg-slate-800 group-hover:bg-slate-50 dark:group-hover:bg-slate-800/50 p-3 font-medium text-slate-500 dark:text-slate-400 border-b border-r border-slate-200 dark:border-slate-600 text-xs uppercase tracking-wide">
                                                {prop.label}
                                            </td>

                                            {comparisonList.map((nuclide, idx) => {
                                                let cellContent;
                                                let cellClass = 'border-b border-slate-200 dark:border-slate-600 transition-colors duration-200';
                                                
                                                if (prop.render) {
                                                    cellContent = prop.render(nuclide);
                                                } else {
                                                    const rawVal = prop.getValue ? prop.getValue(nuclide) : null;
                                                    const displayVal = prop.getDisplay ? prop.getDisplay(nuclide) : (rawVal || 'N/A');

                                                    if (prop.type === 'numeric') {
                                                        const numVal = numericValues[idx];
                                                        let barWidth = 0;

                                                        if (numVal !== null && maxVal > 0) {
                                                            // LOGARITHMIC SCALING for huge ranges (Half Life, SA)
                                                            if (prop.useLogScale && minVal > 0 && maxVal / minVal > 100) {
                                                                const logMin = Math.log10(minVal);
                                                                const logMax = Math.log10(maxVal);
                                                                const logVal = Math.log10(numVal);
                                                                // Normalizing log scale to 0-100%
                                                                barWidth = ((logVal - logMin) / (logMax - logMin)) * 100;
                                                                // Ensure a minimum visibility for the smallest value
                                                                barWidth = Math.max(barWidth, 5); 
                                                            } else {
                                                                // Linear scale for tighter ranges
                                                                barWidth = (numVal / maxVal) * 100;
                                                            }

                                                            // SEMANTIC HIGHLIGHTING
                                                            if (prop.highlightMode === 'highGood') {
                                                                if (numVal === maxVal) cellClass += ' bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 font-bold';
                                                                if (numVal === minVal) cellClass += ' text-slate-500 dark:text-slate-400';
                                                            } else if (prop.highlightMode === 'lowGood') {
                                                                if (numVal === minVal) cellClass += ' bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 font-bold';
                                                                if (numVal === maxVal) cellClass += ' text-slate-500 dark:text-slate-400';
                                                            } else { // Neutral (Blue Max)
                                                                if (numVal === maxVal) cellClass += ' bg-sky-50 dark:bg-sky-900/20 text-sky-700 dark:text-sky-300 font-bold';
                                                            }
                                                        }

                                                        cellContent = (
                                                            <div className="relative h-full w-full flex items-center">
                                                                {barWidth > 0 && (
                                                                    <div 
                                                                        className={`absolute bottom-0 left-0 h-1 transition-all duration-500 ${
                                                                            prop.highlightMode === 'highGood' ? (numVal === maxVal ? 'bg-green-500' : 'bg-green-200') :
                                                                            prop.highlightMode === 'lowGood' ? (numVal === minVal ? 'bg-green-500' : 'bg-slate-300') :
                                                                            'bg-sky-400' 
                                                                        }`} 
                                                                        style={{ width: `${barWidth}%`, opacity: 0.4 }} 
                                                                    />
                                                                )}
                                                                <span className="relative z-10">{displayVal}</span>
                                                            </div>
                                                        );
                                                    } else {
                                                        cellContent = <span>{displayVal}</span>;
                                                    }
                                                }
                                                return <td key={nuclide.symbol} className={`${cellClass} p-3 text-sm`}>{cellContent}</td>;
                                            })}
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
            <ConfirmationModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onConfirm={handleConfirmClear} title="Clear Comparison"><p>Are you sure you want to clear the list?</p></ConfirmationModal>
        </div>
    );
};
              
              /**
              * @description React component for a versatile dose and dose rate calculation suite.
              * This component functions as a multi-tool, allowing users to estimate dose from various
              * types of radiation and source geometries. It integrates with a pre-populated database
              * of radionuclide properties but also supports manual input for greater flexibility.
              *
              * The calculator provides four primary modes:
              * 1.  **Gamma:** Calculates dose rate from gamma-emitting sources in different geometries
              * (point, line, or area) using the specific gamma-ray constant and the inverse-square law,
              * with appropriate geometric corrections.
              * 2.  **Beta:** Estimates dose from beta sources in two sub-modes:
              * - **Skin Dose:** Calculates the absorbed dose at the skin surface from a
              * surface contamination.
              * - **Dose in Air:** Calculates the dose rate in air from a point source,
              * considering the beta particle's maximum range.
              * 3.  **Bremsstrahlung:** Calculates the dose rate from Bremsstrahlung (braking radiation)
              * produced when a beta source is shielded by a high-Z material.
              * 4.  **Internal:** Estimates the **Committed Effective Dose Equivalent (CEDE)** from a
              * known intake of a radionuclide, based on the **Annual Limit on Intake (ALI)**
              * values specified in 10 CFR 20 Appendix B.
              *
              * This component is a central hub for many fundamental dose and dose rate calculations,
              * simplifying complex radiological physics for practical application.
              *
              * @prop {array} radionuclides - A comprehensive array of all known radionuclides,
              * used as the data source for the calculator's modes.
              * @prop {string} preselectedNuclide - An optional prop to pre-fill the calculator with
              * a specific nuclide symbol from another part of the application (e.g., from the main
              * nuclide search).
              */
                      
const DoseRateCalculator = ({ radionuclides, preselectedNuclide }) => {
    const CALC_MODE_GAMMA = 'gamma';
    const CALC_MODE_BETA = 'beta';
    const CALC_MODE_BREMS = 'bremsstrahlung';
    const CALC_MODE_INTERNAL = 'internal';
    
    const INPUT_MODE_DB = 'fromSource';
    const INPUT_MODE_MANUAL = 'manual';
    const GEOMETRY_POINT = 'point';
    const GEOMETRY_LINE = 'line';
    const GEOMETRY_AREA = 'area';
    const BETA_MODE_SKIN = 'skin';
    const BETA_MODE_AIR = 'air';
    const METHOD_10CFR20 = '10CFR20';
    const METHOD_FGR11 = 'FGR11';

    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    // --- Units ---
    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq', 'TBq'] : ['µCi', 'mCi', 'Ci'], [settings.unitSystem]);
    const distanceUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['mm', 'cm', 'm'] : ['in', 'ft', 'm'], [settings.unitSystem]);
    const intakeUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq'] : ['pCi', 'nCi', 'µCi', 'mCi', 'Ci'], [settings.unitSystem]);

    // --- State ---
    const [calcMode, setCalcMode] = React.useState(() => localStorage.getItem('doseRate_calcMode') || CALC_MODE_GAMMA);
    const [inputMode, setInputMode] = React.useState(() => localStorage.getItem('doseRate_inputMode') || INPUT_MODE_DB);
    const [geometryMode, setGeometryMode] = React.useState(() => localStorage.getItem('doseRate_geometryMode') || GEOMETRY_POINT);
    const [doseMethod, setDoseMethod] = React.useState(() => localStorage.getItem('doseRate_doseMethod') || METHOD_10CFR20);

    // Inputs
    const [activity, setActivity] = React.useState(() => localStorage.getItem('doseRate_activity') || '1');
    const [activityUnit, setActivityUnit] = React.useState(() => localStorage.getItem('doseRate_activityUnit') || activityUnits[0]);
    const [distance, setDistance] = React.useState(() => localStorage.getItem('doseRate_distance') || '1');
    const [distanceUnit, setDistanceUnit] = React.useState(() => localStorage.getItem('doseRate_distanceUnit') || distanceUnits[0]);
    
    // Geometry Specific
    const [lineLength, setLineLength] = React.useState('1');
    const [lineLengthUnit, setLineLengthUnit] = React.useState('m');
    const [linearActivityUnit, setLinearActivityUnit] = React.useState('mCi/m');
    const [diskRadius, setDiskRadius] = React.useState('10');
    const [diskRadiusUnit, setDiskRadiusUnit] = React.useState('cm');
    const [arealActivityUnit, setArealActivityUnit] = React.useState('µCi/cm²');
    
    // Beta/Brems Specific
    const [shieldMaterial, setShieldMaterial] = React.useState('Plastic');
    const [betaMode, setBetaMode] = React.useState(BETA_MODE_SKIN);
    const [skinActivity, setSkinActivity] = React.useState('1000');
    const [skinActivityUnit, setSkinActivityUnit] = React.useState('dpm/100cm²');

    // Internal Specific
    const [intakeRoute, setIntakeRoute] = React.useState('inhalation');
    const [solubility, setSolubility] = React.useState('');
    const [intakeAmount, setIntakeAmount] = React.useState('1');
    const [intakeUnit, setIntakeUnit] = React.useState(intakeUnits[2]);

    // Manual Data
    const [nuclideSymbol, setNuclideSymbol] = React.useState('');
    const [manualGammaConstant, setManualGammaConstant] = React.useState('');
    const [manualBetaEnergy, setManualBetaEnergy] = React.useState('');
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // --- Persistence Effects ---
    React.useEffect(() => {
        localStorage.setItem('doseRate_calcMode', calcMode);
        localStorage.setItem('doseRate_inputMode', inputMode);
        localStorage.setItem('doseRate_geometryMode', geometryMode);
        localStorage.setItem('doseRate_doseMethod', doseMethod);
        localStorage.setItem('doseRate_activity', activity);
        localStorage.setItem('doseRate_activityUnit', activityUnit);
        localStorage.setItem('doseRate_distance', distance);
        localStorage.setItem('doseRate_distanceUnit', distanceUnit);
    }, [calcMode, inputMode, geometryMode, doseMethod, activity, activityUnit, distance, distanceUnit]);

    React.useEffect(() => {
        if (!activityUnits.includes(activityUnit)) setActivityUnit(activityUnits[0]);
        if (!distanceUnits.includes(distanceUnit)) setDistanceUnit(distanceUnits[0]);
    }, [settings.unitSystem]);

    React.useEffect(() => { if (preselectedNuclide) { setNuclideSymbol(preselectedNuclide.symbol); setInputMode(INPUT_MODE_DB); } }, [preselectedNuclide]);

    // Data Filtering
    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    const betaNuclides = React.useMemo(() => radionuclides.filter(n => n.emissionEnergies?.beta?.length > 0 || n.daughterEmissions?.beta?.length > 0).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);
    const dosimetryNuclides = React.useMemo(() => radionuclides.filter(n => n.dosimetry?.ALI).sort((a, b) => a.name.localeCompare(b.name)), [radionuclides]);

    const availableNuclides = React.useMemo(() => {
        switch (calcMode) {
            case CALC_MODE_GAMMA: return gammaNuclides;
            case CALC_MODE_BETA:
            case CALC_MODE_BREMS: return betaNuclides;
            case CALC_MODE_INTERNAL: return dosimetryNuclides;
            default: return [];
        }
    }, [calcMode, gammaNuclides, betaNuclides, dosimetryNuclides]);

    const selectedNuclide = React.useMemo(() => radionuclides.find(n => n.symbol === nuclideSymbol), [nuclideSymbol, radionuclides]);
    
    const availableClasses = React.useMemo(() => {
        if (!selectedNuclide || !selectedNuclide.dosimetry) return [];
        const sourceObject = doseMethod === METHOD_FGR11 ? selectedNuclide.dosimetry.DCF : selectedNuclide.dosimetry.ALI;
        if (!sourceObject) return [];
        return Object.keys(sourceObject).filter(k => k.startsWith('inhalation_')).map(k => k.split('_')[1]);
    }, [selectedNuclide, doseMethod]);

    React.useEffect(() => {
        if (calcMode === CALC_MODE_INTERNAL && intakeRoute === 'inhalation' && availableClasses.length > 0) {
            if (!solubility || !availableClasses.includes(solubility)) setSolubility(availableClasses[0]);
        }
    }, [calcMode, intakeRoute, availableClasses, solubility]);

    // --- Calculation Logic ---
    const activityFactorsCi = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'TBq': 1 / 0.037, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1 };
    const distanceFactorsM = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048, 'km': 1000 };
    const linearActivityFactorsCi_per_m = { 'µCi/cm': 1e-4, 'mCi/cm': 0.1, 'Ci/cm': 100, 'µCi/m': 1e-6, 'mCi/m': 1e-3, 'Ci/m': 1 };
    const arealActivityFactorsCi_per_m2 = { 'µCi/cm²': 0.01, 'mCi/cm²': 10, 'Ci/cm²': 10000, 'µCi/m²': 1e-6, 'mCi/m²': 1e-3, 'Ci/m²': 1 };
    const intakeUnitFactors = { 'pCi': 1e-6, 'nCi': 1e-3, 'µCi': 1, 'mCi': 1000, 'Ci': 1e6, 'Bq': 1/37000, 'kBq': 1/37, 'MBq': 1000/37, 'GBq': 1e6/37 };
    const intakeUnitFactorsBq = { 'pCi': 0.037, 'nCi': 37, 'µCi': 37000, 'mCi': 3.7e7, 'Ci': 3.7e10, 'Bq': 1, 'kBq': 1000, 'MBq': 1e6, 'GBq': 1e9 };
    const concentrationFactors_uCi_per_cm2 = { 'dpm/100cm²': 1 / 2.22e8, 'µCi/cm²': 1, 'mCi/cm²': 1000, 'Ci/cm²': 1e6, 'Bq/cm²': 1 / 37000 };

    React.useEffect(() => {
        try {
            setError(''); setResult(null);
            const A_val = parseFloat(activity);
            const d_val = parseFloat(distance);
            
            if (calcMode !== CALC_MODE_INTERNAL && (isNaN(d_val) || d_val <= 0)) {
                if(distance) setError("Distance must be > 0."); return;
            }

            switch (calcMode) {
                case CALC_MODE_GAMMA: {
                    let gammaConstant = 0;
                    if (inputMode === INPUT_MODE_DB) {
                        if (!selectedNuclide) { setResult(null); return; }
                        gammaConstant = parseFloat(selectedNuclide.gammaConstant);
                    } else {
                        gammaConstant = parseFloat(manualGammaConstant);
                        if (isNaN(gammaConstant) || gammaConstant <= 0) { setResult(null); return; }
                    }

                    const d_m = d_val * distanceFactorsM[distanceUnit];
                    let doseRateR_hr = 0;

                    if (geometryMode === GEOMETRY_POINT) {
                        if (isNaN(A_val)) { setResult(null); return; }
                        const A_Ci = A_val * activityFactorsCi[activityUnit];
                        doseRateR_hr = (gammaConstant * A_Ci) / Math.pow(d_m, 2);
                    } 
                    else if (geometryMode === GEOMETRY_LINE) {
                        const len_val = parseFloat(lineLength);
                        if (isNaN(len_val) || len_val <= 0) { setError("Invalid line length"); return; }
                        const len_m = len_val * distanceFactorsM[lineLengthUnit];
                        const A_L_Ci_m = A_val * linearActivityFactorsCi_per_m[linearActivityUnit];
                        doseRateR_hr = (gammaConstant * A_L_Ci_m / d_m) * 2 * Math.atan(len_m / (2 * d_m));
                    } 
                    else if (geometryMode === GEOMETRY_AREA) {
                        const r_val = parseFloat(diskRadius);
                        if (isNaN(r_val) || r_val <= 0) { setError("Invalid radius"); return; }
                        const r_m = r_val * distanceFactorsM[diskRadiusUnit];
                        const A_A_Ci_m2 = A_val * arealActivityFactorsCi_per_m2[arealActivityUnit];
                        doseRateR_hr = Math.PI * gammaConstant * A_A_Ci_m2 * Math.log((Math.pow(r_m, 2) + Math.pow(d_m, 2)) / Math.pow(d_m, 2));
                    }
                    setResult({ type: 'gamma', rawDoseRate_mrem_hr: doseRateR_hr * 1000 });
                    break;
                }

                case CALC_MODE_BETA:
                case CALC_MODE_BREMS: {
                    let E_max = 0;
                    if (inputMode === INPUT_MODE_DB) {
                        if (!selectedNuclide) { setResult(null); return; }
                        if (selectedNuclide.emissionEnergies?.beta?.length > 0) {
                            E_max = parseEnergyToMeV(selectedNuclide.emissionEnergies.beta);
                        } else if (selectedNuclide.daughterEmissions?.beta?.length > 0) {
                             const str = selectedNuclide.daughterEmissions.beta[0];
                             E_max = parseFloat(str.split(' ')[0]);
                        }
                    } else {
                        E_max = parseFloat(manualBetaEnergy);
                        if (isNaN(E_max) || E_max <= 0) { setResult(null); return; }
                    }
                    
                    if (!E_max) { setError("No beta energy found."); return; }

                    if (calcMode === CALC_MODE_BETA) {
                        if (betaMode === BETA_MODE_SKIN) {
                            const skin_val = parseFloat(skinActivity);
                            if (isNaN(skin_val)) { setResult(null); return; }
                            const conc_uCi_cm2 = skin_val * concentrationFactors_uCi_per_cm2[skinActivityUnit];
                            
                            // Physics Check
                            let doseRate_rad_hr = 0;
                            let note = "";
                            if (E_max < 0.07) {
                                doseRate_rad_hr = 0;
                                note = `E_max (${E_max.toFixed(3)} MeV) is too low to penetrate the dead skin layer. Dose is zero.`;
                            } else {
                                let factor = 9.0;
                                if (E_max < 0.6) {
                                    factor = 9.0 * ((E_max - 0.07) / (0.6 - 0.07));
                                }
                                doseRate_rad_hr = factor * conc_uCi_cm2;
                            }
                            setResult({ type: 'beta_skin', rawDoseRate_mrem_hr: doseRate_rad_hr * 1000, e_max: E_max, sourceNote: note });
                        } else {
                            if (isNaN(A_val)) { setResult(null); return; }
                            const A_Ci = A_val * activityFactorsCi[activityUnit];
                            const d_ft = (d_val * distanceFactorsM[distanceUnit]) * 3.28084;
                            const d_m = d_val * distanceFactorsM[distanceUnit];
                            
                            let range_g_cm2 = E_max > 0.8 ? (0.542 * E_max - 0.133) : (0.407 * Math.pow(E_max, 1.38));
                            const range_m = (range_g_cm2 / 0.001225) / 100;
                            const isBeyondRange = d_m >= range_m;
                            
                            let doseRate_rad_hr = 0;
                            if (!isBeyondRange) {
                                doseRate_rad_hr = (300 * A_Ci) / Math.pow(d_ft, 2);
                            }
                            setResult({ type: 'beta_air', rawDoseRate_mrem_hr: doseRate_rad_hr * 1000, e_max: E_max, isBeyondRange, range_m: range_m.toPrecision(2) });
                        }
                    } else {
                        // Bremsstrahlung
                        const matProps = SHIELDING_MATERIALS[shieldMaterial];
                        if (!matProps) { setError("Invalid shield material."); setResult(null); return; }
                        const A_Ci = A_val * activityFactorsCi[activityUnit];
                        const d_m = d_val * distanceFactorsM[distanceUnit];
                        const doseRate_R_hr_1m = (6e-4 * matProps.Z * Math.pow(E_max, 2) * A_Ci);
                        const finalRate = doseRate_R_hr_1m / Math.pow(d_m, 2);
                        const fraction = 3.5e-4 * matProps.Z * E_max;
                        setResult({ type: 'bremsstrahlung', rawDoseRate_mrem_hr: finalRate * 1000, bremsstrahlungFraction: (fraction * 100).toPrecision(2) });
                    }
                    break;
                }

                case CALC_MODE_INTERNAL: {
                     if (!selectedNuclide) { setResult(null); return; }
                     const I_val = parseFloat(intakeAmount);
                     if (isNaN(I_val) || I_val <= 0) { setResult(null); return; }
                     
                     const dataKey = intakeRoute === 'ingestion' ? 'ingestion' : `inhalation_${solubility}`;
                     let cede_mrem = 0;
                     if (doseMethod === METHOD_10CFR20) {
                         const I_uCi = I_val * intakeUnitFactors[intakeUnit];
                         const ALI = selectedNuclide.dosimetry.ALI?.[dataKey];
                         if (!ALI) { setError(`ALI not found for ${dataKey}`); setResult(null); return; }
                         cede_mrem = (I_uCi / ALI) * 5000;
                     } else {
                         const I_Bq = I_val * intakeUnitFactorsBq[intakeUnit];
                         const DCF = selectedNuclide.dosimetry.DCF?.[dataKey];
                         if (!DCF) { setError(`DCF not found for ${dataKey}`); setResult(null); return; }
                         cede_mrem = (I_Bq * DCF) * 100000;
                     }
                     setResult({ type: 'internal', rawDose_mrem: cede_mrem, method: doseMethod });
                     break;
                }
            }
        } catch (e) { setError(e.message); setResult(null); }
    }, [calcMode, inputMode, geometryMode, doseMethod, selectedNuclide, activity, activityUnit, distance, distanceUnit, lineLength, linearActivityUnit, diskRadius, arealActivityUnit, shieldMaterial, manualGammaConstant, manualBetaEnergy, betaMode, skinActivity, skinActivityUnit, intakeRoute, solubility, intakeAmount, intakeUnit]);

    const handleSaveToHistory = () => {
        if (result) {
            const formattedResult = formatDoseValue(result.rawDoseRate_mrem_hr || result.rawDose_mrem, result.type === 'internal' ? 'dose' : 'doseRate', settings);
            addHistory({ id: Date.now(), type: 'Dose Calculation', icon: ICONS.doseRate, inputs: calcMode, result: `${formattedResult.value} ${formattedResult.unit}`, view: VIEWS.DOSE_RATE });
            addToast("Saved to history!");
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <div className="flex justify-between items-center mb-6">
                   <h2 className="text-xl font-bold text-slate-800 dark:text-white">Dose Calculator</h2>
                   <ClearButton onClick={() => { setCalcMode(CALC_MODE_GAMMA); setInputMode(INPUT_MODE_DB); setNuclideSymbol(''); setResult(null); }} />
               </div>

               {/* VISUAL IMPROVEMENT: Prominent Tabs */}
               <div className="grid grid-cols-4 gap-2 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6">
                   {[CALC_MODE_GAMMA, CALC_MODE_BETA, CALC_MODE_BREMS, CALC_MODE_INTERNAL].map(m => {
                       const label = m === CALC_MODE_BREMS ? 'Brems.' : m.charAt(0).toUpperCase() + m.slice(1);
                       const isActive = calcMode === m;
                       return (
                           <button key={m} onClick={() => setCalcMode(m)}
                               className={`py-2 rounded-md text-sm font-semibold transition-all truncate px-1
                               ${isActive ? 'bg-white dark:bg-slate-800 text-sky-600 shadow-sm' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600'}`}>
                               {label}
                           </button>
                       );
                   })}
               </div>

               {/* Input Mode Toggle */}
               {calcMode !== CALC_MODE_INTERNAL && (
                   <div className="flex justify-center mb-6 animate-fade-in">
                       <div className="flex bg-slate-100 dark:bg-slate-900 rounded-lg p-1">
                           <button onClick={() => setInputMode(INPUT_MODE_DB)} className={`px-4 py-1.5 text-sm font-medium rounded transition-colors ${inputMode === INPUT_MODE_DB ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500 dark:text-slate-400'}`}>Database</button>
                           <button onClick={() => setInputMode(INPUT_MODE_MANUAL)} className={`px-4 py-1.5 text-sm font-medium rounded transition-colors ${inputMode === INPUT_MODE_MANUAL ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500 dark:text-slate-400'}`}>Manual Input</button>
                       </div>
                   </div>
               )}

               {/* Main Input Section */}
               <div className="space-y-5 p-1">
                   {/* 1. Source Selection */}
                   {calcMode !== CALC_MODE_INTERNAL && inputMode === INPUT_MODE_DB && (
                       <div className="min-h-[42px]">{selectedNuclide ? <CalculatorNuclideInfo nuclide={selectedNuclide} onClear={() => setNuclideSymbol('')} /> : <SearchableSelect options={availableNuclides} onSelect={setNuclideSymbol} placeholder={`Search ${calcMode} emitters...`} />}</div>
                   )}
                   
                   {/* Manual Inputs */}
                   {calcMode === CALC_MODE_GAMMA && inputMode === INPUT_MODE_MANUAL && (
                       <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gamma Constant (Γ)</label><div className="flex"><input type="number" value={manualGammaConstant} onChange={e => setManualGammaConstant(e.target.value)} className="w-full p-2.5 bg-slate-100 dark:bg-slate-700 rounded-l-md border-r-0 focus:ring-sky-500"/><span className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-500 text-sm">R·m²/hr·Ci</span></div></div>
                   )}
                   {(calcMode === CALC_MODE_BETA || calcMode === CALC_MODE_BREMS) && inputMode === INPUT_MODE_MANUAL && (
                       <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Max Beta Energy (E<sub>max</sub>)</label><div className="flex"><input type="number" value={manualBetaEnergy} onChange={e => setManualBetaEnergy(e.target.value)} className="w-full p-2.5 bg-slate-100 dark:bg-slate-700 rounded-l-md border-r-0 focus:ring-sky-500"/><span className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-500 text-sm">MeV</span></div></div>
                   )}
                   
                   {/* Geometry Toggles */}
                   {calcMode === CALC_MODE_GAMMA && (
                       <div>
                           <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Source Geometry</label>
                           <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-900 rounded-lg">
                               <button onClick={() => setGeometryMode(GEOMETRY_POINT)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${geometryMode === GEOMETRY_POINT ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Point</button>
                               <button onClick={() => setGeometryMode(GEOMETRY_LINE)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${geometryMode === GEOMETRY_LINE ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Line</button>
                               <button onClick={() => setGeometryMode(GEOMETRY_AREA)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${geometryMode === GEOMETRY_AREA ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Disk</button>
                           </div>
                       </div>
                   )}

                   {/* Beta Mode Toggles */}
                   {calcMode === CALC_MODE_BETA && (
                       <div className="flex gap-2 mb-4 p-1 bg-slate-100 dark:bg-slate-900 rounded-lg"><button onClick={() => setBetaMode(BETA_MODE_SKIN)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${betaMode === BETA_MODE_SKIN ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Skin Dose (Contamination)</button><button onClick={() => setBetaMode(BETA_MODE_AIR)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${betaMode === BETA_MODE_AIR ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Dose in Air (External)</button></div>
                   )}

                   {/* Standard Activity/Distance Inputs */}
                   {(calcMode === CALC_MODE_GAMMA || calcMode === CALC_MODE_BREMS || (calcMode === CALC_MODE_BETA && betaMode === BETA_MODE_AIR)) && (
                       <div className="grid grid-cols-2 gap-4 animate-fade-in">
                           <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Total Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2.5 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="p-2.5 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{activityUnits.map(u=><option key={u}>{u}</option>)}</select></div></div>
                           <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full p-2.5 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="p-2.5 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{distanceUnits.map(u=><option key={u}>{u}</option>)}</select></div></div>
                       </div>
                   )}
                   
                   {/* Specific Inputs based on mode */}
                   {calcMode === CALC_MODE_GAMMA && geometryMode === GEOMETRY_LINE && (
                        <div className="animate-fade-in">
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Line Source Parameters</label>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="flex"><input type="number" value={lineLength} onChange={e => setLineLength(e.target.value)} placeholder="Length" className="w-full p-2.5 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={lineLengthUnit} onChange={e => setLineLengthUnit(e.target.value)} className="p-2.5 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{distanceUnits.map(u=><option key={u}>{u}</option>)}</select></div>
                                <select value={linearActivityUnit} onChange={e => setLinearActivityUnit(e.target.value)} className="w-full p-2.5 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"><option>µCi/cm</option><option>mCi/cm</option><option>Ci/cm</option><option>µCi/m</option><option>mCi/m</option><option>Ci/m</option></select>
                            </div>
                        </div>
                   )}
                   {calcMode === CALC_MODE_GAMMA && geometryMode === GEOMETRY_AREA && (
                        <div className="animate-fade-in">
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Disk Source Parameters</label>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="flex"><input type="number" value={diskRadius} onChange={e => setDiskRadius(e.target.value)} placeholder="Radius" className="w-full p-2.5 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={diskRadiusUnit} onChange={e => setDiskRadiusUnit(e.target.value)} className="p-2.5 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{distanceUnits.map(u=><option key={u}>{u}</option>)}</select></div>
                                <select value={arealActivityUnit} onChange={e => setArealActivityUnit(e.target.value)} className="w-full p-2.5 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"><option>µCi/cm²</option><option>mCi/cm²</option><option>Ci/cm²</option><option>µCi/m²</option><option>mCi/m²</option><option>Ci/m²</option></select>
                            </div>
                        </div>
                   )}

                   {calcMode === CALC_MODE_BETA && betaMode === BETA_MODE_SKIN && (
                       <div className="animate-fade-in"><div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Surface Contamination Level</label><div className="flex"><input type="number" value={skinActivity} onChange={e => setSkinActivity(e.target.value)} className="w-full p-2.5 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={skinActivityUnit} onChange={e => setSkinActivityUnit(e.target.value)} className="p-2.5 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{['dpm/100cm²', 'µCi/cm²'].map(u=><option key={u}>{u}</option>)}</select></div></div></div>
                   )}
                   
                   {calcMode === CALC_MODE_BREMS && (
                       <div className="animate-fade-in"><div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Shielding Material (Interactions)</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full p-2.5 bg-slate-100 dark:bg-slate-700 rounded-md text-sm">{Object.keys(SHIELDING_MATERIALS).filter(m => m !== 'None').map(m => <option key={m} value={m}>{m} (Z≈{SHIELDING_MATERIALS[m].Z})</option>)}</select></div></div>
                   )}

                   {calcMode === CALC_MODE_INTERNAL && (
                       <div className="space-y-4 animate-fade-in">
                           <div>
                               <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Dosimetry Methodology</label>
                               <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-900 rounded-lg">
                                   <button onClick={() => setDoseMethod(METHOD_10CFR20)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${doseMethod === METHOD_10CFR20 ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>10 CFR 20 (ALI)</button>
                                   <button onClick={() => setDoseMethod(METHOD_FGR11)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${doseMethod === METHOD_FGR11 ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>FGR 11 (DCF)</button>
                               </div>
                           </div>
                           <div className="grid grid-cols-2 gap-4">
                               <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Route</label><select value={intakeRoute} onChange={e => setIntakeRoute(e.target.value)} className="w-full p-2.5 rounded bg-slate-100 dark:bg-slate-700 text-sm"><option value="inhalation">Inhalation</option><option value="ingestion">Ingestion</option></select></div>
                               {intakeRoute === 'inhalation' && <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Lung Class</label><select value={solubility} onChange={e => setSolubility(e.target.value)} className="w-full p-2.5 rounded bg-slate-100 dark:bg-slate-700 text-sm" disabled={availableClasses.length === 0}>{availableClasses.length > 0 ? availableClasses.map(c=><option key={c}>{c}</option>) : <option>N/A</option>}</select></div>}
                           </div>
                           <div><label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Total Intake</label><div className="flex"><input type="number" value={intakeAmount} onChange={e => setIntakeAmount(e.target.value)} className="w-full p-2.5 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={intakeUnit} onChange={e => setIntakeUnit(e.target.value)} className="p-2.5 rounded-r-md bg-slate-200 dark:bg-slate-600 text-sm">{intakeUnits.map(u=><option key={u}>{u}</option>)}</select></div></div>
                       </div>
                   )}
               </div>

               {error && <p className="text-red-500 text-sm text-center mt-4 bg-red-50 dark:bg-red-900/20 p-2 rounded">{error}</p>}
               
               {/* VISUAL IMPROVEMENT: Polished Result Box */}
               {result && (
                   <div className="mt-8 p-6 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm relative overflow-hidden">
                       <div className="flex justify-end -mt-3 -mr-3 mb-2"><Tooltip text="Save to history"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-600 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip></div>
                       
                       <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">
                           {result.type === 'internal' ? 'Committed Effective Dose' : 'Calculated Dose Rate'}
                       </p>
                       
                       <div className="flex items-end justify-center gap-2 mb-2">
                           <span className="text-4xl font-bold text-sky-600 dark:text-sky-400">
                               {formatDoseValue(result.rawDoseRate_mrem_hr || result.rawDose_mrem, result.type === 'internal' ? 'dose' : 'doseRate', settings).value}
                           </span>
                           <span className="text-xl font-medium text-slate-600 dark:text-slate-300 pb-1">
                               {formatDoseValue(result.rawDoseRate_mrem_hr || result.rawDose_mrem, result.type === 'internal' ? 'dose' : 'doseRate', settings).unit}
                           </span>
                       </div>
                       
                       {/* Contextual Warnings */}
                       {result.sourceNote && (
                            <div className="mt-4 p-2 bg-slate-200 dark:bg-slate-600 rounded text-slate-700 dark:text-slate-200 text-xs italic">
                                {result.sourceNote}
                            </div>
                       )}
                       {result.type === 'beta_air' && result.isBeyondRange && (
                           <div className="mt-4 p-2 bg-green-100 dark:bg-green-900/50 rounded text-green-800 dark:text-green-200 text-xs font-semibold">
                               Target is beyond max beta range ({result.range_m} m). Dose is zero.
                           </div>
                       )}
                       {result.type === 'beta_air' && !result.isBeyondRange && (
                           <div className="mt-4 p-2 bg-amber-100 dark:bg-amber-900/50 rounded text-amber-800 dark:text-amber-200 text-xs">
                               <strong>Conservative Estimate:</strong> Ignores air attenuation. Actual dose will be lower.
                           </div>
                       )}
                       {result.type === 'bremsstrahlung' && <p className="text-xs text-slate-500 mt-2">Radiative Fraction (Yield): ~{result.bremsstrahlungFraction}%</p>}
                   </div>
               )}
            </div>
        </div>
    );
};

/**
 * @description A helper component to display quick-select buttons for common nuclides.
 */
const QuickNuclideSelector = ({ onSelect }) => {
    const commonNuclides = ['Cs-137', 'Co-60', 'Ir-192', 'Am-241'];
    return (
        <div className="flex flex-wrap gap-2 mt-2">
            <span className="text-xs text-slate-400 py-1">Quick Select:</span>
            {commonNuclides.map(sym => (
                <button 
                    key={sym} 
                    onClick={() => onSelect(sym)}
                    className="px-2 py-1 text-xs font-semibold bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded hover:bg-sky-100 dark:hover:bg-sky-800 transition-colors"
                >
                    {sym}
                </button>
            ))}
        </div>
    );
};

              /**
              * @description A calculator for photon shielding with three modes:
              * 1. (From Source) Calculates final dose rate from a specific radionuclide.
              * 2. (Find Thickness) Calculates required shielding thickness for a specific radionuclide.
              * 3. (Generic Rate) Calculates final OR initial dose rate from a user-inputted HVL.
              */
              
const ShieldingCalculator = ({ radionuclides, preselectedNuclide }) => {
    // --- Constants ---
    const MODE_GAMMA_DOSE = 'gammaDose';
    const MODE_FIND_THICKNESS = 'findThickness';
    const MODE_BETA_RANGE = 'betaRange';
    
    const DEFINE_BY_SOURCE = 'bySource';
    const DEFINE_BY_RATE = 'byRate';
    
    const INPUT_MODE_DB = 'fromSource';
    const INPUT_MODE_MANUAL = 'manual';
    
    // --- Context & Hooks ---
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    // --- Units ---
    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq', 'TBq'] : ['µCi', 'mCi', 'Ci'], [settings.unitSystem]);
    const distanceUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['mm', 'cm', 'm'] : ['in', 'ft', 'm'], [settings.unitSystem]);
    const doseRateUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['µSv/hr', 'mSv/hr', 'Sv/hr'] : ['µrem/hr', 'mrem/hr', 'rem/hr', 'mR/hr', 'R/hr'], [settings.unitSystem]);

    // --- State ---
    const [calcMode, setCalcMode] = React.useState(() => localStorage.getItem('shielding_calcMode') || MODE_GAMMA_DOSE);
    const [definitionMode, setDefinitionMode] = React.useState(DEFINE_BY_SOURCE);
    const [inputMode, setInputMode] = React.useState(INPUT_MODE_DB);
    const [useManualHVL, setUseManualHVL] = React.useState(false);
    const [useBuildup, setUseBuildup] = React.useState(false);
    
    const [nuclideSymbol, setNuclideSymbol] = React.useState(() => localStorage.getItem('shielding_nuclideSymbol') || '');
    const [activity, setActivity] = React.useState('1');
    const [activityUnit, setActivityUnit] = React.useState(activityUnits[1]);
    const [distance, setDistance] = React.useState('1');
    const [distanceUnit, setDistanceUnit] = React.useState(distanceUnits[2]);
    
    const [unshieldedRate, setUnshieldedRate] = React.useState('100');
    const [unshieldedRateUnit, setUnshieldedRateUnit] = React.useState(doseRateUnits[1]);
    
    const [genericReference, setGenericReference] = React.useState('Cs-137'); 
    
    const [manualGamma, setManualGamma] = React.useState('');
    const [manualHVL, setManualHVL] = React.useState('');
    const [manualBetaEnergy, setManualBetaEnergy] = React.useState('');
    
    const [shieldMaterial, setShieldMaterial] = React.useState('Lead');
    const [shieldThickness, setShieldThickness] = React.useState('1');
    const [thicknessUnit, setThicknessUnit] = React.useState('cm');
    const [targetDoseRate, setTargetDoseRate] = React.useState('2');
    const [targetDoseRateUnit, setTargetDoseRateUnit] = React.useState(doseRateUnits[1]);
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    // --- Persistence ---
    React.useEffect(() => {
        localStorage.setItem('shielding_calcMode', calcMode);
        localStorage.setItem('shielding_nuclideSymbol', nuclideSymbol);
    }, [calcMode, nuclideSymbol]);
    
    // --- Data Sources ---
    const SHIELD_PROPS = {
        'Lead': { density: 11.34, Z: 82, type: 'High-Z' },
        'Steel': { density: 7.85, Z: 26, type: 'High-Z' },
        'Tungsten': { density: 19.3, Z: 74, type: 'High-Z' },
        'Concrete': { density: 2.35, Z: 11, type: 'Low-Z' },
        'Aluminum': { density: 2.7, Z: 13, type: 'Low-Z' },
        'Plastic': { density: 1.18, Z: 6, type: 'Low-Z' },
        'Lucite/Acrylic': { density: 1.19, Z: 6, type: 'Low-Z' },
        'Glass': { density: 2.23, Z: 11, type: 'Low-Z' },
        'Water': { density: 1.0, Z: 7.4, type: 'Low-Z' }
    };

    const shieldingNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant && HVL_DATA[n.symbol]).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    const betaNuclides = React.useMemo(() => radionuclides.filter(n => n.emissionEnergies?.beta?.length > 0).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );
    
    const availableMaterials = React.useMemo(() => {
        if (calcMode === MODE_BETA_RANGE) return Object.keys(SHIELD_PROPS);
        if (useManualHVL) return ['Lead', 'Concrete', 'Steel', 'Water', 'Aluminum', 'Tungsten', 'Plastic', 'Glass'];
        if (definitionMode === DEFINE_BY_RATE) return ['Lead', 'Concrete', 'Steel', 'Water', 'Aluminum'];
        if (inputMode === INPUT_MODE_DB && nuclideSymbol && HVL_DATA[nuclideSymbol]) {
            return Object.keys(HVL_DATA[nuclideSymbol]).filter(k => k !== 'sourceRef');
        }
        return ['Lead', 'Concrete', 'Steel', 'Water', 'Aluminum', 'Tungsten'];
    }, [calcMode, inputMode, nuclideSymbol, definitionMode, useManualHVL]);

    React.useEffect(() => {
        if (!availableMaterials.includes(shieldMaterial)) setShieldMaterial(availableMaterials[0]);
    }, [availableMaterials, calcMode]);

    // Factors
    const activityFactors = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'TBq': 1/0.037, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1 };
    const distanceFactors = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };
    const thicknessFactors = { 'mm': 0.1, 'cm': 1, 'in': 2.54 };
    const doseRateFactors_mrem_hr = { 'µrem/hr': 0.001, 'mrem/hr': 1, 'rem/hr': 1000, 'mR/hr': 1, 'R/hr': 1000, 'µSv/hr': 0.1, 'mSv/hr': 100, 'Sv/hr': 100000 };

    // --- Core Calculation Logic ---
    React.useEffect(() => {
        try {
            setError(''); setResult(null);

            // 1. BETA CALCULATION
            if (calcMode === MODE_BETA_RANGE) {
                let E_max = 0;
                if (inputMode === INPUT_MODE_DB) {
                    if (!nuclideSymbol) return;
                    const n = radionuclides.find(r => r.symbol === nuclideSymbol);
                    if (n?.emissionEnergies?.beta) E_max = parseEnergyToMeV(n.emissionEnergies.beta);
                } else {
                    E_max = parseFloat(manualBetaEnergy);
                }

                if (!E_max || E_max <= 0) return;

                const mat = SHIELD_PROPS[shieldMaterial];
                if (!mat) { setError("Invalid shield material."); return; }

                let range_mg_cm2;
                if (E_max > 0.8) range_mg_cm2 = 542 * E_max - 133;
                else if (E_max >= 0.15) range_mg_cm2 = 407 * Math.pow(E_max, 1.38);
                else range_mg_cm2 = 407 * Math.pow(E_max, 1.38);
                
                const density_mg_cm3 = mat.density * 1000;
                const thickness_cm = range_mg_cm2 / density_mg_cm3;
                
                let warning = null;
                if (mat.type === 'High-Z') {
                    warning = `High-Z material (${shieldMaterial}) generates Bremsstrahlung X-rays. Use Plastic/Lucite instead.`;
                }

                setResult({ type: 'beta', thickness_cm, material: shieldMaterial, range_mg_cm2, warning });
                return;
            }

            // 2. GAMMA CALCULATIONS
            let unshieldedRate_R_hr = 0;

            if (definitionMode === DEFINE_BY_RATE) {
                const rateVal = parseFloat(unshieldedRate);
                if (isNaN(rateVal) || rateVal < 0) { if(unshieldedRate) setError("Rate must be positive."); return; }
                unshieldedRate_R_hr = (rateVal * doseRateFactors_mrem_hr[unshieldedRateUnit]) / 1000; 
            } else {
                const actVal = parseFloat(activity);
                const distVal = parseFloat(distance);
                
                if (isNaN(actVal) || isNaN(distVal) || actVal <= 0 || distVal <= 0) {
                     if (activity && distance) setError("Inputs must be valid positive numbers.");
                     return;
                }
                
                let gammaConst = 0;
                if (inputMode === INPUT_MODE_DB) {
                    if (nuclideSymbol) {
                        const n = radionuclides.find(r => r.symbol === nuclideSymbol);
                        gammaConst = parseFloat(n?.gammaConstant);
                    }
                } else {
                    gammaConst = parseFloat(manualGamma);
                }
                
                if (!gammaConst || isNaN(gammaConst)) { 
                    if(inputMode === INPUT_MODE_MANUAL) setError("Invalid Gamma Constant.");
                    return; 
                }

                const actCi = actVal * activityFactors[activityUnit];
                const distM = distVal * distanceFactors[distanceUnit];
                unshieldedRate_R_hr = (gammaConst * actCi) / Math.pow(distM, 2);
            }

            let hvl_cm = 0;
            if (useManualHVL) {
                hvl_cm = parseFloat(manualHVL);
            } else if (definitionMode === DEFINE_BY_RATE) {
                hvl_cm = HVL_DATA[genericReference]?.[shieldMaterial];
            } else if (inputMode === INPUT_MODE_DB && nuclideSymbol) {
                hvl_cm = HVL_DATA[nuclideSymbol]?.[shieldMaterial];
            } else {
                hvl_cm = parseFloat(manualHVL);
            }

            if ((!useManualHVL && !hvl_cm) || isNaN(hvl_cm) || hvl_cm <= 0) {
                if (shieldMaterial && definitionMode === DEFINE_BY_RATE) { /* Wait */ } 
                else if (shieldMaterial && nuclideSymbol) {
                    setError(`HVL data unavailable for ${shieldMaterial}. Enable "Override HVL" to enter it manually.`);
                }
                return;
            }

            if (calcMode === MODE_GAMMA_DOSE) {
                const thickVal = parseFloat(shieldThickness);
                if (isNaN(thickVal) || thickVal < 0) return;
                const thickCm = thickVal * thicknessFactors[thicknessUnit];
                
                let buildup = 1;
                if (useBuildup) {
                    const mu = Math.log(2) / hvl_cm;
                    const mfp = mu * thickCm;
                    buildup = 1 + mfp;
                }

                // --- PHYSICS FIX: Handle Near-Zero Transmission ---
                let transmission = Math.pow(0.5, thickCm / hvl_cm);
                if (transmission < 1e-9) transmission = 0; // Clamp absurdly small numbers to 0
                
                const shieldedRate_R_hr = unshieldedRate_R_hr * transmission * buildup;
                const shieldedRate_mrem_hr = shieldedRate_R_hr * 1000;
                
                let warning = null;
                if (useBuildup && thickCm > (3 * hvl_cm)) {
                     warning = "Linear buildup approximation may underestimate dose for thick shields (>3 HVL).";
                }

                setResult({
                    type: 'gamma_dose',
                    unshielded_mrem_hr: unshieldedRate_R_hr * 1000,
                    // Check if rate effectively 0
                    shielded_mrem_hr: shieldedRate_mrem_hr < 1e-9 ? 0 : shieldedRate_mrem_hr,
                    transmission: transmission,
                    buildup: buildup,
                    warning
                });

            } else if (calcMode === MODE_FIND_THICKNESS) {
                const targetVal = parseFloat(targetDoseRate);
                if (isNaN(targetVal) || targetVal <= 0) return;
                const target_R_hr = (targetVal * doseRateFactors_mrem_hr[targetDoseRateUnit]) / 1000;
                
                if (target_R_hr >= unshieldedRate_R_hr) {
                    setResult({ type: 'thickness', val: 0, msg: "Target > Unshielded Rate", unshielded_mrem_hr: unshieldedRate_R_hr * 1000 });
                    return;
                }

                let reqThickCm = hvl_cm * Math.log2(unshieldedRate_R_hr / target_R_hr);
                
                if (useBuildup) {
                    for(let i=0; i<5; i++) {
                        const mfp = (Math.log(2) / hvl_cm) * reqThickCm;
                        const B = 1 + mfp;
                        reqThickCm = hvl_cm * Math.log2((unshieldedRate_R_hr * B) / target_R_hr);
                    }
                }
                
                setResult({
                    type: 'thickness',
                    val: reqThickCm,
                    unshielded_mrem_hr: unshieldedRate_R_hr * 1000
                });
            }

        } catch (e) { setError(e.message); setResult(null); }
    }, [calcMode, definitionMode, inputMode, nuclideSymbol, manualGamma, manualHVL, manualBetaEnergy, activity, activityUnit, distance, distanceUnit, unshieldedRate, unshieldedRateUnit, genericReference, shieldMaterial, shieldThickness, thicknessUnit, targetDoseRate, targetDoseRateUnit, useManualHVL, useBuildup]);

    const handleSaveToHistory = () => {
        if (!result) return;
        let resStr = "";
        if (result.type === 'beta' || result.type === 'thickness') {
             const fmt = formatSensibleUnit(result.val || result.thickness_cm, 'distance');
             resStr = `${fmt.value} ${fmt.unit} ${shieldMaterial}`;
        } else {
             const fmt = formatDoseValue(result.shielded_mrem_hr, 'doseRate', settings);
             resStr = `${fmt.value} ${fmt.unit}`;
        }
        addHistory({ id: Date.now(), type: 'Shielding', icon: ICONS.shield, inputs: `${shieldMaterial} calculation`, result: resStr, view: VIEWS.SHIELDING });
        addToast("Saved to history!");
    };

    const handleClearInputs = () => {
        setCalcMode(MODE_GAMMA_DOSE);
        setDefinitionMode(DEFINE_BY_SOURCE);
        setInputMode(INPUT_MODE_DB);
        setUseManualHVL(false);
        setUseBuildup(false);
        setNuclideSymbol('');
        setActivity('1');
        setUnshieldedRate('100');
        setShieldMaterial('Lead');
        setShieldThickness('1');
        setResult(null);
        setError('');
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <div className="flex justify-between items-center mb-6">
                   <h2 className="text-xl font-bold text-slate-800 dark:text-white">Shielding Calculator</h2>
                   <ClearButton onClick={handleClearInputs} />
               </div>

               {/* MAIN TABS */}
               <div className="grid grid-cols-3 gap-2 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6">
                   {[
                       { id: MODE_GAMMA_DOSE, label: 'Gamma Dose' },
                       { id: MODE_FIND_THICKNESS, label: 'Find Thickness' },
                       { id: MODE_BETA_RANGE, label: 'Beta Range' }
                   ].map(tab => (
                       <button key={tab.id} onClick={() => setCalcMode(tab.id)}
                           className={`py-2 rounded-md text-sm font-bold transition-all
                           ${calcMode === tab.id ? 'bg-sky-600 text-white shadow-sm' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600'}`}>
                           {tab.label}
                       </button>
                   ))}
               </div>

               <div className="space-y-5">
                   
                   {/* 1. GAMMA DEFINITION MODE */}
                   {calcMode !== MODE_BETA_RANGE && (
                       <div className="flex justify-center mb-2">
                           <div className="flex bg-slate-100 dark:bg-slate-900 rounded-lg p-1">
                               <button onClick={() => setDefinitionMode(DEFINE_BY_SOURCE)} className={`px-4 py-1 text-xs font-bold rounded transition-colors ${definitionMode === DEFINE_BY_SOURCE ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Define Source</button>
                               <button onClick={() => setDefinitionMode(DEFINE_BY_RATE)} className={`px-4 py-1 text-xs font-bold rounded transition-colors ${definitionMode === DEFINE_BY_RATE ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Known Dose Rate</button>
                           </div>
                       </div>
                   )}

                   {/* 2. SOURCE INPUTS */}
                   {calcMode === MODE_BETA_RANGE || (definitionMode === DEFINE_BY_SOURCE) ? (
                       <>
                           {calcMode !== MODE_BETA_RANGE && (
                               <div className="flex justify-end -mt-4 mb-2">
                                   <button onClick={() => setInputMode(inputMode === INPUT_MODE_DB ? INPUT_MODE_MANUAL : INPUT_MODE_DB)} className="text-xs text-sky-600 hover:underline">
                                       Switch to {inputMode === INPUT_MODE_DB ? 'Manual' : 'Database'}
                                   </button>
                               </div>
                           )}
                           
                           {inputMode === INPUT_MODE_DB || calcMode === MODE_BETA_RANGE ? (
                               <div className="min-h-[42px]">
                                   {nuclideSymbol ? 
                                       <CalculatorNuclideInfo nuclide={radionuclides.find(n => n.symbol === nuclideSymbol)} onClear={() => setNuclideSymbol('')} /> 
                                       : <SearchableSelect options={calcMode === MODE_BETA_RANGE ? betaNuclides : shieldingNuclides} onSelect={setNuclideSymbol} placeholder="Select radionuclide..." />
                                   }
                               </div>
                           ) : (
                               <div className="grid grid-cols-2 gap-4 animate-fade-in">
                                   <div><label className="text-xs font-bold">Gamma Constant (Γ)</label><input type="number" value={manualGamma} onChange={e => setManualGamma(e.target.value)} className="w-full p-2 bg-slate-100 dark:bg-slate-700 rounded text-sm" placeholder="R·m²/hr·Ci" /></div>
                                   <div><label className="text-xs font-bold">Half-Value Layer (cm)</label><input type="number" value={manualHVL} onChange={e => { setManualHVL(e.target.value); setUseManualHVL(true); }} className="w-full p-2 bg-slate-100 dark:bg-slate-700 rounded text-sm" /></div>
                               </div>
                           )}
                           
                           {calcMode === MODE_BETA_RANGE && !nuclideSymbol && (
                                <div><label className="text-xs font-bold">Max Beta Energy (MeV)</label><input type="number" value={manualBetaEnergy} onChange={e => setManualBetaEnergy(e.target.value)} className="w-full p-2 bg-slate-100 dark:bg-slate-700 rounded text-sm" /></div>
                           )}

                           {calcMode !== MODE_BETA_RANGE && (
                               <div className="grid grid-cols-2 gap-4 animate-fade-in">
                                   <div><label className="text-xs font-bold mb-1 block">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{activityUnits.map(u=><option key={u}>{u}</option>)}</select></div></div>
                                   <div><label className="text-xs font-bold mb-1 block">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{distanceUnits.map(u=><option key={u}>{u}</option>)}</select></div></div>
                               </div>
                           )}
                       </>
                   ) : (
                       // 2B. KNOWN RATE INPUT + HELPER TEXT
                       <div className="animate-fade-in">
                           <label className="text-xs font-bold mb-1 block">Initial (Unshielded) Dose Rate</label>
                           <div className="flex">
                               <input type="number" value={unshieldedRate} onChange={e => setUnshieldedRate(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/>
                               <select value={unshieldedRateUnit} onChange={e => setUnshieldedRateUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{doseRateUnits.map(u=><option key={u}>{u}</option>)}</select>
                           </div>
                           
                           {!useManualHVL && (
                               <div className="mt-3 p-3 bg-blue-50 dark:bg-blue-900/30 text-xs text-blue-800 dark:text-blue-200 rounded border border-blue-100 dark:border-blue-800">
                                   <p><strong>Note:</strong> Since the isotope is unknown, we must assume an energy to estimate shielding effectiveness.</p>
                                   <div className="mt-2 flex items-center gap-2">
                                       <span className="font-semibold">Assume:</span>
                                       <select value={genericReference} onChange={e => setGenericReference(e.target.value)} className="p-1 rounded border border-blue-200 dark:border-blue-700 dark:bg-slate-800">
                                            <option value="I-125">Low Energy (I-125 / 30 keV)</option>
                                            <option value="Cs-137">Medium Energy (Cs-137 / 662 keV)</option>
                                            <option value="Co-60">High Energy (Co-60 / 1.25 MeV)</option>
                                       </select>
                                   </div>
                               </div>
                           )}
                       </div>
                   )}

                   {/* 3. SHIELDING CONFIG */}
                   <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                       <div className="flex justify-between items-center">
                           <label className="text-sm font-bold text-slate-700 dark:text-slate-300">Shielding Configuration</label>
                           {calcMode !== MODE_BETA_RANGE && (inputMode === INPUT_MODE_DB || definitionMode === DEFINE_BY_RATE) && (
                               <label className="flex items-center gap-2 text-xs cursor-pointer"><input type="checkbox" checked={useManualHVL} onChange={e => setUseManualHVL(e.target.checked)} className="form-checkbox h-3 w-3 rounded text-sky-600" /> Override HVL</label>
                           )}
                       </div>
                       
                       <div className="grid grid-cols-2 gap-4">
                           <div>
                               <label className="text-xs font-medium mb-1 block">Material</label>
                               <select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full p-2 bg-slate-100 dark:bg-slate-700 rounded text-sm">
                                   {availableMaterials.map(m => <option key={m} value={m}>{m}</option>)}
                               </select>
                           </div>
                           
                           {calcMode === MODE_GAMMA_DOSE && (
                               <div><label className="text-xs font-medium mb-1 block">Thickness</label><div className="flex"><input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{Object.keys(thicknessFactors).map(u=><option key={u}>{u}</option>)}</select></div></div>
                           )}
                           
                           {useManualHVL && calcMode !== MODE_BETA_RANGE && (
                               <div className="col-span-2"><label className="text-xs font-medium mb-1 block">Manual HVL (cm)</label><input type="number" value={manualHVL} onChange={e => setManualHVL(e.target.value)} className="w-full p-2 bg-slate-100 dark:bg-slate-700 rounded text-sm" /></div>
                           )}
                           
                           {calcMode === MODE_FIND_THICKNESS && (
                               <div className="col-span-2"><label className="text-xs font-medium mb-1 block">Target Dose Rate</label><div className="flex"><input type="number" value={targetDoseRate} onChange={e => setTargetDoseRate(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={targetDoseRateUnit} onChange={e => setTargetDoseRateUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{doseRateUnits.map(u=><option key={u}>{u}</option>)}</select></div></div>
                           )}
                       </div>
                       
                       {calcMode !== MODE_BETA_RANGE && (
                           <div className="flex justify-end pt-2">
                               <Tooltip text="Approximation (B = 1 + μx). Conservative for < 3 mfp."><label className="flex items-center gap-2 text-xs font-semibold cursor-pointer text-slate-600 dark:text-slate-400"><input type="checkbox" checked={useBuildup} onChange={e => setUseBuildup(e.target.checked)} className="form-checkbox h-3 w-3 rounded text-sky-600" /> Apply Buildup Factor</label></Tooltip>
                           </div>
                       )}
                   </div>
               </div>

               {error && <p className="text-red-500 text-sm text-center mt-4 bg-red-50 dark:bg-red-900/20 p-2 rounded">{error}</p>}

               {result && (
                   <div className="mt-6 p-6 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm relative overflow-hidden">
                       <div className="flex justify-end -mt-3 -mr-3 mb-2"><Tooltip text="Save to history"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-600 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip></div>
                       
                       {result.type === 'gamma_dose' && (
                           <>
                               <p className="text-xs uppercase font-bold text-slate-500 mb-2">Shielded Dose Rate</p>
                               <div className="flex items-center justify-center gap-2 mb-4">
                                   <span className="text-4xl font-extrabold text-sky-600 dark:text-sky-400">{formatDoseValue(result.shielded_mrem_hr, 'doseRate', settings).value}</span>
                                   <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">{formatDoseValue(result.shielded_mrem_hr, 'doseRate', settings).unit}</span>
                                   <CopyButton textToCopy={formatDoseValue(result.shielded_mrem_hr, 'doseRate', settings).value} />
                               </div>
                               <div className="grid grid-cols-2 gap-2 text-xs text-slate-600 dark:text-slate-300 border-t border-slate-200 dark:border-slate-600 pt-3">
                                   <p>Unshielded: <strong>{formatDoseValue(result.unshielded_mrem_hr, 'doseRate', settings).value} {formatDoseValue(result.unshielded_mrem_hr, 'doseRate', settings).unit}</strong></p>
                                   <p>Reduction: <strong>{result.reduction}x</strong></p>
                                   <p>Transmission: <strong>{result.transmission}%</strong></p>
                                   {useBuildup && <p>Buildup Factor: <strong>{result.buildup}</strong></p>}
                               </div>
                           </>
                       )}

                       {result.type === 'thickness' && (
                           <>
                               {result.val === 0 ? (
                                   <p className="text-amber-600 font-bold">No shielding required</p>
                               ) : (
                                   <>
                                       <p className="text-xs uppercase font-bold text-slate-500 mb-2">Required Thickness</p>
                                       <div className="flex items-center justify-center gap-2 mb-2">
                                           <span className="text-4xl font-extrabold text-sky-600 dark:text-sky-400">{formatSensibleUnit(result.val, 'distance').value}</span>
                                           <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">{formatSensibleUnit(result.val, 'distance').unit}</span>
                                       </div>
                                       <p className="text-sm text-slate-500">of {shieldMaterial}</p>
                                   </>
                               )}
                           </>
                       )}
                       
                       {result.type === 'beta' && (
                           <>
                               <p className="text-xs uppercase font-bold text-slate-500 mb-2">Range (Stopping Thickness)</p>
                               <div className="flex items-center justify-center gap-2 mb-2">
                                   <span className="text-4xl font-extrabold text-sky-600 dark:text-sky-400">{formatSensibleUnit(result.thickness_cm, 'distance').value}</span>
                                   <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">{formatSensibleUnit(result.thickness_cm, 'distance').unit}</span>
                               </div>
                               <p className="text-sm text-slate-500">of {result.material}</p>
                           </>
                       )}

                       {/* WARNINGS */}
                       <div className="space-y-2 mt-4 text-left">
                           {result.warning && <div className="p-2 bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-200 text-xs rounded font-medium border-l-4 border-amber-500">{result.warning}</div>}
                           {result.msg && <div className="p-2 bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 text-xs rounded">{result.msg}</div>}
                       </div>
                   </div>
               )}
            </div>
        </div>
    );
};
  
            /**
              * @description A calculator for determining allowable stay time and total dose received.
              * The dose rate can be calculated from a specific source or entered manually.
              */
             
const StayTimeCalculator = ({ radionuclides, preselectedNuclide }) => {
    const INPUT_MODE_SOURCE = 'fromSource';
    const INPUT_MODE_MANUAL = 'manualRate';
    
    const { settings } = React.useContext(SettingsContext);
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    const activityUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['Bq', 'kBq', 'MBq', 'GBq', 'TBq'] : ['µCi', 'mCi', 'Ci'], [settings.unitSystem]);
    const distanceUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['mm', 'cm', 'm'] : ['in', 'ft', 'm'], [settings.unitSystem]);
    const doseRateUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['µSv/hr', 'mSv/hr', 'Sv/hr'] : ['µrem/hr', 'mrem/hr', 'rem/hr'], [settings.unitSystem]);
    const doseUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['µSv', 'mSv', 'Sv'] : ['µrem', 'mrem', 'rem'], [settings.unitSystem]);
    
    const [inputMode, setInputMode] = React.useState(() => localStorage.getItem('stayTime_inputMode') || INPUT_MODE_SOURCE);
    const [nuclideSymbol, setNuclideSymbol] = React.useState(() => localStorage.getItem('stayTime_nuclideSymbol') || '');
    
    const [activity, setActivity] = React.useState(() => localStorage.getItem('stayTime_activity') || '1');
    const [activityUnit, setActivityUnit] = React.useState(activityUnits[1]);
    const [distance, setDistance] = React.useState(() => localStorage.getItem('stayTime_distance') || '1');
    const [distanceUnit, setDistanceUnit] = React.useState(distanceUnits[2]);
    const [transmission, setTransmission] = React.useState(() => localStorage.getItem('stayTime_transmission') || '1.0'); 
    
    const [manualDoseRate, setManualDoseRate] = React.useState(() => localStorage.getItem('stayTime_manualDoseRate') || '10');
    const [manualDoseRateUnit, setManualDoseRateUnit] = React.useState(doseRateUnits[1]);
    
    const [doseLimit, setDoseLimit] = React.useState(() => localStorage.getItem('stayTime_doseLimit') || '100');
    const [doseLimitUnit, setDoseLimitUnit] = React.useState(doseUnits[1]);
    
    const [plannedTime, setPlannedTime] = React.useState(() => localStorage.getItem('stayTime_plannedTime') || '10');
    const [plannedTimeUnit, setPlannedTimeUnit] = React.useState(() => localStorage.getItem('stayTime_plannedTimeUnit') || 'minutes');
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');
    
    // --- Persistence ---
    React.useEffect(() => {
        localStorage.setItem('stayTime_inputMode', inputMode);
        localStorage.setItem('stayTime_nuclideSymbol', nuclideSymbol);
        localStorage.setItem('stayTime_activity', activity);
        localStorage.setItem('stayTime_distance', distance);
        localStorage.setItem('stayTime_transmission', transmission);
        localStorage.setItem('stayTime_manualDoseRate', manualDoseRate);
        localStorage.setItem('stayTime_doseLimit', doseLimit);
        localStorage.setItem('stayTime_plannedTime', plannedTime);
        localStorage.setItem('stayTime_plannedTimeUnit', plannedTimeUnit);
    }, [inputMode, nuclideSymbol, activity, distance, transmission, manualDoseRate, doseLimit, plannedTime, plannedTimeUnit]);

    React.useEffect(() => { if (!activityUnits.includes(activityUnit)) setActivityUnit(activityUnits[1]); }, [activityUnits, activityUnit]);
    React.useEffect(() => { if (!distanceUnits.includes(distanceUnit)) setDistanceUnit(distanceUnits[2]); }, [distanceUnits, distanceUnit]);
    React.useEffect(() => { if (!doseRateUnits.includes(manualDoseRateUnit)) setManualDoseRateUnit(doseRateUnits[1]); }, [doseRateUnits, manualDoseRateUnit]);
    React.useEffect(() => { if (!doseUnits.includes(doseLimitUnit)) setDoseLimitUnit(doseUnits[1]); }, [doseUnits, doseLimitUnit]);
    
    React.useEffect(() => {
        const gammaNuclides = radionuclides.filter(n => n.gammaConstant);
        if (preselectedNuclide && gammaNuclides.find(n => n.symbol === preselectedNuclide)) {
            setNuclideSymbol(preselectedNuclide);
            setInputMode(INPUT_MODE_SOURCE);
        }
    }, [preselectedNuclide, radionuclides]);

    // --- Factors ---
    const activityFactorsCi = { 'Bq': 1 / 3.7e10, 'kBq': 1 / 3.7e7, 'MBq': 1 / 37000, 'GBq': 1 / 37, 'TBq': 1/0.037, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1 };
    const distanceFactorsM = { 'mm': 0.001, 'cm': 0.01, 'm': 1, 'in': 0.0254, 'ft': 0.3048 };
    const timeFactorsHours = { 'minutes': 1 / 60, 'hours': 1, 'days': 24 };
    const doseRateFactors_mrem_hr = { 'µrem/hr': 0.001, 'mrem/hr': 1, 'rem/hr': 1000, 'µSv/hr': 0.1, 'mSv/hr': 100, 'Sv/hr': 100000 };
    const doseFactors_mrem = { 'µrem': 0.001, 'mrem': 1, 'rem': 1000, 'µSv': 0.1, 'mSv': 100, 'Sv': 100000 };
    const timeUnits_ordered = ['minutes', 'hours', 'days'];
    const gammaNuclides = React.useMemo(() => radionuclides.filter(n => n.gammaConstant).sort((a,b) => a.name.localeCompare(b.name)), [radionuclides] );

    // --- Calculation ---
    const handleCalculate = React.useCallback(() => {
        let effectiveDoseRate_mrem_hr = 0;
        try {
            const transValue = parseFloat(transmission);
            if (isNaN(transValue) || transValue < 0 || transValue > 1) { throw new Error('Transmission must be between 0 and 1.'); }

            if (inputMode === INPUT_MODE_SOURCE) {
              const nuclide = gammaNuclides.find(n => n.symbol === nuclideSymbol);
              if (!nuclide) { throw new Error('Please select a radionuclide.'); }
              const activityValue = parseFloat(activity);
              const distanceValue = parseFloat(distance);

              if (isNaN(activityValue) || isNaN(distanceValue) || distanceValue <= 0 || activityValue < 0) { throw new Error('Please enter valid, positive numbers for activity and distance.'); }
              
              const gammaConstant = parseFloat(nuclide.gammaConstant);
              const activityInCi = activityValue * activityFactorsCi[activityUnit];
              const distanceInM = distanceValue * distanceFactorsM[distanceUnit];
              
              // Inverse Square + Transmission
              const doseRateR_hr = (gammaConstant * activityInCi) / Math.pow(distanceInM, 2);
              effectiveDoseRate_mrem_hr = doseRateR_hr * 1000 * transValue;

            } else { 
              const manualRate = parseFloat(manualDoseRate);
              if (isNaN(manualRate) || manualRate < 0) { throw new Error('Please enter a valid, non-negative dose rate.'); }
              const baseRate = manualRate * doseRateFactors_mrem_hr[manualDoseRateUnit];
              
              // FIX: Apply transmission to manual rate too
              effectiveDoseRate_mrem_hr = baseRate * transValue;
            }
            
            const limitVal = parseFloat(doseLimit);
            const plannedTimeValue = parseFloat(plannedTime);
            if (isNaN(limitVal) || isNaN(plannedTimeValue) || limitVal <= 0 || plannedTimeValue < 0) { throw new Error('Please enter valid, positive numbers for dose limit and planned time.'); }
            
            if (effectiveDoseRate_mrem_hr <= 1e-9) { 
               setResult({ rawDoseRate_mrem_hr: 0, stayTime: 'Infinite', rawTotalDose_mrem: 0, isSafe: true });
               return;
            }

            const limit_mrem = limitVal * doseFactors_mrem[doseLimitUnit];
            const stayTimeHours = limit_mrem / effectiveDoseRate_mrem_hr;
            
            let formattedStayTime = "";
            const totalMinutes = stayTimeHours * 60;
            if (totalMinutes > 6000) { 
                 formattedStayTime = `> 100 hours`;
            } else if (totalMinutes > 60) {
                const hrs = Math.floor(totalMinutes / 60);
                const mins = Math.round(totalMinutes % 60);
                formattedStayTime = `${hrs} hr ${mins} min`;
            } else {
                const mins = Math.floor(totalMinutes);
                const secs = Math.round((totalMinutes - mins) * 60);
                formattedStayTime = `${mins} min ${secs} sec`;
            }

            const plannedTimeInHours = plannedTimeValue * timeFactorsHours[plannedTimeUnit];
            const totalDoseReceived_mrem = effectiveDoseRate_mrem_hr * plannedTimeInHours;
            const isSafe = totalDoseReceived_mrem <= limit_mrem;
            
            setResult({ rawDoseRate_mrem_hr: effectiveDoseRate_mrem_hr, stayTime: formattedStayTime, rawTotalDose_mrem: totalDoseReceived_mrem, isSafe: isSafe });
        } catch(e) {
            setError(e.message);
            setResult(null);
        }
    }, [inputMode, nuclideSymbol, activity, activityUnit, distance, distanceUnit, transmission, manualDoseRate, manualDoseRateUnit, doseLimit, doseLimitUnit, plannedTime, plannedTimeUnit, gammaNuclides]);

    React.useEffect(() => {
        setResult(null);
        setError('');
        if (inputMode === INPUT_MODE_SOURCE && !nuclideSymbol) { return; }
        handleCalculate();
    }, [handleCalculate]);

    const handleClearInputs = () => {
        setInputMode(INPUT_MODE_SOURCE);
        setNuclideSymbol('');
        setActivity('1');
        setDistance('1');
        setTransmission('1.0');
        setManualDoseRate('10');
        setDoseLimit('100');
        setPlannedTime('10');
        setError('');
        setResult(null);
        
        const keysToClear = ['stayTime_inputMode', 'stayTime_nuclideSymbol', 'stayTime_activity', 'stayTime_distance', 'stayTime_transmission', 'stayTime_manualDoseRate', 'stayTime_doseLimit', 'stayTime_plannedTime'];
        keysToClear.forEach(key => localStorage.removeItem(key));
    };

    const handleSaveToHistory = () => {
        if (result) {
           const formattedDoseRate = formatDoseValue(result.rawDoseRate_mrem_hr, 'doseRate', settings);
           addHistory({ 
               id: Date.now(), 
               type: 'Stay Time', 
               icon: ICONS.stopwatch, 
               inputs: `${formattedDoseRate.value} ${formattedDoseRate.unit}, ${doseLimit} ${doseLimitUnit} limit`, 
               result: result.stayTime, 
               view: VIEWS.STAY_TIME 
           });
           addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
              <div className="flex justify-between items-center mb-6">
                  <h2 className="text-xl font-bold text-slate-800 dark:text-white">Stay Time Calculator</h2>
                  <ClearButton onClick={handleClearInputs} />
              </div>
              
              <div className="flex justify-center mb-6">
                  <div className="flex bg-slate-100 dark:bg-slate-900 rounded-lg p-1 w-full">
                      <button onClick={() => setInputMode(INPUT_MODE_SOURCE)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${inputMode === INPUT_MODE_SOURCE ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Calculate from Source</button>
                      <button onClick={() => setInputMode(INPUT_MODE_MANUAL)} className={`flex-1 py-1.5 text-sm font-medium rounded transition-colors ${inputMode === INPUT_MODE_MANUAL ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Known Dose Rate</button>
                  </div>
              </div>
              
              <div className="space-y-4">
                  {inputMode === INPUT_MODE_SOURCE ? (
                      <div className="space-y-4 animate-fade-in">
                          <div className="min-h-[42px]">
                              {nuclideSymbol ? 
                                  <CalculatorNuclideInfo nuclide={gammaNuclides.find(n => n.symbol === nuclideSymbol)} onClear={() => setNuclideSymbol('')} /> : 
                                  <SearchableSelect options={gammaNuclides} onSelect={setNuclideSymbol} placeholder="Select a gamma source..." />
                              }
                          </div>
                          
                          <div className="grid grid-cols-2 gap-4">
                              <div><label className="text-xs font-bold mb-1 block">Activity</label><div className="flex"><input type="number" value={activity} onChange={e => setActivity(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={activityUnit} onChange={e => setActivityUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{activityUnits.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                              <div><label className="text-xs font-bold mb-1 block">Distance</label><div className="flex"><input type="number" value={distance} onChange={e => setDistance(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={distanceUnit} onChange={e => setDistanceUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{distanceUnits.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                          </div>
                      </div>
                  ) : (
                      <div className="animate-fade-in">
                          <label className="text-xs font-bold mb-1 block">Work Area Dose Rate (Unshielded)</label>
                          <div className="flex"><input type="number" value={manualDoseRate} onChange={e => setManualDoseRate(e.target.value)} className="w-full p-2 rounded-l bg-slate-100 dark:bg-slate-700 text-sm"/><select value={manualDoseRateUnit} onChange={e => setManualDoseRateUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{doseRateUnits.map(u => <option key={u} value={u}>{u}</option>)}</select></div>
                      </div>
                  )}
                  
                  {/* Shared Transmission Input */}
                  <div>
                      <Tooltip text="Factor to account for shielding. 1.0 = Unshielded. 0.5 = 1 HVL.">
                          <label className="text-xs font-bold mb-1 block cursor-help underline decoration-dotted">Transmission Factor (0-1)</label>
                      </Tooltip>
                      <input type="number" step="0.1" min="0" max="1" value={transmission} onChange={e => setTransmission(e.target.value)} className="w-full p-2 rounded bg-slate-100 dark:bg-slate-700 text-sm" placeholder="e.g., 0.5 for 1 HVL"/>
                  </div>
                  
                  {/* Planning Section */}
                  <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 bg-slate-50 dark:bg-slate-800/50">
                      <div className="flex items-center gap-2 mb-1"><Icon path={ICONS.stopwatch} className="w-4 h-4 text-slate-400"/><span className="text-sm font-bold text-slate-600 dark:text-slate-300">ALARA Planning</span></div>
                      <div className="grid grid-cols-2 gap-4">
                          <div><label className="text-xs font-bold mb-1 block">Dose Limit</label><div className="flex"><input type="number" value={doseLimit} onChange={e => setDoseLimit(e.target.value)} className="w-full p-2 rounded-l bg-white dark:bg-slate-700 text-sm"/><select value={doseLimitUnit} onChange={e => setDoseLimitUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{doseUnits.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                          <div><label className="text-xs font-bold mb-1 block">Planned Time</label><div className="flex"><input type="number" value={plannedTime} onChange={e => setPlannedTime(e.target.value)} className="w-full p-2 rounded-l bg-white dark:bg-slate-700 text-sm"/><select value={plannedTimeUnit} onChange={e => setPlannedTimeUnit(e.target.value)} className="rounded-r bg-slate-200 dark:bg-slate-600 text-xs">{timeUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
                      </div>
                  </div>

                  {error && <p className="text-red-500 text-sm text-center bg-red-50 dark:bg-red-900/20 p-2 rounded">{error}</p>}

                  {result && (
                      <div className="mt-6 p-6 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm relative overflow-hidden">
                          <div className="flex justify-end -mt-3 -mr-3 mb-2"><Tooltip text="Save to history"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-600 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip></div>
                          
                          <p className="text-xs uppercase font-bold text-slate-500 mb-2">Maximum Stay Time</p>
                          <div className="flex items-center justify-center gap-2 mb-4">
                              <span className="text-4xl font-extrabold text-sky-600 dark:text-sky-400">{result.stayTime}</span>
                              <CopyButton textToCopy={result.stayTime} />
                          </div>
                          
                          <div className="grid grid-cols-2 gap-2 text-xs text-slate-600 dark:text-slate-300 border-t border-slate-200 dark:border-slate-600 pt-3">
                              <div>
                                  <p>Effective Rate:</p>
                                  <p className="font-bold text-sm text-slate-800 dark:text-white">
                                      {formatDoseValue(result.rawDoseRate_mrem_hr, 'doseRate', settings).value} {formatDoseValue(result.rawDoseRate_mrem_hr, 'doseRate', settings).unit}
                                  </p>
                              </div>
                              <div>
                                  <p>Proj. Dose:</p>
                                  <p className={`font-bold text-sm ${result.isSafe ? 'text-green-600 dark:text-green-400' : 'text-red-500'}`}>
                                      {formatDoseValue(result.rawTotalDose_mrem, 'dose', settings).value} {formatDoseValue(result.rawTotalDose_mrem, 'dose', settings).unit}
                                  </p>
                              </div>
                          </div>
                          
                          {!result.isSafe && <p className="text-xs font-bold text-red-500 mt-2 bg-red-50 dark:bg-red-900/30 p-1 rounded">Planned time exceeds dose limit!</p>}
                      </div>
                  )}
              </div>
            </div>
        </div>
    );
};

             /**
              * Data and components for the Neutron Tools module.
              */
              
              // --- Data from 10 CFR 20.1004 for Fluence/Dose Conversion ---
              
              const NEUTRON_CONVERSION_FACTORS = [
              { energyMeV: 2.5e-8, fluencePerRem: 980e6, q: 2, label: 'Thermal (0.025 eV)' },
              { energyMeV: 1e-7, fluencePerRem: 980e6, q: 2, label: '0.1 eV' },
              { energyMeV: 1e-6, fluencePerRem: 810e6, q: 2, label: '1 eV' },
              { energyMeV: 1e-5, fluencePerRem: 810e6, q: 2, label: '10 eV' },
              { energyMeV: 1e-4, fluencePerRem: 840e6, q: 2, label: '100 eV' },
              { energyMeV: 1e-3, fluencePerRem: 980e6, q: 2, label: '1 keV' },
              { energyMeV: 1e-2, fluencePerRem: 1000e6, q: 2.5, label: '10 keV' },
              { energyMeV: 1e-1, fluencePerRem: 170e6, q: 7.5, label: '100 keV' },
              { energyMeV: 5e-1, fluencePerRem: 39e6, q: 11, label: '0.5 MeV' },
              { energyMeV: 1, fluencePerRem: 27e6, q: 11, label: '1 MeV' },
              { energyMeV: 2.5, fluencePerRem: 29e6, q: 9, label: '2.5 MeV' },
              { energyMeV: 5, fluencePerRem: 23e6, q: 8, label: '5 MeV' },
              { energyMeV: 7, fluencePerRem: 24e6, q: 7, label: '7 MeV' },
              { energyMeV: 10, fluencePerRem: 24e6, q: 6.5, label: '10 MeV' },
              { energyMeV: 14, fluencePerRem: 17e6, q: 7.5, label: '14 MeV' },
              { energyMeV: 20, fluencePerRem: 16e6, q: 8, label: '20 MeV' },
              { energyMeV: 40, fluencePerRem: 14e6, q: 7, label: '40 MeV' },
              { energyMeV: 60, fluencePerRem: 16e6, q: 5.5, label: '60 MeV' },
              { energyMeV: 100, fluencePerRem: 20e6, q: 4, label: '100 MeV' },
              { energyMeV: 200, fluencePerRem: 19e6, q: 3.5, label: '200 MeV' },
              { energyMeV: 300, fluencePerRem: 19e6, q: 3.5, label: '300 MeV' },
              { energyMeV: 400, fluencePerRem: 20e6, q: 3.5, label: '400 MeV' }
              ];
              
              // 1. Updated Data with Abundances
const NEUTRON_ACTIVATION_DATA = [
    { targetSymbol: 'Co-59', name: 'Cobalt-59', atomicWeight: 58.933, thermalCrossSection_barns: 37.2, productSymbol: 'Co-60', abundance: 100 },
    { targetSymbol: 'Na-23', name: 'Sodium-23', atomicWeight: 22.990, thermalCrossSection_barns: 0.53, productSymbol: 'Na-24', abundance: 100 },
    { targetSymbol: 'Au-197', name: 'Gold-197', atomicWeight: 196.967, thermalCrossSection_barns: 98.65, productSymbol: 'Au-198', abundance: 100 },
    { targetSymbol: 'Ir-191', name: 'Iridium-191', atomicWeight: 190.960, thermalCrossSection_barns: 954, productSymbol: 'Ir-192', abundance: 37.3 },
    { targetSymbol: 'Ho-165', name: 'Holmium-165', atomicWeight: 164.930, thermalCrossSection_barns: 64.7, productSymbol: 'Ho-166', abundance: 100 },
    { targetSymbol: 'Fe-58', name: 'Iron-58', atomicWeight: 57.933, thermalCrossSection_barns: 1.3, productSymbol: 'Fe-59', abundance: 0.282 },
    { targetSymbol: 'Lu-176', name: 'Lutetium-176', atomicWeight: 175.942, thermalCrossSection_barns: 2090, productSymbol: 'Lu-177', abundance: 2.59 },
    { targetSymbol: 'Ta-181', name: 'Tantalum-181', atomicWeight: 180.948, thermalCrossSection_barns: 20.6, productSymbol: 'Ta-182', abundance: 99.988 },
    { targetSymbol: 'Sc-45', name: 'Scandium-45', atomicWeight: 44.956, thermalCrossSection_barns: 27.5, productSymbol: 'Sc-46', abundance: 100 },
    { targetSymbol: 'Cu-63', name: 'Copper-63', atomicWeight: 62.929, thermalCrossSection_barns: 4.5, productSymbol: 'Cu-64', abundance: 69.15 },
    { targetSymbol: 'Ag-109', name: 'Silver-109', atomicWeight: 108.905, thermalCrossSection_barns: 89, productSymbol: 'Ag-110m', abundance: 48.16 },
    { targetSymbol: 'Sb-123', name: 'Antimony-123', atomicWeight: 122.904, thermalCrossSection_barns: 4.1, productSymbol: 'Sb-124', abundance: 42.79 },
    { targetSymbol: 'Eu-151', name: 'Europium-151', atomicWeight: 150.920, thermalCrossSection_barns: 9200, productSymbol: 'Eu-152', abundance: 47.8 },
    { targetSymbol: 'Ca-44', name: 'Calcium-44', atomicWeight: 43.955, thermalCrossSection_barns: 1.0, productSymbol: 'Ca-45', abundance: 2.086 },
].sort((a,b) => a.name.localeCompare(b.name));
              
// --- Updated Data: Expanded Material & Shielding Data ---

// 1. Expanded Composite Materials
const COMPOSITE_MATERIALS_DATA = {
    'Ordinary Concrete': {
        density_g_cm3: 2.3,
        composition: [ 
            { element: 'Sodium-23', targetSymbol: 'Na-23', massFraction: 0.01 }, 
            { element: 'Iron-58', targetSymbol: 'Fe-58', massFraction: 0.015 * 0.0028 }, 
            { element: 'Cobalt-59', targetSymbol: 'Co-59', massFraction: 0.00001 }, 
            { element: 'Europium-151', targetSymbol: 'Eu-151', massFraction: 0.000001 }, 
            { element: 'Calcium-44', targetSymbol: 'Ca-44', massFraction: 0.08 * 0.02086 }
        ]
    },
    'Standard Human Tissue': {
        density_g_cm3: 1.0,
        composition: [ { element: 'Sodium-23', targetSymbol: 'Na-23', massFraction: 0.0015 } ]
    },
    'Stainless Steel 304': {
        density_g_cm3: 8.0,
        composition: [ 
            { element: 'Iron-58', targetSymbol: 'Fe-58', massFraction: 0.70 * 0.0028 }, 
            { element: 'Cobalt-59', targetSymbol: 'Co-59', massFraction: 0.001 },
            { element: 'Chromium-50', targetSymbol: 'Cr-50', massFraction: 0.19 * 0.0435 }
        ]
    },
    'Aluminum 6061': {
        density_g_cm3: 2.7,
        composition: [
            { element: 'Aluminum-27', targetSymbol: 'Al-27', massFraction: 0.97 }, // Activates to Al-28 (short) -> Na-24 (via n,alpha)
            { element: 'Magnesium-26', targetSymbol: 'Mg-26', massFraction: 0.01 * 0.11 }, // Activates to Mg-27
            { element: 'Copper-63', targetSymbol: 'Cu-63', massFraction: 0.003 * 0.69 }
        ]
    },
    'Standard Soil': {
        density_g_cm3: 1.6,
        composition: [
            { element: 'Sodium-23', targetSymbol: 'Na-23', massFraction: 0.006 }, // Na-24
            { element: 'Manganese-55', targetSymbol: 'Mn-55', massFraction: 0.0008 }, // Mn-56
            { element: 'Aluminum-27', targetSymbol: 'Al-27', massFraction: 0.07 } // Al-28
        ]
    }
};

// 2. Expanded Neutron Shielding Data (Split Fission vs 14 MeV)
// Values approximated from NCRP 38 / 79 & IAEA
const NEUTRON_SHIELDING_DATA = {
    'Water': { thermal: 2.8, fission: 6.1, fusion14: 12.0 },
    'Polyethylene': { thermal: 3.5, fission: 5.3, fusion14: 10.5 },
    'Concrete': { thermal: 4.8, fission: 10.7, fusion14: 18.0 },
    'Borated Poly (5%)': { thermal: 0.8, fission: 5.1, fusion14: 10.2 }, // High thermal capture
    'Steel': { thermal: 99, fission: 7.9, fusion14: 13.0 }, // Thermal Hvl is large (poor absorber)
    'Lead': { thermal: 99, fission: 15.0, fusion14: 14.0 }, // Poor neutron shield
    'Cadmium': { thermal: 0.02, fission: 99, fusion14: 99 } // Excellent thermal, useless fast
};


const FluenceDoseConverter = ({ calcMode, setCalcMode, energy, setEnergy, inputValue, setInputValue, inputUnit, setInputUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const { settings } = React.useContext(SettingsContext);

    // Dynamic Units
    const doseUnits = React.useMemo(() => settings.unitSystem === 'si' ? ['µSv', 'mSv', 'Sv'] : ['µrem', 'mrem', 'rem'], [settings.unitSystem]);

    // Auto-switch default input unit
    React.useEffect(() => {
        if (calcMode === 'doseToFluence') {
            if (!doseUnits.includes(inputUnit)) setInputUnit(doseUnits[1]);
        } else {
            setInputUnit('n/cm²');
        }
    }, [calcMode, settings.unitSystem]);

    const logLogInterpolate = (targetX, x1, y1, x2, y2) => y1 * Math.pow(targetX / x1, Math.log(y2 / y1) / Math.log(x2 / x1));
    const doseFactorsRem = { 'µrem': 1e-6, 'mrem': 1e-3, 'rem': 1, 'µSv': 1e-4, 'mSv': 0.1, 'Sv': 100 };

    React.useEffect(() => {
        try {
            setError('');
            const val = parseFloat(inputValue);
            const energyVal = parseFloat(energy);
            
            if (isNaN(val) || isNaN(energyVal) || val < 0 || energyVal <= 0) { 
                if(inputValue) setError('Inputs must be positive numbers.'); 
                setResult(null); return; 
            }

            // Interpolate Fluence-to-Rem factor
            let p1 = NEUTRON_CONVERSION_FACTORS[0], p2 = NEUTRON_CONVERSION_FACTORS[NEUTRON_CONVERSION_FACTORS.length - 1];
            if (energyVal < p1.energyMeV) { p2 = p1; } 
            else if (energyVal > p2.energyMeV) { p1 = p2; } 
            else {
                for (let i = 0; i < NEUTRON_CONVERSION_FACTORS.length - 1; i++) {
                    if (energyVal >= NEUTRON_CONVERSION_FACTORS[i].energyMeV && energyVal <= NEUTRON_CONVERSION_FACTORS[i + 1].energyMeV) { 
                        p1 = NEUTRON_CONVERSION_FACTORS[i]; 
                        p2 = NEUTRON_CONVERSION_FACTORS[i + 1]; 
                        break; 
                    }
                }
            }
            
            const fluencePerRem = (p1.energyMeV === p2.energyMeV) ? p1.fluencePerRem : logLogInterpolate(energyVal, p1.energyMeV, p1.fluencePerRem, p2.energyMeV, p2.fluencePerRem);
            
            if (calcMode === 'fluenceToDose') {
                const dose_rem = val / fluencePerRem;
                const formatted = formatDoseValue(dose_rem * 1000, 'dose', settings);
                setResult({ 
                    val: formatted.value, 
                    unit: formatted.unit, 
                    label: 'Equivalent Dose', 
                    factor: fluencePerRem.toExponential(2) 
                });
            } else {
                const dose_rem = val * doseFactorsRem[inputUnit];
                const fluence = dose_rem * fluencePerRem;
                setResult({ 
                    val: fluence.toExponential(3), 
                    unit: 'n/cm²', 
                    label: 'Required Fluence', 
                    factor: fluencePerRem.toExponential(2) 
                });
            }
        } catch (e) { setError('Calculation error.'); setResult(null); }
    }, [calcMode, energy, inputValue, inputUnit, settings.unitSystem]);

    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Neutron Conversion', icon: ICONS.neutron, inputs: `${inputValue} ${inputUnit} (${energy} MeV)`, result: `${result.val} ${result.unit}`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };

    return (
        <div className="space-y-4">
           <div className="grid grid-cols-2 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg">
               <button onClick={() => setCalcMode('fluenceToDose')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'fluenceToDose' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Fluence → Dose</button>
               <button onClick={() => setCalcMode('doseToFluence')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${calcMode === 'doseToFluence' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Dose → Fluence</button>
           </div>
           <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
               <div><label className="block text-sm font-medium">Neutron Energy</label><select value={energy} onChange={e => setEnergy(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{NEUTRON_CONVERSION_FACTORS.map(f => <option key={f.energyMeV} value={f.energyMeV}>{f.label}</option>)}</select></div>
               <div>
                   <label className="block text-sm font-medium">{calcMode === 'fluenceToDose' ? 'Neutron Fluence' : 'Dose'}</label>
                   <div className="flex">
                       <input type="number" value={inputValue} onChange={e => setInputValue(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700" />
                       {calcMode === 'doseToFluence' ? (
                           <select value={inputUnit} onChange={e => setInputUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{doseUnits.map(u => <option key={u} value={u}>{u}</option>)}</select>
                       ) : (
                           <div className="mt-1 px-3 flex items-center bg-slate-200 dark:bg-slate-600 rounded-r-md text-sm text-slate-500 dark:text-slate-300">n/cm²</div>
                       )}
                   </div>
               </div>
           </div>
           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           {result && (
               <div className="mt-6 p-6 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm relative overflow-hidden">
                   <div className="flex justify-end -mt-3 -mr-3 mb-2"><Tooltip text="Save to history"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-600 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip></div>
                   
                   <p className="text-xs uppercase font-bold text-slate-500 dark:text-slate-400 mb-2">{result.label}</p>
                   <div className="flex items-center justify-center gap-2 mb-2">
                       <span className="text-3xl font-extrabold text-sky-600 dark:text-sky-400">{result.val}</span>
                       <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">{result.unit}</span>
                       <CopyButton textToCopy={result.val} />
                   </div>
                   <p className="text-xs text-slate-500 dark:text-slate-400">Factor: {result.factor} n/cm² per rem</p>
               </div>
           )}
        </div>
    );
};

const ActivationCalculator = ({ radionuclides, inputMode, setInputMode, targetMass, setTargetMass, massUnit, setMassUnit, abundance, setAbundance, neutronFlux, setNeutronFlux, irradiationTime, setIrradiationTime, timeUnit, setTimeUnit, result, setResult, error, setError, targetSymbol, setTargetSymbol, manualAW, setManualAW, manualCS, setManualCS, manualHL, setManualHL, manualHLUnit, setManualHLUnit, manualProductName, setManualProductName }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const { settings } = React.useContext(SettingsContext);
    
    const massUnits = { 'µg': 1e-6, 'mg': 1e-3, 'g': 1, 'kg': 1000 };
    const timeUnits = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400 };

    // Auto-set abundance
    React.useEffect(() => {
        if (inputMode === 'fromDB') {
            const data = NEUTRON_ACTIVATION_DATA.find(t => t.targetSymbol === targetSymbol);
            if (data) setAbundance(data.abundance.toString());
        }
    }, [targetSymbol, inputMode]);

    React.useEffect(() => {
        try {
           setError('');
           let atomicWeight, crossSection, halfLife_s, productName;
           
           if (inputMode === 'fromDB') {
               const targetData = NEUTRON_ACTIVATION_DATA.find(t => t.targetSymbol === targetSymbol);
               if (!targetData) throw new Error('Target material data not found.');
               const productData = radionuclides.find(r => r.symbol === targetData.productSymbol);
               if (!productData) throw new Error(`Product ${targetData.productSymbol} data missing.`);
               
               atomicWeight = targetData.atomicWeight;
               crossSection = targetData.thermalCrossSection_barns;
               halfLife_s = parseHalfLifeToSeconds(productData.halfLife);
               productName = `${productData.name} (${productData.symbol})`;
           } else {
               atomicWeight = parseFloat(manualAW);
               crossSection = parseFloat(manualCS);
               const hl_val = parseFloat(manualHL);
               halfLife_s = hl_val * (parseHalfLifeToSeconds(`1 ${manualHLUnit}`));
               productName = manualProductName || 'Product';
               if ([atomicWeight, crossSection, hl_val].some(isNaN)) { if(manualAW) setError('Invalid manual inputs.'); setResult(null); return; }
           }

           const mass_g = parseFloat(targetMass) * massUnits[massUnit];
           const flux = parseFloat(neutronFlux);
           const t_s = parseFloat(irradiationTime) * timeUnits[timeUnit];
           const abund = parseFloat(abundance) / 100.0;

           if ([mass_g, flux, t_s, abund].some(isNaN) || mass_g <= 0 || flux < 0 || t_s < 0 || abund <= 0) {
               if (targetMass && neutronFlux) setError('Inputs must be valid positive numbers.');
               setResult(null); return;
           }

           const AVOGADRO = 6.02214076e23;
           const num_target_atoms = (mass_g * abund * AVOGADRO) / atomicWeight;
           const lambda = Math.log(2) / halfLife_s;
           const sigma_cm2 = crossSection * 1e-24;
           
           // A = N * sigma * phi * (1 - e^-lambda*t)
           const sat_activity = num_target_atoms * sigma_cm2 * flux;
           const saturation_fraction = 1 - Math.exp(-lambda * t_s);
           const activity_Bq = sat_activity * saturation_fraction;
           
           const configKey = settings.unitSystem === 'si' ? 'activity_si' : 'activity_conventional';
           const baseAct = settings.unitSystem === 'si' ? activity_Bq : activity_Bq / 3.7e10;
           const formatted = formatSensibleUnit(baseAct, configKey);

           setResult({ 
               productName, 
               displayVal: formatted.value, 
               unit: formatted.unit, 
               saturationPct: (saturation_fraction * 100)
           });

        } catch (e) { setError(e.message); setResult(null); }
    }, [inputMode, targetSymbol, targetMass, massUnit, abundance, neutronFlux, irradiationTime, timeUnit, manualAW, manualCS, manualHL, manualHLUnit, manualProductName, settings.unitSystem]);

    const handleSaveToHistory = () => {
        if (result) {
            const inputs = inputMode === 'fromDB' ? `${targetMass} ${massUnit} ${targetSymbol}` : 'Manual Target';
            addHistory({ id: Date.now(), type: 'Activation', icon: ICONS.neutron, inputs, result: `${result.displayVal} ${result.unit} ${result.productName}`, view: VIEWS.NEUTRON });
            addToast("Calculation saved!");
        }
    };

    return (
        <div className="space-y-4">
           <div className="flex justify-center mb-2">
               <div className="flex bg-slate-100 dark:bg-slate-900 rounded-lg p-1">
                   <button onClick={() => setInputMode('fromDB')} className={`px-4 py-1 text-xs font-bold rounded transition-colors ${inputMode === 'fromDB' ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Database</button>
                   <button onClick={() => setInputMode('manual')} className={`px-4 py-1 text-xs font-bold rounded transition-colors ${inputMode === 'manual' ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Manual</button>
               </div>
           </div>
           
           {inputMode === 'fromDB' ? (
               <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg animate-fade-in">
                   <label className="block text-sm font-medium">Target Isotope</label>
                   <select value={targetSymbol} onChange={e => setTargetSymbol(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{NEUTRON_ACTIVATION_DATA.map(t => <option key={t.targetSymbol} value={t.targetSymbol}>{t.name} ({t.abundance}% nat.)</option>)}</select>
               </div>
           ) : (
               <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 animate-fade-in">
                   <div className="grid grid-cols-2 gap-4">
                       <div><label className="block text-sm font-medium">Atomic Weight</label><input type="number" value={manualAW} onChange={e => setManualAW(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                       <div><label className="block text-sm font-medium">Cross-Section (b)</label><input type="number" value={manualCS} onChange={e => setManualCS(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                   </div>
                   <div><label className="block text-sm font-medium">Product Half-Life</label><div className="flex"><input type="number" value={manualHL} onChange={e => setManualHL(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/><select value={manualHLUnit} onChange={e => setManualHLUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{longTimeUnits_ordered.map(u => <option key={u} value={u}>{u}</option>)}</select></div></div>
               </div>
           )}

           <div className="space-y-4">
               <div className="grid grid-cols-2 gap-4">
                   <div>
                       <label className="block text-sm font-medium">Total Mass</label>
                       <div className="flex">
                           <input type="number" value={targetMass} onChange={e => setTargetMass(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                           <select value={massUnit} onChange={e => setMassUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
                       </div>
                   </div>
                   <div>
                       <Tooltip text="Percentage of the total mass that is the target isotope. Defaults to natural abundance.">
                           <label className="block text-sm font-medium cursor-help underline decoration-dotted">Abundance (%)</label>
                       </Tooltip>
                       <input type="number" value={abundance} onChange={e => setAbundance(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                   </div>
               </div>
               <div><label className="block text-sm font-medium">Thermal Flux (n/cm²·s)</label><input type="text" value={neutronFlux} onChange={e => setNeutronFlux(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
               <div>
                   <label className="block text-sm font-medium">Irradiation Time</label>
                   <div className="flex">
                       <input type="number" value={irradiationTime} onChange={e => setIrradiationTime(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                       <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(timeUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
                   </div>
               </div>
           </div>

           {error && <p className="text-red-500 text-sm text-center">{error}</p>}
           
           {result && (
               <div className="mt-6 p-6 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm relative overflow-hidden">
                   <div className="flex justify-end -mt-3 -mr-3 mb-2"><Tooltip text="Save to Recent Calculations" widthClass="w-auto"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip></div>
                   
                   <p className="text-xs uppercase font-bold text-slate-500 mb-2">Produced Activity</p>
                   <div className="flex items-center justify-center gap-2 mb-2">
                       <span className="text-3xl font-extrabold text-sky-600 dark:text-sky-400">{result.displayVal}</span>
                       <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">{result.unit}</span>
                       <CopyButton textToCopy={result.displayVal} />
                   </div>
                   <p className="text-sm font-medium text-slate-600 dark:text-slate-300 mb-4">of {result.productName}</p>

                   {/* Saturation Bar */}
                   <div className="relative pt-1">
                      <div className="flex mb-1 items-center justify-between">
                        <span className="text-xs font-semibold inline-block text-sky-600 dark:text-sky-400">Saturation</span>
                        <span className="text-xs font-semibold inline-block text-sky-600 dark:text-sky-400">{result.saturationPct.toFixed(1)}%</span>
                      </div>
                      <div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-sky-200 dark:bg-slate-600">
                        <div style={{ width: `${result.saturationPct}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-sky-500"></div>
                      </div>
                   </div>
               </div>
           )}
        </div>
    );
};

const CompositeActivationCalculator = ({ radionuclides, material, setMaterial, totalMass, setTotalMass, massUnit, setMassUnit, neutronFlux, setNeutronFlux, irradiationTime, setIrradiationTime, timeUnit, setTimeUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const massUnits = { 'µg': 1e-6, 'mg': 1e-3, 'g': 1, 'kg': 1000 };
    const timeUnits = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400 };
    
    React.useEffect(() => {
    try {
       setError('');
       const materialData = COMPOSITE_MATERIALS_DATA[material];
       if (!materialData) throw new Error("Selected material data not found.");
       const total_mass_g = parseFloat(totalMass) * massUnits[massUnit];
       const flux_n_cm2_s = parseFloat(neutronFlux);
       const time_s = parseFloat(irradiationTime) * timeUnits[timeUnit];
       if (isNaN(total_mass_g) || isNaN(flux_n_cm2_s) || isNaN(time_s)) { if(totalMass && neutronFlux && irradiationTime) setError("Inputs must be valid numbers."); setResult(null); return; }
       
       const activationProducts = [];
       for (const component of materialData.composition) {
           const targetData = NEUTRON_ACTIVATION_DATA.find(t => t.targetSymbol === component.targetSymbol);
           if (!targetData) continue;
           const productData = radionuclides.find(r => r.symbol === targetData.productSymbol);
           if (!productData || productData.halfLife === 'Stable') continue;
           
           const component_mass_g = total_mass_g * component.massFraction;
           const AVOGADRO = 6.02214076e23; const BARN_TO_CM2 = 1e-24;
           const num_target_atoms = (component_mass_g / targetData.atomicWeight) * AVOGADRO;
           const product_half_life_s = parseHalfLifeToSeconds(productData.halfLife);
           const product_lambda = Math.log(2) / product_half_life_s;
           const cross_section_cm2 = targetData.thermalCrossSection_barns * BARN_TO_CM2;
           const saturation_factor = 1 - Math.exp(-product_lambda * time_s);
           const activity_Bq = num_target_atoms * cross_section_cm2 * flux_n_cm2_s * saturation_factor;
           
           if (activity_Bq > 1e-3) { activationProducts.push({ product: productData, targetElement: component.element, activity_Bq: activity_Bq, activity_Ci: activity_Bq / 3.7e10 }); }
       }
       activationProducts.sort((a, b) => b.activity_Bq - a.activity_Bq);
       setResult(activationProducts);
    } catch (e) { setError(e.message); setResult(null); }
    }, [material, totalMass, massUnit, neutronFlux, irradiationTime, timeUnit, radionuclides, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Composite Activation', icon: ICONS.neutron, inputs: `${totalMass} ${massUnit} of ${material}`, result: `${result.length} products found`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div><label className="block text-sm font-medium">Composite Material</label><select value={material} onChange={e => setMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(COMPOSITE_MATERIALS_DATA).map(m => <option key={m} value={m}>{m}</option>)}</select></div>
           <div>
               <label className="block text-sm font-medium">Total Mass</label>
               <div className="flex">
                   <input type="number" value={totalMass} onChange={e => setTotalMass(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                   <select value={massUnit} onChange={e => setMassUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(massUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
               </div>
           </div>
           <div><label className="block text-sm font-medium">Thermal Neutron Flux (n/cm²·s)</label><input type="text" value={neutronFlux} onChange={e => setNeutronFlux(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div>
               <label className="block text-sm font-medium">Irradiation Time</label>
               <div className="flex">
                   <input type="number" value={irradiationTime} onChange={e => setIrradiationTime(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                   <select value={timeUnit} onChange={e => setTimeUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(timeUnits).map(u => <option key={u} value={u}>{u}</option>)}</select>
               </div>
           </div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (<div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in">
            <div className="flex justify-between items-center -mt-2">
                <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 mb-2">Principal Activation Products</h3>
                <Tooltip text="Save to Recent Calculations" widthClass="w-auto">
                   <button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                       <Icon path={ICONS.notepad} className="w-5 h-5" />
                   </button>
                </Tooltip>
            </div>
            <div className="space-y-2">{result.length > 0 ? result.map(p => (<div key={p.product.symbol} className="grid grid-cols-3 items-center text-sm border-b border-slate-200 dark:border-slate-600 pb-1 last:border-0"><span className="font-semibold text-sky-600 dark:text-sky-400">{p.product.name}</span><span className="text-xs text-center text-slate-500 dark:text-slate-400">(from {p.targetElement})</span><span className="font-mono text-right">{p.activity_Ci.toExponential(2)} Ci</span></div>)) : <p className="text-center text-sm text-slate-500 dark:text-slate-400">No significant activation products found.</p>}</div>
       </div>)}
    </div>
    );
};

const NeutronShieldingCalculator = ({ selectedEnergy, setSelectedEnergy, initialFlux, setInitialFlux, shieldMaterial, setShieldMaterial, shieldThickness, setShieldThickness, thicknessUnit, setThicknessUnit, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const thicknessFactors_cm = { 'mm': 0.1, 'cm': 1, 'in': 2.54, 'ft': 30.48 };
    
    // 1. Source Spectrum Toggle
    const [spectrum, setSpectrum] = React.useState('fission'); // 'fission' or 'fusion14'

    // 2. Updated Data Getter
    const getHvl = (mat) => {
        const data = NEUTRON_SHIELDING_DATA[mat];
        if (!data) return null;
        
        // If energy is explicitly "Thermal" (< 1e-4 MeV), force thermal HVL
        const energyMeV = parseFloat(selectedEnergy);
        if (energyMeV < 1e-4) return data.thermal;
        
        // Otherwise use spectrum toggle
        return spectrum === 'fission' ? data.fission : data.fusion14;
    };
    
    const logLogInterpolate = (targetX, x1, y1, x2, y2) => y1 * Math.pow(targetX / x1, Math.log(y2 / y1) / Math.log(x2 / x1));
    
    React.useEffect(() => {
    try {
       setError('');
       const flux_val = parseFloat(initialFlux); const thickness_val = parseFloat(shieldThickness); const energyVal = parseFloat(selectedEnergy);
       if (isNaN(flux_val) || isNaN(thickness_val) || isNaN(energyVal) || flux_val < 0 || thickness_val < 0 || energyVal <= 0) { 
           if(initialFlux && shieldThickness && selectedEnergy) setError("Please enter valid positive numbers."); 
           setResult(null); return; 
       }
       
       const hvl_cm = getHvl(shieldMaterial);
       if (!hvl_cm || hvl_cm >= 99) { throw new Error("Material is ineffective for this neutron energy."); }
       
       let p1 = NEUTRON_CONVERSION_FACTORS[0], p2 = NEUTRON_CONVERSION_FACTORS[NEUTRON_CONVERSION_FACTORS.length - 1];
       if (energyVal < p1.energyMeV) { p2 = p1; } 
       else if (energyVal > p2.energyMeV) { p1 = p2; } 
       else {
           for (let i = 0; i < NEUTRON_CONVERSION_FACTORS.length - 1; i++) {
               if (energyVal >= NEUTRON_CONVERSION_FACTORS[i].energyMeV && energyVal <= NEUTRON_CONVERSION_FACTORS[i + 1].energyMeV) { 
                   p1 = NEUTRON_CONVERSION_FACTORS[i]; p2 = NEUTRON_CONVERSION_FACTORS[i + 1]; break; 
               }
           }
       }
       const fluencePerRem = (p1.energyMeV === p2.energyMeV) ? p1.fluencePerRem : logLogInterpolate(energyVal, p1.energyMeV, p1.fluencePerRem, p2.energyMeV, p2.fluencePerRem);
       const FLUX_TO_DOSE_RATE_FACTOR = (1 / fluencePerRem) * 1000 * 3600;
       
       const thickness_cm = thickness_val * thicknessFactors_cm[thicknessUnit];
       const final_flux = flux_val * Math.pow(0.5, thickness_cm / hvl_cm);
       const initial_dose_rate_mrem_hr = flux_val * FLUX_TO_DOSE_RATE_FACTOR;
       const final_dose_rate_mrem_hr = final_flux * FLUX_TO_DOSE_RATE_FACTOR;
       
       setResult({ 
           initialFlux: flux_val.toExponential(3), 
           finalFlux: final_flux.toExponential(3), 
           initialDose: formatSensibleUnit(initial_dose_rate_mrem_hr, 'doseRate'), 
           finalDose: formatSensibleUnit(final_dose_rate_mrem_hr, 'doseRate'),
           hvlUsed: hvl_cm
       });
    } catch(e) { setError(e.message); setResult(null); }
    }, [initialFlux, shieldMaterial, shieldThickness, thicknessUnit, selectedEnergy, spectrum, setResult, setError]);
    
    const handleSaveToHistory = () => {
        if (result) {
           addHistory({ id: Date.now(), type: 'Neutron Shielding', icon: ICONS.shield, inputs: `${shieldThickness} ${thicknessUnit} of ${shieldMaterial}`, result: `Final: ${result.finalDose.value} ${result.finalDose.unit}`, view: VIEWS.NEUTRON });
           addToast("Calculation saved to history!");
        }
    };
    
    return (
    <div className="space-y-4">
       <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
           <div><label className="block text-sm font-medium">Neutron Energy</label><select value={selectedEnergy} onChange={e => setSelectedEnergy(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{NEUTRON_CONVERSION_FACTORS.map(f => <option key={f.energyMeV} value={f.energyMeV}>{f.label}</option>)}</select></div>
           
           {/* Source Spectrum Toggle (Visible if not Thermal) */}
           {parseFloat(selectedEnergy) >= 1e-4 && (
               <div>
                   <label className="block text-sm font-medium mb-1">Source Spectrum</label>
                   <div className="flex bg-slate-100 dark:bg-slate-900 rounded-lg p-1">
                       <button onClick={() => setSpectrum('fission')} className={`flex-1 py-1 text-xs font-bold rounded transition-colors ${spectrum === 'fission' ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Fission / AmBe (~2-5 MeV)</button>
                       <button onClick={() => setSpectrum('fusion14')} className={`flex-1 py-1 text-xs font-bold rounded transition-colors ${spectrum === 'fusion14' ? 'bg-white dark:bg-slate-700 text-sky-600 shadow-sm' : 'text-slate-500'}`}>Fusion (14 MeV)</button>
                   </div>
               </div>
           )}

           <div><label className="block text-sm font-medium">Initial Neutron Flux (n/cm²·s)</label><input type="text" value={initialFlux} onChange={e => setInitialFlux(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
           <div><label className="block text-sm font-medium">Shield Material</label><select value={shieldMaterial} onChange={e => setShieldMaterial(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{Object.keys(NEUTRON_SHIELDING_DATA).map(m => <option key={m} value={m}>{m}</option>)}</select></div>
           <div>
               <label className="block text-sm font-medium">Shield Thickness</label>
               <div className="flex">
                   <input type="number" value={shieldThickness} onChange={e => setShieldThickness(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                   <select value={thicknessUnit} onChange={e => setThicknessUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600">{Object.keys(thicknessFactors_cm).map(u => <option key={u} value={u}>{u}</option>)}</select>
               </div>
           </div>
       </div>
       {error && <p className="text-red-500 text-sm text-center">{error}</p>}
       {result && (
           <div className="mt-6 p-6 bg-slate-100 dark:bg-slate-700 rounded-lg text-center animate-fade-in shadow-sm relative overflow-hidden">
               <div className="flex justify-end -mt-3 -mr-3 mb-2"><Tooltip text="Save to Recent Calculations" widthClass="w-auto"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></Tooltip></div>
               
               <p className="text-xs uppercase font-bold text-slate-500 mb-2">Shielded Dose Rate</p>
               <div className="flex items-center justify-center gap-2 mb-2">
                   <span className="text-3xl font-extrabold text-sky-600 dark:text-sky-400">{result.finalDose.value}</span>
                   <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">{result.finalDose.unit}</span>
                   <CopyButton textToCopy={result.finalDose.value} />
               </div>
               
               <div className="grid grid-cols-2 gap-2 text-xs text-slate-600 dark:text-slate-300 border-t border-slate-200 dark:border-slate-600 pt-3">
                   <p>Unshielded: <strong>{result.initialDose.value} {result.initialDose.unit}</strong></p>
                   <p>HVL Used: <strong>{result.hvlUsed} cm</strong></p>
               </div>
           </div>
       )}
    </div>
    );
};

const NeutronCalculator = ({radionuclides}) => {
    const [activeTab, setActiveTab] = React.useState('fluenceDose');
    const { settings } = React.useContext(SettingsContext);
    
    // State for FluenceDoseConverter
    const [fluence_calcMode, setFluence_calcMode] = React.useState('fluenceToDose');
    const [fluence_energy, setFluence_energy] = React.useState('1');
    const [fluence_inputValue, setFluence_inputValue] = React.useState('1e6');
    const [fluence_inputUnit, setFluence_inputUnit] = React.useState('n/cm²');
    const [fluence_result, setFluence_result] = React.useState(null);
    const [fluence_error, setFluence_error] = React.useState('');
    
    // State for ActivationCalculator
    const [act_inputMode, setAct_inputMode] = React.useState('fromDB');
    const [act_targetMass, setAct_targetMass] = React.useState('1');
    const [act_massUnit, setAct_massUnit] = React.useState('g');
    const [act_abundance, setAct_abundance] = React.useState('100');
    const [act_neutronFlux, setAct_neutronFlux] = React.useState('1e12');
    const [act_irradiationTime, setAct_irradiationTime] = React.useState('1');
    const [act_timeUnit, setAct_timeUnit] = React.useState('hours');
    const [act_result, setAct_result] = React.useState(null);
    const [act_error, setAct_error] = React.useState('');
    const [act_targetSymbol, setAct_targetSymbol] = React.useState('Co-59');
    const [act_manualAW, setAct_manualAW] = React.useState('58.933');
    const [act_manualCS, setAct_manualCS] = React.useState('37.2');
    const [act_manualHL, setAct_manualHL] = React.useState('5.27');
    const [act_manualHLUnit, setAct_manualHLUnit] = React.useState('years');
    const [act_manualProductName, setAct_manualProductName] = React.useState('Co-60');
    
    // State for CompositeActivationCalculator
    const [comp_material, setComp_material] = React.useState('Ordinary Concrete');
    const [comp_totalMass, setComp_totalMass] = React.useState('100');
    const [comp_massUnit, setComp_massUnit] = React.useState('kg');
    const [comp_neutronFlux, setComp_neutronFlux] = React.useState('1e12');
    const [comp_irradiationTime, setComp_irradiationTime] = React.useState('8');
    const [comp_timeUnit, setComp_timeUnit] = React.useState('hours');
    const [comp_result, setComp_result] = React.useState(null);
    const [comp_error, setComp_error] = React.useState('');
    
    // State for NeutronShieldingCalculator
    const [shield_selectedEnergy, setShield_selectedEnergy] = React.useState('2.5');
    const [shield_initialFlux, setShield_initialFlux] = React.useState('1e6');
    const [shield_shieldMaterial, setShield_shieldMaterial] = React.useState('Polyethylene');
    const [shield_shieldThickness, setShield_shieldThickness] = React.useState('10');
    const [shield_thicknessUnit, setShield_thicknessUnit] = React.useState('cm');
    const [shield_result, setShield_result] = React.useState(null);
    const [shield_error, setShield_error] = React.useState('');
    
    const handleFluenceClear = () => {
        setFluence_calcMode('fluenceToDose'); setFluence_energy('1'); setFluence_inputValue('1e6');
        setFluence_result(null); setFluence_error('');
    };
    const handleActivationClear = () => {
        setAct_inputMode('fromDB'); setAct_targetMass('1'); setAct_massUnit('g'); setAct_neutronFlux('1e12');
        setAct_irradiationTime('1'); setAct_timeUnit('hours'); setAct_targetSymbol('Co-59');
        setAct_abundance('100');
        setAct_manualAW('58.933'); setAct_manualCS('37.2'); setAct_manualHL('5.27'); setAct_manualHLUnit('years');
        setAct_manualProductName('Co-60'); setAct_result(null); setAct_error('');
    };
    const handleCompositeClear = () => {
        setComp_material('Ordinary Concrete'); setComp_totalMass('100'); setComp_massUnit('kg');
        setComp_neutronFlux('1e12'); setComp_irradiationTime('8'); setComp_timeUnit('hours');
        setComp_result(null); setComp_error('');
    };
    const handleShieldingClear = () => {
        setShield_selectedEnergy('2.5'); setShield_initialFlux('1e6'); setShield_shieldMaterial('Polyethylene');
        setShield_shieldThickness('10'); setShield_thicknessUnit('cm'); setShield_result(null); setShield_error('');
    };
    
    const handleClearActiveCalculator = () => {
        switch (activeTab) {
            case 'fluenceDose': handleFluenceClear(); break;
            case 'activation': handleActivationClear(); break;
            case 'composite': handleCompositeClear(); break;
            case 'shielding': handleShieldingClear(); break;
            default: break;
        }
    };
    
    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Neutron Tools</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-1 p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setActiveTab('fluenceDose')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'fluenceDose' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Fluence</button>
                    <button onClick={() => setActiveTab('activation')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'activation' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Activation</button>
                    <button onClick={() => setActiveTab('composite')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'composite' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Composite</button>
                    <button onClick={() => setActiveTab('shielding')} className={`p-2 rounded-md text-sm font-semibold transition-colors ${activeTab === 'shielding' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Shielding</button>
                </div>
                {activeTab === 'fluenceDose' && <FluenceDoseConverter 
                    calcMode={fluence_calcMode} setCalcMode={setFluence_calcMode}
                    energy={fluence_energy} setEnergy={setFluence_energy}
                    inputValue={fluence_inputValue} setInputValue={setFluence_inputValue}
                    inputUnit={fluence_inputUnit} setInputUnit={setFluence_inputUnit}
                    result={fluence_result} setResult={setFluence_result}
                    error={fluence_error} setError={setFluence_error}
                />}
                {activeTab === 'activation' && <ActivationCalculator 
                    radionuclides={radionuclides}
                    inputMode={act_inputMode} setInputMode={setAct_inputMode}
                    targetMass={act_targetMass} setTargetMass={setAct_targetMass}
                    massUnit={act_massUnit} setMassUnit={setAct_massUnit}
                    abundance={act_abundance} setAbundance={setAct_abundance} // <--- FIXED: Was setAbundance={setAbundance}
                    neutronFlux={act_neutronFlux} setNeutronFlux={setAct_neutronFlux}
                    irradiationTime={act_irradiationTime} setIrradiationTime={setAct_irradiationTime}
                    timeUnit={act_timeUnit} setTimeUnit={setAct_timeUnit}
                    result={act_result} setResult={setAct_result}
                    error={act_error} setError={setAct_error}
                    targetSymbol={act_targetSymbol} setTargetSymbol={setAct_targetSymbol}
                    manualAW={act_manualAW} setManualAW={setAct_manualAW}
                    manualCS={act_manualCS} setManualCS={setAct_manualCS}
                    manualHL={act_manualHL} setManualHL={setAct_manualHL}
                    manualHLUnit={act_manualHLUnit} setManualHLUnit={setAct_manualHLUnit}
                    manualProductName={act_manualProductName} setManualProductName={setAct_manualProductName}
                />}
                {activeTab === 'composite' && <CompositeActivationCalculator 
                    radionuclides={radionuclides}
                    material={comp_material} setMaterial={setComp_material}
                    totalMass={comp_totalMass} setTotalMass={setComp_totalMass}
                    massUnit={comp_massUnit} setMassUnit={setComp_massUnit}
                    neutronFlux={comp_neutronFlux} setNeutronFlux={setComp_neutronFlux}
                    irradiationTime={comp_irradiationTime} setIrradiationTime={setComp_irradiationTime}
                    timeUnit={comp_timeUnit} setTimeUnit={setComp_timeUnit}
                    result={comp_result} setResult={setComp_result}
                    error={comp_error} setError={setComp_error}
                />}
                {activeTab === 'shielding' && <NeutronShieldingCalculator 
                    selectedEnergy={shield_selectedEnergy} setSelectedEnergy={setShield_selectedEnergy}
                    initialFlux={shield_initialFlux} setInitialFlux={setShield_initialFlux}
                    shieldMaterial={shield_shieldMaterial} setShieldMaterial={setShield_shieldMaterial}
                    shieldThickness={shield_shieldThickness} setShieldThickness={setShield_shieldThickness}
                    thicknessUnit={shield_thicknessUnit} setThicknessUnit={setShield_thicknessUnit}
                    result={shield_result} setResult={setShield_result}
                    error={shield_error} setError={setShield_error}
                />}
            </div>
        </div>
    );
};      
              /**
              * @description A unified calculator for determining detection limits for both
              * MARSSIM-compliant static counts and scanning surveys.
              */
              
const MDACalculator = ({ onNavClick, onDeepLink }) => {
    const MDA_MODE_STATIC = 'static';
    const MDA_MODE_SCAN = 'scan';
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    // --- State Management ---
    const [mdaMode, setMdaMode] = React.useState(() => localStorage.getItem('mda_mdaMode') || MDA_MODE_STATIC);

    // Shared State
    const [backgroundCpm, setBackgroundCpm] = React.useState(() => localStorage.getItem('mda_backgroundCpm') || '50');
    const [instrumentEff, setInstrumentEff] = React.useState(() => localStorage.getItem('mda_instrumentEff') || '20'); 
    const [surfaceEff, setSurfaceEff] = React.useState(() => localStorage.getItem('mda_surfaceEff') || '50'); 
    const [probeArea, setProbeArea] = React.useState(() => localStorage.getItem('mda_probeArea') || '15'); 

    // Static State
    const [grossTime, setGrossTime] = React.useState(() => localStorage.getItem('mda_grossTime') || '1');
    const [outputUnit, setOutputUnit] = React.useState(() => localStorage.getItem('mda_outputUnit') || 'dpm/100cm²');
    const [sampleVolume, setSampleVolume] = React.useState(() => localStorage.getItem('mda_sampleVolume') || '1');
    const [sampleMass, setSampleMass] = React.useState(() => localStorage.getItem('mda_sampleMass') || '100');

    // Scan State
    const [scanSpeed, setScanSpeed] = React.useState(() => localStorage.getItem('mda_scanSpeed') || '5'); 
    const [probeDimension, setProbeDimension] = React.useState(() => localStorage.getItem('mda_probeDimension') || '4.4'); 
    const [dprime, setDprime] = React.useState(() => localStorage.getItem('mda_dprime') || '1.38');
    const [surveyorEff, setSurveyorEff] = React.useState(() => localStorage.getItem('mda_surveyorEff') || '0.5');

    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    // --- Data and Constants ---
    const MDA_UNIT_CONFIG = { 'counts': { label: 'LLD (counts)', category: 'Counts', requires: [] }, 'cpm': { label: 'LLD Rate (cpm)', category: 'Rate', requires: [] }, 'dpm': { label: 'Activity (dpm)', category: 'Activity', requires: ['efficiency'] }, 'Bq': { label: 'Activity (Bq)', category: 'Activity', requires: ['efficiency'] }, 'µCi': { label: 'Activity (µCi)', category: 'Activity', requires: ['efficiency'] }, 'dpm/100cm²': { label: 'Surface (dpm/100cm²)', category: 'Concentration', requires: ['efficiency', 'area'] }, 'Bq/L': { label: 'Liquid (Bq/L)', category: 'Concentration', requires: ['efficiency', 'volume'] }, 'pCi/g': { label: 'Solid (pCi/g)', category: 'Concentration', requires: ['efficiency', 'mass'] } };
    const dpmFactors = { 'dpm': 1, 'Bq': 1 / 60, 'µCi': 1 / 2.22e6 };
    const dprimeOptions = [ { value: '1.38', label: '1.38 (95% detection prob.)' }, { value: '1.28', label: '1.28 (90% detection prob.)' }, { value: '1.04', label: '1.04 (85% detection prob.)' }, { value: '3.0', label: '3.0 (High Confidence)' } ];
    const surveyorEffOptions = [ { value: '0.5', label: '0.5 (Standard/Audible)' }, { value: '0.75', label: '0.75 (Optimistic)' }, { value: '1.0', label: '1.0 (Data Logger/Scaler)' } ];

    const PROBE_PRESETS = {
        'custom': { label: 'Custom / Manual', area: '', dim: '' },
        '44-9': { label: 'Pancake GM (Ludlum 44-9)', area: '15', dim: '4.4' },
        '43-5': { label: 'Alpha Scint. (Ludlum 43-5)', area: '50', dim: '7.6' },
        '43-37': { label: 'Floor Monitor (Gas Prop)', area: '584', dim: '13' },
        '43-68': { label: 'Handheld Gas Prop', area: '100', dim: '10' }, 
        '43-89': { label: 'Alpha/Beta Scint (Square)', area: '100', dim: '10' }, 
        '43-93': { label: 'Alpha/Beta Scint (Round)', area: '100', dim: '11' }
    };

    React.useEffect(() => {
        localStorage.setItem('mda_mdaMode', mdaMode);
        localStorage.setItem('mda_backgroundCpm', backgroundCpm);
        localStorage.setItem('mda_instrumentEff', instrumentEff);
        localStorage.setItem('mda_surfaceEff', surfaceEff);
        localStorage.setItem('mda_probeArea', probeArea);
        localStorage.setItem('mda_grossTime', grossTime);
        localStorage.setItem('mda_outputUnit', outputUnit);
        localStorage.setItem('mda_sampleVolume', sampleVolume);
        localStorage.setItem('mda_sampleMass', sampleMass);
        localStorage.setItem('mda_scanSpeed', scanSpeed);
        localStorage.setItem('mda_probeDimension', probeDimension);
        localStorage.setItem('mda_dprime', dprime);
        localStorage.setItem('mda_surveyorEff', surveyorEff);
    }, [mdaMode, backgroundCpm, instrumentEff, surfaceEff, probeArea, grossTime, outputUnit, sampleVolume, sampleMass, scanSpeed, probeDimension, dprime, surveyorEff]);

    React.useEffect(() => { setResult(null); setError(''); }, [mdaMode]);

    const handlePresetChange = (key) => {
        const p = PROBE_PRESETS[key];
        if (p && key !== 'custom') {
            setProbeArea(p.area);
            setProbeDimension(p.dim);
            addToast(`Loaded settings for ${p.label}`);
        }
    };

    // Helper to calculate total efficiency
    const getTotalEfficiency = (iEff, sEff) => (iEff / 100.0) * (sEff / 100.0);

    const handleStaticCalculate = React.useCallback(() => {
        const bkgRate = parseFloat(backgroundCpm); 
        const tg = parseFloat(grossTime);
        const ei = parseFloat(instrumentEff);
        const es = parseFloat(surfaceEff);
        const A = parseFloat(probeArea);
        const V = parseFloat(sampleVolume);
        const M = parseFloat(sampleMass);

        if (isNaN(bkgRate) || isNaN(tg) || tg <= 0) { 
            throw new Error('Please enter valid, positive numbers for background rate and sample time.'); 
        }
        
        // Currie Equation: LLD = 2.71 + 4.65 * sqrt(Rb * Tg)
        const LLD = 2.71 + 4.65 * Math.sqrt(bkgRate * tg);
        
        if (outputUnit === 'counts') { 
            setResult({ type: 'static', LLD: LLD.toPrecision(3), MDA: LLD.toPrecision(3), unit: 'counts', backgroundActivity: bkgRate.toPrecision(3) }); 
            return; 
        }

        if (isNaN(ei) || isNaN(es) || ei <= 0 || es <= 0) { throw new Error('Valid efficiencies are required for this unit.'); }
        
        const E_total = getTotalEfficiency(ei, es);
        const mda_dpm = (LLD / tg) / E_total;
        const background_dpm = bkgRate / E_total;
        
        let finalMDA, finalBackground;
        
        if (MDA_UNIT_CONFIG[outputUnit].category === 'Activity') { 
            finalMDA = mda_dpm * dpmFactors[outputUnit]; 
            finalBackground = background_dpm * dpmFactors[outputUnit]; 
        } else if (outputUnit === 'dpm/100cm²') { 
            if (isNaN(A) || A <= 0) throw new Error('Probe Area is required.'); 
            finalMDA = mda_dpm * (100 / A); 
            finalBackground = background_dpm * (100 / A); 
        } else if (outputUnit === 'Bq/L') { 
            if (isNaN(V) || V <= 0) throw new Error('Sample Volume is required.'); 
            finalMDA = (mda_dpm / 60) / V; 
            finalBackground = (background_dpm / 60) / V; 
        } else if (outputUnit === 'pCi/g') { 
            if (isNaN(M) || M <= 0) throw new Error('Sample Mass is required.'); 
            finalMDA = (mda_dpm / 2.22) / M; 
            finalBackground = (background_dpm / 2.22) / M; 
        } else if (outputUnit === 'cpm') { 
            finalMDA = LLD / tg; 
            finalBackground = bkgRate; 
        }
        
        setResult({ type: 'static', LLD: LLD.toPrecision(3), MDA: finalMDA.toPrecision(3), backgroundActivity: finalBackground.toPrecision(3), unit: outputUnit });
    }, [backgroundCpm, grossTime, instrumentEff, surfaceEff, outputUnit, probeArea, sampleVolume, sampleMass, MDA_UNIT_CONFIG, dpmFactors]);

    const handleScanCalculate = React.useCallback(() => {
        const bkgRate = parseFloat(backgroundCpm);
        const dimension_cm = parseFloat(probeDimension);
        const eff_i = parseFloat(instrumentEff);
        const eff_s = parseFloat(surfaceEff);
        const speed_cms = parseFloat(scanSpeed);
        const dp = parseFloat(dprime);
        const p = parseFloat(surveyorEff);
        const total_area_cm2 = parseFloat(probeArea);

        if (isNaN(bkgRate) || isNaN(eff_i) || isNaN(eff_s) || isNaN(speed_cms) || isNaN(dimension_cm) || bkgRate < 0 || eff_i <= 0 || eff_s <= 0 || speed_cms <= 0 || dimension_cm <= 0) { 
            throw new Error('Please enter valid, positive numbers for all required fields.'); 
        }
        if (isNaN(total_area_cm2) || total_area_cm2 <= 0) throw new Error("Probe Area must be a positive number.");

        const residence_time_s = dimension_cm / speed_cms;
        const b_cps = bkgRate / 60.0; 
        const E_total = getTotalEfficiency(eff_i, eff_s);
        const B_i = b_cps * residence_time_s; 
        const mdcr_instrument_cpm = dp * Math.sqrt(B_i) * (60 / residence_time_s);
        const mdcr_surveyor_cpm = mdcr_instrument_cpm / Math.sqrt(p);
        const scan_mda = mdcr_surveyor_cpm / (E_total * (total_area_cm2 / 100.0));
        const background_activity = bkgRate / (E_total * (total_area_cm2 / 100.0));
        
        setResult({ 
            type: 'scan', 
            obs_interval: residence_time_s.toPrecision(2), 
            bg_counts_in_interval: B_i.toPrecision(2), 
            mdcr_inst: mdcr_instrument_cpm.toPrecision(3),
            mdcr_surveyor: mdcr_surveyor_cpm.toPrecision(3), 
            scan_mda: scan_mda.toPrecision(3), 
            background_activity: background_activity.toPrecision(3) 
        });
    }, [backgroundCpm, probeDimension, instrumentEff, surfaceEff, scanSpeed, dprime, surveyorEff, probeArea]);

    const handleSaveToHistory = () => {
        if (!result) return;
        let inputs = mdaMode === MDA_MODE_STATIC ? `Bkg: ${backgroundCpm} cpm, Time: ${grossTime} min` : `Bkg: ${backgroundCpm} cpm, Speed: ${scanSpeed} cm/s`;
        let resString = mdaMode === MDA_MODE_STATIC ? `${result.MDA} ${result.unit}` : `${result.scan_mda} dpm/100cm²`;
        
        addHistory({
            id: Date.now(),
            type: mdaMode === MDA_MODE_STATIC ? 'Static MDA' : 'Scan MDC',
            icon: ICONS.search,
            inputs: inputs,
            result: resString,
            view: VIEWS.MDA
        });
        addToast("Calculation saved to history!");
    };

    React.useEffect(() => {
        try {
            setError(''); setResult(null);
            if(!backgroundCpm) return;
            if (mdaMode === MDA_MODE_STATIC) handleStaticCalculate(); 
            else handleScanCalculate();
        } catch (e) { setError(e.message); setResult(null); }
    }, [mdaMode, backgroundCpm, grossTime, outputUnit, sampleVolume, sampleMass, scanSpeed, dprime, surveyorEff, probeArea, instrumentEff, surfaceEff, probeDimension, handleStaticCalculate, handleScanCalculate]);

    const handleClearInputs = () => {
        setMdaMode(MDA_MODE_STATIC);
        setBackgroundCpm('50'); setInstrumentEff('20'); setSurfaceEff('50'); setProbeArea('15');
        setGrossTime('1'); setOutputUnit('dpm/100cm²'); setSampleVolume('1'); setSampleMass('100');
        setScanSpeed('5'); setProbeDimension('4.4');
        setDprime('1.38'); setSurveyorEff('0.5');
        setResult(null); setError('');
        Object.keys(localStorage).forEach(key => { if (key.startsWith('mda_')) localStorage.removeItem(key); });
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Detection Limit Calculator</h2>
                    <ClearButton onClick={handleClearInputs} />
                </div>
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setMdaMode(MDA_MODE_STATIC)} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${mdaMode === MDA_MODE_STATIC ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Static Count MDA</button>
                    <button onClick={() => setMdaMode(MDA_MODE_SCAN)} className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${mdaMode === MDA_MODE_SCAN ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Scan Survey MDC</button>
                </div>
                
                <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4 mb-4">
                    <div className="flex justify-between items-center -mb-2">
                        <h3 className="text-md font-semibold text-center">Shared Inputs</h3>
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-slate-500">Preset:</span>
                            <select onChange={(e) => handlePresetChange(e.target.value)} className="text-xs p-1 rounded border border-slate-300 dark:bg-slate-700 dark:border-slate-600">
                                {Object.entries(PROBE_PRESETS).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium">Background Rate (cpm)</label><input type="number" value={backgroundCpm} onChange={e => setBackgroundCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                        <div><label className="block text-sm font-medium">Probe Active Area (cm²)</label><input type="number" value={probeArea} onChange={e => setProbeArea(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                        <div><Tooltip text="Intrinsic efficiency (2π or 4π) from calibration certificate."><label className="block text-sm font-medium cursor-help underline decoration-dotted">Instrument Eff. (%)</label></Tooltip><input type="number" value={instrumentEff} onChange={e => setInstrumentEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                        <div><Tooltip text="Efficiency of the source material itself (ISO 7503). Standard defaults: 0.5 (Beta), 0.25 (Alpha)."><label className="block text-sm font-medium cursor-help underline decoration-dotted">Source Eff. (%)</label></Tooltip><input type="number" value={surfaceEff} onChange={e => setSurfaceEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    </div>
                </div>

                {mdaMode === MDA_MODE_STATIC ? (
                    <div className="space-y-4 animate-fade-in">
                        {/* FIXED: Removed {bkg} from JSX text */}
                        <ContextualNote type="info">
                            {"Assumes paired observations (Tbkg = Tsample)."} <br/>
                            {"Uses Currie Equation: L_D = 2.71 + 4.65 * sqrt(B)"}
                        </ContextualNote>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium">Sample Count Time (min)</label><input type="number" value={grossTime} onChange={e => setGrossTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div className="md:col-span-2"><label className="block text-sm font-medium">Desired Output Unit</label><select value={outputUnit} onChange={e => setOutputUnit(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{ Object.keys(MDA_UNIT_CONFIG).map(u => <option key={u} value={u}>{MDA_UNIT_CONFIG[u].label}</option>) }</select></div>
                            {MDA_UNIT_CONFIG[outputUnit]?.requires.includes('volume') && ( <div className="animate-fade-in md:col-span-2"><label className="block text-sm font-medium">Sample Volume (L)</label><input type="number" value={sampleVolume} onChange={e => setSampleVolume(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div> )}
                            {MDA_UNIT_CONFIG[outputUnit]?.requires.includes('mass') && ( <div className="animate-fade-in md:col-span-2"><label className="block text-sm font-medium">Sample Mass (g)</label><input type="number" value={sampleMass} onChange={e => setSampleMass(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div> )}
                        </div>
                    </div>
                ) : (
                    <div className="space-y-4 animate-fade-in">
                        {/* FIXED: Sanitized Text */}
                        <ContextualNote type="info">
                            {"Calculates Scan MDC based on NUREG-1507 / MARSSIM."} <br/>
                            {"MDC = MDCR_surveyor / (Eff_tot * Area/100)"}
                        </ContextualNote>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-medium">Scan Speed (cm/s)</label><input type="number" value={scanSpeed} onChange={e => setScanSpeed(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                            <div>
                                <Tooltip text="The physical width of the detector window in the direction of travel. Used to calculate residence time.">
                                    <label className="block text-sm font-medium cursor-help underline decoration-dotted">Probe Width (cm)</label>
                                </Tooltip>
                                <input type="number" value={probeDimension} onChange={e => setProbeDimension(e.target.value)} placeholder="Scan Direction Dim." className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/>
                            </div>
                        </div>
                        <details className="p-2 rounded-lg bg-slate-50 dark:bg-slate-900/50"><summary className="cursor-pointer text-sm font-semibold">Advanced Factors</summary><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700"><div><label className="block text-sm font-medium">Detectability Index (d')</label><Tooltip text="Guidance from MARSSIM 6.7.2.1. Relates the desired probability of detecting a hot spot."><select value={dprime} onChange={e => setDprime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{dprimeOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></Tooltip></div><div><label className="block text-sm font-medium">Surveyor Efficiency (p)</label><Tooltip text="Guidance from NUREG-1507, Sec. 6.6. Accounts for the human factor of the surveyor noticing an audible signal."><select value={surveyorEff} onChange={e => setSurveyorEff(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">{surveyorEffOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></Tooltip></div></div></details>
                    </div>
                )}
                {error && <p className="text-red-500 text-sm text-center mt-4">{error}</p>}
                {result && (
                    <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 animate-fade-in">
                        {result.type === 'static' ? (
                            <>
                                <div className="flex justify-between items-center -mt-2 -mb-2">
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-left p-2">
                                        <span className="font-semibold text-slate-600 dark:text-slate-300">LLD (Net):</span><span className="font-mono text-right">{result.LLD} counts</span>
                                        {result.unit !== 'counts' && <><span className="font-semibold text-slate-600 dark:text-slate-300">Bkg. Equiv:</span><span className="font-mono text-right">{result.backgroundActivity} {result.unit}</span></>}
                                    </div>
                                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5" /></button></Tooltip>
                                </div>
                                <div className="text-center pt-2 border-t border-slate-300 dark:border-slate-600">
                                    <p className="font-semibold text-sm text-slate-500 dark:text-slate-400">{ MDA_UNIT_CONFIG[result.unit]?.label || 'Result' }</p>
                                    <div className="flex items-center justify-center"><p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.MDA}</p><CopyButton textToCopy={result.MDA} /></div>
                                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">{result.unit}</p>
                                </div>
                            </>
                        ) : (
                            <div className="space-y-3">
                                <div className="flex justify-between items-center -mt-2">
                                    <h3 className="text-lg font-bold text-center mb-2">Scan Survey Results</h3>
                                    <Tooltip text="Save to Recent Calculations" widthClass="w-auto"><button onClick={handleSaveToHistory} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.notepad} className="w-5 h-5" /></button></Tooltip>
                                </div>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-left p-2 border-b border-slate-300 dark:border-slate-600">
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Observation Interval:</span><span className="font-mono text-right">{result.obs_interval} s</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">Bkg. Counts/Interval:</span><span className="font-mono text-right">{result.bg_counts_in_interval} cts</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">MDCR (Instrument):</span><span className="font-mono text-right">{result.mdcr_inst} cpm</span>
                                    <span className="font-semibold text-slate-600 dark:text-slate-300">MDCR (Surveyor):</span><span className="font-mono text-right font-bold text-sky-600">{result.mdcr_surveyor} cpm</span>
                                </div>
                                <div className="text-center pt-2">
                                    <p className="font-semibold text-sm text-slate-500 dark:text-slate-400">Scan MDC (Activity)</p>
                                    <div className="flex items-center justify-center"><p className="text-3xl font-bold text-sky-600 dark:text-sky-400">{result.scan_mda}</p><CopyButton textToCopy={result.scan_mda} /></div>
                                    <p className="text-md font-medium text-slate-600 dark:text-slate-300">dpm/100 cm²</p>
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                <ContextualNote type="info">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                        <span className="text-slate-600 dark:text-slate-300">
                            Need to estimate probe response from activity?
                        </span>
                        <button 
                            onClick={onDeepLink}
                            className="flex items-center gap-1 text-sky-600 dark:text-sky-400 hover:underline font-bold whitespace-nowrap transition-colors"
                        >
                            <Icon path={ICONS.doseRate} className="w-4 h-4" />
                            Detector Response Tool &rarr;
                        </button>
                    </div>
                </ContextualNote>
            </div>
        </div>
    );
};

             /**
              * @description A calculator to determine the required number of statistical samples for a
              * survey unit based on the more precise MARSSIM Equation 5-2.
              */

const MARSSIM_SampleCalculator = ({ onTransferResults }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    const [alpha, setAlpha] = React.useState('0.05');
    const [beta, setBeta] = React.useState('0.05');
    const [sigma, setSigma] = React.useState('15');
    const [dcgl, setDcgl] = React.useState('100');
    const [lbgr, setLbgr] = React.useState('50');
    const [cv, setCv] = React.useState('0.3');
    const [backgroundPresence, setBackgroundPresence] = React.useState('insignificant'); 
    
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    const zScores = {
        '0.005': 2.576, '0.01': 2.326, '0.025': 1.960, '0.05': 1.645,
        '0.10': 1.282, '0.20': 0.841,
    };

    // HIGH PRECISION MATH HELPER (Abramowitz & Stegun 7.1.26)
    const getNormalCDF = (x) => {
        const t = 1 / (1 + 0.2316419 * Math.abs(x));
        const d = 0.3989423 * Math.exp(-x * x / 2);
        const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return x > 0 ? 1 - prob : prob;
    };

    const handleClearInputs = () => {
        setAlpha('0.05'); setBeta('0.05'); setSigma('15');
        setDcgl('100'); setLbgr('50'); setCv('0.3');
        setBackgroundPresence('insignificant');
        setResult(null); setError('');
    };

    React.useEffect(() => { handleCalculate(); }, []);

    React.useEffect(() => {
        localStorage.setItem('marssim_alpha', alpha);
        localStorage.setItem('marssim_beta', beta);
        localStorage.setItem('marssim_sigma', sigma);
        localStorage.setItem('marssim_dcgl', dcgl);
        localStorage.setItem('marssim_lbgr', lbgr);
        localStorage.setItem('marssim_cv', cv);
        localStorage.setItem('marssim_bg', backgroundPresence);
    }, [alpha, beta, sigma, dcgl, lbgr, cv, backgroundPresence]);

    const handleCalculateSigma = () => {
        const d = parseFloat(dcgl); const c = parseFloat(cv);
        if (!isNaN(d) && !isNaN(c)) setSigma((d * c).toPrecision(3));
    };

    const handleSetLbgr = () => {
        const d = parseFloat(dcgl);
        if (!isNaN(d)) setLbgr((d * 0.5).toPrecision(3));
    };

    const handleCalculate = () => {
        const sVal = parseFloat(sigma);
        const dVal = parseFloat(dcgl);
        const lVal = parseFloat(lbgr);

        if (isNaN(sVal) || isNaN(dVal) || isNaN(lVal) || sVal <= 0) {
            setResult(null); return;
        }
        if (dVal <= lVal) {
            setError('DCGL must be greater than LBGR.');
            setResult(null); return;
        }
        setError('');

        const z1_alpha = zScores[alpha];
        const z1_beta = zScores[beta];
        const delta = dVal - lVal;
        const rawRelShift = delta / sVal;
        const usedRelShift = rawRelShift > 3.0 ? 3.0 : rawRelShift;

        let Pr = 0;
        let N_raw = 0;
        let methodLabel = '';
        let samplesPerUnit = 0;
        let isWRS = false;

        if (backgroundPresence === 'insignificant') {
            // --- SIGN TEST ---
            methodLabel = 'No Background Correction (Sign Formula)';
            Pr = getNormalCDF(usedRelShift);
            if (Pr <= 0.5) { setError("Relative Shift too low."); setResult(null); return; }
            
            // Sign Formula: Result is N for the Survey Unit
            N_raw = Math.pow(z1_alpha + z1_beta, 2) / (4 * Math.pow(Pr - 0.5, 2));
            
            // Apply 20% margin, then round up
            samplesPerUnit = Math.ceil(N_raw * 1.20);
            
        } else {
            // --- WRS TEST ---
            isWRS = true;
            methodLabel = 'With Background Reference (WRS Formula)';
            Pr = getNormalCDF(usedRelShift / Math.sqrt(2));
            if (Pr <= 0.5) { setError("Relative Shift too low."); setResult(null); return; }
            
            // WRS Formula: Result is TOTAL N (Ref + Survey)
            N_raw = Math.pow(z1_alpha + z1_beta, 2) / (3 * Math.pow(Pr - 0.5, 2));
            
            // Apply 20% margin to total, then divide by 2 for "N/2" (Per Unit)
            const N_total_with_margin = N_raw * 1.20;
            samplesPerUnit = Math.ceil(N_total_with_margin / 2);
        }

        setResult({ 
            totalShift: delta, 
            relativeShift: rawRelShift.toFixed(2), 
            final_N: samplesPerUnit, 
            methodLabel,
            isWRS
        });
    };

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({
                id: Date.now(),
                type: 'MARSSIM Samples',
                icon: ICONS.calculator,
                inputs: `${result.methodLabel}, Δ/σ: ${result.relativeShift}`,
                result: `${result.final_N} samples`,
                view: VIEWS.MARSSIM_SAMPLES
            });
            addToast("Calculation saved to history!");
        }
    };

    React.useEffect(() => { handleCalculate(); }, [alpha, beta, sigma, dcgl, lbgr, cv, backgroundPresence]);

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-1">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">MARSSIM Samples Calculator</h2>
                    <ClearButton onClick={handleClearInputs} />
                </div>
                
                {/* Simplified Toggle */}
                <div className="mb-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600">
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Is the Contaminant present in Background?</label>
                    <div className="flex gap-4">
                        <label className="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="bgP" value="insignificant" checked={backgroundPresence === 'insignificant'} onChange={e => setBackgroundPresence(e.target.value)} className="text-sky-600"/>
                            <span className="text-sm font-medium">No (Use Sign Formula)</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="bgP" value="significant" checked={backgroundPresence === 'significant'} onChange={e => setBackgroundPresence(e.target.value)} className="text-sky-600"/>
                            <span className="text-sm font-medium">Yes (Use WRS Formula)</span>
                        </label>
                    </div>
                </div>

                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium">Type I Error (α)</label>
                            <select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                {Object.keys(zScores).map(key => <option key={key} value={key}>{key}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Type II Error (β)</label>
                            <select value={beta} onChange={e => setBeta(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700">
                                {Object.keys(zScores).map(key => <option key={key} value={key}>{key}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                        <div>
                            <label className="block text-sm font-medium">Estimated Std. Deviation (σ)</label>
                            <input type="number" value={sigma} onChange={e => setSigma(e.target.value)} placeholder="in units of DCGL" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium">DCGL (Limit)</label>
                            <input type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} placeholder="Cleanup limit" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium">LBGR (Mean)</label>
                            <input type="number" value={lbgr} onChange={e => setLbgr(e.target.value)} placeholder="Concentration that is 'clean'" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" />
                        </div>
                    </div>
                    
                    <details className="p-3 my-2 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                        <summary className="cursor-pointer text-sm font-semibold text-slate-600 dark:text-slate-300">
                            Scoping Data Helper
                        </summary>
                        <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 space-y-3">
                            <div className="flex items-end gap-2">
                                <div className="flex-grow">
                                    <label className="block text-xs font-medium">Coefficient of Variation (CV)</label>
                                    <input type="number" value={cv} onChange={e => setCv(e.target.value)} step="0.05" className="w-full mt-1 p-2 rounded-md bg-white dark:bg-slate-700" />
                                </div>
                                <button onClick={handleCalculateSigma} className="px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 rounded-md font-semibold hover:bg-slate-300 dark:hover:bg-slate-500">
                                    Calculate σ
                                </button>
                            </div>
                            <button onClick={handleSetLbgr} className="w-full px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 rounded-md font-semibold hover:bg-slate-300 dark:hover:bg-slate-500">
                                Set LBGR to 50% of DCGL
                            </button>
                        </div>
                    </details>
                    
                    <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Save to Calculations</button>
                    
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    
                    {result && (
                        <div className="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg mt-4 space-y-3 text-center animate-fade-in">
                            <div className="flex justify-between items-center pb-2 border-b border-slate-200 dark:border-slate-600">
                                <span className="text-sm font-bold text-slate-500 uppercase">Calculation Method</span>
                                <span className={`text-sm font-mono font-bold ${parseFloat(result.relativeShift) < 1 || parseFloat(result.relativeShift) > 3 ? 'text-amber-500' : 'text-green-600'}`}>Δ/σ: {result.relativeShift}</span>
                            </div>
                            
                            <div className="py-2">
                                <p className="font-semibold block text-sm text-slate-500 dark:text-slate-400">
                                    {/* DYNAMIC LABEL CHANGE */}
                                    {result.isWRS ? "Required Survey Points (N/2)" : "Required Survey Points (N)"}
                                </p>
                                <div className="flex items-center justify-center gap-2">
                                    <p className="text-4xl font-extrabold text-sky-600 dark:text-sky-400">{result.final_N}</p>
                                    <CopyButton textToCopy={result.final_N} />
                                </div>
                                <p className="text-xs font-medium text-slate-600 dark:text-slate-300 mt-1">(Includes 20% MARSSIM adjustment)</p>
                            </div>

                            {result.isWRS && (
                                <div className="p-3 bg-amber-50 dark:bg-amber-900/20 rounded border border-amber-200 dark:border-amber-700 text-xs text-amber-800 dark:text-amber-200">
                                    <strong>WRS Requirement:</strong> You must also collect <strong>{result.final_N}</strong> samples in your Reference Area.
                                </div>
                            )}

                            <button 
                                onClick={() => onTransferResults(result.final_N)}
                                className="flex items-center justify-center gap-2 w-full py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition shadow-sm hover:shadow-md"
                            >
                                <Icon path={ICONS.map} className="w-5 h-5" />
                                Map These Points &rarr;
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};         
              /**
              * @description React component for a graphical survey unit drawing tool. This utility
              * allows users to visually plan and lay out radiation survey points on an interactive map.
              * The tool is designed to support the planning phase of a final status survey, particularly
              * for a **Multi-Agency Radiation Survey and Site Investigation Manual (MARSSIM)** project.
              *
              * Key features include:
              * - **Interactive Map:** A Leaflet-based map provides a visual canvas.
              * - **Drawing Controls:** Users can draw survey unit boundaries using **polygons** or
              * **rectangles**.
              * - **Sample Point Generation:** Automatically generates statistical sample points within
              * the drawn boundary using common MARSSIM patterns: **random**, **square grid**, or
              * **triangular grid**.
              * - **Manual Point Placement:** Allows for the placement of "biased" sample points in
              * areas of known or suspected contamination.
              * - **Area Calculation:** Automatically calculates the area of the drawn survey unit.
              * - **Data Export:** The final list of sample points, including coordinates and a unique
              * identifier, can be exported to a `.csv` file for use with GPS devices or for documentation.
              *
              * This component is an essential part of the MARSSIM suite, bridging the statistical
              * calculations with a practical, field-ready planning tool.
              *
              * @prop {boolean} isVisible - Boolean to trigger map redraw on component mount,
              * ensuring correct rendering within a tabbed interface.
              */
         
const DrawingTool = ({ isVisible, importedSamples }) => {
    const mapRef = React.useRef(null);
    const drawnItemsRef = React.useRef(null);
    const samplePointsLayerRef = React.useRef(null);
    const originMarkerRef = React.useRef(null);
    const fileInputRef = React.useRef(null);
    const osmLayerRef = React.useRef(null);
    const satelliteLayerRef = React.useRef(null);
    const { addToast } = useToast();

    // --- STATE MANAGEMENT ---
    const [surveyUnitLayer, setSurveyUnitLayer] = React.useState(null);
    const [surveyUnitArea, setSurveyUnitArea] = React.useState(0);
    const [plottedPoints, setPlottedPoints] = React.useState([]);
    const [locationInput, setLocationInput] = React.useState('');
    const [surveyUnitName, setSurveyUnitName] = React.useState('SU-1');
    const [surveyClass, setSurveyClass] = React.useState('Class 1');
    const [samplesToPlace, setSamplesToPlace] = React.useState(25);
    const [sampleCalcMode, setSampleCalcMode] = React.useState('byNumber');
    const [gridSpacing, setGridSpacing] = React.useState(10);

    const highlightStyle = { weight: 5, color: '#0ea5e9', dashArray: '', fillOpacity: 0.5 };
    const defaultStyle = { color: '#3388ff' };

    const plottedPointsRef = React.useRef(plottedPoints);
    const surveyUnitNameRef = React.useRef(surveyUnitName);
    const surveyClassRef = React.useRef(surveyClass);

    // Keep refs synchronized with state
    React.useEffect(() => { plottedPointsRef.current = plottedPoints; }, [plottedPoints]);
    React.useEffect(() => { surveyUnitNameRef.current = surveyUnitName; }, [surveyUnitName]);
    React.useEffect(() => { surveyClassRef.current = surveyClass; }, [surveyClass]);

React.useEffect(() => {
        if (importedSamples && importedSamples > 0) {
            setSamplesToPlace(importedSamples);
            setSampleCalcMode('byNumber'); // Ensure we are in the right mode to use this number
            addToast(`Imported ${importedSamples} samples from calculator.`);
        }
    }, [importedSamples]);

    // --- HELPER FUNCTIONS ---

    React.useEffect(() => {
        if (surveyUnitLayer) {
            const popupContent = `<b>Survey Unit: ${surveyUnitName}</b><br>Class: ${surveyClass}<br>Area: ${surveyUnitArea.toFixed(1)} m²`;
            surveyUnitLayer.setPopupContent(popupContent);
        }
    }, [surveyUnitName, surveyClass, surveyUnitLayer, surveyUnitArea]);

    const getNextIdForPrefix = (points, prefix) => {
        const existingNumbers = points
            .filter(p => p.id.startsWith(prefix + '-'))
            .map(p => parseInt(p.id.split('-')[1], 10))
            .sort((a, b) => a - b);

        let nextNum = 1;
        for (const num of existingNumbers) {
            if (num === nextNum) {
                nextNum++;
            } else {
                break; // Found a gap
            }
        }
        return `${prefix}-${nextNum}`;
    };

    // Robust point-in-polygon check
    const isPointInPolygon = (point, polygonLatLngs) => {
        // Leaflet Draw polygons can have nested arrays for holes, we take the outer ring [0]
        const polyPoints = polygonLatLngs[0]; 
        const x = point.lat, y = point.lng;
        let inside = false;
        for (let i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
            const xi = polyPoints[i].lat, yi = polyPoints[i].lng;
            const xj = polyPoints[j].lat, yj = polyPoints[j].lng;
            const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    };

    // Clears ONLY the statistical samples (Random, Square, Triangular)
    const handleClearPoints = () => {
        const biasedOnly = plottedPoints.filter(p => p.type === 'Biased');
        setPlottedPoints(biasedOnly);
        
        // Remove layers that are NOT the origin marker and NOT matched to a biased point ID
        samplePointsLayerRef.current.eachLayer(layer => {
            if (layer !== originMarkerRef.current) {
                // Check if this layer corresponds to a biased point we are keeping
                // Biased points are stored in state, so we can check IDs if we attached them to layers
                // Simplified approach: Clear all points layer, re-add biased points
                samplePointsLayerRef.current.removeLayer(layer);
            }
        });

        // Re-add biased points visually
        biasedOnly.forEach(p => {
             const latLng = { lat: p.lat, lng: p.lng };
             const popupContent = `<b>Bias Sample Point #${p.id}</b><br>Type: Biased<br>Lat: ${p.lat.toFixed(7)}<br>Lng: ${p.lng.toFixed(7)}`;
             const marker = L.circleMarker(latLng, { radius: 4, className: 'biased-sample-marker' }).bindPopup(popupContent);
             marker.myCustomId = p.id;
             drawnItemsRef.current.addLayer(marker); // Biased points live in drawnItems so they persist
        });
    };

    const handleClearAll = () => {
        if (drawnItemsRef.current) drawnItemsRef.current.clearLayers();
        if (samplePointsLayerRef.current) samplePointsLayerRef.current.clearLayers();
        setSurveyUnitLayer(null);
        setSurveyUnitArea(0);
        setPlottedPoints([]);
    };

    const onDrawDelete = (e) => {
        e.layers.eachLayer(layer => {
            if (layer instanceof L.CircleMarker && layer.myCustomId) {
                const deletedId = layer.myCustomId;
                setPlottedPoints(currentPoints =>
                    currentPoints.filter(p => p.id !== deletedId)
                );
            } else if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                handleClearAll();
            }
        });
        addToast("Item(s) removed from map.");
    };

    // --- CORE LOGIC ---
    const onDrawEditOrCreate = (e) => {
        if (e.type === 'draw:edited') {
            const currentPoints = plottedPointsRef.current;
            
            // 1. Separate biased points (persist) from statistical (clear, as they may now be outside)
            const biasedPoints = currentPoints.filter(p => p.type === 'Biased');
            const statisticalPoints = currentPoints.filter(p => p.type !== 'Biased');
            
            // If we had statistical points, warn the user they are gone/need regen
            if (statisticalPoints.length > 0) {
                 addToast("Boundary modified. Statistical samples cleared.");
                 // Clear them visually
                 samplePointsLayerRef.current.clearLayers();
                 // Origin marker might need re-adding
                 if (originMarkerRef.current) {
                      // Logic in useEffect will re-add origin based on surveyUnitLayer
                      originMarkerRef.current.remove();
                      originMarkerRef.current = null;
                 }
            }

            // Update Biased Points positions if they were dragged (Leaflet Draw handles marker drag)
            const updatedBiasedPoints = [];
            e.layers.eachLayer(layer => {
                if (layer instanceof L.CircleMarker && layer.myCustomId) {
                    const latLng = layer.getLatLng();
                    updatedBiasedPoints.push({ 
                        id: layer.myCustomId, 
                        lat: latLng.lat, 
                        lng: latLng.lng, 
                        type: 'Biased' 
                    });
                } else if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                    // Recalculate Area using Geodesic (more accurate)
                    const latLngs = layer.getLatLngs()[0];
                    const area = L.GeometryUtil.geodesicArea(latLngs);
                    setSurveyUnitArea(area);
                    
                    const popupContent = `<b>Survey Unit: ${surveyUnitNameRef.current}</b><br>Class: ${surveyClassRef.current}<br>Area: ${area.toFixed(1)} m²`;
                    layer.setPopupContent(popupContent);
                }
            });

            // If we didn't find specific marker layers in the event, we keep the old biased points (they weren't edited)
            // But this event usually contains everything being edited.
            // Simplified: We set state to just the biased points. User must click "Generate" again for grid.
            setPlottedPoints(updatedBiasedPoints.length > 0 ? updatedBiasedPoints : biasedPoints);
            return;
        }

        const layer = e.layer;
        if (!layer) return;

        if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
            drawnItemsRef.current.eachLayer(l => {
                if (l instanceof L.Polygon || l instanceof L.Rectangle) { drawnItemsRef.current.removeLayer(l); }
            });
            handleClearPoints(); 
            drawnItemsRef.current.addLayer(layer);
            setSurveyUnitLayer(layer);
            
            // Use Geodesic Area
            const latLngs = layer.getLatLngs()[0];
            const area = L.GeometryUtil.geodesicArea(latLngs);
            setSurveyUnitArea(area);
            
            const popupContent = `<b>Survey Unit: ${surveyUnitNameRef.current}</b><br>Class: ${surveyClassRef.current}<br>Area: ${area.toFixed(1)} m²`;
            layer.bindPopup(popupContent).openPopup();
            
            layer.on({
                mouseover: (e) => e.target.setStyle(highlightStyle),
                mouseout: (e) => e.target.setStyle(defaultStyle)
            });
        } else if (layer instanceof L.Marker) {
            drawnItemsRef.current.removeLayer(layer);
            const latLng = layer.getLatLng();
            
            setPlottedPoints(prevPoints => {
                const newId = getNextIdForPrefix(prevPoints, 'B');
                const newPoint = { id: newId, lat: latLng.lat, lng: latLng.lng, type: 'Biased' };
                
                const popupContent = `<b>Bias Sample Point #${newId}</b><br>Type: Biased<br>Lat: ${latLng.lat.toFixed(7)}<br>Lng: ${latLng.lng.toFixed(7)}`;
                const newMarker = L.circleMarker(latLng, { 
                    radius: 4, 
                    className: 'biased-sample-marker' 
                }).bindPopup(popupContent);
                
                newMarker.myCustomId = newId;
                drawnItemsRef.current.addLayer(newMarker);
                
                return [...prevPoints, newPoint];
            });
        }
    };

    const handleGenerateSamples = React.useCallback((pattern) => {
        if (!surveyUnitLayer) {
            addToast("Please draw a survey unit boundary first.");
            return;
        }
        handleClearPoints(); // Clear existing grid points
        
        // Retrieve biased points to preserve them
        const existingBiasedPoints = plottedPointsRef.current.filter(p => p.type === 'Biased');
        
        let numSamples = samplesToPlace;
        let spacingMeters = gridSpacing;
        const latLngs = surveyUnitLayer.getLatLngs();
        const bounds = surveyUnitLayer.getBounds();

        // 1. Calculate Spacing / Number
        if (pattern !== 'random') {
            if (sampleCalcMode === 'bySpacing') {
                if (spacingMeters <= 0) { addToast("Grid spacing must be > 0."); return; }
                // Estimate N
                const multiplier = pattern === 'triangular' ? 0.866 : 1;
                numSamples = Math.ceil(surveyUnitArea / (spacingMeters * spacingMeters * multiplier));
                setSamplesToPlace(numSamples);
            } else { // byNumber
                if (numSamples <= 0) { addToast("Number of samples must be > 0."); return; }
                const multiplier = pattern === 'triangular' ? 0.866 : 1;
                spacingMeters = Math.sqrt(surveyUnitArea / (multiplier * numSamples));
                setGridSpacing(spacingMeters.toFixed(2));
            }
        }

        // --- CRITICAL FIX: Infinite Loop Protection ---
        if (pattern !== 'random' && spacingMeters <= 0.01) {
            addToast("Calculated grid spacing is too small. Check area and sample count.");
            return;
        }

        const newPoints = [];
        
        if (pattern === 'random') {
            // Random generation (unchanged)
            for (let i = 0; i < numSamples; i++) {
                let pointFound = false;
                let attempts = 0;
                while (!pointFound && attempts < 2000) {
                    const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                    const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                    if (isPointInPolygon({ lat, lng }, latLngs)) {
                        newPoints.push({ lat, lng });
                        pointFound = true;
                    }
                    attempts++;
                }
            }
        } else { 
            // Systematic Grid
            // Approx conversion factors at the center latitude
            const centerLat = (bounds.getSouth() + bounds.getNorth()) / 2;
            const metersPerDegLat = 111320;
            const metersPerDegLng = 111320 * Math.cos(centerLat * Math.PI / 180);

            const spacingLat = spacingMeters / metersPerDegLat;
            const spacingLng = spacingMeters / metersPerDegLng;

            // Random start point logic (MARSSIM requirement)
            // L.GeometryUtil.randomPointInLayer(surveyUnitLayer) is better but manual is fine for now
            const randomLatOffset = Math.random() * spacingLat;
            const randomLngOffset = Math.random() * spacingLng;

            let row = 0;
            // Loop with safety check
            for (let lat = bounds.getSouth() + randomLatOffset - spacingLat; lat < bounds.getNorth() + spacingLat; lat += spacingLat * (pattern === 'triangular' ? 0.866 : 1)) {
                
                const triangularShift = (pattern === 'triangular' && row % 2 !== 0) ? spacingLng / 2 : 0;
                
                for (let lng = bounds.getWest() + randomLngOffset - spacingLng; lng < bounds.getEast() + spacingLng; lng += spacingLng) {
                    
                    const actualLng = lng + triangularShift;
                    
                    if (isPointInPolygon({ lat, lng: actualLng }, latLngs)) {
                        newPoints.push({ lat, lng: actualLng });
                    }
                }
                row++;
            }
        }

        // Add to map
        const pointsWithTypes = newPoints.map((p, index) => {
            const prefix = pattern.charAt(0).toUpperCase(); // R, S, T
            return {
                ...p,
                id: `${prefix}-${index + 1}`,
                type: pattern.charAt(0).toUpperCase() + pattern.slice(1)
            };
        });

        setPlottedPoints([...existingBiasedPoints, ...pointsWithTypes]);

        pointsWithTypes.forEach(point => {
            const marker = L.circleMarker([point.lat, point.lng], { radius: 4, className: 'grid-sample-marker' });
            const popupContent = `<b>Sample Point #${point.id}</b><br>Type: ${point.type}<br>Lat: ${point.lat.toFixed(7)}<br>Lng: ${point.lng.toFixed(7)}`;
            marker.bindPopup(popupContent).addTo(samplePointsLayerRef.current);
        });

        addToast(`${newPoints.length} ${pattern} sample points generated.`);

    }, [surveyUnitLayer, sampleCalcMode, samplesToPlace, gridSpacing, surveyUnitArea, addToast]);

    const handleZoomToSurveyUnit = () => { if (surveyUnitLayer && mapRef.current) { mapRef.current.fitBounds(surveyUnitLayer.getBounds()); } };

    const handleSavePlan = () => {
        if (!surveyUnitLayer) { addToast("Please draw a survey unit to save."); return; }
        const planData = {
            surveyUnit: surveyUnitLayer.toGeoJSON(),
            points: plottedPoints,
            surveyClass: surveyClass,
            samplesToPlace: samplesToPlace,
        };
        const blob = new Blob([JSON.stringify(planData, null, 2)], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "survey-plan.json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const handleLoadPlan = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const parsedData = JSON.parse(e.target.result);
                if (!parsedData.surveyUnit || !parsedData.points) { throw new Error("Invalid plan file format."); }
                
                handleClearAll();
                
                const newSurveyUnit = L.geoJSON(parsedData.surveyUnit, { style: defaultStyle });
                const layer = newSurveyUnit.getLayers()[0];
                if (layer) {
                    drawnItemsRef.current.addLayer(layer);
                    setSurveyUnitLayer(layer);
                    
                    // Use Geodesic
                    const latLngs = layer.getLatLngs()[0];
                    const area = L.GeometryUtil.geodesicArea(latLngs);
                    setSurveyUnitArea(area);
                    
                    mapRef.current.fitBounds(layer.getBounds());

                    const popupContent = `<b>Survey Unit</b><br>Class: ${parsedData.surveyClass || 'Class 1'}<br>Area: ${area.toFixed(1)} m²`;
                    layer.bindPopup(popupContent);
                    layer.on({
                        mouseover: (e) => e.target.setStyle(highlightStyle),
                        mouseout: (e) => e.target.setStyle(defaultStyle)
                    });
                }

                const loadedPoints = parsedData.points || [];
                setPlottedPoints(loadedPoints);
                setSurveyClass(parsedData.surveyClass || 'Class 1');
                setSamplesToPlace(parsedData.samplesToPlace || 25);
                
                loadedPoints.forEach((point, index) => {
                    const marker = L.circleMarker([point.lat, point.lng], {
                        radius: 4,
                        className: point.type === 'Biased' ? 'biased-sample-marker' : 'grid-sample-marker'
                    });
                    const popupContent = `<b>Sample Point #${point.id}</b><br>Type: ${point.type}<br>Lat: ${point.lat.toFixed(7)}<br>Lng: ${point.lng.toFixed(7)}`;
                    marker.bindPopup(popupContent);
                    marker.addTo(samplePointsLayerRef.current);
                    
                    if (point.type === 'Biased') {
                        marker.myCustomId = point.id;
                        drawnItemsRef.current.addLayer(marker); // Ensure Biased persist in edits
                    }
                });

            } catch (error) { alert(`Error loading plan: ${error.message}`); }
        };
        reader.readAsText(file);
        event.target.value = null;
    };

    const handleExport = () => {
        if (plottedPoints.length === 0 || !surveyUnitLayer) {
            addToast("Please draw a survey unit and place sample points before exporting."); return;
        }
        const origin = surveyUnitLayer ? { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng } : null;
        
        // Sort: Biased first (by ID), then grid points (by numeric ID)
        const sortedPoints = [...plottedPoints].sort((a, b) => {
             const aIsBiased = a.type === 'Biased';
             const bIsBiased = b.type === 'Biased';
             if (aIsBiased && !bIsBiased) return -1;
             if (!aIsBiased && bIsBiased) return 1;
             
             // Extract numeric part of ID (e.g., S-1 -> 1)
             const aNum = parseInt(a.id.split('-')[1]);
             const bNum = parseInt(b.id.split('-')[1]);
             return aNum - bNum;
        });

        const dataForExport = sortedPoints.map((point) => {
            const yDistance = calculateDistance(origin, { lat: point.lat, lng: origin.lng });
            const xDistance = calculateDistance(origin, { lat: origin.lat, lng: point.lng });
            return { 
                sampleNumber: point.id, 
                type: point.type, 
                latitude: point.lat.toFixed(7), 
                longitude: point.lng.toFixed(7), 
                xDistance: xDistance.toFixed(3), 
                yDistance: yDistance.toFixed(3) 
            };
        });
        const headers = ["Sample #", "Type", "Latitude", "Longitude", "X Distance (m)", "Y Distance (m)"];
        const csvRows = [headers.join(',')];
        dataForExport.forEach(row => { csvRows.push(Object.values(row).join(',')); });
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "survey_sample_points.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const handleGoToLocation = async () => {
        if (!locationInput.trim()) return;
        const coordRegex = /^-?[\d.]+\s*,\s*-?[\d.]+$/;
        if (coordRegex.test(locationInput)) {
            const [lat, lng] = locationInput.split(',').map(Number);
            if (!isNaN(lat) && !isNaN(lng)) { mapRef.current.setView([lat, lng], 16); return; }
        }
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput)}`);
            const data = await response.json();
            if (data && data.length > 0) {
                const { lat, lon } = data[0];
                mapRef.current.setView([parseFloat(lat), parseFloat(lon)], 16);
            } else { addToast("Location not found."); }
        } catch (error) { addToast("Could not connect to the location service."); }
    };
    
    // --- PRINT / PDF HANDLER (Simplified for brevity, includes origin style) ---
    const handlePrintMap = () => {
        if (!mapRef.current || !surveyUnitLayer) { addToast("No survey unit to print."); return; }
        // ... (Keep existing print logic, it works fine. Ensure you update the coordinate precision in the HTML table generation to .toFixed(7) if desired.)
        // Just triggering the existing function if you kept it.
        window.print(); 
    };

    // --- MAP INITIALIZATION ---
    React.useEffect(() => {
        if (mapRef.current) return;
        
        L.drawLocal.draw.toolbar.buttons.marker = 'Place a bias sample';
        L.drawLocal.draw.handlers.marker.tooltip.start = 'Click map to place bias sample.';

        const biasMarkerIcon = new L.DivIcon({ className: 'leaflet-draw-biased-marker-icon', iconSize: new L.Point(12, 12), iconAnchor: new L.Point(8, 8) });
        const yourStadiaApiKey = 'a7f8d6b2-37be-4661-afa4-0409424b5708';
        
        osmLayerRef.current = L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.png?api_key={apiKey}', {
            attribution: '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a>',
            maxNativeZoom: 19, maxZoom: 21, apiKey: yourStadiaApiKey
        });
        satelliteLayerRef.current = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri', maxNativeZoom: 19, maxZoom: 21 });

        mapRef.current = L.map('marssim-map', { layers: [osmLayerRef.current] }).setView([37.207, -76.51], 13);
        
        drawnItemsRef.current = new L.FeatureGroup();
        samplePointsLayerRef.current = new L.FeatureGroup();
        mapRef.current.addLayer(drawnItemsRef.current);
        mapRef.current.addLayer(samplePointsLayerRef.current);

        const drawControl = new L.Control.Draw({ 
            edit: { featureGroup: drawnItemsRef.current }, 
            draw: { 
                polyline: false, polygon: { shapeOptions: { color: '#3388ff' } }, 
                rectangle: { shapeOptions: { color: '#3388ff' } }, 
                marker: { icon: biasMarkerIcon }, circle: false, circlemarker: false 
            } 
        });
        mapRef.current.addControl(drawControl);
        
        // Add North Arrow & Scale (Keep existing logic)
        L.control.scale({ imperial: true, metric: true }).addTo(mapRef.current);
        
        // Events
        mapRef.current.on(L.Draw.Event.CREATED, onDrawEditOrCreate);
        mapRef.current.on(L.Draw.Event.EDITED, onDrawEditOrCreate);
        mapRef.current.on(L.Draw.Event.DELETED, onDrawDelete);

        return () => { if (mapRef.current) { mapRef.current.remove(); mapRef.current = null; } };
    }, []);

    React.useEffect(() => { if (isVisible && mapRef.current) { setTimeout(() => mapRef.current.invalidateSize(), 100); } }, [isVisible]);
    
    // Manage Origin Marker
    React.useEffect(() => {
        if (originMarkerRef.current) { originMarkerRef.current.remove(); originMarkerRef.current = null; }
        if (surveyUnitLayer && samplePointsLayerRef.current) {
            const originLatLng = surveyUnitLayer.getBounds().getSouthWest();
            const originMarker = L.circleMarker(originLatLng, { radius: 6, className: 'origin-sample-marker' }).bindPopup(`<b>Survey Origin (SW Corner)</b><br>Lat: ${originLatLng.lat.toFixed(7)}<br>Lng: ${originLatLng.lng.toFixed(7)}`);
            originMarker.addTo(samplePointsLayerRef.current);
            originMarkerRef.current = originMarker;
        }
    }, [surveyUnitLayer]);

    return (
        <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
             <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h3 className="text-lg font-bold">Survey Unit Drawing Tool</h3>
                <div className="flex items-center gap-2">
                    {surveyUnitLayer && ( <button onClick={handleZoomToSurveyUnit} className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Zoom to Unit</button> )}
                    <input type="file" ref={fileInputRef} onChange={handleLoadPlan} accept=".json" style={{ display: 'none' }} />
                    <button onClick={() => fileInputRef.current.click()} className="px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Load Plan</button>
                    <button onClick={handleSavePlan} className="px-3 py-2 text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Save Plan</button>
                </div>
            </div>
            <div className="flex gap-2 items-center mb-4">
                <input type="text" value={locationInput} onChange={(e) => setLocationInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleGoToLocation(); }} placeholder="Enter an address or lat,lng coordinates" className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-sky-500"/>
                <button onClick={handleGoToLocation} className="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Go</button>
            </div>
            
            <div id="marssim-map" className="w-full h-[60vh] my-4 rounded-lg bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 z-0"></div>
            
            <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="md:col-span-2 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                    <h4 className="font-bold text-lg mb-3">Survey Unit Dashboard</h4>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <label className="font-semibold text-slate-500 dark:text-slate-400">Unit Name</label>
                            <input type="text" value={surveyUnitName} onChange={e => setSurveyUnitName(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600"/>
                        </div>
                        <div>
                            <label className="font-semibold text-slate-500 dark:text-slate-400">Unit Class</label>
                            <select value={surveyClass} onChange={e => setSurveyClass(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600">
                                <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Un-Impacted</option><option>Other</option>
                            </select>
                        </div>
                        <div className="pt-2">
                            <p className="font-semibold text-slate-500 dark:text-slate-400">Area (Geodesic)</p>
                            <p className="text-xl font-bold text-sky-600 dark:text-sky-400">{surveyUnitArea.toFixed(1)} m²</p>
                        </div>
                         <div className="pt-2">
                            <p className="font-semibold text-slate-500 dark:text-slate-400">Plotted Samples</p>
                            <p className="text-xl font-bold text-sky-600 dark:text-sky-400">{plottedPoints.length}</p>
                        </div>
                    </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg h-full flex flex-col justify-between">
                    <div>
                        <h4 className="font-bold text-lg mb-3">Statistical Samples</h4>
                        <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-3">
                            <button onClick={() => setSampleCalcMode('byNumber')} className={`w-1/2 p-1 rounded-md text-xs font-semibold ${sampleCalcMode === 'byNumber' ? 'bg-white dark:bg-slate-800' : ''}`}>By Number</button>
                            <button onClick={() => setSampleCalcMode('bySpacing')} className={`w-1/2 p-1 rounded-md text-xs font-semibold ${sampleCalcMode === 'bySpacing' ? 'bg-white dark:bg-slate-800' : ''}`}>By Spacing</button>
                        </div>
                        {sampleCalcMode === 'byNumber' ? (
                             <div className="text-center">
                                <label className="font-semibold text-sm text-slate-500 dark:text-slate-400 mb-2">Desired Number of Samples</label>
                                <input type="number" value={samplesToPlace} onChange={(e) => setSamplesToPlace(parseInt(e.target.value, 10) || 0)} className="persistent-spinner w-24 text-center text-2xl font-bold text-sky-600 dark:text-sky-400 p-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:outline-none" />
                             </div>
                        ) : (
                            <div className="text-center">
                                <label className="font-semibold text-sm text-slate-500 dark:text-slate-400 mb-2">Grid Spacing (meters)</label>
                                <input type="number" value={gridSpacing} onChange={(e) => setGridSpacing(parseInt(e.target.value, 10) || 0)} className="persistent-spinner w-24 text-center text-2xl font-bold text-sky-600 dark:text-sky-400 p-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 focus:outline-none" />
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-3 gap-2 mt-2">
                        <button onClick={() => handleGenerateSamples('square')} className="p-2 text-xs md:text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-md hover:bg-sky-200 dark:hover:bg-sky-800">Square Grid</button>
                        <button onClick={() => handleGenerateSamples('triangular')} className="p-2 text-[12px] leading-tight bg-slate-200 dark:bg-slate-600 font-semibold rounded-md hover:bg-sky-200 dark:hover:bg-sky-800">Triangular Grid</button>
                        <button onClick={() => handleGenerateSamples('random')} className="p-2 text-xs md:text-sm bg-slate-200 dark:bg-slate-600 font-semibold rounded-md hover:bg-sky-200 dark:hover:bg-sky-800">Random</button>
                    </div>
                </div>
            </div>
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <div className="flex justify-between items-center">
                    <h3 className="text-lg font-bold">Plotted Sample Coordinates ({plottedPoints.length})</h3>
                    <div className="flex items-center gap-4">
                        <button onClick={handleClearPoints} className="text-xs text-slate-500 hover:underline font-semibold flex items-center gap-1"><Icon path={ICONS.clear} className="w-3 h-3"/> Clear Grid Points</button>
                        <button onClick={handleClearAll} className="text-xs text-slate-500 hover:underline font-semibold flex items-center gap-1"><Icon path={ICONS.clear} className="w-3 h-3"/> Clear All</button>
                        <button onClick={handleExport} className="px-3 py-2 text-sm bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition flex items-center gap-2">Export CSV</button>
                    </div>
                </div>
                <div className="max-h-60 overflow-y-auto mt-2 pr-2">
                    {plottedPoints.length > 0 || surveyUnitLayer ? (
                        <div className="overflow-x-auto">
                        <table className="w-full text-sm text-center">
                            <thead className="bg-slate-100 dark:bg-slate-700 sticky top-0">
                               <tr>
                                  <th className="p-2 text-center">#</th>
                                   <th className="p-2 text-center">Type</th>
                                   <th className="p-2 text-center">Latitude</th>
                                   <th className="p-2 text-center">Longitude</th>
                                   <th className="p-2 text-center">X (m)</th>
                                   <th className="p-2 text-center">Y (m)</th>
                               </tr>
                            </thead>
                            <tbody>
                                {(() => {
                                    const origin = surveyUnitLayer ? { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng } : null;
                                    // Use state for rendering table
                                    const sortedPoints = [...plottedPoints].sort((a, b) => {
                                        const aIsBiased = a.type === 'Biased';
                                        const bIsBiased = b.type === 'Biased';
                                        if (aIsBiased && !bIsBiased) return -1;
                                        if (!aIsBiased && bIsBiased) return 1;
                                        const aNum = parseInt(a.id.split('-')[1]);
                                        const bNum = parseInt(b.id.split('-')[1]);
                                        return aNum - bNum;
                                    });
                                    return sortedPoints.map((point) => {
                                        let xDist = 'N/A', yDist = 'N/A';
                                        if (origin) {
                                            yDist = calculateDistance(origin, { lat: point.lat, lng: origin.lng }).toFixed(3);
                                            xDist = calculateDistance(origin, { lat: origin.lat, lng: point.lng }).toFixed(3);
                                        }
                                        return (
                                            <tr key={point.id} className="border-b border-slate-200 dark:border-slate-700">
                                                <td className="p-2 font-medium">{point.id}</td>
                                                <td className="p-2">{point.type}</td>
                                                <td className="p-2 font-mono">{point.lat.toFixed(7)}</td>
                                                <td className="p-2 font-mono">{point.lng.toFixed(7)}</td>
                                                <td className="p-2 font-mono">{xDist}</td>
                                                <td className="p-2 font-mono">{yDist}</td>
                                            </tr>
                                        );
                                    });
                                })()}
                            </tbody>
                            <tfoot>
                                {(() => {
                                    const origin = surveyUnitLayer ? { lat: surveyUnitLayer.getBounds().getSouthWest().lat, lng: surveyUnitLayer.getBounds().getSouthWest().lng } : null;
                                    if (!origin) return null;
                                    return ( <tr className="bg-slate-200 dark:bg-slate-700 font-semibold border-t-2 border-slate-300 dark:border-slate-600"><td colSpan="2" className="p-2 text-left">Origin (SW Corner)</td><td className="p-2 font-mono">{origin.lat.toFixed(7)}</td><td className="p-2 font-mono">{origin.lng.toFixed(7)}</td><td className="p-2 font-mono">0.000</td><td className="p-2 font-mono">0.000</td></tr> );
                                })()}
                            </tfoot>
                        </table>
                        </div>
                    ) : ( <p className="text-center text-slate-500 dark:text-slate-400 py-4">No sample points have been placed.</p> )}
                </div>
            </div>
        </div>
    );
};
         
              /**
              * @description React component for the MARSSIM Sample Design Suite.
              * This component acts as a container for two main functionalities:
              * 1.  **Sample Size Calculator:** Calculates the number of samples required based on MARSSIM methodology.
              * 2.  **Survey Unit Drawing Tool:** Provides a user interface for drawing survey units and sample locations.
              *
              * It manages the active module state ('calculator' or 'drawing') and conditionally renders the corresponding
              * sub-component (`MARSSIM_SampleCalculator` or `DrawingTool`) based on user selection.
              */
              
const MARSSIM_SampleDesign = () => {
    const [activeModule, setActiveModule] = React.useState('calculator');
    //  Shared state to hold the calculated N
    const [transferredSamples, setTransferredSamples] = React.useState(null);

    //  Handler to receive N and switch tabs
    const handleTransferN = (n) => {
        setTransferredSamples(n);
        setActiveModule('drawing');
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white">MARSSIM Sample Design Suite</h2>
                
                {/* Navigation Tabs */}
                <div className="flex w-full p-1 my-4 bg-slate-200 dark:bg-slate-700 rounded-lg">
                    <button 
                        onClick={() => setActiveModule('calculator')}
                        className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${
                            activeModule === 'calculator' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'
                        }`}
                    >
                        1. Calculate Number of Samples
                    </button>
                    <button 
                        onClick={() => setActiveModule('drawing')}
                        className={`w-1/2 p-2 rounded-md text-sm font-semibold transition-colors ${
                            activeModule === 'drawing' ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'
                        }`}
                    >
                        2. Draw Survey Unit
                    </button>
                </div>

                {/* Content Area */}
                <div>
                    <div style={{ display: activeModule === 'calculator' ? 'block' : 'none' }}>
                        {/* PASS the handler down */}
                        <MARSSIM_SampleCalculator onTransferResults={handleTransferN} />
                    </div>
                    <div style={{ display: activeModule === 'drawing' ? 'block' : 'none' }}>
                        {/* PASS the data down */}
                        <DrawingTool 
                            isVisible={activeModule === 'drawing'} 
                            importedSamples={transferredSamples} 
                        />
                    </div>
                </div>
            </div>
        </div>
    );
};

// This component provides a user interface for performing two statistical tests from the Multi-Agency Radiation Survey and Site Investigation Manual (MARSSIM): the Wilcoxon Rank Sum (WRS) test for survey units and the Elevated Measurement Comparison (EMC) Sign Test for localized areas.
              
// 1. : Parent Component
const MARSSIM_Statistical_Tests = () => {
    const TEST_WRS = 'wrs';
    const TEST_SIGN = 'sign';
    const TEST_EMC_EVAL = 'emc_eval'; // New Tab ID
    const [activeTest, setActiveTest] = React.useState(TEST_WRS);

    // WRS State
    const [wrs_dcgl, setWrs_dcgl] = React.useState(() => localStorage.getItem('wrs_dcgl') || '5');
    const [wrs_referenceData, setWrs_referenceData] = React.useState(() => localStorage.getItem('wrs_referenceData') || '1.6\n1.2\n1.4\n1.2\n0.5\n1.5\n0.8\n1.1\n1.9\n1.7\n1.8\n1.8\n1.7\n1.9\n2.1\n1.8\n2.1\n2.4\n2.2\n2.9\n2\n1.7\n2.3\n1.1\n2.3\n0.6\n1.1\n1.1\n1.4\n2.1');
    const [wrs_surveyData, setWrs_surveyData] = React.useState(() => localStorage.getItem('wrs_surveyData') || '2.928\n3.458\n3.31\n3.198\n2.218\n6.827\n2.269\n4.96\n2.766\n3.29\n10.833\n1.606\n1.856\n3.135\n1.808\n1.873\n3.373\n1.887\n1.457\n5.5\n1.973\n1.915\n2.205\n1.814\n3.7\n2.327\n1.919\n2.677\n3.253\n1.776\n5.201\n4.737\n2.585');
    const [wrs_alpha, setWrs_alpha] = React.useState(() => localStorage.getItem('wrs_alpha') || '0.05');
    const [wrs_result, setWrs_result] = React.useState(null);
    const [wrs_error, setWrs_error] = React.useState('');

    // Sign Test State
    const [sign_dcgl, setSign_dcgl] = React.useState(() => localStorage.getItem('sign_dcgl') || '100');
    const [sign_data, setSign_data] = React.useState(() => localStorage.getItem('sign_data') || '120, 90, 95, 80, 85, 110, 95, 70');
    const [sign_alpha, setSign_alpha] = React.useState(() => localStorage.getItem('sign_alpha') || '0.05');
    const [sign_result, setSign_result] = React.useState(null);
    const [sign_error, setSign_error] = React.useState('');

    // NEW: EMC Evaluation State
    const [emc_dcglw, setEmc_dcglw] = React.useState(() => localStorage.getItem('emcEval_dcglw') || '100');
    const [emc_areaFactor, setEmc_areaFactor] = React.useState(() => localStorage.getItem('emcEval_areaFactor') || '3.0');
    const [emc_avgConc, setEmc_avgConc] = React.useState(() => localStorage.getItem('emcEval_avgConc') || '40');
    const [emc_maxConc, setEmc_maxConc] = React.useState(() => localStorage.getItem('emcEval_maxConc') || '150');
    const [emc_result, setEmc_result] = React.useState(null);
    const [emc_error, setEmc_error] = React.useState('');

    const handleClearActiveCalculator = () => {
        if (activeTest === TEST_WRS) {
            setWrs_dcgl('5'); setWrs_referenceData(''); setWrs_surveyData(''); setWrs_result(null); setWrs_error('');
            ['wrs_dcgl', 'wrs_referenceData', 'wrs_surveyData', 'wrs_alpha'].forEach(k => localStorage.removeItem(k));
        } else if (activeTest === TEST_SIGN) {
            setSign_dcgl('100'); setSign_data(''); setSign_result(null); setSign_error('');
            ['sign_dcgl', 'sign_data', 'sign_alpha'].forEach(k => localStorage.removeItem(k));
        } else {
            // Clear EMC
            setEmc_dcglw('100'); setEmc_areaFactor('3.0'); setEmc_avgConc('40'); setEmc_maxConc('150'); setEmc_result(null); setEmc_error('');
            ['emcEval_dcglw', 'emcEval_areaFactor', 'emcEval_avgConc', 'emcEval_maxConc'].forEach(k => localStorage.removeItem(k));
        }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-2xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">MARSSIM Statistical Tests</h2>
                    <ClearButton onClick={handleClearActiveCalculator} />
                </div>
                
                {/* 3-Button Navigation */}
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-4">
                    <button onClick={() => setActiveTest(TEST_WRS)} className={`flex-1 p-2 rounded-md text-xs sm:text-sm font-semibold transition-colors ${activeTest === TEST_WRS ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>WRS Test</button>
                    <button onClick={() => setActiveTest(TEST_SIGN)} className={`flex-1 p-2 rounded-md text-xs sm:text-sm font-semibold transition-colors ${activeTest === TEST_SIGN ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>Sign Test</button>
                    <button onClick={() => setActiveTest(TEST_EMC_EVAL)} className={`flex-1 p-2 rounded-md text-xs sm:text-sm font-semibold transition-colors ${activeTest === TEST_EMC_EVAL ? 'bg-white dark:bg-slate-800 text-sky-600' : 'text-slate-600 dark:text-slate-300'}`}>EMC Eval</button>
                </div>

                {activeTest === TEST_WRS && (
                    <WRS_Calculator 
                        dcgl={wrs_dcgl} setDcgl={setWrs_dcgl}
                        referenceData={wrs_referenceData} setReferenceData={setWrs_referenceData}
                        surveyData={wrs_surveyData} setSurveyData={setWrs_surveyData}
                        alpha={wrs_alpha} setAlpha={setWrs_alpha}
                        result={wrs_result} setResult={setWrs_result}
                        error={wrs_error} setError={setWrs_error}
                    />
                )}
                {activeTest === TEST_SIGN && (
                    <SignTest_Calculator 
                        dcgl={sign_dcgl} setDcgl={setSign_dcgl}
                        dataInput={sign_data} setDataInput={setSign_data}
                        alpha={sign_alpha} setAlpha={setSign_alpha}
                        result={sign_result} setResult={setSign_result}
                        error={sign_error} setError={setSign_error}
                    />
                )}
                {activeTest === TEST_EMC_EVAL && (
                    <EMC_Evaluation_Calculator
                        dcglw={emc_dcglw} setDcglw={setEmc_dcglw}
                        areaFactor={emc_areaFactor} setAreaFactor={setEmc_areaFactor}
                        avgConc={emc_avgConc} setAvgConc={setEmc_avgConc}
                        maxConc={emc_maxConc} setMaxConc={setEmc_maxConc}
                        result={emc_result} setResult={setEmc_result}
                        error={emc_error} setError={setEmc_error}
                    />
                )}
            </div>
        </div>
    );
};

// 2. UPDATED: WRS Calculator (Fixed "Gross vs Net" logic)
const WRS_Calculator = ({ dcgl, setDcgl, referenceData, setReferenceData, surveyData, setSurveyData, alpha, setAlpha, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    // Kept existing criticalValueTable and zScores for brevity...
    const criticalValueTable = { '0.05': { '5': { '5': 28, '6': 32, '7': 36, '8': 41, '9': 45, '10': 50 }, '6': { '5': 33, '6': 38, '7': 43, '8': 48, '9': 53, '10': 59 }, '7': { '5': 37, '6': 43, '7': 49, '8': 54, '9': 60, '10': 66 }, '8': { '5': 42, '6': 49, '7': 55, '8': 61, '9': 67, '10': 74 }, '9': { '5': 46, '6': 54, '7': 61, '8': 68, '9': 75, '10': 82 }, '10': { '5': 51, '6': 59, '7': 67, '8': 75, '9': 83, '10': 91 }, '11': { '11': 111, '12': 119, '13': 127, '14': 135, '15': 143 }, '12': { '12': 131, '13': 139, '14': 148, '15': 156, '16': 165 }, '13': { '13': 151, '14': 160, '15': 169, '16': 178, '17': 187 }, '14': { '14': 171, '15': 181, '16': 190, '17': 200, '18': 210 }, '15': { '15': 192, '16': 202, '17': 212, '18': 223, '19': 233 } } };
    const zScores = { '0.05': 1.645, '0.025': 1.960, '0.01': 2.326, '0.10': 1.282 };
    const resultStyles = { PASS: { container: 'bg-green-100 dark:bg-green-900/50', title: 'text-green-600 dark:text-green-400', text: 'text-green-800 dark:text-green-200', display: 'SURVEY UNIT PASSES' }, FAIL: { container: 'bg-red-100 dark:bg-red-900/50', title: 'text-red-600 dark:text-red-400', text: 'text-red-800 dark:text-red-200', display: 'SURVEY UNIT FAILS' } };

    // New Helper for Stats
    const getStats = (data) => {
        if (!data || data.length === 0) return null;
        const sum = data.reduce((a, b) => a + b, 0);
        const mean = sum / data.length;
        const max = Math.max(...data);
        const min = Math.min(...data);
        // Standard Deviation
        const sqDiff = data.map(v => Math.pow(v - mean, 2));
        const avgSqDiff = sqDiff.reduce((a, b) => a + b, 0) / (data.length - 1); // Sample SD
        const sd = Math.sqrt(avgSqDiff);
        return { mean, max, min, sd };
    };

    const parseData = (dataString) => dataString.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);

    const handleCalculate = () => {
        setResult(null); setError('');
        const refData = parseData(referenceData); 
        const suData = parseData(surveyData); 
        const dcgl_val = parseFloat(dcgl);
        
        if (isNaN(dcgl_val)) { setError('DCGL must be a valid number.'); return; }
        
        // --- 1. BUG FIX: Small Sample Warning ---
        if (refData.length < 5 || suData.length < 5) { 
            setError('At least 5 data points are required for each area to perform a valid WRS test.'); 
            return; 
        }

        let combined = [...refData.map(v => ({ value: v + dcgl_val, group: 'ref' })), ...suData.map(v => ({ value: v, group: 'su' }))].sort((a, b) => a.value - b.value);
        
        // Handle Ties
        for (let i = 0; i < combined.length; i++) {
            let ties = [i]; const epsilon = 1e-9;
            while (i + 1 < combined.length && Math.abs(combined[i].value - combined[i + 1].value) < epsilon) { i++; ties.push(i); }
            if (ties.length > 1) { const avgRank = (ties[0] + 1 + ties[ties.length - 1] + 1) / 2; ties.forEach(index => { combined[index].rank = avgRank; }); } else { combined[i].rank = i + 1; }
        }
        
        const W_rs = combined.filter(d => d.group === 'ref').reduce((sum, d) => sum + d.rank, 0);
        const n = refData.length; const m = suData.length; 
        let C_w;
        
        const tableVal = criticalValueTable[alpha]?.[n]?.[m] || criticalValueTable[alpha]?.[m]?.[n]; 
        
        if (tableVal) { 
            C_w = tableVal; 
        } else {
            // Large Sample Approx
            const zAlpha = zScores[alpha]; const N = n + m; const mean_W = (n * (N + 1)) / 2; const tieGroups = {};
            combined.forEach(item => { tieGroups[item.value] = (tieGroups[item.value] || 0) + 1; });
            const tieCorrection = Object.values(tieGroups).filter(t => t > 1).reduce((sum, t) => sum + (Math.pow(t, 3) - t), 0);
            const variance_W = ((n * m * (N + 1)) / 12) - ((n * m * tieCorrection) / (12 * N * (N - 1)));
            const stdDev_W_corrected = Math.sqrt(variance_W); C_w = Math.round(mean_W + (zAlpha * stdDev_W_corrected) + 0.5);
        }
        
        const wrsTestPassed = W_rs >= C_w; 
        const finalConclusion = wrsTestPassed ? 'PASS' : 'FAIL';
        const finalReason = wrsTestPassed 
            ? `The sum of reference ranks (${W_rs}) is ≥ the critical value (${C_w}). The Survey Unit is effectively cleaner than Reference + DCGL.`
            : `The sum of reference ranks (${W_rs}) is < the critical value (${C_w}). The Survey Unit exceeds the release criterion.`;

        const hotMeasurements = suData.filter(v => v > dcgl_val);

        setResult({ 
            conclusion: finalConclusion, 
            reason: finalReason, 
            n, m, W_rs, C_w, 
            rankedData: combined, 
            hotCount: hotMeasurements.length,
            // --- 2. EASY WIN: Pass Stats ---
            refStats: getStats(refData),
            suStats: getStats(suData)
        });
    };

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'WRS Test', icon: ICONS.labStats, inputs: `Ref(n)=${result.n}, SU(m)=${result.m}`, result: result.conclusion, view: VIEWS.MARSSIM_TESTS });
            addToast("Calculation saved to history!");
        }
    };

    React.useEffect(() => { handleCalculate(); }, [dcgl, referenceData, surveyData, alpha]);

    return (
        <div className="space-y-4">
             <div className="p-4 bg-sky-50 dark:bg-sky-900/20 border border-sky-200 dark:border-sky-800 rounded-lg text-sm text-sky-800 dark:text-sky-200">
                <strong>Applicability:</strong> Use WRS when the contaminant <em>is</em> present in background (Class 1, 2, or 3).
                <br/><span className="text-xs mt-1 block">Note: Inputs should generally be <strong>Gross</strong> measurements (not background subtracted). The test handles the subtraction statistically.</span>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                  <div className="flex justify-between items-center"><label className="block text-sm font-medium">Reference Area Data (n)</label><button onClick={() => setReferenceData('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
                  <textarea value={referenceData} onChange={e => setReferenceData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste gross values..."></textarea>
                  {result && result.refStats && (
                      <p className="text-xs text-slate-500 mt-1 font-mono">
                          Count: {result.n} | Mean: {result.refStats.mean.toFixed(2)} | Max: {result.refStats.max}
                      </p>
                  )}
              </div>
              <div>
                  <div className="flex justify-between items-center"><label className="block text-sm font-medium">Survey Unit Data (m)</label><button onClick={() => setSurveyData('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
                  <textarea value={surveyData} onChange={e => setSurveyData(e.target.value)} rows="8" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste gross values..."></textarea>
                  {result && result.suStats && (
                      <p className="text-xs text-slate-500 mt-1 font-mono">
                          Count: {result.m} | Mean: {result.suStats.mean.toFixed(2)} | Max: {result.suStats.max}
                      </p>
                  )}
              </div>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div><label className="block text-sm font-medium">DCGL<sub>W</sub> (Net Limit)</label><input type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
              <div><label className="block text-sm font-medium">Significance Level (&alpha;)</label><select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="0.05">0.05</option><option value="0.025">0.025</option><option value="0.01">0.01</option><option value="0.10">0.10</option></select></div>
            </div>
            <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Save to Calculations</button>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
              <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${resultStyles[result.conclusion].container}`}>
                  <p className={`text-3xl font-extrabold ${resultStyles[result.conclusion].title}`}>{resultStyles[result.conclusion].display}</p>
                  <p className={`mt-2 text-sm ${resultStyles[result.conclusion].text}`}>{result.reason}</p>
                  
                  {result.hotCount > 0 && result.conclusion === 'PASS' && (
                      <div className="mt-3 p-2 bg-amber-100 dark:bg-amber-900/50 rounded text-amber-800 dark:text-amber-200 text-xs font-semibold">
                          ⚠️ {result.hotCount} measurements exceed the DCGL. Ensure these do not exceed Background + DCGL<sub>EMC</sub>.
                      </div>
                  )}

                  <details className="mt-4 text-left text-xs"><summary className="cursor-pointer font-semibold">Show Ranked Data Table</summary><div className="mt-2 max-h-48 overflow-y-auto bg-white dark:bg-slate-800 p-2 rounded"><table className="w-full"><thead><tr className="font-bold"><td className="p-1">Value</td><td className="p-1">Group</td><td className="p-1">Rank</td></tr></thead><tbody>{result.rankedData.map((item, i) => (<tr key={i} className={item.group === 'ref' ? 'text-sky-600 dark:text-sky-400' : ''}><td className="p-1 font-mono">{item.value.toFixed(3)}</td><td className="p-1">{item.group.toUpperCase()}</td><td className="p-1">{item.rank}</td></tr>))}</tbody></table></div></details>
                  <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                      <p>Rank Sum (W&darr;rs): <span className="font-bold">{result.W_rs}</span></p><p>Critical Value (C&darr;w): <span className="font-bold">{result.C_w}</span></p>
                  </div>
              </div>
            )}
        </div>
    );
};

// 3. UPDATED: Sign Test Calculator (Formerly EMC)
const SignTest_Calculator = ({ dcgl, setDcgl, dataInput, setDataInput, alpha, setAlpha, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    const signTestCriticalValues = { '0.05': { 5: 5, 6: 6, 7: 7, 8: 7, 9: 8, 10: 8, 11: 9, 12: 10, 13: 11, 14: 11, 15: 12, 16: 12, 17: 13, 18: 14, 19: 14, 20: 15, 21: 16, 22: 16, 23: 17, 24: 17, 25: 18, 26: 19, 27: 19, 28: 20, 29: 21, 30: 21 }, '0.025': { 5: 5, 6: 6, 7: 7, 8: 8, 9: 8, 10: 9, 11: 10, 12: 10, 13: 11, 14: 12, 15: 12, 16: 13, 17: 14, 18: 14, 19: 15, 20: 15, 21: 16, 22: 17, 23: 17, 24: 18, 25: 19, 26: 19, 27: 20, 28: 20, 29: 21, 30: 22 }, '0.01': { 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 9, 11: 10, 12: 11, 13: 11, 14: 12, 15: 13, 16: 13, 17: 14, 18: 15, 19: 15, 20: 16, 21: 17, 22: 17, 23: 18, 24: 18, 25: 19, 26: 20, 27: 20, 28: 21, 29: 22, 30: 22 }, '0.10': { 5: 4, 6: 5, 7: 6, 8: 6, 9: 7, 10: 8, 11: 8, 12: 9, 13: 10, 14: 10, 15: 11, 16: 11, 17: 12, 18: 13, 19: 13, 20: 14, 21: 15, 22: 15, 23: 16, 24: 16, 25: 17, 26: 18, 27: 18, 28: 19, 29: 20, 30: 20 } };
    const zScores = { '0.05': 1.645, '0.025': 1.960, '0.01': 2.326, '0.10': 1.282 };

    React.useEffect(() => {
        localStorage.setItem('sign_dcgl', dcgl);
        localStorage.setItem('sign_data', dataInput);
        localStorage.setItem('sign_alpha', alpha);
    }, [dcgl, dataInput, alpha]);

    const parseData = (dataString) => dataString.split(/[\s,;\n]+/).filter(d => d.trim() !== '' && !isNaN(d)).map(Number);

    const handleCalculate = () => {
        setResult(null); setError('');
        const measurements = parseData(dataInput); 
        const dcgl_val = parseFloat(dcgl);
        
        if (isNaN(dcgl_val) || dcgl_val <= 0) { setError('DCGL must be a valid positive number.'); return; }
        if (measurements.length === 0) { setError('Please enter measurement data.'); return; }
        
        // Effective N (discard ties where measurement == DCGL)
        const epsilon = 1e-9;
        const validData = measurements.filter(val => Math.abs(dcgl_val - val) > epsilon); 
        const n_adjusted = validData.length;
        const ties = measurements.length - n_adjusted;

        if (n_adjusted === 0) { setError('All data points are equal to the DCGL; the test cannot be performed.'); return; }

        // S+ = Number of measurements LESS than DCGL (Passed measurements)
        // Sign test logic: Difference = DCGL - Measurement. If Diff > 0, it's a "success".
        const S_plus = validData.filter(val => (dcgl_val - val) > 0).length;

        let Cs; let note = '';
        const tableValue = signTestCriticalValues[alpha]?.[n_adjusted];
        
        if (tableValue !== undefined) { 
            Cs = tableValue; 
            note = `Used MARSSIM Table I.3 for N=${n_adjusted}.`; 
        } else {
            const zAlpha = zScores[alpha];
            // Large sample approximation for k (Critical Value)
            // k = 0.5N + 0.5*sqrt(N)*z
            // Note: This is for "how many successes do we need?"
            // Ideally we use: k = (N - 1)/2 + 0.5 + (Z * sqrt(N))/2 -- Wait, let's stick to the code's previous approx which is standard.
            Cs = Math.ceil((n_adjusted / 2) - 0.5 - (zAlpha * Math.sqrt(n_adjusted) / 2)); 
            // Wait, standard approx is N/2 + Z*sqrt(N)/2. 
            // The formula in previous code: ceil(N/2 - 0.5 - ...) looked like it was calculating the *rejection* region for the other tail?
            // MARSSIM Eq I.2: k = N/2 + Z/2 * sqrt(N).
            Cs = Math.ceil((n_adjusted / 2) + (zAlpha * Math.sqrt(n_adjusted) / 2));
            note = `Used Large Sample Approximation for N=${n_adjusted}.`;
        }

        const testPassed = S_plus >= Cs;
        const newResult = { 
            conclusion: testPassed ? 'PASS' : 'FAIL', 
            reason: `The number of data points below the DCGL (S+) is ${S_plus}, which is ${testPassed ? 'greater than or equal to' : 'less than'} the critical value (${Cs}).`, 
            n: measurements.length, 
            n_adjusted, 
            ties, 
            S_plus, 
            Cs, 
            note 
        };
        setResult(newResult);
    };

    const handleSaveToHistory = () => {
        if (result) {
           addHistory({
               id: Date.now(),
               type: 'Sign Test',
               icon: ICONS.labStats,
               inputs: `N=${result.n}, DCGL=${dcgl}`,
               result: `UNIT ${result.conclusion}ES`,
               view: VIEWS.MARSSIM_TESTS
           });
           addToast("Calculation saved to history!");
        }
    };

    React.useEffect(() => { handleCalculate(); }, [dcgl, dataInput, alpha]);

    return (
        <div className="space-y-4">
             <div className="p-4 bg-sky-50 dark:bg-sky-900/20 border border-sky-200 dark:border-sky-800 rounded-lg text-sm text-sky-800 dark:text-sky-200">
                <strong>Applicability:</strong> Use the Sign Test when the contaminant is <em>not</em> present in background (Class 1, 2, or 3). It compares survey data directly against the DCGL.
            </div>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
              <div><label htmlFor="sign-dcgl" className="block text-sm font-medium">DCGL</label><input id="sign-dcgl" type="number" value={dcgl} onChange={e => setDcgl(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
              <div>
                 <div className="flex justify-between items-center"><label htmlFor="sign-data" className="block text-sm font-medium">Survey Unit Measurements</label><button onClick={() => setDataInput('')} className="text-xs text-sky-600 dark:text-sky-400 hover:underline font-semibold">Clear</button></div>
                 <textarea id="sign-data" value={dataInput} onChange={e => setDataInput(e.target.value)} rows="6" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste comma, space, or newline separated values..."></textarea>
                 <p className="text-right text-xs font-semibold text-slate-500 dark:text-slate-400 mt-1 pr-1">Samples (N): {parseData(dataInput).length}</p>
              </div>
              <div><label htmlFor="sign-alpha" className="block text-sm font-medium">Significance Level (&alpha;)</label><select id="sign-alpha" value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="0.05">0.05</option><option value="0.025">0.025</option><option value="0.01">0.01</option><option value="0.10">0.10</option></select></div>
            </div>
            <button onClick={handleSaveToHistory} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">Save to Calculations</button>
            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
            {result && (
              <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${result.conclusion === 'PASS' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                  <p className={`text-3xl font-extrabold ${result.conclusion === 'PASS' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>UNIT {result.conclusion}ES</p>
                  <p className={`mt-2 text-sm ${result.conclusion === 'PASS' ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}`}>{result.reason}</p>
                  <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 grid grid-cols-2 gap-2 text-sm">
                      <p>Samples (N): <span className="font-bold">{result.n}</span></p><p>Adjusted N': <span className="font-bold">{result.n_adjusted}</span></p>
                      <p>Points &lt; DCGL (S+): <span className="font-bold">{result.S_plus}</span></p><p>Critical Value (Cs): <span className="font-bold">{result.Cs}</span></p>
                  </div>
                   <p className="text-xs italic text-slate-500 dark:text-slate-400 mt-3">{result.note}</p>
              </div>
            )}
        </div>
    );
};   

const EMC_Evaluation_Calculator = ({ dcglw, setDcglw, areaFactor, setAreaFactor, avgConc, setAvgConc, maxConc, setMaxConc, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    // Persist state
    React.useEffect(() => {
        localStorage.setItem('emcEval_dcglw', dcglw);
        localStorage.setItem('emcEval_areaFactor', areaFactor);
        localStorage.setItem('emcEval_avgConc', avgConc);
        localStorage.setItem('emcEval_maxConc', maxConc);
    }, [dcglw, areaFactor, avgConc, maxConc]);

    const handleCalculate = () => {
        setResult(null); setError('');
        const dcgl = parseFloat(dcglw);
        const af = parseFloat(areaFactor);
        const average = parseFloat(avgConc);
        const maximum = parseFloat(maxConc);

        if ([dcgl, af, average, maximum].some(isNaN) || dcgl <= 0 || af < 1 || average < 0 || maximum < 0) {
            setError('Please enter valid, positive numbers. Area Factor must be ≥ 1.');
            return;
        }

        if (maximum < average) {
            setError('Maximum concentration cannot be less than the average.');
            return;
        }

        // 1. Calculate DCGL_emc
        const dcgl_emc = dcgl * af;

        // 2. Calculate Terms
        // Term 1: Contribution from general area (Average / DCGLw)
        const term1 = average / dcgl;
        
        // Term 2: Contribution from Hot Spot ((Max - Avg) / DCGL_emc)
        // Note: The hot spot is "elevated" above the average local background
        const delta = maximum - average;
        const term2 = delta / dcgl_emc;

        // 3. Unity Rule
        const unityValue = term1 + term2;
        const pass = unityValue <= 1;

        setResult({
            dcgl_emc: dcgl_emc.toPrecision(4),
            term1: term1.toFixed(3),
            term2: term2.toFixed(3),
            delta: delta.toPrecision(4),
            unityValue: unityValue.toFixed(3),
            pass
        });
    };

    const handleSaveToHistory = () => {
        if (result) {
            addHistory({
                id: Date.now(),
                type: 'EMC Evaluation',
                icon: ICONS.labStats,
                inputs: `AF=${areaFactor}, Max=${maxConc}`,
                result: result.pass ? 'PASS' : 'FAIL',
                view: VIEWS.MARSSIM_TESTS
            });
            addToast("Calculation saved to history!");
        }
    };

    // Auto-calculate on change
    React.useEffect(() => {
        if (dcglw && areaFactor && avgConc && maxConc) handleCalculate();
    }, [dcglw, areaFactor, avgConc, maxConc]);

    return (
        <div className="space-y-4">
             <div className="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg text-sm text-amber-800 dark:text-amber-200">
                <strong>Applicability:</strong> Use this to evaluate specific "hot spots" found during scanning. It ensures that small areas of elevated activity do not exceed the dose limit when averaged with the general area.
            </div>
            
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium">DCGL<sub>W</sub></label>
                        <input type="number" value={dcglw} onChange={e => setDcglw(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" placeholder="Wide Area Limit" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Area Factor (AF)</label>
                        <input type="number" value={areaFactor} onChange={e => setAreaFactor(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" placeholder="e.g., 3.0" />
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium">Average Conc.</label>
                        <input type="number" value={avgConc} onChange={e => setAvgConc(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" placeholder="Survey Unit Average" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Max Conc.</label>
                        <input type="number" value={maxConc} onChange={e => setMaxConc(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700" placeholder="Hot Spot Value" />
                    </div>
                </div>
            </div>

            <button onClick={handleSaveToHistory} disabled={!result} className="w-full py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition disabled:opacity-50">Save to Calculations</button>

            {error && <p className="text-red-500 text-sm text-center">{error}</p>}

            {result && (
                <div className={`p-4 rounded-lg mt-4 text-center animate-fade-in ${result.pass ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                    <p className={`text-3xl font-extrabold ${result.pass ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                        HOT SPOT {result.pass ? 'PASSES' : 'FAILS'}
                    </p>
                    <p className={`mt-1 font-semibold ${result.pass ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}`}>
                        Unity Value: {result.unityValue}
                    </p>
                    
                    <div className="mt-4 pt-4 border-t border-slate-300 dark:border-slate-600 text-sm text-left grid grid-cols-2 gap-2">
                        <div className="col-span-2 text-center mb-2 font-mono text-xs text-slate-500 dark:text-slate-400">
                             Formula: (Avg / DCGLw) + ((Max - Avg) / (DCGLw * AF)) ≤ 1
                        </div>
                        <p>DCGL<sub>EMC</sub>: <span className="font-mono font-bold float-right">{result.dcgl_emc}</span></p>
                        <p>Difference (δ): <span className="font-mono font-bold float-right">{result.delta}</span></p>
                        
                        <p className="border-t border-slate-300 dark:border-slate-600 pt-1 mt-1">General Area Term:</p>
                        <p className="border-t border-slate-300 dark:border-slate-600 pt-1 mt-1 font-mono font-bold text-right">{result.term1}</p>
                        
                        <p className="border-t border-slate-300 dark:border-slate-600 pt-1 mt-1">Hot Spot Term:</p>
                        <p className="border-t border-slate-300 dark:border-slate-600 pt-1 mt-1 font-mono font-bold text-right">{result.term2}</p>
                    </div>
                </div>
            )}
        </div>
    );
};

// 1. NEW: MDA Calculator (Currie Equation)
const MdaCalculator = ({ bkgCounts, setBkgCounts, countTime, setCountTime, bkgTime, setBkgTime, efficiency, setEfficiency, effUnit, setEffUnit, probeArea, setProbeArea, result, setResult }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();

    React.useEffect(() => {
        try {
            const Rb = parseFloat(bkgCounts) / parseFloat(bkgTime); // Rate Bkg
            const Ts = parseFloat(countTime);
            const Tb = parseFloat(bkgTime);
            const effVal = parseFloat(efficiency);
            const area = parseFloat(probeArea);

            if (isNaN(Rb) || isNaN(Ts) || isNaN(Tb) || isNaN(effVal) || Ts <= 0 || Tb <= 0) { setResult(null); return; }

            // Efficiency -> Decimal
            const effDec = effUnit === '%' ? effVal / 100 : effVal;
            if (effDec <= 0) { setResult(null); return; }

            // Currie Equation (Paired vs Unpaired)
            // Lc = Critical Level (Is it real?)
            // Ld = Detection Limit (Can I see it?)
            let Lc, Ld;

            if (Math.abs(Ts - Tb) < 0.01) {
                // Paired Observations (Ts = Tb) -> Simplified Currie
                // Ld = 2.71 + 4.65 * sqrt(BkgCounts)
                const B = Rb * Tb;
                Lc = 2.33 * Math.sqrt(B);
                Ld = 2.71 + 4.65 * Math.sqrt(B);
            } else {
                // Unpaired (Different times) -> NUREG-1507 exact formulation
                // Ld (rate) = (2.71/Ts) + 3.29 * sqrt( Rb * (1/Ts + 1/Tb) )
                const term1 = 2.71 / Ts;
                const term2 = 3.29 * Math.sqrt(Rb * (1/Ts + 1/Tb));
                const Ld_rate = term1 + term2;
                Ld = Ld_rate * Ts; // Convert back to counts for display consistency
                
                // Lc (rate) = 1.645 * sqrt( Rb * (1/Ts + 1/Tb) )
                const Lc_rate = 1.645 * Math.sqrt(Rb * (1/Ts + 1/Tb));
                Lc = Lc_rate * Ts;
            }

            // Calculate MDA (Activity)
            // MDA = Ld / (T * Eff * Yield * 2.22) -> Yield assumed 1 for now
            // Result in dpm = Ld / (T * Eff) if T is min
            const Ld_rate_cpm = Ld / Ts;
            const mda_dpm = Ld_rate_cpm / effDec;
            const mda_pCi = mda_dpm / 2.22;
            const mdc_dpm_100cm2 = (mda_dpm / area) * 100;

            setResult({ Lc: Math.round(Lc), Ld: Math.round(Ld), mda_dpm, mda_pCi, mdc: mdc_dpm_100cm2 });

        } catch (e) { setResult(null); }
    }, [bkgCounts, countTime, bkgTime, efficiency, effUnit, probeArea]);

    const handleSave = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'MDA Calc', icon: ICONS.microscope, inputs: `Bkg: ${bkgCounts}c/${bkgTime}m`, result: `MDA: ${result.mda_dpm.toFixed(1)} dpm`, view: VIEWS.LAB_STATS });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <ContextualNote type="info"><strong>Currie Equation:</strong> Calculates the <i>a priori</i> detection limit (Ld) ensuring 95% confidence of detection.</ContextualNote>
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium">Bkg Counts</label><input type="number" value={bkgCounts} onChange={e => setBkgCounts(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div><label className="block text-sm font-medium">Bkg Time (min)</label><input type="number" value={bkgTime} onChange={e => setBkgTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium">Sample Time (min)</label><input type="number" value={countTime} onChange={e => setCountTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                    <div>
                        <label className="block text-sm font-medium">Efficiency</label>
                        <div className="flex">
                            <input type="number" value={efficiency} onChange={e => setEfficiency(e.target.value)} className="w-full mt-1 p-2 rounded-l-md bg-slate-100 dark:bg-slate-700"/>
                            <select value={effUnit} onChange={e => setEffUnit(e.target.value)} className="mt-1 p-2 rounded-r-md bg-slate-200 dark:bg-slate-600 text-xs"><option>%</option><option>dec</option></select>
                        </div>
                    </div>
                </div>
                <div><label className="block text-sm font-medium">Probe Area (cm²) <span className="text-xs text-slate-400 font-normal">(For MDC)</span></label><input type="number" value={probeArea} onChange={e => setProbeArea(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
            </div>

            {result && (
                <div className="mt-4 p-5 bg-slate-100 dark:bg-slate-700 rounded-lg animate-fade-in shadow-sm">
                    <div className="flex justify-end -mt-3 -mr-3 mb-2"><button onClick={handleSave} className="text-slate-400 hover:text-sky-600"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></div>
                    
                    <div className="text-center mb-4">
                        <p className="text-xs uppercase font-bold text-slate-500">Minimum Detectable Activity</p>
                        <div className="flex items-center justify-center gap-2">
                            <span className="text-3xl font-extrabold text-sky-600 dark:text-sky-400">{result.mda_dpm.toFixed(1)}</span>
                            <span className="text-lg font-semibold text-slate-600 dark:text-slate-300">dpm</span>
                        </div>
                        <p className="text-xs text-slate-500">({result.mda_pCi.toFixed(2)} pCi)</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4 text-center border-t border-slate-200 dark:border-slate-600 pt-4">
                        <div>
                            <p className="text-xs text-slate-500">Critical Level (Lc)</p>
                            <p className="font-mono font-bold">{result.Lc} counts</p>
                        </div>
                        <div>
                            <p className="text-xs text-slate-500">Detection Limit (Ld)</p>
                            <p className="font-mono font-bold">{result.Ld} counts</p>
                        </div>
                    </div>
                    <div className="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600 text-center">
                        <p className="text-xs text-slate-500">Surface MDC</p>
                        <p className="font-bold text-slate-700 dark:text-slate-200">{result.mdc.toFixed(0)} dpm/100cm²</p>
                    </div>
                </div>
            )}
        </div>
    );
};

// 2. UPDATED: ChiSquaredCalculator (Visual Polish)
const ChiSquaredCalculator = ({ chiSquaredData, setChiSquaredData, alpha, setAlpha, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    // (Keep your existing CRITICAL_VALUES and UPPER_BOUNDS constants here...)
    const CHI_SQUARED_CRITICAL_VALUES = { '0.10': { lowerP: 0.05, upperP: 0.95, 1: 0.004, 2: 0.103, 3: 0.352, 4: 0.711, 5: 1.145, 6: 1.635, 7: 2.167, 8: 2.733, 9: 3.325, 10: 3.940, 11: 4.575, 12: 5.226, 13: 5.892, 14: 6.571, 15: 7.261, 16: 7.962, 17: 8.672, 18: 9.390, 19: 10.117, 20: 10.851, 21: 11.591, 22: 12.338, 23: 13.091, 24: 13.848, 25: 14.611, 26: 15.379, 27: 16.151, 28: 16.928, 29: 17.708, 30: 18.493, 40: 26.509 }, '0.05': { lowerP: 0.025, upperP: 0.975, 1: 0.001, 2: 0.051, 3: 0.216, 4: 0.484, 5: 0.831, 6: 1.237, 7: 1.690, 8: 2.180, 9: 2.700, 10: 3.247, 11: 3.816, 12: 4.404, 13: 5.009, 14: 5.629, 15: 6.262, 16: 6.908, 17: 7.564, 18: 8.231, 19: 8.907, 20: 9.591, 21: 10.283, 22: 10.982, 23: 11.689, 24: 12.401, 25: 13.120, 26: 13.844, 27: 14.573, 28: 15.308, 29: 16.047, 30: 16.791, 40: 24.433 }, '0.01': { lowerP: 0.005, upperP: 0.995, 1: 0.000, 2: 0.010, 3: 0.072, 4: 0.207, 5: 0.412, 6: 0.676, 7: 0.989, 8: 1.344, 9: 1.735, 10: 2.156, 11: 2.603, 12: 3.074, 13: 3.565, 14: 4.075, 15: 4.601, 16: 5.142, 17: 5.697, 18: 6.265, 19: 6.844, 20: 7.434, 21: 8.034, 22: 8.643, 23: 9.260, 24: 9.886, 25: 10.520, 26: 11.160, 27: 11.808, 28: 12.461, 29: 13.121, 30: 13.787, 40: 20.707 } };
    const UPPER_BOUNDS = { '0.10': { 1: 3.841, 2: 5.991, 3: 7.815, 4: 9.488, 5: 11.070, 6: 12.592, 7: 14.067, 8: 15.507, 9: 16.919, 10: 18.307, 11: 19.675, 12: 21.026, 13: 22.362, 14: 23.685, 15: 24.996, 16: 26.296, 17: 27.587, 18: 28.869, 19: 30.144, 20: 31.410, 21: 32.671, 22: 33.924, 23: 35.172, 24: 36.415, 25: 37.652, 26: 38.885, 27: 40.113, 28: 41.337, 29: 42.557, 30: 43.773, 40: 55.758 }, '0.05': { 1: 5.024, 2: 7.378, 3: 9.348, 4: 11.143, 5: 12.833, 6: 14.449, 7: 16.013, 8: 17.535, 9: 19.023, 10: 20.483, 11: 21.920, 12: 23.337, 13: 24.736, 14: 26.119, 15: 27.488, 16: 28.845, 17: 30.191, 18: 31.526, 19: 32.852, 20: 34.170, 21: 35.479, 22: 36.781, 23: 38.076, 24: 39.364, 25: 40.646, 26: 41.923, 27: 43.195, 28: 44.461, 29: 45.722, 30: 46.979, 40: 59.342 }, '0.01': { 1: 7.879, 2: 10.597, 3: 12.838, 4: 14.860, 5: 16.750, 6: 18.548, 7: 20.278, 8: 21.955, 9: 23.589, 10: 25.188, 11: 26.757, 12: 28.300, 13: 29.819, 14: 31.319, 15: 32.801, 16: 34.267, 17: 35.718, 18: 37.156, 19: 38.582, 20: 39.997, 21: 41.401, 22: 42.796, 23: 44.181, 24: 45.559, 25: 46.928, 26: 48.290, 27: 49.645, 28: 50.993, 29: 52.336, 30: 53.672, 40: 66.766 } };

    React.useEffect(() => {
        try {
            setError('');
            const dataPoints = chiSquaredData.split(/[\s,]+/).filter(v => v.trim() !== '').map(Number);
            if (dataPoints.some(isNaN)) { if (chiSquaredData.trim().length > 0) setError("Data contains non-numeric values."); setResult(null); return; }
            
            const n = dataPoints.length;
            if (n < 2) { setResult(null); return; }

            const mean = dataPoints.reduce((sum, val) => sum + val, 0) / n;
            const chiSquared = dataPoints.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / mean;
            const df = n - 1;

            let lowerCrit, upperCrit;
            const tableRow = CHI_SQUARED_CRITICAL_VALUES?.[alpha];
            if (tableRow && tableRow[df] !== undefined) {
                if (Array.isArray(tableRow[df])) [lowerCrit, upperCrit] = tableRow[df];
                else { lowerCrit = tableRow[df]; upperCrit = UPPER_BOUNDS[alpha][df]; } // Handle your logic
            } else {
                // Wilson-Hilferty approx
                const zScoreMap = { '0.10': 1.645, '0.05': 1.960, '0.01': 2.576 };
                const z = zScoreMap[alpha];
                const term1 = 2 / (9 * df);
                lowerCrit = df * Math.pow(1 - term1 - z * Math.sqrt(term1), 3);
                upperCrit = df * Math.pow(1 - term1 + z * Math.sqrt(term1), 3);
            }

            const pass = chiSquared >= lowerCrit && chiSquared <= upperCrit;
            setResult({ n, df, mean: mean.toFixed(2), chiSquared: chiSquared.toFixed(4), lowerBound: lowerCrit.toFixed(3), upperBound: upperCrit.toFixed(3), conclusion: pass ? 'PASS' : 'FAIL' });
        } catch (e) { setError("Calculation Error"); setResult(null); }
    }, [chiSquaredData, alpha]);

    const handleSave = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'χ² Test', icon: ICONS.labStats, inputs: `N=${result.n}, α=${alpha}`, result: `χ²=${result.chiSquared} (${result.conclusion})`, view: VIEWS.LAB_STATS });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-lg space-y-4">
                <div><label className="block text-sm font-medium">Count Data</label><textarea value={chiSquaredData} onChange={e => setChiSquaredData(e.target.value)} rows="5" className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 font-mono text-sm" placeholder="Paste counts..."></textarea></div>
                <div><label className="block text-sm font-medium">Significance Level (α)</label><select value={alpha} onChange={e => setAlpha(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"><option value="0.10">0.10 (90%)</option><option value="0.05">0.05 (95%)</option><option value="0.01">0.01 (99%)</option></select></div>
            </div>
            
            {result && (
                <div className={`p-5 rounded-lg mt-4 text-center animate-fade-in shadow-sm ${result.conclusion === 'PASS' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                    <div className="flex justify-end -mt-3 -mr-3 mb-1"><button onClick={handleSave} className="text-slate-500 hover:text-black dark:hover:text-white"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></div>
                    <p className={`text-3xl font-extrabold ${result.conclusion === 'PASS' ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}`}>SYSTEM {result.conclusion}ES</p>
                    <div className="mt-4 grid grid-cols-3 gap-2 text-sm border-t border-black/10 pt-4">
                        <div><p className="text-xs text-slate-500">Lower Limit</p><p className="font-mono font-bold">{result.lowerBound}</p></div>
                        <div><p className="text-xs text-slate-500">Calculated χ²</p><p className="font-mono font-bold text-lg">{result.chiSquared}</p></div>
                        <div><p className="text-xs text-slate-500">Upper Limit</p><p className="font-mono font-bold">{result.upperBound}</p></div>
                    </div>
                </div>
            )}
        </div>
    );
};

// 3. UPDATED: DeadTimeCorrector (Visual Polish)
const DeadTimeCorrector = ({ observedCpm, setObservedCpm, deadTime, setDeadTime, result, setResult, error, setError }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    React.useEffect(() => {
        try {
            setError('');
            const R = parseFloat(observedCpm); const tau = parseFloat(deadTime);
            if (isNaN(R) || isNaN(tau) || R < 0 || tau < 0) { setResult(null); return; }
            
            const R_cps = R / 60.0;
            const tau_s = tau / 1e6;
            const denom = 1 - (R_cps * tau_s);
            if (denom <= 0) throw new Error("Detector Saturated!");
            
            const N_cpm = (R_cps / denom) * 60;
            setResult({ trueCpm: N_cpm, loss: (1 - R/N_cpm)*100 });
        } catch(e) { setError(e.message); setResult(null); }
    }, [observedCpm, deadTime]);

    const handleSave = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'Dead Time', icon: ICONS.stopwatch, inputs: `Obs: ${observedCpm}, τ: ${deadTime}µs`, result: `True: ${Math.round(result.trueCpm)} cpm`, view: VIEWS.LAB_STATS });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                <div><label className="block text-sm font-medium">Observed CPM</label><input type="number" value={observedCpm} onChange={e => setObservedCpm(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                <div><label className="block text-sm font-medium">Dead Time (µs)</label><input type="number" value={deadTime} onChange={e => setDeadTime(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
            </div>
            {error && <p className="text-red-500 text-center text-sm">{error}</p>}
            {result && (
                <div className="mt-4 p-5 bg-slate-100 dark:bg-slate-700 rounded-lg text-center shadow-sm">
                    <div className="flex justify-end -mt-3 -mr-3 mb-2"><button onClick={handleSave} className="text-slate-400 hover:text-sky-600"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></div>
                    <p className="text-xs uppercase font-bold text-slate-500">True Count Rate</p>
                    <p className="text-3xl font-extrabold text-sky-600 dark:text-sky-400 my-1">{Math.round(result.trueCpm).toLocaleString()}</p>
                    <p className="text-sm text-slate-500 font-medium">cpm</p>
                    <div className="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                        <p className={`font-bold ${result.loss > 10 ? 'text-amber-500' : 'text-slate-600 dark:text-slate-300'}`}>{result.loss.toFixed(2)}% Loss</p>
                    </div>
                </div>
            )}
        </div>
    );
};

// 4. UPDATED: RpdCalculator (Visual Polish)
const RpdCalculator = ({ sample1, setSample1, sample2, setSample2, result, setResult }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    React.useEffect(() => {
        const s1 = parseFloat(sample1); const s2 = parseFloat(sample2);
        if (!isNaN(s1) && !isNaN(s2) && (s1+s2 > 0)) {
            const rpd = Math.abs(s1 - s2) / ((s1 + s2)/2) * 100;
            setResult({ rpd: rpd.toFixed(2), pass: rpd <= 20 });
        } else { setResult(null); }
    }, [sample1, sample2]);

    const handleSave = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'RPD', icon: ICONS.compare, inputs: `${sample1} vs ${sample2}`, result: `${result.rpd}%`, view: VIEWS.LAB_STATS });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                <div><label className="block text-sm font-medium">Sample 1</label><input type="number" value={sample1} onChange={e => setSample1(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
                <div><label className="block text-sm font-medium">Sample 2</label><input type="number" value={sample2} onChange={e => setSample2(e.target.value)} className="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700"/></div>
            </div>
            {result && (
                <div className="mt-4 p-5 bg-slate-100 dark:bg-slate-700 rounded-lg text-center shadow-sm">
                    <div className="flex justify-end -mt-3 -mr-3 mb-2"><button onClick={handleSave} className="text-slate-400 hover:text-sky-600"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></div>
                    <p className="text-xs uppercase font-bold text-slate-500">Relative Percent Difference</p>
                    <p className={`text-4xl font-extrabold my-2 ${result.pass ? 'text-sky-600 dark:text-sky-400' : 'text-amber-500'}`}>{result.rpd}%</p>
                    {result.pass ? <p className="text-green-600 font-bold text-sm">Acceptable (≤ 20%)</p> : <p className="text-amber-600 font-bold text-sm">Investigate (> 20%)</p>}
                </div>
            )}
        </div>
    );
};

// 5. UPDATED: FwhmCalculator (Visual Polish)
const FwhmCalculator = ({ centroid, setCentroid, lower, setLower, upper, setUpper, result, setResult }) => {
    const { addHistory } = useCalculationHistory();
    const { addToast } = useToast();
    
    React.useEffect(() => {
        const c = parseFloat(centroid); const l = parseFloat(lower); const u = parseFloat(upper);
        if (!isNaN(c) && !isNaN(l) && !isNaN(u) && c > 0) {
            const fwhm = u - l;
            setResult({ fwhm: fwhm.toFixed(2), res: (fwhm/c)*100 });
        } else { setResult(null); }
    }, [centroid, lower, upper]);

    const handleSave = () => {
        if (result) {
            addHistory({ id: Date.now(), type: 'Resolution', icon: ICONS.gammaSpec, inputs: `Peak: ${centroid}`, result: `${result.res.toFixed(2)}%`, view: VIEWS.LAB_STATS });
            addToast("Saved!");
        }
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-3 gap-2 p-4 border border-slate-200 dark:border-slate-700 rounded-lg">
                <div><label className="block text-xs font-bold mb-1">Centroid</label><input type="number" value={centroid} onChange={e => setCentroid(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
                <div><label className="block text-xs font-bold mb-1">Lower ½</label><input type="number" value={lower} onChange={e => setLower(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
                <div><label className="block text-xs font-bold mb-1">Upper ½</label><input type="number" value={upper} onChange={e => setUpper(e.target.value)} className="w-full p-2 rounded-md bg-slate-100 dark:bg-slate-700 text-sm"/></div>
            </div>
            {result && (
                <div className="mt-4 p-5 bg-slate-100 dark:bg-slate-700 rounded-lg text-center shadow-sm">
                    <div className="flex justify-end -mt-3 -mr-3 mb-2"><button onClick={handleSave} className="text-slate-400 hover:text-sky-600"><Icon path={ICONS.notepad} className="w-5 h-5"/></button></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><p className="text-xs uppercase font-bold text-slate-500">FWHM</p><p className="text-2xl font-bold text-slate-700 dark:text-slate-200">{result.fwhm}</p></div>
                        <div><p className="text-xs uppercase font-bold text-slate-500">Resolution</p><p className="text-2xl font-bold text-sky-600 dark:text-sky-400">{result.res.toFixed(2)}%</p></div>
                    </div>
                </div>
            )}
        </div>
    );
};

// 6. MAIN CONTAINER: LabStatistics
const LabStatistics = () => {
    const [activeTab, setActiveTab] = React.useState('mda');
    
    // MDA State
    const [mda_bkgCounts, setMda_bkgCounts] = React.useState('50');
    const [mda_countTime, setMda_countTime] = React.useState('1');
    const [mda_bkgTime, setMda_bkgTime] = React.useState('1');
    const [mda_eff, setMda_eff] = React.useState('10');
    const [mda_effUnit, setMda_effUnit] = React.useState('%');
    const [mda_area, setMda_area] = React.useState('100');
    const [mda_result, setMda_result] = React.useState(null);

    // ChiSq State
    const [chi_data, setChi_data] = React.useState('');
    const [chi_alpha, setChi_alpha] = React.useState('0.05');
    const [chi_result, setChi_result] = React.useState(null);
    const [chi_error, setChi_error] = React.useState('');

    // DeadTime State
    const [dt_obs, setDt_obs] = React.useState('50000');
    const [dt_tau, setDt_tau] = React.useState('100');
    const [dt_result, setDt_result] = React.useState(null);
    const [dt_error, setDt_error] = React.useState('');

    // RPD State
    const [rpd_s1, setRpd_s1] = React.useState('1250');
    const [rpd_s2, setRpd_s2] = React.useState('1180');
    const [rpd_result, setRpd_result] = React.useState(null);

    // FWHM State
    const [fw_cent, setFw_cent] = React.useState('661.7');
    const [fw_low, setFw_low] = React.useState('658.2');
    const [fw_up, setFw_up] = React.useState('665.2');
    const [fw_result, setFw_result] = React.useState(null);

    const handleClear = () => {
        if(activeTab === 'mda') { setMda_bkgCounts('50'); setMda_result(null); }
        if(activeTab === 'chi') { setChi_data(''); setChi_result(null); }
        if(activeTab === 'dt') { setDt_obs('50000'); setDt_result(null); }
        if(activeTab === 'rpd') { setRpd_s1(''); setRpd_result(null); }
        if(activeTab === 'fwhm') { setFw_cent(''); setFw_result(null); }
    };

    return (
        <div className="p-4 animate-fade-in">
            <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white">Lab Statistics</h2>
                    <ClearButton onClick={handleClear} />
                </div>

                {/* UPDATED: Centered Tabs using flex-1 and text-center */}
                <div className="flex w-full p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6 overflow-x-auto no-scrollbar gap-1">
                    {['mda', 'chi', 'dt', 'rpd', 'fwhm'].map(id => {
                        const labels = { mda: 'MDA/MDC', chi: 'Chi-Sq', dt: 'Dead Time', rpd: 'RPD', fwhm: 'Resolution' };
                        return (
                            <button key={id} onClick={() => setActiveTab(id)} 
                                className={`flex-1 min-w-fit px-2 py-2 rounded-md text-sm font-bold text-center whitespace-nowrap transition-all duration-200 
                                ${activeTab === id 
                                    ? 'bg-white dark:bg-slate-800 text-sky-600 shadow-sm ring-1 ring-black/5 dark:ring-white/10' 
                                    : 'text-slate-600 dark:text-slate-300 hover:bg-slate-300/50 dark:hover:bg-slate-600'
                                }`}>
                                {labels[id]}
                            </button>
                        )
                    })}
                </div>

                <div className="mt-2">
                    {activeTab === 'mda' && <MdaCalculator 
                        bkgCounts={mda_bkgCounts} setBkgCounts={setMda_bkgCounts} countTime={mda_countTime} setCountTime={setMda_countTime} 
                        bkgTime={mda_bkgTime} setBkgTime={setMda_bkgTime} efficiency={mda_eff} setEfficiency={setMda_eff} 
                        effUnit={mda_effUnit} setEffUnit={setMda_effUnit} probeArea={mda_area} setProbeArea={setMda_area} 
                        result={mda_result} setResult={setMda_result} 
                    />}
                    {activeTab === 'chi' && <ChiSquaredCalculator 
                        chiSquaredData={chi_data} setChiSquaredData={setChi_data} alpha={chi_alpha} setAlpha={setChi_alpha} 
                        result={chi_result} setResult={setChi_result} error={chi_error} setError={setChi_error} 
                    />}
                    {activeTab === 'dt' && <DeadTimeCorrector 
                        observedCpm={dt_obs} setObservedCpm={setDt_obs} deadTime={dt_tau} setDeadTime={setDt_tau} 
                        result={dt_result} setResult={setDt_result} error={dt_error} setError={setDt_error} 
                    />}
                    {activeTab === 'rpd' && <RpdCalculator 
                        sample1={rpd_s1} setSample1={setRpd_s1} sample2={rpd_s2} setSample2={setRpd_s2} 
                        result={rpd_result} setResult={setRpd_result} 
                    />}
                    {activeTab === 'fwhm' && <FwhmCalculator 
                        centroid={fw_cent} setCentroid={setFw_cent} lower={fw_low} setLower={setFw_low} upper={fw_up} setUpper={setFw_up} 
                        result={fw_result} setResult={setFw_result} 
                    />}
                </div>
            </div>
        </div>
    );
};                       

 
              /**
              * @description A React component that renders a line chart for simple radioactive decay using Chart.js.
              * It can display the decay of a parent nuclide and the in-growth and decay of a single daughter nuclide.
              * @param {{chartData: object}} props - The data object for the chart, including labels and datasets for parent and optional daughter.
              */
                       
              const DecayChart = ({ chartData, useLogScale, theme }) => {
              const chartRef = React.useRef(null);
              const chartInstance = React.useRef(null);
              
              React.useEffect(() => {
         
                  // Destroy the previous chart instance if it exists
         
                  if (chartInstance.current) {
                     chartInstance.current.destroy();
                  }
              
                  if (chartRef.current && chartData) {
                     // Determine colors based on the theme prop
                     const isDarkMode = theme === 'dark';
                     const textColor = isDarkMode ? '#94a3b8' : '#475569';
                     const gridColor = isDarkMode ? '#334155' : '#e2e8f0';
                     const legendColor = isDarkMode ? '#cbd5e1' : '#334155';
         
                     const ctx = chartRef.current.getContext('2d');
                     chartInstance.current = new Chart(ctx, {
                         type: 'line',
                         data: {
                             labels: chartData.labels,
                             datasets: [
                                 {
                                     label: chartData.parentName,
                                     data: chartData.parentData,
                                     borderColor: '#0284c7', // Sky-600
                                     backgroundColor: 'rgba(2, 132, 199, 0.1)',
                                     fill: true,
                                     tension: 0.1,
                                     pointRadius: 0
                                 },
                                 ...(chartData.daughterData ? [{
                                     label: chartData.daughterName,
                                     data: chartData.daughterData,
                                     borderColor: '#e11d48', // Rose-600
                                     backgroundColor: 'rgba(225, 29, 72, 0.1)',
                                     fill: true,
                                     tension: 0.1,
                                     pointRadius: 0
                                 }] : [])
                             ]
                         },
                         options: {
                             responsive: true,
                             maintainAspectRatio: false,
                             scales: {
                                 x: {
                                     title: { display: true, text: `Time (${chartData.timeUnit})` },
                                     ticks: { color: textColor },
                                     grid: { color: gridColor }
                                 },
                                 y: {
                                     type: useLogScale ? 'logarithmic' : 'linear',
                                     title: { display: true, text: `Activity (${useLogScale ? 'Log Scale' : 'Linear Scale'})` },
                                     beginAtZero: !useLogScale,
                                     ticks: { color: textColor },
                                     grid: { color: gridColor }
                                 }
                             },
                             plugins: {
                                 legend: {
                                     labels: {
                                         color: legendColor
                                     }
                                 }
                             }
                         }
                     });
                  }
              
                  return () => {
                     if (chartInstance.current) {
                         chartInstance.current.destroy();
                     }
                  };
              }, [chartData, useLogScale, theme]); // Added theme to the dependency array
              
              const handleExport = () => {
              if (chartInstance.current) {
                 const link = document.createElement('a');
                 link.href = chartInstance.current.toBase64Image();
                 link.download = 'decay-chart.png';
                 link.click();
              }
              };
              
              return (
              <div className="mt-4">
                 <div className="h-64">
                     <canvas ref={chartRef}></canvas>
                 </div>
                 <div className="text-center mt-2">
                     <button
                         onClick={handleExport}
                         className="px-3 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded-md hover:bg-sky-100 dark:hover:bg-sky-800 transition font-semibold"
                     >
                         Export as PNG
                     </button>
                 </div>
              </div>
              );
              };
              
              // Final step: Render the main App component into the DOM.
              
              ReactDOM.createRoot(document.getElementById('root')).render(
              <SettingsProvider>
              <ToastProvider>
                  <App />
              </ToastProvider>
              </SettingsProvider>
              );
              
              ReactDOM.createRoot(document.getElementById('back-to-top-root')).render(
              <BackToTopButton />
              );
              
              // After the app is rendered, find the loader and fade it out.
              
              const loader = document.getElementById('loader');
              if (loader) {
              
              // A small timeout ensures the app has painted before the loader disappears.
              
              setTimeout(() => {
              
              loader.classList.add('hidden');
              }, 100); // 100ms delay
              }
              
      </script>
   </body>
</html>
