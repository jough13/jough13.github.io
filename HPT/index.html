<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50,50 m0,-45 a45,45 0 1,1 0,90 a45,45 0 1,1 0,-90' stroke='%2338bdf8' stroke-width='10' stroke-dasharray='1 7' fill='none' transform='rotate(15 50 50)'><animateTransform attributeName='transform' type='rotate' from='15 50 50' to='375 50 50' dur='10s' repeatCount='indefinite' /></path><circle cx='50' cy='50' r='20' fill='%230ea5e9'/></svg>">
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-VQFWC5V7FC"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            
            gtag('config', 'G-VQFWC5V7FC');
        </script>
        <script>
            // 1. The "Speed Bump": Disable Right-Click
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                // Optional: Alert the user (or just do nothing to be subtle)
                // alert('© 2026 Joseph Donakowski. Code is proprietary.'); 
            });
            
            // 2. The "Curious Cat" Deterrent: Disable F12 / Inspect Shortcuts
            document.onkeydown = function(e) {
                if(e.keyCode == 123) { // F12
                return false;
                }
                if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
                return false;
                }
                if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
                return false;
                }
                if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
                return false;
                }
                if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (View Source)
                return false;
                }
            }
            
            // 3. The "Legal Wall": Console Warning
            // If someone DOES manage to open the console, this is the first thing they see.
            console.log("%cThis is a proprietary tool developed by Joseph Donakowski, CHP.", "font-size: 16px;");
            console.log("%cUnauthorized copying, reverse engineering, or distribution is strictly prohibited. Activity is logged.", "font-size: 16px; color: red;");
        </script>
        <!-- Inline Styles for the Loader (Must remain in HTML for instant loading) -->
        <style>
            #loader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            }
            .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #cbd5e1;
            border-bottom-color: #38bdf8;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: spin 1s linear infinite;
            }
            .loading-text {
            margin-top: 20px;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            /* Dark Mode Loader Overrides */
            html.dark #loader { background-color: #0f172a; }
            html.dark .spinner { border: 5px solid #334155; border-bottom-color: #38bdf8; }
            html.dark .loading-text { color: #94a3b8; }
            #loader.hidden { opacity: 0; visibility: hidden; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        </style>
        <!--Basic HTML Metadata-->
        <meta charset="UTF-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <script>
            (function() {
            
              // Function to apply the dark theme
            
              const applyTheme = () => {
                document.documentElement.classList.add('dark');
              };
            
              // Check 1: See if a theme is explicitly saved in localStorage
            
              const savedTheme = localStorage.getItem('theme');
              if (savedTheme === 'dark') {
                applyTheme();
                return;
              }
            
              // Check 2: If no saved theme, check the user's OS/browser preference
            
              if (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme();
              }
            
            })();
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
        <title>Health Physics Toolbox</title>
        <!--External Libraries & Frameworks-->
        <!--Tailwind CSS for styling-->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            // Enables Tailwind's dark mode feature, allowing class-based theme switching (e.g., <body class="dark">)
            
            tailwind.config = {
              darkMode: 'class'
            }
        </script>
        <!--React Libraries for building the user interface-->
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
            ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
            ></script>
        <!--Babel to transpile JSX (React's syntax) into plain JavaScript in the browser-->
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <!--Chart.js for creating data visualizations-->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!--Google Fonts for a clean, modern typeface-->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
            />
        <!--Custom Application Styles-->
        <link
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
            rel="stylesheet"
            />
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
            ></script>
        <script
            defer
            onload="renderMathInElement(document.body);"
            src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
            ></script>
        <link rel="stylesheet" href="css/style.css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
            />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet-geosearch@3/dist/geosearch.css"
            />
        <script src="https://unpkg.com/leaflet-geosearch@3/dist/geosearch.umd.js"></script>
        <script>
            // When the document is ready, add the 'visible' class to the #root element
            // to trigger our CSS transition.
            
            window.addEventListener('DOMContentLoaded', () => {
              document.getElementById('root').classList.add('visible');
            });
        </script>
    </head>
    <body class="bg-slate-100 dark:bg-slate-900 transition-colors duration-300">
        <div id="loader">
            <div class="spinner"></div>
            <p class="loading-text">Health Physics Toolbox loading...</p>
        </div>
        <!--The root element where the React application will be mounted.-->
        <div id="root"></div>
        <div id="back-to-top-root"></div>
        <div id="modal-root"></div>
        <div id="toast-root"></div>
        <!-- 1. External Libraries (Keep these) -->
        <script src="js/radionuclide-data.js"></script> 
        <!-- 2. Constants & Data -->
        <script type="text/babel" src="js/constants.js"></script>
        <script type="text/babel" src="js/data.js"></script>
        <!-- 3. Utilities -->
        <script type="text/babel" src="js/utils.js"></script>
        <!-- 4. React State -->
        <script type="text/babel" src="js/state.js"></script>
        <!-- 5. UI Components -->
        <script type="text/babel" src="js/components-ui.js"></script>
        <!-- 6. Calculators -->
        <script type="text/babel" src="js/calculators.js"></script>
        <script type="text/babel" src="js/marssim.js"></script>
        <!-- 7. Page Views -->
        <script type="text/babel" src="js/views.js"></script>
        <script type="text/babel">
            /**
             * A comprehensive list of radionuclides pulled from the initial table.
             */
            
            const radionuclides = RADIONUCLIDE_DATA;
                        
            /**
            * @description React component for displaying the application's user manual, FAQ, and technical reference.
            * This component functions as a modal dialog that presents static, detailed information about the
            * "Health Physics Toolbox" application.
            *
            * The manual content is an in-depth guide covering:
            * - **Getting Started:** How to search for and view radionuclide data.
            * - **Core Features:** A comprehensive breakdown of each major section of the app (Database, Compare, Calculators).
            * - **Settings & Customization:** How to configure user preferences.
            * - **Formulas & Equations:** A reference section detailing the key mathematical formulas used in various calculators.
            * - **Contact & Copyright:** Information for user feedback and legal disclaimers.
            * - **FAQ:** Answers to common questions, such as the source of the data and why certain nuclides may not appear in specific calculators.
            *
            * This component is purely for display and serves as the primary source of documentation for the user.
            *
            * @prop {boolean} isOpen - Boolean to control the visibility of the modal.
            * @prop {function} onClose - A callback function to close the modal.
            */
            
            const ManualModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            
            // Internal component for the static content of the manual
            const ManualContent = () => {
            return (
            <div className="prose prose-slate dark:prose-invert max-w-none p-6 text-slate-700 dark:text-slate-300">
              <h1 className="text-slate-900 dark:text-slate-100"><strong>User Manual & FAQ</strong></h1>
              <p>
                  Welcome to the Health Physics Toolbox! This application is designed to be a comprehensive, all-in-one resource for students, health physicists, and nuclear professionals. Our philosophy is to centralize the essential data and calculations you need, removing the reliance on scattered spreadsheets, outdated software, or manual lookups. This guide will walk you through the various features to help you get the most out of the tool.
              </p>
            
              <hr className="my-4" />
            
              <h2 className="text-slate-900 dark:text-slate-100"><strong>Getting Started: Finding a Nuclide</strong></h2>
              <p>
                  The primary function of the tool is to look up detailed information on a specific radionuclide. The search bar at the top of the page is your main entry point.
              </p>
              <h4 className="italic mt-4">Searching</h4>
              <p>
                  You can search by either the nuclide's full name (e.g., <code>"Cesium-137"</code>) or its symbol (e.g., <code>"Cs-137"</code>). The search is flexible and ignores spaces or hyphens, so <code>"cs137"</code> will also work. As you type, a list of the top 10 suggestions will appear, prioritized by how common the nuclide is, to help you find what you're looking for faster.
              </p>
              <h4 className="italic mt-4">The Nuclide Card</h4>
              <p>
                  Once you select a nuclide, its detailed information card is displayed. This card is a comprehensive summary, containing key data points grouped into logical sections like **Decay Properties**, **Physical Properties**, **Genealogy**, **Transportation Limits**, **Internal Dosimetry**, and **Principal Emissions**. You can add a nuclide to your persistent <strong>Favorites</strong> list by clicking the star icon in the top right, making it easily accessible from the home page.
              </p>
            
              <hr className="my-4" />
            
              <h2 className="text-slate-900 dark:text-slate-100"><strong>Core Features</strong></h2>
              <p>The main navigation bar provides access to all the specialized tools and views within the application.</p>
            
              <h3 className="mt-6"><strong>Database & Compare</strong></h3>
              <ul>
                  <li><strong>Database:</strong> This view is for discovery and exploration. It allows you to browse and sort the entire collection of radionuclides. The sidebar on the left provides a powerful set of filters to help you find nuclides with specific properties, such as category, emission type, half-life, and energy ranges. This is perfect for finding the right nuclide for a specific application.</li>
                  <li><strong>Compare:</strong> This tool is designed for nuanced analysis, allowing you to view multiple nuclides in a side-by-side table. This is especially useful for comparing similar candidates for a task, such as different isotopes for brachytherapy or medical imaging. The table automatically highlights the minimum and maximum values in each numerical row and displays in-cell data bars to provide an immediate visual sense of magnitude. This view also includes an <strong>Export to CSV</strong> function.</li>
              </ul>
            
              <h3 className="mt-6"><strong>Calculators</strong></h3>
              <p>The application includes a comprehensive suite of calculators for a wide range of radiological scenarios.</p>
            
              <h4 className="italic mt-4">Decay Calculators</h4>
              <p>This group of tools handles the physics of radioactive decay over time.</p>
              <ul>
                  <li><strong>Decay Tools:</strong> A multi-tool for fundamental decay calculations. The <strong>Standard</strong> tab solves the fundamental decay equation for any one variable (initial activity, remaining activity, or time). The <strong>Correction</strong> tab is a specialized tool for correcting a source's activity from its calibration date to a new date. The <strong>To Limit</strong> tab calculates the time required for a source to decay to a specific activity level, which is useful for waste management.</li>
                  <li><strong>Series Decay:</strong> This advanced tool uses the full Bateman equations to model the activity of <em>every</em> nuclide in a long decay chain (like the Uranium or Thorium series) over time. It provides both a final activity table and an interactive chart showing the in-growth and decay of each progeny, which is essential for understanding complex decay dynamics.</li>
                  <li><strong>Equilibrium:</strong> This calculator specifically analyzes a parent-daughter pair to determine their equilibrium relationship. It will automatically classify the relationship as <strong>Secular</strong> (parent half-life is much longer than daughter's) or <strong>Transient</strong> (parent half-life is longer, but not by a huge margin) and calculates important metrics like the time to maximum daughter activity.</li>
              </ul>
            
              <h4 className="italic mt-4">Dose & Shielding Calculators</h4>
              <p>These tools are for external dosimetry, helping to estimate radiation dose and the shielding required to reduce it.</p>
              <ul>
                  <li><strong>Dose & Dose Rate:</strong> A versatile tool with multiple modes. <strong>Gamma</strong> mode models dose from Point, Line, and Area (Disk) geometries. <strong>Beta</strong> mode includes two sub-calculators: Skin Dose from surface contamination and Dose in Air from a point source. <strong>Bremsstrahlung</strong> mode estimates the secondary X-ray dose produced when beta particles are stopped by shielding. <strong>Internal</strong> mode calculates the Committed Effective Dose Equivalent (CEDE) from an intake using 10 CFR 20 ALI values.</li>
                  <li><strong>Shielding:</strong> This calculator models the attenuation of radiation. The <strong>Gamma</strong> modes calculate the final dose rate after passing through a shield or the required shield thickness to reach a target dose rate. It includes an optional Buildup Factor correction for a more accurate result in broad beam geometries. The <strong>Beta Range</strong> mode calculates the thickness of low-Z material required to completely stop beta particles.</li>
                  <li><strong>Stay Time:</strong> A practical tool for ALARA planning. It calculates the maximum time a person can stay in an area with a known dose rate before accumulating a specific dose limit.</li>
              </ul>
            
              <h4 className="italic mt-4">Operational HP Tools</h4>
              <p>A suite of calculators designed for day-to-day radiation safety tasks and survey analysis.</p>
              <ul>
                 <li><strong>Surface Contamination:</strong> A comprehensive tool that calculates both removable contamination (from a wipe test) and total contamination (from a static probe survey). It automatically compares the results against the standard limits found in both NRC Regulatory Guide 1.86 and ANSI N13.12.</li>
                 <li><strong>Leak Test:</strong> A specialized version of the wipe survey calculator for evaluating sealed sources against the common 0.005 µCi regulatory limit for removable contamination.</li>
                 <li><strong>Airborne Release:</strong> This tool models a theoretical airborne release in a room to calculate the initial concentration in DAC (Derived Air Concentration) units. It also estimates the time required for the room's ventilation system (in Air Changes per Hour) to reduce the concentration back down to 1 DAC.</li>
                 <li><strong>Detector Response:</strong> Estimates the count rate (cpm) a detector would see from a source, accounting for geometry, efficiency, and shielding. Includes models for NaI(Tl) and GM probes.</li>
              </ul>
            
              {/* --- Medical Physics --- */}
              <h4 className="italic mt-4">Medical Physics Tools</h4>
              <p>Calculators tailored to scenarios commonly found in a medical or hospital environment.</p>
              <ul>
                 <li><strong>X-Ray Shielding:</strong> A screening tool to calculate the required thickness of lead, concrete, or drywall for diagnostic X-ray rooms. It is based on the NCRP Report No. 147 methodology, accounting for workload, use factor, occupancy, and distance.</li>
                 <li><strong>Patient Release:</strong> This tool helps determine if a patient administered with a radiopharmaceutical can be released from the hospital based on the criteria in 10 CFR 35.75. It checks against activity-based limits, dose-rate limits, or a full public dose calculation (TEDE) based on occupancy scenarios.</li>
              </ul>
            
              {/* --- Neutron Tools --- */}
              <h4 className="italic mt-4">Neutron Tools</h4>
              <p>A set of specialized calculators for dealing with neutron radiation, a common consideration in reactor and accelerator facilities.</p>
              <ul>
                 <li><strong>Fluence/Dose:</strong> Converts between neutron fluence (n/cm²) and dose equivalent (rem or Sv) for a given neutron energy. The conversion is performed using a log-log interpolation of the quality factors and fluence-per-rem data specified in 10 CFR 20.</li>
                 <li><strong>Activation:</strong> Calculates the activity of a product nuclide created by irradiating a specific target material in a known thermal neutron flux for a given amount of time. It includes both a database of common (n,γ) reactions and a manual input mode for custom scenarios.</li>
                 <li><strong>Composite Activation:</strong> Estimates the principal activation products from irradiating common composite materials like concrete or steel, which contain trace elements that can become significant activation products.</li>
                 <li><strong>Shielding:</strong> Estimates the attenuation of fast or thermal neutrons through various common shielding materials using approximate Half-Value Layer (HVL) data.</li>
              </ul>
            
              {/* --- MARSSIM --- */}
              <h4 className="italic mt-4">MARSSIM Tools</h4>
              <p>A suite of tools dedicated to planning and evaluating final status surveys according to the Multi-Agency Radiation Survey and Site Investigation Manual.</p>
              <ul>
                  <li><strong>MDA/MDC:</strong> Calculates key decision values for radiation counting instrumentation. It includes a mode for <strong>Static Count MDA</strong> (based on NUREG-1507) and <strong>Scan Survey MDC</strong> (based on MARSSIM formulas) to ensure your survey methods can detect contamination at the required levels.</li>
                  <li><strong>Sample Design:</strong> A two-part suite. The <strong>Calculator</strong> determines the required number of statistical samples for a survey unit using the Wilcoxon Rank Sum (WRS) test methodology. The <strong>Drawing Tool</strong> provides an interactive map to draw survey unit boundaries and automatically generate sample locations in a square grid, triangular grid, or random pattern.</li>
                  <li><strong>Statistical Tests:</strong> Performs the two primary MARSSIM statistical tests on a set of data. The <strong>WRS Test</strong> is used to compare a survey unit to a reference area to determine if it meets the release criteria. The <strong>EMC Sign Test</strong> is used for evaluating localized areas of elevated activity to ensure they are not a significant risk.</li>
              </ul>
            
              {/* --- Lab Stats --- */}
              <h4 className="italic mt-4">Lab Statistics & QA/QC</h4>
              <p>Tools for quality assurance and control of radiation counting equipment and laboratory processes.</p>
              <ul>
                 <li><strong>Chi-Squared (χ²) Test:</strong> This is a key performance test for a counting system. It performs a chi-squared test on a set of repeated counts of a stable source to check if the observed variance is consistent with a random Poisson distribution, ensuring the detector is functioning properly.</li>
                 <li><strong>Dead Time Correction:</strong> Corrects an observed count rate for counts that were missed due to detector dead time—the brief period after detecting a particle when the system is busy and cannot register another. This is crucial for accurate measurements at high count rates.</li>
                 <li><strong>RPD:</strong> Calculates the Relative Percent Difference between two duplicate samples to evaluate measurement precision and the reproducibility of your lab processes.</li>
                 <li><strong>FWHM / Resolution:</strong> Calculates a detector's Full Width at Half Maximum (FWHM) and energy resolution from a photopeak's properties (centroid and half-max energies). This is a fundamental measure of a gamma spectroscopy system's performance.</li>
              </ul>
            
              <h4 className="italic mt-4">Utility Tools</h4>
              <p>A collection of helpful tools to streamline your workflow.</p>
              <ul>
                  <li><strong>Peak Identifier:</strong> An essential tool for spectroscopy. The <strong>Search</strong> tab finds matching radionuclides for a given peak energy and tolerance. It also analyzes for common spectral artifacts like Compton Edges, escape peaks, and lead X-rays. The <strong>Data Tables</strong> tab provides a comprehensive, sortable, and filterable list of all alpha, beta, and gamma emissions in the database.</li>
                  <li><strong>Activity/Mass Tools:</strong> A three-in-one module. <strong>Mass ↔ Activity</strong> converts between a nuclide's mass and its activity using its specific activity. <strong>Activity from Dose</strong> calculates a source's activity based on a gamma dose rate measurement. <strong>Specific Activity</strong> is a first-principles calculator for determining a nuclide's SA (Bq/g) from its atomic weight and half-life.</li>
                  <li><strong>Radon Tools:</strong> A three-part suite for radon analysis. <strong>Concentration</strong> converts between radon concentration units (e.g., pCi/L and Bq/m³) and estimates annual dose. <strong>Ingrowth</strong> calculates the Rn-222 activity from a given mass of its parent, Ra-226. <strong>Kusnetz (WL)</strong> determines the Working Level of radon progeny from air sampling data.</li>
                  <li><strong>Transportation:</strong> Determines the required shipping package type (Excepted, Type A, or Type B) for a given radionuclide and activity, based on its IAEA A₁ (special form) and A₂ (normal form) values.</li>
                  <li><strong>Converter:</strong> A general-purpose unit converter for activity, dose, dose rate, energy, concentration, and other common physical units.</li>
                  <li><strong>Scratchpad:</strong> A persistent text area for jotting down notes or intermediate results. Notes are saved to your browser's local storage.</li>
                  <li><strong>Scientific Calculator:</strong> A professional-grade calculator with "Smart Start" (operators apply to previous answer), memory functions, scientific notation (`EXP`), and quick-insert buttons for physics constants.</li>
              </ul>
            
              <hr className="my-4" />
            
              <h2 className="text-slate-900 dark:text-slate-100"><strong>Formulas & Equations Reference</strong></h2>
            
              <h3 className="mt-6"><b>Decay & Activity Formulas</b></h3>
              <h4 className="italic mt-4">Radioactive Decay</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>A(t) = A₀ · e<sup>-λt</sup></pre>
              </div>
              <ul>
                  <li><code>A(t)</code> = Activity at time t</li>
                  <li><code>A₀</code> = Initial activity at t=0</li>
                  <li><code>λ</code> = Decay constant (ln(2) / T<sub>1/2</sub>)</li>
                  <li><code>t</code> = Elapsed time</li>
              </ul>
            
              <h4 className="italic mt-4">Series (Bateman) Decay for a 2-step chain (A → B)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>A₂(t) = [A₁(0)·λ₂/(λ₂-λ₁)]·[e<sup>-λ₁t</sup> - e<sup>-λ₂t</sup>] + A₂(0)e<sup>-λ₂t</sup></pre>
              </div>
               <ul>
                  <li><code>A₂(t)</code> = Activity of the daughter at time t</li>
                  <li><code>A₁(0)</code> = Initial activity of the parent</li>
                  <li><code>A₂(0)</code> = Initial activity of the daughter</li>
                  <li><code>λ₁</code>, <code>λ₂</code> = Decay constants for parent and daughter, respectively</li>
              </ul>
            
              <h4 className="italic mt-4">Specific Activity (SA)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>SA (Bq/g) = (Nₐ · λ) / Mₐ</pre>
              </div>
              <ul>
                  <li><code>Nₐ</code> = Avogadro's Number (6.022 x 10²³ atoms/mol)</li>
                  <li><code>Mₐ</code> = Molar mass of the radionuclide (g/mol)</li>
                  <li><code>λ</code> = Decay constant in seconds⁻¹</li>
              </ul>
            
              <h3 className="mt-6"><b>Dose & Shielding Formulas</b></h3>
              <h4 className="italic mt-4">Gamma Dose Rate (Point Source)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>Dose Rate = (Γ · A) / d²</pre>
              </div>
              <ul>
                  <li><code>Γ</code> = Specific gamma-ray constant (e.g., in R·m²/hr·Ci)</li>
                  <li><code>A</code> = Source activity (in Ci)</li>
                  <li><code>d</code> = Distance from the source (in m)</li>
              </ul>
            
              <h4 className="italic mt-4">Gamma Shielding</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>D(x) = D₀ · B · (0.5)<sup>(x / HVL)</sup></pre>
              </div>
              <ul>
                  <li><code>D(x)</code> = Dose rate after shielding</li>
                  <li><code>D₀</code> = Initial dose rate</li>
                  <li><code>B</code> = Buildup Factor, for scattered photons</li>
                  <li><code>x</code> = Shield thickness</li>
                  <li><code>HVL</code> = Half-Value Layer thickness for the material</li>
              </ul>
            
              {/* --- NEW FORMULA: Patient Release --- */}
              <h4 className="italic mt-4">Patient Release TEDE (10 CFR 35.75)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>TEDE (rem) ≈ 1.443 · Γ · A₀ · T<sub>eff</sub> · Σ(tᵢ / dᵢ²)</pre>
              </div>
              <ul>
                  <li><code>Γ</code> = Gamma constant (R·m²/hr·mCi)</li>
                  <li><code>A₀</code> = Initial activity (mCi)</li>
                  <li><code>T<sub>eff</sub></code> = Effective half-life (hours)</li>
                  <li><code>tᵢ</code> = Occupancy time fraction for scenario i (hours/24)</li>
                  <li><code>dᵢ</code> = Distance for scenario i (m)</li>
              </ul>
            
              <h3 className="mt-6"><b>Operational HP Formulas</b></h3>
              <h4 className="italic mt-4">Wipe / Leak Test Activity</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>Activity (µCi) = (CPM<sub>net</sub>) / (ε<sub>inst</sub> · ε<sub>smear</sub> · 2.22x10⁶)</pre>
              </div>
              <ul>
                  <li><code>CPM<sub>net</sub></code> = Gross CPM - Background CPM</li>
                  <li><code>ε<sub>inst</sub></code> = Instrument efficiency (as a fraction)</li>
                  <li><code>ε<sub>smear</sub></code> = Smear/wipe efficiency (typically 0.1)</li>
                  <li><code>2.22x10⁶</code> = DPM per µCi</li>
              </ul>
            
              <h4 className="italic mt-4">Airborne Concentration</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>C(t) = (A / V) · e<sup>(-ACH · t)</sup></pre>
              </div>
              <ul>
                  <li><code>C(t)</code> = Concentration at time t</li>
                  <li><code>A</code> = Released activity</li>
                  <li><code>V</code> = Room volume</li>
                  <li><code>ACH</code> = Air Changes per Hour</li>
                  <li><code>t</code> = Time in hours</li>
              </ul>
            
              {/* --- Neutron Formulas --- */}
              <h3 className="mt-6"><b>Neutron Formulas</b></h3>
              <h4 className="italic mt-4">Thermal Neutron Activation</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>A(t) = N · σ · φ · (1 - e<sup>-λt</sup>)</pre>
              </div>
              <ul>
                  <li><code>A(t)</code> = Activity of product at time t (Bq)</li>
                  <li><code>N</code> = Number of target atoms</li>
                  <li><code>σ</code> = Thermal neutron cross-section (cm²)</li>
                  <li><code>φ</code> = Neutron flux (n/cm²·s)</li>
                  <li><code>λ</code> = Decay constant of the product nuclide</li>
                  <li><code>t</code> = Irradiation time (s)</li>
              </ul>
            
              {/* --- MARSSIM Formulas --- */}
              <h3 className="mt-6"><b>MARSSIM Formulas</b></h3>
              <h4 className="italic mt-4">Static Count MDA (NUREG-1507)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>LLD (counts) = 2.71 + 4.65 · √(R<sub>b</sub> · t<sub>s</sub>)</pre>
              </div>
              <ul>
                  <li><code>LLD</code> = Lower Limit of Detection (net counts)</li>
                  <li><code>R<sub>b</sub></code> = Background count rate (cpm)</li>
                  <li><code>t<sub>s</sub></code> = Sample count time (min)</li>
              </ul>
            
              <h4 className="italic mt-4">Scan MDC</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>Scan MDC = MDCR / (√(p) · ε<sub>total</sub>)</pre>
              </div>
              <ul>
                  <li><code>MDCR</code> = Minimum Detectable Count Rate</li>
                  <li><code>p</code> = Surveyor efficiency</li>
                  <li><code>ε<sub>total</sub></code> = Total efficiency (instrument * surface)</li>
              </ul>
            
              <h4 className="italic mt-4">Number of Samples (WRS Test)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>N = (Z₁<sub>-α</sub> + Z₁<sub>-β</sub>)² / (3 · (Pᵣ - 0.5)²)</pre>
              </div>
               <ul>
                  <li><code>Z₁<sub>-α</sub></code>, <code>Z₁<sub>-β</sub></code> = Z-scores for Type I/II error rates</li>
                  <li><code>Pᵣ</code> = Probability value from MARSSIM Table 5.2 based on Relative Shift</li>
              </ul>
            
              {/* --- Lab Stats Formulas --- */}
              <h3 className="mt-6"><b>Lab Statistics Formulas</b></h3>
              <h4 className="italic mt-4">Chi-Squared (χ²) Test</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>χ² = Σ((xᵢ - x̄)²) / x̄</pre>
              </div>
               <ul>
                  <li><code>xᵢ</code> = Individual count value</li>
                  <li><code>x̄</code> = Mean of all count values</li>
              </ul>
            
              <h4 className="italic mt-4">Dead Time Correction</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>N = R / (1 - Rτ)</pre>
              </div>
               <ul>
                  <li><code>N</code> = True count rate (cps)</li>
                  <li><code>R</code> = Observed count rate (cps)</li>
                  <li><code>τ</code> = Detector dead time (seconds)</li>
              </ul>
            
              <h4 className="italic mt-4">Relative Percent Difference (RPD)</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>RPD (%) = |S₁ - S₂| / ((S₁ + S₂) / 2) · 100</pre>
              </div>
              <ul>
                  <li><code>S₁</code>, <code>S₂</code> = Values for the two duplicate samples</li>
              </ul>
            
              <h4 className="italic mt-4">Energy Resolution</h4>
              <div className="my-2 p-3 text-center text-lg font-mono rounded-md bg-slate-100 dark:bg-slate-800 overflow-x-auto">
                  <pre>Resolution (%) = (FWHM / E) · 100</pre>
              </div>
               <ul>
                  <li><code>FWHM</code> = Full Width at Half Maximum of the peak (keV)</li>
                  <li><code>E</code> = Peak centroid energy (keV)</li>
              </ul>
            
              <hr className="my-4" />
            
              <h2 className="text-slate-900 dark:text-slate-100"><strong>Frequently Asked Questions (FAQ)</strong></h2>
              <h4 className="italic mt-4">Where does the data come from?</h4>
              <p>The data is aggregated from highly reliable, standard industry sources:</p>
              <ul>
                  <li><strong>Nuclear Data (Half-life, emissions, etc.):</strong> National Nuclear Data Center's (NNDC) NuDat 3 database.</li>
                  <li><strong>Dosimetry Data (ALI, DAC):</strong> U.S. Nuclear Regulatory Commission, 10 CFR 20, Appendix B.</li>
                  <li><strong>Gamma Constants & HVL Data:</strong> Standard, commonly-cited values from health physics texts (e.g. Radiological Health Handbook, Plexus-NSD).</li>
                  <li><strong>MARSSIM Formulas:</strong> NUREG-1575 (MARSSIM), NUREG-1507.</li>
              </ul>
            
              <h4 className="italic mt-4">Why doesn't a specific nuclide appear in a calculator?</h4>
              <p>Calculators are populated only with nuclides that have the necessary data for that specific calculation. For example, the <strong>Dose Rate</strong>, <strong>Shielding</strong>, and <strong>Stay Time</strong> calculators all require a nuclide to have a defined "Gamma Constant" (Γ). Therefore, pure beta emitters (like Tritium or Carbon-14) or pure alpha emitters will not be available in those specific tools. Similarly, the **Activation Calculator** only lists target nuclides known to produce common activation products.</p>
            
              {/* --- CONTACT SECTION --- */}
              <hr className="my-4" />
              <h2 className="text-slate-900 dark:text-slate-100"><strong>Contact & Bug Reports</strong></h2>
              <div className="bg-slate-100 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                  <p className="mb-2"><strong>Found a bug or have a feature request?</strong></p>
                  <p className="text-sm">
                      This tool is actively maintained. Your feedback helps improve accuracy and usability.
                      Please include the <strong>Browser/OS version</strong> and a <strong>description</strong> of the issue.
                  </p>
                  <div className="mt-4">
                      <a
                          href="mailto:jough.donakowski@gmail.com?subject=Health Physics Toolbox - Bug Report"
                          className="inline-flex items-center gap-2 px-4 py-2 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition-colors"
                      >
                          <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                          </svg>
                          Send Bug Report
                      </a>
                      <p className="text-xs text-slate-500 mt-2">
                          Or email directly: <strong>jough.donakowski@gmail.com</strong>
                      </p>
                  </div>
              </div>
            
              <h4 className="italic mt-4">Disclaimer</h4>
                <p><strong>This tool is for informational and educational purposes only.</strong> The data and calculations have not been independently peer-reviewed or validated and may contain errors. It should not be used for radiation protection, safety-critical applications, operational decision-making, or for demonstrating regulatory compliance. All use of this tool is at your own risk.</p>

                <hr className="my-4" />

                <h4 className="italic mt-4">Privacy</h4>
                <p>
                    This application operates offline and prioritizes your privacy. 
                    <a 
                        href="privacy.html" 
                        target="_blank" 
                        className="ml-1 text-sky-600 dark:text-sky-400 font-bold hover:underline"
                    >
                        Read the full Privacy Policy
                    </a>.
                </p>
            </div>
            );
            };
            
            return (
            <div className="fixed inset-0 bg-black/60 z-[5000] flex justify-center items-start p-4" onClick={onClose}>
            <div className="bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
              <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                  <h2 className="text-xl font-bold">User Manual & FAQ</h2>
                  <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                      <Icon path={ICONS.clear} className="w-6 h-6" />
                  </button>
              </div>
              <div className="overflow-y-auto">
                  <ManualContent />
              </div>
            </div>
            </div>
            );
            };
            
            /**
            * @description The root component of the entire application.
            * It manages all primary state, handles routing between views, and orchestrates all user interactions.
            */
            
            const App = () => {
            // --- 1. SETTINGS CONTEXT & THEME RESOLUTION ---
            const { settings, updateSettings } = React.useContext(SettingsContext);
            
            // Resolve 'system' setting to actual 'dark' or 'light' string for charts/icons
            const getEffectiveTheme = () => {
            if (settings.theme === 'system') {
               return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            return settings.theme;
            };
            
            // Define 'theme' so it can be passed to Header and Calculators
            const theme = getEffectiveTheme();
            
            const toggleTheme = () => {
            // If current is dark, switch to light, otherwise dark
            updateSettings({ theme: theme === 'dark' ? 'light' : 'dark' });
            };
            
            // --- 2. EXISTING STATE ---
            
            const [activeView, setActiveView] = React.useState(VIEWS.HOME);
            
            const [previousView, setPreviousView] = React.useState(VIEWS.HOME);
            
            const [showCalcPopout, setShowCalcPopout] = React.useState(false);
            const [showScratchpadPopout, setShowScratchpadPopout] = React.useState(false);
            const [detailedNuclide, setDetailedNuclide] = React.useState(null);
            const [errorMessage, setErrorMessage] = React.useState('');
            const [preselectedNuclide, setPreselectedNuclide] = React.useState(null);
            const [comparisonList, setComparisonList] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideComparisonList') || '[]'); } catch (e) { return []; } });
            const [nuclideName, setNuclideName] = React.useState('');
            const debouncedSearchTerm = useDebounce(nuclideName, 250);
            const [suggestions, setSuggestions] = React.useState([]);
            const [activeSuggestionIndex, setActiveSuggestionIndex] = React.useState(-1);
            const [isManualOpen, setIsManualOpen] = React.useState(false);
            const [isFiltersVisible, setIsFiltersVisible] = React.useState(false);
            const [displayHalfLifeUnit, setDisplayHalfLifeUnit] = React.useState('years');
            const [currentDecaySeriesId, setCurrentDecaySeriesId] = React.useState(null);
            
            const [searchHistory, setSearchHistory] = React.useState(() => { try { return JSON.parse(localStorage.getItem('radionuclideSearchHistory') || '[]'); } catch (e) { return []; } });
            const [favorites, setFavorites] = React.useState(() => { try { return JSON.parse(localStorage.getItem('favoriteNuclides') || '[]'); } catch (e) { return []; } });
            const [randomSuggestions, setRandomSuggestions] = React.useState([]);
            const [isSearchFocused, setIsSearchFocused] = React.useState(false);
            
            const [opHpActiveTab, setOpHpActiveTab] = React.useState('surfaceContam');
            
            const [scientificCalculatorState, setScientificCalculatorState] = React.useState(() => {
            const savedState = localStorage.getItem('scientificCalculatorState');
            return savedState ? JSON.parse(savedState) : { expression: '', result: '', history: [], memory: 0 };
            });
            
            // Add this useEffect to save the state whenever it changes
            React.useEffect(() => {
            localStorage.setItem('scientificCalculatorState', JSON.stringify(scientificCalculatorState));
            }, [scientificCalculatorState]);
            
            const [scratchpadNotes, setScratchpadNotes] = React.useState(
            () => localStorage.getItem('user_scratchpad_notes') || ''
            );
            
            const [sortBy, setSortBy] = React.useState(() => localStorage.getItem('filterSortBy') || 'name');
            const [sortOrder, setSortOrder] = React.useState(() => localStorage.getItem('filterSortOrder') || 'asc');
            const [selectedCategory, setSelectedCategory] = React.useState(() => localStorage.getItem('filterCategory') || 'All');
            const [selectedEmissionType, setSelectedEmissionType] = React.useState(() => localStorage.getItem('filterEmissionType') || 'All');
            const [selectedCommonality, setSelectedCommonality] = React.useState(() => localStorage.getItem('filterCommonality') || 'All');
            const [minAlphaEnergy, setMinAlphaEnergy] = React.useState(() => localStorage.getItem('filterMinAlphaEnergy') || '');
            const [maxAlphaEnergy, setMaxAlphaEnergy] = React.useState(() => localStorage.getItem('filterMaxAlphaEnergy') || '');
            const [minBetaEnergy, setMinBetaEnergy] = React.useState(() => localStorage.getItem('filterMinBetaEnergy') || '');
            const [maxBetaEnergy, setMaxBetaEnergy] = React.useState(() => localStorage.getItem('filterMaxBetaEnergy') || '');
            const [minGammaEnergy, setMinGammaEnergy] = React.useState(() => localStorage.getItem('filterMinGammaEnergy') || '');
            const [maxGammaEnergy, setMaxGammaEnergy] = React.useState(() => localStorage.getItem('filterMaxGammaEnergy') || '');
            const [minHalfLife, setMinHalfLife] = React.useState(() => localStorage.getItem('filterMinHalfLife') || '');
            const [maxHalfLife, setMaxHalfLife] = React.useState(() => localStorage.getItem('filterMaxHalfLife') || '');
            const [halfLifeFilterUnit, setHalfLifeFilterUnit] = React.useState(() => localStorage.getItem('filterHalfLifeUnit') || 'years');
            
            const handleSearchFocus = () => setIsSearchFocused(true);
            const handleSearchBlur = () => {
            setTimeout(() => { setIsSearchFocused(false); }, 150);
            };
            
            const handleGoToDetectorResponse = () => {
            //  Pass 'response' as the second argument so handleNavClick knows to set the tab
            handleNavClick(VIEWS.OPERATIONAL_HP, 'response');
            };
            
            React.useEffect(() => {
            const handleHashChange = () => {
            const hash = window.location.hash.replace('#', '');
            const validViews = Object.values(VIEWS);
            let targetView = VIEWS.HOME;
            if (hash && validViews.includes(hash)) {
              targetView = hash;
            } else {
              history.replaceState(null, '', `#${VIEWS.HOME}`);
            }
            setActiveView(targetView);
            
            if (targetView === VIEWS.HOME) {
              setDetailedNuclide(null);
              setNuclideName('');
              setSuggestions([]);
              setErrorMessage('');
            }
            };
            window.addEventListener('hashchange', handleHashChange);
            handleHashChange();
            return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);
            
            const mainContentRef = React.useRef(null);
            const scrollPositionRef = React.useRef(null);
            const inputRef = React.useRef(null);
            const suggestionsRef = React.useRef(null);
            const { addToast } = useToast();
            
            React.useEffect(() => {
            // Check if the new view is HOME and we are on a desktop (width > 768px)
            if (activeView === VIEWS.HOME && window.innerWidth > 768) {
               // Small timeout ensures the render is complete before focusing
               setTimeout(() => {
                   inputRef.current?.focus();
               }, 50);
            }
            }, [activeView]); // Dependency added here
            
            React.useEffect(() => {
            if (sessionStorage.getItem('showResetToast') === 'true') {
            addToast('All settings and saved data have been reset.');
            sessionStorage.removeItem('showResetToast');
            }
            }, [addToast]);
            
            const scrollToMainContent = () => {
              // Only scroll on mobile devices (e.g., width < 768px) 
              // to prevent jarring jumps on desktop where content is already visible.
              if (window.innerWidth < 768 && mainContentRef.current) {
                mainContentRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            };
            
            const handleNavClick = (view, opHpTab = null) => {
            // Save current view as 'previous' if we are changing views,
            // but ignore if we are just going to the Detail view (handled separately)
            // or if we are already on the References page to prevent circular history.
            if (activeView !== view && view !== VIEWS.DETAIL && view !== VIEWS.REFERENCES) {
               setPreviousView(activeView);
            }
            
            if (view !== VIEWS.DETAIL) {
               setDetailedNuclide(null);
            }
            
            // If opHpTab is passed (deep link), it sets it.
            // If undefined/null (normal nav), it clears it.
            setOpHpActiveTab(opHpTab);
            
            // When navigating manually, clear any pre-selections
            setPreselectedNuclide(null);
            setActiveView(view);
            window.location.hash = view;
            scrollToMainContent();
            };
            
            const handleClearSearch = () => {
            setNuclideName('');
            setSuggestions([]);
            setDetailedNuclide(null);
            handleNavClick(VIEWS.HOME);
            inputRef.current?.focus();
            };
            
            const handleSendToCalculator = (viewId, nuclideSymbol) => {
            // Find the full object so calculators can access .symbol property
            const n = radionuclides.find(r => r.symbol === nuclideSymbol);
            setPreselectedNuclide(n);
            window.location.hash = viewId;
            };
            
            const handleAddToCompare = (nuclideSymbol) => {
                const nuclideToAdd = radionuclides.find(n => n.symbol === nuclideSymbol);
                
                if (nuclideToAdd) {
                    setComparisonList(prevList => {
                        // Check for duplicates before adding
                        if (prevList.some(n => n.symbol === nuclideSymbol)) {
                            addToast(`${nuclideToAdd.name} is already in the comparison.`);
                            return prevList;
                        }
                        addToast(`${nuclideToAdd.name} added to comparison.`);
                        return [...prevList, nuclideToAdd];
                    });
                }
                window.location.hash = VIEWS.COMPARE;
            };
            
            const handleRemoveFromCompare = (nuclideSymbol) => { setComparisonList(prevList => prevList.filter(n => n.symbol !== nuclideSymbol)); };
            const handleClearCompare = () => { setComparisonList([]); addToast('Comparison list cleared.'); };
            
            React.useEffect(() => {
            localStorage.setItem('filterSortBy', sortBy);
            localStorage.setItem('filterSortOrder', sortOrder);
            localStorage.setItem('filterCategory', selectedCategory);
            localStorage.setItem('filterEmissionType', selectedEmissionType);
            localStorage.setItem('filterCommonality', selectedCommonality);
            localStorage.setItem('filterMinAlphaEnergy', minAlphaEnergy);
            localStorage.setItem('filterMaxAlphaEnergy', maxAlphaEnergy);
            localStorage.setItem('filterMinBetaEnergy', minBetaEnergy);
            localStorage.setItem('filterMaxBetaEnergy', maxBetaEnergy);
            localStorage.setItem('filterMinGammaEnergy', minGammaEnergy);
            localStorage.setItem('filterMaxGammaEnergy', maxGammaEnergy);
            localStorage.setItem('filterMinHalfLife', minHalfLife);
            localStorage.setItem('filterMaxHalfLife', maxHalfLife);
            localStorage.setItem('filterHalfLifeUnit', halfLifeFilterUnit);
            }, [sortBy, sortOrder, selectedCategory, selectedEmissionType, selectedCommonality, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit]);
            
            React.useEffect(() => {
            localStorage.setItem('radionuclideComparisonList', JSON.stringify(comparisonList));
            }, [comparisonList]);
            
            React.useEffect(() => {
            const handleClickOutside = (e) => {
            if (suggestionsRef.current && !suggestionsRef.current.contains(e.target) && inputRef.current && !inputRef.current.contains(e.target)) {
              setSuggestions([]);
            }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            
            React.useEffect(() => {
            const common = radionuclides.filter(n => n.commonality === 'Common');
            setRandomSuggestions([...common].sort(() => 0.5 - Math.random()).slice(0, 5));
            }, [radionuclides]);
            
            const allCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.category))].sort()], [radionuclides]);
            const allEmissionTypes = React.useMemo(() => ['All', ...[...new Set(radionuclides.flatMap(n => n.emissionType || []))].sort()], [radionuclides]);
            const allCommonalityCategories = React.useMemo(() => ['All', ...[...new Set(radionuclides.map(n => n.commonality).filter(Boolean))].sort()], [radionuclides]);
            
            const getFilteredAndSortedRadionuclides = React.useCallback(() => {
            let filtered = [...radionuclides];
            if (selectedCategory !== 'All') { filtered = filtered.filter(n => n.category === selectedCategory); }
            if (selectedEmissionType !== 'All') { filtered = filtered.filter(n => n.emissionType?.includes(selectedEmissionType)); }
            if (selectedCommonality !== 'All') { filtered = filtered.filter(n => n.commonality === selectedCommonality); }
            
            const filterByEnergyRange = (nuclide, type, min, max) => {
                // Get all energies for this type (e.g., all gamma lines)
                const energies = nuclide.emissionEnergies?.[type] || [];
                
                // If no energies exist for this type...
                if (energies.length === 0) {
                    // ...but the user requested a specific range, exclude this nuclide.
                    if (min || max) return false;
                    // If user didn't request a range, keep it (neutral).
                    return true; 
                }
            
                const minVal = safeParseFloat(min);
                const maxVal = safeParseFloat(max);
            
                // If user inputs are invalid (empty), don't filter out anything based on them.
                const hasMin = !isNaN(minVal);
                const hasMax = !isNaN(maxVal);
                
                if (!hasMin && !hasMax) return true;
            
                // Check if AT LEAST ONE energy in the array meets the criteria
                // Previously, this only checked the first element via parseEnergyToMeV(energies)
                return energies.some(energyStr => {
                    // Use the utility to parse the single string "0.662 MeV" -> 0.662
                    const parts = energyStr.split(' ');
                    let val = safeParseFloat(parts[0]);
                    if (parts[1]?.toLowerCase().includes('kev')) val /= 1000;
                    
                    if (isNaN(val)) return false;
                    
                    if (hasMin && hasMax) return val >= minVal && val <= maxVal;
                    if (hasMin) return val >= minVal;
                    if (hasMax) return val <= maxVal;
                    return true;
                });
            };
            
            if (minAlphaEnergy || maxAlphaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'alpha', minAlphaEnergy, maxAlphaEnergy));
            if (minBetaEnergy || maxBetaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'beta', minBetaEnergy, maxBetaEnergy));
            if (minGammaEnergy || maxGammaEnergy) filtered = filtered.filter(n => filterByEnergyRange(n, 'gamma', minGammaEnergy, maxGammaEnergy));
            if (minHalfLife || maxHalfLife) {
            const unitConversions = { 'seconds': 1, 'minutes': 60, 'hours': 3600, 'days': 86400, 'years': 31557600 };
            const minSeconds = minHalfLife ? safeParseFloat(minHalfLife) * unitConversions[halfLifeFilterUnit] : null;
            const maxSeconds = maxHalfLife ? safeParseFloat(maxHalfLife) * unitConversions[halfLifeFilterUnit] : null;
            filtered = filtered.filter(n => {
              const nuclideSeconds = parseHalfLifeToSeconds(n.halfLife);
              if (nuclideSeconds === Infinity && (minSeconds || maxSeconds)) return false;
              const checkMin = minSeconds ? nuclideSeconds >= minSeconds : true;
              const checkMax = maxSeconds ? nuclideSeconds <= maxSeconds : true;
              return checkMin && checkMax;
            });
            }
            filtered.sort((a, b) => {
            let compare = 0;
            if (sortBy === 'name') compare = a.name.localeCompare(b.name);
            else if (sortBy === 'halfLife') compare = parseHalfLifeToSeconds(a.halfLife) - parseHalfLifeToSeconds(b.halfLife);
            else if (sortBy === 'alphaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.alpha) - parseEnergyToMeV(b.emissionEnergies?.alpha);
            else if (sortBy === 'betaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.beta) - parseEnergyToMeV(b.emissionEnergies?.beta);
            else if (sortBy === 'gammaEnergy') compare = parseEnergyToMeV(a.emissionEnergies?.gamma) - parseEnergyToMeV(b.emissionEnergies?.gamma);
            return sortOrder === 'asc' ? compare : -compare;
            });
            return filtered;
            }, [selectedCategory, selectedEmissionType, selectedCommonality, sortBy, sortOrder, minAlphaEnergy, maxAlphaEnergy, minBetaEnergy, maxBetaEnergy, minGammaEnergy, maxGammaEnergy, minHalfLife, maxHalfLife, halfLifeFilterUnit, radionuclides]);
            
            const filteredList = getFilteredAndSortedRadionuclides();
            
            const handleClearHistory = () => { setSearchHistory([]); localStorage.removeItem('radionuclideSearchHistory'); addToast('Search history cleared.'); };
            const handleDecaySeriesClick = (seriesId) => { setCurrentDecaySeriesId(seriesId); window.location.hash = VIEWS.DECAY_SERIES; };
            const toggleFavorite = (symbol) => { const nuclide = radionuclides.find(n => n.symbol === symbol); const isCurrentlyFavorite = favorites.includes(symbol); const newFavorites = isCurrentlyFavorite ? favorites.filter(s => s !== symbol) : [...favorites, symbol]; setFavorites(newFavorites); localStorage.setItem('favoriteNuclides', JSON.stringify(newFavorites)); if (isCurrentlyFavorite) { addToast(`${nuclide ? nuclide.name : symbol} removed from favorites.`); } else { addToast(`${nuclide ? nuclide.name : symbol} added to favorites!`); } };
            const handleClearFavorites = () => { setFavorites([]); localStorage.removeItem('favoriteNuclides'); addToast('Favorites list cleared.'); };
            const updateSearchHistory = (nuclide) => { setSearchHistory(prev => { const newHistory = [nuclide.symbol, ...prev.filter(symbol => symbol !== nuclide.symbol)]; const limitedHistory = newHistory.slice(0, 5); localStorage.setItem('radionuclideSearchHistory', JSON.stringify(limitedHistory)); return limitedHistory; }); }
            
            const handleNuclideSelection = (nuclide, skipHistory = false) => {
               // Save the current view if we are not already in the detail view.
               if (activeView !== VIEWS.DETAIL) {
                   setPreviousView(activeView);
               }
            
               setNuclideName(nuclide.name);
               
               // Only update history if the flag is FALSE (default behavior)
               if (!skipHistory) {
                   updateSearchHistory(nuclide);
               }
            
               setDetailedNuclide(nuclide);
               setSuggestions([]);
               setErrorMessage('');
               setCurrentDecaySeriesId(null);
               handleNavClick(VIEWS.DETAIL);
            };
            
            
            React.useEffect(() => {
            
            if (debouncedSearchTerm.length > 0) {
            // Don't show suggestions if the search term already matches the displayed nuclide
            if (detailedNuclide && debouncedSearchTerm === detailedNuclide.name) {
            setSuggestions([]);
            return;
            }
            const normVal = normalizeString(debouncedSearchTerm);
            const commonalityOrder = { 'Common': 3, 'Moderate': 2, 'Rare': 1 };
            
            const filtered = radionuclides
            .filter(n => normalizeString(n.name).includes(normVal) || normalizeString(n.symbol).includes(normVal))
            .sort((a, b) => {
              const orderA = commonalityOrder[a.commonality] || 0;
              const orderB = commonalityOrder[b.commonality] || 0;
              if (orderB !== orderA) return orderB - orderA; // Sort by commonality first
              return a.name.localeCompare(b.name); // Then alphabetically
            })
            .slice(0, 10);
            
            setSuggestions(filtered);
            } else {
            // If the search term is empty, clear suggestions and the detailed result.
            setSuggestions([]);
            if (detailedNuclide) { // Only change state if there's something to clear
            setDetailedNuclide(null);
            handleNavClick(VIEWS.HOME);
            }
            }
            }, [debouncedSearchTerm, radionuclides]); // Simplified dependencies
            
            const handleNuclideNameChange = (e) => {
            setNuclideName(e.target.value);
            if (e.target.value.length > 0) {
            setSelectedCategory('All');
            setSelectedEmissionType('All');
            setSelectedCommonality('All');
            setMinAlphaEnergy('');
            setMaxAlphaEnergy('');
            setMinBetaEnergy('');
            setMaxBetaEnergy('');
            setMinGammaEnergy('');
            setMaxGammaEnergy('');
            setMinHalfLife('');
            setMaxHalfLife('');
            }
            };
            
            const handleClearFilters = () => { setSortBy('name'); setSortOrder('asc'); setSelectedCategory('All'); setSelectedEmissionType('All'); setSelectedCommonality('All'); setMinAlphaEnergy(''); setMaxAlphaEnergy(''); setMinBetaEnergy(''); setMaxBetaEnergy(''); setMinGammaEnergy(''); setMaxGammaEnergy(''); setMinHalfLife(''); setMaxHalfLife(''); setHalfLifeFilterUnit('years'); };
            
            const handleLookup = () => {
            setSuggestions([]);
            const normInput = normalizeString(nuclideName);
            const found = radionuclides.find(n => normalizeString(n.name) === normInput || normalizeString(n.symbol) === normInput);
            if (found) {
            handleNuclideSelection(found);
            } else {
            setDetailedNuclide(null);
            setErrorMessage(`Nuclide "${nuclideName}" not found.`);
            setActiveView(VIEWS.HOME);
            }
            };
            
            const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
            if (activeSuggestionIndex !== -1 && suggestions.length > 0) {
              handleNuclideSelection(suggestions[activeSuggestionIndex]);
            } else {
              handleLookup();
            }
            } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            setActiveSuggestionIndex(prev => (prev < suggestions.length - 1 ? prev + 1 : 0));
            } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            setActiveSuggestionIndex(prev => (prev > 0 ? prev - 1 : suggestions.length - 1));
            } else if (e.key === 'Escape') {
            setSuggestions([]);
            }
            };
            
            const renderActiveView = () => {
            const filterProps = { sortBy, setSortBy, sortOrder, setSortOrder, selectedCategory, setSelectedCategory, allCategories, selectedEmissionType, setSelectedEmissionType, allEmissionTypes, selectedCommonality, setSelectedCommonality, allCommonalityCategories, minAlphaEnergy, setMinAlphaEnergy, maxAlphaEnergy, setMaxAlphaEnergy, minBetaEnergy, setMinBetaEnergy, maxBetaEnergy, setMaxBetaEnergy, minGammaEnergy, setMinGammaEnergy, maxGammaEnergy, setMaxGammaEnergy, minHalfLife, setMinHalfLife, maxHalfLife, setMaxHalfLife, halfLifeFilterUnit, setHalfLifeFilterUnit, clearFilters: handleClearFilters };
            switch (activeView) {
            case VIEWS.DATABASE: return <DatabaseView filteredList={filteredList} onNuclideClick={handleNuclideSelection} filterProps={filterProps} isFiltersVisible={isFiltersVisible} setIsFiltersVisible={setIsFiltersVisible} scrollPositionRef={scrollPositionRef} handleClearFilters={handleClearFilters} />;
            case VIEWS.CALCULATOR: return <DecayTools radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} theme={theme} />;
            case VIEWS.MDA:
               return <MDACalculator onNavClick={handleNavClick} onDeepLink={handleGoToDetectorResponse} />;
            case VIEWS.MARSSIM_SAMPLES: return <MARSSIM_SampleDesign />;
            case VIEWS.WRS_TEST: return <WRS_Calculator />;
            case VIEWS.EMC_TEST: return <EMC_Calculator />;
            
            case VIEWS.SERIES_CALCULATOR:
            return <DecaySeriesCalculator
            radionuclides={radionuclides}
            decaySeriesData={decaySeriesData}
            theme={theme}
            onNuclideClick={handleNuclideSelection}
            />;
            case VIEWS.EQUILIBRIUM: return <EquilibriumCalculator radionuclides={radionuclides} theme={theme} />;
            case VIEWS.RADON: return <RadonCalculator />;
            case VIEWS.COMPARE: return <ComparisonView radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} comparisonList={comparisonList} onAddToCompare={handleAddToCompare} onRemoveFromCompare={handleRemoveFromCompare} onClearCompare={handleClearCompare} />;
            case VIEWS.ACTIVITY_MASS: return <ActivityAndMassTools radionuclides={radionuclides} />;
            case VIEWS.DOSE_RATE: return <DoseRateCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.SHIELDING: return <ShieldingCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.STAY_TIME: return <StayTimeCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.NEUTRON: return <NeutronCalculator radionuclides={radionuclides} />;
            case VIEWS.OPERATIONAL_HP: return <OperationalHPCalculators radionuclides={radionuclides} initialTab={opHpActiveTab} />;
            case VIEWS.TRANSPORTATION: return <TransportationCalculator radionuclides={radionuclides} preselectedNuclide={preselectedNuclide} />;
            case VIEWS.CONVERTER: return <UnitConverter />;
            case VIEWS.LAB_STATS: return <LabStatistics />;
            case VIEWS.PEAK_ID: return <PeakIdentifier radionuclides={radionuclides} onNuclideClick={handleNuclideSelection} />;
            case VIEWS.SETTINGS: return <SettingsPanel />;
            case VIEWS.MARSSIM_TESTS: return <MARSSIM_Statistical_Tests />;
            case VIEWS.DECAY_SERIES: return <DecaySeriesViewer seriesId={currentDecaySeriesId} onBack={() => { setDetailedNuclide(null); handleNavClick(VIEWS.HOME); }} onNuclideClick={handleNuclideSelection} />;
            case VIEWS.DETAIL:
            
            if (detailedNuclide) {
            return (
            <div className="p-4">
              <NuclideCard
                  nuclide={detailedNuclide}
                  radionuclides={radionuclides}
                  onDecaySeriesClick={handleDecaySeriesClick}
                  displayHalfLifeUnit={displayHalfLifeUnit}
                  favorites={favorites}
                  toggleFavorite={toggleFavorite}
                  onSendToCalculator={handleSendToCalculator}
                  onAddToCompare={handleAddToCompare}
                  onNuclideClick={handleNuclideSelection}
                  showBackButton={true}
                  // Navigates to the stored previous view
                  onBackClick={() => handleNavClick(previousView)}
              />
            </div>
            );
            }
              return <HomePage errorMessage={errorMessage} randomSuggestions={randomSuggestions} searchHistory={searchHistory} handleNuclideSelection={handleNuclideSelection} handleClearHistory={handleClearHistory} favorites={favorites} radionuclides={radionuclides} handleClearFavorites={handleClearFavorites} onNavClick={handleNavClick} />;
            case VIEWS.MEDICAL:return <MedicalCalculator radionuclides={radionuclides} />;
            
            case VIEWS.SCRATCHPAD:
            return (
            <div className="p-4 animate-fade-in">
            <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col">
            <div className="flex justify-between items-center mb-4">
             <h2 className="text-xl font-bold text-slate-800 dark:text-white">Scratchpad</h2>
             <Tooltip text="Open in New Window" widthClass="w-auto">
                 <button onClick={() => setShowScratchpadPopout(true)} className="p-2 text-slate-400 hover:text-sky-500 transition-colors">
                     <Icon path={ICONS.popOut} className="w-5 h-5" />
                 </button>
             </Tooltip>
            </div>
            {/* Pass the centralized state down to the Scratchpad component */}
            <Scratchpad notes={scratchpadNotes} setNotes={setScratchpadNotes} />
            </div>
            </div>
            );
            
            case VIEWS.SCIENTIFIC_CALCULATOR: return ( <div className="p-4 animate-fade-in"><div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 dark:text-white">Scientific Calculator</h2><Tooltip text="Open in New Window" widthClass="w-auto"><button onClick={() => setShowCalcPopout(true)} className="p-2 text-slate-400 hover:text-sky-500 transition-colors"><Icon path={ICONS.popOut} className="w-5 h-5" /></button></Tooltip></div><ScientificCalculator calcState={scientificCalculatorState} setCalcState={setScientificCalculatorState} /></div></div> );
            
            case VIEWS.REFERENCES: return <ReferencesPage onNavClick={handleNavClick} previousView={previousView} />;
            
            case VIEWS.HOME:
            default:
              return <HomePage errorMessage={errorMessage} randomSuggestions={randomSuggestions} searchHistory={searchHistory} handleNuclideSelection={handleNuclideSelection} handleClearHistory={handleClearHistory} favorites={favorites} radionuclides={radionuclides} handleClearFavorites={handleClearFavorites} onNavClick={handleNavClick} />;
            }
            };
            
            return (
            <div className="min-h-screen p-0 sm:p-2 md:p-4 text-slate-800 dark:text-slate-200">
            <div className="max-w-7xl mx-auto bg-white dark:bg-slate-900/70 rounded-none sm:rounded-2xl shadow-2xl backdrop-blur-lg border-slate-200 dark:border-slate-800">
              <Header onHelpClick={() => setIsManualOpen(true)} theme={theme} toggleTheme={toggleTheme} onNavClick={handleNavClick} />
              <SearchBar
                  nuclideName={nuclideName}
                  inputRef={inputRef}
                  handleNuclideNameChange={handleNuclideNameChange}
                  handleKeyDown={handleKeyDown}
                  onClear={handleClearSearch}
                  suggestions={suggestions}
                  activeSuggestionIndex={activeSuggestionIndex}
                  suggestionsRef={suggestionsRef}
                  handleNuclideSelection={handleNuclideSelection}
                  onNavClick={handleNavClick}
                  isFocused={isSearchFocused}
                  onFocus={handleSearchFocus}
                  onBlur={handleSearchBlur}
              />
              <MainNav activeView={activeView} onNavClick={handleNavClick} />
              <main ref={mainContentRef} className="min-h-[400px]">{renderActiveView()}</main>
              <footer className="text-center p-6 mt-4 border-t border-slate-200 dark:border-slate-700">
                  <p className="text-xs text-slate-500 dark:text-slate-400"><strong>Disclaimer:</strong> This tool is for informational and educational purposes only. The data and calculations have not been validated and may contain errors. Use of this tool is at your own risk.</p>
                  <div className="mt-4 flex justify-center md:hidden"><a href="https://www.buymeacoffee.com/jough" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style={{ height: '36px', width: 'auto' }} /></a></div>
              </footer>
              <ManualModal isOpen={isManualOpen} onClose={() => setIsManualOpen(false)} />
            
              {showCalcPopout && (
                  <PopoutWindow
                      title="Scientific Calculator"
                      onClose={() => setShowCalcPopout(false)}
                      height={850}
                  >
                      <div className={`${theme} bg-slate-100 dark:bg-slate-900 h-full p-4`}>
                          <div className="max-w-md mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                              <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Scientific Calculator</h2>
                              <ScientificCalculator calcState={scientificCalculatorState} setCalcState={setScientificCalculatorState} />
                          </div>
                      </div>
                  </PopoutWindow>
              )}
            
            {showScratchpadPopout && (
            <PopoutWindow
            title="Scratchpad"
            onClose={() => setShowScratchpadPopout(false)}
            width={800}
            height={660}
            >
            <div className={`${theme} bg-slate-100 dark:bg-slate-900 h-full p-4`}>
            <div className="max-w-4xl mx-auto bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col h-full">
            <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4">Scratchpad</h2>
            <div className="flex-grow flex flex-col">
            {/* Pass the centralized state down to the pop-out component */}
            <Scratchpad notes={scratchpadNotes} setNotes={setScratchpadNotes} />
            </div>
            </div>
            </div>
            </PopoutWindow>
            )}
            </div>
            </div>
            );
            };          
                        
            // Final step: Render the main App component into the DOM.
            
            ReactDOM.createRoot(document.getElementById('root')).render(
            <SettingsProvider>
            <ToastProvider>
                <App />
            </ToastProvider>
            </SettingsProvider>
            );
            
            ReactDOM.createRoot(document.getElementById('back-to-top-root')).render(
            <BackToTopButton />
            );
            
            // After the app is rendered, find the loader and fade it out.
            
            const loader = document.getElementById('loader');
            if (loader) {
            
            // A small timeout ensures the app has painted before the loader disappears.
            
            setTimeout(() => {
            
            loader.classList.add('hidden');
            }, 100); // 100ms delay
            }
        </script>
    </body>
</html>
