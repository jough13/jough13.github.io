<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortable Radioactive Commodity Lookup Table</title>
    
    <!-- The main Tailwind CSS script MUST be loaded before the configuration script. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind CSS to use the 'class' strategy for dark mode.
        // This tells Tailwind to apply dark styles whenever the 'dark' class is present on the <html> element.
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the sticky header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Styles for sortable columns and arrows */
        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .sortable .sort-arrow {
            display: inline-block;
            width: 1em;
            height: 1em;
            opacity: 0.4;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .sortable .sort-arrow.asc,
        .sortable .sort-arrow.desc {
            opacity: 1;
        }
        .sortable .sort-arrow.asc::after {
            content: '▲';
            font-size: 0.6em;
        }
        .sortable .sort-arrow.desc::after {
            content: '▼';
            font-size: 0.6em;
        }
        /* NEW: Style for the currently sorted column header */
        .sorted-column {
            background-color: #e5e7eb; /* gray-200 */
        }
        .dark .sorted-column {
            background-color: #4b5563; /* gray-600 */
        }
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2563eb;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Style for selected rows */
        .selected-row {
            background-color: #fef9c3; /* A light yellow, works in both light and dark mode */
        }
        .dark .selected-row {
            background-color: #4a4a2a; /* A darker yellow for dark mode */
        }
        tr td:not(:first-child):not(.radionuclide-link) {
            cursor: pointer;
        }
        
        /* Styles for new progress/bar charts */
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            overflow: hidden;
            margin-top: 0.25rem; /* mt-1 */
        }
        .dark .progress-bar-container {
            background-color: #374151; /* dark:bg-gray-700 */
        }
        .progress-bar {
            height: 100%;
            border-radius: 0.375rem; /* rounded-md */
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.4);
        }

        /* Style for custom-added rows */
        .custom-row {
            background-color: #eff6ff; /* blue-50 */
        }
        .dark .custom-row {
            background-color: #1e3a8a; /* A deep blue for dark mode */
        }
        .dark .custom-row:hover {
            background-color: #1e40af; /* A slightly lighter blue for hover */
        }
        
        /* NEW: Styles for mobile details toggle */
        .toggle-cell {
            display: none;
        }
        .details-toggle-btn {
            width: 100%;
            padding: 0.5rem;
            font-weight: 600;
            color: #3b82f6; /* blue-500 */
            border-radius: 0.5rem;
            background-color: transparent;
            transition: background-color 0.2s;
        }
        .details-toggle-btn:hover {
            background-color: #dbeafe; /* blue-100 */
        }
        .dark .details-toggle-btn {
            color: #60a5fa; /* blue-400 */
        }
        .dark .details-toggle-btn:hover {
            background-color: #374151; /* gray-700 */
        }

        /* NEW: Toast Notification Styles */
        #toastContainer {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            animation: toast-fade-in 0.3s ease-out;
        }
        .toast.success { background-color: #22c55e; } /* green-500 */
        .toast.error { background-color: #ef4444; } /* red-500 */
        .toast.info { background-color: #3b82f6; } /* blue-500 */
        
        @keyframes toast-fade-in {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toast-fade-out {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .toast.fade-out {
            animation: toast-fade-out 0.3s ease-in forwards;
        }


        /* Responsive Table Styles */
        @media (max-width: 1024px) {
            #lookupTable thead {
                display: none;
            }
            #lookupTable, #lookupTable tbody, #lookupTable tr, #lookupTable td {
                display: block;
                width: 100%;
            }
            #lookupTable tr {
                margin-bottom: 1.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                overflow: hidden;
            }
            .dark #lookupTable tr {
                border-color: #374151;
            }
            #lookupTable td {
                display: flex;
                justify-content: space-between;
                padding: 0.75rem 1rem;
                text-align: right;
                border-bottom: 1px solid #e5e7eb;
            }
            .dark #lookupTable td {
                border-color: #374151;
            }
            #lookupTable td:last-child {
                border-bottom: none;
            }
            #lookupTable td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                padding-right: 1rem;
                white-space: nowrap;
            }
            .dark #lookupTable td::before {
                color: #d1d5db;
            }

            /* NEW: Mobile view improvements */
            #lookupTable td.expandable {
                display: none;
            }
            #lookupTable tr.details-visible td.expandable {
                display: flex;
            }
            #lookupTable td.toggle-cell {
                display: flex;
                justify-content: center;
                background-color: #f3f4f6; /* gray-100 */
                border-bottom: none;
            }
            .dark #lookupTable td.toggle-cell {
                background-color: #1f2937; /* gray-800 */
            }

            /* Special handling for the first two cells (Checkbox and Name) */
            #lookupTable td:first-child {
                justify-content: center; /* Center the checkbox */
                background-color: #f9fafb;
            }
            .dark #lookupTable td:first-child {
                background-color: #1f2937;
            }
            #lookupTable tr.custom-row td:first-child {
                background-color: #dbeafe;
            }
            .dark #lookupTable tr.custom-row td:first-child {
                background-color: #1e3a8a;
            }

            #lookupTable td:nth-child(2) {
                font-size: 1.125rem; /* lg */
                font-weight: 600;
                justify-content: center;
                text-align: center;
                background-color: #f9fafb;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            .dark #lookupTable td:nth-child(2) {
                background-color: #1f2937;
            }
            #lookupTable tr.custom-row td:nth-child(2) {
                background-color: #dbeafe;
            }
            .dark #lookupTable tr.custom-row td:nth-child(2) {
                background-color: #1e3a8a;
            }
            #lookupTable td:nth-child(2)::before {
                display: none; /* Hide the "Name or Nomenclature" label */
            }
        }
    </style>
    <script>
        // This script runs immediately to set the dark mode class on initial load.
        // This prevents a "flash of incorrect theme" while the page is loading.
        if (localStorage.getItem('darkMode') === 'enabled' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-300 transition-colors duration-300">
    
    <!-- NEW: Toast Notification Container -->
    <div id="toastContainer"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Radioactive Commodity Lookup</h1>
                <p class="mt-2 text-gray-600 dark:text-gray-400">A searchable and sortable database of items with NRC and DOT exemption values.</p>
            </div>

            <!-- Controls: Search and Toggles -->
            <div class="p-6 bg-gray-50 dark:bg-gray-900/50 flex flex-col gap-4">
                <div class="flex flex-col lg:flex-row items-center gap-4 w-full">
                    <div class="w-full lg:flex-grow flex flex-col sm:flex-row items-center gap-4">
                        <input type="text" id="searchInput" placeholder="Search by name, NSN, NIIN..." class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" autocomplete="off">
                        <select id="radionuclideFilter" class="px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 w-full sm:w-auto">
                            <!-- Options will be populated by script -->
                        </select>
                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 whitespace-nowrap">Clear Filters</button>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap justify-center">
                        <button id="addItemBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Add New Item</button>
                        <button id="importCustomBtn" class="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">Import Custom</button>
                        <button id="exportCustomBtn" class="px-4 py-2 bg-cyan-700 text-white rounded-lg hover:bg-cyan-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Export Custom</button>
                        <button id="clearAddedBtn" class="px-4 py-2 bg-indigo-700 text-white rounded-lg hover:bg-indigo-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Clear Added</button>
                        <button id="packageBuilderBtn" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Build Package</button>
                        <button id="compareBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Compare</button>
                        <button id="exportSelectionBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Export Selection</button>
                        <button id="clearSelectionBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Clear</button>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-6 w-full pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="nrcExemptFilter" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="text-gray-700 dark:text-gray-300">NRC Exempt Only</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="dotExemptFilter" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="text-gray-700 dark:text-gray-300">DOT Exempt Only</span>
                        </label>
                    </div>
                    <div class="flex-grow"></div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button id="saveSelectionBtn" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Save</button>
                        <button id="loadSelectionBtn" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Load</button>
                        <button id="clearSavedBtn" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Clear Saved</button>
                        <button id="helpBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Help</button>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <span class="font-medium text-sm sm:text-base text-gray-700 dark:text-gray-300">Ci</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="unitToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="font-medium text-sm sm:text-base text-gray-700 dark:text-gray-300">Bq</span>
                    </div>
                     <div class="flex items-center gap-2 sm:gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-700 dark:text-gray-300"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Table Container with Scrolling -->
            <div class="overflow-x-auto">
                <table id="lookupTable" class="w-full text-sm text-gray-600 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-100 dark:bg-gray-700 sticky-header">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center">
                                <input type="checkbox" id="selectAllCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            </th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('name')">Name or Nomenclature<span class="sort-arrow"></span></th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('nsn')">National Stock # (NSN)<span class="sort-arrow"></span></th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('niin')">NIIN<span class="sort-arrow"></span></th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('radionuclide')">Radionuclide<span class="sort-arrow"></span></th>
                            <th id="activityHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('activity_val')">Activity<span class="sort-arrow"></span></th>
                            <th id="nrcExemptionHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('nrc_exemption_val')">NRC Exemption<span class="sort-arrow"></span></th>
                            <th id="dotExemptionHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('dot_exemption_val')">DOT Exemption<span class="sort-arrow"></span></th>
                            <th id="un2911Header" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('un2911_limit_val')">UN 2911 Limit (per item)<span class="sort-arrow"></span></th>
                            <th id="un2911PkgHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('un2911_pkg_limit_val')">UN 2911 Limit (per package)<span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody class="dark:divide-gray-700">
                        <!-- Data rows will be injected here by the script -->
                    </tbody>
                </table>
            </div>
             <div id="noResults" class="hidden p-6 text-center text-gray-500 dark:text-gray-400">
                No results found.
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500 dark:text-gray-400">
            <p>Data provided for informational purposes. NRC values from 10 CFR 30.71. DOT values from 49 CFR § 173.425, § 173.435, & § 173.436.</p>
            <p class="mt-2">Version 1.76 | Last Updated: August 6, 2025</p>
        </footer>
    </div>

    <!-- Comparison Modal -->
    <div id="compareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Compare Selected Items</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div id="compareContent" class="p-6">
                <!-- Comparison table will be injected here -->
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="detailModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Item Details</h2>
                <button id="closeDetailModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div id="detailContent" class="p-6">
                <!-- Detail content will be injected here -->
            </div>
            <div id="detailActions" class="p-4 border-t dark:border-gray-700 flex justify-between items-center">
                <!-- Action buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- Package Builder Modal -->
    <div id="packageBuilderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Package Builder</h2>
                <button id="closePackageBuilderModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div id="packageBuilderContent" class="p-6">
                <!-- Package builder content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">User Guide</h2>
                <button id="closeHelpModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="prose prose-lg dark:prose-invert max-w-none space-y-4">
                    <div>
                        <h2 class="!mb-2 font-bold">1. Overview</h2>
                        <p>This tool is a dynamic, searchable database designed to help you quickly look up information on various radioactive commodities. You can search, sort, and filter a comprehensive list of items, view their activity levels in different units, and compare them against key regulatory limits from the NRC and DOT.</p>
                    </div>
                    <hr class="dark:border-gray-600">
                    <div>
                        <h2 class="!mb-2 font-bold">2. Core Features</h2>
                        <div class="space-y-4 pl-4">
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">2.1 Searching and Filtering</h3>
                                <p>You have several powerful tools to narrow down the list to find exactly what you're looking for:</p>
                                <ul>
                                    <li><strong>Text Search:</strong> Simply type in the search bar to filter by <strong>Name</strong>, <strong>NSN</strong>, or <strong>NIIN</strong>. The table will update in real-time as you type.</li>
                                    <li><strong>Radionuclide Filter:</strong> Use the dropdown menu to display only items containing a specific radionuclide. Select "All Radionuclides" to clear this filter.</li>
                                    <li><strong>Exemption Filters:</strong>
                                        <ul>
                                            <li><strong>NRC Exempt Only:</strong> Check this box to show only items whose activity is at or below the NRC exemption limit.</li>
                                            <li><strong>DOT Exempt Only:</strong> Check this box to show only items whose activity is at or below the DOT exemption limit for consignments.</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>All filters work together, allowing you to create highly specific queries.</p>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">2.2 Sorting</h3>
                                <p>Every column in the table is sortable.</p>
                                <ul>
                                    <li><strong>Click a column header once</strong> to sort it in ascending order (A-Z, 0-9).</li>
                                    <li><strong>Click the same header again</strong> to sort in descending order (Z-A, 9-0). An arrow (▲ or ▼) will appear to indicate the current sort direction.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">2.3 Unit Conversion & Dark Mode</h3>
                                <ul>
                                    <li><strong>Ci/Bq Toggle:</strong> Use the toggle switch to instantly convert all activity and limit values between traditional units (Curies) and SI units (Becquerels).</li>
                                    <li><strong>Dark Mode:</strong> Click the sun/moon icon toggle to switch between light and dark themes for comfortable viewing. Your preference will be saved in your browser.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr class="dark:border-gray-600">
                    <div>
                        <h2 class="!mb-2 font-bold">3. Interactive Tools</h2>
                        <div class="space-y-4 pl-4">
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.1 Selecting Items</h3>
                                <p>Click the checkbox in the first column of any row to "select" an item. The row will highlight in yellow. This enables the action buttons at the top of the table.</p>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.2 Action Buttons</h3>
                                <p>Once you have selected one or more items, the following buttons will become active:</p>
                                <ul>
                                    <li><strong>Add New Item:</strong> Opens a form to add a custom item to the table.</li>
                                    <li><strong>Import/Export Custom:</strong> Save your custom-added items to a file or load them from a file. This is useful for backups or sharing with others.</li>
                                    <li><strong>Clear Added:</strong> Removes all custom items you have added.</li>
                                    <li><strong>Build Package:</strong> (Requires 1+ items) Opens a powerful calculator to determine the shipping classification of your items.</li>
                                    <li><strong>Compare:</strong> (Requires 2+ items) Opens a pop-up that displays a side-by-side comparison of the selected items.</li>
                                    <li><strong>Export Selection:</strong> (Requires 1+ items) Downloads a <code>.csv</code> file of the selected items, with values reflecting the current Ci/Bq unit setting.</li>
                                    <li><strong>Clear:</strong> (Requires 1+ items) Instantly deselects all checked items.</li>
                                    <li><strong>Save:</strong> (Requires 1+ items) Stores your current selection in your browser's local storage so you can return to it later.</li>
                                    <li><strong>Load:</strong> (Requires a saved selection) Clears any current selections and restores your previously saved group.</li>
                                    <li><strong>Clear Saved:</strong> Removes a saved selection from your browser's memory.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.3 Detail View</h3>
                                <p>Click anywhere on a row (except the "Select" column) to open a detailed pop-up view for that specific item. This view shows:</p>
                                <ul>
                                    <li>NSN and NIIN for easy copying.</li>
                                    <li>A direct link to look up the item on ISO-Group.com.</li>
                                    <li>A clear, color-coded comparison of the item's activity against all relevant regulatory limits (NRC, DOT, UN 2911).</li>
                                    <li>A clickable info icon <svg class="inline-block w-4 h-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg> next to each limit for a plain-language explanation.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.4 Package Builder</h3>
                                <p>This is the most powerful feature for practical use. After selecting one or more items and clicking "Build Package," a modal appears where you can:</p>
                                <ol>
                                    <li><strong>Enter Quantities:</strong> Input the number of each selected item you are grouping together.</li>
                                    <li><strong>Analyze Classification:</strong> The tool automatically calculates the Sum of Ratios (SOR) for different regulatory limits and provides a final classification for your package:
                                        <ul>
                                            <li><strong>Exempt Consignment:</strong> The package meets the DOT's requirements for exemption and can be shipped without most hazmat regulations.</li>
                                            <li><strong>Excepted Package (UN 2911):</strong> The package meets the limits for shipment as an excepted package, which has reduced regulatory requirements.</li>
                                            <li><strong>Regulated as Class 7 (Requires Type A Package):</strong> The package exceeds the limits for both Exempt and Excepted status and must be shipped as fully regulated Class 7 hazardous material.</li>
                                        </ul>
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <hr class="dark:border-gray-600">
                    <div>
                        <h2 class="!mb-2 font-bold">4. Helpful Links & References</h2>
                        <div class="space-y-4 pl-4">
                            <ul>
                                <li><a href="https://www.nrc.gov/reading-rm/doc-collections/cfr/part030/part030-0071.html" target="_blank" class="text-blue-500 hover:underline">10 CFR § 30.71 - NRC Exempt Concentrations</a></li>
                                <li><a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173" target="_blank" class="text-blue-500 hover:underline">49 CFR Part 173 - DOT Shippers General Requirements</a></li>
                                <li><a href="https://www.iso-group.com/nsn-search" target="_blank" class="text-blue-500 hover:underline">ISO-Group NSN Search</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="addItemModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Add Custom Item</h2>
                <button id="closeAddItemModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="addItemForm" class="space-y-4">
                    <input type="hidden" id="itemEditId">
                    <div>
                        <label for="itemName" class="block mb-1 font-medium">Name or Nomenclature*</label>
                        <input type="text" id="itemName" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="itemNsn" class="block mb-1 font-medium">NSN</label>
                        <input type="text" id="itemNsn" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="itemRadionuclide" class="block mb-1 font-medium">Radionuclide*</label>
                            <select id="itemRadionuclide" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required></select>
                        </div>
                        <div class="sm:col-span-1">
                            <label for="itemActivity" class="block mb-1 font-medium">Activity*</label>
                            <input type="number" id="itemActivity" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required step="any">
                        </div>
                        <div class="sm:col-span-1">
                            <label for="itemUnits" class="block mb-1 font-medium">Units*</label>
                            <select id="itemUnits" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                                <option>Ci</option>
                                <option>mCi</option>
                                <option>µCi</option>
                                <option>nCi</option>
                                <option>pCi</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-sm italic text-gray-500 dark:text-gray-400 pt-2">*Note: Custom items are saved to your browser's local storage. Clearing your browser's cache or history may remove any items you have added.</p>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancelAddItemBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Cancel</button>
                        <button type="submit" id="saveItemBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFileInput" class="hidden" accept=".json">

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
                <h3 id="confirmModalText" class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Are you sure?</h3>
                <button id="confirmModalConfirmBtn" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
                    Yes, I'm sure
                </button>
                <button id="confirmModalCancelBtn" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">
                    No, cancel
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Radionuclide Detail Modal -->
    <div id="radionuclideDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="radionuclideModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Radionuclide Details</h2>
                <button id="closeRadionuclideModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div id="radionuclideContent" class="p-6">
                <!-- Radionuclide details will be injected here -->
            </div>
        </div>
    </div>

    <!-- NEW: Tooltip Modal -->
    <div id="tooltipModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="tooltipModalTitle" class="text-xl font-bold text-gray-900 dark:text-white"></h2>
                <button id="closeTooltipModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>
            <div id="tooltipContent" class="p-6">
                <!-- Tooltip content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- Raw Data (before processing) ---
        const rawTableData = [
            { name: "M11 Pistol Sight, P/N P00007-8A", nsn: "1005-01-359-8429", radionuclide: "H-3", activity: "18", units: "mCi" },
            { name: "M11 Pistol Sight, P/N P00008-8A", nsn: "1005-01-359-8431", radionuclide: "H-3", activity: "36", units: "mCi" },
            { name: "Handle And Firing Mechanism", nsn: "1010-01-043-2050", radionuclide: "H-3", activity: "3.2", units: "Ci" },
            { name: "Fire Control Instrument Level", nsn: "1200-00-257-2769", radionuclide: "H-3", activity: "80", units: "mCi" },
            { name: "M1A1 Collimator", nsn: "1240-00-332-1780", radionuclide: "H-3", activity: "10", units: "Ci" },
            { name: "Lamp, Radioluminous", nsn: "1240-01-051-8472", radionuclide: "H-3", activity: "0.7", units: "Ci" },
            { name: "Level, Fire Control", nsn: "1240-01-057-0112", radionuclide: "H-3", activity: "0.05", units: "Ci" },
            { name: "Sight, Unit M64A1", nsn: "1240-01-201-8299", radionuclide: "H-3", activity: "4.99", units: "Ci" },
            { name: "Telescope, Elbow", nsn: "1240-01-211-3608", radionuclide: "H-3", activity: "1.6", units: "Ci" },
            { name: "Sight Unit, M67", nsn: "1240-01-366-7322", radionuclide: "H-3", activity: "5.8", units: "Ci" },
            { name: "Mount, Telescope", nsn: "1240-01-379-7953", radionuclide: "H-3", activity: "6.7", units: "Ci" },
            { name: "Self-Luminous Weapon Sight, ACOG", nsn: "1240-01-412-6608", radionuclide: "H-3", activity: "100", units: "mCi" },
            { name: "ACOG Rifle Sight", nsn: "1240-01-435-1916", radionuclide: "H-3", activity: "100", units: "mCi" },
            { name: "Sight Unit, M64", nsn: "1240-01-507-8580", radionuclide: "H-3", activity: "3.20", units: "Ci" },
            { name: "Sight, Bore, Optical (RCO/ACOG)", nsn: "1240-01-525-1648", radionuclide: "H-3", activity: "0.1", units: "Ci" },
            { name: "Sight Reflex Rmr", nsn: "1240-01-581-6250", radionuclide: "H-3", activity: "0.25", units: "Ci" },
            { name: "Weapon Reflex Sight", nsn: "1240-25-150-7592", radionuclide: "H-3", activity: "10", units: "mCi" },
            { name: "Model Amm Source", nsn: "1260-01-510-1032", radionuclide: "Am-241", activity: "8", units: "µCi" },
            { name: "Receiver-Transmitter", nsn: "1270-01-437-6581", radionuclide: "Am-241", activity: "9", units: "µCi" },
            { name: "Stabilizer Optics", nsn: "1280-01-300-0940", radionuclide: "Th-232", activity: "4.00E-02", units: "µCi" },
            { name: "Light Aiming Post M58", nsn: "1290-00-169-1934", radionuclide: "H-3", activity: "5", units: "Ci" },
            { name: "Light Aiming Post M59", nsn: "1290-00-169-1935", radionuclide: "H-3", activity: "9", units: "Ci" },
            { name: "Ice Detector Probe", nsn: "1660-00-077-8473", radionuclide: "Sr-90", activity: "50", units: "µCi" },
            { name: "Regulator, Oxygen Diluter Demand", nsn: "1660-00-252-7796", radionuclide: "Ra-226", activity: "3", units: "µCi" },
            { name: "Probe, Ice Detector", nsn: "1660-00-919-0419", radionuclide: "Sr-90", activity: "50", units: "µCi" },
            { name: "Regulator, Oxygen, Demand", nsn: "1660-00-927-1996", radionuclide: "Ra-226", activity: "1.2", units: "µCi" },
            { name: "ILS Frequency Selector", nsn: "1660-01-483-2581", radionuclide: "Kr-85", activity: "0.2697", units: "µCi" },
            { name: "Regulator, Oxygen, Demand", nsn: "1660-01-492-5521", radionuclide: "Ra-226", activity: "1.2", units: "µCi" },
            { name: "Pod, Aircraft", nsn: "1680-01-186-1430", radionuclide: "Th-232", activity: "0.03", units: "µCi" },
            { name: "ILS Frequency Selector", nsn: "1680-01-415-5778", radionuclide: "Kr-85", activity: "0.2697", units: "µCi" },
            { name: "Flap, Ven Primary", nsn: "2480-01-450-1973", radionuclide: "U-238", activity: "0.003", units: "µCi" },
            { name: "Exciter, Gas Turbine", nsn: "2835-00-601-1317", radionuclide: "Kr-85", activity: "6.9", units: "µCi" },
            { name: "Igniter, Turbine", nsn: "2835-01-200-0298", radionuclide: "Kr-85", activity: "0.224", units: "µCi" },
            { name: "Power Unit, Gas Turbine", nsn: "2835-01-267-8229", radionuclide: "Kr-85", activity: "2.914", units: "µCi" },
            { name: "Power Unit", nsn: "2835-01-373-4275", radionuclide: "Kr-85", activity: "2.92E+00", units: "µCi" },
            { name: "Flap, Ven Secondary", nsn: "2840-01-438-9479", radionuclide: "U-238", activity: "0.03", units: "µCi" },
            { name: "Seal, Ven Secondary", nsn: "2840-01-440-7755", radionuclide: "U-238", activity: "0.002", units: "µCi" },
            { name: "Mixer, Afterburner", nsn: "2840-01-450-1980", radionuclide: "U-238", activity: "0.05", units: "µCi" },
            { name: "Seal, Ven Primary", nsn: "2840-01-450-1982", radionuclide: "U-238", activity: "0.001", units: "µCi" },
            { name: "Flameholder, Afterburner", nsn: "2840-01-450-3755", radionuclide: "U-238", activity: "0.06", units: "µCi" },
            { name: "Ignition Unit", nsn: "2925-00-133-9594", radionuclide: "Kr-85", activity: "0.084", units: "µCi" },
            { name: "Vibrator, Ignition Coil", nsn: "2925-00-706-2720", radionuclide: "Cs-137", activity: "10", units: "µCi" },
            { name: "Ignition Unit", nsn: "2925-00-800-3403", radionuclide: "Kr-85", activity: "5", units: "µCi" },
            { name: "Vibrator, Ignition Coil", nsn: "2925-00-968-9594", radionuclide: "Cs-137", activity: "5", units: "µCi" },
            { name: "Vibrator, Ignition Coil", nsn: "2925-01-022-3181", radionuclide: "H-3", activity: "13.03", units: "µCi" },
            { name: "Ignition Exciter", nsn: "2925-01-057-6993", radionuclide: "Kr-85", activity: "0.0029", units: "mCi" },
            { name: "Vibrator, Ignition", nsn: "2925-01-077-3310", radionuclide: "Kr-85", activity: "0.3", units: "µCi" },
            { name: "Vibrator, Ignition", nsn: "2925-01-077-6866", radionuclide: "Kr-85", activity: "0.2", units: "µCi" },
            { name: "Coil Ignition Exciter", nsn: "2925-01-323-9835", radionuclide: "Kr-85", activity: "6", units: "mCi" },
            { name: "Igniter, Spark Gap", nsn: "2925-01-550-0177", radionuclide: "Kr-85", activity: "0.173", units: "µCi" },
            { name: "Tungsten Electrode", nsn: "3439-00-105-9945", radionuclide: "Th-232", activity: "0.2", units: "µCi" },
            { name: "Ionization Detector", nsn: "4210-00-595-5139", radionuclide: "Am-241", activity: "4", units: "µCi" },
            { name: "Ionization Sealed Source, Smoke Alarm", nsn: "4210-01-185-2762", radionuclide: "Am-241", activity: "1.6", units: "µCi" },
            { name: "Gamma Detector", nsn: "4470-00-444-3666", radionuclide: "C-14", activity: "100", units: "µCi" },
            { name: "Dial Control", nsn: "5355-01-342-2421", radionuclide: "H-3", activity: "2", units: "Ci" },
            { name: "Dial Scale", nsn: "5355-01-343-1793", radionuclide: "H-3", activity: "1.1", units: "Ci" },
            { name: "Processor, Video Signal", nsn: "5836-01-052-6952", radionuclide: "Th-232", activity: "0.002", units: "µCi" },
            { name: "Indicator, Range", nsn: "5840-01-458-6159", radionuclide: "H-3", activity: "3.2", units: "Ci" },
            { name: "Indicator, Range", nsn: "5840-01-642-5687", radionuclide: "H-3", activity: "3.20", units: "Ci" },
            { name: "Radar Spark Gap", nsn: "5841-01-054-6758", radionuclide: "Kr-85", activity: "25", units: "mCi" },
            { name: "Receiver - Transmitter", nsn: "5841-01-056-8647", radionuclide: "H-3", activity: "15", units: "mCi" },
            { name: "Receiver - Exciter", nsn: "5841-01-554-2099", radionuclide: "Pm-147", activity: "30", units: "µCi" },
            { name: "Image Intensifier", nsn: "5855-00-087-2948", radionuclide: "Th-232", activity: "4.9", units: "µCi" },
            { name: "NVS MX-7901A / TVS-4", nsn: "5855-00-147-2508", radionuclide: "Th-232", activity: "15.2", units: "µCi" },
            { name: "ANPVS 3A Night Vision Sight Lens", nsn: "5855-00-156-4992", radionuclide: "Th-232", activity: "5.8", units: "µCi" },
            { name: "Image Intensifier", nsn: "5855-00-177-3502", radionuclide: "Th-232", activity: "4.89", units: "µCi" },
            { name: "Lens Cap", nsn: "5855-00-409-0915", radionuclide: "Th-232", activity: "2.9", units: "µCi" },
            { name: "Night Vision Scope, MX 7793/ANPVS 1", nsn: "5855-00-688-9954", radionuclide: "Th-232", activity: "2.9", units: "µCi" },
            { name: "Night Vision System Sub-Assembly, Mx 7794a/Tvs-2a", nsn: "5855-00-791-1653", radionuclide: "Th-232", activity: "2.9", units: "µCi" },
            { name: "NVS Mk 37 Mod 3", nsn: "5855-00-908-9314", radionuclide: "Th-232", activity: "15.2", units: "µCi" },
            { name: "PVS-2B Eye Piece", nsn: "5855-00-941-3037", radionuclide: "Th-232", activity: "2.9", units: "µCi" },
            { name: "Boresight Collimator", nsn: "5855-01-029-8730", radionuclide: "Th-232", activity: "6", units: "nCi" },
            { name: "Night Vision Sight", nsn: "5855-01-037-7339", radionuclide: "Th-232", activity: "0.05", units: "µCi" },
            { name: "Receiver-Converter, Infrared", nsn: "5855-01-052-6849", radionuclide: "Th-232", activity: "0.0015", units: "µCi" },
            { name: "Afocal Assembly", nsn: "5855-01-052-6944", radionuclide: "Th-232", activity: "0.002", units: "µCi" },
            { name: "Imager, Infrared", nsn: "5855-01-053-0672", radionuclide: "Th-232", activity: "1.50E-03", units: "µCi" },
            { name: "AN/PAS-7A Infrared Viewing Set", nsn: "5855-01-093-3080", radionuclide: "Th-232", activity: "0.1", units: "µCi" },
            { name: "Image Intensifier", nsn: "5855-01-352-7033", radionuclide: "Th-232", activity: "5.00E-02", units: "µCi" },
            { name: "Window Infrared", nsn: "5855-01-377-7112", radionuclide: "Th-232", activity: "1.50E-03", units: "µCi" },
            { name: "Detector Dewar", nsn: "5855-01-486-0038", radionuclide: "Th-232", activity: "0.2", units: "µCi" },
            { name: "Duplexer", nsn: "5895-00-056-7033", radionuclide: "Co-60", activity: "0.8", units: "µCi" },
            { name: "Control, Receiver", nsn: "5895-00-688-6030", radionuclide: "Ra-226", activity: "0.17", units: "µCi" },
            { name: "TR Tube", nsn: "5895-01-375-6748", radionuclide: "Co-60/H-3", activity: "2.5E-4/12.51", units: "mCi" },
            { name: "Switch, Toggle", nsn: "5930-00-615-9376", radionuclide: "Ra-226", activity: "0.15", units: "mCi" },
            { name: "Electron Tube", nsn: "5960-00-001-1632", radionuclide: "Th-232", activity: "0.22", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-054-1987", radionuclide: "Th-232", activity: "3", units: "nCi" },
            { name: "Electron Tube", nsn: "5960-00-060-3449", radionuclide: "Th-232", activity: "1.10E-09", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-114-4849", radionuclide: "Th-232", activity: "1.80E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-131-6742", radionuclide: "Co-60", activity: "0.0000007", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-134-6004", radionuclide: "Re-187", activity: "0.00001", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-134-6012", radionuclide: "Re-187", activity: "4.46E-07", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-134-6031", radionuclide: "Re-187", activity: "1.00E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-134-6064", radionuclide: "Re-187", activity: "1.00E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-134-6073", radionuclide: "Re-187", activity: "8.89E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-140-1600", radionuclide: "Kr-85", activity: "1.00E-03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-148-4724", radionuclide: "Ni-63", activity: "0.5", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-168-8386", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Tube Electron", nsn: "5960-00-170-4582", radionuclide: "H-3", activity: "1", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-179-4446", radionuclide: "Re-187", activity: "10", units: "pCi" },
            { name: "Electron Tube", nsn: "5960-00-188-0968", radionuclide: "Kr-85", activity: "5.00E-08", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-188-3565", radionuclide: "Co-60", activity: "0.000001", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-188-3574", radionuclide: "Re-187", activity: "0.00000002", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-188-8612", radionuclide: "Re-187", activity: "1.00E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-193-5127", radionuclide: "Th-232", activity: "2.60E-10", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-220-6892", radionuclide: "Co-60", activity: "0.09", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-262-0161", radionuclide: "Re-187", activity: "0.00000002", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-262-0163", radionuclide: "Re-187", activity: "0.00000002", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-262-0210", radionuclide: "Re-187", activity: "0.00001", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-262-0286", radionuclide: "Co-60", activity: "0.00000002", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-280-5585", radionuclide: "Re-187", activity: "1.00E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-297-7099", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-307-9918", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-338-0377", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Magnetron", nsn: "5960-00-476-4750", radionuclide: "H-3", activity: "1", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-503-4880", radionuclide: "Kr-85", activity: "0.03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-542-7004", radionuclide: "Re-187", activity: "0.00000004", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-552-0082", radionuclide: "Re-187", activity: "0.00000002", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-552-8277", radionuclide: "U-238", activity: "0.00000008", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-615-5619", radionuclide: "Th-232", activity: "120", units: "pCi" },
            { name: "Electron Tube", nsn: "5960-00-624-4718", radionuclide: "Ra-226", activity: "6", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-681-8037", radionuclide: "Co-60", activity: "0.15", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-682-8627", radionuclide: "Re-187", activity: "8.89E-11", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-00-713-7014", radionuclide: "U-238", activity: "0.08", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-752-6384", radionuclide: "H-3", activity: "1", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-00-827-8782", radionuclide: "Re-187", activity: "4.46E-09", units: "Ci" },
            { name: "Electron Tube, Tr-Limiter, Band-Pass, S-Band", nsn: "5960-01-008-1351", radionuclide: "H-3", activity: "30", units: "mCi" },
            { name: "Electron Tube, Tr-Limiter, Band-Pass, S-Band", nsn: "5960-01-008-1352", radionuclide: "H-3", activity: "30", units: "mCi" },
            { name: "Electron Tube", nsn: "5960-01-013-9344", radionuclide: "Co-60", activity: "0.1", units: "µCi" },
            { name: "TR Tube", nsn: "5960-01-018-1237", radionuclide: "H-3/Co-60", activity: "33,000/1", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-01-027-7252", radionuclide: "H-3", activity: "0.075135135", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-01-036-3839", radionuclide: "Am-241", activity: "0.0045", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-01-037-3297", radionuclide: "Th-232", activity: "1", units: "nCi" },
            { name: "Electron Tube", nsn: "5960-01-037-3297", radionuclide: "Th-232", activity: "0.001", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-01-095-5001", radionuclide: "H-3", activity: "0.15", units: "Ci" },
            { name: "Electron Tube", nsn: "5960-01-274-3899", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-01-274-3900", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-01-365-5728", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "AEGIS Electron Tube, YV-150 SWT", nsn: "5960-01-392-6982", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Cathode Ray Tube (Electron Tube)", nsn: "5960-01-418-2641", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Electron Tube", nsn: "5960-01-462-6267", radionuclide: "Th-232", activity: "1.10E-03", units: "µCi" },
            { name: "Amplifier Radio", nsn: "5996-01-266-0543", radionuclide: "H-3", activity: "150", units: "µCi" },
            { name: "Lamp, Metal, Halide", nsn: "6240-01-163-0015", radionuclide: "Kr-85/Th-232", activity: "100/0.2", units: "µCi" },
            { name: "Lamp, Nuclear", nsn: "6260-01-056-2883", radionuclide: "H-3", activity: "1", units: "Ci" },
            { name: "Index, Mount", nsn: "6260-01-212-8472", radionuclide: "H-3", activity: "0.03", units: "Ci" },
            { name: "Sensor, Pick Up Kit", nsn: "6350-00-224-3203", radionuclide: "Pm-147", activity: "90", units: "µCi" },
            { name: "Ionization Smoke Detector", nsn: "6350-01-593-8401", radionuclide: "Am-241", activity: "9.00E-01", units: "µCi" },
            { name: "Magnetic Compass", nsn: "6605-00-129-6330", radionuclide: "H-3", activity: "50", units: "mCi" },
            { name: "Compass, Magnetic", nsn: "6605-00-151-5337", radionuclide: "H-3", activity: "190", units: "mCi" },
            { name: "Compass, Magnetic", nsn: "6605-01-196-6971", radionuclide: "H-3", activity: "120", units: "mCi" },
            { name: "Indicator, Turn And", nsn: "6610-00-253-3547", radionuclide: "Ra-226", activity: "0.01", units: "µCi" },
            { name: "Indicator", nsn: "6620-01-125-8904", radionuclide: "Sr-90", activity: "500", units: "µCi" },
            { name: "Mount, Telescope", nsn: "6650-01-340-6082", radionuclide: "H-3", activity: "4.19", units: "Ci" },
            { name: "Telescope, Elbow", nsn: "6650-01-341-5195", radionuclide: "H-3", activity: "0.8", units: "Ci" },
            { name: "RADIAC AN/PDR-27Q", nsn: "6665-00-017-8903", radionuclide: "Kr-85", activity: "5", units: "mCi" },
            { name: "Detector, Helicopter", nsn: "6665-01-278-9145", radionuclide: "Sr-90", activity: "0.01", units: "µCi" },
            { name: "Detector", nsn: "6665-01-282-7139", radionuclide: "Tc-99", activity: "0.2", units: "µCi" },
            { name: "IM-239 Check Source", nsn: "6665-01-333-5985", radionuclide: "Tc-99", activity: "0.2", units: "µCi" },
            { name: "Detector, Chemical Agent (GID-3)", nsn: "6665-01-438-3673", radionuclide: "Ni-63", activity: "30", units: "mCi" },
            { name: "Vapor Tracer Ii", nsn: "6665-01-491-8523", radionuclide: "Ni-63", activity: "10", units: "mCi" },
            { name: "Source Set", nsn: "6665-01-546-6120", radionuclide: "Sr-90", activity: "0.15", units: "µCi" },
            { name: "Detector, Chemical Agent", nsn: "6665-99-203-6162", radionuclide: "Ni-63", activity: "30", units: "mCi" },
            { name: "Chemical Agent Monitor", nsn: "6665-99-725-9996", radionuclide: "Ni-63", activity: "10", units: "mCi" },
            { name: "Indicator, Pressure", nsn: "6685-01-356-9967", radionuclide: "Sr-90", activity: "100", units: "µCi" },
            { name: "Meter, Brightness", nsn: "6695-01-221-3251", radionuclide: "C-14", activity: "50", units: "µCi" },
            { name: "Marker, Self-Luminous", nsn: "9905-99-931-5348", radionuclide: "H-3", activity: "0.61", units: "Ci" },
            { name: "APD 2000", nsn: "6625-07-000-1329", radionuclide: "Ni-63", activity: "10", units: "mCi" }
        ];

        // --- NEW: Radionuclide Detail Data ---
        const radionuclideDetails = {
            'H-3': { name: 'Tritium', halfLife: '12.3 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Tritium' },
            'Am-241': { name: 'Americium-241', halfLife: '432.2 years', decayMode: 'Alpha, Gamma', wiki: 'https://en.wikipedia.org/wiki/Americium-241' },
            'Th-232': { name: 'Thorium-232', halfLife: '14.05 billion years', decayMode: 'Alpha', wiki: 'https://en.wikipedia.org/wiki/Thorium-232' },
            'Sr-90': { name: 'Strontium-90', halfLife: '28.8 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Strontium-90' },
            'Ra-226': { name: 'Radium-226', halfLife: '1600 years', decayMode: 'Alpha, Gamma', wiki: 'https://en.wikipedia.org/wiki/Radium-226' },
            'Kr-85': { name: 'Krypton-85', halfLife: '10.75 years', decayMode: 'Beta, Gamma', wiki: 'https://en.wikipedia.org/wiki/Krypton-85' },
            'U-238': { name: 'Uranium-238', halfLife: '4.468 billion years', decayMode: 'Alpha', wiki: 'https://en.wikipedia.org/wiki/Uranium-238' },
            'Cs-137': { name: 'Caesium-137', halfLife: '30.17 years', decayMode: 'Beta, Gamma', wiki: 'https://en.wikipedia.org/wiki/Caesium-137' },
            'Pm-147': { name: 'Promethium-147', halfLife: '2.62 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Promethium-147' },
            'Co-60': { name: 'Cobalt-60', halfLife: '5.27 years', decayMode: 'Beta, Gamma', wiki: 'https://en.wikipedia.org/wiki/Cobalt-60' },
            'Re-187': { name: 'Rhenium-187', halfLife: '43.3 billion years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Rhenium-187' },
            'Ni-63': { name: 'Nickel-63', halfLife: '100.1 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Nickel-63' },
            'C-14': { name: 'Carbon-14', halfLife: '5730 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Carbon-14' },
            'Tc-99': { name: 'Technetium-99', halfLife: '211,100 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Technetium-99' }
        };

        // --- NRC Exemption values from 10 CFR 30.71, Schedule B ---
        const nrcExemptionValues = {
            'Am-241': '0.01 µCi', 'C-14': '100 µCi', 'Cs-137': '10 µCi', 'Co-60': '1 µCi',
            'H-3': '1,000 µCi', 'Kr-85': '100 µCi', 'Ni-63': '100 µCi', 'N-63': '100 µCi',
            'Pm-147': '10 µCi', 'Ra-226': '0.1 µCi', 'Re-187': '100 µCi', 'Sr-90': '0.1 µCi',
            'Tc-99': '10 µCi', 'Th-232': '--', 'U-238': '--'
        };

        // --- DOT Exemption values from 49 CFR 173.436 (Consignment) ---
        const dotExemptionValues = {
            'H-3': '27 mCi',
            'Am-241': '0.27 µCi',
            'Th-232': '0.27 µCi',
            'Sr-90': '0.27 µCi',
            'Ra-226': '0.27 µCi',
            'Kr-85': '0.27 µCi',
            'U-238': '0.27 µCi',
            'Cs-137': '0.27 µCi',
            'Pm-147': '270 µCi',
            'Co-60': '2.7 µCi',
            'Re-187': '27 mCi',
            'Ni-63': '2.7 mCi',
            'N-63': '2.7 mCi', // Assuming typo for Ni-63
            'C-14': '270 µCi',
            'Tc-99': '270 µCi'
        };

        // --- UN 2911 Excepted Package Limits (per item) ---
        const un2911Limits = {
            'Am-241': '0.00027 Ci',
            'C-14': '0.81 Ci',
            'Co-60': '0.11 Ci',
            'Cs-137': '0.16 Ci',
            'H-3': '22 Ci',
            'Kr-85': '0.27 Ci',
            'Ni-63': '8.1 Ci',
            'N-63': '8.1 Ci', // Assuming typo for Ni-63
            'Pm-147': '0.54 Ci',
            'Ra-226': '0.00081 Ci',
            'Re-187': 'Unlimited',
            'Sr-90': '0.081 Ci',
            'Tc-99': '0.24 Ci',
            'Th-232': 'Unlimited',
            'U-238': 'Unlimited'
        };

        // --- UN 2911 Excepted Package Limits (per package) ---
        const un2911PkgLimits = {
            'Am-241': '0.027 Ci',
            'C-14': '81 Ci',
            'Co-60': '11 Ci',
            'Cs-137': '16 Ci',
            'H-3': '220 Ci',
            'Kr-85': '2.7 Ci',
            'Ni-63': '810 Ci',
            'N-63': '810 Ci', // Assuming typo for Ni-63
            'Pm-147': '54 Ci',
            'Ra-226': '0.081 Ci',
            'Re-187': 'Unlimited',
            'Sr-90': '8.1 Ci',
            'Tc-99': '24 Ci',
            'Th-232': 'Unlimited',
            'U-238': 'Unlimited'
        };

        // --- Global State ---
        let tableData = [];
        let currentSort = { column: null, direction: 'asc' };
        
        // --- Conversion and Formatting Helpers ---
        const CI_TO_BQ = 3.7e10;
        const ciMultipliers = { 'pCi': 1e-12, 'nCi': 1e-9, 'µCi': 1e-6, 'mCi': 1e-3, 'Ci': 1 };
        
        function formatNumberWithCommas(number) {
            return number.toLocaleString('en-US');
        }

        function parseValueToCi(valueStr) {
            if (typeof valueStr !== 'string' || valueStr === '--' || valueStr.toLowerCase() === 'unlimited') {
                return null;
            }
            const parts = valueStr.trim().split(/\s+/);
            const value = parseFloat(String(parts[0]).replace(/,/g, ''));
            const unit = parts[1] || 'Ci';
            const multiplier = ciMultipliers[unit.trim()] || 1;
            return isNaN(value) ? null : value * multiplier;
        }

        function formatCi(valueCi) {
            if (valueCi === null || typeof valueCi === 'undefined') return '--';
            if (valueCi === 0) return '0 Ci';
            const units = ['pCi', 'nCi', 'µCi', 'mCi', 'Ci'];
            let unitIndex = 4;
            let value = valueCi;
            while (value < 1 && unitIndex > 0) {
                value *= 1000;
                unitIndex--;
            }
            return `${formatNumberWithCommas(parseFloat(value.toPrecision(3)))} ${units[unitIndex]}`;
        }

        function formatBq(valueCi) {
            if (valueCi === null || typeof valueCi === 'undefined') return '--';
            if (valueCi === 0) return '0 Bq';
            let valueBq = valueCi * CI_TO_BQ;
            const units = ['Bq', 'kBq', 'MBq', 'GBq', 'TBq'];
            let unitIndex = 0;

            while (valueBq >= 1000 && unitIndex < units.length - 1) {
                valueBq /= 1000;
                unitIndex++;
            }
            
            let displayValue = parseFloat(valueBq.toPrecision(3));

            if (displayValue >= 999 && unitIndex < units.length - 1) {
                displayValue = 1;
                unitIndex++;
            } 
            else if (displayValue >= 99.9 && displayValue < 100) {
                 displayValue = 100;
            } 
            else if (displayValue >= 9.99 && displayValue < 10) {
                 displayValue = 10;
            }

            return `${formatNumberWithCommas(displayValue)} ${units[unitIndex]}`;
        }

        // --- Data Processing ---
        function processData(baseData, customData) {
            const processed = [];
            let uniqueId = 0;

            // Process the initial, hardcoded data
            baseData.forEach(item => {
                const hasMultipleNuclides = item.radionuclide.includes('/');
                const hasMultipleActivities = String(item.activity).includes('/');

                if (hasMultipleNuclides && hasMultipleActivities) {
                    const nuclides = item.radionuclide.split('/');
                    const activities = String(item.activity).split('/');
                    if (nuclides.length === activities.length) {
                        nuclides.forEach((nuclide, i) => {
                            // Create a new item object for each part of the multi-nuclide entry
                            const singleItem = { ...item, radionuclide: nuclide.trim(), activity: activities[i].trim() };
                            // Pass `false` for isCustom since this is base data
                            processed.push(createRowObject(singleItem, uniqueId++, false));
                        });
                        return; // Skip the final push for the original multi-nuclide item
                    }
                }
                // Process regular base data items
                processed.push(createRowObject(item, uniqueId++, false));
            });
            
            // Process custom data from local storage
            customData.forEach(item => {
                // Pass `true` for isCustom since this is user-added data
                processed.push(createRowObject(item, item.id, true));
            });

            return processed;
        }
        
        function createRowObject(item, id, isCustom = false) {
            const radionuclide = item.radionuclide.trim();
            
            const activityVal = parseValueToCi(`${item.activity} ${item.units}`);
            const nrcExemptionVal = parseValueToCi(nrcExemptionValues[radionuclide]);
            const dotExemptionVal = parseValueToCi(dotExemptionValues[radionuclide]);
            const un2911LimitVal = parseValueToCi(un2911Limits[radionuclide]);
            const un2911PkgLimitVal = parseValueToCi(un2911PkgLimits[radionuclide]);

            return {
                id: id,
                isCustom: isCustom,
                name: item.name,
                nsn: item.nsn,
                niin: item.niin || (item.nsn ? item.nsn.substring(5).replace(/-/g, '') : ''),
                radionuclide: radionuclide,
                
                activity_val: activityVal,
                nrc_exemption_val: nrcExemptionVal,
                dot_exemption_val: dotExemptionVal,
                un2911_limit_val: un2911LimitVal,
                un2911_pkg_limit_val: un2911PkgLimitVal,
                
                activity_ci_str: formatCi(activityVal),
                nrc_exemption_ci_str: nrcExemptionVal !== null ? formatCi(nrcExemptionVal) : (nrcExemptionValues[radionuclide] || 'N/A'),
                dot_exemption_ci_str: dotExemptionVal !== null ? formatCi(dotExemptionVal) : (dotExemptionValues[radionuclide] || 'N/A'),
                un2911_limit_ci_str: un2911LimitVal !== null ? formatCi(un2911LimitVal) : 'Unlimited',
                un2911_pkg_limit_ci_str: un2911PkgLimitVal !== null ? formatCi(un2911PkgLimitVal) : 'Unlimited',

                activity_bq_str: formatBq(activityVal),
                nrc_exemption_bq_str: nrcExemptionVal !== null ? formatBq(nrcExemptionVal) : (nrcExemptionValues[radionuclide] || 'N/A'),
                dot_exemption_bq_str: dotExemptionVal !== null ? formatBq(dotExemptionVal) : (dotExemptionValues[radionuclide] || 'N/A'),
                un2911_limit_bq_str: un2911LimitVal !== null ? formatBq(un2911LimitVal) : 'Unlimited',
                un2911_pkg_limit_bq_str: un2911PkgLimitVal !== null ? formatBq(un2911PkgLimitVal) : 'Unlimited',
            };
        }


        function populateTable(data) {
            const tableBody = document.querySelector('#lookupTable tbody');
            const isSiUnits = document.getElementById('unitToggle').checked;
            tableBody.innerHTML = '';

            const rows = data.map((item) => {
                const nrcExemption = isSiUnits ? item.nrc_exemption_bq_str : item.nrc_exemption_ci_str;
                const dotExemption = isSiUnits ? item.dot_exemption_bq_str : item.dot_exemption_ci_str;
                const un2911Limit = isSiUnits ? item.un2911_limit_bq_str : item.un2911_limit_ci_str;
                const un2911PkgLimit = isSiUnits ? item.un2911_pkg_limit_bq_str : item.un2911_pkg_limit_ci_str;
                const activity = isSiUnits ? item.activity_bq_str : item.activity_ci_str;

                const rowClasses = ['border-b', 'dark:border-gray-700', 'hover:bg-gray-50', 'dark:hover:bg-gray-600'];
                if (item.isCustom) {
                    rowClasses.push('custom-row');
                } else {
                    rowClasses.push('bg-white', 'dark:bg-gray-800');
                }

                const customIcon = item.isCustom ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="inline-block ml-2 text-blue-600 dark:text-blue-300" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg>` : '';

                return `
                    <tr class="${rowClasses.join(' ')}" data-id="${item.id}">
                        <td class="px-6 py-4 text-center" data-label="Select"><input type="checkbox" class="row-checkbox" data-id="${item.id}"></td>
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white text-left" data-label="Name">${item.name}${customIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center expandable" data-label="NSN">${item.nsn || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center expandable" data-label="NIIN">${item.niin || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center radionuclide-link text-blue-500 hover:underline cursor-pointer" data-label="Radionuclide" data-radionuclide="${item.radionuclide}">${item.radionuclide}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap" data-label="Activity">${activity}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="NRC Exemption">${nrcExemption}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="DOT Exemption">${dotExemption}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="UN 2911 Limit (item)">${un2911Limit}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="UN 2911 Limit (package)">${un2911PkgLimit}</td>
                        <td class="toggle-cell">
                            <button class="details-toggle-btn">Show More</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = rows;
        }

        function sortTable(columnKey) {
            const isAsc = currentSort.column === columnKey && currentSort.direction === 'asc';
            currentSort.direction = isAsc ? 'desc' : 'asc';
            currentSort.column = columnKey;

            const filteredData = getFilteredData();

            filteredData.sort((a, b) => {
                let valA = a[columnKey];
                let valB = b[columnKey];
                
                if (valA === null) return 1;
                if (valB === null) return -1;

                let comparison = 0;
                if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB, undefined, { numeric: true });
                } else {
                    if (valA > valB) comparison = 1;
                    else if (valA < valB) comparison = -1;
                }

                return currentSort.direction === 'asc' ? comparison : -comparison;
            });

            updateSortArrows();
            populateTable(filteredData);
        }
        
        function updateSortArrows() {
            // Remove sort indicators from all columns first
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sorted-column');
                const arrow = th.querySelector('.sort-arrow');
                if (arrow) {
                    arrow.classList.remove('asc', 'desc');
                }
            });

            // Apply sort indicator to the current column
            const header = document.querySelector(`th[onclick="sortTable('${currentSort.column}')"]`);
            if (header) {
                header.classList.add('sorted-column');
                const arrow = header.querySelector('.sort-arrow');
                if (arrow) {
                    arrow.classList.add(currentSort.direction);
                }
            }
        }
        
        function getFilteredData() {
            const searchInput = document.getElementById("searchInput");
            const textFilter = searchInput.value.toUpperCase();
            const radionuclideFilter = document.getElementById('radionuclideFilter');
            const nuclideFilter = radionuclideFilter.value;
            const nrcExemptOnly = document.getElementById('nrcExemptFilter').checked;
            const dotExemptOnly = document.getElementById('dotExemptFilter').checked;

            return tableData.filter(item => {
                const nuclideMatch = nuclideFilter === 'all' || item.radionuclide === nuclideFilter;
                
                const nrcExemptMatch = !nrcExemptOnly || (item.nrc_exemption_val !== null && item.activity_val <= item.nrc_exemption_val);
                const dotExemptMatch = !dotExemptOnly || (item.dot_exemption_val !== null && item.activity_val <= item.dot_exemption_val);

                let textMatch = false;
                if (textFilter === "") {
                    textMatch = true;
                } else {
                    const searchableValues = [item.name, item.nsn, item.niin];
                    textMatch = searchableValues.some(val => val && val.toUpperCase().includes(textFilter));
                }

                return nuclideMatch && textMatch && nrcExemptMatch && dotExemptMatch;
            });
        }

        function filterTable() {
            const filteredData = getFilteredData();
            populateTable(filteredData);
            document.getElementById("noResults").style.display = filteredData.length === 0 ? 'block' : 'none';
            updateSelectionState();
            // saveState(); // REMOVED FROM HERE
        }

        function updateSelectionState() {
            const allVisibleCheckboxes = document.querySelectorAll('#lookupTable tbody tr .row-checkbox');
            const allVisibleChecked = Array.from(allVisibleCheckboxes).every(cb => cb.checked);
            document.getElementById('selectAllCheckbox').checked = allVisibleCheckboxes.length > 0 && allVisibleChecked;
        }

        // --- NEW: Debounce helper function ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- NEW: Toast Notification function ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, 3000); // Toast disappears after 3 seconds
        }

        document.addEventListener('DOMContentLoaded', () => {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const unitToggle = document.getElementById('unitToggle');
            const tableBody = document.querySelector('#lookupTable tbody');
            const compareBtn = document.getElementById('compareBtn');
            const exportSelectionBtn = document.getElementById('exportSelectionBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const packageBuilderBtn = document.getElementById('packageBuilderBtn');
            const compareModal = document.getElementById('compareModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const compareContent = document.getElementById('compareContent');
            const detailModal = document.getElementById('detailModal');
            const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
            const detailContent = document.getElementById('detailContent');
            const detailActions = document.getElementById('detailActions');
            const detailModalTitle = document.getElementById('detailModalTitle');
            const radionuclideFilter = document.getElementById('radionuclideFilter');
            const packageBuilderModal = document.getElementById('packageBuilderModal');
            const closePackageBuilderModalBtn = document.getElementById('closePackageBuilderModalBtn');
            const packageBuilderContent = document.getElementById('packageBuilderContent');
            const nrcExemptFilter = document.getElementById('nrcExemptFilter');
            const dotExemptFilter = document.getElementById('dotExemptFilter');
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
            const saveSelectionBtn = document.getElementById('saveSelectionBtn');
            const loadSelectionBtn = document.getElementById('loadSelectionBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const clearSavedBtn = document.getElementById('clearSavedBtn');
            const addItemBtn = document.getElementById('addItemBtn');
            const addItemModal = document.getElementById('addItemModal');
            const closeAddItemModalBtn = document.getElementById('closeAddItemModalBtn');
            const cancelAddItemBtn = document.getElementById('cancelAddItemBtn');
            const addItemForm = document.getElementById('addItemForm');
            const itemRadionuclideSelect = document.getElementById('itemRadionuclide');
            const clearAddedBtn = document.getElementById('clearAddedBtn');
            const importCustomBtn = document.getElementById('importCustomBtn');
            const exportCustomBtn = document.getElementById('exportCustomBtn');
            const importFileInput = document.getElementById('importFileInput');
            const searchInput = document.getElementById('searchInput');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const radionuclideDetailModal = document.getElementById('radionuclideDetailModal');
            const closeRadionuclideModalBtn = document.getElementById('closeRadionuclideModalBtn');
            const tooltipModal = document.getElementById('tooltipModal');
            const closeTooltipModalBtn = document.getElementById('closeTooltipModalBtn');


            if (document.documentElement.classList.contains('dark')) {
                darkModeToggle.checked = true;
            }
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            unitToggle.addEventListener('change', () => {
                filterTable();
            });
            
            tableBody.addEventListener('click', (event) => {
                // Handle "Show More/Less" button click on mobile
                const toggleBtn = event.target.closest('.details-toggle-btn');
                if (toggleBtn) {
                    const row = toggleBtn.closest('tr');
                    row.classList.toggle('details-visible');
                    toggleBtn.textContent = row.classList.contains('details-visible') ? 'Show Less' : 'Show More';
                    return; // Stop further processing
                }

                const targetCell = event.target.closest('td');
                if (!targetCell) return;

                // Handle radionuclide link click
                if (targetCell.classList.contains('radionuclide-link')) {
                    const nuclideId = targetCell.dataset.radionuclide;
                    showRadionuclideModal(nuclideId);
                    return;
                }

                const row = targetCell.parentElement;
                const checkbox = row.querySelector('.row-checkbox');

                // Handle checkbox cell click
                if (targetCell.cellIndex === 0) {
                    if (event.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                } else { // Handle other cell clicks to open detail modal
                    const itemId = row.dataset.id;
                    const item = tableData.find(d => d.id == itemId);
                    if (item) {
                        showDetailModal(item);
                    }
                }
            });

            tableBody.addEventListener('change', (event) => {
                 if (event.target.classList.contains('row-checkbox')) {
                    const row = event.target.closest('tr');
                    if (event.target.checked) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                    const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
                    compareBtn.disabled = selectedCount < 2;
                    exportSelectionBtn.disabled = selectedCount === 0;
                    clearSelectionBtn.disabled = selectedCount === 0;
                    packageBuilderBtn.disabled = selectedCount === 0;
                    saveSelectionBtn.disabled = selectedCount === 0;
                    updateSelectionState();
                }
            });

            function copyToClipboard(text, buttonElement) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Copied to clipboard!', 'success');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showToast('Failed to copy!', 'error');
                }
                document.body.removeChild(textarea);
            }

            function showDetailModal(item) {
                const isSiUnits = document.getElementById('unitToggle').checked;
                detailModalTitle.textContent = item.name;

                let content = `<div class="space-y-4">`;
                content += `<div class="flex justify-between items-center"><strong>NSN:</strong> <span>${item.nsn || 'N/A'} <button data-copy="${item.nsn || ''}" class="copy-btn ml-2 p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Copy NSN"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 7a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15A.5.5 0 0 1-1 7z"/></svg></button></span></div>`;
                content += `<div class="flex justify-between items-center"><strong>NIIN:</strong> <span>${item.niin || 'N/A'} <button data-copy="${item.niin || ''}" class="copy-btn ml-2 p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Copy NIIN"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 7a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15A.5.5 0 0 1-1 7z"/></svg></button></span></div>`;
                if (item.nsn) {
                    content += `<div><a href="https://www.iso-group.com/NSN/${item.nsn}" target="_blank" class="text-blue-500 hover:underline">Lookup via ISO-Group</a></div>`;
                }
                content += `<hr class="dark:border-gray-600 my-4">`;
                content += `<div class="mb-4"><strong>Activity:</strong> ${isSiUnits ? item.activity_bq_str : item.activity_ci_str} of <span class="radionuclide-link text-blue-500 hover:underline cursor-pointer" data-radionuclide="${item.radionuclide}">${item.radionuclide}</span></div>`;
                
                const comparisons = [
                    { key: 'nrc_exemption_val', label: 'NRC Exemption', limit: item.nrc_exemption_val, str: isSiUnits ? item.nrc_exemption_bq_str : item.nrc_exemption_ci_str },
                    { key: 'dot_exemption_val', label: 'DOT Exemption', limit: item.dot_exemption_val, str: isSiUnits ? item.dot_exemption_bq_str : item.dot_exemption_ci_str },
                    { key: 'un2911_limit_val', label: 'UN 2911 Limit (item)', limit: item.un2911_limit_val, str: isSiUnits ? item.un2911_limit_bq_str : item.un2911_limit_ci_str },
                    { key: 'un2911_pkg_limit_val', label: 'UN 2911 Limit (package)', limit: item.un2911_pkg_limit_val, str: isSiUnits ? item.un2911_pkg_limit_bq_str : item.un2911_pkg_limit_ci_str }
                ];

                comparisons.forEach(comp => {
                    let status, statusColor, percentage = 0;
                    
                    if (item.activity_val === null || comp.limit === null) {
                        status = 'N/A';
                        statusColor = 'text-gray-500';
                    } else if (item.activity_val > comp.limit) {
                        status = 'ABOVE';
                        statusColor = 'text-red-500';
                    } else {
                        status = 'BELOW';
                        statusColor = 'text-green-500';
                    }

                    if (item.activity_val !== null && comp.limit !== null && comp.limit > 0) {
                        percentage = Math.min((item.activity_val / comp.limit) * 100, 100);
                    }

                    content += `<div class="mb-3">`;
                    content += `<div class="flex justify-between items-center">
                                    <span class="flex items-center">
                                        ${comp.label}: ${comp.str}
                                        <svg data-tooltip-key="${comp.key}" class="tooltip-icon ml-2 w-4 h-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-pointer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    </span> 
                                    <span class="font-bold ${statusColor}">${status}</span>
                                </div>`;
                    
                    if (status !== 'N/A') {
                        const barColor = statusColor.replace('text-', 'bg-');
                        content += `
                            <div class="progress-bar-container">
                                <div class="progress-bar ${barColor}" style="width: ${percentage}%;">
                                    ${percentage.toFixed(0)}%
                                </div>
                            </div>
                        `;
                    }
                    content += `</div>`;
                });

                content += `</div>`;
                detailContent.innerHTML = content;

                // Add listener for the new radionuclide link in the detail modal
                const nuclideLink = detailContent.querySelector('.radionuclide-link');
                if (nuclideLink) {
                    nuclideLink.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const nuclideId = e.target.dataset.radionuclide;
                        showRadionuclideModal(nuclideId);
                    });
                }

                detailContent.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const textToCopy = button.dataset.copy;
                        if(textToCopy) {
                            copyToClipboard(textToCopy, button);
                        }
                    });
                });

                // NEW: Add listener for tooltip icons
                detailContent.querySelectorAll('.tooltip-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tooltipKey = e.currentTarget.dataset.tooltipKey;
                        showTooltipModal(tooltipKey);
                    });
                });

                detailActions.innerHTML = '';
                
                const copyDetailsBtn = document.createElement('button');
                copyDetailsBtn.textContent = 'Copy Details';
                copyDetailsBtn.className = 'px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600';
                copyDetailsBtn.onclick = (e) => {
                    e.stopPropagation();
                    let textToCopy = `Item Details:\n--------------------------\n`;
                    textToCopy += `Name: ${item.name}\n`;
                    textToCopy += `NSN: ${item.nsn || 'N/A'}\n`;
                    textToCopy += `NIIN: ${item.niin || 'N/A'}\n`;
                    textToCopy += `Radionuclide: ${item.radionuclide}\n`;
                    textToCopy += `Activity: ${isSiUnits ? item.activity_bq_str : item.activity_ci_str}\n`;
                    textToCopy += `--------------------------\n`;
                    comparisons.forEach(comp => {
                        let status = (item.activity_val === null || comp.limit === null) ? 'N/A' : (item.activity_val > comp.limit ? 'ABOVE' : 'BELOW');
                        textToCopy += `${comp.label}: ${comp.str} (${status})\n`;
                    });
                    copyToClipboard(textToCopy, copyDetailsBtn);
                };
                detailActions.appendChild(copyDetailsBtn);

                const customActionsContainer = document.createElement('div');
                customActionsContainer.className = 'flex gap-4';
                
                if(item.isCustom) {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600';
                    editBtn.onclick = () => {
                        detailModal.style.display = 'none';
                        showAddItemModal(item);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600';
                    deleteBtn.onclick = () => {
                        showConfirmationModal(`Are you sure you want to delete the item "${item.name}"?`, () => {
                            // Hide modals before performing the delete action to prevent rendering issues.
                            detailModal.style.display = 'none';
                            confirmModal.style.display = 'none';
                            deleteCustomItem(item.id);
                        });
                    };
                    customActionsContainer.appendChild(editBtn);
                    customActionsContainer.appendChild(deleteBtn);
                }
                detailActions.appendChild(customActionsContainer);

                detailModal.style.display = 'flex';
            }

            closeDetailModalBtn.addEventListener('click', () => {
                detailModal.style.display = 'none';
            });

            compareBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedData = Array.from(selectedCheckboxes).map(cb => tableData.find(d => d.id == cb.dataset.id));
                
                const isSiUnits = document.getElementById('unitToggle').checked;

                let content = '<div class="overflow-x-auto"><table class="w-full text-sm text-left">';
                
                const headers = ['Attribute', ...selectedData.map(item => item.name)];
                content += '<thead><tr class="bg-gray-100 dark:bg-gray-700">';
                headers.forEach(header => content += `<th class="px-4 py-2">${header}</th>`);
                content += '</tr></thead><tbody>';

                const attributes = [
                    { label: 'NSN', key: 'nsn' },
                    { label: 'NIIN', key: 'niin' },
                    { label: 'Radionuclide', key: 'radionuclide' },
                    { label: 'Activity', key: isSiUnits ? 'activity_bq_str' : 'activity_ci_str' },
                    { label: 'NRC Exemption', key: isSiUnits ? 'nrc_exemption_bq_str' : 'nrc_exemption_ci_str' },
                    { label: 'DOT Exemption', key: isSiUnits ? 'dot_exemption_bq_str' : 'dot_exemption_ci_str' },
                    { label: 'UN 2911 Limit (item)', key: isSiUnits ? 'un2911_limit_bq_str' : 'un2911_limit_ci_str' },
                    { label: 'UN 2911 Limit (package)', key: isSiUnits ? 'un2911_pkg_limit_bq_str' : 'un2911_pkg_limit_ci_str' }
                ];

                attributes.forEach(attr => {
                    content += '<tr class="border-b dark:border-gray-700">';
                    content += `<td class="px-4 py-2 font-semibold">${attr.label}</td>`;
                    selectedData.forEach(item => {
                        content += `<td class="px-4 py-2">${item[attr.key] || ''}</td>`;
                    });
                    content += '</tr>';
                });

                content += '</tbody></table></div>';
                compareContent.innerHTML = content;
                compareModal.style.display = 'flex';
            });

            closeModalBtn.addEventListener('click', () => {
                compareModal.style.display = 'none';
            });

            exportSelectionBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedData = Array.from(selectedCheckboxes).map(cb => tableData.find(d => d.id == cb.dataset.id));
                const isSiUnits = document.getElementById('unitToggle').checked;
                
                const headers = [
                    "Name or Nomenclature", "NSN", "NIIN", "Radionuclide", 
                    "Activity", "NRC Exemption", "DOT Exemption", 
                    "UN 2911 Limit (per item)", "UN 2911 Limit (per package)"
                ];

                let csvContent = "data:text/csv;charset=utf-8," + headers.map(h => `"${h}"`).join(",") + "\n";

                selectedData.forEach(item => {
                    const row = [
                        `"${item.name}"`,
                        `"${item.nsn || ''}"`,
                        `"${item.niin || ''}"`,
                        `"${item.radionuclide}"`,
                        `"${isSiUnits ? item.activity_bq_str : item.activity_ci_str}"`,
                        `"${isSiUnits ? item.nrc_exemption_bq_str : item.nrc_exemption_ci_str}"`,
                        `"${isSiUnits ? item.dot_exemption_bq_str : item.dot_exemption_ci_str}"`,
                        `"${isSiUnits ? item.un2911_limit_bq_str : item.un2911_limit_ci_str}"`,
                        `"${isSiUnits ? item.un2911_pkg_limit_bq_str : item.un2911_pkg_limit_ci_str}"`
                    ].join(",");
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "radioactive_commodities_selection.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            clearSelectionBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                selectedCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.closest('tr').classList.remove('selected-row');
                });
                compareBtn.disabled = true;
                exportSelectionBtn.disabled = true;
                clearSelectionBtn.disabled = true;
                packageBuilderBtn.disabled = true;
                saveSelectionBtn.disabled = true;
                selectAllCheckbox.checked = false;
            });
            
            packageBuilderBtn.addEventListener('click', () => {
                showPackageBuilderModal();
            });

            function showPackageBuilderModal() {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedItems = Array.from(selectedCheckboxes).map(cb => tableData.find(d => d.id == cb.dataset.id));
                
                let content = '<div id="packageBuilderItems" class="space-y-4">';
                selectedItems.forEach((item, index) => {
                    content += `
                        <div class="flex items-center gap-4">
                            <label for="qty-${index}" class="w-2/3">${item.name} (${item.radionuclide})</label>
                            <input type="number" id="qty-${index}" data-id="${item.id}" value="1" min="1" class="quantity-input w-1/3 px-2 py-1 rounded border dark:bg-gray-700 dark:border-gray-600">
                        </div>
                    `;
                });
                content += '</div>';
                content += '<div id="packageBuilderTotals" class="mt-6 space-y-4"></div>';
                
                packageBuilderContent.innerHTML = content;
                packageBuilderModal.style.display = 'flex';
                calculatePackageTotals();

                document.getElementById('packageBuilderItems').addEventListener('input', calculatePackageTotals);
            }
            
            function calculatePackageTotals() {
                const isSiUnits = document.getElementById('unitToggle').checked;
                const quantityInputs = document.querySelectorAll('#packageBuilderItems .quantity-input');
                const selectedItemsInBuilder = Array.from(quantityInputs).map(input => {
                    const item = tableData.find(d => d.id == input.dataset.id);
                    return { ...item, quantity: input.valueAsNumber || 0 };
                });

                const totals = {};
                let isAnyItemOverLimit = false;

                selectedItemsInBuilder.forEach(item => {
                    if (item.quantity > 0 && item.un2911_limit_val !== null && item.activity_val > item.un2911_limit_val) {
                        isAnyItemOverLimit = true;
                    }
                    if (!totals[item.radionuclide]) {
                        totals[item.radionuclide] = { totalActivity: 0, exemptLimit: item.dot_exemption_val, exceptedLimit: item.un2911_pkg_limit_val };
                    }
                    totals[item.radionuclide].totalActivity += item.activity_val * item.quantity;
                });

                let exemptSOR = 0;
                let exceptedSOR = 0;

                for (const nuclide in totals) {
                    if (totals[nuclide].exemptLimit !== null && totals[nuclide].exemptLimit > 0) {
                        exemptSOR += totals[nuclide].totalActivity / totals[nuclide].exemptLimit;
                    }
                    if (totals[nuclide].exceptedLimit !== null && totals[nuclide].exceptedLimit > 0) {
                        exceptedSOR += totals[nuclide].totalActivity / totals[nuclide].exceptedLimit;
                    }
                }

                let classification, explanation, statusColor;

                if (exemptSOR <= 1) {
                    classification = 'Exempt Consignment';
                    statusColor = 'bg-green-500';
                    explanation = 'This package meets the requirements for an Exempt Consignment per 49 CFR § 173.436. It can be shipped without most Class 7 (radioactive) hazmat requirements.';
                } else if (exceptedSOR <= 1 && !isAnyItemOverLimit) {
                    classification = 'Excepted Package (UN 2911)';
                    statusColor = 'bg-yellow-500';
                    explanation = 'This package meets the requirements for an Excepted Package per 49 CFR § 173.425. It can be shipped with reduced regulatory requirements (e.g., no shipping papers required).';
                } else {
                    classification = 'Regulated as Class 7 (Requires Type A Package)';
                    statusColor = 'bg-red-500';
                    explanation = 'This package exceeds the limits for both Exempt and Excepted status. It must be shipped as a fully regulated Class 7 (radioactive) Type A package, which requires certified packaging, shipping papers, and hazmat training.';
                     if (isAnyItemOverLimit) {
                        explanation += ' This is because at least one item exceeds its individual limit for excepted packages.'
                    }
                }

                let totalsContent = `
                    <hr class="dark:border-gray-600">
                    <div class="p-4 rounded-lg ${statusColor} text-white">
                        <h3 class="text-xl font-bold text-center">${classification}</h3>
                    </div>
                    <p class="text-sm dark:text-gray-400">${explanation}</p>
                    <div class="mt-4">
                        <h4 class="font-semibold">Calculation Details:</h4>
                        <p><strong>Exempt Consignment SOR:</strong> ${exemptSOR.toFixed(3)} (Limit: 1.0)</p>
                        <p><strong>Excepted Package SOR:</strong> ${exceptedSOR.toFixed(3)} (Limit: 1.0)</p>
                        ${isAnyItemOverLimit ? '<p class="text-red-500"><strong>Note:</strong> At least one item exceeds its individual UN 2911 limit.</p>' : ''}
                    </div>
                `;

                document.getElementById('packageBuilderTotals').innerHTML = totalsContent;
            }

            closePackageBuilderModalBtn.addEventListener('click', () => {
                packageBuilderModal.style.display = 'none';
            });

            function populateRadionuclideFilter() {
                const nuclides = [...new Set(tableData.map(item => item.radionuclide))].sort();
                radionuclideFilter.innerHTML = '<option value="all">All Radionuclides</option>';
                nuclides.forEach(nuclide => {
                    const option = document.createElement('option');
                    option.value = nuclide;
                    option.textContent = nuclide;
                    radionuclideFilter.appendChild(option);
                });
            }

            helpBtn.addEventListener('click', () => {
                helpModal.style.display = 'flex';
            });
            closeHelpModalBtn.addEventListener('click', () => {
                helpModal.style.display = 'none';
            });

            saveSelectionBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
                localStorage.setItem('savedSelection', JSON.stringify(selectedIds));
                showToast('Selection saved!', 'success');
                loadSelectionBtn.disabled = false;
                clearSavedBtn.disabled = false;
            });

            loadSelectionBtn.addEventListener('click', () => {
                const savedIds = JSON.parse(localStorage.getItem('savedSelection'));
                if (!savedIds || savedIds.length === 0) return;

                clearSelectionBtn.click();

                savedIds.forEach(id => {
                    const checkbox = document.querySelector(`.row-checkbox[data-id="${id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        const changeEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                    }
                });
                showToast('Selection loaded.', 'info');
            });

            clearSavedBtn.addEventListener('click', () => {
                showConfirmationModal('Are you sure you want to clear your saved selection?', () => {
                    localStorage.removeItem('savedSelection');
                    clearSavedBtn.disabled = true;
                    loadSelectionBtn.disabled = true;
                    showToast('Saved selection cleared.', 'success');
                });
            });

            selectAllCheckbox.addEventListener('change', () => {
                const isChecked = selectAllCheckbox.checked;
                const visibleCheckboxes = document.querySelectorAll('#lookupTable tbody tr .row-checkbox');
                visibleCheckboxes.forEach(checkbox => {
                    if (checkbox.checked !== isChecked) {
                        checkbox.checked = isChecked;
                        const changeEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                    }
                });
            });

            addItemBtn.addEventListener('click', () => {
                showAddItemModal();
            });
            closeAddItemModalBtn.addEventListener('click', () => {
                addItemModal.style.display = 'none';
            });
            cancelAddItemBtn.addEventListener('click', () => {
                addItemModal.style.display = 'none';
            });

            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addItemModal.style.display = 'none'; // Close modal immediately for better UX
                const newItemData = {
                    name: document.getElementById('itemName').value,
                    nsn: document.getElementById('itemNsn').value,
                    radionuclide: document.getElementById('itemRadionuclide').value,
                    activity: document.getElementById('itemActivity').value,
                    units: document.getElementById('itemUnits').value,
                };
                
                let customItems = JSON.parse(localStorage.getItem('customItems')) || [];
                const editId = document.getElementById('itemEditId').value;

                if (editId) { // Editing existing item
                    const index = customItems.findIndex(item => item.id == editId);
                    if(index > -1) {
                        customItems[index] = {...newItemData, id: parseInt(editId)};
                    }
                    showToast('Item updated!', 'success');
                } else { // Adding new item
                    const newId = Date.now();
                    customItems.push({...newItemData, id: newId });
                    showToast('Item added!', 'success');
                }
                
                localStorage.setItem('customItems', JSON.stringify(customItems));
                
                tableData = processData(rawTableData, customItems);
                filterTable();
                populateRadionuclideFilter();
                updateCustomItemButtonsState();

                addItemForm.reset();
            });

            clearAddedBtn.addEventListener('click', () => {
                showConfirmationModal("Are you sure you want to delete all custom-added items? This action cannot be undone.", () => {
                    localStorage.removeItem('customItems');
                    tableData = processData(rawTableData, []);
                    filterTable();
                    populateRadionuclideFilter();
                    updateCustomItemButtonsState();
                    showToast('All custom items have been deleted.', 'success');
                });
            });

            function populateAddItemRadionuclides() {
                const nuclides = [...new Set(Object.keys(nrcExemptionValues))].sort();
                itemRadionuclideSelect.innerHTML = '';
                nuclides.forEach(nuclide => {
                    const option = document.createElement('option');
                    option.value = nuclide;
                    option.textContent = nuclide;
                    itemRadionuclideSelect.appendChild(option);
                });
            }

            function showAddItemModal(itemToEdit = null) {
                addItemForm.reset();
                if (itemToEdit) {
                    const customItems = JSON.parse(localStorage.getItem('customItems')) || [];
                    const originalCustomItem = customItems.find(ci => ci.id === itemToEdit.id);

                    document.getElementById('addItemModalTitle').textContent = 'Edit Custom Item';
                    document.getElementById('saveItemBtn').textContent = 'Update Item';
                    document.getElementById('itemEditId').value = itemToEdit.id;
                    document.getElementById('itemName').value = itemToEdit.name;
                    document.getElementById('itemNsn').value = itemToEdit.nsn;
                    document.getElementById('itemRadionuclide').value = itemToEdit.radionuclide;
                    
                    if(originalCustomItem) {
                        document.getElementById('itemActivity').value = originalCustomItem.activity;
                        document.getElementById('itemUnits').value = originalCustomItem.units;
                    }

                } else {
                    document.getElementById('addItemModalTitle').textContent = 'Add Custom Item';
                    document.getElementById('saveItemBtn').textContent = 'Save Item';
                    document.getElementById('itemEditId').value = '';
                }
                addItemModal.style.display = 'flex';
            }

            function deleteCustomItem(itemId) {
                let customItems = JSON.parse(localStorage.getItem('customItems')) || [];
                customItems = customItems.filter(item => item.id !== itemId);
                localStorage.setItem('customItems', JSON.stringify(customItems));

                tableData = processData(rawTableData, customItems);
                filterTable();
                populateRadionuclideFilter();
                updateCustomItemButtonsState();
                showToast('Item deleted.', 'success');
            }

            // --- Import/Export Custom Items ---
            function updateCustomItemButtonsState() {
                const customItems = JSON.parse(localStorage.getItem('customItems')) || [];
                const hasCustomItems = customItems.length > 0;
                clearAddedBtn.disabled = !hasCustomItems;
                exportCustomBtn.disabled = !hasCustomItems;
            }

            exportCustomBtn.addEventListener('click', () => {
                const customItems = JSON.parse(localStorage.getItem('customItems')) || [];
                if (customItems.length === 0) {
                    showToast('No custom items to export.', 'error');
                    return;
                }
                const jsonString = JSON.stringify(customItems, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'radioactive_commodities_custom.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Custom items exported!', 'success');
            });

            importCustomBtn.addEventListener('click', () => {
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedItems = JSON.parse(e.target.result);
                        if (!Array.isArray(importedItems)) {
                            throw new Error('Imported file is not a valid list.');
                        }
                        
                        showConfirmationModal('Do you want to REPLACE your current custom items with the imported list?', () => {
                            localStorage.setItem('customItems', JSON.stringify(importedItems));
                            tableData = processData(rawTableData, importedItems);
                            filterTable();
                            populateRadionuclideFilter();
                            updateCustomItemButtonsState();
                            showToast('Custom items imported successfully!', 'success');
                        });

                    } catch (error) {
                        showToast('Error reading or parsing the file.', 'error');
                        console.error("Import error:", error);
                    } finally {
                        // Reset file input to allow importing the same file again
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            });

            // --- State Management ---
            function saveState() {
                const state = {
                    searchTerm: searchInput.value,
                    radionuclide: radionuclideFilter.value,
                    nrcExempt: nrcExemptFilter.checked,
                    dotExempt: dotExemptFilter.checked,
                    isSiUnits: unitToggle.checked
                };
                localStorage.setItem('lookupTableState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('lookupTableState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    searchInput.value = state.searchTerm || '';
                    radionuclideFilter.value = state.radionuclide || 'all';
                    nrcExemptFilter.checked = state.nrcExempt || false;
                    dotExemptFilter.checked = state.dotExempt || false;
                    unitToggle.checked = state.isSiUnits || false;
                }
            }
            
            // --- Custom Confirmation Modal ---
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalText = document.getElementById('confirmModalText');
            const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
            const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
            let confirmCallback = null;

            function showConfirmationModal(message, onConfirm) {
                confirmModalText.textContent = message;
                confirmCallback = onConfirm;
                confirmModal.style.display = 'flex';
            }

            confirmModalCancelBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            confirmModalConfirmBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback(); // Run the action
                }
                // We no longer hide the confirmModal here, as the callback is now responsible for it.
                confirmCallback = null;
            });

            // --- Clear Filters Button Logic ---
            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                radionuclideFilter.value = 'all';
                nrcExemptFilter.checked = false;
                dotExemptFilter.checked = false;
                // NEW: Explicitly remove the saved state
                localStorage.removeItem('lookupTableState');
                filterTable(); 
            });

            // --- Enhanced Modal Interaction Logic ---
            const allModals = [compareModal, detailModal, packageBuilderModal, helpModal, addItemModal, confirmModal, radionuclideDetailModal, tooltipModal];

            // Close on Escape key
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    // Find the topmost open modal and close it
                    const openModal = allModals.find(m => m.style.display !== 'none');
                    if (openModal) {
                        openModal.style.display = 'none';
                    }
                }
            });

            // Close on overlay click
            allModals.forEach(modal => {
                modal.addEventListener('click', (event) => {
                    // If the click is on the modal's immediate background, close it
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // --- NEW: Radionuclide Detail Modal Logic ---
            function showRadionuclideModal(nuclideId) {
                const details = radionuclideDetails[nuclideId];
                if (!details) return;

                const modalTitle = document.getElementById('radionuclideModalTitle');
                const modalContent = document.getElementById('radionuclideContent');

                modalTitle.textContent = `${details.name} (${nuclideId})`;
                
                let content = `<div class="space-y-3">`;
                content += `<div class="flex justify-between"><strong>Half-life:</strong> <span>${details.halfLife}</span></div>`;
                content += `<div class="flex justify-between"><strong>Decay Mode:</strong> <span>${details.decayMode}</span></div>`;
                content += `<div class="mt-4"><a href="${details.wiki}" target="_blank" class="text-blue-500 hover:underline">Learn More on Wikipedia</a></div>`;
                content += `</div>`;

                modalContent.innerHTML = content;
                radionuclideDetailModal.style.display = 'flex';
            }

            closeRadionuclideModalBtn.addEventListener('click', () => {
                radionuclideDetailModal.style.display = 'none';
            });

            // --- BUG FIX: Add Tooltip Modal function ---
            function showTooltipModal(tooltipKey) {
                const tooltipModalTitle = document.getElementById('tooltipModalTitle');
                const tooltipContent = document.getElementById('tooltipContent');

                const tooltipData = {
                    'nrc_exemption_val': {
                        title: 'NRC Exemption Limit',
                        content: `
                            <p class="mb-2">This value comes from <strong>10 CFR § 30.71, Schedule B</strong>.</p>
                            <p class="mb-2">It represents the maximum activity of a specific radionuclide that can be contained in a single "exempt quantity" item.</p>
                            <p>If an item's activity is at or below this limit, it is generally exempt from NRC licensing requirements for possession and use, provided it's not part of a larger aggregated quantity.</p>
                            <a href="https://www.nrc.gov/reading-rm/doc-collections/cfr/part030/part030-0071.html" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>
                        `
                    },
                    'dot_exemption_val': {
                        title: 'DOT Exemption Limit (Consignment)',
                        content: `
                            <p class="mb-2">This value comes from the "Activity limit for an exempt consignment" column in the table at <strong>49 CFR § 173.436</strong>.</p>
                            <p class="mb-2">It represents the maximum total activity of a specific radionuclide that can be in a single shipment (consignment) to be considered exempt from most hazmat shipping regulations.</p>
                            <p>This is a consignment-level limit, not a per-item or per-package limit.</p>
                            <a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173/subpart-I/section-173.436" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>
                        `
                    },
                    'un2911_limit_val': {
                        title: 'UN 2911 Limit (Per Item)',
                        content: `
                            <p class="mb-2">This value comes from the "Item limits" column in the table at <strong>49 CFR § 173.425</strong> for "Instruments and articles".</p>
                            <p class="mb-2">It is the maximum activity of a specific radionuclide allowed in a single instrument or article to be shipped as an "Excepted package" under UN 2911.</p>
                            <p>Items meeting this limit can be shipped with reduced regulatory requirements compared to fully regulated radioactive material.</p>
                            <a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173/subpart-I/section-173.425" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>
                        `
                    },
                    'un2911_pkg_limit_val': {
                        title: 'UN 2911 Limit (Per Package)',
                        content: `
                            <p class="mb-2">This value comes from the "Package limits" column in the table at <strong>49 CFR § 173.425</strong> for "Instruments and articles".</p>
                            <p class="mb-2">It is the maximum total activity of a specific radionuclide allowed in a single package containing one or more excepted items to be shipped under UN 2911.</p>
                            <p>Even if individual items are below the item limit, the total activity in the package must not exceed this limit.</p>
                            <a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173/subpart-I/section-173.425" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>
                        `
                    }
                };

                const data = tooltipData[tooltipKey];
                if (!data) return;

                tooltipModalTitle.innerHTML = data.title;
                tooltipContent.innerHTML = data.content;
                tooltipModal.style.display = 'flex';
            }
            
            // --- BUG FIX: Add event listener for the tooltip modal close button ---
            closeTooltipModalBtn.addEventListener('click', () => {
                tooltipModal.style.display = 'none';
            });


            // --- Event Listeners for State Saving ---
            const debouncedFilterAndSave = debounce(() => {
                filterTable();
                saveState();
            }, 300);

            searchInput.addEventListener('input', debouncedFilterAndSave);
            radionuclideFilter.addEventListener('change', () => { filterTable(); saveState(); });
            nrcExemptFilter.addEventListener('change', () => { filterTable(); saveState(); });
            dotExemptFilter.addEventListener('change', () => { filterTable(); saveState(); });
            unitToggle.addEventListener('change', () => { filterTable(); saveState(); });


            // --- Initial Load ---
            const customItems = JSON.parse(localStorage.getItem('customItems')) || [];
            tableData = processData(rawTableData, customItems);
            populateRadionuclideFilter();
            populateAddItemRadionuclides();
            updateCustomItemButtonsState();
            
            loadState(); // Load saved filters and toggles
            filterTable(); // Apply loaded filters
            sortTable('name'); // Initial sort

            if (localStorage.getItem('savedSelection')) {
                loadSelectionBtn.disabled = false;
                clearSavedBtn.disabled = false;
            }
        });
    </script>

</body>
</html>
