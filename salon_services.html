<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Posh Salon Service Matrix</title>
    <style>
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f7f7f7;
            --header-bg: #f0f0f0;
            --accent-color: #203459;
            --danger-hover: #ef5350;
            --danger-color: #f44336;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --success-color: #5db983;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --modal-bg: white;
            --page-bg: #ebf4ff;
        }

        body.dark-mode {
            --primary-bg: #252525;
            --secondary-bg: #2c2c2c;
            --header-bg: #3a3a3a;
            --accent-color: #6c7a99;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --modal-bg: #2c2c2c;
            --page-bg: #1e1e1e;
        }
        
        body.dark-mode .table-container { scrollbar-color: rgba(255, 255, 255, 0.2) transparent; }
        body.dark-mode .table-container::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); }
        body.dark-mode .table-container::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.4); }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--page-bg);
            color: var(--text-color);
            margin: 0;
            padding: 2rem 1rem;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }
        
        body.placing-note { cursor: crosshair; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--primary-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 4rem);
        }
        
        .main-controls, footer { flex-shrink: 0; }
        .main-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .controls-column { display: flex; flex-direction: column; gap: 1rem; }
        .controls-column.middle { text-align: center; }
        .controls-column.right { align-items: flex-end; }
        .main-controls h1 { margin: 0; font-size: 1.75rem; color: var(--accent-color); font-weight: 600; }
        .control-group { position: relative; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .controls-column.right .control-group { justify-content: flex-end; }
        input[type="text"], select, textarea {
            border: 1px solid var(--border-color); padding: 0.75rem 1rem; border-radius: 8px;
            background-color: var(--primary-bg); color: var(--text-color);
            transition: box-shadow 0.2s, background-color 0.3s;
            font-family: inherit; font-size: 1em;
        }
        input[type="text"] { min-width: 200px; }
        select {-webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; padding-right: 2.5rem; }
        body.dark-mode select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); }

        input[type="text"]:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px var(--accent-color); opacity: 0.8; }
        button {
            background-color: var(--accent-color); color: white; border: none; padding: 0.75rem 1.5rem;
            border-radius: 8px; cursor: pointer; font-weight: 500;
            transition: background-color 0.2s, opacity 0.2s; white-space: nowrap;
        }
        button:hover { opacity: 0.85; }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        body.dark-mode button:disabled { background-color: #555; }
        button.danger-btn { background-color: var(--danger-color); }
        button.save-btn { background-color: var(--success-color); }
        #theme-toggle-btn {
            background-color: var(--secondary-bg); color: var(--text-color); padding: 0;
            width: 44px; height: 44px; font-size: 1.5rem; line-height: 44px; text-align: center;
        }
        .table-container {
            flex-grow: 1; overflow: auto; border-radius: 12px;
            box-shadow: var(--shadow); background-color: var(--modal-bg);
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 0.5rem; border-bottom: 1px solid var(--border-color); vertical-align: top; position: relative; }
        th { position: sticky; top: 0; z-index: 3; background-color: var(--header-bg); font-weight: 600; white-space: nowrap; }
        th .editable { cursor: pointer; }
        tr { background-color: var(--primary-bg); transition: background-color 0.2s ease-in-out; }
        tr:nth-child(even) { background-color: var(--secondary-bg); }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: color-mix(in srgb, var(--accent-color) 15%, var(--primary-bg)); }
        td:first-child, th:first-child { font-weight: 500; position: sticky; left: 0; background-color: inherit; z-index: 2; }
        th:first-child { background-color: var(--header-bg); z-index: 4; }
        .cell-wrapper { padding: 0.5rem 0.75rem; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .name-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .stylist-info-wrapper { display: flex; align-items: center; gap: 12px; }
        .stylist-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background-color: var(--border-color); border: 2px solid var(--primary-bg); }
        .stylist-info { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; text-align: left; }
        .level-text { font-size: 0.9em; color: #888; }
        .editable { padding: 4px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; font-weight: 600; }
        .editable.profile-link, .editable.level-text { cursor: pointer; }
        .editable.profile-link { font-weight: 600; }
        .editable:hover { background-color: var(--accent-color); color: white; opacity: 0.8; }
        .remove-btn { background: none; border: none; cursor: pointer; color: #aaa; font-size: 1.1em; padding: 4px; border-radius: 50%; width: 28px; height: 28px; line-height: 1; }
        .remove-btn:hover { color: white; background-color: var(--danger-hover); }
        td { text-align: center; }
        td:first-child { text-align: left; white-space: nowrap; }
        .cell-content { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; accent-color: var(--accent-color); }
        .price-text { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s, color 0.2s; min-width: 70px; display: inline-block; }
        .price-text:hover { background-color: var(--accent-color); color: white; opacity: 0.8; }
        .price-text.placeholder { color: #888; font-style: italic; font-size: 0.9em; }
        .price-input, .name-input { width: 70px; padding: 4px; border: 1px solid var(--accent-color); border-radius: 4px; text-align: center; font-family: inherit; font-size: 1em; }
        .name-input { width: 150px; text-align: left; }
        .sticky-note { position: absolute; bottom: 4px; right: 4px; width: 16px; height: 16px; border-radius: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        #color-palette { position: absolute; top: 110%; right: 0; background-color: var(--secondary-bg); padding: 0.75rem; border-radius: 8px; box-shadow: var(--shadow); z-index: 10; }
        .color-palette { display: flex; gap: 8px; }
        .color-box { width: 28px; height: 28px; border-radius: 6px; cursor: pointer; box-sizing: border-box; transition: transform 0.2s; }
        .color-box:hover { transform: scale(1.1); }
        .color-box.selected { border-color: var(--accent-color) !important; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .color-box.cancel-note { background-color: var(--secondary-bg); color: var(--danger-color); font-size: 1.5rem; font-weight: bold; line-height: 24px; text-align: center; border: 1px solid var(--border-color); }
        .color-box.cancel-note:hover { background-color: var(--danger-color); color: white; }
        .sort-arrow { cursor: pointer; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 1em; height: 1em; display: flex; align-items: center; justify-content: center; color: #ccc; transition: color 0.2s ease-in-out; }
        .sort-arrow svg { width: 100%; height: 100%; }
        .sort-arrow.active { color: var(--text-color); }
        
        .modal-backdrop {
            display: none; position: fixed; z-index: 999; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5);
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; }

        .modal-popup {
            display: none; position: fixed; z-index: 1000; left: 50%; top: 50%;
            padding: 2rem; background: var(--modal-bg); border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left; width: 90%; max-width: 600px;
            opacity: 0; visibility: hidden;
            transform: translate(-50%, -50%) scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s;
        }
        .modal-popup.visible {
            opacity: 1; visibility: visible;
            transform: translate(-50%, -50%) scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s;
        }
        
        #note-popup { border-top: 10px solid transparent; padding-top: 1.5rem; }
        .modal-popup h2 { margin-top: 0; color: var(--accent-color); }
        #note-popup-content { white-space: pre-wrap; padding: 1rem; border-radius: 8px; background-color: var(--secondary-bg); }
        .modal-popup .delete-note { display: inline-block; margin-top: 1rem; color: var(--danger-hover); cursor: pointer; text-decoration: underline; }
        .modal-popup .close-popup { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; line-height: 1; cursor: pointer; border: none; background: none; color: #aaa; transition: color 0.2s; }
        .modal-popup .close-popup:hover { color: var(--text-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #note-entry-color-swatch { width: 24px; height: 24px; border-radius: 6px; }
        #note-entry-textarea, #profile-bio-textarea, #service-description-textarea { width: 100%; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; resize: vertical; box-sizing: border-box; font-family: inherit; font-size: 1em; background-color: var(--primary-bg); color: var(--text-color); }
        #note-entry-textarea:focus, #profile-bio-textarea:focus, #service-description-textarea:focus { outline: none; box-shadow: 0 0 0 3px var(--accent-color); opacity: 0.8; }
        #note-entry-textarea { height: 120px; }
        #profile-bio-textarea, #service-description-textarea { height: 100px; margin-top: 0.5rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .modal-actions button.secondary { background-color: #6c757d; }
        .manual-content { max-height: 70vh; overflow-y: auto; padding-right: 1rem; }
        .manual-content h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        #service-stylists-list p, #service-performers-list p { line-height: 1.6; margin: 0 0 0.5rem 0; padding-left: 1rem; border-left: 3px solid var(--border-color); }
        .manual-content p, .manual-content li { line-height: 1.6; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column-reverse; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: fadeIn 0.3s ease-out forwards; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--accent-color); }
        .toast.fade-out { animation: fadeOut 0.5s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        .table-container::-webkit-scrollbar { width: 12px; height: 12px; }
        .table-container::-webkit-scrollbar-track { background: transparent; }
        .table-container::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
        .table-container::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }
        .table-container { scrollbar-width: thin; scrollbar-color: rgba(0, 0, 0, 0.2) transparent; }
        .dev-mode-only { display: none !important; }
        body.developer-mode-active .dev-mode-only { display: flex !important; }
        footer { text-align: center; margin-top: 2rem; padding: 1rem 0 0 0; font-size: 0.9em; color: #888; }
        footer a { color: var(--accent-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        
/* Profile Modal Styles */
#profile-popup { max-width: 520px; }

#profile-popup .profile-content { display: grid; grid-template-columns: 100px 1fr; gap: 2.25rem; align-items: flex-start; }

#profile-popup .profile-photo-area { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; flex: 0 0 100px; }

#profile-photo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; background-color: var(--secondary-bg); border: 2px solid var(--border-color); }
#profile-details { flex: 1; display: flex; flex-direction: column; }
#profile-name-wrapper { display: flex; align-items: center; gap: 0.5rem; }
#profile-name { font-size: 1.3rem; font-weight: 600; color: var(--accent-color); margin: 0 0 0.25rem 0; }
#profile-level { font-size: 0.9rem; color: #888; margin: 0; }
#profile-color-palette { margin-top: 0.25rem; display: none; flex-wrap: wrap; gap: 6px; justify-content: center; max-width: 100px; }
#profile-edit-name-btn { padding: 0; width: 24px; height: 24px; font-size: 0.9rem; line-height: 24px; background: var(--secondary-bg); color: var(--text-color);}
#profile-details .modal-actions { justify-content: flex-end; margin-top: 0.75rem; }
#profile-bio-textarea { height: 80px; margin-top: 0.25rem; }
#profile-change-photo-btn, #profile-delete-photo-btn, #profile-change-color-btn, #profile-save-bio-btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

        /* Service Details Modal Styles */
        #service-details-popup .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        #service-details-popup h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        #service-details-popup .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        
        /* Drag and Drop Styles */
        [draggable="true"] { cursor: grab; }
        [draggable="true"]:active { cursor: grabbing; }
        .dragging { opacity: 0.5; background: var(--accent-color) !important; color: white; }
        .drag-over { border-top: 3px solid var(--accent-color); }
        .mobile-drag-over { border-top: 3px solid var(--accent-color); }

        @media print {
            .main-controls, footer, #modal-backdrop, .modal-popup { display: none !important; }
            body { padding: 1in; background-color: #ffffff; }
            .container { padding: 0; margin: 0; box-shadow: none; border-radius: 0; height: auto; width: 100%; max-width: 100%; }
            .table-container { overflow: visible; box-shadow: none; height: auto; }
            table { font-size: 10pt; width: 100%; min-width: 100%; }
            th, td, th:first-child, td:first-child { position: static; }
            tr { page-break-inside: avoid; }
            tr:nth-child(even) { background-color: #ffffff !important; }
        }

        /* --- MOBILE RESPONSIVE STYLES --- */
        #mobile-view-container { display: none; flex-grow: 1; overflow-y: auto; padding: 0 0.5rem; }
        .stylist-card {
            background-color: var(--secondary-bg); border-radius: 12px; margin-bottom: 1.5rem;
            padding: 1.25rem; box-shadow: var(--shadow); border-left: 5px solid var(--accent-color);
        }
        .stylist-card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); position: relative;
        }
        .stylist-card-header .stylist-info-wrapper { gap: 15px; flex-grow: 1; }
        .stylist-card-header .sticky-note { position: relative; top: 0; right: 0; bottom: 0; align-self: center; }
        .service-item {
            display: grid; grid-template-columns: 1fr auto; align-items: center;
            padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); gap: 1rem;
        }
        .service-item:last-child { border-bottom: none; }
        .service-name { font-weight: 500; }
        .service-controls { display: flex; align-items: center; gap: 1rem; position: relative; }
        .service-controls .sticky-note { position: relative; top: 0; right: 0; bottom: 0; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        @media (max-width: 992px) {
            .main-controls { flex-direction: column; align-items: stretch; gap: 1.5rem; }
            .controls-column { width: 100%; text-align: center; }
            .controls-column.right, .controls-column.left { align-items: center; }
            .controls-column.right .control-group { justify-content: center; }
        }
        @media (max-width: 800px) {
            body { padding: 1rem 0; overflow-y: auto; }
            .container { border-radius: 0; padding: 1rem; height: auto; min-height: 100vh; }
            .table-container { display: none; }
            #mobile-view-container { display: block; }
            #service-details-popup .details-grid { grid-template-columns: 1fr; }
            #profile-popup .profile-content { flex-direction: column; align-items: center; }
            
            /* Ensure input font size is 16px on mobile to prevent auto-zoom */
            .price-input, .name-input {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div class="container">
        
        <div class="main-controls">
            <div class="controls-column left">
                <div class="control-group">
                    <input type="text" id="new-stylist-name" placeholder="New Stylist Name...">
                    <button id="add-stylist-btn">Add Stylist</button>
                </div>
                <div class="control-group">
                    <input type="text" id="new-service-name" placeholder="New Service Name...">
                    <button id="add-service-btn">Add Service</button>
                </div>
            </div>
            <div class="controls-column middle">
                <h1>Posh Salon Service Matrix</h1>
                <div class="control-group" style="justify-content: center;">
                    <select id="level-filter"><option value="all">All Levels</option></select>
                    <input type="text" id="search-input" placeholder="Search Stylists...">
                </div>
            </div>
            <div class="controls-column right">
                <div class="control-group">
                    <button id="save-btn" class="save-btn">Save</button>
                    <button id="export-btn">Export</button>
                    <button id="import-btn">Import</button>
                    <button id="print-btn">Print</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
                <div class="control-group">
                    <button id="add-note-btn">Add Note</button>
                    <div id="color-palette" class="color-palette" style="display: none;"></div>
                    <button id="manual-btn">User Manual</button>
                    <button id="theme-toggle-btn">🌓</button>
                </div>
                 <div class="control-group dev-mode-only">
                    <button id="undo-btn">Undo</button>
                    <button id="redo-btn">Redo</button>
                    <button id="reset-all-btn" class="danger-btn">Reset All Data</button>
                </div>
            </div>
        </div>

        <div class="table-container"><table id="services-table"><thead></thead><tbody></tbody></table></div>
        <div id="mobile-view-container"></div>

        <footer>
            <p>
                Posh Salon Service Matrix v2.44 | Last Updated: <span id="last-updated-span">Never</span> | 
                <a href="https://www.poshsalonwbg.com" target="_blank" rel="noopener noreferrer">Posh Salon Website</a>
            </p>
        </footer>
    </div>

    <div id="note-popup" class="modal-popup"><button class="close-popup">&times;</button><h2>Sticky Note</h2><div id="note-popup-content"></div><span id="delete-note-popup" class="delete-note">Delete this note</span></div>
    <div id="manual-popup" class="modal-popup"><button class="close-popup">&times;</button><div class="manual-content"><h2>Posh Salon: User Manual ✂️</h2>
        <p>Welcome to the Service Matrix! Think of this as your digital cheat-sheet for everything related to stylists and the services they offer. Here’s a detailed guide on how to use it.</p>
        <h3>Getting Started: The Basics</h3><ul><li><strong>Adding a Stylist:</strong> In the top-left corner, type a new stylist's name into the "New Stylist Name..." box and click the "Add Stylist" button. They will be added to the bottom of the list.</li><li><strong>Adding a Service:</strong> Similarly, type a new service into the "New Service Name..." box and click "Add Service". A new column for this service will appear on the right side of the table.</li><li><strong>Marking Services:</strong> In the main grid, simply check the box where a stylist's row and a service's column meet to indicate they perform that service. On mobile, use the toggle switch.</li></ul>
        <h3>Editing Information</h3><ul><li><strong>Edit a Stylist's Name:</strong> Single-click on a stylist's name to open their Profile pop-up. Next to their name at the top, click the little pencil icon (✏️) to change it.</li><li><strong>Edit a Service's Name:</strong> Double-click on a service name in the table header. An input box will appear, allowing you to type a new name. A trash can icon (🗑️) will also appear if you wish to delete the service entirely.</li><li><strong>Edit a Price or Level:</strong> Simply single-click on any price or a stylist's level (e.g., "Level Five") in the table. An input box will appear for you to enter the new value.</li></ul>
        <h3>Stylist & Service Profiles</h3><ul><li><strong>Stylist Profiles:</strong> Single-click any stylist's name to open their profile. Here you can upload a photo, change their avatar color, and write a bio or important notes about their specialties.</li><li><strong>Service Details:</strong> Single-click any service name in the table header. A details panel will open, showing which stylists perform that service. You can also add information like the standard duration, price range, and a detailed description for that service.</li></ul>
        <h3>Organizing Your View</h3><ul><li><strong>Search and Filter:</strong> Use the central search bar to quickly find a stylist by name. You can also use the dropdown menu next to it to filter the view and show only stylists of a specific level.</li><li><strong>Reorder Stylists (Drag & Drop):</strong> To change the order of stylists, just click and hold on a stylist's row (or their card on mobile), drag it to a new position, and release.</li><li><strong>Sort Columns:</strong> To sort the table, click the small arrow icons (▲▼) in any column header. You can sort by stylist name (A-Z) or by price (low to high). Clicking the same arrow again will reverse the sort direction.</li></ul>
        <h3>Advanced Tools</h3><ul><li><strong>Autosave & Manual Save:</strong> All your changes are automatically saved to your browser a few seconds after you stop working. The "Last Updated" timestamp in the footer will confirm the last save time. You can also click the green "Save" button for an immediate save.</li><li><strong>Developer Mode (Ctrl+Alt+D):</strong> For power users, pressing `Ctrl+Alt+D` on your keyboard will reveal a hidden set of tools: **Undo**, **Redo**, and a **Reset All Data** button. The Undo/Redo functions can also be accessed with the standard `Ctrl+Z` and `Ctrl+Y` keyboard shortcuts.</li></ul>
    </div></div>
    <div id="note-entry-popup" class="modal-popup"><div class="modal-header"><h2>Add Sticky Note</h2><div id="note-entry-color-swatch"></div></div><textarea id="note-entry-textarea" placeholder="Enter your note text here..."></textarea><div class="modal-actions"><button id="note-entry-cancel" class="secondary">Cancel</button><button id="note-entry-save">Save Note</button></div></div>
    <div id="confirm-popup" class="modal-popup"><h2 id="confirm-title">Confirm Action</h2><p id="confirm-message">Are you sure?</p><div class="modal-actions"><button id="confirm-cancel-btn" class="secondary">Cancel</button><button id="confirm-confirm-btn" class="danger-btn">Confirm</button></div></div>
    <div id="service-stylists-popup" class="modal-popup"><button class="close-popup">&times;</button><h2 id="service-stylists-title"></h2><div id="service-stylists-list"></div></div>
    <div id="profile-popup" class="modal-popup"><button class="close-popup">&times;</button><div class="profile-content"><div class="profile-photo-area"><img id="profile-photo" src="" alt="Stylist Photo"><button id="profile-change-photo-btn">Change Photo</button><button id="profile-delete-photo-btn" class="danger-btn">Delete Photo</button><button id="profile-change-color-btn">Change Color</button><div id="profile-color-palette" class="color-palette"></div></div><div class="profile-details"><div id="profile-name-wrapper"><h2 id="profile-name"></h2><button id="profile-edit-name-btn">✏️</button></div><p id="profile-level"></p><label for="profile-bio-textarea">Bio / Notes:</label><textarea id="profile-bio-textarea" rows="4"></textarea><div class="modal-actions"><button id="profile-save-bio-btn" class="save-btn">Save Bio</button></div></div></div></div>
    <div id="service-details-popup" class="modal-popup"><button class="close-popup">&times;</button><h2 id="service-details-title">Service Details</h2><div class="details-grid"><div><div class="input-group"><label for="service-duration-input">Standard Duration:</label><input type="text" id="service-duration-input" placeholder="e.g., 2.5 hours"></div></div><div><div class="input-group"><label for="service-pricerange-input">Base Price Range:</label><input type="text" id="service-pricerange-input" placeholder="e.g., $150 - $250"></div></div></div><div class="input-group" style="margin-top: 1rem;"><label for="service-description-textarea">Description:</label><textarea id="service-description-textarea" rows="3" placeholder="e.g., A detailed description of the service, including the process, products used, and expected results."></textarea></div><h3>Performed By:</h3><div id="service-performers-list"></div><div class="modal-actions"><button id="service-details-save-btn" class="save-btn">Save Details</button></div></div>
    <div id="toast-container"></div>
    <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE AND CONSTANTS ---
        let stateHistory = [];
        let currentStateIndex = -1;
        let isPlacingNote = false;
        let selectedNoteColor = null;
        let clickTimer = null;
        let sortState = { key: 'manual', direction: 'asc' };
        
        // --- DOM ELEMENT REFERENCES ---
        const servicesTable = document.getElementById('services-table');
        const mobileViewContainer = document.getElementById('mobile-view-container');
        const mainContentContainer = document.querySelector('.container');
        const newStylistInput = document.getElementById('new-stylist-name');
        const newServiceInput = document.getElementById('new-service-name');
        const addNoteBtn = document.getElementById('add-note-btn');
        const colorPalette = document.getElementById('color-palette');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const searchInput = document.getElementById('search-input');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const lastUpdatedSpan = document.getElementById('last-updated-span');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const levelFilter = document.getElementById('level-filter');
        const photoUploadInput = document.getElementById('photo-upload-input');
        
        // --- CORE DATA ---
        const LOCAL_STORAGE_KEY = 'salonMatrixData';
        const THEME_KEY = 'salonMatrixTheme';
        const NOTE_COLORS = [
            { color: '#ffe880', border: 'none' }, { color: '#adcffa', border: 'none' }, { color: '#ffbaba', border: 'none' },
            { color: '#a8e6a8', border: 'none' }, { color: '#e0c4ff', border: 'none' }
        ];
        const defaultData = {
            salonState: {
                services: [
                    { name: "Haircut & Style", note: null, duration: "", priceRange: "", description: "" },
                    { name: "Full Color", note: null, duration: "", priceRange: "", description: "" },
                    { name: "Balayage", note: { text: "Requires consultation.", color: "#e0c4ff", border: "none" }, duration: "", priceRange: "", description: "" },
                    { name: "Keratin Treatment", note: null, duration: "", priceRange: "", description: "" }
                ],
                stylists: [{
                    name: "Alex Chen", level: "Level Five", note: null, photo: null, bio: "", avatarColor: null, services: [
                        { checked: true, price: "85.00", note: null }, { checked: true, price: "150.00", note: null },
                        { checked: true, price: "275.00", note: { text: "Expert level.", color: "#adcffa", border: "none" } },
                        { checked: false, price: "", note: null }
                    ]
                }, {
                    name: "Brianna R.", level: "Level Seven", note: { text: "Specializes in curly hair.", color: "#ffe880", border: "none" }, photo: null, bio: "Specializes in curly hair and vibrant color.", avatarColor: null, services: [
                        { checked: true, price: "95.00", note: null }, { checked: false, price: "", note: null },
                        { checked: true, price: "315.00", note: null }, { checked: true, price: "350.00", note: null }
                    ]
                }]
            },
            timestamp: "Never"
        };
        
        // --- HELPER & UTILITY FUNCTIONS ---
        const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), delay); }; };

        const generateAvatar = (stylist) => {
            if (stylist.photo) { return stylist.photo; }
            const name = stylist.name || '?';
            const initial = name.charAt(0).toUpperCase();
            let bgColorHex;
            if (stylist.avatarColor) {
                bgColorHex = stylist.avatarColor;
            } else {
                let hash = 0;
                for (let i = 0; i < name.length; i++) { hash = name.charCodeAt(i) + ((hash << 5) - hash); }
                const colorIndex = Math.abs(hash % NOTE_COLORS.length);
                bgColorHex = NOTE_COLORS[colorIndex].color;
            }
            const r = parseInt(bgColorHex.slice(1, 3), 16);
            const g = parseInt(bgColorHex.slice(3, 5), 16);
            const b = parseInt(bgColorHex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
            const textColor = luminance > 150 ? '#333333' : '#FFFFFF';
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="${bgColorHex}" /><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="50" font-weight="bold" fill="${textColor}" font-family="-apple-system, sans-serif">${initial}</text></svg>`;
            return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
        };

        const getSortIcon = (key) => {
            const upArrow = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M7 14l5-5 5 5z"/></svg>`;
            const downArrow = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M7 10l5 5 5-5z"/></svg>`;
            const defaultArrows = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M7 15l5-5 5 5zm0-6l5 5 5-5z"/></svg>`;

            if (sortState.key === key) {
                return sortState.direction === 'asc' ? upArrow : downArrow;
            }
            return defaultArrows;
        };

        const showModal = (popup) => {
            modalBackdrop.style.display = 'block';
            popup.style.display = 'block';
            
            requestAnimationFrame(() => {
                modalBackdrop.classList.add('visible');
                popup.classList.add('visible');
            });
        };
        const hideModal = (popup) => {
            modalBackdrop.classList.remove('visible');
            popup.classList.remove('visible');
            const handler = () => {
                modalBackdrop.style.display = 'none';
                popup.style.display = 'none';
                popup.removeEventListener('transitionend', handler);
            };
            popup.addEventListener('transitionend', handler);
        };

        const showToast = (message, type = 'info', duration = 3000) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, duration);
        };

        const sortData = (key) => {
            const currentKey = !isNaN(parseInt(key)) ? parseInt(key) : key;
            let newDirection;
            if (sortState.key === currentKey) {
                newDirection = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                newDirection = 'asc';
            }
            sortState = { key: currentKey, direction: newDirection };
            updateDisplay();
        };

        const showNoteEntryPopup = (row, col) => {
            const popup = document.getElementById('note-entry-popup');
            const swatch = document.getElementById('note-entry-color-swatch');
            const textarea = document.getElementById('note-entry-textarea');
            const saveBtn = document.getElementById('note-entry-save');
            const cancelBtn = document.getElementById('note-entry-cancel');
            textarea.value = '';
            swatch.style.backgroundColor = selectedNoteColor.color;
            swatch.style.border = selectedNoteColor.border || 'none';
            const handleSave = () => {
                const newState = deepClone(stateHistory[currentStateIndex]);
                const newNote = { text: textarea.value, ...selectedNoteColor };
                if (row === -1) newState.services[col - 1].note = newNote;
                else if (col === 0) newState.stylists[row].note = newNote;
                else newState.stylists[row].services[col - 1].note = newNote;
                recordChange(newState);
                showToast("Note added.", "success");
                cleanup();
            };
            const handleCancel = () => cleanup();
            const cleanup = () => {
                hideModal(popup);
                togglePlacingNote(false);
                saveBtn.removeEventListener('click', handleSave);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            saveBtn.addEventListener('click', handleSave, { once: true });
            cancelBtn.addEventListener('click', handleCancel, { once: true });
            showModal(popup);
            textarea.focus();
        };

        const showConfirmModal = (message, onConfirm) => {
            const popup = document.getElementById('confirm-popup');
            const confirmMsg = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-confirm-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            confirmMsg.textContent = message;
            const handleConfirm = () => { onConfirm(); cleanup(); };
            const handleCancel = () => cleanup();
            const cleanup = () => {
                hideModal(popup);
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            confirmBtn.addEventListener('click', handleConfirm, { once: true });
            cancelBtn.addEventListener('click', handleCancel, { once: true });
            showModal(popup);
        };
        
        const togglePlacingNote = (placing) => {
            isPlacingNote = placing;
            selectedNoteColor = null;
            document.body.classList.toggle('placing-note', placing);
            colorPalette.style.display = placing ? 'flex' : 'none';
            if (!placing) colorPalette.querySelector('.selected')?.classList.remove('selected');
        };

        const showNotePopup = (row, col) => {
            const popup = document.getElementById('note-popup');
            const salonState = stateHistory[currentStateIndex];
            let note;
            if (row === -1) note = salonState.services[col - 1].note;
            else if (col === 0) note = salonState.stylists[row].note;
            else note = salonState.stylists[row].services[col - 1].note;
            if (!note) return;
            popup.style.borderTopColor = (note.border !== 'none' && note.color === '#ffffff') ? '#333' : note.color;
            popup.querySelector('#note-popup-content').textContent = note.text;
            document.getElementById('delete-note-popup').onclick = () => {
                showConfirmModal("Are you sure you want to delete this note?", () => {
                    const newState = deepClone(salonState);
                    if (row === -1) newState.services[col - 1].note = null;
                    else if (col === 0) newState.stylists[row].note = null;
                    else newState.stylists[row].services[col - 1].note = null;
                    hideModal(popup);
                    recordChange(newState);
                    showToast("Note deleted.", "info");
                });
            };
            showModal(popup);
        };

        const showProfileModal = (stylistIndex) => {
            const popup = document.getElementById('profile-popup');
            const salonState = stateHistory[currentStateIndex];
            const stylist = salonState.stylists[stylistIndex];
            if (!stylist) return;

            const photoEl = document.getElementById('profile-photo');
            const nameWrapper = document.getElementById('profile-name-wrapper');
            const nameEl = document.getElementById('profile-name');
            const editNameBtn = document.getElementById('profile-edit-name-btn');
            const levelEl = document.getElementById('profile-level');
            const bioTextarea = document.getElementById('profile-bio-textarea');
            const changePhotoBtn = document.getElementById('profile-change-photo-btn');
            const deletePhotoBtn = document.getElementById('profile-delete-photo-btn');
            const saveBioBtn = document.getElementById('profile-save-bio-btn');
            const changeColorBtn = document.getElementById('profile-change-color-btn');
            const profilePalette = document.getElementById('profile-color-palette');
            
            const existingInput = popup.querySelector('.profile-details > .name-input');
            if (existingInput) {
                existingInput.replaceWith(nameWrapper);
            }
            nameEl.textContent = stylist.name;
            
            levelEl.textContent = stylist.level || 'Add Level';
            levelEl.className = 'editable level-text';
            levelEl.dataset.stylistIndex = stylistIndex;
            
            photoEl.src = generateAvatar(stylist);
            bioTextarea.value = stylist.bio || '';
            profilePalette.style.display = 'none';

            editNameBtn.onclick = () => {
                const originalText = nameEl.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'name-input';
                input.style.fontSize = '1.5rem';
                input.value = originalText;
                nameWrapper.replaceWith(input);
                
                const saveName = () => {
                    const newText = input.value.trim();
                    if (newText && newText !== originalText) {
                        const newState = deepClone(stateHistory[currentStateIndex]);
                        newState.stylists[stylistIndex].name = newText;
                        recordChange(newState);
                        showToast("Name updated.", "success");
                        nameEl.textContent = newText;
                    } else {
                        nameEl.textContent = originalText;
                    }
                    input.replaceWith(nameWrapper);
                };

                input.focus();
                input.addEventListener('blur', saveName, { once: true });
                
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') e.target.blur();
                    if (e.key === 'Escape') {
                        input.value = originalText;
                        e.target.blur();
                    }
                });
            };
            
            changePhotoBtn.onclick = () => photoUploadInput.click();
            
            photoUploadInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (readEvent) => {
                    const newState = deepClone(stateHistory[currentStateIndex]);
                    newState.stylists[stylistIndex].photo = readEvent.target.result;
                    photoEl.src = readEvent.target.result;
                    recordChange(newState);
                    showToast("Photo updated.", "success");
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            deletePhotoBtn.onclick = () => {
                const newState = deepClone(stateHistory[currentStateIndex]);
                newState.stylists[stylistIndex].photo = null;
                photoEl.src = generateAvatar(newState.stylists[stylistIndex]);
                recordChange(newState);
                showToast("Photo removed.", "info");
            };
            
            changeColorBtn.onclick = () => {
                profilePalette.style.display = profilePalette.style.display === 'flex' ? 'none' : 'flex';
            };
            
            profilePalette.innerHTML = '';
            NOTE_COLORS.forEach(c => {
                const box = document.createElement('div');
                box.className = 'color-box';
                box.style.backgroundColor = c.color;
                box.style.border = c.border || '2px solid transparent';
                box.onclick = () => {
                    const newState = deepClone(stateHistory[currentStateIndex]);
                    newState.stylists[stylistIndex].avatarColor = c.color;
                    photoEl.src = generateAvatar(newState.stylists[stylistIndex]);
                    recordChange(newState);
                    showToast("Avatar color changed.", "success");
                    profilePalette.style.display = 'none';
                };
                profilePalette.appendChild(box);
            });

            saveBioBtn.onclick = () => {
                const newState = deepClone(stateHistory[currentStateIndex]);
                newState.stylists[stylistIndex].bio = bioTextarea.value;
                recordChange(newState);
                showToast("Bio saved.", "success");
            };
            
            showModal(popup);
        };
        
        const showServiceDetailsModal = (serviceIndex) => {
            const popup = document.getElementById('service-details-popup');
            const salonState = stateHistory[currentStateIndex];
            const service = salonState.services[serviceIndex];
            if (!service) return;

            const title = document.getElementById('service-details-title');
            const durationInput = document.getElementById('service-duration-input');
            const priceRangeInput = document.getElementById('service-pricerange-input');
            const descriptionTextarea = document.getElementById('service-description-textarea');
            const performersList = document.getElementById('service-performers-list');
            const saveBtn = document.getElementById('service-details-save-btn');
            
            title.textContent = `${service.name} Details`;
            durationInput.value = service.duration || '';
            priceRangeInput.value = service.priceRange || '';
            descriptionTextarea.value = service.description || '';

            const performers = salonState.stylists
                .filter(stylist => stylist.services[serviceIndex]?.checked)
                .map(stylist => stylist.name);
            
            performersList.innerHTML = performers.length > 0
                ? performers.map(name => `<p>${name}</p>`).join('')
                : '<p>No stylists currently perform this service.</p>';

            saveBtn.onclick = () => {
                const newState = deepClone(salonState);
                const serviceToUpdate = newState.services[serviceIndex];
                serviceToUpdate.duration = durationInput.value;
                serviceToUpdate.priceRange = priceRangeInput.value;
                serviceToUpdate.description = descriptionTextarea.value;
                recordChange(newState);
                showToast("Service details saved.", "success");
                hideModal(popup);
            };

            showModal(popup);
        };
        
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleBtn.textContent = '🌓';
            }
        };
        
        const handlePrint = () => {
            const salonState = stateHistory[currentStateIndex];
            const printStyles = `<style>@page{size:portrait;margin:0.75in}body{font-family:Arial,sans-serif;font-size:10pt}h1{font-size:16pt;text-align:center;margin-bottom:20px}p.timestamp{text-align:center;font-style:italic;font-size:9pt;color:#555}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ccc;padding:6px;text-align:center}th{background-color:#f0f0f0;font-weight:bold}thead{display:table-header-group}</style>`;
            let tableHtml = '<table><thead><tr><th>Stylist</th>';
            salonState.services.forEach(service => { tableHtml += `<th>${service.name}</th>`; });
            tableHtml += '</tr></thead><tbody>';
            salonState.stylists.forEach(stylist => {
                tableHtml += `<tr><td><strong>${stylist.name}</strong><br><small>${stylist.level}</small></td>`;
                stylist.services.forEach(service => {
                    let cellContent = service.checked ? (service.price ? `$${parseFloat(service.price).toFixed(2)}` : '') : '';
                    tableHtml += `<td>${cellContent}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            const timestamp = `Generated on: ${new Date().toLocaleString()}`;
            const fullHtml = `<!DOCTYPE html><html><head><title>Posh Salon Service Matrix</title>${printStyles}</head><body><h1>Posh Salon Service Matrix</h1><p class="timestamp">${timestamp}</p>${tableHtml}</body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(fullHtml);
            printWindow.document.close();
            printWindow.onload = () => { printWindow.print(); printWindow.close(); };
        };

        const populateLevelFilter = () => {
            const salonState = stateHistory[currentStateIndex];
            if (!salonState) return;
            const currentFilterValue = levelFilter.value;
            const levels = new Set(salonState.stylists.map(s => s.level));
            while(levelFilter.options.length > 1) {
                levelFilter.remove(1);
            }
            levels.forEach(level => {
                if (level) {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    levelFilter.appendChild(option);
                }
            });
            levelFilter.value = currentFilterValue;
        };

        // --- STATE MANAGEMENT (UNDO/REDO) ---
        const updateUndoRedoButtons = () => {
            undoBtn.disabled = currentStateIndex <= 0;
            redoBtn.disabled = currentStateIndex >= stateHistory.length - 1;
        };

        const recordChange = (newState) => {
            if (currentStateIndex < stateHistory.length - 1) {
                stateHistory = stateHistory.slice(0, currentStateIndex + 1);
            }
            stateHistory.push(newState);
            currentStateIndex++;
            updateDisplay();
            updateUndoRedoButtons();
            debouncedSave();
        };

        const undo = () => {
            if (currentStateIndex > 0) {
                currentStateIndex--;
                updateDisplay();
                updateUndoRedoButtons();
                debouncedSave();
            }
        };

        const redo = () => {
            if (currentStateIndex < stateHistory.length - 1) {
                currentStateIndex++;
                updateDisplay();
                updateUndoRedoButtons();
                debouncedSave();
            }
        };

        // --- RENDER FUNCTIONS ---
        const renderTable = (stylistsToRender) => {
            const thead = servicesTable.querySelector('thead');
            const tbody = servicesTable.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';
            const salonState = stateHistory[currentStateIndex];
            const headerRow = document.createElement('tr');
            const stylistArrow = `<span class="sort-arrow ${sortState.key === 'stylist' ? 'active' : ''}">${getSortIcon('stylist')}</span>`;
            headerRow.innerHTML = `<th><div class="cell-wrapper sortable" data-sort="stylist">Stylist ${stylistArrow}</div></th>`;
            salonState.services.forEach((service, colIndex) => {
                const th = document.createElement('th');
                th.dataset.col = colIndex + 1;
                let noteHTML = service.note ? `<div class="sticky-note" style="background-color: ${service.note.color}; border: ${service.note.border || 'none'};"></div>` : '';
                const serviceArrow = `<span class="sort-arrow ${sortState.key === colIndex ? 'active' : ''}">${getSortIcon(colIndex)}</span>`;
                th.innerHTML = `<div class="cell-wrapper sortable" data-sort="${colIndex}"><div class="name-wrapper"><span class="editable">${service.name}</span></div>${noteHTML}${serviceArrow}</div>`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            stylistsToRender.forEach((stylist) => {
                const originalRowIndex = salonState.stylists.findIndex(s => s.name === stylist.name && s.level === stylist.level);
                const row = document.createElement('tr');
                row.dataset.row = originalRowIndex;
                row.draggable = true;
                const nameCell = document.createElement('td');
                nameCell.dataset.col = 0;
                let stylistNoteHTML = stylist.note ? `<div class="sticky-note" style="background-color: ${stylist.note.color}; border: ${stylist.note.border || 'none'};"></div>` : '';
                
                const levelText = stylist.level || 'Add Level';
                nameCell.innerHTML = `<div class="cell-wrapper">
                    <div class="stylist-info-wrapper">
                        <img class="stylist-avatar" src="${generateAvatar(stylist)}">
                        <div class="stylist-info">
                            <span class="editable profile-link">${stylist.name}</span>
                            <div>
                                <span class="editable level-text">${levelText}</span>
                                <input type="text" class="name-input" value="${levelText === 'Add Level' ? '' : levelText}" style="display:none; width: 120px;">
                            </div>
                        </div>
                    </div>
                    ${stylistNoteHTML}
                </div>`;
                row.appendChild(nameCell);

                stylist.services.forEach((service, colIndex) => {
                    const cell = document.createElement('td');
                    cell.dataset.col = colIndex + 1;
                    const priceHTML = service.price ? `$${parseFloat(service.price).toFixed(2)}` : 'Add Price';
                    const priceClass = service.price ? 'price-text' : 'price-text placeholder';
                    let cellNoteHTML = service.note ? `<div class="sticky-note" style="background-color: ${service.note.color}; border: ${service.note.border || 'none'};"></div>` : '';
                    
                    cell.innerHTML = `<div class="cell-wrapper">
                        <div class="cell-content">
                            <input type="checkbox" ${service.checked ? 'checked' : ''}>
                            <div>
                                <span class="${priceClass}" data-placeholder="Add Price">${priceHTML}</span>
                                <input type="number" class="price-input" value="${service.price || ''}" step="0.01" style="display:none;">
                            </div>
                        </div>
                        ${cellNoteHTML}
                    </div>`;
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        };

        const renderMobileView = (stylistsToRender) => {
            mobileViewContainer.innerHTML = '';
            const salonState = stateHistory[currentStateIndex];
            if (stylistsToRender.length === 0) {
                mobileViewContainer.innerHTML = '<p style="text-align:center; color:#888;">No stylists match your search.</p>';
                return;
            }
            stylistsToRender.forEach((stylist) => {
                const originalRowIndex = salonState.stylists.findIndex(s => s.name === stylist.name && s.level === stylist.level);
                const card = document.createElement('div');
                card.className = 'stylist-card';
                card.dataset.row = originalRowIndex;
                card.draggable = true;
                let stylistNoteHTML = stylist.note ? `<div class="sticky-note" style="background-color: ${stylist.note.color}; border: ${stylist.note.border || 'none'};" data-col="0"></div>` : '';
                
                const levelText = stylist.level || 'Add Level';
                card.innerHTML = `<div class="stylist-card-header" data-col="0">
                    <div class="stylist-info-wrapper">
                        <img class="stylist-avatar" src="${generateAvatar(stylist)}">
                        <div class="stylist-info">
                            <span class="editable profile-link">${stylist.name}</span>
                             <div>
                                <span class="editable level-text">${levelText}</span>
                                <input type="text" class="name-input" value="${levelText === 'Add Level' ? '' : levelText}" style="display:none; width: 120px;">
                            </div>
                        </div>
                    </div>
                    ${stylistNoteHTML}
                </div>
                <div class="stylist-card-body"></div>`;

                const cardBody = card.querySelector('.stylist-card-body');
                salonState.services.forEach((serviceData, colIndex) => {
                    const service = stylist.services[colIndex];
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'service-item';
                    serviceItem.dataset.col = colIndex + 1;
                    const priceHTML = service.price ? `$${parseFloat(service.price).toFixed(2)}` : 'Add Price';
                    const priceClass = service.price ? 'price-text' : 'price-text placeholder';
                    let cellNoteHTML = service.note ? `<div class="sticky-note" style="background-color: ${service.note.color}; border: ${service.note.border || 'none'};"></div>` : '';
                    
                    serviceItem.innerHTML = `<span class="service-name editable">${serviceData.name}</span>
                        <div class="service-controls">
                            <div>
                                <span class="${priceClass}" data-placeholder="Add Price">${priceHTML}</span>
                                <input type="number" class="price-input" value="${service.price || ''}" step="0.01" style="display:none;">
                            </div>
                            <label class="toggle-switch"><input type="checkbox" ${service.checked ? 'checked' : ''}><span class="slider"></span></label>
                            ${cellNoteHTML}
                        </div>`;

                    cardBody.appendChild(serviceItem);
                });
                mobileViewContainer.appendChild(card);
            });
        };

        const updateDisplay = () => {
            const salonState = stateHistory[currentStateIndex];
            if (!salonState) return;
            populateLevelFilter();
            const searchTerm = searchInput.value.toLowerCase();
            const selectedLevel = levelFilter.value;
            let filteredStylists = salonState.stylists;
            if (searchTerm) {
                filteredStylists = filteredStylists.filter(stylist => stylist.name.toLowerCase().includes(searchTerm));
            }
            if (selectedLevel !== 'all') {
                filteredStylists = filteredStylists.filter(stylist => stylist.level === selectedLevel);
            }
            let stylistsToRender;
            if (sortState.key === 'manual') {
                stylistsToRender = filteredStylists;
            } else {
                const { key, direction } = sortState;
                stylistsToRender = [...filteredStylists].sort((a, b) => {
                    if (key === 'stylist') {
                        return direction === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                    } else {
                        const priceA = parseFloat(a.services[key]?.price) || 0;
                        const priceB = parseFloat(b.services[key]?.price) || 0;
                        return direction === 'asc' ? priceA - priceB : priceB - priceA;
                    }
                });
            }
            if (window.innerWidth <= 800) {
                renderMobileView(stylistsToRender);
            } else {
                renderTable(stylistsToRender);
            }
        };

        // --- DATA & SAVE FUNCTIONS ---
        const saveData = (showFeedback = false) => {
            if (currentStateIndex < 0) return;
            const timestamp = new Date().toLocaleString();
            const dataToSave = { salonState: stateHistory[currentStateIndex], timestamp };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            lastUpdatedSpan.textContent = timestamp;
            if (showFeedback) showToast('Data saved successfully!', 'success');
        };
        const debouncedSave = debounce(saveData, 1500);

        const loadInitialData = () => {
            const savedJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
            const savedData = savedJSON ? JSON.parse(savedJSON) : deepClone(defaultData);
            stateHistory = [savedData.salonState];
            currentStateIndex = 0;
            lastUpdatedSpan.textContent = savedData.timestamp || 'Never';
            updateDisplay();
            updateUndoRedoButtons();
        };

        // --- EVENT LISTENERS ---
        mainContentContainer.addEventListener('input', (event) => {
            const target = event.target;
            if (!target.matches('input[type="checkbox"]')) return;
            const newState = deepClone(stateHistory[currentStateIndex]);
            const serviceItem = target.closest('.service-item');
            const td = target.closest('td');
            if (serviceItem) {
                const row = parseInt(target.closest('.stylist-card').dataset.row);
                const col = parseInt(serviceItem.dataset.col);
                newState.stylists[row].services[col - 1].checked = target.checked;
            } else if (td) {
                const row = parseInt(td.parentElement.dataset.row);
                const col = parseInt(td.dataset.col);
                newState.stylists[row].services[col - 1].checked = target.checked;
            }
            recordChange(newState);
        });

        mainContentContainer.addEventListener('click', (event) => {
            const target = event.target;
            
            if (target.matches('.profile-link')) {
                clearTimeout(clickTimer);
                const row = parseInt(target.closest('[data-row]').dataset.row);
                showProfileModal(row);
                return;
            }
            const cell = target.closest('td, th, .stylist-card-header, .service-item');
            if (!cell) return;
            if (isPlacingNote) {
                if (!selectedNoteColor) return showToast("Please select a color first!", 'error');
                const row = cell.closest('[data-row]') ? parseInt(cell.closest('[data-row]').dataset.row) : -1;
                const col = parseInt(cell.dataset.col);
                showNoteEntryPopup(row, col);
                return;
            }
            if (target.closest('.sort-arrow')) {
                sortData(target.closest('.sortable').dataset.sort);
            } else if (target.matches('.editable') && target.closest('th')) {
                clearTimeout(clickTimer);
                clickTimer = setTimeout(() => {
                    const colIndex = parseInt(target.closest('th').dataset.col) - 1;
                    showServiceDetailsModal(colIndex);
                }, 250);
            
            } else if (target.matches('.editable.level-text')) {
                event.preventDefault();
                const container = target.parentElement;
                const input = container.querySelector('.name-input');
                
                target.style.display = 'none';
                input.style.display = 'inline-block';
                input.focus();
                input.select();

                const save = () => {
                    let stylistIndex;
                    const rowEl = target.closest('[data-row]');
                    if (rowEl) {
                        stylistIndex = parseInt(rowEl.dataset.row);
                    } else if (target.dataset.stylistIndex) {
                        stylistIndex = parseInt(target.dataset.stylistIndex);
                    } else { return; }

                    const newState = deepClone(stateHistory[currentStateIndex]);
                    newState.stylists[stylistIndex].level = input.value.trim() || 'Add Level';
                    recordChange(newState);
                };
                
                // ========================================================================
                // === FINAL FIX: Delay attaching the blur listener to prevent race condition
                // ========================================================================
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur();
                    }
                };
                input.addEventListener('keydown', handleKeyDown);

                setTimeout(() => {
                    input.addEventListener('blur', () => {
                        input.removeEventListener('keydown', handleKeyDown);
                        save();
                    }, { once: true });
                }, 0);

            } else if (target.matches('.price-text')) {
                event.preventDefault();
                const container = target.parentElement;
                const input = container.querySelector('.price-input');

                target.style.display = 'none';
                input.style.display = 'inline-block';
                input.focus();
                input.select();
                
                const save = () => {
                    const row = parseInt(target.closest('[data-row]').dataset.row);
                    const col = parseInt(target.closest('[data-col]').dataset.col);

                    const newState = deepClone(stateHistory[currentStateIndex]);
                    const newPrice = input.value.trim();
                    newState.stylists[row].services[col - 1].price = newPrice ? parseFloat(newPrice).toFixed(2) : '';
                    recordChange(newState);
                };
                
                // ========================================================================
                // === FINAL FIX: Delay attaching the blur listener to prevent race condition
                // ========================================================================
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur();
                    }
                };
                input.addEventListener('keydown', handleKeyDown);

                setTimeout(() => {
                    input.addEventListener('blur', () => {
                        input.removeEventListener('keydown', handleKeyDown);
                        save();
                    }, { once: true });
                }, 0);
            
            } else if (target.matches('.sticky-note')) {
                const row = target.closest('[data-row]') ? parseInt(target.closest('[data-row]').dataset.row) : -1;
                const col = parseInt(target.closest('[data-col]').dataset.col);
                showNotePopup(row, col);
            }
        });

        mainContentContainer.addEventListener('dblclick', (event) => {
            const target = event.target;
            if (target.closest('.profile-link')) return; 
            clearTimeout(clickTimer);
            if (target.matches('.editable') && target.closest('th')) {
                const cell = target.closest('th');
                const col = parseInt(cell.dataset.col);
                const originalText = target.textContent;
                const nameWrapper = target.closest('.name-wrapper');
                const editInput = document.createElement('input'); editInput.type = 'text'; editInput.className = 'name-input'; editInput.value = originalText;
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'remove-btn'; deleteBtn.innerHTML = '🗑️';
                nameWrapper.innerHTML = ''; nameWrapper.appendChild(editInput); nameWrapper.appendChild(deleteBtn);
                editInput.focus();
                const handleSave = (input, originalText, updateFn) => {
                    const newState = deepClone(stateHistory[currentStateIndex]);
                    const newText = input.value.trim();
                    updateFn(newState, newText || originalText);
                    recordChange(newState);
                };
                deleteBtn.addEventListener('mousedown', () => showConfirmModal(`Remove service "${originalText}"?`, () => {
                    const newState = deepClone(stateHistory[currentStateIndex]);
                    newState.services.splice(col - 1, 1);
                    newState.stylists.forEach(s => s.services.splice(col - 1, 1));
                    showToast(`Service "${originalText}" removed.`, "info");
                    recordChange(newState);
                }));
                editInput.addEventListener('blur', () => handleSave(editInput, originalText, (state, val) => state.services[col - 1].name = val));
                editInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.target.blur(); });
            }
        });
        
        // Drag and drop listeners remain unchanged...
        let draggedElementIndex = null;
        mainContentContainer.addEventListener('dragstart', (e) => {
            const draggable = e.target.closest('[draggable="true"]');
            if (draggable) {
                draggedElementIndex = parseInt(draggable.dataset.row);
                setTimeout(() => draggable.classList.add('dragging'), 0);
            }
        });
        mainContentContainer.addEventListener('dragover', (e) => { e.preventDefault(); const target = e.target.closest('[draggable="true"]'); if (target && parseInt(target.dataset.row) !== draggedElementIndex) { const rect = target.getBoundingClientRect(); const isMobile = target.classList.contains('stylist-card'); if (e.clientY < rect.top + rect.height / 2) { target.classList.add(isMobile ? 'mobile-drag-over' : 'drag-over'); } else { target.classList.remove(isMobile ? 'mobile-drag-over' : 'drag-over'); } } });
        mainContentContainer.addEventListener('dragleave', (e) => { const target = e.target.closest('[draggable="true"]'); if (target) { target.classList.remove('drag-over', 'mobile-drag-over'); } });
        mainContentContainer.addEventListener('drop', (e) => { e.preventDefault(); const dropTarget = e.target.closest('[draggable="true"]'); if (dropTarget && draggedElementIndex !== null) { const targetIndex = parseInt(dropTarget.dataset.row); sortState = { key: 'manual', direction: 'asc' }; const newState = deepClone(stateHistory[currentStateIndex]); const [draggedItem] = newState.stylists.splice(draggedElementIndex, 1); newState.stylists.splice(targetIndex, 0, draggedItem); recordChange(newState); } draggedElementIndex = null; });
        mainContentContainer.addEventListener('dragend', () => { document.querySelectorAll('.dragging, .drag-over, .mobile-drag-over').forEach(el => { el.classList.remove('dragging', 'drag-over', 'mobile-drag-over'); }); draggedElementIndex = null; });
        
        NOTE_COLORS.forEach(c => {
            const box = document.createElement('div');
            box.className = 'color-box'; box.style.backgroundColor = c.color; box.style.border = c.border || '2px solid transparent';
            box.addEventListener('click', (e) => { e.stopPropagation(); colorPalette.querySelector('.selected')?.classList.remove('selected'); box.classList.add('selected'); selectedNoteColor = c; });
            colorPalette.appendChild(box);
        });
        const cancelBox = document.createElement('div'); cancelBox.className = 'color-box cancel-note'; cancelBox.innerHTML = '&times;';
        cancelBox.addEventListener('click', (e) => { e.stopPropagation(); togglePlacingNote(false); });
        colorPalette.appendChild(cancelBox);

        document.querySelectorAll('.close-popup').forEach(btn => btn.addEventListener('click', () => hideModal(btn.closest('.modal-popup'))));
        document.getElementById('add-stylist-btn').addEventListener('click', () => {
            const name = newStylistInput.value.trim();
            if (!name) { showToast("Please enter a stylist name first.", "error"); return; }
            const newState = deepClone(stateHistory[currentStateIndex]);
            newState.stylists.push({ name, level: "Apprentice", note: null, photo: null, bio: "", avatarColor: null, services: newState.services.map(() => ({ checked: false, price: '', note: null })) });
            recordChange(newState);
            showToast(`Stylist "${name}" added.`, 'success');
            newStylistInput.value = '';
        });
        document.getElementById('add-service-btn').addEventListener('click', () => {
            const name = newServiceInput.value.trim();
            if (!name) { showToast("Please enter a service name first.", "error"); return; }
            const newState = deepClone(stateHistory[currentStateIndex]);
            newState.services.push({ name, note: null, duration: "", priceRange: "", description: "" });
            newState.stylists.forEach(s => s.services.push({ checked: false, price: '', note: null }));
            recordChange(newState);
            showToast(`Service "${name}" added.`, 'success');
            newServiceInput.value = '';
        });

        // Final event listeners remain unchanged
        document.getElementById('save-btn').addEventListener('click', () => saveData(true));
        document.getElementById('export-btn').addEventListener('click', () => { saveData(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([localStorage.getItem(LOCAL_STORAGE_KEY)], { type: 'application/json' })); a.download = 'salon-data.json'; a.click(); URL.revokeObjectURL(a.href); showToast("Data exported.", "info"); });
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('import-file-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data?.salonState && data?.timestamp) { stateHistory = [data.salonState]; currentStateIndex = 0; lastUpdatedSpan.textContent = data.timestamp; updateDisplay(); updateUndoRedoButtons(); saveData(); showToast('Data imported!', 'success'); } else showToast('Error: Invalid file format.', 'error'); } catch (error) { showToast('Error reading file.', 'error'); } }; reader.readAsText(file); event.target.value = ''; });
        document.getElementById('print-btn').addEventListener('click', handlePrint);
        document.getElementById('manual-btn').addEventListener('click', () => showModal(document.getElementById('manual-popup')));
        themeToggleBtn.addEventListener('click', () => { const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; localStorage.setItem(THEME_KEY, newTheme); applyTheme(newTheme); });
        document.getElementById('reset-all-btn').addEventListener('click', () => showConfirmModal("Reset ALL data? This is irreversible.", () => { localStorage.clear(); showToast('Data reset. Reloading...', 'info'); setTimeout(() => location.reload(), 1000); }));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isPlacingNote) { togglePlacingNote(false); } if (e.ctrlKey && e.altKey && e.key === 'd') { e.preventDefault(); const isDev = document.body.classList.toggle('developer-mode-active'); showToast(`Developer Mode ${isDev ? 'Enabled' : 'Disabled'}.`, 'info'); } if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); } if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }});
        addNoteBtn.addEventListener('click', () => togglePlacingNote(!isPlacingNote));
        searchInput.addEventListener('input', updateDisplay);
        levelFilter.addEventListener('change', updateDisplay);
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        
        // --- KICK-OFF ---
        applyTheme(localStorage.getItem(THEME_KEY) || 'light');
        loadInitialData();
        window.addEventListener('resize', debounce(updateDisplay, 250));
    });
</script>
</body>
</html>
