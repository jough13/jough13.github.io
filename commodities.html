<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortable Radioactive Commodity Lookup Table</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sticky-header { position: sticky; top: 0; z-index: 10; }
        .sortable { cursor: pointer; position: relative; user-select: none; }
        .sortable .sort-arrow { display: inline-block; width: 1em; height: 1em; opacity: 0.4; position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); }
        .sortable .sort-arrow.asc, .sortable .sort-arrow.desc { opacity: 1; }
        .sortable .sort-arrow.asc::after { content: '▲'; font-size: 0.6em; }
        .sortable .sort-arrow.desc::after { content: '▼'; font-size: 0.6em; }
        .sorted-column { background-color: #e5e7eb; }
        .dark .sorted-column { background-color: #4b5563; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }
        .selected-row { background-color: #fef9c3; }
        .dark .selected-row { background-color: #4a4a2a; }
        tr td:not(:first-child):not(.radionuclide-link) { cursor: pointer; }
        .progress-bar-container { width: 100%; height: 20px; background-color: #e5e7eb; border-radius: 0.375rem; overflow: hidden; margin-top: 0.25rem; }
        .dark .progress-bar-container { background-color: #374151; }
        .progress-bar { height: 100%; border-radius: 0.375rem; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.4); }
        .custom-row { background-color: #eff6ff; }
        .dark .custom-row { background-color: #1e3a8a; }
        .dark .custom-row:hover { background-color: #1e40af; }
        .toggle-cell { display: none; }
        .details-toggle-btn { width: 100%; padding: 0.5rem; font-weight: 600; color: #3b82f6; border-radius: 0.5rem; background-color: transparent; transition: background-color 0.2s; }
        .details-toggle-btn:hover { background-color: #dbeafe; }
        .dark .details-toggle-btn { color: #60a5fa; }
        .dark .details-toggle-btn:hover { background-color: #374151; }
        .highlight { background-color: #fef08a; color: #713f12; border-radius: 2px; padding: 1px 0; }
        .dark .highlight { background-color: #facc15; color: #422006; }
        #toastContainer { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { padding: 1rem; border-radius: 0.5rem; color: white; font-weight: 500; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); animation: toast-fade-in 0.3s ease-out; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        @keyframes toast-fade-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toast-fade-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .toast.fade-out { animation: toast-fade-out 0.3s ease-in forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        @media (max-width: 1024px) {
            #lookupTable thead { display: none; }
            #lookupTable, #lookupTable tbody, #lookupTable tr, #lookupTable td { display: block; width: 100%; }
            #lookupTable tr { margin-bottom: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden; }
            .dark #lookupTable tr { border-color: #374151; }
            #lookupTable td { display: flex; justify-content: space-between; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
            .dark #lookupTable td { border-color: #374151; }
            #lookupTable td:last-child { border-bottom: none; }
            #lookupTable td::before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; white-space: nowrap; }
            .dark #lookupTable td::before { color: #d1d5db; }
            #lookupTable td.expandable { display: none; }
            #lookupTable tr.details-visible td.expandable { display: flex; }
            #lookupTable td.toggle-cell { display: flex; justify-content: center; background-color: #f3f4f6; border-bottom: none; }
            .dark #lookupTable td.toggle-cell { background-color: #1f2937; }
            #lookupTable td:first-child { justify-content: center; background-color: #f9fafb; }
            .dark #lookupTable td:first-child { background-color: #1f2937; }
            #lookupTable tr.custom-row td:first-child { background-color: #dbeafe; }
            .dark #lookupTable tr.custom-row td:first-child { background-color: #1e3a8a; }
            #lookupTable td:nth-child(2) { font-size: 1.125rem; font-weight: 600; justify-content: center; text-align: center; background-color: #f9fafb; padding-top: 1rem; padding-bottom: 1rem; }
            .dark #lookupTable td:nth-child(2) { background-color: #1f2937; }
            #lookupTable tr.custom-row td:nth-child(2) { background-color: #dbeafe; }
            .dark #lookupTable tr.custom-row td:nth-child(2) { background-color: #1e3a8a; }
            #lookupTable td:nth-child(2)::before { display: none; }
        }
    </style>
    <script>
        // Check for dark mode preference before the page loads to prevent flickering
        if (localStorage.getItem('darkMode') === 'enabled' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-300 transition-colors duration-300">
    <div id="toastContainer"></div>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Radioactive Commodity Lookup</h1>
                <p class="mt-2 text-gray-600 dark:text-gray-400">A searchable and sortable database of items with NRC and DOT exemption values.</p>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-gray-900/50 flex flex-col gap-4">
                <div class="flex flex-col lg:flex-row items-center gap-4 w-full">
                    <div class="w-full lg:flex-grow flex flex-col sm:flex-row items-center gap-4">
                        <div class="relative w-full lg:flex-grow">
                            <input type="text" id="searchInput" placeholder="Search by name, NSN, NIIN..." class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" autocomplete="off">
                            <button id="clearSearchBtn" class="absolute inset-y-0 right-0 flex items-center pr-3 hidden" title="Clear search">
                                <svg class="h-5 w-5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <select id="radionuclideFilter" class="px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 w-full sm:w-auto"></select>
                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 whitespace-nowrap">Clear Filters</button>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap justify-center">
                        <button id="addItemBtn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Add New Item</button>
                        <button id="importCustomBtn" class="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">Import Custom</button>
                        <button id="exportCustomBtn" class="px-4 py-2 bg-cyan-700 text-white rounded-lg hover:bg-cyan-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Export Custom</button>
                        <button id="clearAddedBtn" class="px-4 py-2 bg-indigo-700 text-white rounded-lg hover:bg-indigo-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Clear Added</button>
                        <button id="disposalRequestBtn" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Prepare Disposal Request</button>
                        <button id="compareBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Compare</button>
                        <button id="exportSelectionBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Export Selection</button>
                        <button id="clearSelectionBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Clear</button>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-6 w-full pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="nrcExemptFilter" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="text-gray-700 dark:text-gray-300">NRC Exempt Only</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="dotExemptFilter" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="text-gray-700 dark:text-gray-300">DOT Exempt Only</span>
                        </label>
                    </div>
                    <div class="flex-grow"></div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button id="saveSelectionBtn" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Save</button>
                        <button id="loadSelectionBtn" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Load</button>
                        <button id="clearSavedBtn" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Clear Saved</button>
                        <button id="helpBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Help</button>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <span class="font-medium text-sm sm:text-base text-gray-700 dark:text-gray-300">Ci</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="unitToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="font-medium text-sm sm:text-base text-gray-700 dark:text-gray-300">Bq</span>
                    </div>
                     <div class="flex items-center gap-2 sm:gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-700 dark:text-gray-300"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="lookupTable" class="w-full text-sm text-gray-600 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-100 dark:bg-gray-700 sticky-header">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center">
                                <input type="checkbox" id="selectAllCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            </th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('name')" role="button" tabindex="0">Name or Nomenclature<span class="sort-arrow"></span></th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('nsn')" role="button" tabindex="0">National Stock # (NSN)<span class="sort-arrow"></span></th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('niin')" role="button" tabindex="0">NIIN<span class="sort-arrow"></span></th>
                            <th scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('radionuclide')" role="button" tabindex="0">Radionuclide<span class="sort-arrow"></span></th>
                            <th id="activityHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('activity_val')" role="button" tabindex="0">Activity<span class="sort-arrow"></span></th>
                            <th id="nrcExemptionHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('nrc_exemption_val')" role="button" tabindex="0">NRC Exemption<span class="sort-arrow"></span></th>
                            <th id="dotExemptionHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('dot_exemption_val')" role="button" tabindex="0">DOT Exemption<span class="sort-arrow"></span></th>
                            <th id="un2911Header" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('un2911_limit_val')" role="button" tabindex="0">UN 2911 Limit (per item)<span class="sort-arrow"></span></th>
                            <th id="un2911PkgHeader" scope="col" class="px-6 py-3 sortable text-center" onclick="sortTable('un2911_pkg_limit_val')" role="button" tabindex="0">UN 2911 Limit (per package)<span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody class="dark:divide-gray-700">
                        <tr id="loadingStateRow">
                            <td colspan="10" class="text-center p-16">
                                <div class="flex justify-center items-center gap-4">
                                    <svg class="spinner h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="text-lg font-medium text-gray-600 dark:text-gray-400">Loading data...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <div id="noResults" class="hidden p-6 text-center text-gray-500 dark:text-gray-400"></div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500 dark:text-gray-400">
            <p>Data provided for informational purposes. NRC values from 10 CFR 30.71. DOT values from 49 CFR § 173.425, § 173.435, & § 173.436.</p>
            <p class="mt-2">Version 2.0 | Last Updated: September 8, 2025</p>
        </footer>
    </div>

    <div id="compareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="compareModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="compareModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Compare Selected Items</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div id="compareContent" class="p-6"></div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="detailModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="detailModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Item Details</h2>
                <button id="closeDetailModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div id="detailContent" class="p-6"></div>
            <div id="detailActions" class="p-4 border-t dark:border-gray-700 flex justify-between items-center"></div>
        </div>
    </div>

    <div id="disposalRequestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="disposalRequestModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="disposalRequestModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Prepare Disposal Request</h2>
                <button id="closeDisposalRequestModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div id="disposalRequestContent" class="p-6 overflow-y-auto"></div>
		<div class="p-4 border-t dark:border-gray-700 flex justify-between items-center gap-4">
		    <button id="showInstructionsBtn" type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Submission Instructions</button>
    
		    <div class="flex justify-end gap-4">
		        <button id="generateMemoBtn" type="button" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Generate Memo</button>
        		<button id="exportCsvBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export as .csv</button>
		        <button id="printRequestBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Generate & Print Request</button>
		    </div>
		</div>
        </div>
    </div>

    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="helpModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">User Guide</h2>
                <button id="closeHelpModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="prose prose-lg dark:prose-invert max-w-none space-y-4">
                    <div>
                        <h2 class="!mb-2 font-bold">1. Overview</h2>
                        <p>This tool is a dynamic, searchable database designed to help you quickly look up information on various radioactive commodities. You can search, sort, and filter a comprehensive list of items, view their activity levels in different units, and compare them against key regulatory limits from the NRC and DOT.</p>
                    </div>
                    <hr class="dark:border-gray-600">
                    <div>
                        <h2 class="!mb-2 font-bold">2. Core Features</h2>
                        <div class="space-y-4 pl-4">
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">2.1 Searching and Filtering</h3>
                                <p>You have several powerful tools to narrow down the list to find exactly what you're looking for:</p>
                                <ul>
                                    <li><strong>Text Search:</strong> Simply type in the search bar to filter by <strong>Name</strong>, <strong>NSN</strong>, or <strong>NIIN</strong>. The table will update in real-time as you type.</li>
                                    <li><strong>Radionuclide Filter:</strong> Use the dropdown menu to display only items containing a specific radionuclide. Select "All Radionuclides" to clear this filter.</li>
                                    <li><strong>Exemption Filters:</strong>
                                        <ul>
                                            <li><strong>NRC Exempt Only:</strong> Check this box to show only items whose activity is at or below the NRC exemption limit.</li>
                                            <li><strong>DOT Exempt Only:</strong> Check this box to show only items whose activity is at or below the DOT exemption limit for consignments.</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>All filters work together, allowing you to create highly specific queries.</p>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">2.2 Sorting</h3>
                                <p>Every column in the table is sortable.</p>
                                <ul>
                                    <li><strong>Click a column header once</strong> to sort it in ascending order (A-Z, 0-9).</li>
                                    <li><strong>Click the same header again</strong> to sort in descending order (Z-A, 9-0). An arrow (▲ or ▼) will appear to indicate the current sort direction.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">2.3 Unit Conversion & Dark Mode</h3>
                                <ul>
                                    <li><strong>Ci/Bq Toggle:</strong> Use the toggle switch to instantly convert all activity and limit values between traditional units (Curies) and SI units (Becquerels).</li>
                                    <li><strong>Dark Mode:</strong> Click the sun/moon icon toggle to switch between light and dark themes for comfortable viewing. Your preference will be saved in your browser.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr class="dark:border-gray-600">
                    <div>
                        <h2 class="!mb-2 font-bold">3. Interactive Tools</h2>
                        <div class="space-y-4 pl-4">
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.1 Selecting Items</h3>
                                <p>Click the checkbox in the first column of any row to "select" an item. The row will highlight in yellow. This enables the action buttons at the top of the table.</p>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.2 Action Buttons</h3>
                                <p>Once you have selected one or more items, the following buttons will become active:</p>
                                <ul>
                                    <li><strong>Add New Item:</strong> Opens a form to add a custom item to the table.</li>
                                    <li><strong>Import/Export Custom:</strong> Save your custom-added items to a file or load them from a file. This is useful for backups or sharing with others.</li>
                                    <li><strong>Clear Added:</strong> Removes all custom items you have added.</li>
                                    <li><strong>Prepare Disposal Request:</strong> (Requires 1+ items) Opens a form to generate a Low-Level Radioactive Waste (LLRW) disposal request. This form includes a live package analysis to determine shipping requirements.</li>
                                    <li><strong>Compare:</strong> (Requires 2+ items) Opens a pop-up that displays a side-by-side comparison of the selected items.</li>
                                    <li><strong>Export Selection:</strong> (Requires 1+ items) Downloads a <code>.csv</code> file of the selected items, with values reflecting the current Ci/Bq unit setting.</li>
                                    <li><strong>Clear:</strong> (Requires 1+ items) Instantly deselects all checked items.</li>
                                    <li><strong>Save:</strong> (Requires 1+ items) Stores your current selection in your browser's local storage so you can return to it later.</li>
                                    <li><strong>Load:</strong> (Requires a saved selection) Clears any current selections and restores your previously saved group.</li>
                                    <li><strong>Clear Saved:</strong> Removes a saved selection from your browser's memory.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.3 Detail View</h3>
                                <p>Click anywhere on a row (except the "Select" column) to open a detailed pop-up view for that specific item. This view shows:</p>
                                <ul>
                                    <li>NSN and NIIN for easy copying.</li>
                                    <li>A direct link to look up the item on ISO-Group.com.</li>
                                    <li>A clear, color-coded comparison of the item's activity against all relevant regulatory limits (NRC, DOT, UN 2911).</li>
                                    <li>A clickable info icon <svg class="inline-block w-4 h-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg> next to each limit for a plain-language explanation.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.4 Disposal Request Form</h3>
                                <p>This is the most powerful feature for practical use. After selecting one or more items and clicking "Prepare Disposal Request," a modal appears where you can:</p>
                                <ol>
                                    <li><strong>Fill in Command and POC info:</strong> Provide details about your command and at least two points of contact.</li>
                                    <li><strong>Complete Item Details:</strong> The form will pre-populate with your selected items. Fill in the remaining information for each item type, such as quantity, serial number, and physical description.</li>
                                    <li><strong>Review Package Analysis:</strong> At the bottom of the form, a live analysis calculates the total package activity and determines the correct shipping category based on the sum-of-fractions rule.</li>
                                    <li><strong>Specify Pickup Location:</strong> Enter the address and building number for the waste pickup.</li>
                                    <li><strong>Generate & Print:</strong> Click the "Generate & Print Request" button to create a formatted document ready for printing and submission.</li>
                                </ol>
                            </div>
                            <div>
                                <h3 class="!mt-4 !mb-1 font-bold">3.5 Package Analysis Explained</h3>
                                <p>The "Package Analysis" section in the disposal request form automatically calculates the shipping requirements for your package based on DOT regulations (49 CFR). It uses the <strong>Sum of the Fractions Rule</strong> to determine if multiple different radionuclides in the same package collectively exceed a limit.</p>
                                <p>Here’s what the classifications mean:</p>
                                <ul>
                                    <li><strong>Exempt:</strong> The total activity in the package is very low. The sum of fractions for the Exempt consignment limit is ≤ 1. The package is exempt from most shipping regulations.</li>
                                    <li><strong>Limited Quantity Excepted Package (UN 2911):</strong> The package contains more activity than the exempt limit but is still below the Excepted Package limit. The sum of fractions for the UN 2911 package limit is ≤ 1. This allows for shipment with reduced labeling and paperwork.</li>
                                    <li><strong>Type A Package:</strong> The package exceeds Excepted Package limits but is at or below the Type A limit. The sum of fractions for the Type A (A2) limit is ≤ 1. This is a fully regulated shipment requiring specific Type A packaging, labeling, and shipping papers.</li>
                                    <li><strong>Exceeds Type A:</strong> The total activity exceeds the Type A limit. This shipment requires a more robust Type B package and special arrangements.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr class="dark:border-gray-600">
                    <div>
                        <h2 class="!mb-2 font-bold">4. Helpful Links & References</h2>
                        <div class="space-y-4 pl-4">
                            <ul>
                                <li><a href="https://www.nrc.gov/reading-rm/doc-collections/cfr/part030/part030-0071.html" target="_blank" class="text-blue-500 hover:underline">10 CFR § 30.71 - NRC Exempt Concentrations</a></li>
                                <li><a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173" target="_blank" class="text-blue-500 hover:underline">49 CFR Part 173 - DOT Shippers General Requirements</a></li>
                                <li><a href="https://www.iso-group.com/nsn-search" target="_blank" class="text-blue-500 hover:underline">ISO-Group NSN Search</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addItemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="addItemModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="addItemModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Add Custom Item</h2>
                <button id="closeAddItemModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div class="p-6">
                <form id="addItemForm" class="space-y-4">
                    <input type="hidden" id="itemEditId">
                    <div>
                        <label for="itemName" class="block mb-1 font-medium">Name or Nomenclature*</label>
                        <input type="text" id="itemName" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="itemNsn" class="block mb-1 font-medium">NSN</label>
                        <input type="text" id="itemNsn" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1">
                            <label for="itemRadionuclide" class="block mb-1 font-medium">Radionuclide*</label>
                            <select id="itemRadionuclide" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required></select>
                        </div>
                        <div class="sm:col-span-1">
                            <label for="itemActivity" class="block mb-1 font-medium">Activity*</label>
                            <input type="number" id="itemActivity" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required step="any">
                        </div>
                        <div class="sm:col-span-1">
                            <label for="itemUnits" class="block mb-1 font-medium">Units*</label>
                            <select id="itemUnits" class="w-full px-3 py-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                                <option>Ci</option>
                                <option>mCi</option>
                                <option>µCi</option>
                                <option>nCi</option>
                                <option>pCi</option>
                            </select>
                        </div>
                    </div>

			<div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300">
			    <p class="font-bold">Security Notice</p>
			    <p class="text-sm">Do not enter any sensitive, classified, or Controlled Unclassified Information (CUI). All data is stored unencrypted in your browser.</p>
			</div>

                    <p class="text-sm italic text-gray-500 dark:text-gray-400 pt-2">*Note: Custom items are saved to your browser's local storage. Clearing your browser's cache or history may remove any items you have added.</p>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancelAddItemBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Cancel</button>
                        <button type="submit" id="saveItemBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFileInput" class="hidden" accept=".json">

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="confirmModalText">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
                <h3 id="confirmModalText" class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Are you sure?</h3>
                <button id="confirmModalConfirmBtn" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
                    Yes, I'm sure
                </button>
                <button id="confirmModalCancelBtn" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">
                    No, cancel
                </button>
            </div>
        </div>
    </div>

    <div id="radionuclideDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="radionuclideModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="radionuclideModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Radionuclide Details</h2>
                <button id="closeRadionuclideModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div id="radionuclideContent" class="p-6"></div>
        </div>
    </div>

    <div id="tooltipModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="tooltipModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="tooltipModalTitle" class="text-xl font-bold text-gray-900 dark:text-white"></h2>
                <button id="closeTooltipModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div id="tooltipContent" class="p-6"></div>
        </div>
    </div>

    <div id="memoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="memoModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="memoModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Example Disposal Request Memo</h2>
                <button id="closeMemoModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <pre id="memoContent" class="whitespace-pre-wrap font-mono text-sm bg-gray-50 dark:bg-gray-900 p-4 rounded-md"></pre>
            </div>
            <div class="p-4 border-t dark:border-gray-700 flex justify-end gap-4">
                <button id="copyMemoBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Copy Text</button>
            </div>
        </div>
    </div>

    <div id="instructionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="instructionsModalTitle">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h2 id="instructionsModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">LLRW Disposal Request Submission Instructions</h2>
                <button id="closeInstructionsModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl" aria-label="Close">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto prose dark:prose-invert max-w-none">
                <p>To submit a Department of the Navy (DON) request for Low-Level Radioactive Waste (LLRW) disposal, please gather the required documents as follows:</p>
                <ol>
                    <li>
                        <strong>Formal Correspondence (Cover Letter):</strong>
                        <ul>
                            <li>This tool helps you create the required memo. After filling out the form, click the <strong>"Generate Memo"</strong> button to produce a pre-filled sample letter.</li>
                            <li>You can copy this text into a new document for formal signing. The letter can be modified as required by your command.</li>
                            <li><strong>NOTE:</strong> If funding will be command-provided, the letter must be signed by the CO/OIC or an approved designee. Otherwise, the RSO's signature is typically sufficient.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>LLRW Disposal Request Enclosures (Spreadsheet):</strong>
                        <ul>
                            <li>This tool generates the required enclosure spreadsheet for you.</li>
                            <li>Click the <strong>"Export as .csv"</strong> button. This will download an Excel-compatible file containing all the items and details you've entered on this form.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Review and verify your information:</strong>
                        <ul>
                            <li>Ensure the command points of contact (POCs) you list have knowledge of the LLRW inventory and can coordinate access for the waste broker.</li>
                            <li>The completeness of this information is vital. This tool helps populate the data, but the ultimate responsibility for characterization of the waste belongs to you, the generator. Incomplete or inaccurate information may result in pickup delays.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Submit the request:</strong>
                        <ul>
                            <li>Once complete, e-mail your LLRW disposal request, including both the signed PDF of your cover letter and the <strong>.csv file</strong> generated by this tool, to:</li>
                            <li><a href="mailto:beth.m.schilke.civ@us.navy.mil">beth.m.schilke.civ@us.navy.mil</a> and <a href="mailto:joseph.a.donakowski.civ@us.navy.mil">joseph.a.donakowski.civ@us.navy.mil</a></li>
                        </ul>
                    </li>
                    <li>
                        <strong>Questions?</strong>
                        <p>If you have any additional questions, contact the LLRW Program Managers:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 not-prose">
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <h4 class="font-bold">Ms. Beth Schilke</h4>
                                <p>(757) 887-7162</p>
                                <p><a href="mailto:beth.m.schilke.civ@us.navy.mil" class="text-blue-500">beth.m.schilke.civ@us.navy.mil</a></p>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                <h4 class="font-bold">Mr. Joseph Donakowski</h4>
                                <p>(757) 887-7445</p>
                                <p><a href="mailto:joseph.a.donakowski.civ@us.navy.mil" class="text-blue-500">joseph.a.donakowski.civ@us.navy.mil</a></p>
                            </div>
                        </div>
                    </li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const rawTableData = [
            { name: "SIGHT KIT", nsn: "1005-00-071-8030", nuclides: [{ id: "Pm-147", activity: "1", units: "mCi" }] },
            { name: "RIFLE, 5.56 MILLIMETER", nsn: "1005-00-073-9421", nuclides: [{ id: "H-3", activity: "9", units: "mCi" }] },
            { name: "POST ASSEMBLY", nsn: "1005-00-145-6378", nuclides: [{ id: "Pm-147", activity: "1", units: "mCi" }] },
            { name: "POST ASSEMBLY", nsn: "1005-00-234-1568", nuclides: [{ id: "H-3", activity: "9", units: "mCi" }] },
            { name: "SWITCH, TOGGLE", nsn: "5930-00-655-1514", nuclides: [{ id: "Ra-226", activity: "0.15", units: "µCi" }] },
            { name: "WINDVANE ASSEMBLY", nsn: "1005-01-099-1450", nuclides: [{ id: "Th-232", activity: "2.6", units: "pCi" }] },
            { name: "PISTOL, 9 MILLIMETER, AUTOMATIC", nsn: "1005-01-340-0096", nuclides: [{ id: "H-3", activity: "54.1", units: "mCi" }] },
            { name: "RIFLE, 5.56 MILLIMETER", nsn: "1005-01-340-6037", nuclides: [{ id: "H-3", activity: "9", units: "mCi" }] },
            { name: "MORTAR, 60 MILLIMETER", nsn: "1010-01-020-5626", nuclides: [{ id: "H-3", activity: "29", units: "Ci" }] },
            { name: "SIGHT UNIT", nsn: "1240-01-174-1726", nuclides: [{ id: "H-3", activity: "6.7", units: "Ci" }] },
            { name: "LIGHT, AIMING POST", nsn: "1290-00-169-1934", nuclides: [{ id: "H-3", activity: "5", units: "Ci" }] },
            { name: "LIGHT, AIMING POST", nsn: "1290-00-169-1935", nuclides: [{ id: "H-3", activity: "9", units: "Ci" }] },
            { name: "RANGE INDICATOR ASSEMBLY", nsn: "1010-01-115-3128", nuclides: [{ id: "H-3", activity: "3.19", units: "Ci" }] },
            { name: "RANGE INDICATOR", nsn: "1010-01-237-9033", nuclides: [{ id: "H-3", activity: "3.19", units: "Ci" }] },
            { name: "HOWITZER, LIGHT, TOWED, 105MM", nsn: "1015-00-086-8164", nuclides: [{ id: "H-3", activity: "24.8", units: "Ci" }] },
            { name: "TELESCOPE, ELBOW", nsn: "1240-00-150-8886", nuclides: [{ id: "H-3", activity: "3.81", units: "Ci" }] },
            { name: "TELESCOPE, PANORAMIC", nsn: "1240-00-150-8889", nuclides: [{ id: "H-3", activity: "5.59", units: "Ci" }] },
            { name: "MOUNT, TELESCOPE", nsn: "1240-00-150-8890", nuclides: [{ id: "H-3", activity: "150", units: "mCi" }] },
            { name: "COLLIMATOR, INFINITY AIMING REFERENCE", nsn: "1240-00-332-1780", nuclides: [{ id: "H-3", activity: "10", units: "Ci" }] },
            { name: "QUADRANT, FIRE CONTROL", nsn: "1290-00-150-8891", nuclides: [{ id: "H-3", activity: "2.2", units: "Ci" }] },
            { name: "QUADRANT, GUNNERS", nsn: "1290-00-169-1937", nuclides: [{ id: "H-3", activity: "75.1", units: "mCi" }] },
            { name: "ALIGNMENT DEVICE, BORESIGHT", nsn: "4931-00-341-5119", nuclides: [{ id: "H-3", activity: "3", units: "Ci" }] },
            { name: "ALIGNMENT DEVICE, BORESIGHT", nsn: "4931-01-187-9713", nuclides: [{ id: "H-3", activity: "3", units: "Ci" }] },
            { name: "HOWITZER, LIGHT, TOWED, 105MM", nsn: "1015-00-322-9728", nuclides: [{ id: "H-3", activity: "10", units: "Ci" }] },
            { name: "HOWITZER, LIGHT, TOWED, 105MM", nsn: "1015-00-322-9752", nuclides: [{ id: "H-3", activity: "10", units: "Ci" }] },
            { name: "MORTAR, 81MM", nsn: "1015-01-164-6651", nuclides: [{ id: "H-3", activity: "25.7", units: "Ci" }] },
            { name: "SIGHT UNIT", nsn: "1240-01-379-7953", nuclides: [{ id: "H-3", activity: "6.7", units: "Ci" }] },
            { name: "MORTAR, 120MM", nsn: "1015-01-226-1672", nuclides: [{ id: "H-3", activity: "24.8", units: "Ci" }] },
            { name: "SIGHT UNIT", nsn: "1240-01-366-7322", nuclides: [{ id: "H-3", activity: "5.78", units: "Ci" }] },
            { name: "HOWITZER, TOWED, 105MM", nsn: "1015-01-248-0859", nuclides: [{ id: "H-3", activity: "22.4", units: "Ci" }] },
            { name: "TELESCOPE, PANORAMIC", nsn: "1240-01-277-0472", nuclides: [{ id: "H-3", activity: "5.11", units: "Ci" }] },
            { name: "MOUNT, TELESCOPE", nsn: "1240-01-277-0474", nuclides: [{ id: "H-3", activity: "2.65", units: "Ci" }] },
            { name: "TELESCOPE, ELBOW", nsn: "1240-01-277-2875", nuclides: [{ id: "H-3", activity: "1.6", units: "Ci" }] },
            { name: "MORTAR, CARRIER MOUNTED, 120MM", nsn: "1015-01-292-3801", nuclides: [{ id: "H-3", activity: "24.8", units: "Ci" }] },
            { name: "HOWITZER, TOWED, 105MM", nsn: "1015-01-308-1872", nuclides: [{ id: "H-3", activity: "22.4", units: "Ci" }] },
            { name: "RIFLE, RECOILLESS", nsn: "1015-01-314-1770", nuclides: [{ id: "H-3", activity: "210", units: "mCi" }] },
            { name: "HOWITZER, MEDIUM, TOWED, 155MM", nsn: "1025-01-026-6648", nuclides: [{ id: "H-3", activity: "26.6", units: "Ci" }] },
            { name: "TELESCOPE, PANORAMIC", nsn: "1240-01-038-0530", nuclides: [{ id: "H-3", activity: "4.41", units: "Ci" }] },
            { name: "TELESCOPE, PANORAMIC", nsn: "1240-01-038-0531", nuclides: [{ id: "H-3", activity: "5.11", units: "Ci" }] },
            { name: "MOUNT, TELESCOPE", nsn: "1240-01-039-7273", nuclides: [{ id: "H-3", activity: "150", units: "mCi" }] },
            { name: "QUADRANT, FIRE CONTROL", nsn: "1290-01-037-3883", nuclides: [{ id: "H-3", activity: "1.9", units: "Ci" }] },
            { name: "QUADRANT, FIRE CONTROL", nsn: "1290-01-037-7289", nuclides: [{ id: "H-3", activity: "1.95", units: "Ci" }] },
            { name: "ALIGNMENT DEVICE", nsn: "4931-01-048-5834", nuclides: [{ id: "H-3", activity: "3", units: "Ci" }] },
            { name: "SWITCH", nsn: "5930-00-655-1582", nuclides: [{ id: "Ra-226", activity: "0.15", units: "µCi" }] },
            { name: "TURRET ASSEMBLY", nsn: "1220-01-308-3019", nuclides: [{ id: "Th-232", activity: "81.1", units: "nCi" }] },
            { name: "OPTICAL IMAGING SET", nsn: "5855-01-201-4857", nuclides: [{ id: "Th-232", activity: "16", units: "nCi" }] },
            { name: "CELL ASSEMBLY", nsn: "6650-01-169-9328", nuclides: [{ id: "Th-232", activity: "30", units: "nCi" }] },
            { name: "PRISM", nsn: "6650-01-171-8538", nuclides: [{ id: "Th-232", activity: "0.9", units: "nCi" }] },
            { name: "PRISM", nsn: "6650-01-171-8539", nuclides: [{ id: "Th-232", activity: "2.81", units: "nCi" }] },
            { name: "LENS", nsn: "6650-01-176-3107", nuclides: [{ id: "Th-232", activity: "14", units: "nCi" }] },
            { name: "LENS", nsn: "6650-01-176-3108", nuclides: [{ id: "Th-232", activity: "17", units: "nCi" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-00-257-2770", nuclides: [{ id: "H-3", activity: "800", units: "mCi" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-00-257-2774", nuclides: [{ id: "H-3", activity: "1", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-00-257-2776", nuclides: [{ id: "H-3", activity: "800", units: "mCi" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-096-4479", nuclides: [{ id: "H-3", activity: "1.2", units: "Ci" }] },
            { name: "CELL ASSEMBLY", nsn: "1240-00-257-2759", nuclides: [{ id: "H-3", activity: "4.41", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-135-3161", nuclides: [{ id: "H-3", activity: "1.2", units: "Ci" }] },
            { name: "LEVEL ASSEMBLY", nsn: "1240-01-142-5381", nuclides: [{ id: "H-3", activity: "150", units: "mCi" }] },
            { name: "LEVEL, FIRE CONTROL", nsn: "1290-00-257-2769", nuclides: [{ id: "H-3", activity: "150", units: "mCi" }] },
            { name: "CELL ASSEMBLY", nsn: "1240-01-079-5453", nuclides: [{ id: "H-3", activity: "10", units: "Ci" }] },
            { name: "COLLIMATOR", nsn: "1240-01-124-1358", nuclides: [{ id: "H-3", activity: "10", units: "Ci" }] },
            { name: "MODIFICATION KIT, GUN, FIELD ARTILLERY", nsn: "9999-00-332-1779", nuclides: [{ id: "H-3", activity: "10", units: "Ci" }] },
            { name: "CELL ASSEMBLY", nsn: "1240-01-048-0779", nuclides: [{ id: "H-3", activity: "4.41", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-113-7947", nuclides: [{ id: "H-3", activity: "4.41", units: "Ci" }] },
            { name: "OBJECTIVE ASSEMBLY", nsn: "1240-01-043-9463", nuclides: [{ id: "H-3", activity: "2.4", units: "Ci" }] },
            { name: "COUNTERBALANCE", nsn: "1240-01-044-6915", nuclides: [{ id: "H-3", activity: "2.7", units: "Ci" }] },
            { name: "TELESCOPE ASSEMBLY", nsn: "1240-01-062-8264", nuclides: [{ id: "H-3", activity: "2.4", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6240-01-043-8209", nuclides: [{ id: "H-3", activity: "2.7", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-051-9606", nuclides: [{ id: "H-3", activity: "2.4", units: "Ci" }] },
            { name: "DISPLAY UNIT", nsn: "1240-01-063-1351", nuclides: [{ id: "Th-232", activity: "0.05", units: "µCi" }] },
            { name: "DISPLAY UNIT", nsn: "1240-01-063-1401", nuclides: [{ id: "Th-232", activity: "0.05", units: "µCi" }] },
            { name: "MOUNT, TELESCOPE", nsn: "1240-01-050-5588", nuclides: [{ id: "H-3", activity: "5.08", units: "Ci" }] },
            { name: "TELESCOPE", nsn: "1240-01-051-3657", nuclides: [{ id: "H-3", activity: "1.6", units: "Ci" }] },
            { name: "LAMP UNIT", nsn: "1240-01-051-8472", nuclides: [{ id: "H-3", activity: "700", units: "mCi" }] },
            { name: "LEVEL, FIRE CONTROL", nsn: "1240-01-057-0112", nuclides: [{ id: "H-3", activity: "100", units: "mCi" }] },
            { name: "MOUNT, TELESCOPE", nsn: "1240-01-201-8299", nuclides: [{ id: "H-3", activity: "5.08", units: "Ci" }] },
            { name: "TELESCOPE, ELBOW", nsn: "1240-01-211-3608", nuclides: [{ id: "H-3", activity: "1.6", units: "Ci" }] },
            { name: "SCALE, INDICATING", nsn: "5355-01-053-3354", nuclides: [{ id: "H-3", activity: "1.2", units: "Ci" }] },
            { name: "DIAL, CONTROL", nsn: "5355-01-053-6448", nuclides: [{ id: "H-3", activity: "2", units: "Ci" }] },
            { name: "DIAL, CONTROL", nsn: "5355-01-212-8527", nuclides: [{ id: "H-3", activity: "2", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-053-3356", nuclides: [{ id: "H-3", activity: "90", units: "mCi" }] },
            { name: "TELESCOPE, ELBOW", nsn: "1240-01-280-5337", nuclides: [{ id: "H-3", activity: "2.5", units: "Ci" }] },
            { name: "LEVEL, FIRE CONTROL", nsn: "1240-01-287-9711", nuclides: [{ id: "H-3", activity: "150", units: "mCi" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-283-8659", nuclides: [{ id: "H-3", activity: "1.6", units: "Ci" }] },
            { name: "LAMP, NUCLEAR", nsn: "6260-01-280-1795", nuclides: [{ id: "H-3", activity: "1.6", units: "Ci" }] },
            { name: "RETICLE, OPTICAL INSTRUMENT", nsn: "6650-01-287-9710", nuclides: [{ id: "H-3", activity: "1.6", units: "Ci" }] },
            { name: "SUBASSEMBLY", nsn: "1240-01-306-2058", nuclides: [{ id: "Th-232", activity: "6.41", units: "nCi" }] },
            { name: "PRISM", nsn: "6650-01-170-4494", nuclides: [{ id: "Th-232", activity: "2.2", units: "nCi" }] },
            { name: "DIAL, CONTROL", nsn: "5355-01-342-2421", nuclides: [{ id: "H-3", activity: "2", units: "Ci" }] },
            { name: "DIAL, SCALE", nsn: "5355-01-343-1793", nuclides: [{ id: "H-3", activity: "1.1", units: "Ci" }] },
            { name: "MOUNT, TELESCOPE", nsn: "6650-01-340-6082", nuclides: [{ id: "H-3", activity: "5", units: "Ci" }] },
            { name: "TELESCOPE, ELBOW", nsn: "6650-01-341-5195", nuclides: [{ id: "H-3", activity: "800", units: "mCi" }] },
            { name: "DIAL, SCALE", nsn: "5355-01-212-8526", nuclides: [{ id: "H-3", activity: "1.2", units: "Ci" }] },
            { name: "SIGHT, BORE, OPTICAL", nsn: "1240-01-412-6608", nuclides: [{ id: "H-3", activity: "100", units: "mCi" }] },
            { name: "SIGHT, REFLEX", nsn: "1240-01-435-1916", nuclides: [{ id: "H-3", activity: "100", units: "mCi" }] },
            { name: "SIGHT UNIT", nsn: "1240-01-507-8580", nuclides: [{ id: "H-3", activity: "3.2", units: "Ci" }] },
            { name: "SIGHT, BORE, OPTICAL", nsn: "1240-01-525-1648", nuclides: [{ id: "H-3", activity: "100", units: "mCi" }] },
            { name: "SIGHT, REFLEX", nsn: "1240-01-581-6250", nuclides: [{ id: "H-3", activity: "250", units: "mCi" }] },
            { name: "SIGHT, REFLEX", nsn: "1240-25-150-7592", nuclides: [{ id: "H-3", activity: "10", units: "mCi" }] },
            { name: "SOURCE, RADIOACTIVE", nsn: "1260-01-510-1032", nuclides: [{ id: "Am-241", activity: "8", units: "µCi" }] },
            { name: "RECEIVER-TRANSMITTER", nsn: "1270-01-437-6581", nuclides: [{ id: "Am-241", activity: "9", units: "µCi" }] },
            { name: "OPTICS ASSEMBLY", nsn: "1280-01-300-0940", nuclides: [{ id: "Th-232", activity: "0.04", units: "µCi" }] },
            { name: "PROBE, ICE DETECTOR", nsn: "1660-00-077-8473", nuclides: [{ id: "Sr-90", activity: "50", units: "µCi" }] },
            { name: "REGULATOR, OXYGEN, DILUTER DEMAND", nsn: "1660-00-252-7796", nuclides: [{ id: "Ra-226", activity: "3", units: "µCi" }] },
            { name: "PROBE, ICE DETECTOR", nsn: "1660-00-919-0419", nuclides: [{ id: "Sr-90", activity: "50", units: "µCi" }] },
            { name: "REGULATOR, OXYGEN, DEMAND", nsn: "1660-00-927-1996", nuclides: [{ id: "Ra-226", activity: "1.2", units: "µCi" }] },
            { name: "SELECTOR, FREQUENCY, INSTRUMENT LANDING SYSTEM", nsn: "1660-01-483-2581", nuclides: [{ id: "Kr-85", activity: "0.27", units: "µCi" }] },
            { name: "REGULATOR, OXYGEN, DEMAND", nsn: "1660-01-492-5521", nuclides: [{ id: "Ra-226", activity: "1.2", units: "µCi" }] },
            { name: "POD, AIRCRAFT", nsn: "1680-01-186-1430", nuclides: [{ id: "Th-232", activity: "0.03", units: "µCi" }] },
            { name: "SELECTOR, FREQUENCY, INSTRUMENT LANDING SYSTEM", nsn: "1680-01-415-5778", nuclides: [{ id: "Kr-85", activity: "0.27", units: "µCi" }] },
            { name: "FLAP, VARIABLE EXHAUST NOZZLE, PRIMARY", nsn: "2480-01-450-1973", nuclides: [{ id: "U-238", activity: "0.003", units: "µCi" }] },
            { name: "EXCITER, GAS TURBINE ENGINE", nsn: "2835-00-601-1317", nuclides: [{ id: "Kr-85", activity: "6.9", units: "µCi" }] },
            { name: "IGNITER, TURBINE ENGINE, GAS", nsn: "2835-01-200-0298", nuclides: [{ id: "Kr-85", activity: "0.224", units: "µCi" }] },
            { name: "POWER UNIT, GAS TURBINE ENGINE", nsn: "2835-01-267-8229", nuclides: [{ id: "Kr-85", activity: "2.91", units: "µCi" }] },
            { name: "POWER UNIT", nsn: "2835-01-373-4275", nuclides: [{ id: "Kr-85", activity: "2.92", units: "µCi" }] },
            { name: "FLAP, VARIABLE EXHAUST NOZZLE, SECONDARY", nsn: "2840-01-438-9479", nuclides: [{ id: "U-238", activity: "0.03", units: "µCi" }] },
            { name: "SEAL, VARIABLE EXHAUST NOZZLE, SECONDARY", nsn: "2840-01-440-7755", nuclides: [{ id: "U-238", activity: "0.002", units: "µCi" }] },
            { name: "MIXER, AFTERBURNER", nsn: "2840-01-450-1980", nuclides: [{ id: "U-238", activity: "0.05", units: "µCi" }] },
            { name: "SEAL, VARIABLE EXHAUST NOZZLE, PRIMARY", nsn: "2840-01-450-1982", nuclides: [{ id: "U-238", activity: "0.001", units: "µCi" }] },
            { name: "FLAMEHOLDER, AFTERBURNER", nsn: "2840-01-450-3755", nuclides: [{ id: "U-238", activity: "0.06", units: "µCi" }] },
            { name: "IGNITION UNIT", nsn: "2925-00-133-9594", nuclides: [{ id: "Kr-85", activity: "0.084", units: "µCi" }] },
            { name: "VIBRATOR, IGNITION COIL", nsn: "2925-00-706-2720", nuclides: [{ id: "Cs-137", activity: "10", units: "µCi" }] },
            { name: "IGNITION UNIT", nsn: "2925-00-800-3403", nuclides: [{ id: "Kr-85", activity: "5", units: "µCi" }] },
            { name: "VIBRATOR, IGNITION COIL", nsn: "2925-00-968-9594", nuclides: [{ id: "Cs-137", activity: "5", units: "µCi" }] },
            { name: "VIBRATOR, IGNITION COIL", nsn: "2925-01-022-3181", nuclides: [{ id: "H-3", activity: "13", units: "µCi" }] },
            { name: "IGNITION EXCITER", nsn: "2925-01-057-6993", nuclides: [{ id: "Kr-85", activity: "2.9", units: "µCi" }] },
            { name: "VIBRATOR, IGNITION", nsn: "2925-01-077-3310", nuclides: [{ id: "Kr-85", activity: "0.3", units: "µCi" }] },
            { name: "VIBRATOR, IGNITION", nsn: "2925-01-077-6866", nuclides: [{ id: "Kr-85", activity: "0.2", units: "µCi" }] },
            { name: "COIL, IGNITION-EXCITER", nsn: "2925-01-323-9835", nuclides: [{ id: "Kr-85", activity: "6", units: "mCi" }] },
            { name: "IGNITER, SPARK GAP", nsn: "2925-01-550-0177", nuclides: [{ id: "Kr-85", activity: "0.173", units: "µCi" }] },
            { name: "ELECTRODE, WELDING", nsn: "3439-00-105-9945", nuclides: [{ id: "Th-232", activity: "0.2", units: "µCi" }] },
            { name: "DETECTOR, IONIZATION", nsn: "4210-00-595-5139", nuclides: [{ id: "Am-241", activity: "4", units: "µCi" }] },
            { name: "SEALED SOURCE, IONIZATION, SMOKE ALARM", nsn: "4210-01-185-2762", nuclides: [{ id: "Am-241", activity: "1.6", units: "µCi" }] },
            { name: "DETECTOR, GAMMA", nsn: "4470-00-444-3666", nuclides: [{ id: "C-14", activity: "100", units: "µCi" }] },
            { name: "PROCESSOR, VIDEO SIGNAL", nsn: "5836-01-052-6952", nuclides: [{ id: "Th-232", activity: "0.002", units: "µCi" }] },
            { name: "INDICATOR, RANGE", nsn: "5840-01-458-6159", nuclides: [{ id: "H-3", activity: "3.2", units: "Ci" }] },
            { name: "INDICATOR, RANGE", nsn: "5840-01-642-5687", nuclides: [{ id: "H-3", activity: "3.2", units: "Ci" }] },
            { name: "SPARK GAP, RADAR", nsn: "5841-01-054-6758", nuclides: [{ id: "Kr-85", activity: "25", units: "mCi" }] },
            { name: "RECEIVER-TRANSMITTER", nsn: "5841-01-056-8647", nuclides: [{ id: "H-3", activity: "15", units: "mCi" }] },
            { name: "RECEIVER-EXCITER", nsn: "5841-01-554-2099", nuclides: [{ id: "Pm-147", activity: "30", units: "µCi" }] },
            { name: "IMAGE INTENSIFIER ASSEMBLY", nsn: "5855-00-087-2948", nuclides: [{ id: "Th-232", activity: "4.9", units: "µCi" }] },
            { name: "NIGHT VISION SIGHT, INDIVIDUAL SERVED WEAPON", nsn: "5855-00-147-2508", nuclides: [{ id: "Th-232", activity: "15.2", units: "µCi" }] },
            { name: "LENS ASSEMBLY", nsn: "5855-00-156-4992", nuclides: [{ id: "Th-232", activity: "5.8", units: "µCi" }] },
            { name: "IMAGE INTENSIFIER ASSEMBLY", nsn: "5855-00-177-3502", nuclides: [{ id: "Th-232", activity: "4.89", units: "µCi" }] },
            { name: "LENS CAP", nsn: "5855-00-409-0915", nuclides: [{ id: "Th-232", activity: "2.9", units: "µCi" }] },
            { name: "NIGHT VISION SIGHT, INDIVIDUAL SERVED WEAPON", nsn: "5855-00-688-9954", nuclides: [{ id: "Th-232", activity: "2.9", units: "µCi" }] },
            { name: "NIGHT VISION SIGHT SUBASSEMBLY", nsn: "5855-00-791-1653", nuclides: [{ id: "Th-232", activity: "2.9", units: "µCi" }] },
            { name: "NIGHT VISION SIGHT", nsn: "5855-00-908-9314", nuclides: [{ id: "Th-232", activity: "15.2", units: "µCi" }] },
            { name: "EYEPIECE ASSEMBLY, NIGHT VISION SIGHT", nsn: "5855-00-941-3037", nuclides: [{ id: "Th-232", activity: "2.9", units: "µCi" }] },
            { name: "COLLIMATOR, BORESIGHT", nsn: "5855-01-029-8730", nuclides: [{ id: "Th-232", activity: "6", units: "nCi" }] },
            { name: "NIGHT VISION SIGHT", nsn: "5855-01-037-7339", nuclides: [{ id: "Th-232", activity: "0.05", units: "µCi" }] },
            { name: "RECEIVER-CONVERTER, INFRARED", nsn: "5855-01-052-6849", nuclides: [{ id: "Th-232", activity: "0.0015", units: "µCi" }] },
            { name: "AFOCAL ASSEMBLY", nsn: "5855-01-052-6944", nuclides: [{ id: "Th-232", activity: "0.002", units: "µCi" }] },
            { name: "IMAGER, INFRARED", nsn: "5855-01-053-0672", nuclides: [{ id: "Th-232", activity: "0.0015", units: "µCi" }] },
            { name: "INFRARED VIEWING SET", nsn: "5855-01-093-3080", nuclides: [{ id: "Th-232", activity: "0.1", units: "µCi" }] },
            { name: "IMAGE INTENSIFIER ASSEMBLY", nsn: "5855-01-352-7033", nuclides: [{ id: "Th-232", activity: "0.05", units: "µCi" }] },
            { name: "WINDOW, INFRARED", nsn: "5855-01-377-7112", nuclides: [{ id: "Th-232", activity: "0.0015", units: "µCi" }] },
            { name: "DETECTOR-DEWAR", nsn: "5855-01-486-0038", nuclides: [{ id: "Th-232", activity: "0.2", units: "µCi" }] },
            { name: "DUPLEXER", nsn: "5895-00-056-7033", nuclides: [{ id: "Co-60", activity: "0.8", units: "µCi" }] },
            { name: "CONTROL, RECEIVER", nsn: "5895-00-688-6030", nuclides: [{ id: "Ra-226", activity: "0.17", units: "µCi" }] },
            { name: "TUBE, TRANSMIT-RECEIVE", nsn: "5895-01-375-6748", nuclides: [
                { id: "Co-60", activity: "0.25", units: "µCi" },
                { id: "H-3", activity: "12510", units: "µCi" }
            ]},
            { name: "SWITCH, TOGGLE", nsn: "5930-00-615-9376", nuclides: [{ id: "Ra-226", activity: "150", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-001-1632", nuclides: [{ id: "Th-232", activity: "0.22", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-054-1987", nuclides: [{ id: "Th-232", activity: "3", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-060-3449", nuclides: [{ id: "Th-232", activity: "1.1", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-114-4849", nuclides: [{ id: "Th-232", activity: "0.018", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-131-6742", nuclides: [{ id: "Co-60", activity: "0.7", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-134-6004", nuclides: [{ id: "Re-187", activity: "0.01", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-134-6012", nuclides: [{ id: "Re-187", activity: "0.446", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-134-6031", nuclides: [{ id: "Re-187", activity: "0.01", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-134-6064", nuclides: [{ id: "Re-187", activity: "0.01", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-134-6073", nuclides: [{ id: "Re-187", activity: "0.0889", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-140-1600", nuclides: [{ id: "Kr-85", activity: "0.001", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-148-4724", nuclides: [{ id: "Ni-63", activity: "0.5", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-168-8386", nuclides: [{ id: "Th-232", activity: "1.1", units: "nCi" }] },
            { name: "TUBE, ELECTRON", nsn: "5960-00-170-4582", nuclides: [{ id: "H-3", activity: "1", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-179-4446", nuclides: [{ id: "Re-187", activity: "10", units: "pCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-188-0968", nuclides: [{ id: "Kr-85", activity: "0.05", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-188-3565", nuclides: [{ id: "Co-60", activity: "1", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-188-3574", nuclides: [{ id: "Re-187", activity: "0.02", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-188-8612", nuclides: [{ id: "Re-187", activity: "0.01", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-193-5127", nuclides: [{ id: "Th-232", activity: "0.26", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-220-6892", nuclides: [{ id: "Co-60", activity: "0.09", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-262-0161", nuclides: [{ id: "Re-187", activity: "0.02", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-262-0163", nuclides: [{ id: "Re-187", activity: "0.02", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-262-0210", nuclides: [{ id: "Re-187", activity: "0.01", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-262-0286", nuclides: [{ id: "Co-60", activity: "0.02", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-280-5585", nuclides: [{ id: "Re-187", activity: "0.01", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-297-7099", nuclides: [{ id: "Th-232", activity: "1.1", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-307-9918", nuclides: [{ id: "Th-232", activity: "1.1", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-338-0377", nuclides: [{ id: "Th-232", activity: "1.1", units: "nCi" }] },
            { name: "MAGNETRON", nsn: "5960-00-476-4750", nuclides: [{ id: "H-3", activity: "1", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-503-4880", nuclides: [{ id: "Kr-85", activity: "0.03", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-542-7004", nuclides: [{ id: "Re-187", activity: "0.04", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-552-0082", nuclides: [{ id: "Re-187", activity: "0.02", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-552-8277", nuclides: [{ id: "U-238", activity: "0.08", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-615-5619", nuclides: [{ id: "Th-232", activity: "120", units: "pCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-624-4718", nuclides: [{ id: "Ra-226", activity: "6", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-681-8037", nuclides: [{ id: "Co-60", activity: "0.15", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-682-8627", nuclides: [{ id: "Re-187", activity: "0.0889", units: "nCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-713-7014", nuclides: [{ id: "U-238", activity: "0.08", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-752-6384", nuclides: [{ id: "H-3", activity: "1", units: "µCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-00-827-8782", nuclides: [{ id: "Re-187", activity: "4.46", units: "nCi" }] },
            { name: "TUBE, ELECTRON", nsn: "5960-01-008-1351", nuclides: [{ id: "H-3", activity: "30", units: "mCi" }] },
            { name: "TUBE, ELECTRON", nsn: "5960-01-008-1352", nuclides: [{ id: "H-3", activity: "30", units: "mCi" }] },
            { name: "ELECTRON TUBE", nsn: "5960-01-013-9344", nuclides: [{ id: "Co-60", activity: "0.1", units: "µCi" }] },
            { name: "RADIAC SET", nsn: "6665-00-017-8903", nuclides: [{ id: "Kr-85", activity: "5", units: "mCi" }] },
            { name: "DETECTOR", nsn: "6665-01-282-7139", nuclides: [{ id: "Tc-99", activity: "0.2", units: "µCi" }] },
            { name: "RADIAC CALIBRATOR", nsn: "6665-01-333-5985", nuclides: [{ id: "Tc-99", activity: "0.2", units: "µCi" }] },
            { name: "DETECTOR, CHEMICAL AGENT, AUTOMATIC", nsn: "6665-01-438-3673", nuclides: [{ id: "Ni-63", activity: "30", units: "mCi" }] },
            { name: "DETECTOR KIT, CHEMICAL AGENT", nsn: "6665-01-491-8523", nuclides: [{ id: "Ni-63", activity: "10", units: "mCi" }] },
            { name: "SOURCE SET, RADIOACTIVITY", nsn: "6665-01-546-6120", nuclides: [{ id: "Sr-90", activity: "0.15", units: "µCi" }] },
            { name: "DETECTOR, CHEMICAL AGENT", nsn: "6665-99-203-6162", nuclides: [{ id: "Ni-63", activity: "30", units: "mCi" }] },
            { name: "CHEMICAL AGENT MONITOR", nsn: "6665-99-725-9996", nuclides: [{ id: "Ni-63", activity: "10", units: "mCi" }] },
            { name: "INDICATOR, PRESSURE", nsn: "6685-01-356-9967", nuclides: [{ id: "Sr-90", activity: "100", units: "µCi" }] },
        ];
        const radionuclideDetails = {
            'H-3': { name: 'Tritium', halfLife: '12.3 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Tritium' },
            'Am-241': { name: 'Americium-241', halfLife: '432.2 years', decayMode: 'Alpha, Gamma', wiki: 'https://en.wikipedia.org/wiki/Americium-241' },
            'Th-232': { name: 'Thorium-232', halfLife: '14.05 billion years', decayMode: 'Alpha', wiki: 'https://en.wikipedia.org/wiki/Thorium-232' },
            'Sr-90': { name: 'Strontium-90', halfLife: '28.8 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Strontium-90' },
            'Ra-226': { name: 'Radium-226', halfLife: '1600 years', decayMode: 'Alpha, Gamma', wiki: 'https://en.wikipedia.org/wiki/Radium-226' },
            'Kr-85': { name: 'Krypton-85', halfLife: '10.75 years', decayMode: 'Beta, Gamma', wiki: 'https://en.wikipedia.org/wiki/Krypton-85' },
            'U-238': { name: 'Uranium-238', halfLife: '4.468 billion years', decayMode: 'Alpha', wiki: 'https://en.wikipedia.org/wiki/Uranium-238' },
            'Cs-137': { name: 'Caesium-137', halfLife: '30.17 years', decayMode: 'Beta, Gamma', wiki: 'https://en.wikipedia.org/wiki/Caesium-137' },
            'Pm-147': { name: 'Promethium-147', halfLife: '2.62 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Promethium-147' },
            'Co-60': { name: 'Cobalt-60', halfLife: '5.27 years', decayMode: 'Beta, Gamma', wiki: 'https://en.wikipedia.org/wiki/Cobalt-60' },
            'Re-187': { name: 'Rhenium-187', halfLife: '43.3 billion years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Rhenium-187' },
            'Ni-63': { name: 'Nickel-63', halfLife: '100.1 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Nickel-63' },
            'C-14': { name: 'Carbon-14', halfLife: '5730 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Carbon-14' },
            'Tc-99': { name: 'Technetium-99', halfLife: '211,100 years', decayMode: 'Beta', wiki: 'https://en.wikipedia.org/wiki/Technetium-99' }
        };
        const nrcExemptionValues = {
            'Am-241': '0.01 µCi', 'C-14': '100 µCi', 'Cs-137': '10 µCi', 'Co-60': '1 µCi',
            'H-3': '1,000 µCi', 'Kr-85': '100 µCi', 'Ni-63': '100 µCi', 'N-63': '100 µCi',
            'Pm-147': '10 µCi', 'Ra-226': '0.1 µCi', 'Re-187': '100 µCi', 'Sr-90': '0.1 µCi',
            'Tc-99': '10 µCi', 'Th-232': '--', 'U-238': '--'
        };
        const dotExemptionValues = {
            'H-3': '27 mCi', 'Am-241': '0.27 µCi', 'Th-232': '0.27 µCi', 'Sr-90': '0.27 µCi',
            'Ra-226': '0.27 µCi', 'Kr-85': '0.27 µCi', 'U-238': '0.27 µCi', 'Cs-137': '0.27 µCi',
            'Pm-147': '270 µCi', 'Co-60': '2.7 µCi', 'Re-187': '27 mCi', 'Ni-63': '2.7 mCi',
            'N-63': '2.7 mCi', 'C-14': '270 µCi', 'Tc-99': '270 µCi'
        };
        const un2911Limits = {
            'Am-241': '0.00027 Ci', 'C-14': '0.81 Ci', 'Co-60': '0.11 Ci', 'Cs-137': '0.16 Ci',
            'H-3': '22 Ci', 'Kr-85': '0.27 Ci', 'Ni-63': '8.1 Ci', 'N-63': '8.1 Ci',
            'Pm-147': '0.54 Ci', 'Ra-226': '0.00081 Ci', 'Re-187': 'Unlimited', 'Sr-90': '0.081 Ci',
            'Tc-99': '0.24 Ci', 'Th-232': 'Unlimited', 'U-238': 'Unlimited'
        };
        const un2911PkgLimits = {
            'Am-241': '0.027 Ci', 'C-14': '81 Ci', 'Co-60': '11 Ci', 'Cs-137': '16 Ci',
            'H-3': '220 Ci', 'Kr-85': '2.7 Ci', 'Ni-63': '810 Ci', 'N-63': '810 Ci',
            'Pm-147': '54 Ci', 'Ra-226': '0.081 Ci', 'Re-187': 'Unlimited', 'Sr-90': '8.1 Ci',
            'Tc-99': '24 Ci', 'Th-232': 'Unlimited', 'U-238': 'Unlimited'
        };
        const dotA2Values = {
            'Am-241': '0.027 Ci', 'C-14': '54 Ci', 'Co-60': '11 Ci', 'Cs-137': '16 Ci',
            'H-3': '1100 Ci', 'Kr-85': '270 Ci', 'Ni-63': '810 Ci', 'N-63': '810 Ci',
            'Pm-147': '54 Ci', 'Ra-226': '0.54 Ci', 'Re-187': 'Unlimited', 'Sr-90': '8.1 Ci',
            'Tc-99': '54 Ci', 'Th-232': 'Unlimited', 'U-238': 'Unlimited'
        };

        // --- GLOBAL STATE ---
        let tableData = [];
        let currentSort = { column: null, direction: 'asc' };
        
        // --- UTILITY FUNCTIONS ---
        const CI_TO_BQ = 3.7e10;
        const ciMultipliers = { 'pci': 1e-12, 'nci': 1e-9, 'µci': 1e-6, 'uci': 1e-6, 'mci': 1e-3, 'ci': 1 };
        
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.error(`Failed to set item "${key}":`, e);
            }
        }
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.error(`Failed to get item "${key}":`, e);
                return null;
            }
        }
        function safeRemoveItem(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error(`Failed to remove item "${key}":`, e);
            }
        }
        
        function formatNumberWithCommas(number) {
            return number.toLocaleString('en-US');
        }
        function parseValueToCi(valueStr) {
            if (typeof valueStr !== 'string' || valueStr === '--' || valueStr.toLowerCase() === 'unlimited') {
                return null;
            }
            const parts = valueStr.trim().split(/\s+/);
            const value = parseFloat(String(parts[0]).replace(/,/g, ''));
            const unit = parts[1] || 'Ci';
            const multiplier = ciMultipliers[unit.trim().toLowerCase()] || 1;
            return isNaN(value) ? null : value * multiplier;
        }
        function formatCi(valueCi) {
            if (valueCi === null || typeof valueCi === 'undefined') return '--';
            if (valueCi === 0) return '0 Ci';
            const units = ['pCi', 'nCi', 'µCi', 'mCi', 'Ci'];
            let unitIndex = 4;
            let value = valueCi;
            while (value < 1 && unitIndex > 0) {
                value *= 1000;
                unitIndex--;
            }
            return `${formatNumberWithCommas(parseFloat(value.toPrecision(3)))} ${units[unitIndex]}`;
        }
        function formatBq(valueCi) {
            if (valueCi === null || typeof valueCi === 'undefined') return '--';
            if (valueCi === 0) return '0 Bq';
            let valueBq = valueCi * CI_TO_BQ;
            const units = ['Bq', 'kBq', 'MBq', 'GBq', 'TBq'];
            let unitIndex = 0;
            while (valueBq >= 1000 && unitIndex < units.length - 1) {
                valueBq /= 1000;
                unitIndex++;
            }
            let displayValue = parseFloat(valueBq.toPrecision(3));
            if (displayValue >= 999 && unitIndex < units.length - 1) {
                displayValue = 1;
                unitIndex++;
            } else if (displayValue >= 99.9 && displayValue < 100) {
                 displayValue = 100;
            } else if (displayValue >= 9.99 && displayValue < 10) {
                 displayValue = 10;
            }
            return `${formatNumberWithCommas(displayValue)} ${units[unitIndex]}`;
        }
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }
        function activateFocusTrap(modalElement) {
            const focusableElements = modalElement.querySelectorAll(
                'a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );
            if (focusableElements.length === 0) return;
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            setTimeout(() => firstElement.focus(), 100);
            function handleKeyDown(e) {
                if (e.key !== 'Tab') return;
                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        lastElement.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        firstElement.focus();
                        e.preventDefault();
                    }
                }
            }
            modalElement.addEventListener('keydown', handleKeyDown);
            return () => {
                modalElement.removeEventListener('keydown', handleKeyDown);
            };
        }

        // --- CORE LOGIC ---
        function processData(baseData, customData) {
            const processed = [];
            let uniqueId = 0;
            baseData.forEach(item => {
                if (item.nuclides && item.nuclides.length > 0) {
                    item.nuclides.forEach(nuclide => {
                        const flatItem = {
                            name: item.name, nsn: item.nsn,
                            radionuclide: nuclide.id, activity: nuclide.activity, units: nuclide.units
                        };
                        processed.push(createRowObject(flatItem, uniqueId++, false));
                    });
                }
            });
            customData.forEach(item => {
                processed.push(createRowObject(item, item.id, true));
            });
            return processed;
        }
        function createRowObject(item, id, isCustom = false) {
            const radionuclide = item.radionuclide.trim();
            const activityVal = parseValueToCi(`${item.activity} ${item.units}`);
            const nrcExemptionVal = parseValueToCi(nrcExemptionValues[radionuclide]);
            const dotExemptionVal = parseValueToCi(dotExemptionValues[radionuclide]);
            const un2911LimitVal = parseValueToCi(un2911Limits[radionuclide]);
            const un2911PkgLimitVal = parseValueToCi(un2911PkgLimits[radionuclide]);
            const dotA2Val = parseValueToCi(dotA2Values[radionuclide]);
            return {
                id: id, isCustom: isCustom, name: item.name, nsn: item.nsn,
                niin: item.niin || (item.nsn ? item.nsn.substring(5).replace(/-/g, '') : ''),
                radionuclide: radionuclide, activity_val: activityVal, nrc_exemption_val: nrcExemptionVal,
                dot_exemption_val: dotExemptionVal, un2911_limit_val: un2911LimitVal,
                un2911_pkg_limit_val: un2911PkgLimitVal, dot_a2_val: dotA2Val,
                activity_ci_str: formatCi(activityVal),
                nrc_exemption_ci_str: nrcExemptionVal !== null ? formatCi(nrcExemptionVal) : (nrcExemptionValues[radionuclide] || 'N/A'),
                dot_exemption_ci_str: dotExemptionVal !== null ? formatCi(dotExemptionVal) : (dotExemptionValues[radionuclide] || 'N/A'),
                un2911_limit_ci_str: un2911LimitVal !== null ? formatCi(un2911LimitVal) : 'Unlimited',
                un2911_pkg_limit_ci_str: un2911PkgLimitVal !== null ? formatCi(un2911PkgLimitVal) : 'Unlimited',
                activity_bq_str: formatBq(activityVal),
                nrc_exemption_bq_str: nrcExemptionVal !== null ? formatBq(nrcExemptionVal) : (nrcExemptionValues[radionuclide] || 'N/A'),
                dot_exemption_bq_str: dotExemptionVal !== null ? formatBq(dotExemptionVal) : (dotExemptionValues[radionuclide] || 'N/A'),
                un2911_limit_bq_str: un2911LimitVal !== null ? formatBq(un2911LimitVal) : 'Unlimited',
                un2911_pkg_limit_bq_str: un2911PkgLimitVal !== null ? formatBq(un2911PkgLimitVal) : 'Unlimited',
            };
        }
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) {
                return text ? escapeHTML(text) : ''; 
            }
            const escapedText = escapeHTML(text);
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapeHTML(escapedSearchTerm)})`, 'gi');
            return escapedText.replace(regex, `<span class="highlight">$1</span>`);
        }
        function populateTable(data) {
            const tableBody = document.querySelector('#lookupTable tbody');
            const isSiUnits = document.getElementById('unitToggle').checked;
            const searchTerm = document.getElementById('searchInput').value;
            tableBody.innerHTML = '';
            const rows = data.map((item) => {
                const nrcExemption = isSiUnits ? item.nrc_exemption_bq_str : item.nrc_exemption_ci_str;
                const dotExemption = isSiUnits ? item.dot_exemption_bq_str : item.dot_exemption_ci_str;
                const un2911Limit = isSiUnits ? item.un2911_limit_bq_str : item.un2911_limit_ci_str;
                const un2911PkgLimit = isSiUnits ? item.un2911_pkg_limit_bq_str : item.un2911_pkg_limit_ci_str;
                const activity = isSiUnits ? item.activity_bq_str : item.activity_ci_str;
                const rowClasses = ['border-b', 'dark:border-gray-700', 'hover:bg-gray-50', 'dark:hover:bg-gray-600'];
                if (item.isCustom) { rowClasses.push('custom-row'); } 
                else { rowClasses.push('bg-white', 'dark:bg-gray-800'); }
                const customIcon = item.isCustom ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="inline-block ml-2 text-blue-600 dark:text-blue-300" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg>` : '';
                const highlightedName = highlightText(item.name, searchTerm);
                const highlightedNsn = highlightText(item.nsn, searchTerm);
                const highlightedNiin = highlightText(item.niin, searchTerm);
                return `
                    <tr class="${rowClasses.join(' ')}" data-id="${item.id}">
                        <td class="px-6 py-4 text-center" data-label="Select"><input type="checkbox" class="row-checkbox" data-id="${item.id}"></td>
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white text-left" data-label="Name">${highlightedName}${customIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center expandable" data-label="NSN">${highlightedNsn || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center expandable" data-label="NIIN">${highlightedNiin || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center radionuclide-link text-blue-500 hover:underline cursor-pointer" data-label="Radionuclide" data-radionuclide="${item.radionuclide}">${item.radionuclide}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap" data-label="Activity">${activity}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="NRC Exemption">${nrcExemption}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="DOT Exemption">${dotExemption}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="UN 2911 Limit (item)">${un2911Limit}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap expandable" data-label="UN 2911 Limit (package)">${un2911PkgLimit}</td>
                        <td class="toggle-cell"><button class="details-toggle-btn">Show More</button></td>
                    </tr>`;
            }).join('');
            tableBody.innerHTML = rows;
        }
        function performSort() {
            const filteredData = getFilteredData();
            filteredData.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                if (valA === null) return 1;
                if (valB === null) return -1;
                let comparison = 0;
                if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB, undefined, { numeric: true });
                } else {
                    if (valA > valB) comparison = 1;
                    else if (valA < valB) comparison = -1;
                }
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
            updateSortArrows();
            populateTable(filteredData);
        }
        function sortTable(columnKey) {
            const isSameColumn = currentSort.column === columnKey;
            if (isSameColumn) {
                currentSort.direction = (currentSort.direction === 'asc') ? 'desc' : 'asc';
            } else {
                currentSort.direction = 'asc';
            }
            currentSort.column = columnKey;
            performSort();
            saveState();
        }
        function updateSortArrows() {
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sorted-column');
                const arrow = th.querySelector('.sort-arrow');
                if (arrow) { arrow.classList.remove('asc', 'desc'); }
            });
            const header = document.querySelector(`th[onclick="sortTable('${currentSort.column}')"]`);
            if (header) {
                header.classList.add('sorted-column');
                const arrow = header.querySelector('.sort-arrow');
                if (arrow) { arrow.classList.add(currentSort.direction); }
            }
        }
        function getFilteredData() {
            const searchInput = document.getElementById("searchInput");
            const textFilter = searchInput.value.toUpperCase();
            const radionuclideFilter = document.getElementById('radionuclideFilter');
            const nuclideFilter = radionuclideFilter.value;
            const nrcExemptOnly = document.getElementById('nrcExemptFilter').checked;
            const dotExemptOnly = document.getElementById('dotExemptFilter').checked;
            return tableData.filter(item => {
                const nuclideMatch = nuclideFilter === 'all' || item.radionuclide === nuclideFilter;
                const nrcExemptMatch = !nrcExemptOnly || (item.nrc_exemption_val !== null && item.activity_val <= item.nrc_exemption_val);
                const dotExemptMatch = !dotExemptOnly || (item.dot_exemption_val !== null && item.activity_val <= item.dot_exemption_val);
                let textMatch = false;
                if (textFilter === "") {
                    textMatch = true;
                } else {
                    const searchableValues = [item.name, item.nsn, item.niin];
                    textMatch = searchableValues.some(val => val && val.toUpperCase().includes(textFilter));
                }
                return nuclideMatch && textMatch && nrcExemptMatch && dotExemptMatch;
            });
        }
        function filterTable() {
            const filteredData = getFilteredData();
            const noResultsDiv = document.getElementById("noResults");
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            populateTable(filteredData);
            if (filteredData.length === 0) {
                noResultsDiv.innerHTML = `<p class="font-semibold">No results found.</p><p class="mt-2 text-sm">Try adjusting your search term or clearing some filters.</p>`;
                noResultsDiv.style.display = 'block';
                selectAllCheckbox.checked = false;
                selectAllCheckbox.disabled = true;
            } else {
                noResultsDiv.style.display = 'none';
                selectAllCheckbox.disabled = false;
            }
            updateSelectionState();
        }
        function updateSelectionState() {
            const allVisibleCheckboxes = document.querySelectorAll('#lookupTable tbody tr .row-checkbox');
            const allVisibleChecked = Array.from(allVisibleCheckboxes).every(cb => cb.checked);
            document.getElementById('selectAllCheckbox').checked = allVisibleCheckboxes.length > 0 && allVisibleChecked;
        }
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, 3000);
        }
        function exportDisposalRequestAsCSV() {
            const form = document.getElementById('disposalRequestForm');
            if (!form) return;
            const escapeCsvCell = (cell) => {
                if (cell === null || typeof cell === 'undefined') return '""';
                let str = String(cell);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    str = `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };
            const pocs = [];
            const pocCards = form.querySelectorAll('.poc-card');
            pocCards.forEach((card, index) => {
                const pocNumber = index + 1;
                const getValue = (field) => card.querySelector(`[data-form-id="poc${pocNumber}${field}"]`)?.value || '';
                pocs.push({
                    name: getValue('Name'), title: getValue('Title'), email: getValue('Email'),
                    businessPhone: getValue('BusinessPhone'), mobilePhone: getValue('MobilePhone')
                });
            });
            const staticHeadersStart = [
                'UIC', 'Command Name', 'Street Address', 'City', 'State', 'Zip', 'Country'
            ];
            const pocHeaders = [];
            pocs.forEach((poc, index) => {
                const pocNumber = index + 1;
                pocHeaders.push(
                    `POC ${pocNumber} Name`, `POC ${pocNumber} Title`, `POC ${pocNumber} Email`,
                    `POC ${pocNumber} Business #`, `POC ${pocNumber} Mobile #`
                );
            });
            const staticHeadersEnd = [
                'Security Requirements', 'Pickup Address', 'Pickup Building',
                'Item Name', 'NSN', 'Quantity', 'Serial #(s)', 'DEMIL', 'SSDR', 'Radionuclide', 'Activity (Ci)', 'Assay Date',
                'Licensed', 'License/Permit #', 'Form', 'Volume', 'Weight', 'Other Info',
                'Mfg. Name', 'Mfg. Model', 'Mfg. Date'
            ];
            const headers = [...staticHeadersStart, ...pocHeaders, ...staticHeadersEnd];
            let csvString = headers.map(escapeCsvCell).join(",") + "\n";
            const itemCards = form.querySelectorAll('.disposal-item');
            itemCards.forEach(itemCard => {
                const itemId = itemCard.dataset.itemId;
                const itemData = tableData.find(d => d.id == itemId);
                const getFieldValue = (id) => itemCard.querySelector(`[data-form-id="${id}"]`)?.value || '';
                const serialInputs = itemCard.querySelectorAll('[data-form-id="serial"]');
                const serials = Array.from(serialInputs).map(input => input.value).filter(val => val).join('; ');
                const staticRowDataStart = [
                    form.querySelector('[data-form-id="uic"]').value, form.querySelector('[data-form-id="commandName"]').value,
                    form.querySelector('[data-form-id="streetAddress"]').value, form.querySelector('[data-form-id="city"]').value,
                    form.querySelector('[data-form-id="state"]').value, form.querySelector('[data-form-id="zip"]').value,
                    form.querySelector('[data-form-id="country"]').value
                ];
                const pocRowData = [];
                pocs.forEach(poc => {
                    pocRowData.push(poc.name, poc.title, poc.email, poc.businessPhone, poc.mobilePhone);
                });
                const staticRowDataEnd = [
                    form.querySelector('[data-form-id="security"]').value,
                    form.querySelector('[data-form-id="pickupAddress"]').value, form.querySelector('[data-form-id="pickupBuilding"]').value,
                    itemData.name, itemData.nsn, getFieldValue('quantity'), serials, getFieldValue('demil'), getFieldValue('ssdr'),
                    itemData.radionuclide, itemData.activity_ci_str, getFieldValue('assayDate'), getFieldValue('licensed'),
                    getFieldValue('licenseNumber'), getFieldValue('form'), getFieldValue('volume'), getFieldValue('weight'),
                    getFieldValue('otherInfo'), getFieldValue('mfgName'), getFieldValue('mfgModel'), getFieldValue('mfgDate')
                ];
                const rowData = [...staticRowDataStart, ...pocRowData, ...staticRowDataEnd];
                csvString += rowData.map(escapeCsvCell).join(",") + "\n";
            });
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "disposal_request.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Disposal request exported as CSV!', 'success');
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Element selectors
            const darkModeToggle = document.getElementById('darkModeToggle');
            const unitToggle = document.getElementById('unitToggle');
            const tableBody = document.querySelector('#lookupTable tbody');
            const compareBtn = document.getElementById('compareBtn');
            const exportSelectionBtn = document.getElementById('exportSelectionBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            const disposalRequestBtn = document.getElementById('disposalRequestBtn');
            const compareModal = document.getElementById('compareModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const compareContent = document.getElementById('compareContent');
            const detailModal = document.getElementById('detailModal');
            const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
            const detailContent = document.getElementById('detailContent');
            const detailActions = document.getElementById('detailActions');
            const detailModalTitle = document.getElementById('detailModalTitle');
            const radionuclideFilter = document.getElementById('radionuclideFilter');
            const disposalRequestModal = document.getElementById('disposalRequestModal');
            const closeDisposalRequestModalBtn = document.getElementById('closeDisposalRequestModalBtn');
            const disposalRequestContent = document.getElementById('disposalRequestContent');
            const nrcExemptFilter = document.getElementById('nrcExemptFilter');
            const dotExemptFilter = document.getElementById('dotExemptFilter');
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
            const saveSelectionBtn = document.getElementById('saveSelectionBtn');
            const loadSelectionBtn = document.getElementById('loadSelectionBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const clearSavedBtn = document.getElementById('clearSavedBtn');
            const addItemBtn = document.getElementById('addItemBtn');
            const addItemModal = document.getElementById('addItemModal');
            const closeAddItemModalBtn = document.getElementById('closeAddItemModalBtn');
            const cancelAddItemBtn = document.getElementById('cancelAddItemBtn');
            const addItemForm = document.getElementById('addItemForm');
            const itemRadionuclideSelect = document.getElementById('itemRadionuclide');
            const clearAddedBtn = document.getElementById('clearAddedBtn');
            const importCustomBtn = document.getElementById('importCustomBtn');
            const exportCustomBtn = document.getElementById('exportCustomBtn');
            const importFileInput = document.getElementById('importFileInput');
            const searchInput = document.getElementById('searchInput');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const radionuclideDetailModal = document.getElementById('radionuclideDetailModal');
            const closeRadionuclideModalBtn = document.getElementById('closeRadionuclideModalBtn');
            const tooltipModal = document.getElementById('tooltipModal');
            const closeTooltipModalBtn = document.getElementById('closeTooltipModalBtn');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const printRequestBtn = document.getElementById('printRequestBtn');
            const generateMemoBtn = document.getElementById('generateMemoBtn');
            const memoModal = document.getElementById('memoModal');
            const closeMemoModalBtn = document.getElementById('closeMemoModalBtn');
            const copyMemoBtn = document.getElementById('copyMemoBtn');
            const memoContent = document.getElementById('memoContent');
            const instructionsModal = document.getElementById('instructionsModal');
            const showInstructionsBtn = document.getElementById('showInstructionsBtn');
            const closeInstructionsModalBtn = document.getElementById('closeInstructionsModalBtn');
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalText = document.getElementById('confirmModalText');
            const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
            const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
            const allModals = [compareModal, detailModal, disposalRequestModal, helpModal, addItemModal, confirmModal, radionuclideDetailModal, tooltipModal, memoModal, instructionsModal];

            // State for accessibility and modals
            let removeCurrentFocusTrap = null;
            let confirmCallback = null;
            let focusedElementBeforeModal = null;

            // Centralized Modal Functions with Focus Management
            function openModal(modalElement) {
                focusedElementBeforeModal = document.activeElement;
                modalElement.style.display = 'flex';
                removeCurrentFocusTrap = activateFocusTrap(modalElement);
            }
            function closeModal(modalElement) {
                if (typeof removeCurrentFocusTrap === 'function') {
                    removeCurrentFocusTrap();
                    removeCurrentFocusTrap = null;
                }
                modalElement.style.display = 'none';
                if (focusedElementBeforeModal) {
                    focusedElementBeforeModal.focus();
                }
            }

            // Dark Mode
            if (safeGetItem('darkMode') === 'enabled') {
                darkModeToggle.checked = true;
            }
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    safeSetItem('darkMode', 'enabled');
                } else {
                    document.documentElement.classList.remove('dark');
                    safeSetItem('darkMode', 'disabled');
                }
            });

            // Table interaction
            tableBody.addEventListener('click', (event) => {
                const toggleBtn = event.target.closest('.details-toggle-btn');
                if (toggleBtn) {
                    const row = toggleBtn.closest('tr');
                    row.classList.toggle('details-visible');
                    toggleBtn.textContent = row.classList.contains('details-visible') ? 'Show Less' : 'Show More';
                    return;
                }
                const targetCell = event.target.closest('td');
                if (!targetCell) return;
                if (targetCell.classList.contains('radionuclide-link')) {
                    const nuclideId = targetCell.dataset.radionuclide;
                    showRadionuclideModal(nuclideId);
                    return;
                }
                const row = targetCell.parentElement;
                const checkbox = row.querySelector('.row-checkbox');
                if (targetCell.cellIndex === 0) {
                    if (event.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                } else {
                    const itemId = row.dataset.id;
                    const item = tableData.find(d => d.id == itemId);
                    if (item) {
                        showDetailModal(item);
                    }
                }
            });
            tableBody.addEventListener('change', (event) => {
                 if (event.target.classList.contains('row-checkbox')) {
                    const row = event.target.closest('tr');
                    if (event.target.checked) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                    const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
                    compareBtn.disabled = selectedCount < 2;
                    exportSelectionBtn.disabled = selectedCount === 0;
                    clearSelectionBtn.disabled = selectedCount === 0;
                    disposalRequestBtn.disabled = selectedCount === 0;
                    saveSelectionBtn.disabled = selectedCount === 0;
                    updateSelectionState();
                }
            });

            function copyToClipboard(text, buttonElement) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Copied to clipboard!', 'success');
                    if(buttonElement){
                        const clipboardIcon = buttonElement.querySelector('.clipboard-icon');
                        const checkmarkIcon = buttonElement.querySelector('.checkmark-icon');
                        if (clipboardIcon && checkmarkIcon) {
                            clipboardIcon.style.display = 'none';
                            checkmarkIcon.style.display = 'inline-block';
                            setTimeout(() => {
                                clipboardIcon.style.display = 'inline-block';
                                checkmarkIcon.style.display = 'none';
                            }, 1500);
                        }
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showToast('Failed to copy!', 'error');
                }
                document.body.removeChild(textarea);
            }

            // Modal Functions
            function showDetailModal(item) {
                const isSiUnits = unitToggle.checked;
                detailModalTitle.textContent = item.name;
                const copyButtonHTML = (copyText) => `
                    <button data-copy="${copyText || ''}" class="copy-btn ml-2 p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Copy">
                        <svg class="clipboard-icon w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 7a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15A.5.5 0 0 1-1 7z"/></svg>
                        <svg class="checkmark-icon w-4 h-4 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </button>`;
                let content = `<div class="space-y-4">`;
                content += `<div class="flex justify-between items-center"><strong>NSN:</strong> <span>${escapeHTML(item.nsn || 'N/A')} ${copyButtonHTML(item.nsn)}</span></div>`;
                content += `<div class="flex justify-between items-center"><strong>NIIN:</strong> <span>${escapeHTML(item.niin || 'N/A')} ${copyButtonHTML(item.niin)}</span></div>`;		
                if (item.nsn) {
                    content += `<div><a href="https://www.iso-group.com/NSN/${item.nsn}" target="_blank" class="text-blue-500 hover:underline">Lookup via ISO-Group</a></div>`;
                }
                content += `<hr class="dark:border-gray-600 my-4">`;
                content += `<div class="mb-4"><strong>Activity:</strong> ${isSiUnits ? item.activity_bq_str : item.activity_ci_str} of <span class="radionuclide-link text-blue-500 hover:underline cursor-pointer" data-radionuclide="${item.radionuclide}">${item.radionuclide}</span></div>`;
                const comparisons = [
                    { key: 'nrc_exemption_val', label: 'NRC Exemption', limit: item.nrc_exemption_val, str: isSiUnits ? item.nrc_exemption_bq_str : item.nrc_exemption_ci_str },
                    { key: 'dot_exemption_val', label: 'DOT Exemption', limit: item.dot_exemption_val, str: isSiUnits ? item.dot_exemption_bq_str : item.dot_exemption_ci_str },
                    { key: 'un2911_limit_val', label: 'UN 2911 Limit (item)', limit: item.un2911_limit_val, str: isSiUnits ? item.un2911_limit_bq_str : item.un2911_limit_ci_str },
                    { key: 'un2911_pkg_limit_val', label: 'UN 2911 Limit (package)', limit: item.un2911_pkg_limit_val, str: isSiUnits ? item.un2911_pkg_limit_bq_str : item.un2911_pkg_limit_ci_str }
                ];
                comparisons.forEach(comp => {
                    let status, statusColor, percentage = 0;
                    if (item.activity_val === null || comp.limit === null) {
                        status = 'N/A';
                        statusColor = 'text-gray-500';
                    } else if (item.activity_val > comp.limit) {
                        status = 'ABOVE';
                        statusColor = 'text-red-500';
                    } else {
                        status = 'BELOW';
                        statusColor = 'text-green-500';
                    }
                    if (item.activity_val !== null && comp.limit !== null && comp.limit > 0) {
                        percentage = Math.min((item.activity_val / comp.limit) * 100, 100);
                    }
                    content += `<div class="mb-3">`;
                    content += `<div class="flex justify-between items-center">
                                    <span class="flex items-center">
                                        ${comp.label}: ${comp.str}
                                        <svg data-tooltip-key="${comp.key}" class="tooltip-icon ml-2 w-4 h-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-pointer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    </span> 
                                    <span class="font-bold ${statusColor}">${status}</span>
                                </div>`;
                    if (status !== 'N/A') {
                        const barColor = statusColor.replace('text-', 'bg-');
                        content += `
                            <div class="progress-bar-container">
                                <div class="progress-bar ${barColor}" style="width: ${percentage}%;">
                                    ${percentage.toFixed(0)}%
                                </div>
                            </div>`;
                    }
                    content += `</div>`;
                });
                content += `</div>`;
                detailContent.innerHTML = content;
                const nuclideLink = detailContent.querySelector('.radionuclide-link');
                if (nuclideLink) {
                    nuclideLink.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const nuclideId = e.target.dataset.radionuclide;
                        showRadionuclideModal(nuclideId);
                    });
                }
                detailContent.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const textToCopy = button.dataset.copy;
                        if(textToCopy) { copyToClipboard(textToCopy, button); }
                    });
                });
                detailContent.querySelectorAll('.tooltip-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tooltipKey = e.currentTarget.dataset.tooltipKey;
                        showTooltipModal(tooltipKey);
                    });
                });
                detailActions.innerHTML = '';
                const addToPackageBtn = document.createElement('button');
                const checkbox = document.querySelector(`.row-checkbox[data-id="${item.id}"]`);
                function updateAddToPackageButtonState() {
                    if (checkbox && checkbox.checked) {
                        addToPackageBtn.textContent = 'Remove from Package';
                        addToPackageBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600';
                    } else {
                        addToPackageBtn.textContent = 'Add to Package';
                        addToPackageBtn.className = 'px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600';
                    }
                }
                updateAddToPackageButtonState();
                addToPackageBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        const changeEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                        updateAddToPackageButtonState();
                    }
                };
                detailActions.appendChild(addToPackageBtn);
                const customActionsContainer = document.createElement('div');
                customActionsContainer.className = 'flex gap-4';
                if(item.isCustom) {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600';
                    editBtn.onclick = () => {
                        closeModal(detailModal);
                        showAddItemModal(item);
                    };
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600';
                    deleteBtn.onclick = () => {
                        showConfirmationModal(`Are you sure you want to delete the item "${item.name}"?`, () => {
                            closeModal(detailModal);
                            deleteCustomItem(item.id);
                        });
                    };
                    customActionsContainer.appendChild(editBtn);
                    customActionsContainer.appendChild(deleteBtn);
                }
                detailActions.appendChild(customActionsContainer);
                openModal(detailModal);
            }
            compareBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedData = Array.from(selectedCheckboxes).map(cb => tableData.find(d => d.id == cb.dataset.id));
                const isSiUnits = unitToggle.checked;
                let content = '<div class="overflow-x-auto"><table class="w-full text-sm text-left">';
                const headers = ['Attribute', ...selectedData.map(item => escapeHTML(item.name))];
                content += '<thead><tr class="bg-gray-100 dark:bg-gray-700">';
                headers.forEach(header => content += `<th class="px-4 py-2">${header}</th>`);
                content += '</tr></thead><tbody>';
                const attributes = [
                    { label: 'NSN', key: 'nsn' }, { label: 'NIIN', key: 'niin' },
                    { label: 'Radionuclide', key: 'radionuclide' },
                    { label: 'Activity', key: isSiUnits ? 'activity_bq_str' : 'activity_ci_str' },
                    { label: 'NRC Exemption', key: isSiUnits ? 'nrc_exemption_bq_str' : 'nrc_exemption_ci_str' },
                    { label: 'DOT Exemption', key: isSiUnits ? 'dot_exemption_bq_str' : 'dot_exemption_ci_str' },
                    { label: 'UN 2911 Limit (item)', key: isSiUnits ? 'un2911_limit_bq_str' : 'un2911_limit_ci_str' },
                    { label: 'UN 2911 Limit (package)', key: isSiUnits ? 'un2911_pkg_limit_bq_str' : 'un2911_pkg_limit_ci_str' }
                ];
                attributes.forEach(attr => {
                    content += '<tr class="border-b dark:border-gray-700">';
                    content += `<td class="px-4 py-2 font-semibold">${attr.label}</td>`;
                    selectedData.forEach(item => {
                        content += `<td class="px-4 py-2">${escapeHTML(item[attr.key] || '')}</td>`;
                    });
                    content += '</tr>';
                });
                content += '</tbody></table></div>';
                compareContent.innerHTML = content;
                openModal(compareModal);
            });
            function createPocHtml(pocNumber) {
                return `
                    <div class="p-4 border rounded-lg dark:border-gray-600 poc-card">
                        <h4 class="font-semibold mb-2">POC ${pocNumber}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="block text-sm font-medium">Name</label><input type="text" data-form-id="poc${pocNumber}Name" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Title</label><input type="text" data-form-id="poc${pocNumber}Title" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">E-mail</label><input type="email" data-form-id="poc${pocNumber}Email" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Business #</label><input type="tel" data-form-id="poc${pocNumber}BusinessPhone" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Mobile #</label><input type="tel" data-form-id="poc${pocNumber}MobilePhone" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                        </div>
                    </div>`;
            }
            function showDisposalRequestModal() {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedItems = Array.from(selectedCheckboxes).map(cb => tableData.find(d => d.id == cb.dataset.id));
                let content = '<form id="disposalRequestForm" class="space-y-6">';
                content += `
                    <details class="group" open>
                        <summary class="text-lg font-semibold cursor-pointer list-none group-open:mb-4">
                            <span class="group-open:hidden">►</span><span class="hidden group-open:inline">▼</span> Command Information
                        </summary>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-l-2 border-gray-200 dark:border-gray-600 pl-4">
                            <div><label class="block text-sm font-medium">UIC</label><input type="text" data-form-id="uic" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Command Name</label><input type="text" data-form-id="commandName" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div class="md:col-span-2"><label class="block text-sm font-medium">Street Address</label><input type="text" data-form-id="streetAddress" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">City</label><input type="text" data-form-id="city" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">State</label><input type="text" data-form-id="state" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Zip</label><input type="text" data-form-id="zip" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Country (if not USA)</label><input type="text" data-form-id="country" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                        </div>
                    </details>`;
                content += `
                    <details class="group" open>
                        <summary class="text-lg font-semibold cursor-pointer list-none group-open:mb-4">
                            <span class="group-open:hidden">►</span><span class="hidden group-open:inline">▼</span> Command POCs (at least two!)
                        </summary>
                        <div class="border-l-2 border-gray-200 dark:border-gray-600 pl-4">
                                        <div id="pocContainer" class="space-y-4">
                                ${createPocHtml(1)}
                                ${createPocHtml(2)}
                            </div>
                            <button type="button" id="addPocBtn" class="mt-4 text-sm text-blue-600 hover:underline">+ Add another POC</button>
                            <div class="mt-4"><label class="block text-sm font-medium">Facility Security Access Requirements</label><textarea data-form-id="security" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm" rows="2"></textarea></div>
                        </div>
                    </details>`;
                content += `
                    <details class="group" open>
                        <summary class="text-lg font-semibold cursor-pointer list-none group-open:mb-4">
                            <span class="group-open:hidden">►</span><span class="hidden group-open:inline">▼</span> Funding Information
                        </summary>
                        <div class="border-l-2 border-gray-200 dark:border-gray-600 pl-4">
                            <div>
                                <label class="block text-sm font-medium">Does the command intend to provide funds for this disposal?</label>
					<select data-form-id="funding" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm">
   						 <option value="does">Yes</option>
						  <option value="does not" selected>No</option>
					</select>
                            </div>
                        </div>
                    </details>`;
                content += `
                    <details class="group" open>
                        <summary class="text-lg font-semibold cursor-pointer list-none group-open:mb-4">
                            <span class="group-open:hidden">►</span><span class="hidden group-open:inline">▼</span> Item Details
                        </summary>
                        <div id="disposalItemsContainer" class="border-l-2 border-gray-200 dark:border-gray-600 pl-4 space-y-4">`;
                selectedItems.forEach((item, index) => {
                    content += `
			    <div class="p-4 border rounded-lg dark:border-gray-600 disposal-item" data-item-id="${item.id}">
			        <h4 class="font-semibold mb-2 text-base">${escapeHTML(item.name)}</h4>
			        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium">NSN</label><input type="text" value="${item.nsn || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm" readonly></div>
                                <div><label class="block text-sm font-medium">DEMIL</label><input type="text" data-form-id="demil" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div class="md:col-span-2"><label class="block text-sm font-medium">Serial #(s)</label><div class="serial-number-container space-y-2"><input type="text" data-form-id="serial" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div></div>
                                <div><label class="block text-sm font-medium">SSDR</label><input type="text" data-form-id="ssdr" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium"># each</label><input type="number" value="1" min="1" data-form-id="quantity" class="quantity-input mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Radionuclide</label><input type="text" value="${item.radionuclide}" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm" readonly></div>
                                <div><label class="block text-sm font-medium">Activity</label><input type="text" value="${item.activity_ci_str}" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm" readonly></div>
                                <div><label class="block text-sm font-medium">Assay Date</label><input type="date" data-form-id="assayDate" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Licensed</label><select data-form-id="licensed" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"><option>No</option><option>Yes</option></select></div>
                                <div class="md:col-span-2"><label class="block text-sm font-medium">NRC License # / MML Permit #</label><input type="text" data-form-id="licenseNumber" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Form (i.e. Normal/Special/unknown)</label><input type="text" data-form-id="form" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Volume</label><input type="text" data-form-id="volume" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Weight</label><input type="text" data-form-id="weight" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div class="md:col-span-3"><label class="block text-sm font-medium">Other Info</label><input type="text" data-form-id="otherInfo" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div class="md:col-span-3"><label class="block text-sm font-medium">Pictures</label><div class="picture-container space-y-2"><input type="file" data-form-id="picture" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600"></div><button type="button" class="add-picture-btn mt-2 text-sm text-blue-600 hover:underline">+ Add another picture</button></div>
                                <div><label class="block text-sm font-medium">Company Name</label><input type="text" data-form-id="mfgName" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Part/Model #</label><input type="text" data-form-id="mfgModel" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                                <div><label class="block text-sm font-medium">Date (on item)</label><input type="text" data-form-id="mfgDate" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
				</div>
                        </div>`;
                });
                content += `</div></details>`;
                content += `
                    <details class="group" open>
                        <summary class="text-lg font-semibold cursor-pointer list-none group-open:mb-4">
                             <span class="group-open:hidden">►</span><span class="hidden group-open:inline">▼</span> Pickup Location
                        </summary>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-l-2 border-gray-200 dark:border-gray-600 pl-4">
                            <div class="md:col-span-2"><label class="block text-sm font-medium">Address</label><input type="text" data-form-id="pickupAddress" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                            <div><label class="block text-sm font-medium">Building #</label><input type="text" data-form-id="pickupBuilding" class="mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm"></div>
                        </div>
                    </details>`;
                content += `<div id="packageAnalysis" class="mt-6"></div>`;
                content += '</form>';
                disposalRequestContent.innerHTML = content;
                openModal(disposalRequestModal);
                calculateDisposalPackageAnalysis();
                disposalRequestContent.querySelector('#disposalItemsContainer').addEventListener('input', calculateDisposalPackageAnalysis);
            }
            disposalRequestContent.addEventListener('input', (e) => {
                if (e.target.classList.contains('quantity-input')) {
                    const quantityInput = e.target;
                    const itemCard = quantityInput.closest('.disposal-item');
                    const serialContainer = itemCard.querySelector('.serial-number-container');
                    let targetCount = parseInt(quantityInput.value, 10);
                    if (isNaN(targetCount) || targetCount < 1) {
                        targetCount = 1;
                    }
                    const currentFields = serialContainer.querySelectorAll('input[data-form-id="serial"]');
                    let currentCount = currentFields.length;
                    while (currentCount < targetCount) {
                        const newInput = document.createElement('input');
                        newInput.type = 'text';
                        newInput.dataset.formId = 'serial';
                        newInput.className = 'mt-1 block w-full rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 shadow-sm';
                        serialContainer.appendChild(newInput);
                        currentCount++;
                    }
                    while (currentCount > targetCount) {
                        serialContainer.lastElementChild.remove();
                        currentCount--;
                    }
                }
            });
            disposalRequestContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-picture-btn')) {
                    const container = e.target.previousElementSibling;
                    const newInput = document.createElement('input');
                    newInput.type = 'file';
                    newInput.dataset.formId = 'picture';
                    newInput.className = 'mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600';
                    container.appendChild(newInput);
                }
                if (e.target.id === 'addPocBtn') {
                    const pocContainer = document.getElementById('pocContainer');
                    const newPocNumber = pocContainer.children.length + 1;
                    const newPocCardHtml = createPocHtml(newPocNumber);
                    pocContainer.insertAdjacentHTML('beforeend', newPocCardHtml);
                }
            });
            function calculateDisposalPackageAnalysis() {
                const analysisContainer = document.getElementById('packageAnalysis');
                if (!analysisContainer) return;
                const itemCards = document.querySelectorAll('.disposal-item');
                let dotExemptSum = 0; let un2911PkgSum = 0; let typeASum = 0;
                let analysisDetails = [];
                itemCards.forEach(card => {
                    const itemId = card.dataset.itemId;
                    const itemData = tableData.find(d => d.id == itemId);
                    const quantityInput = card.querySelector('.quantity-input');
                    const quantity = quantityInput ? parseFloat(quantityInput.value) : 0;
                    if (!itemData || isNaN(quantity) || quantity <= 0) { return; }
                    const totalActivity = itemData.activity_val * quantity;
                    let detailRow = { name: itemData.name, qty: quantity, activity: formatCi(totalActivity), dot: 'N/A', un2911: 'N/A', typeA: 'N/A' };
                    if (itemData.dot_exemption_val) {
                        const fraction = totalActivity / itemData.dot_exemption_val;
                        dotExemptSum += fraction;
                        detailRow.dot = fraction.toFixed(3);
                    }
                    if (itemData.un2911_pkg_limit_val) {
                        const fraction = totalActivity / itemData.un2911_pkg_limit_val;
                        un2911PkgSum += fraction;
                        detailRow.un2911 = fraction.toFixed(3);
                    }
                    if (itemData.dot_a2_val) {
                        const fraction = totalActivity / itemData.dot_a2_val;
                        typeASum += fraction;
                        detailRow.typeA = fraction.toFixed(3);
                    }
                    analysisDetails.push(detailRow);
                });
                let classification = '';
                let classificationColor = '';
                if (dotExemptSum <= 1) {
                    classification = 'Exempt from regulation per 49 CFR § 173.436.';
                    classificationColor = 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                } else if (un2911PkgSum <= 1) {
                    classification = 'Limited Quantity Excepted Package (UN 2911)';
                    classificationColor = 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200';
                } else if (typeASum <= 1) {
                    classification = 'Type A Package';
                    classificationColor = 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                } else {
                    classification = 'Exceeds Type A limits. Requires Type B package.';
                    classificationColor = 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
                }
                let content = `
                    <details class="group" open>
                        <summary class="text-lg font-semibold cursor-pointer list-none group-open:mb-4">
                            <span class="group-open:hidden">►</span><span class="hidden group-open:inline">▼</span> Package Analysis
                        </summary>
                        <div class="border-l-2 border-gray-200 dark:border-gray-600 pl-4 space-y-4">
                            <div class="p-4 rounded-lg ${classificationColor}">
                                <h4 class="font-bold">Package Classification:</h4>
                                <p>${classification}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Sum of Fractions Calculation:</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-gray-100 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-2 py-1">Item</th><th class="px-2 py-1 text-center">Qty</th>
                                                <th class="px-2 py-1 text-center">Total Activity</th><th class="px-2 py-1 text-center">Exempt Fraction</th>
                                                <th class="px-2 py-1 text-center">UN 2911 Fraction</th><th class="px-2 py-1 text-center">Type A Fraction</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${analysisDetails.map(row => `
                                                <tr class="border-b dark:border-gray-700">
                                                    <td class="px-2 py-1">${row.name}</td><td class="px-2 py-1 text-center">${row.qty}</td>
                                                    <td class="px-2 py-1 text-center">${row.activity}</td><td class="px-2 py-1 text-center">${row.dot}</td>
                                                    <td class="px-2 py-1 text-center">${row.un2911}</td><td class="px-2 py-1 text-center">${row.typeA}</td>
                                                </tr>`).join('')}
                                            <tr class="font-bold bg-gray-50 dark:bg-gray-800">
                                                <td class="px-2 py-1 text-right" colspan="3">Total Sum of Fractions:</td>
                                                <td class="px-2 py-1 text-center ${dotExemptSum > 1 ? 'text-red-500' : 'text-green-500'}">${dotExemptSum.toFixed(3)}</td>
                                                <td class="px-2 py-1 text-center ${un2911PkgSum > 1 ? 'text-red-500' : 'text-green-500'}">${un2911PkgSum.toFixed(3)}</td>
                                                <td class="px-2 py-1 text-center ${typeASum > 1 ? 'text-red-500' : 'text-green-500'}">${typeASum.toFixed(3)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </details>`;
                analysisContainer.innerHTML = content;
            }
            printRequestBtn.addEventListener('click', async () => {
                const form = document.getElementById('disposalRequestForm');
                const getValue = (id) => {
                    const el = form.querySelector(`[data-form-id="${id}"]`);
                    return el ? el.value : 'N/A';
                };
                const readFileAsDataURL = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                };
                const analysisContentHTML = document.getElementById('packageAnalysis').innerHTML;
                let printContent = `
                    <html><head><title>Disposal Request</title><script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        body { font-family: "Inter", sans-serif; padding: 2rem; } h1, h2, h3 { font-weight: bold; margin-bottom: 0.5rem; margin-top: 1rem; }
                        h1 { font-size: 1.5rem; } h2 { font-size: 1.25rem; border-bottom: 1px solid #ccc; padding-bottom: 0.25rem; }
                        h3 { font-size: 1.1rem; } .section { margin-bottom: 1.5rem; page-break-inside: avoid; }
                        .grid-print { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem; }
                        .grid-item { display: flex; flex-direction: column; } .grid-item strong { font-weight: 600; font-size: 0.875rem; color: #555; }
                        .item-card { border: 1px solid #ccc; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; page-break-inside: avoid; }
                        .item-image { max-width: 100%; height: auto; margin-top: 1rem; border-radius: 0.25rem; }
                        .group[open] .group-open\\:mb-4 { margin-bottom: 1rem; } .list-none { list-style-type: none; }
                        .cursor-pointer { cursor: pointer; } .group .group-open\\:hidden { display: inline; }
                        .group[open] .group-open\\:hidden { display: none; } .group .hidden { display: none; }
                        .group[open] .hidden { display: inline; } .border-l-2 { border-left-width: 2px; } .pl-4 { padding-left: 1rem; }
                        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; } .p-4 { padding: 1rem; }
                        .rounded-lg { border-radius: 0.5rem; } .bg-green-100 { background-color: #dcfce7; } .text-green-800 { color: #166534; }
                        .bg-blue-100 { background-color: #dbeafe; } .text-blue-800 { color: #1e40af; } .bg-yellow-100 { background-color: #fef08a; }
                        .text-yellow-800 { color: #854d0e; } .bg-red-100 { background-color: #fee2e2; } .text-red-800 { color: #991b1b; }
                        .font-bold { font-weight: 700; } .font-semibold { font-weight: 600; } .mb-2 { margin-bottom: 0.5rem; }
                        .overflow-x-auto { overflow-x: auto; } .w-full { width: 100%; } .text-sm { font-size: 0.875rem; }
                        .text-left { text-align: left; } thead { display: table-header-group; } .bg-gray-100 { background-color: #f3f4f6; }
                        th, td { padding: 0.5rem; } .text-center { text-align: center; } tbody { display: table-row-group; }
                        .border-b { border-bottom-width: 1px; border-color: #e5e7eb; } .bg-gray-50 { background-color: #f9fafb; }
                        .text-right { text-align: right; } .text-red-500 { color: #ef4444; } .text-green-500 { color: #22c55e; }
                    </style></head><body><h1>LLRW Disposal Request</h1>
                        <div class="section"><h2>Command Information</h2><div class="grid-print">
                            <div class="grid-item"><strong>UIC:</strong> <span>${getValue('uic')}</span></div>
                            <div class="grid-item"><strong>Command Name:</strong> <span>${getValue('commandName')}</span></div>
                            <div class="grid-item"><strong>Street Address:</strong> <span>${getValue('streetAddress')}</span></div>
                            <div class="grid-item"><strong>City:</strong> <span>${getValue('city')}</span></div>
                            <div class="grid-item"><strong>State:</strong> <span>${getValue('state')}</span></div>
                            <div class="grid-item"><strong>Zip:</strong> <span>${getValue('zip')}</span></div>
                            <div class="grid-item"><strong>Country:</strong> <span>${getValue('country')}</span></div>
                        </div></div>`;
                printContent += `<div class="section"><h2>Command POCs</h2>`;
                const pocCards = form.querySelectorAll('.poc-card');
                pocCards.forEach((card, index) => {
                    const pocNumber = index + 1;
                    const getPocValue = (field) => card.querySelector(`[data-form-id="poc${pocNumber}${field}"]`)?.value || 'N/A';
                    printContent += `
                        <h3 class="mt-4">POC ${pocNumber}</h3>
                        <div class="grid-print">
                            <div class="grid-item"><strong>Name:</strong> <span>${getPocValue('Name')}</span></div>
                            <div class="grid-item"><strong>Title:</strong> <span>${getPocValue('Title')}</span></div>
                            <div class="grid-item"><strong>E-mail:</strong> <span>${getPocValue('Email')}</span></div>
                            <div class="grid-item"><strong>Business #:</strong> <span>${getPocValue('BusinessPhone')}</span></div>
                            <div class="grid-item"><strong>Mobile #:</strong> <span>${getPocValue('MobilePhone')}</span></div>
                        </div>`;
                });
                printContent += `<div class="grid-item mt-4"><strong>Facility Security Access Requirements:</strong> <span>${getValue('security')}</span></div></div>`;
                printContent += `<div class="section"><h2>Item Details</h2>`;
                const imagePromises = [];
                const itemCards = form.querySelectorAll('.disposal-item');
                itemCards.forEach((itemCard, index) => {
                    const itemId = itemCard.dataset.itemId;
                    const itemData = tableData.find(d => d.id == itemId);
                    const getItemValue = (id) => {
                        const el = itemCard.querySelector(`[data-form-id="${id}"]`);
                        return el ? el.value : 'N/A';
                    };
                    const serialInputs = itemCard.querySelectorAll('[data-form-id="serial"]');
                    const serials = Array.from(serialInputs).map(input => input.value).filter(val => val).join(', ');
                    const fileInputs = itemCard.querySelectorAll('input[type="file"]');
                    fileInputs.forEach(input => {
                        if (input.files[0]) {
                            imagePromises.push(readFileAsDataURL(input.files[0]).then(imageDataUrl => ({ name: itemData.name, url: imageDataUrl })));
                        }
                    });
                    printContent += `
                        <div class="item-card"><h3>Item ${index + 1}: ${escapeHTML(itemData.name)}</h3><div class="grid-print">
                            <div class="grid-item"><strong>NSN:</strong> <span>${escapeHTML(itemData.nsn || 'N/A')}</span></div>
                            <div class="grid-item"><strong># each:</strong> <span>${getItemValue('quantity')}</span></div>
                            <div class="grid-item"><strong>DEMIL:</strong> <span>${getItemValue('demil')}</span></div>
                            <div class="grid-item"><strong>Serial #(s):</strong> <span>${serials}</span></div>
                            <div class="grid-item"><strong>SSDR:</strong> <span>${getItemValue('ssdr')}</span></div>
                            <div class="grid-item"><strong>Radionuclide:</strong> <span>${itemData.radionuclide}</span></div>
                            <div class="grid-item"><strong>Activity:</strong> <span>${itemData.activity_ci_str}</span></div>
                            <div class="grid-item"><strong>Assay Date:</strong> <span>${getItemValue('assayDate')}</span></div>
                            <div class="grid-item"><strong>Licensed:</strong> <span>${getItemValue('licensed')}</span></div>
                            <div class="grid-item"><strong>License/Permit #:</strong> <span>${getItemValue('licenseNumber')}</span></div>
                            <div class="grid-item"><strong>Form:</strong> <span>${getItemValue('form')}</span></div>
                            <div class="grid-item"><strong>Volume:</strong> <span>${getItemValue('volume')}</span></div>
                            <div class="grid-item"><strong>Weight:</strong> <span>${getItemValue('weight')}</span></div>
                            <div class="grid-item"><strong>Other Info:</strong> <span>${getItemValue('otherInfo')}</span></div>
                            <div class="grid-item"><strong>Mfg. Name:</strong> <span>${getItemValue('mfgName')}</span></div>
                            <div class="grid-item"><strong>Mfg. Model:</strong> <span>${getItemValue('mfgModel')}</span></div>
                            <div class="grid-item"><strong>Mfg. Date:</strong> <span>${getItemValue('mfgDate')}</span></div>
                        </div></div>`;
                });
                printContent += `</div>`;
                const images = await Promise.all(imagePromises);
                if (images.length > 0) {
                    printContent += `<div class="section" style="page-break-before: always;"><h2>Attached Images</h2>`;
                    images.forEach(image => {
                        printContent += `<div class="item-card"><h3>${image.name}</h3><img src="${image.url}" class="item-image"></div>`;
                    });
                    printContent += `</div>`;
                }
                printContent += `
                    <div class="section"><h2>Pickup Location</h2><div class="grid-print">
                        <div class="grid-item"><strong>Address:</strong> <span>${getValue('pickupAddress')}</span></div>
                        <div class="grid-item"><strong>Building #:</strong> <span>${getValue('pickupBuilding')}</span></div>
                    </div></div><div class="section">${analysisContentHTML}</div></body></html>`;
                const printWindow = window.open('', '', 'height=800,width=800');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 500);
            });
            function populateRadionuclideFilter() {
                const nuclides = [...new Set(tableData.map(item => item.radionuclide))].sort();
                radionuclideFilter.innerHTML = '<option value="all">All Radionuclides</option>';
                nuclides.forEach(nuclide => {
                    const option = document.createElement('option');
                    option.value = nuclide;
                    option.textContent = nuclide;
                    radionuclideFilter.appendChild(option);
                });
            }
            saveSelectionBtn.addEventListener('click', () => {
                const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
                safeSetItem('savedSelection', JSON.stringify(selectedIds));
                showToast('Selection saved!', 'success');
                loadSelectionBtn.disabled = false;
                clearSavedBtn.disabled = false;
            });
            loadSelectionBtn.addEventListener('click', () => {
                const savedSelection = safeGetItem('savedSelection');
                const savedIds = JSON.parse(savedSelection || '[]');
                if (!savedIds || savedIds.length === 0) return;
                clearSelectionBtn.click();
                savedIds.forEach(id => {
                    const checkbox = document.querySelector(`.row-checkbox[data-id="${id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        const changeEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                    }
                });
                showToast('Selection loaded.', 'info');
            });
            clearSavedBtn.addEventListener('click', () => {
                showConfirmationModal('Are you sure you want to clear your saved selection?', () => {
                    safeRemoveItem('savedSelection');
                    clearSavedBtn.disabled = true;
                    loadSelectionBtn.disabled = true;
                    showToast('Saved selection cleared.', 'success');
                });
            });
            selectAllCheckbox.addEventListener('change', () => {
                const isChecked = selectAllCheckbox.checked;
                const visibleCheckboxes = document.querySelectorAll('#lookupTable tbody tr .row-checkbox');
                visibleCheckboxes.forEach(checkbox => {
                    if (checkbox.checked !== isChecked) {
                        checkbox.checked = isChecked;
                        const changeEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                    }
                });
            });
            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newItemData = {
                    name: document.getElementById('itemName').value, nsn: document.getElementById('itemNsn').value,
                    radionuclide: document.getElementById('itemRadionuclide').value, activity: document.getElementById('itemActivity').value,
                    units: document.getElementById('itemUnits').value,
                };
                const customItemsJSON = safeGetItem('customItems');
                let customItems = JSON.parse(customItemsJSON || '[]');
                const editId = document.getElementById('itemEditId').value;
                if (editId) {
                    const index = customItems.findIndex(item => item.id == editId);
                    if(index > -1) { customItems[index] = {...newItemData, id: parseInt(editId)}; }
                    showToast('Item updated!', 'success');
                } else {
                    const newId = Date.now();
                    customItems.push({...newItemData, id: newId });
                    showToast('Item added!', 'success');
                }
                safeSetItem('customItems', JSON.stringify(customItems));
                tableData = processData(rawTableData, customItems);
                filterTable();
                populateRadionuclideFilter();
                updateCustomItemButtonsState();
                closeModal(addItemModal);
            });
            clearAddedBtn.addEventListener('click', () => {
                showConfirmationModal("Are you sure you want to delete all custom-added items? This action cannot be undone.", () => {
                    safeRemoveItem('customItems');
                    tableData = processData(rawTableData, []);
                    filterTable();
                    populateRadionuclideFilter();
                    updateCustomItemButtonsState();
                    showToast('All custom items have been deleted.', 'success');
                });
            });
            function populateAddItemRadionuclides() {
                const nuclides = [...new Set(Object.keys(nrcExemptionValues))].sort();
                itemRadionuclideSelect.innerHTML = '';
                nuclides.forEach(nuclide => {
                    const option = document.createElement('option');
                    option.value = nuclide;
                    option.textContent = nuclide;
                    itemRadionuclideSelect.appendChild(option);
                });
            }
            function showAddItemModal(itemToEdit = null) {
                addItemForm.reset();
                if (itemToEdit) {
                    const customItemsJSON = safeGetItem('customItems');
                    const customItems = JSON.parse(customItemsJSON || '[]');
                    const originalCustomItem = customItems.find(ci => ci.id === itemToEdit.id);
                    document.getElementById('addItemModalTitle').textContent = 'Edit Custom Item';
                    document.getElementById('saveItemBtn').textContent = 'Update Item';
                    document.getElementById('itemEditId').value = itemToEdit.id;
                    document.getElementById('itemName').value = itemToEdit.name;
                    document.getElementById('itemNsn').value = itemToEdit.nsn;
                    document.getElementById('itemRadionuclide').value = itemToEdit.radionuclide;
                    if(originalCustomItem) {
                        document.getElementById('itemActivity').value = originalCustomItem.activity;
                        document.getElementById('itemUnits').value = originalCustomItem.units;
                    }
                } else {
                    document.getElementById('addItemModalTitle').textContent = 'Add Custom Item';
                    document.getElementById('saveItemBtn').textContent = 'Save Item';
                    document.getElementById('itemEditId').value = '';
                }
                openModal(addItemModal);
            }
            function deleteCustomItem(itemId) {
                const customItemsJSON = safeGetItem('customItems');
                let customItems = JSON.parse(customItemsJSON || '[]');
                customItems = customItems.filter(item => item.id !== itemId);
                safeSetItem('customItems', JSON.stringify(customItems));
                tableData = processData(rawTableData, customItems);
                filterTable();
                populateRadionuclideFilter();
                updateCustomItemButtonsState();
                showToast('Item deleted.', 'success');
            }
            function updateCustomItemButtonsState() {
                const customItemsJSON = safeGetItem('customItems');
                const customItems = JSON.parse(customItemsJSON || '[]');
                const hasCustomItems = customItems.length > 0;
                clearAddedBtn.disabled = !hasCustomItems;
                exportCustomBtn.disabled = !hasCustomItems;
            }
            exportCustomBtn.addEventListener('click', () => {
                const customItemsJSON = safeGetItem('customItems');
                const customItems = JSON.parse(customItemsJSON || '[]');
                if (customItems.length === 0) {
                    showToast('No custom items to export.', 'error');
                    return;
                }
                const jsonString = JSON.stringify(customItems, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'radioactive_commodities_custom.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Custom items exported!', 'success');
            });
            importCustomBtn.addEventListener('click', () => {
                importFileInput.click();
            });
            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedItems = JSON.parse(e.target.result);
                        if (!Array.isArray(importedItems)) {
                            throw new Error('Imported file is not a valid list.');
                        }
                        showConfirmationModal('Do you want to REPLACE your current custom items with the imported list?', () => {
                            safeSetItem('customItems', JSON.stringify(importedItems));
                            tableData = processData(rawTableData, importedItems);
                            filterTable();
                            populateRadionuclideFilter();
                            updateCustomItemButtonsState();
                            showToast('Custom items imported successfully!', 'success');
                        });
                    } catch (error) {
                        showToast('Error reading or parsing the file.', 'error');
                        console.error("Import error:", error);
                    } finally {
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            });
            function saveState() {
                const state = {
                    searchTerm: searchInput.value, radionuclide: radionuclideFilter.value,
                    nrcExempt: nrcExemptFilter.checked, dotExempt: dotExemptFilter.checked,
                    isSiUnits: unitToggle.checked, sortColumn: currentSort.column,
                    sortDirection: currentSort.direction
                };
                safeSetItem('lookupTableState', JSON.stringify(state));
            }
            function loadState() {
                const savedState = safeGetItem('lookupTableState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    searchInput.value = state.searchTerm || '';
                    radionuclideFilter.value = state.radionuclide || 'all';
                    nrcExemptFilter.checked = state.nrcExempt || false;
                    dotExemptFilter.checked = state.dotExempt || false;
                    unitToggle.checked = state.isSiUnits || false;
                    currentSort.column = state.sortColumn || null;
                    currentSort.direction = state.sortDirection || 'asc';
                }
            }
            function showConfirmationModal(message, onConfirm) {
                confirmModalText.textContent = message;
                confirmCallback = onConfirm;
                openModal(confirmModal);
            }
            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                radionuclideFilter.value = 'all';
                nrcExemptFilter.checked = false;
                dotExemptFilter.checked = false;
                currentSort.column = 'name';
                currentSort.direction = 'asc';
                safeRemoveItem('lookupTableState');
                performSort();
            });
            function showRadionuclideModal(nuclideId) {
                const details = radionuclideDetails[nuclideId];
                if (!details) return;
                const modalTitle = document.getElementById('radionuclideModalTitle');
                const modalContent = document.getElementById('radionuclideContent');
                modalTitle.textContent = `${details.name} (${nuclideId})`;
                let content = `<div class="space-y-3">`;
                content += `<div class="flex justify-between"><strong>Half-life:</strong> <span>${details.halfLife}</span></div>`;
                content += `<div class="flex justify-between"><strong>Decay Mode:</strong> <span>${details.decayMode}</span></div>`;
                content += `<div class="mt-4"><a href="${details.wiki}" target="_blank" class="text-blue-500 hover:underline">Learn More on Wikipedia</a></div>`;
                content += `</div>`;
                modalContent.innerHTML = content;
                openModal(radionuclideDetailModal);
            }
            function showTooltipModal(tooltipKey) {
                const tooltipModalTitle = document.getElementById('tooltipModalTitle');
                const tooltipContent = document.getElementById('tooltipContent');
                const tooltipData = {
                    'nrc_exemption_val': { title: 'NRC Exemption Limit', content: `<p class="mb-2">This value comes from <strong>10 CFR § 30.71, Schedule B</strong>.</p><p class="mb-2">It represents the maximum activity of a specific radionuclide that can be contained in a single "exempt quantity" item.</p><p>If an item's activity is at or below this limit, it is generally exempt from NRC licensing requirements for possession and use, provided it's not part of a larger aggregated quantity.</p><a href="https://www.nrc.gov/reading-rm/doc-collections/cfr/part030/part030-0071.html" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>` },
                    'dot_exemption_val': { title: 'DOT Exemption Limit (Consignment)', content: `<p class="mb-2">This value comes from the "Activity limit for an exempt consignment" column in the table at <strong>49 CFR § 173.436</strong>.</p><p class="mb-2">It represents the maximum total activity of a specific radionuclide that can be in a single shipment (consignment) to be considered exempt from most hazmat shipping regulations.</p><p>This is a consignment-level limit, not a per-item or per-package limit.</p><a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173/subpart-I/section-173.436" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>` },
                    'un2911_limit_val': { title: 'UN 2911 Limit (Per Item)', content: `<p class="mb-2">This value comes from the "Item limits" column in the table at <strong>49 CFR § 173.425</strong> for "Instruments and articles".</p><p class="mb-2">It is the maximum activity of a specific radionuclide allowed in a single instrument or article to be shipped as an "Excepted package" under UN 2911.</p><p>Items meeting this limit can be shipped with reduced regulatory requirements compared to fully regulated radioactive material.</p><a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173/subpart-I/section-173.425" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>` },
                    'un2911_pkg_limit_val': { title: 'UN 2911 Limit (Per Package)', content: `<p class="mb-2">This value comes from the "Package limits" column in the table at <strong>49 CFR § 173.425</strong> for "Instruments and articles".</p><p class="mb-2">It is the maximum total activity of a specific radionuclide allowed in a single package containing one or more excepted items to be shipped under UN 2911.</p><p>Even if individual items are below the item limit, the total activity in the package must not exceed this limit.</p><a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-I/subchapter-C/part-173/subpart-I/section-173.425" target="_blank" class="text-blue-500 hover:underline">View Regulation</a>` }
                };
                const data = tooltipData[tooltipKey];
                if (!data) return;
                tooltipModalTitle.innerHTML = data.title;
                tooltipContent.innerHTML = data.content;
                openModal(tooltipModal);
            }
            generateMemoBtn.addEventListener('click', () => {
                const form = document.getElementById('disposalRequestForm');
                let primaryPocName = '[POC Name]'; let primaryPocEmail = '[POC Email]';
                const pocCards = form.querySelectorAll('.poc-card');
                for (let i = 0; i < pocCards.length; i++) {
                    const card = pocCards[i]; const pocNumber = i + 1;
                    const nameInput = card.querySelector(`[data-form-id="poc${pocNumber}Name"]`);
                    const emailInput = card.querySelector(`[data-form-id="poc${pocNumber}Email"]`);
                    if (nameInput && nameInput.value.trim() !== '') {
                        primaryPocName = nameInput.value;
                        primaryPocEmail = emailInput ? emailInput.value : '[POC Email]';
                        break;
                    }
                }
                const fundingChoice = form.querySelector('[data-form-id="funding"]').value;
                const commandName = form.querySelector('[data-form-id="commandName"]').value || '[Command Name]';
                const commandAddress = form.querySelector('[data-form-id="streetAddress"]').value || '[Command Address]';
                const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const memoText = `
                                                                                                                                   5104
                                                                                                                                   Ser ##/###
                                                                                                                                   ${date}


From:   Title, ${commandName}, ${commandAddress}
To:     Officer in Charge, Naval Sea Systems Command Detachment, Radiological Affairs Support Office (RASO)

Subj:   REQUEST FOR LOW-LEVEL RADIOACTIVE WASTE DISPOSAL

Encl:   (1) Low-Level Radioactive Waste Disposal Request – Command Information
        (2) Low-Level Radioactive Waste Disposal Request – Command Inventory

The purpose of this letter is to request disposal of low-level radioactive waste (LLRW). Enclosure (1) provides information about the command and my LLRW point of contact. Enclosure (2) provides the command’s LLRW inventory. The command ${fundingChoice} intend to provide funds for this disposal.

Enclosures (1) and (2) are provided in electronic format.

The point of contact is ${primaryPocName} who can be reached at ${primaryPocEmail}.



    I. M. SIGNATURE

Copy to:
As needed`;
                memoContent.textContent = memoText;
                openModal(memoModal);
            });

            // Add all modal closing event listeners
            closeModalBtn.addEventListener('click', () => closeModal(compareModal));
            closeDetailModalBtn.addEventListener('click', () => closeModal(detailModal));
            closeDisposalRequestModalBtn.addEventListener('click', () => closeModal(disposalRequestModal));
            closeHelpModalBtn.addEventListener('click', () => closeModal(helpModal));
            closeAddItemModalBtn.addEventListener('click', () => closeModal(addItemModal));
            cancelAddItemBtn.addEventListener('click', () => closeModal(addItemModal));
            confirmModalCancelBtn.addEventListener('click', () => { closeModal(confirmModal); confirmCallback = null; });
            closeRadionuclideModalBtn.addEventListener('click', () => closeModal(radionuclideDetailModal));
            closeTooltipModalBtn.addEventListener('click', () => closeModal(tooltipModal));
            closeMemoModalBtn.addEventListener('click', () => closeModal(memoModal));
            closeInstructionsModalBtn.addEventListener('click', () => closeModal(instructionsModal));
            confirmModalConfirmBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                closeModal(confirmModal);
                confirmCallback = null;
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    const openModal = allModals.find(m => m.style.display !== 'none');
                    if (openModal) { closeModal(openModal); }
                }
            });
            allModals.forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) { closeModal(modal); }
                });
            });

            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        header.click();
                    }
                });
            });

            // Other button/form event listeners
            disposalRequestBtn.addEventListener('click', showDisposalRequestModal);
            helpBtn.addEventListener('click', () => openModal(helpModal));
            showInstructionsBtn.addEventListener('click', () => openModal(instructionsModal));
            addItemBtn.addEventListener('click', () => showAddItemModal());
            copyMemoBtn.addEventListener('click', () => copyToClipboard(memoContent.textContent, null));
            const debouncedFilterAndSave = debounce(() => {
                filterTable();
                saveState();
            }, 300);
            searchInput.addEventListener('input', () => {
                clearSearchBtn.classList.toggle('hidden', searchInput.value === '');
                debouncedFilterAndSave();
            });
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                filterTable();
                saveState();
            });
            exportCsvBtn.addEventListener('click', exportDisposalRequestAsCSV);
            radionuclideFilter.addEventListener('change', debouncedFilterAndSave);
            nrcExemptFilter.addEventListener('change', debouncedFilterAndSave);
            dotExemptFilter.addEventListener('change', debouncedFilterAndSave);
            unitToggle.addEventListener('change', () => { filterTable(); saveState(); });

            // Initial page load setup
            const customItemsJSON = safeGetItem('customItems');
            const customItems = JSON.parse(customItemsJSON || '[]');
            tableData = processData(rawTableData, customItems);
            populateRadionuclideFilter();
            populateAddItemRadionuclides();
            updateCustomItemButtonsState();
            loadState();
            clearSearchBtn.classList.toggle('hidden', searchInput.value === '');
            currentSort.column = currentSort.column || 'name';
            currentSort.direction = 'asc';
            performSort();
            if (safeGetItem('savedSelection')) {
                loadSelectionBtn.disabled = false;
                clearSavedBtn.disabled = false;
            }
            document.getElementById('loadingStateRow').style.display = 'none';
        });
    </script>
</body>
</html>
